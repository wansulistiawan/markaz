<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Pintar Pro v6.2 - Complete Roles</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; position: absolute; top: 0; left: 0; width: 100%; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useMemo, useRef } = React;
        
        // --- ICONS WRAPPER ---
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                lucide.createIcons({
                    root: iconRef.current ? iconRef.current.parentNode : document,
                    nameAttr: 'data-lucide',
                    attrs: {class: className}
                });
            }, [name]);
            return <i ref={iconRef} data-lucide={name} width={size} height={size} className={className}></i>;
        };

        // --- FIREBASE SETUP ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, RecaptchaVerifier, signInWithPhoneNumber, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, setDoc, getDoc, limit, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4t1Gya_QHDzTkYsF7U-pw1Uo1oQUABpM",
            authDomain: "websitemarkaz.firebaseapp.com",
            databaseURL: "https://websitemarkaz-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "websitemarkaz",
            storageBucket: "websitemarkaz.firebasestorage.app",
            messagingSenderId: "5529883980",
            appId: "1:5529883980:web:792ce6d869070e9a79ebe9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        enableIndexedDbPersistence(db).catch((err) => {
            console.log('Persistence status:', err.code);
        });

        const APP_ID = "kasir-pintar-pro-v6";

        // --- UTILS ---
        const formatCurrency = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val || 0);
        const formatDate = (ts) => ts ? new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium', timeStyle: 'short' }).format(ts.toDate ? ts.toDate() : new Date(ts)) : '-';

        const exportToCSV = (data, filename) => {
            if (!data || !data.length) return alert("Tidak ada data untuk diexport");
            const headers = Object.keys(data[0]).join(",");
            const rows = data.map(obj => Object.values(obj).map(v => `"${v}"`).join(",")).join("\n");
            const csvContent = "data:text/csv;charset=utf-8," + headers + "\n" + rows;
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename + ".csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- COMPONENTS ---

        const Modal = ({ title, onClose, children, maxWidth = "max-w-md" }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className={`bg-white rounded-2xl w-full ${maxWidth} shadow-2xl overflow-hidden flex flex-col max-h-[90vh]`}>
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800 uppercase">{title}</h3>
                        <button onClick={onClose} className="hover:bg-gray-200 p-1 rounded-full"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        // --- LOGIN SCREEN (FULL ORIGINAL) ---
        const LoginScreen = () => {
            const [phone, setPhone] = useState('');
            const [otp, setOtp] = useState('');
            const [showOtp, setShowOtp] = useState(false);
            const [confirmObj, setConfirmObj] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            
            const recaptchaRef = useRef(null);

            useEffect(() => {
                const cleanupRecaptcha = () => {
                    if (window.recaptchaVerifier) {
                        try { window.recaptchaVerifier.clear(); } catch(e){}
                        window.recaptchaVerifier = null;
                    }
                    if (recaptchaRef.current) recaptchaRef.current.innerHTML = '';
                };
                cleanupRecaptcha();
                return () => cleanupRecaptcha();
            }, []);

            const handleGoogleLogin = async () => {
                setLoading(true); setError('');
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    console.error("Google Login Error:", err);
                    setError("Gagal Login Google. (" + err.message + ")");
                    setLoading(false);
                }
            };

            const handleSendOtp = async (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                
                let formatPhone = phone.trim();
                if (formatPhone.startsWith('0')) formatPhone = '+62' + formatPhone.slice(1);
                if (!formatPhone.startsWith('+')) formatPhone = '+62' + formatPhone;

                try {
                    if(!recaptchaRef.current) throw new Error("Recaptcha container not found");
                    if (!window.recaptchaVerifier) {
                        window.recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaRef.current, {
                            'size': 'invisible', 'callback': () => {} 
                        });
                    }
                    const confirmation = await signInWithPhoneNumber(auth, formatPhone, window.recaptchaVerifier);
                    setConfirmObj(confirmation);
                    setShowOtp(true);
                    setLoading(false);
                } catch (err) {
                    console.error("OTP Error:", err);
                    setError("Gagal kirim SMS: " + err.message);
                    setLoading(false);
                    if (window.recaptchaVerifier) {
                         try { window.recaptchaVerifier.clear(); } catch(e){}
                         window.recaptchaVerifier = null;
                    }
                }
            };

            const handleVerifyOtp = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    await confirmObj.confirm(otp);
                } catch (err) {
                    setError("Kode OTP Salah!");
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden">
                        <div className="p-8">
                            <div className="text-center mb-8">
                                <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600">
                                    <Icon name="store" size={32}/>
                                </div>
                                <h1 className="text-2xl font-bold text-gray-800">Kasir Pintar Pro</h1>
                                <p className="text-gray-500 text-sm">Masuk untuk mengelola toko Anda</p>
                            </div>

                            {error && <div className="bg-red-100 text-red-600 p-3 rounded-lg text-sm mb-4 text-center break-words">{error}</div>}

                            {!showOtp ? (
                                <>
                                    <form onSubmit={handleSendOtp} className="space-y-4 mb-6">
                                        <div>
                                            <label className="block text-xs font-bold text-gray-500 mb-1">NOMOR WHATSAPP / HP</label>
                                            <div className="flex bg-gray-50 border rounded-lg overflow-hidden focus-within:ring-2 ring-blue-500 transition">
                                                <span className="bg-gray-200 px-3 py-3 text-gray-600 font-bold border-r">+62</span>
                                                <input type="tel" className="w-full p-3 bg-transparent outline-none font-bold text-gray-800" placeholder="812-3456-7890" value={phone} onChange={e => setPhone(e.target.value.replace(/\D/g,''))} required />
                                            </div>
                                        </div>
                                        <div ref={recaptchaRef}></div>
                                        <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition disabled:bg-gray-300 flex justify-center items-center gap-2">
                                            {loading ? 'Mengirim OTP...' : <>Kirim Kode OTP <Icon name="arrow-right" size={16}/></>}
                                        </button>
                                    </form>
                                    <div className="flex items-center gap-4 mb-6">
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                        <span className="text-xs text-gray-400 font-bold">ATAU MASUK DENGAN</span>
                                        <div className="h-px bg-gray-200 flex-1"></div>
                                    </div>
                                    <button onClick={handleGoogleLogin} className="w-full border border-gray-300 bg-white text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-50 transition flex items-center justify-center gap-3">
                                        Lanjutkan dengan Google
                                    </button>
                                </>
                            ) : (
                                <form onSubmit={handleVerifyOtp} className="space-y-4">
                                    <div className="text-center mb-4">
                                        <p className="text-sm text-gray-500">Kode dikirim ke <span className="font-bold text-gray-800">+62{phone}</span></p>
                                        <button type="button" onClick={()=>setShowOtp(false)} className="text-xs text-blue-600 hover:underline">Ubah Nomor</button>
                                    </div>
                                    <input type="number" className="w-full p-3 border-2 border-blue-100 rounded-xl text-center text-2xl font-bold tracking-widest outline-none focus:border-blue-600 focus:bg-blue-50 transition" placeholder="• • • • • •" value={otp} onChange={e => setOtp(e.target.value)} autoFocus />
                                    <button disabled={loading} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition disabled:bg-gray-300">
                                        {loading ? 'Memverifikasi...' : 'Verifikasi & Masuk'}
                                    </button>
                                </form>
                            )}
                        </div>
                        <div className="bg-gray-50 p-4 text-center text-xs text-gray-400">
                            &copy; 2025 Markaz Qur'an Al-Maa'un Technology
                        </div>
                    </div>
                </div>
            );
        };

        const Receipt = ({ data, storeProfile, onClose }) => {
            if (!data) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-sm rounded-xl shadow-2xl overflow-hidden flex flex-col animate-fade-in">
                        <div className="bg-gray-900 text-white p-4 flex justify-between items-center no-print">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="check-circle" size={18}/> Transaksi Sukses</h3>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div className="p-6 font-mono text-sm bg-gray-50 overflow-y-auto max-h-[70vh]">
                            <div className="text-center mb-6">
                                {storeProfile?.logo && <img src={storeProfile.logo} className="h-16 mx-auto mb-2 object-contain" />}
                                <h2 className="text-xl font-bold uppercase">{storeProfile?.name || 'Toko Kasir Pro'}</h2>
                                <p className="text-gray-500 text-xs">{storeProfile?.address || 'Alamat Belum Diatur'}</p>
                                <p className="text-gray-500 text-xs">{storeProfile?.phone || ''}</p>
                            </div>
                            <div className="border-b border-dashed border-gray-400 pb-2 mb-2 text-xs">
                                <p>No: #{data.id.slice(0,8).toUpperCase()}</p>
                                <p>{formatDate(data.createdAt)}</p>
                                <p>Tipe: <span className="font-bold">{data.orderType || 'Dine In'}</span> {data.table ? `(Meja ${data.table})` : ''}</p>
                                <p>Plg: {data.customerName || 'Umum'}</p>
                            </div>
                            <div className="space-y-2 mb-4">
                                {data.items.map((item, i) => (
                                    <div key={i} className="flex justify-between">
                                        <div className="flex-1">
                                            <div className="font-bold">{item.name}</div>
                                            <div className="text-xs text-gray-500">
                                                {item.qty} x {formatCurrency(item.price)}
                                                {item.wholesaleQty && item.qty >= item.wholesaleQty && <span className="ml-1 text-[10px] font-bold">(Grosir)</span>}
                                            </div>
                                            {item.itemDiscount > 0 && <div className="text-[10px] text-green-600">Disc: -{formatCurrency(item.itemDiscount)}</div>}
                                            {item.note && <div className="text-[10px] italic text-gray-400">"{item.note}"</div>}
                                        </div>
                                        <div className="font-bold">{formatCurrency((item.price * item.qty) - (item.itemDiscount || 0))}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-dashed border-gray-400 pt-2 space-y-1 text-right">
                                <div className="flex justify-between text-gray-500"><span>Subtotal</span><span>{formatCurrency(data.subtotal)}</span></div>
                                {data.discount > 0 && <div className="flex justify-between text-green-600"><span>Diskon Global</span><span>-{formatCurrency(data.discount)}</span></div>}
                                {data.serviceCharge > 0 && <div className="flex justify-between text-gray-500"><span>Service ({data.serviceRate}%)</span><span>{formatCurrency(data.serviceCharge)}</span></div>}
                                {data.tax > 0 && <div className="flex justify-between text-gray-500"><span>Pajak ({data.taxRate}%)</span><span>{formatCurrency(data.tax)}</span></div>}
                                <div className="flex justify-between text-xl font-bold mt-2 pt-2 border-t border-dotted"><span>Total</span><span>{formatCurrency(data.total)}</span></div>
                                <div className="flex justify-between text-xs text-gray-500 mt-2">
                                    <span>Metode: {data.paymentMethod}</span>
                                    <span>{data.paymentMethod === 'Hutang' ? 'Belum Lunas' : 'Lunas'}</span>
                                </div>
                            </div>
                            <div className="mt-6 text-center text-xs text-gray-400 italic">
                                {storeProfile?.footerMessage || "Terima kasih atas kunjungan Anda!"}
                            </div>
                        </div>
                        <div className="p-4 bg-white border-t no-print">
                            <button onClick={() => window.print()} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-700">
                                <Icon name="printer" size={18}/> Cetak Struk
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APPLICATION ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('pos');
            const [loading, setLoading] = useState(true);
            
            // Data States
            const [products, setProducts] = useState([]);
            const [ingredients, setIngredients] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [suppliers, setSuppliers] = useState([]); 
            const [expenses, setExpenses] = useState([]); 
            const [debts, setDebts] = useState([]); 
            const [storeProfile, setStoreProfile] = useState({}); 
            const [tables, setTables] = useState([]); 
            const [shift, setShift] = useState(null); 
            const [transactions, setTransactions] = useState([]);
            const [stockHistory, setStockHistory] = useState([]); 

            // POS States
            const [cart, setCart] = useState([]);
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null); 
            const [discount, setDiscount] = useState(0); 
            const [paymentMethod, setPaymentMethod] = useState('Tunai');
            const [orderType, setOrderType] = useState('Dine In'); 
            const [lastTrans, setLastTrans] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            
            // Staff & Role
            const [staff, setStaff] = useState([]); 
            const [activeStaff, setActiveStaff] = useState(null); 
            
            // Modals
            const [editingItem, setEditingItem] = useState(null);
            const [modalConfig, setModalConfig] = useState({ show: false, type: '', data: null });
            const [settingsTab, setSettingsTab] = useState('profile');

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);

                const basePath = ['artifacts', APP_ID, 'users', user.uid];

                const unsubProd = onSnapshot(collection(db, ...basePath, 'products'), s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubIng = onSnapshot(collection(db, ...basePath, 'ingredients'), s => setIngredients(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubCust = onSnapshot(collection(db, ...basePath, 'customers'), s => setCustomers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubSupp = onSnapshot(collection(db, ...basePath, 'suppliers'), s => setSuppliers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubExp = onSnapshot(collection(db, ...basePath, 'expenses'), s => setExpenses(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubDebts = onSnapshot(collection(db, ...basePath, 'debts'), s => setDebts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubStock = onSnapshot(query(collection(db, ...basePath, 'stock_history'), orderBy('createdAt', 'desc'), limit(50)), s => setStockHistory(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubTrans = onSnapshot(query(collection(db, ...basePath, 'transactions'), orderBy('createdAt', 'desc'), limit(50)), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubTables = onSnapshot(query(collection(db, ...basePath, 'tables'), orderBy('name', 'asc')), s => setTables(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubStaff = onSnapshot(collection(db, ...basePath, 'staff'), s => {
                    const staffData = s.docs.map(d => ({id:d.id, ...d.data()}));
                    setStaff(staffData);
                    if(s.empty) addDoc(collection(db, ...basePath, 'staff'), { name: 'Owner', pin: '1234', role: 'admin' });
                });
                const unsubSettings = onSnapshot(doc(db, ...basePath, 'settings', 'profile'), s => { if (s.exists()) setStoreProfile(s.data()); });
                const qShift = query(collection(db, ...basePath, 'shifts'), where('status', '==', 'open'));
                const unsubShift = onSnapshot(qShift, s => { setShift(s.empty ? null : {id: s.docs[0].id, ...s.docs[0].data()}); });

                setTimeout(() => setLoading(false), 1000);
                return () => { unsubProd(); unsubIng(); unsubCust(); unsubSupp(); unsubExp(); unsubDebts(); unsubStock(); unsubSettings(); unsubShift(); unsubTrans(); unsubTables(); unsubStaff(); };
            }, [user]);

            // --- BUSINESS LOGIC ---

            const getPrice = (prod, qty) => {
                if (prod.wholesaleQty && prod.wholesalePrice && qty >= prod.wholesaleQty) {
                    return Number(prod.wholesalePrice);
                }
                return Number(prod.price);
            };

            const addToCart = (p) => {
                const hasRecipe = p.recipe && p.recipe.length > 0;
                if (!hasRecipe && p.stock <= 0) return alert("Stok Produk Habis!");

                setCart(prev => { 
                    const ex = prev.find(i=>i.id===p.id); 
                    if (ex) {
                        const newQty = ex.qty + 1;
                        return prev.map(i=>i.id===p.id ? {...i, qty: newQty, price: getPrice(p, newQty)} : i);
                    } else {
                        return [...prev,{...p, qty:1, price: getPrice(p, 1), itemDiscount:0}];
                    }
                });
            };

            const updateCartQty = (item, change) => {
                const newQty = Math.max(1, item.qty + change);
                const prod = products.find(p => p.id === item.id);
                setCart(prev => prev.map(i => i.id === item.id ? { ...i, qty: newQty, price: getPrice(prod, newQty) } : i));
            };

            const removeFromCart = (itemId) => {
                setCart(prev => prev.filter(item => item.id !== itemId));
            };

            const calculateTotals = () => {
                const subtotalRaw = cart.reduce((a,b) => a + (b.price * b.qty), 0);
                const itemDiscounts = cart.reduce((a,b) => a + (b.itemDiscount || 0), 0);
                const subtotal = subtotalRaw - itemDiscounts;
                const hppTotal = cart.reduce((a,b) => {
                     let itemHPP = b.hpp || 0;
                     if (b.recipe && b.recipe.length > 0) {
                        itemHPP = 0;
                        b.recipe.forEach(r => {
                            const ing = ingredients.find(i => i.id === r.ingId);
                            if(ing) itemHPP += (ing.costPerUnit || 0) * r.qty;
                        });
                     }
                     return a + (itemHPP * b.qty);
                }, 0);
                const serviceRate = storeProfile?.serviceRate || 0;
                const taxRate = storeProfile?.taxRate || 0;
                const taxableAmount = Math.max(0, subtotal - discount);
                const serviceCharge = (taxableAmount * serviceRate) / 100;
                const tax = ((taxableAmount + serviceCharge) * taxRate) / 100;
                const total = taxableAmount + serviceCharge + tax;
                return { subtotal, hppTotal, tax, serviceCharge, total, serviceRate, taxRate };
            };

            const checkIngredientsAvailability = () => {
                const requiredIngs = {};
                cart.forEach(item => {
                    if (item.recipe && item.recipe.length > 0) {
                        item.recipe.forEach(r => {
                            if (!requiredIngs[r.ingId]) requiredIngs[r.ingId] = 0;
                            requiredIngs[r.ingId] += (r.qty * item.qty);
                        });
                    }
                });
                for (const [id, needed] of Object.entries(requiredIngs)) {
                    const ing = ingredients.find(i => i.id === id);
                    if (!ing || ing.stock < needed) return `Stok Bahan Baku '${ing?.name||'Unknown'}' Kurang! (Butuh: ${needed}, Ada: ${ing?.stock||0})`;
                }
                return null;
            };

            const handleCheckout = async () => {
                if(!shift) return alert("Kasir belum dibuka!");
                if(cart.length === 0) return;
                
                const stockError = checkIngredientsAvailability();
                if (stockError) return alert(stockError);

                if(paymentMethod === 'Hutang' && !selectedCustomer) return alert("Pembayaran Hutang wajib memilih Pelanggan!");
                
                const totals = calculateTotals();
                const profit = totals.total - totals.tax - totals.serviceCharge - totals.hppTotal;

                const transData = {
                    items: cart, ...totals, profit, paymentMethod, orderType,
                    table: selectedTable ? selectedTable.name : null,
                    customerId: selectedCustomer ? selectedCustomer.id : null,
                    customerName: selectedCustomer ? selectedCustomer.name : 'Umum',
                    shiftId: shift.id, createdAt: serverTimestamp(), status: 'success'
                };

                try {
                    const ref = await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions'), transData);
                    
                    if (paymentMethod === 'Hutang') {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'debts'), {
                            transactionId: ref.id, customerId: selectedCustomer.id, customerName: selectedCustomer.name,
                            amount: totals.total, paid: 0, status: 'unpaid', createdAt: serverTimestamp()
                        });
                    }

                    const batchPromises = [];
                    const ingUpdates = {};
                    const prodUpdates = {};

                    cart.forEach(item => {
                        if (item.recipe && item.recipe.length > 0) {
                            item.recipe.forEach(r => {
                                if (!ingUpdates[r.ingId]) ingUpdates[r.ingId] = 0;
                                ingUpdates[r.ingId] += (r.qty * item.qty);
                            });
                        } else {
                            if (!prodUpdates[item.id]) prodUpdates[item.id] = 0;
                            prodUpdates[item.id] += item.qty;
                        }
                    });

                    for (const [id, qty] of Object.entries(ingUpdates)) {
                        const ing = ingredients.find(i => i.id === id);
                        const ingRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'ingredients', id);
                        batchPromises.push(updateDoc(ingRef, { stock: ing.stock - qty }));
                    }
                    
                    for (const [id, qty] of Object.entries(prodUpdates)) {
                        const prod = products.find(p => p.id === id);
                        const prodRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'products', id);
                        batchPromises.push(updateDoc(prodRef, { stock: prod.stock - qty }));
                        batchPromises.push(addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'stock_history'), {
                            productId: id, productName: prod.name, change: -qty, type: 'sale', refId: ref.id, reason: 'Penjualan POS', createdAt: serverTimestamp()
                        }));
                    }

                    await Promise.all(batchPromises);

                    await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'shifts', shift.id), {
                        transactionsCount: (shift.transactionsCount || 0) + 1,
                        totalSales: (shift.totalSales || 0) + transData.total
                    });

                    setLastTrans({id: ref.id, ...transData});
                    setCart([]); setDiscount(0); setSelectedCustomer(null); setSelectedTable(null);
                } catch (e) { alert("Gagal transaksi: " + e.message); }
            };

            const handlePaymentSubmit = async (e) => {
                e.preventDefault();
                const amount = Number(e.target.amount.value);
                const debt = modalConfig.data;
                const newPaid = (debt.paid || 0) + amount;
                const status = newPaid >= debt.amount ? 'paid' : 'partial';
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'debts', debt.id), {
                    paid: newPaid, status: status, lastPayment: serverTimestamp()
                });
                setModalConfig({show:false});
            };

            const handleAdjustStock = async (e) => { 
                e.preventDefault();
                const f = e.target;
                const qty = Number(f.qty.value);
                const type = f.type.value;
                const change = type === 'in' ? qty : -qty;
                const prod = modalConfig.data;
                
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'products', prod.id), { stock: prod.stock + change });
                await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'stock_history'), {
                    productId: prod.id, productName: prod.name, change: change, type: 'adjustment', reason: f.reason.value, createdAt: serverTimestamp()
                });
                setModalConfig({show: false});
            };

            const saveSettings = async (e) => {
                e.preventDefault();
                const f = e.target;
                await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'profile'), {
                    name: f.name.value, address: f.address.value, phone: f.phone.value, logo: f.logo.value,
                    footerMessage: f.footerMessage.value, taxRate: Number(f.taxRate.value), serviceRate: Number(f.serviceRate.value)
                });
                setModalConfig({ show: false });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const f = e.target;
                const type = modalConfig.type;
                const isEdit = !!modalConfig.data;
                const collPath = ['artifacts', APP_ID, 'users', user.uid];
                
                let collectionName = type + 's';
                if (type === 'staff') collectionName = 'staff';
                if (type === 'ingredient') collectionName = 'ingredients';

                let payload = {};

                try {
                    if (type === 'product') {
                        payload = { 
                            name: f.name.value, barcode: f.barcode.value, category: f.category.value, 
                            price: Number(f.price.value), hpp: Number(f.hpp.value), stock: Number(f.stock.value), image: f.image.value,
                            wholesaleQty: Number(f.wholesaleQty.value), wholesalePrice: Number(f.wholesalePrice.value)
                        };
                    } else if (type === 'ingredient') {
                         payload = { name: f.name.value, unit: f.unit.value, stock: Number(f.stock.value), costPerUnit: Number(f.costPerUnit.value) };
                    } else if (type === 'recipe_setup') {
                         const currentRecipe = modalConfig.data.recipe || [];
                         const ingId = f.ingId.value;
                         const qty = Number(f.qty.value);
                         const newRecipe = [...currentRecipe, {ingId, qty}];
                         await updateDoc(doc(db, ...collPath, 'products', modalConfig.data.id), { recipe: newRecipe });
                         setModalConfig({ show: false });
                         return;
                    } else if (type === 'customer') {
                        payload = { name: f.name.value, phone: f.phone.value, email: f.email.value };
                    } else if (type === 'supplier') {
                        payload = { name: f.name.value, phone: f.phone.value, address: f.address.value };
                    } else if (type === 'table') {
                        payload = { name: f.name.value, capacity: f.capacity.value };
                    } else if (type === 'staff') {
                        if(!f.pin.value) throw new Error("PIN Wajib diisi!");
                        payload = { name: f.name.value, pin: f.pin.value, role: f.role.value };
                    } else if (type === 'expense') {
                        payload = { name: f.name.value, amount: Number(f.amount.value), category: f.category.value, date: serverTimestamp() };
                    }

                    if (isEdit) {
                        await updateDoc(doc(db, ...collPath, collectionName, modalConfig.data.id), { ...payload, updatedAt: serverTimestamp() });
                    } else {
                        await addDoc(collection(db, ...collPath, collectionName), { ...payload, createdAt: serverTimestamp() });
                    }
                    
                    setModalConfig({ show: false });
                } catch (err) { alert("GAGAL SIMPAN: " + err.message); }
            };

            // --- RENDERERS ---
            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">Loading Kasir Pro...</div>;
            if (!user) return <LoginScreen />;
            
            if (user && !activeStaff) {
                return (
                    <div className="h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl text-center">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="lock" size={32}/></div>
                            <h2 className="text-2xl font-bold mb-2">Siapa yang bertugas?</h2>
                            <p className="text-gray-500 mb-6 text-sm">Masuk sebagai: <span className="font-bold text-blue-600">{user.phoneNumber || user.email || 'Anonim'}</span></p>
                            <div className="grid grid-cols-2 gap-3 mb-6">
                                {staff.map(s => (
                                    <button key={s.id} onClick={() => {
                                        const pin = prompt(`Masukkan PIN untuk ${s.name}:`);
                                        if(pin === s.pin) { setActiveStaff(s); if(s.role==='admin') setView('dashboard'); else setView('pos'); } 
                                        else alert("PIN Salah!");
                                    }} className="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition group">
                                        <div className="font-bold text-lg group-hover:text-blue-600">{s.name}</div>
                                        <div className="text-xs text-gray-400 uppercase">{s.role}</div>
                                    </button>
                                ))}
                            </div>
                            <div className="border-t pt-4 mt-4">
                                <button onClick={() => signOut(auth)} className="text-red-500 text-sm font-bold flex items-center justify-center gap-2 w-full hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Ganti Akun Pemilik</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (user && !shift && view === 'pos') {
                return (
                    <Modal title="Buka Shift (Modal Awal)" onClose={()=>{}}>
                        <form onSubmit={async(e)=>{
                            e.preventDefault();
                            await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'shifts'), {
                                startCash: Number(e.target.startCash.value), startTime: serverTimestamp(), status: 'open', transactionsCount:0, totalSales:0
                            });
                        }}>
                            <input name="startCash" type="number" placeholder="Modal Awal (Rp)" required className="w-full p-3 border rounded-lg mb-4"/>
                            <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Buka Toko</button>
                        </form>
                    </Modal>
                );
            }

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden text-slate-800">
                    <aside className="w-20 md:w-64 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 z-20 overflow-y-auto">
                        <div className="h-16 flex items-center justify-center md:justify-start md:px-6 bg-slate-950 text-white font-bold gap-3 flex-shrink-0 sticky top-0 z-10">
                            <div className="bg-blue-600 p-2 rounded-lg"><Icon name="zap" size={20}/></div>
                            <span className="hidden md:block">Kasir Pro v6</span>
                        </div>
                        <nav className="flex-1 py-4 space-y-1 px-2">
                            <div className="px-3 mb-6 flex items-center gap-3 pb-4 border-b border-slate-800">
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white">{activeStaff?.name[0]}</div>
                                <div className="hidden md:block">
                                    <div className="text-sm font-bold text-white">{activeStaff?.name}</div>
                                    <div className="text-xs text-slate-500 uppercase">{activeStaff?.role}</div>
                                </div>
                                <button onClick={()=>setActiveStaff(null)} className="ml-auto text-slate-500 hover:text-white"><Icon name="log-out" size={16}/></button>
                            </div>

                            <div className="text-xs font-bold text-slate-500 px-3 mb-2 uppercase hidden md:block">Utama</div>
                            
                            {/* [FIX ROLES] TUGAS TAMBAHAN KASIR & WAITER */}
                            {[
                                {id: 'pos', icon: 'monitor', label: 'Kasir / POS', roles: ['admin', 'kasir', 'waiter']},
                                {id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard', roles: ['admin']},
                                // Kasir boleh buka Expenses & Pelanggan
                                {id: 'expenses', icon: 'wallet', label: 'Pengeluaran', roles: ['admin', 'kasir']},
                                {id: 'debts', icon: 'book', label: 'Hutang / Kasbon', roles: ['admin', 'kasir']},
                                {id: 'customers', icon: 'users', label: 'Pelanggan', roles: ['admin', 'kasir']},
                            ].filter(m => m.roles.includes(activeStaff?.role)).map(m => (
                                <button key={m.id} onClick={() => setView(m.id)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m.id ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <Icon name={m.icon} /> <span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                            
                            {/* [FIX ROLES] GUDANG & DATA */}
                            {(activeStaff?.role === 'admin' || activeStaff?.role === 'gudang') && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Gudang & Data</div>
                                
                                {['inventory', 'ingredients'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name={m==='inventory'?'clipboard-list':'flask-conical'} size={18} /> <span className="hidden md:block font-medium">{m==='inventory'?'Stok Opname':'Bahan Baku'}</span>
                                    </button>
                                ))}
                                
                                {['products', 'staff', 'tables', 'suppliers'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name="database" size={18} /> <span className="hidden md:block font-medium">{m}</span>
                                    </button>
                                ))}
                            </>}
                            
                            {/* [FIX ROLES] SETTING ADMIN ONLY */}
                            {activeStaff?.role === 'admin' && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Sistem</div>
                                <button onClick={() => {setSettingsTab('profile'); setModalConfig({show:true, type:'settings'})}} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl hover:bg-slate-800">
                                    <Icon name="settings" /> <span className="hidden md:block font-medium">Pengaturan</span>
                                </button>
                            </>}
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={()=>{if(confirm("Tutup Shift?")) updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'shifts',shift.id),{status:'closed', endTime:serverTimestamp()})}} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl bg-red-900/30 text-red-400 hover:bg-red-900/50 transition">
                                <Icon name="power" /> <span className="hidden md:block">Tutup Toko</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        {view === 'pos' && (
                            <div className="flex h-full flex-col md:flex-row">
                                <div className="flex-1 bg-gray-50 flex flex-col min-w-0">
                                    <div className="p-4 bg-white border-b flex gap-3 items-center">
                                        <div className="relative flex-1">
                                            <Icon name="scan-barcode" className="absolute left-3 top-3 text-gray-400"/>
                                            <input className="w-full pl-10 p-2.5 rounded-lg border bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Scan Barcode / Cari nama..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} autoFocus/>
                                        </div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start">
                                        {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || (p.barcode && p.barcode.includes(searchQuery))).map(p => {
                                            const hasRecipe = p.recipe && p.recipe.length > 0;
                                            return (
                                                <div key={p.id} onClick={() => addToCart(p)} className={`relative bg-white rounded-xl shadow-sm border p-3 cursor-pointer hover:shadow-md transition ${!hasRecipe && p.stock<=0 && 'opacity-50'} ${!hasRecipe && p.stock<=5 && p.stock > 0 ? 'border-red-300 bg-red-50' : ''}`}>
                                                    {!hasRecipe && p.stock <= 5 && p.stock > 0 && <div className="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full z-10 animate-pulse">Menipis</div>}
                                                    <div className="h-24 bg-gray-100 rounded-lg mb-2 overflow-hidden">
                                                        {p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icon name="image" size={32}/></div>}
                                                    </div>
                                                    <h4 className="font-bold truncate">{p.name}</h4>
                                                    <div className="flex justify-between mt-1 items-center">
                                                        <span className="text-blue-600 font-bold">{formatCurrency(p.price)}</span>
                                                        <span className={`text-xs px-1.5 py-0.5 rounded font-bold ${hasRecipe ? 'bg-purple-100 text-purple-700' : (p.stock<=5 ? 'bg-red-200 text-red-800' : 'bg-gray-100')}`}>
                                                            {hasRecipe ? 'F&B' : p.stock}
                                                        </span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="w-full md:w-96 bg-white shadow-2xl z-10 flex flex-col border-l">
                                    <div className="p-4 border-b bg-gray-50 space-y-2">
                                        <div className="flex gap-2">
                                            <select className="flex-1 p-2 border rounded bg-white text-sm" value={orderType} onChange={e=>setOrderType(e.target.value)}><option>Dine In</option><option>Take Away</option></select>
                                            {orderType === 'Dine In' && <select className="flex-1 p-2 border rounded bg-white text-sm" value={selectedTable?.name||''} onChange={e=>setSelectedTable(tables.find(t=>t.name===e.target.value)||null)}><option value="">Pilih Meja</option>{tables.map(t=><option key={t.id} value={t.name}>{t.name}</option>)}</select>}
                                        </div>
                                        <select className="w-full p-2 border rounded bg-white text-sm" value={selectedCustomer?.id||''} onChange={e=>setSelectedCustomer(customers.find(c=>c.id===e.target.value)||null)}><option value="">Pelanggan Umum</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-2">
                                        {cart.map(i => (
                                            <div key={i.id} onClick={()=>{setEditingItem({...i}); setModalConfig({show:true, type:'edit_cart_item'})}} className="flex justify-between items-center bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100">
                                                <div className="flex-1">
                                                    <div className="font-bold text-sm">{i.name}</div>
                                                    <div className="text-xs text-blue-600">
                                                        {formatCurrency(i.price)} x {i.qty} 
                                                        {i.wholesaleQty && i.qty >= i.wholesaleQty && <span className="text-green-600 font-bold ml-1 text-[10px]">(Grosir)</span>}
                                                    </div>
                                                    {i.note && <div className="text-[10px] text-gray-500 italic">"{i.note}"</div>}
                                                </div>
                                                
                                                <div className="flex items-center gap-2 mr-2" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={()=>updateCartQty(i, -1)} className="w-6 h-6 bg-gray-200 rounded text-sm hover:bg-gray-300">-</button>
                                                    <span className="font-bold text-sm w-4 text-center">{i.qty}</span>
                                                    <button onClick={()=>updateCartQty(i, 1)} className="w-6 h-6 bg-gray-200 rounded text-sm hover:bg-gray-300">+</button>
                                                    
                                                    {/* TOMBOL HAPUS BARU (SAMPAH) */}
                                                    <button onClick={()=>removeFromCart(i.id)} className="ml-2 p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                                                        <Icon name="trash-2" size={14}/>
                                                    </button>
                                                </div>
                                                
                                                <div className="font-bold text-sm">{formatCurrency((i.price*i.qty)- (i.itemDiscount||0))}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 bg-slate-50 border-t space-y-2">
                                        <div className="flex gap-2"><input type="number" placeholder="Diskon" className="w-full p-2 border rounded text-sm" value={discount > 0 ? discount : ''} onChange={e=>setDiscount(Number(e.target.value))} /></div>
                                        <div className="space-y-1 text-sm pt-2 border-t border-dashed">
                                            <div className="flex justify-between text-gray-500"><span>Subtotal</span><span>{formatCurrency(calculateTotals().subtotal)}</span></div>
                                            {calculateTotals().tax > 0 && <div className="flex justify-between text-gray-500"><span>Pajak ({calculateTotals().taxRate}%)</span><span>{formatCurrency(calculateTotals().tax)}</span></div>}
                                            {calculateTotals().serviceCharge > 0 && <div className="flex justify-between text-gray-500"><span>Service ({calculateTotals().serviceRate}%)</span><span>{formatCurrency(calculateTotals().serviceCharge)}</span></div>}
                                            <div className="flex justify-between font-bold text-lg pt-2"><span>Total</span><span>{formatCurrency(calculateTotals().total)}</span></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            {['Tunai', 'Hutang', 'QRIS'].map(m => (
                                                <button key={m} onClick={()=>setPaymentMethod(m)} className={`py-2 rounded border font-medium ${paymentMethod===m ? 'bg-slate-800 text-white' : 'bg-white'}`}>{m}</button>
                                            ))}
                                        </div>
                                        <button onClick={handleCheckout} disabled={!cart.length} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 disabled:bg-gray-300">Bayar</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Executive Dashboard</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Omzet Kotor</p><h3 className="text-2xl font-bold text-blue-600">{formatCurrency(transactions.reduce((a,b)=>a+(b.total||0),0))}</h3></div>
                                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white p-5 rounded-xl shadow-lg"><p className="text-green-100 text-sm">Net Profit (Bersih)</p><h3 className="text-2xl font-bold">{formatCurrency(transactions.reduce((a,b)=>a+(b.profit||0),0) - expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Pengeluaran</p><h3 className="text-2xl font-bold text-red-600">{formatCurrency(expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Piutang Belum Bayar</p><h3 className="text-2xl font-bold text-orange-600">{formatCurrency(debts.reduce((a,b)=>a + (b.status!=='paid' ? (b.amount - b.paid) : 0),0))}</h3></div>
                                </div>
                            </div>
                        )}

                        {view === 'debts' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Buku Hutang (Piutang)</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {debts.sort((a,b)=>b.createdAt-a.createdAt).map(d => (
                                        <div key={d.id} className={`bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition ${d.status==='paid' ? 'opacity-60 grayscale' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 className="font-bold text-lg">{d.customerName}</h4>
                                                    <div className="text-xs text-gray-500">{formatDate(d.createdAt)}</div>
                                                </div>
                                                <span className={`text-xs px-2 py-1 rounded font-bold uppercase ${d.status==='paid'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>{d.status}</span>
                                            </div>
                                            <div className="space-y-1 my-3 text-sm">
                                                <div className="flex justify-between"><span>Total Hutang:</span> <span className="font-bold">{formatCurrency(d.amount)}</span></div>
                                                <div className="flex justify-between text-green-600"><span>Sudah Bayar:</span> <span>{formatCurrency(d.paid || 0)}</span></div>
                                                <div className="flex justify-between text-red-600 border-t pt-1 font-bold"><span>Sisa:</span> <span>{formatCurrency(d.amount - (d.paid||0))}</span></div>
                                            </div>
                                            {d.status !== 'paid' && (
                                                <button onClick={()=>setModalConfig({show:true, type:'pay_debt', data:d})} className="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold mt-2 hover:bg-blue-700">Bayar / Cicil</button>
                                            )}
                                        </div>
                                    ))}
                                    {debts.length === 0 && <div className="col-span-full text-center text-gray-400 py-10">Tidak ada data hutang</div>}
                                </div>
                            </div>
                        )}

                        {view === 'expenses' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Pengeluaran Operasional</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'expense'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b"><tr><th className="p-4">Nama</th><th className="p-4">Kategori</th><th className="p-4">Tanggal</th><th className="p-4 text-right">Jumlah</th><th className="p-4 text-center">Aksi</th></tr></thead>
                                        <tbody>
                                            {expenses.map(e => (
                                                <tr key={e.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-4 font-bold">{e.name}</td>
                                                    <td className="p-4"><span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">{e.category}</span></td>
                                                    <td className="p-4 text-sm text-gray-500">{formatDate(e.date)}</td>
                                                    <td className="p-4 text-right font-mono font-bold text-red-600">{formatCurrency(e.amount)}</td>
                                                    <td className="p-4 text-center">
                                                        <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'expenses',e.id))}} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash" size={16}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'ingredients' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Stok Bahan Baku (Gudang)</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'ingredient'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {ingredients.map(i => (
                                        <div key={i.id} onClick={()=>setModalConfig({show:true, type:'ingredient', data:i})} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><Icon name="flask-conical" size={20}/></div>
                                                <div>
                                                    <h4 className="font-bold">{i.name}</h4>
                                                    <div className="text-xs text-gray-500">Stok: <b className="text-blue-600">{i.stock} {i.unit}</b></div>
                                                </div>
                                            </div>
                                            <div className="mt-2 text-xs bg-gray-50 p-2 rounded text-center">Cost: {formatCurrency(i.costPerUnit)} / {i.unit}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {['products', 'customers', 'suppliers', 'tables', 'staff'].includes(view) && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 capitalize">
                                    <h2 className="text-2xl font-bold">{view}</h2>
                                    <button onClick={()=>setModalConfig({show:true, type: view === 'staff' ? 'staff' : view.slice(0,-1)})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(view==='products'?products:view==='customers'?customers:view==='suppliers'?suppliers:view==='staff'?staff:tables).map(item => (
                                        <div key={item.id} className="bg-white p-4 rounded-xl border hover:shadow-md transition relative group">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold flex-shrink-0">
                                                    {view==='products' && item.image ? <img src={item.image} className="w-full h-full object-cover rounded-full"/> : item.name[0]}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <h4 className="font-bold truncate">{item.name}</h4>
                                                    {view==='products' && <div className="text-sm text-blue-600 font-bold">{formatCurrency(item.price)}</div>}
                                                    {view==='products' && <div className="text-xs text-gray-500 mt-1">Stok: {item.stock}</div>}
                                                    
                                                    {view==='products' && (
                                                        <div className="mt-2 pt-2 border-t border-dashed">
                                                            {item.recipe && item.recipe.length > 0 ? (
                                                                <div className="text-[10px] space-y-1">
                                                                    <div className="font-bold text-gray-400">RESEP:</div>
                                                                    {item.recipe.map((r,idx) => {
                                                                        const ing = ingredients.find(i=>i.id===r.ingId);
                                                                        return <div key={idx} className="flex justify-between bg-purple-50 text-purple-700 px-1 rounded"><span>{ing?.name}</span><span>{r.qty} {ing?.unit}</span></div>
                                                                    })}
                                                                    <button onClick={()=>updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'products',item.id), {recipe: []})} className="text-red-500 hover:underline w-full text-center mt-1">Reset Resep</button>
                                                                </div>
                                                            ) : <div className="text-[10px] text-gray-400 italic">Tanpa Resep (Stok Langsung)</div>}
                                                            <button onClick={()=>setModalConfig({show:true, type:'recipe_setup', data:item})} className="w-full mt-1 bg-gray-100 text-xs py-1 rounded font-bold hover:bg-gray-200">+ Atur Resep</button>
                                                        </div>
                                                    )}

                                                    {view==='staff' && <div className="text-sm text-gray-500 uppercase font-bold text-blue-600">{item.role} (PIN: {item.pin})</div>}
                                                    {view==='tables' && <div className="text-sm text-gray-500">Kapasitas: {item.capacity} org</div>}
                                                    {(view==='customers'||view==='suppliers') && <div className="text-sm text-gray-500">{item.phone}</div>}
                                                </div>
                                            </div>
                                            <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                                <button onClick={()=>setModalConfig({show:true, type: view === 'staff' ? 'staff' : view.slice(0,-1), data:item})} className="p-1.5 bg-gray-100 hover:text-blue-600 rounded"><Icon name="edit-2" size={14}/></button>
                                                <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,view,item.id))}} className="p-1.5 bg-gray-100 hover:text-red-600 rounded"><Icon name="trash" size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {view === 'inventory' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-4">Stok Opname (Produk Jadi)</h2>
                                <div className="bg-white p-4 rounded-xl border">
                                    {products.map(p => (
                                        <div key={p.id} className="flex justify-between items-center border-b p-2">
                                            <div>{p.name} <span className="text-xs bg-gray-100 px-1 rounded">{p.stock}</span></div>
                                            <button onClick={()=>setModalConfig({show:true, type:'stock_adj', data:p})} className="text-blue-600 text-xs border border-blue-600 px-2 py-1 rounded">Sesuaikan</button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* DYNAMIC MODAL FORM */}
                    {modalConfig.show && (
                        <Modal title={modalConfig.type.replace('_', ' ')} onClose={()=>setModalConfig({show:false})}>
                            
                            {modalConfig.type === 'pay_debt' && (
                                <form onSubmit={handlePaymentSubmit} className="space-y-4">
                                    <div className="bg-blue-50 p-3 rounded-lg text-sm">
                                        <p>Pelanggan: <b>{modalConfig.data.customerName}</b></p>
                                        <p>Sisa Hutang: <b className="text-red-600">{formatCurrency(modalConfig.data.amount - modalConfig.data.paid)}</b></p>
                                    </div>
                                    <input name="amount" type="number" placeholder="Jumlah Bayar" max={modalConfig.data.amount - modalConfig.data.paid} required className="w-full p-3 border rounded-lg"/>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Proses Pembayaran</button>
                                </form>
                            )}
                        
                            {modalConfig.type === 'stock_adj' && (
                                <form onSubmit={handleAdjustStock} className="space-y-4">
                                    <div className="text-sm">Produk: <b>{modalConfig.data.name}</b></div>
                                    <select name="type" className="w-full p-3 border rounded-lg"><option value="in">Masuk</option><option value="out">Keluar</option></select>
                                    <input name="qty" type="number" placeholder="Jumlah" required className="w-full p-3 border rounded-lg"/>
                                    <textarea name="reason" placeholder="Keterangan" className="w-full p-3 border rounded-lg" required></textarea>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan</button>
                                </form>
                            )}

                            {modalConfig.type === 'edit_cart_item' && (
                                <div className="space-y-4">
                                    <h3 className="font-bold">{editingItem.name}</h3>
                                    <div className="flex gap-4 items-center">
                                        <button onClick={()=>setEditingItem(p=>({...p, qty: Math.max(1, p.qty-1)}))} className="p-2 bg-gray-200 rounded">-</button>
                                        <span className="font-bold">{editingItem.qty}</span>
                                        <button onClick={()=>setEditingItem(p=>({...p, qty: p.qty+1}))} className="p-2 bg-gray-200 rounded">+</button>
                                    </div>
                                    <input type="text" placeholder="Catatan Item (Pedas/Tanpa Es)" value={editingItem.note||''} onChange={e=>setEditingItem(p=>({...p, note:e.target.value}))} className="w-full p-2 border rounded text-sm"/>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{setCart(cart.filter(c=>c.id!==editingItem.id)); setModalConfig({show:false});}} className="flex-1 bg-red-100 text-red-600 py-3 rounded">Hapus</button>
                                        <button onClick={()=>{setCart(cart.map(c=>c.id===editingItem.id ? editingItem : c)); setModalConfig({show:false});}} className="flex-1 bg-blue-600 text-white py-3 rounded">Simpan</button>
                                    </div>
                                </div>
                            )}

                            {modalConfig.type === 'settings' && (
                                <form onSubmit={saveSettings} className="space-y-4">
                                    <input name="name" placeholder="Nama Toko" defaultValue={storeProfile?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="address" placeholder="Alamat Lengkap" defaultValue={storeProfile?.address} className="w-full p-3 border rounded-lg"/>
                                    <input name="phone" placeholder="No. Telepon" defaultValue={storeProfile?.phone} className="w-full p-3 border rounded-lg"/>
                                    <input name="logo" placeholder="URL Logo (Link Gambar)" defaultValue={storeProfile?.logo} className="w-full p-3 border rounded-lg"/>
                                    <textarea name="footerMessage" placeholder="Pesan di Bawah Struk" defaultValue={storeProfile?.footerMessage} className="w-full p-3 border rounded-lg"/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs">Pajak (%)</label><input name="taxRate" type="number" step="0.1" defaultValue={storeProfile?.taxRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                        <div><label className="text-xs">Service (%)</label><input name="serviceRate" type="number" step="0.1" defaultValue={storeProfile?.serviceRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                    </div>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan Pengaturan</button>
                                </form>
                            )}
                            
                            {modalConfig.type === 'ingredient' && (
                                <form onSubmit={handleSubmit} className="space-y-4 capitalize">
                                    <input name="name" placeholder="Nama Bahan (Misal: Beras)" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="unit" placeholder="Satuan (kg, gram, butir)" required defaultValue={modalConfig.data?.unit} className="w-full p-3 border rounded-lg"/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="stock" type="number" placeholder="Stok Awal" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                        <input name="costPerUnit" type="number" placeholder="Harga Beli / Satuan" required defaultValue={modalConfig.data?.costPerUnit} className="w-full p-3 border rounded-lg"/>
                                    </div>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan Bahan</button>
                                </form>
                            )}

                            {modalConfig.type === 'recipe_setup' && (
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="bg-purple-50 p-3 rounded text-sm text-purple-700 font-bold border border-purple-200">
                                        Menambah komposisi resep untuk: <br/><span className="text-lg">{modalConfig.data.name}</span>
                                    </div>
                                    <select name="ingId" className="w-full p-3 border rounded-lg bg-white" required>
                                        <option value="">-- Pilih Bahan Baku --</option>
                                        {ingredients.map(i=><option key={i.id} value={i.id}>{i.name} ({i.unit})</option>)}
                                    </select>
                                    <input name="qty" type="number" step="0.01" placeholder="Jumlah Takaran Pemakaian" required className="w-full p-3 border rounded-lg"/>
                                    <p className="text-xs text-gray-500">Contoh: Jika Nasi Goreng butuh 200 gram beras, pilih "Beras" lalu isi "200".</p>
                                    <button className="w-full bg-purple-600 text-white p-3 rounded-lg font-bold">Tambahkan ke Resep</button>
                                </form>
                            )}

                            {['product', 'customer', 'supplier', 'expense', 'table', 'staff'].includes(modalConfig.type) && (
                                <form onSubmit={handleSubmit} className="space-y-4 capitalize">
                                    <input name="name" placeholder="Nama" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                    
                                    {modalConfig.type === 'product' && <>
                                        <input name="barcode" placeholder="Barcode" defaultValue={modalConfig.data?.barcode} className="w-full p-3 border rounded-lg"/>
                                        <input name="category" placeholder="Kategori" defaultValue={modalConfig.data?.category} className="w-full p-3 border rounded-lg"/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="price" type="number" placeholder="Harga" required defaultValue={modalConfig.data?.price} className="w-full p-3 border rounded-lg"/>
                                            <input name="hpp" type="number" placeholder="HPP (Manual/Override)" defaultValue={modalConfig.data?.hpp} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="stock" type="number" placeholder="Stok (Produk Jadi)" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                            <input name="image" placeholder="Link Gambar" defaultValue={modalConfig.data?.image} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        
                                        <div className="p-3 bg-gray-50 border rounded-lg">
                                            <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Setting Harga Grosir</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <input name="wholesaleQty" type="number" placeholder="Min Qty (Misal: 10)" defaultValue={modalConfig.data?.wholesaleQty} className="w-full p-2 border rounded bg-white text-sm"/>
                                                <input name="wholesalePrice" type="number" placeholder="Harga Grosir (Rp)" defaultValue={modalConfig.data?.wholesalePrice} className="w-full p-2 border rounded bg-white text-sm"/>
                                            </div>
                                        </div>
                                    </>}

                                    {modalConfig.type === 'staff' && <>
                                        <input name="pin" type="text" placeholder="PIN Akses" required defaultValue={modalConfig.data?.pin} className="w-full p-3 border rounded-lg"/>
                                        {/* [FIX FORM STAFF] Tambah Opsi Gudang & Waiter */}
                                        <select name="role" defaultValue={modalConfig.data?.role||'kasir'} className="w-full p-3 border rounded-lg">
                                            <option value="kasir">Kasir (Jualan)</option>
                                            <option value="admin">Admin (Full Akses)</option>
                                            <option value="gudang">Gudang (Stok)</option>
                                            <option value="waiter">Waiter (Input Order)</option>
                                        </select>
                                    </>}
                                    
                                    {modalConfig.type === 'expense' && <>
                                        <input name="amount" type="number" placeholder="Jumlah Biaya (Rp)" required defaultValue={modalConfig.data?.amount} className="w-full p-3 border rounded-lg"/>
                                        <select name="category" defaultValue={modalConfig.data?.category} className="w-full p-3 border rounded-lg"><option value="Operasional">Operasional</option><option value="Gaji">Gaji Karyawan</option><option value="Belanja">Belanja Bahan</option><option value="Lainnya">Lainnya</option></select>
                                    </>}
                                    
                                    {modalConfig.type === 'customer' && <><input name="phone" placeholder="No HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/><input name="email" placeholder="Email (Opsional)" defaultValue={modalConfig.data?.email} className="w-full p-3 border rounded-lg"/></>}
                                    {modalConfig.type === 'supplier' && <><input name="phone" placeholder="No HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/><input name="address" placeholder="Alamat" defaultValue={modalConfig.data?.address} className="w-full p-3 border rounded-lg"/></>}
                                    {modalConfig.type === 'table' && <input name="capacity" type="number" placeholder="Kapasitas (Orang)" defaultValue={modalConfig.data?.capacity} className="w-full p-3 border rounded-lg"/>}

                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan</button>
                                </form>
                            )}
                        </Modal>
                    )}

                    <Receipt data={lastTrans} storeProfile={storeProfile} onClose={()=>setLastTrans(null)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
