<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Pintar Pro v9.6 - Waiter Mode Fixed</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        @media print { 
            .no-print { display: none !important; }
            @page { margin: 0; }
            body { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => { lucide.createIcons({ root: iconRef.current ? iconRef.current.parentNode : document, nameAttr: 'data-lucide', attrs: {class: className} }); }, [name]);
            return <i ref={iconRef} data-lucide={name} width={size} height={size} className={className}></i>;
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, setDoc, limit, enableIndexedDbPersistence, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4t1Gya_QHDzTkYsF7U-pw1Uo1oQUABpM",
            authDomain: "websitemarkaz.firebaseapp.com",
            databaseURL: "https://websitemarkaz-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "websitemarkaz",
            storageBucket: "websitemarkaz.firebasestorage.app",
            messagingSenderId: "5529883980",
            appId: "1:5529883980:web:792ce6d869070e9a79ebe9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {});

        const APP_ID = "kasir-pintar-pro-v6";
        const formatCurrency = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val || 0);
        
        const formatNumberInput = (numStr) => {
            if (!numStr) return '';
            const num = numStr.replace(/\D/g, ''); 
            return new Intl.NumberFormat('id-ID').format(num);
        };

        const parseNumberInput = (formattedStr) => {
            if (!formattedStr) return 0;
            return Number(formattedStr.replace(/\./g, ''));
        };
        
        const formatDate = (ts) => {
            if (!ts) return '-';
            try {
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium', timeStyle: 'short' }).format(date);
            } catch (e) { return '-'; }
        };

        const Modal = ({ title, onClose, children, maxWidth = "max-w-md" }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" style={{zIndex: 1000}}>
                <div className={`bg-white rounded-2xl w-full ${maxWidth} shadow-2xl overflow-hidden flex flex-col max-h-[90vh]`}>
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800 uppercase">{title}</h3>
                        <button onClick={onClose} className="hover:bg-gray-200 p-1 rounded-full"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        const MemberCardModal = ({ customer, storeProfile, onClose }) => {
            const [isProcessing, setIsProcessing] = useState(false);
            const qrRef = useRef(null);

            useEffect(() => {
                if (qrRef.current) {
                    qrRef.current.innerHTML = "";
                    try {
                        new QRCode(qrRef.current, {
                            text: customer.memberCode,
                            width: 100, height: 100,
                            colorDark : "#000000", colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    } catch(e) { console.error("QR Error", e); }
                }
            }, [customer]);
            
            const handleShare = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                try {
                    const element = document.getElementById('member-card-capture');
                    if (!element) throw new Error("Elemen kartu tidak ditemukan");

                    const canvas = await html2canvas(element, { scale: 1.5, backgroundColor: null, logging: false, useCORS: true });

                    canvas.toBlob(async (blob) => {
                        if (!blob) { alert("Gagal membuat gambar."); setIsProcessing(false); return; }
                        
                        const file = new File([blob], `Member-${customer.name}.png`, { type: "image/png" });

                        if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                            try {
                                await navigator.share({
                                    title: `Member ${customer.name}`,
                                    text: `Kartu Member ${storeProfile?.name || 'Toko'}.`,
                                    files: [file]
                                });
                            } catch (err) {}
                        } else {
                            const link = document.createElement('a');
                            link.href = URL.createObjectURL(blob);
                            link.download = `Member-${customer.name}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            alert("Gambar disimpan ke Download.");
                        }
                        setIsProcessing(false);
                    }, 'image/png');
                } catch (err) {
                    console.error("Capture Error:", err);
                    alert("Terjadi kesalahan saat memproses gambar.");
                    setIsProcessing(false);
                }
            };

            return (
                <Modal title="Kartu Member Digital" onClose={onClose}>
                    <div id="member-card-capture" className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-6 text-white shadow-xl relative overflow-hidden mb-4 transform-gpu">
                        <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                        <div className="flex justify-between items-start">
                            <div>
                                <h3 className="font-bold text-xl">{storeProfile?.name || 'Toko Member'}</h3>
                                <p className="text-xs text-blue-200 uppercase tracking-widest mt-1">Kartu Keanggotaan</p>
                            </div>
                            <div className="bg-white p-2 rounded-lg">
                                <div ref={qrRef}></div>
                            </div>
                        </div>
                        <div className="mt-6">
                            <p className="text-2xl font-bold font-mono tracking-wider">{customer.memberCode}</p>
                            <p className="text-sm mt-1 font-bold uppercase">{customer.name}</p>
                            <div className="flex justify-between items-end mt-2">
                                <p className="text-xs text-blue-200">Member Sejak: {new Date().getFullYear()}</p>
                                <div className="text-right">
                                    <span className="text-[10px] text-blue-200 block">POIN</span>
                                    <span className="font-bold text-xl">{customer.points || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onClick={handleShare} disabled={isProcessing} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-green-700 transition">
                        {isProcessing ? 'Memproses...' : <><Icon name="share-2" size={18}/> Bagikan / Simpan Kartu</>}
                    </button>
                </Modal>
            );
        };

        const BarcodeScanner = ({ onScan, onClose, isInline = false }) => {
            const scannerRef = useRef(null);
            const html5QrCodeRef = useRef(null);

            useEffect(() => {
                const timer = setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    
                    html5QrCode.start({ facingMode: "environment" }, config, 
                        (decodedText) => onScan(decodedText),
                        (errorMessage) => {}
                    ).catch(err => {
                        console.error(err);
                        alert("Gagal membuka kamera.");
                        onClose();
                    });
                }, 300);

                return () => {
                    clearTimeout(timer);
                    if (html5QrCodeRef.current) {
                        if (html5QrCodeRef.current.isScanning) {
                            html5QrCodeRef.current.stop().then(() => html5QrCodeRef.current.clear()).catch(e=>{});
                        } else {
                            html5QrCodeRef.current.clear();
                        }
                    }
                };
            }, []);

            const content = (
                <div className="flex flex-col items-center w-full">
                    <div id="reader" className="w-full bg-black overflow-hidden rounded-lg relative" style={{minHeight: isInline ? '250px' : '300px'}}></div>
                    <p className="text-xs text-gray-500 mt-2 animate-pulse">Scan Barcode Produk / Member...</p>
                    {isInline && (
                        <button onClick={onClose} className="mt-3 bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <Icon name="x-circle" size={16}/> Tutup Kamera
                        </button>
                    )}
                </div>
            );

            if (isInline) return <div className="mb-4 p-4 bg-gray-100 rounded-xl border border-blue-200 shadow-inner">{content}</div>;
            return <Modal title="Scan Barcode" onClose={onClose}>{content}</Modal>;
        };

        const LoginScreen = () => {
            const [phone, setPhone] = useState('');
            const [otp, setOtp] = useState('');
            const [showOtp, setShowOtp] = useState(false);
            const [loading, setLoading] = useState(false);
            const [confirmObj, setConfirmObj] = useState(null);
            const recaptchaRef = useRef(null);

            useEffect(() => {
                if (window.recaptchaVerifier) window.recaptchaVerifier.clear();
                if (recaptchaRef.current) recaptchaRef.current.innerHTML = '';
            }, []);

            const handleGoogleLogin = async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (err) { alert(err.message); }
            };

            const handleSendOtp = async (e) => {
                e.preventDefault(); setLoading(true);
                let formatPhone = phone.trim().replace(/^0/, '+62');
                if (!formatPhone.startsWith('+')) formatPhone = '+62' + formatPhone;
                try {
                    if (!window.recaptchaVerifier) window.recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaRef.current, { 'size': 'invisible' });
                    const confirmation = await signInWithPhoneNumber(auth, formatPhone, window.recaptchaVerifier);
                    setConfirmObj(confirmation); setShowOtp(true); setLoading(false);
                } catch (err) { alert(err.message); setLoading(false); }
            };

            const handleVerifyOtp = async (e) => {
                e.preventDefault(); setLoading(true);
                try { await confirmObj.confirm(otp); } catch (err) { alert("Kode Salah"); setLoading(false); }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white w-full max-w-md rounded-2xl p-8 shadow-2xl overflow-hidden">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="store" size={32}/></div>
                            <h1 className="text-2xl font-bold text-gray-800">Kasir Pintar Pro</h1>
                            <p className="text-gray-500 text-sm">Masuk untuk mengelola toko Anda</p>
                        </div>
                        {!showOtp ? (
                            <form onSubmit={handleSendOtp} className="space-y-4">
                                <input type="tel" className="w-full p-3 border rounded-lg" placeholder="Nomor HP (Contoh: 812xxx)" value={phone} onChange={e=>setPhone(e.target.value)} required />
                                <div ref={recaptchaRef}></div>
                                <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">{loading?'Loading...':'Kirim OTP'}</button>
                                <div className="text-center text-xs text-gray-400 mt-4">ATAU</div>
                                <button type="button" onClick={handleGoogleLogin} className="w-full border p-3 rounded-lg mt-2 font-bold text-gray-600">Masuk dengan Google</button>
                            </form>
                        ) : (
                            <form onSubmit={handleVerifyOtp} className="space-y-4">
                                <input type="number" className="w-full p-3 border rounded-lg text-center text-xl" placeholder="Kode OTP" value={otp} onChange={e=>setOtp(e.target.value)} />
                                <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Verifikasi</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const Receipt = ({ data, storeProfile, onClose }) => {
            if (!data) return null;
            const paperWidth = storeProfile?.paperSize === '80mm' ? '80mm' : '58mm';
            const change = (data.cashReceived || 0) - data.total;

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col animate-fade-in" style={{maxWidth: '400px'}}>
                        <div className="bg-gray-900 text-white p-4 flex justify-between items-center no-print">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="check-circle" size={18}/> Transaksi Sukses</h3>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div id="print-area" className="p-4 bg-white overflow-y-auto max-h-[70vh] mx-auto" style={{width: paperWidth, fontFamily: 'monospace', fontSize: '12px'}}>
                            <div className="text-center mb-4">
                                {storeProfile?.logo && <img src={storeProfile.logo} className="h-12 mx-auto mb-2 object-contain" />}
                                <h2 className="text-lg font-bold uppercase">{storeProfile?.name || 'Toko Kasir Pro'}</h2>
                                <p className="text-gray-500">{storeProfile?.address}</p>
                                <p className="text-gray-500">{storeProfile?.phone}</p>
                            </div>
                            <div className="border-b border-dashed border-gray-400 pb-2 mb-2">
                                <p>#{data.id.slice(0,8).toUpperCase()} | {formatDate(data.createdAt)}</p>
                                <p>Cst: {data.customerName}</p>
                            </div>
                            <div className="space-y-2 mb-4">
                                {data.items.map((item, i) => (
                                    <div key={i} className="flex justify-between">
                                        <div className="flex-1 pr-2">
                                            <div>{item.name}</div>
                                            <div className="text-gray-500">{item.qty} x {formatCurrency(item.price)}</div>
                                        </div>
                                        <div>{formatCurrency((item.price * item.qty) - (item.itemDiscount || 0))}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-dashed border-gray-400 pt-2 text-right">
                                <div className="flex justify-between"><span>Subtotal</span><span>{formatCurrency(data.subtotal)}</span></div>
                                <div className="flex justify-between font-bold text-lg border-t border-dotted mt-2 pt-1"><span>Total</span><span>{formatCurrency(data.total)}</span></div>
                                
                                {data.paymentMethod === 'Tunai' && (
                                    <>
                                        <div className="flex justify-between text-xs mt-1"><span>Tunai:</span><span>{formatCurrency(data.cashReceived)}</span></div>
                                        <div className="flex justify-between text-xs"><span>Kembali:</span><span>{formatCurrency(change)}</span></div>
                                    </>
                                )}

                                {data.pointsEarned > 0 && (
                                    <div className="mt-2 pt-2 border-t border-dashed text-xs">
                                        <div className="flex justify-between"><span>Poin Transaksi:</span><span>+{data.pointsEarned}</span></div>
                                        <div className="flex justify-between font-bold"><span>Total Poin:</span><span>{data.customerPointsTotal}</span></div>
                                    </div>
                                )}
                                <div className="text-center mt-4 italic text-gray-500">{storeProfile?.footerMessage}</div>
                            </div>
                        </div>
                        <div className="p-4 bg-white border-t no-print">
                            <button onClick={() => {
                                const printContent = document.getElementById('print-area').innerHTML;
                                const originalContents = document.body.innerHTML;
                                document.body.innerHTML = printContent;
                                window.print();
                                document.body.innerHTML = originalContents;
                                window.location.reload(); 
                            }} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-700">
                                <Icon name="printer" size={18}/> Cetak Struk
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
			const [user, setUser] = useState(null);
			// [ADD] State untuk menyimpan ID Toko yang sedang diakses
			const [storeId, setStoreId] = useState(localStorage.getItem('kp_store_id')); 
			const [view, setView] = useState('pos');
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            
            const [products, setProducts] = useState([]);
            const [ingredients, setIngredients] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [suppliers, setSuppliers] = useState([]); 
            const [expenses, setExpenses] = useState([]); 
            const [debts, setDebts] = useState([]); 
            const [storeProfile, setStoreProfile] = useState({}); 
            const [tables, setTables] = useState([]); 
            const [shift, setShift] = useState(null); 
            const [transactions, setTransactions] = useState([]);
            const [stockHistory, setStockHistory] = useState([]); 

            const [cart, setCart] = useState([]);
            const [heldCarts, setHeldCarts] = useState([]); 
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null); 
            const [discount, setDiscount] = useState(0); 
            const [paymentMethod, setPaymentMethod] = useState('Tunai');
            const [orderType, setOrderType] = useState('Dine In'); 
            const [lastTrans, setLastTrans] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [cashReceived, setCashReceived] = useState(''); 
            
            const [staff, setStaff] = useState([]); 
            const [activeStaff, setActiveStaff] = useState(null); 
            
            const [editingItem, setEditingItem] = useState(null);
            const [modalConfig, setModalConfig] = useState({ show: false, type: '', data: null });
            const [settingsTab, setSettingsTab] = useState('profile');
            const [scannerContext, setScannerContext] = useState(null); 

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (!user || !storeId) return; 
                
                setLoading(true);
                // [UBAH] Base path sekarang menggunakan storeId, bukan user.uid langsung
                const basePath = ['artifacts', APP_ID, 'users', storeId];
                
                const unsubProd = onSnapshot(collection(db, ...basePath, 'products'), s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubIng = onSnapshot(collection(db, ...basePath, 'ingredients'), s => setIngredients(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubCust = onSnapshot(collection(db, ...basePath, 'customers'), s => setCustomers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubSupp = onSnapshot(collection(db, ...basePath, 'suppliers'), s => setSuppliers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubExp = onSnapshot(collection(db, ...basePath, 'expenses'), s => setExpenses(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubDebts = onSnapshot(collection(db, ...basePath, 'debts'), s => setDebts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubStock = onSnapshot(query(collection(db, ...basePath, 'stock_history'), orderBy('createdAt', 'desc'), limit(50)), s => setStockHistory(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubTrans = onSnapshot(query(collection(db, ...basePath, 'transactions'), orderBy('createdAt', 'desc'), limit(50)), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubTables = onSnapshot(query(collection(db, ...basePath, 'tables'), orderBy('name', 'asc')), s => setTables(s.docs.map(d => ({id:d.id, ...d.data()}))));
                
                const unsubStaff = onSnapshot(collection(db, ...basePath, 'staff'), s => {
                    const staffData = s.docs.map(d => ({id:d.id, ...d.data()}));
                    if(s.empty) {
                        addDoc(collection(db, ...basePath, 'staff'), { name: 'Owner', pin: '1234', role: 'admin' });
                    } else {
                        setStaff(staffData);
                    }
                });
                
                const unsubSettings = onSnapshot(doc(db, ...basePath, 'settings', 'profile'), s => { if (s.exists()) setStoreProfile(s.data()); });
                const qShift = query(collection(db, ...basePath, 'shifts'), where('status', '==', 'open'));
                const unsubShift = onSnapshot(qShift, s => { setShift(s.empty ? null : {id: s.docs[0].id, ...s.docs[0].data()}); });
                
                setTimeout(() => setLoading(false), 1000);
                return () => { unsubProd(); unsubIng(); unsubCust(); unsubSupp(); unsubExp(); unsubDebts(); unsubStock(); unsubSettings(); unsubShift(); unsubTrans(); unsubTables(); unsubStaff(); };
            }, [user]);

            const handleStaffLogin = (s) => {
                // 1. Cek Status Manual (Aktif/Nonaktif)
                if (s.isActive === false) {
                    return alert("Akun Anda sedang dinonaktifkan oleh Admin/Owner.");
                }

                // 2. Cek Jadwal Otomatis (Hanya jika bukan Admin)
                if (s.role !== 'admin') {
                    const now = new Date();
                    const currentTime = now.getHours() * 60 + now.getMinutes(); // Konversi ke menit
                    
                    const [startHour, startMin] = (s.shiftStart || "00:00").split(':').map(Number);
                    const [endHour, endMin] = (s.shiftEnd || "23:59").split(':').map(Number);
                    
                    const startTime = startHour * 60 + startMin;
                    const endTime = endHour * 60 + endMin;

                    if (currentTime < startTime || currentTime > endTime) {
                        return alert(`Akses Ditolak!\nJam Kerja Anda: ${s.shiftStart} - ${s.shiftEnd}\nSekarang: ${now.toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'})}`);
                    }
                }

                // 3. Cek PIN
                const pin = prompt(`Masukkan PIN untuk ${s.name}:`);
                if(pin !== s.pin) return alert("PIN Salah!");

                // 4. Cek Shift Kasir Lain
                if (shift && shift.cashierName !== s.name && s.role !== 'admin') {
                    alert(`Toko sedang dibuka oleh ${shift.cashierName}. \nSilahkan minta ${shift.cashierName} untuk Tutup Toko terlebih dahulu.`);
                    return;
                }
                setActiveStaff(s);
                if(s.role === 'admin') setView('dashboard'); else setView('pos');
            };

            const getPrice = (prod, qty) => {
                if (prod.wholesaleQty && prod.wholesalePrice && qty >= prod.wholesaleQty) {
                    return Number(prod.wholesalePrice);
                }
                return Number(prod.price);
            };

            const addToCart = (p) => {
                const hasRecipe = p.recipe && p.recipe.length > 0;
                if (!hasRecipe && p.stock <= 0) return alert("Stok Produk Habis!");

                setCart(prev => { 
                    const ex = prev.find(i=>i.id===p.id); 
                    if (ex) {
                        const newQty = ex.qty + 1;
                        if (!hasRecipe && newQty > p.stock) {
                            alert(`Stok tidak cukup! (Sisa: ${p.stock})`);
                            return prev;
                        }
                        return prev.map(i=>i.id===p.id ? {...i, qty: newQty, price: getPrice(p, newQty)} : i);
                    } else {
                        return [...prev,{...p, qty:1, price: getPrice(p, 1), itemDiscount:0}];
                    }
                });
            };

            const handleScanResult = (code) => {
                if (scannerContext === 'pos') {
                    const prod = products.find(p => p.barcode === code);
                    if (prod) {
                        addToCart(prod);
                        return;
                    }
                    const cust = customers.find(c => c.memberCode === code);
                    if (cust) {
                        setSelectedCustomer(cust);
                        alert(`Pelanggan terdeteksi: ${cust.name} (Poin: ${cust.points||0})`);
                        return;
                    }
                    alert("Barcode tidak ditemukan (Produk/Member): " + code);
                } else if (scannerContext === 'form') {
                    setModalConfig(prev => ({ ...prev, data: { ...prev.data, barcode: code } }));
                    setScannerContext(null); 
                }
            };

            // [FIXED] HANDLE ORDER UNTUK WAITER & KASIR
            const handleOrderToKitchen = () => {
                if(cart.length === 0) return alert("Keranjang kosong!");
                if(!selectedTable && orderType === 'Dine In') return alert("Pilih Meja untuk Dine In!");

                const newHold = { 
                    id: Date.now(), 
                    cust: selectedCustomer, 
                    cart: cart, 
                    table: selectedTable, 
                    orderType: orderType,
                    time: new Date(),
                    waiter: activeStaff.name 
                };
                setHeldCarts(prev => [...prev, newHold]);
                setCart([]); setSelectedCustomer(null); setSelectedTable(null); setCashReceived('');
                alert("Pesanan berhasil disimpan & dikirim ke dapur!");
            };

            const restoreTransaction = (h) => {
                if(cart.length > 0) { if(!confirm("Ada transaksi aktif. Timpa?")) return; }
                setCart(h.cart); setSelectedCustomer(h.cust); setSelectedTable(h.table); setCashReceived('');
                setHeldCarts(prev => prev.filter(x => x.id !== h.id));
                setModalConfig({show: false});
            };

            const updateCartQty = (item, change) => {
                setCart(prev => {
                    return prev.map(i => {
                        if (i.id !== item.id) return i;
                        const newQty = i.qty + change;
                        if (newQty <= 0) return null;
                        const prod = products.find(p => p.id === i.id);
                        if (!prod) return i;
                        const hasRecipe = prod.recipe && prod.recipe.length > 0;
                        if (!hasRecipe && change > 0 && newQty > prod.stock) {
                            alert(`Maksimal stok tersedia: ${prod.stock}`);
                            return i; 
                        }
                        return { ...i, qty: newQty, price: getPrice(prod, newQty) }; 
                    }).filter(Boolean);
                });
            };

            const removeFromCart = (itemId) => {
                setCart(prev => prev.filter(item => item.id !== itemId));
            };

            const calculateTotals = () => {
                const subtotalRaw = cart.reduce((a,b) => a + (b.price * b.qty), 0);
                const itemDiscounts = cart.reduce((a,b) => a + (b.itemDiscount || 0), 0);
                const subtotal = subtotalRaw - itemDiscounts;
                const hppTotal = cart.reduce((a,b) => {
                     let itemHPP = b.hpp || 0;
                     if (b.recipe && b.recipe.length > 0) {
                        itemHPP = 0;
                        b.recipe.forEach(r => {
                            const ing = ingredients.find(i => i.id === r.ingId);
                            if(ing) itemHPP += (ing.costPerUnit || 0) * r.qty;
                        });
                     }
                     return a + (itemHPP * b.qty);
                }, 0);
                const serviceRate = storeProfile?.serviceRate || 0;
                const taxRate = storeProfile?.taxRate || 0;
                const taxableAmount = Math.max(0, subtotal - discount);
                const serviceCharge = (taxableAmount * serviceRate) / 100;
                const tax = ((taxableAmount + serviceCharge) * taxRate) / 100;
                const total = taxableAmount + serviceCharge + tax;
                return { subtotal, hppTotal, tax, serviceCharge, total, serviceRate, taxRate };
            };

            const checkIngredientsAvailability = () => {
                const requiredIngs = {};
                cart.forEach(item => {
                    if (item.recipe && item.recipe.length > 0) {
                        item.recipe.forEach(r => {
                            if (!requiredIngs[r.ingId]) requiredIngs[r.ingId] = 0;
                            requiredIngs[r.ingId] += (r.qty * item.qty);
                        });
                    }
                });
                for (const [id, needed] of Object.entries(requiredIngs)) {
                    const ing = ingredients.find(i => i.id === id);
                    if (!ing || ing.stock < needed) return `Stok Bahan Baku Kurang!`;
                }
                return null;
            };

            const handleCheckout = async () => {
                try {
                    if(!shift) { alert("Buka Shift dulu!"); return; }
                    if(cart.length === 0) return;
                    
                    const stockError = checkIngredientsAvailability();
                    if (stockError) { alert(stockError); return; }

                    if(paymentMethod === 'Hutang' && !selectedCustomer) { alert("Pilih Pelanggan!"); return; }
                    
                    const totals = calculateTotals();
                    const received = parseNumberInput(cashReceived);
                    
                    if (paymentMethod === 'Tunai' && received < totals.total) {
                        alert(`Uang kurang! Total: ${formatCurrency(totals.total)}`);
                        return;
                    }

                    setIsProcessing(true);
                    const profit = totals.total - totals.tax - totals.serviceCharge - totals.hppTotal;

                    const pointRate = storeProfile?.pointConversion || 10000;
                    const pointsEarned = selectedCustomer ? Math.floor(totals.total / pointRate) : 0;

                    const transData = {
                        items: cart, ...totals, profit, paymentMethod, orderType,
                        table: selectedTable ? selectedTable.name : null,
                        customerId: selectedCustomer ? selectedCustomer.id : null,
                        customerName: selectedCustomer ? selectedCustomer.name : 'Umum',
                        pointsEarned, 
                        customerPointsTotal: selectedCustomer ? (selectedCustomer.points || 0) + pointsEarned : 0,
                        cashReceived: paymentMethod === 'Tunai' ? received : totals.total,
                        shiftId: shift.id, createdAt: serverTimestamp(), status: 'success'
                    };

                    const ref = await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions'), transData);
                    
                    if (paymentMethod === 'Hutang') {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'debts'), {
                            transactionId: ref.id, customerId: selectedCustomer.id, customerName: selectedCustomer.name,
                            amount: totals.total, paid: 0, status: 'unpaid', createdAt: serverTimestamp()
                        });
                    }

                    if(selectedCustomer) {
                        const custRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'customers', selectedCustomer.id);
                        await updateDoc(custRef, { points: increment(pointsEarned) });
                    }

                    const batchPromises = [];
                    const ingUpdates = {};
                    const prodUpdates = {};

                    cart.forEach(item => {
                        if (item.recipe && item.recipe.length > 0) {
                            item.recipe.forEach(r => {
                                if (!ingUpdates[r.ingId]) ingUpdates[r.ingId] = 0;
                                ingUpdates[r.ingId] += (r.qty * item.qty);
                            });
                        } else {
                            if (!prodUpdates[item.id]) prodUpdates[item.id] = 0;
                            prodUpdates[item.id] += item.qty;
                        }
                    });

                    for (const [id, qty] of Object.entries(ingUpdates)) {
                        const ing = ingredients.find(i => i.id === id);
                        if (ing) batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'ingredients', id), { stock: ing.stock - qty }));
                    }
                    for (const [id, qty] of Object.entries(prodUpdates)) {
                        const prod = products.find(p => p.id === id);
                        if (prod) {
                            batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'products', id), { stock: prod.stock - qty }));
                            batchPromises.push(addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'stock_history'), {
                                productId: id, productName: prod.name, change: -qty, type: 'sale', refId: ref.id, reason: 'Penjualan POS', createdAt: serverTimestamp()
                            }));
                        }
                    }

                    await Promise.all(batchPromises);

                    await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'shifts', shift.id), {
                        transactionsCount: (shift.transactionsCount || 0) + 1,
                        totalSales: (shift.totalSales || 0) + transData.total
                    });

                    setLastTrans({id: ref.id, ...transData, createdAt: new Date()});
                    setCart([]); setDiscount(0); setSelectedCustomer(null); setSelectedTable(null); setCashReceived('');

                    if(paymentMethod === 'QRIS') window.open("https://qris.id", "_blank");

                } catch (e) { 
                    console.error(e);
                    alert("Error: " + e.message); 
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleOpenShift = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'shifts'), {
                    startCash: Number(e.target.startCash.value),
                    startTime: serverTimestamp(),
                    status: 'open',
                    transactionsCount: 0,
                    totalSales: 0,
                    cashierName: activeStaff?.name || 'Unknown'
                });
            };

            const handleCloseShift = async (e) => {
                e.preventDefault();
                const endCash = Number(e.target.endCash.value);
                const cashSales = transactions.filter(t => t.paymentMethod === 'Tunai' && t.shiftId === shift.id).reduce((a,b) => a + (b.total || 0), 0);
                const totalExpenses = expenses.filter(ex => ex.date?.seconds >= shift.startTime?.seconds).reduce((a,b) => a + (b.amount || 0), 0);
                const expectedCash = (shift.startCash || 0) + cashSales - totalExpenses;
                const difference = endCash - expectedCash;

                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'shifts', shift.id), {
                    endCash, expectedCash, difference, cashSales, totalExpenses, status: 'closed', endTime: serverTimestamp()
                });
                setModalConfig({show: false});
                alert(`Shift Ditutup.`);
                setActiveStaff(null);
            };

            const handleDeleteTransaction = async (t) => {
                if(!confirm(`Hapus transaksi? Stok akan KEMBALI.`)) return;
                try {
                    const batchPromises = [];
                    t.items.forEach(item => {
                        if(item.recipe && item.recipe.length > 0) {
                            item.recipe.forEach(r => {
                                const ingRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'ingredients', r.ingId);
                                batchPromises.push(updateDoc(ingRef, { stock: increment(r.qty * item.qty) }));
                            });
                        } else {
                            const prodRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'products', item.id);
                            batchPromises.push(updateDoc(prodRef, { stock: increment(item.qty) }));
                        }
                    });
                    batchPromises.push(deleteDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'transactions', t.id)));
                    const qDebt = query(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'debts'), where('transactionId', '==', t.id));
                    const debtSnap = await getDocs(qDebt);
                    debtSnap.forEach(d => batchPromises.push(deleteDoc(d.ref)));
                    
                    if(t.customerId && t.pointsEarned > 0) {
                        const custRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'customers', t.customerId);
                        batchPromises.push(updateDoc(custRef, { points: increment(-t.pointsEarned) }));
                    }

                    await Promise.all(batchPromises);
                    alert("Transaksi dihapus.");
                } catch(e) { alert("Gagal: " + e.message); }
            };

            const handlePaymentSubmit = async (e) => {
                e.preventDefault();
                const amount = Number(e.target.amount.value);
                const debt = modalConfig.data;
                const newPaid = (debt.paid || 0) + amount;
                const status = newPaid >= debt.amount ? 'paid' : 'partial';
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'debts', debt.id), {
                    paid: newPaid, status: status, lastPayment: serverTimestamp()
                });
                setModalConfig({show:false});
            };

            const handleAdjustStock = async (e) => { 
                e.preventDefault();
                const f = e.target;
                const qty = Number(f.qty.value);
                const type = f.type.value;
                const change = type === 'in' ? qty : -qty;
                const prod = modalConfig.data;
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'products', prod.id), { stock: prod.stock + change });
                await addDoc(collection(db, 'artifacts', APP_ID, 'users', user.uid, 'stock_history'), {
                    productId: prod.id, productName: prod.name, change: change, type: 'adjustment', reason: f.reason.value, createdAt: serverTimestamp()
                });
                setModalConfig({show: false});
            };

            const saveSettings = async (e) => {
                e.preventDefault();
                const f = e.target;
                await setDoc(doc(db, 'artifacts', APP_ID, 'users', user.uid, 'settings', 'profile'), {
                    name: f.name.value, address: f.address.value, phone: f.phone.value, logo: f.logo.value,
                    footerMessage: f.footerMessage.value, 
                    taxRate: Number(f.taxRate.value), serviceRate: Number(f.serviceRate.value),
                    paperSize: f.paperSize.value,
                    pointConversion: Number(f.pointConversion.value)
                });
                setModalConfig({ show: false });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const f = e.target;
                const type = modalConfig.type;
                const collPath = ['artifacts', APP_ID, 'users', user.uid];
                let collectionName = type + 's';
                if (type === 'staff') collectionName = 'staff';
                if (type === 'ingredient') collectionName = 'ingredients';
                let payload = {};

                try {
                    if (type === 'product') {
                        payload = { 
                            name: f.name.value, barcode: f.barcode.value, category: f.category.value, 
                            price: Number(f.price.value), hpp: Number(f.hpp.value), stock: Number(f.stock.value), image: f.image.value,
                            wholesaleQty: Number(f.wholesaleQty.value), wholesalePrice: Number(f.wholesalePrice.value)
                        };
                    } else if (type === 'ingredient') {
                         payload = { name: f.name.value, unit: f.unit.value, stock: Number(f.stock.value), costPerUnit: Number(f.costPerUnit.value) };
                    } else if (type === 'recipe_setup') {
                         const currentRecipe = modalConfig.data.recipe || [];
                         const newRecipe = [...currentRecipe, {ingId: f.ingId.value, qty: Number(f.qty.value)}];
                         await updateDoc(doc(db, ...collPath, 'products', modalConfig.data.id), { recipe: newRecipe });
                         setModalConfig({ show: false }); return;
                    } else if (type === 'customer') {
                        const timestamp = Date.now().toString().slice(-6);
                        payload = { 
                            name: f.name.value, phone: f.phone.value, email: f.email.value, 
                            nik: f.nik.value, memberCode: `MBR-${timestamp}` 
                        };
                    } else if (type === 'supplier') {
                        payload = { name: f.name.value, phone: f.phone.value, address: f.address.value };
                    } else if (type === 'table') {
                        payload = { name: f.name.value, capacity: f.capacity.value };
                    } else if (type === 'staff') {
                        if(!f.pin.value) throw new Error("PIN Wajib diisi!");
                        
                        // [UPDATE] Simpan Jadwal & Status
                        payload = { 
                            name: f.name.value, 
                            email: f.email.value.trim().toLowerCase(),
                            pin: f.pin.value, 
                            role: f.role.value,
                            shiftStart: f.shiftStart.value, // Simpan jam masuk
                            shiftEnd: f.shiftEnd.value,     // Simpan jam pulang
                            isActive: f.isActive.value === "true" // Simpan status (true/false)
                        };
                    } else if (type === 'expense') {
                        payload = { name: f.name.value, amount: Number(f.amount.value), category: f.category.value, date: serverTimestamp() };
                    }

                    if (modalConfig.data?.id) await updateDoc(doc(db, ...collPath, collectionName, modalConfig.data.id), { ...payload, updatedAt: serverTimestamp() });
                    else {
                        const ref = await addDoc(collection(db, ...collPath, collectionName), { ...payload, createdAt: serverTimestamp() });
                        if(type === 'customer') {
                            setModalConfig({show: false});
                            setTimeout(() => setModalConfig({show: true, type: 'show_member_card', data: {...payload, id: ref.id}}), 500);
                            return;
                        }
                    }
                    
                    setModalConfig({ show: false });
                } catch (err) { alert("GAGAL SIMPAN: " + err.message); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">Loading Kasir Pro...</div>;
            if (!user) return <LoginScreen />;
            
			if (user && !storeId) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white w-full max-w-md rounded-2xl p-8 shadow-2xl text-center">
                            <h2 className="text-2xl font-bold mb-2">Halo, {user.displayName}!</h2>
                            <p className="text-gray-500 mb-6 text-sm">Mau masuk sebagai apa?</p>
                            
                            <div className="space-y-3">
                                <button onClick={() => {
                                    localStorage.setItem('kp_store_id', user.uid);
                                    setStoreId(user.uid);
                                    window.location.reload();
                                }} className="w-full p-4 border-2 border-blue-100 rounded-xl hover:bg-blue-50 transition flex items-center gap-4 text-left">
                                    <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Icon name="store" size={24}/></div>
                                    <div>
                                        <div className="font-bold text-blue-900">Saya Owner (Pemilik)</div>
                                        <div className="text-xs text-gray-500">Kelola toko saya sendiri</div>
                                    </div>
                                </button>

                                <div className="relative flex py-2 items-center">
                                    <div className="flex-grow border-t border-gray-200"></div>
                                    <span className="flex-shrink-0 mx-4 text-gray-400 text-xs">ATAU</span>
                                    <div className="flex-grow border-t border-gray-200"></div>
                                </div>

                                <button onClick={() => {
                                    const id = prompt("Masukkan ID Toko Owner (Minta ke Boss Anda):");
                                    if(id) {
                                        localStorage.setItem('kp_store_id', id);
                                        setStoreId(id);
                                        window.location.reload();
                                    }
                                }} className="w-full p-4 border-2 border-orange-100 rounded-xl hover:bg-orange-50 transition flex items-center gap-4 text-left">
                                    <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Icon name="users" size={24}/></div>
                                    <div>
                                        <div className="font-bold text-orange-900">Saya Staff / Waiter</div>
                                        <div className="text-xs text-gray-500">Masuk ke toko orang lain</div>
                                    </div>
                                </button>
                            </div>
                            <div className="mt-6">
                                <button onClick={()=>signOut(auth)} className="text-xs text-red-500 hover:underline">Ganti Akun Google</button>
                            </div>
                        </div>
                    </div>
                );
            }
			
            if (user && !activeStaff) {
                return (
                    <div className="h-screen bg-slate-900 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl text-center">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="lock" size={32}/></div>
                            <h2 className="text-2xl font-bold mb-2">Siapa yang bertugas?</h2>
                            <p className="text-gray-500 mb-6 text-sm">Masuk sebagai: <span className="font-bold text-blue-600">{user.phoneNumber || user.email || 'Anonim'}</span></p>
                            
                            {staff.length === 0 ? (
                                <div className="p-4 text-gray-400 animate-pulse">Menyiapkan Data Staff...</div>
                            ) : (
                                <div className="grid grid-cols-2 gap-3 mb-6">
                                    {staff.map(s => (
                                        <button key={s.id} onClick={() => handleStaffLogin(s)} className="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition group">
                                            <div className="font-bold text-lg group-hover:text-blue-600">{s.name}</div>
                                            <div className="text-xs text-gray-400 uppercase">{s.role}</div>
                                        </button>
                                    ))}
                                </div>
                            )}
                            
                            <div className="border-t pt-4 mt-4">
                                <button onClick={() => signOut(auth)} className="text-red-500 text-sm font-bold flex items-center justify-center gap-2 w-full hover:bg-red-50 p-2 rounded transition"><Icon name="log-out" size={16}/> Ganti Akun Pemilik</button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (user && !shift && (activeStaff?.role === 'kasir' || activeStaff?.role === 'admin' || activeStaff?.role === 'waiter') && view === 'pos') {
                return (
                    <Modal title="Buka Toko / Shift Baru" onClose={()=>{}}>
                        <form onSubmit={handleOpenShift}>
                            <div className="bg-blue-50 p-4 rounded-lg mb-4 text-sm text-blue-800">
                                Selamat Datang, <b>{activeStaff.name}</b>!<br/>Silakan masukkan uang modal di laci kasir sebelum mulai berjualan.
                            </div>
                            <input name="startCash" type="number" placeholder="Nominal Modal Awal (Rp)" required className="w-full p-3 border rounded-lg mb-4 text-lg font-bold"/>
                            <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Buka Toko</button>
                        </form>
                    </Modal>
                );
            }

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden text-slate-800">
                    <aside className="w-20 md:w-64 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 z-20 overflow-y-auto">
                        <div className="h-16 flex items-center justify-center md:justify-start md:px-6 bg-slate-950 text-white font-bold gap-3 flex-shrink-0 sticky top-0 z-10">
                            <div className="bg-blue-600 p-2 rounded-lg"><Icon name="zap" size={20}/></div>
                            <span className="hidden md:block">Kasir Pro v9</span>
                        </div>
                        <nav className="flex-1 py-4 space-y-1 px-2">
                            <div className="px-3 mb-6 flex items-center gap-3 pb-4 border-b border-slate-800">
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white">{activeStaff?.name[0]}</div>
                                <div className="hidden md:block">
                                    <div className="text-sm font-bold text-white">{activeStaff?.name}</div>
                                    <div className="text-xs text-slate-500 uppercase">{activeStaff?.role}</div>
                                </div>
                                <button onClick={()=>setActiveStaff(null)} className="ml-auto text-slate-500 hover:text-white" title="Keluar / Ganti Akun"><Icon name="log-out" size={16}/></button>
                            </div>

                            <div className="text-xs font-bold text-slate-500 px-3 mb-2 uppercase hidden md:block">Utama</div>
                            
                            {[
                                {id: 'pos', icon: 'monitor', label: 'Kasir / POS', roles: ['admin', 'kasir', 'waiter']},
                                {id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard', roles: ['admin']},
                                {id: 'history', icon: 'history', label: 'Riwayat Transaksi', roles: ['admin', 'kasir']},
                                {id: 'expenses', icon: 'wallet', label: 'Pengeluaran', roles: ['admin', 'kasir']},
                                {id: 'debts', icon: 'book', label: 'Hutang / Kasbon', roles: ['admin', 'kasir']},
                                {id: 'customers', icon: 'users', label: 'Pelanggan', roles: ['admin', 'kasir']},
                            ].filter(m => m.roles.includes(activeStaff?.role)).map(m => (
                                <button key={m.id} onClick={() => setView(m.id)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m.id ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <Icon name={m.icon} /> <span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                            
                            {(activeStaff?.role === 'admin' || activeStaff?.role === 'gudang') && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Gudang & Data</div>
                                {['inventory', 'ingredients'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name={m==='inventory'?'clipboard-list':'flask-conical'} size={18} /> <span className="hidden md:block font-medium">{m==='inventory'?'Stok Opname':'Bahan Baku'}</span>
                                    </button>
                                ))}
                                {['products', 'staff', 'tables', 'suppliers'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name="database" size={18} /> <span className="hidden md:block font-medium">{m}</span>
                                    </button>
                                ))}
                            </>}
                            
                            {activeStaff?.role === 'admin' && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Sistem</div>
                                <button onClick={() => {setSettingsTab('profile'); setModalConfig({show:true, type:'settings'})}} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl hover:bg-slate-800">
                                    <Icon name="settings" /> <span className="hidden md:block font-medium">Pengaturan</span>
                                </button>
                            </>}
                        </nav>
                        
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={()=>setModalConfig({show:true, type:'close_shift'})} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl bg-red-900/30 text-red-400 hover:bg-red-900/50 transition">
                                <Icon name="power" /> <span className="hidden md:block">Tutup Toko</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        {view === 'pos' && (
                            <div className="flex h-full flex-col md:flex-row">
                                <div className="flex-1 bg-gray-50 flex flex-col min-w-0 h-full overflow-hidden">
                                    <div className="p-4 bg-white border-b flex flex-col gap-3">
                                        {scannerContext === 'pos' ? (
                                            <BarcodeScanner onScan={handleScanResult} onClose={()=>setScannerContext(null)} isInline={true} />
                                        ) : (
                                            <div className="flex gap-3 items-center">
                                                <div className="relative flex-1">
                                                    <Icon name="search" className="absolute left-3 top-3 text-gray-400"/>
                                                    <input className="w-full pl-10 p-2.5 rounded-lg border bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cari nama, barcode, atau member..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} autoFocus/>
                                                </div>
                                                <button onClick={()=>setScannerContext('pos')} className="p-2.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 flex items-center gap-2 font-bold" title="Scan Kamera">
                                                    <Icon name="camera" size={20}/> <span className="hidden md:inline">Scan</span>
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start">
                                        {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || (p.barcode && p.barcode.includes(searchQuery))).sort((a,b) => {
                                            const stockA = (a.recipe && a.recipe.length > 0) ? 999 : a.stock;
                                            const stockB = (b.recipe && b.recipe.length > 0) ? 999 : b.stock;
                                            if (stockA > 0 && stockB <= 0) return -1;
                                            if (stockA <= 0 && stockB > 0) return 1;
                                            return 0;
                                        }).map(p => {
                                            const hasRecipe = p.recipe && p.recipe.length > 0;
                                            return (
                                                <div key={p.id} onClick={() => addToCart(p)} className={`relative bg-white rounded-xl shadow-sm border p-3 cursor-pointer hover:shadow-md transition ${!hasRecipe && p.stock<=0 && 'opacity-50'} ${!hasRecipe && p.stock<=5 && p.stock > 0 ? 'border-red-300 bg-red-50' : ''}`}>
                                                    {!hasRecipe && p.stock <= 5 && p.stock > 0 && <div className="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full z-10 animate-pulse">Menipis</div>}
                                                    <div className="h-24 bg-gray-100 rounded-lg mb-2 overflow-hidden">
                                                        {p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icon name="image" size={32}/></div>}
                                                    </div>
                                                    <h4 className="font-bold truncate">{p.name}</h4>
                                                    <div className="flex justify-between mt-1 items-center">
                                                        <span className="text-blue-600 font-bold">{formatCurrency(p.price)}</span>
                                                        <span className={`text-xs px-1.5 py-0.5 rounded font-bold ${hasRecipe ? 'bg-purple-100 text-purple-700' : (p.stock<=5 ? 'bg-red-200 text-red-800' : 'bg-gray-100')}`}>
                                                            {hasRecipe ? 'F&B' : p.stock}
                                                        </span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                                <div className="w-full md:w-96 bg-white shadow-2xl z-20 flex flex-col border-l flex-shrink-0 h-auto md:h-full">
                                    
                                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center">
                                        <div className="flex gap-2">
                                            {heldCarts.length > 0 && (
                                                <button onClick={()=>setModalConfig({show: true, type: 'hold_list'})} className="bg-orange-100 text-orange-600 px-3 py-1.5 rounded-lg text-sm font-bold flex items-center gap-1 animate-pulse">
                                                    <Icon name="list" size={16}/> Antrean ({heldCarts.length})
                                                </button>
                                            )}
                                        </div>
                                        <button onClick={holdTransaction} className="text-gray-500 hover:text-blue-600 p-2 rounded-lg" title="Tunda Transaksi (Ganti Orang)">
                                            <Icon name="clock" size={20}/>
                                        </button>
                                    </div>

                                    <div className="p-4 border-b bg-white space-y-2">
                                        <div className="flex gap-2">
                                            <select className="flex-1 p-2 border rounded bg-white text-sm" value={orderType} onChange={e=>setOrderType(e.target.value)}><option>Dine In</option><option>Take Away</option></select>
                                            {orderType === 'Dine In' && <select className="flex-1 p-2 border rounded bg-white text-sm" value={selectedTable?.name||''} onChange={e=>setSelectedTable(tables.find(t=>t.name===e.target.value)||null)}><option value="">Pilih Meja</option>{tables.map(t=><option key={t.id} value={t.name}>{t.name}</option>)}</select>}
                                        </div>
                                        <select className="w-full p-2 border rounded bg-white text-sm" value={selectedCustomer?.id||''} onChange={e=>setSelectedCustomer(customers.find(c=>c.id===e.target.value)||null)}><option value="">Pelanggan Umum</option>{customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}</select>
                                        
                                        {selectedCustomer && (
                                            <div className="text-xs bg-green-50 text-green-700 p-2 rounded flex justify-between">
                                                <span>Poin Member: <b>{selectedCustomer.points || 0}</b></span>
                                                <span>Dapat +{Math.floor(calculateTotals().total / (storeProfile?.pointConversion || 10000))} Poin</span>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-4 space-y-2 max-h-[300px] md:max-h-full">
                                        {cart.map(i => (
                                            <div key={i.id} onClick={()=>{setEditingItem({...i}); setModalConfig({show:true, type:'edit_cart_item'})}} className="flex justify-between items-center bg-gray-50 p-2 rounded cursor-pointer hover:bg-gray-100">
                                                <div className="flex-1">
                                                    <div className="font-bold text-sm">{i.name}</div>
                                                    <div className="text-xs text-blue-600">
                                                        {formatCurrency(i.price)} x {i.qty} 
                                                        {i.wholesaleQty && i.qty >= i.wholesaleQty && <span className="text-green-600 font-bold ml-1 text-[10px]">(Grosir)</span>}
                                                    </div>
                                                    {i.note && <div className="text-[10px] text-gray-500 italic">"{i.note}"</div>}
                                                </div>
                                                <div className="flex items-center gap-2 mr-2" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={()=>updateCartQty(i, -1)} className="w-6 h-6 bg-gray-200 rounded text-sm hover:bg-gray-300">-</button>
                                                    <span className="font-bold text-sm w-4 text-center">{i.qty}</span>
                                                    <button onClick={()=>updateCartQty(i, 1)} className="w-6 h-6 bg-gray-200 rounded text-sm hover:bg-gray-300">+</button>
                                                    <button onClick={()=>removeFromCart(i.id)} className="ml-2 p-1.5 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition">
                                                        <Icon name="trash-2" size={14}/>
                                                    </button>
                                                </div>
                                                <div className="font-bold text-sm">{formatCurrency((i.price*i.qty)- (i.itemDiscount||0))}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="p-4 bg-slate-50 border-t space-y-2">
                                        <div className="flex gap-2"><input type="number" placeholder="Diskon" className="w-full p-2 border rounded text-sm" value={discount > 0 ? discount : ''} onChange={e=>setDiscount(Number(e.target.value))} /></div>
                                        <div className="space-y-1 text-sm pt-2 border-t border-dashed">
                                            <div className="flex justify-between text-gray-500"><span>Subtotal</span><span>{formatCurrency(calculateTotals().subtotal)}</span></div>
                                            {calculateTotals().tax > 0 && <div className="flex justify-between text-gray-500"><span>Pajak ({calculateTotals().taxRate}%)</span><span>{formatCurrency(calculateTotals().tax)}</span></div>}
                                            {calculateTotals().serviceCharge > 0 && <div className="flex justify-between text-gray-500"><span>Service ({calculateTotals().serviceRate}%)</span><span>{formatCurrency(calculateTotals().serviceCharge)}</span></div>}
                                            <div className="flex justify-between font-bold text-lg pt-2"><span>Total</span><span>{formatCurrency(calculateTotals().total)}</span></div>
                                        </div>
                                        
                                        {/* [FIXED] INPUT UANG DITERIMA DENGAN FORMAT */}
                                        {paymentMethod === 'Tunai' && (
                                            <div className="bg-gray-100 p-2 rounded-lg border flex flex-col gap-1">
                                                <div className="flex items-center">
                                                    <span className="text-xs font-bold w-20">Diterima:</span>
                                                    <input 
                                                        type="tel" 
                                                        inputMode="numeric" 
                                                        value={formatNumberInput(cashReceived)} 
                                                        onChange={e => setCashReceived(e.target.value.replace(/\./g, ''))} // Simpan raw tanpa titik
                                                        className="flex-1 p-1 text-right text-sm border rounded font-bold text-blue-600" 
                                                        placeholder="0"
                                                    />
                                                </div>
                                                <div className="flex justify-between items-center text-sm font-bold">
                                                    <span>Kembalian:</span>
                                                    <span className={parseNumberInput(cashReceived) < calculateTotals().total ? "text-red-500" : "text-green-600"}>
                                                        {formatCurrency(Math.max(0, parseNumberInput(cashReceived) - calculateTotals().total))}
                                                    </span>
                                                </div>
                                            </div>
                                        )}

                                        <div className="grid grid-cols-2 gap-2 text-xs">
                                            {['Tunai', 'Hutang', 'QRIS'].map(m => (
                                                <button key={m} onClick={()=>{setPaymentMethod(m); setCashReceived('');}} className={`py-2 rounded border font-medium ${paymentMethod===m ? 'bg-slate-800 text-white' : 'bg-white'}`}>{m}</button>
                                            ))}
                                        </div>
                                        
                                        {/* [FIXED] TOMBOL BAYAR VS SIMPAN (WAITER) */}
                                        <button 
                                            onClick={activeStaff?.role === 'waiter' ? handleOrderToKitchen : handleCheckout} 
                                            disabled={!cart.length || isProcessing} 
                                            className={`w-full text-white py-3 rounded-xl font-bold transition disabled:bg-gray-300 ${activeStaff?.role === 'waiter' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                                        >
                                            {isProcessing ? 'Memproses...' : (activeStaff?.role === 'waiter' ? 'Simpan Pesanan (Dapur)' : 'Bayar')}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {view === 'dashboard' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Executive Dashboard</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Omzet Kotor</p><h3 className="text-2xl font-bold text-blue-600">{formatCurrency(transactions.reduce((a,b)=>a+(b.total||0),0))}</h3></div>
                                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white p-5 rounded-xl shadow-lg"><p className="text-green-100 text-sm">Net Profit (Bersih)</p><h3 className="text-2xl font-bold">{formatCurrency(transactions.reduce((a,b)=>a+(b.profit||0),0) - expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Pengeluaran</p><h3 className="text-2xl font-bold text-red-600">{formatCurrency(expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Piutang Belum Bayar</p><h3 className="text-2xl font-bold text-orange-600">{formatCurrency(debts.reduce((a,b)=>a + (b.status!=='paid' ? (b.amount - b.paid) : 0),0))}</h3></div>
                                </div>
                            </div>
                        )}

                        {view === 'history' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Riwayat Transaksi</h2>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-gray-50 border-b">
                                            <tr>
                                                <th className="p-4">ID / Waktu</th>
                                                <th className="p-4">Pelanggan</th>
                                                <th className="p-4">Total</th>
                                                <th className="p-4">Metode</th>
                                                <th className="p-4 text-center">Aksi</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {transactions.map(t => (
                                                <tr key={t.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-4">
                                                        <div className="font-bold text-xs text-gray-500">#{t.id.slice(0,6)}</div>
                                                        <div>{formatDate(t.createdAt)}</div>
                                                    </td>
                                                    <td className="p-4">
                                                        <div className="font-bold">{t.customerName}</div>
                                                        <div className="text-xs text-gray-500">{t.orderType} {t.table ? `(${t.table})` : ''}</div>
                                                    </td>
                                                    <td className="p-4 font-bold">{formatCurrency(t.total)}</td>
                                                    <td className="p-4"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs">{t.paymentMethod}</span></td>
                                                    <td className="p-4 flex justify-center gap-2">
                                                        <button onClick={()=>setLastTrans(t)} className="p-2 bg-gray-100 rounded hover:bg-blue-50 text-blue-600" title="Lihat/Print"><Icon name="printer" size={16}/></button>
                                                        {activeStaff?.role === 'admin' && (
                                                            <button onClick={()=>handleDeleteTransaction(t)} className="p-2 bg-gray-100 rounded hover:bg-red-50 text-red-600" title="Hapus & Kembalikan Stok"><Icon name="trash-2" size={16}/></button>
                                                        )}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    {transactions.length === 0 && <div className="p-8 text-center text-gray-400">Belum ada transaksi</div>}
                                </div>
                            </div>
                        )}

                        {view === 'debts' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Buku Hutang (Piutang)</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {debts.sort((a,b)=>b.createdAt-a.createdAt).map(d => (
                                        <div key={d.id} className={`bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition ${d.status==='paid' ? 'opacity-60 grayscale' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 className="font-bold text-lg">{d.customerName}</h4>
                                                    <div className="text-xs text-gray-500">{formatDate(d.createdAt)}</div>
                                                </div>
                                                <span className={`text-xs px-2 py-1 rounded font-bold uppercase ${d.status==='paid'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>{d.status}</span>
                                            </div>
                                            <div className="space-y-1 my-3 text-sm">
                                                <div className="flex justify-between"><span>Total Hutang:</span> <span className="font-bold">{formatCurrency(d.amount)}</span></div>
                                                <div className="flex justify-between text-green-600"><span>Sudah Bayar:</span> <span>{formatCurrency(d.paid || 0)}</span></div>
                                                <div className="flex justify-between text-red-600 border-t pt-1 font-bold"><span>Sisa:</span> <span>{formatCurrency(d.amount - (d.paid||0))}</span></div>
                                            </div>
                                            {d.status !== 'paid' && (
                                                <button onClick={()=>setModalConfig({show:true, type:'pay_debt', data:d})} className="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold mt-2 hover:bg-blue-700">Bayar / Cicil</button>
                                            )}
                                        </div>
                                    ))}
                                    {debts.length === 0 && <div className="col-span-full text-center text-gray-400 py-10">Tidak ada data hutang</div>}
                                </div>
                            </div>
                        )}

                        {view === 'expenses' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Pengeluaran Operasional</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'expense'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b"><tr><th className="p-4">Nama</th><th className="p-4">Kategori</th><th className="p-4">Tanggal</th><th className="p-4 text-right">Jumlah</th><th className="p-4 text-center">Aksi</th></tr></thead>
                                        <tbody>
                                            {expenses.map(e => (
                                                <tr key={e.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-4 font-bold">{e.name}</td>
                                                    <td className="p-4"><span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">{e.category}</span></td>
                                                    <td className="p-4 text-sm text-gray-500">{formatDate(e.date)}</td>
                                                    <td className="p-4 text-right font-mono font-bold text-red-600">{formatCurrency(e.amount)}</td>
                                                    <td className="p-4 text-center">
                                                        <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'expenses',e.id))}} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash" size={16}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'ingredients' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Stok Bahan Baku (Gudang)</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'ingredient'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {ingredients.map(i => (
                                        <div key={i.id} onClick={()=>setModalConfig({show:true, type:'ingredient', data:i})} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><Icon name="flask-conical" size={20}/></div>
                                                <div>
                                                    <h4 className="font-bold">{i.name}</h4>
                                                    <div className="text-xs text-gray-500">Stok: <b className="text-blue-600">{i.stock} {i.unit}</b></div>
                                                </div>
                                            </div>
                                            <div className="mt-2 text-xs bg-gray-50 p-2 rounded text-center">Cost: {formatCurrency(i.costPerUnit)} / {i.unit}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {['products', 'customers', 'suppliers', 'tables', 'staff'].includes(view) && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 capitalize">
                                    <h2 className="text-2xl font-bold">{view}</h2>
                                    <button onClick={()=>setModalConfig({show:true, type: view === 'staff' ? 'staff' : view.slice(0,-1)})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(view==='products'?products:view==='customers'?customers:view==='suppliers'?suppliers:view==='staff'?staff:tables).map(item => (
                                        <div key={item.id} className="bg-white p-4 rounded-xl border hover:shadow-md transition relative group">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold flex-shrink-0">
                                                    {view==='products' && item.image ? <img src={item.image} className="w-full h-full object-cover rounded-full"/> : item.name[0]}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <h4 className="font-bold truncate">{item.name}</h4>
                                                    {view==='products' && <div className="text-sm text-blue-600 font-bold">{formatCurrency(item.price)}</div>}
                                                    {view==='products' && <div className="text-xs text-gray-500 mt-1">Stok: {item.stock}</div>}
                                                    
                                                    {view==='products' && (
                                                        <div className="mt-2 pt-2 border-t border-dashed">
                                                            {item.recipe && item.recipe.length > 0 ? (
                                                                <div className="text-[10px] space-y-1">
                                                                    <div className="font-bold text-gray-400">RESEP:</div>
                                                                    {item.recipe.map((r,idx) => {
                                                                        const ing = ingredients.find(i=>i.id===r.ingId);
                                                                        return <div key={idx} className="flex justify-between bg-purple-50 text-purple-700 px-1 rounded"><span>{ing?.name}</span><span>{r.qty} {ing?.unit}</span></div>
                                                                    })}
                                                                    <button onClick={()=>updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'products',item.id), {recipe: []})} className="text-red-500 hover:underline w-full text-center mt-1">Reset Resep</button>
                                                                </div>
                                                            ) : <div className="text-[10px] text-gray-400 italic">Tanpa Resep (Stok Langsung)</div>}
                                                            <button onClick={()=>setModalConfig({show:true, type:'recipe_setup', data:item})} className="w-full mt-1 bg-gray-100 text-xs py-1 rounded font-bold hover:bg-gray-200">+ Atur Resep</button>
                                                        </div>
                                                    )}

                                                    {view==='staff' && <div className="text-sm text-gray-500 uppercase font-bold text-blue-600">{item.role} (PIN: {item.pin})</div>}
                                                    {view==='tables' && <div className="text-sm text-gray-500">Kapasitas: {item.capacity} org</div>}
                                                    {view==='customers' && <div className="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded inline-block mt-1">{item.memberCode}</div>}
                                                    {view==='customers' && <div className="text-[10px] text-gray-500 mt-1">Poin: {item.points || 0}</div>}
                                                    {(view==='customers'||view==='suppliers') && <div className="text-sm text-gray-500">{item.phone}</div>}
                                                </div>
                                            </div>
                                            <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                                {view==='customers' && <button onClick={()=>setModalConfig({show:true, type:'show_member_card', data:item})} className="p-1.5 bg-green-100 text-green-600 rounded" title="Kartu Member"><Icon name="credit-card" size={14}/></button>}
                                                <button onClick={()=>setModalConfig({show:true, type: view === 'staff' ? 'staff' : view.slice(0,-1), data:item})} className="p-1.5 bg-gray-100 hover:text-blue-600 rounded"><Icon name="edit-2" size={14}/></button>
                                                <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,view,item.id))}} className="p-1.5 bg-gray-100 hover:text-red-600 rounded"><Icon name="trash" size={14}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    {/* DYNAMIC MODAL FORM */}
                    {modalConfig.show && (
                        <Modal title={modalConfig.type.replace('_', ' ')} onClose={()=>setModalConfig({show:false})}>
                            
                            {modalConfig.type === 'show_member_card' && <MemberCardModal customer={modalConfig.data} storeProfile={storeProfile} onClose={()=>setModalConfig({show:false})} />}

                            {modalConfig.type === 'hold_list' && (
                                <div className="space-y-3">
                                    {heldCarts.length === 0 && <p className="text-center text-gray-400">Tidak ada antrean.</p>}
                                    {heldCarts.map(h => (
                                        <div key={h.id} onClick={()=>restoreTransaction(h)} className="p-3 border rounded-lg hover:bg-blue-50 cursor-pointer flex justify-between items-center">
                                            <div>
                                                <div className="font-bold">{h.cust?.name || 'Umum'}</div>
                                                <div className="text-xs text-gray-500">{h.cart.length} item  {h.time.toLocaleTimeString()}</div>
                                            </div>
                                            <Icon name="arrow-right-circle" className="text-blue-600"/>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {modalConfig.type === 'close_shift' && (
                                <form onSubmit={handleCloseShift} className="space-y-4">
                                    <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4 text-sm">
                                        <h4 className="font-bold text-yellow-800 mb-2">Ringkasan Shift</h4>
                                        <div className="flex justify-between"><span>Modal Awal:</span> <b>{formatCurrency(shift?.startCash)}</b></div>
                                        <div className="flex justify-between"><span>Penjualan Tunai:</span> <b>{formatCurrency(transactions.filter(t=>t.paymentMethod==='Tunai' && t.shiftId===shift.id).reduce((a,b)=>a+(b.total||0),0))}</b></div>
                                        <div className="flex justify-between text-red-600"><span>Pengeluaran:</span> <b>-{formatCurrency(expenses.filter(ex=>ex.date?.seconds>=shift.startTime?.seconds).reduce((a,b)=>a+(b.amount||0),0))}</b></div>
                                    </div>
                                    <label className="block text-sm font-bold text-gray-700">Total Uang Fisik di Laci</label>
                                    <input name="endCash" type="number" placeholder="Hitung uang tunai..." required className="w-full p-3 border rounded-lg text-lg font-bold" autoFocus/>
                                    <button className="w-full bg-red-600 text-white p-3 rounded-lg font-bold">Setor & Tutup Toko</button>
                                </form>
                            )}

                            {modalConfig.type === 'pay_debt' && (
                                <form onSubmit={handlePaymentSubmit} className="space-y-4">
                                    <div className="bg-blue-50 p-3 rounded-lg text-sm">
                                        <p>Pelanggan: <b>{modalConfig.data.customerName}</b></p>
                                        <p>Sisa Hutang: <b className="text-red-600">{formatCurrency(modalConfig.data.amount - modalConfig.data.paid)}</b></p>
                                    </div>
                                    <input name="amount" type="number" placeholder="Jumlah Bayar" max={modalConfig.data.amount - modalConfig.data.paid} required className="w-full p-3 border rounded-lg"/>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Proses Pembayaran</button>
                                </form>
                            )}
                        
                            {modalConfig.type === 'stock_adj' && (
                                <form onSubmit={handleAdjustStock} className="space-y-4">
                                    <div className="text-sm">Produk: <b>{modalConfig.data.name}</b></div>
                                    <select name="type" className="w-full p-3 border rounded-lg"><option value="in">Masuk</option><option value="out">Keluar</option></select>
                                    <input name="qty" type="number" placeholder="Jumlah" required className="w-full p-3 border rounded-lg"/>
                                    <textarea name="reason" placeholder="Keterangan" className="w-full p-3 border rounded-lg" required></textarea>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan</button>
                                </form>
                            )}

                            {modalConfig.type === 'edit_cart_item' && (
                                <div className="space-y-4">
                                    <h3 className="font-bold">{editingItem.name}</h3>
                                    <div className="flex gap-4 items-center">
                                        <button onClick={()=>setEditingItem(p=>({...p, qty: Math.max(1, p.qty-1)}))} className="p-2 bg-gray-200 rounded">-</button>
                                        <span className="font-bold">{editingItem.qty}</span>
                                        <button onClick={()=>setEditingItem(p=>({...p, qty: p.qty+1}))} className="p-2 bg-gray-200 rounded">+</button>
                                    </div>
                                    <input type="text" placeholder="Catatan Item (Pedas/Tanpa Es)" value={editingItem.note||''} onChange={e=>setEditingItem(p=>({...p, note:e.target.value}))} className="w-full p-2 border rounded text-sm"/>
                                    <div className="flex gap-2">
                                        <button onClick={()=>{setCart(cart.filter(c=>c.id!==editingItem.id)); setModalConfig({show:false});}} className="flex-1 bg-red-100 text-red-600 py-3 rounded">Hapus</button>
                                        <button onClick={()=>{setCart(cart.map(c=>c.id===editingItem.id ? editingItem : c)); setModalConfig({show:false});}} className="flex-1 bg-blue-600 text-white py-3 rounded">Simpan</button>
                                    </div>
                                </div>
                            )}

                            {modalConfig.type === 'settings' && (
                                <form onSubmit={saveSettings} className="space-y-4">
                                    {/* [ADD] INFORMASI ID TOKO */}
                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <label className="text-xs font-bold text-blue-600 uppercase">ID Toko Anda (Berikan ke Staff)</label>
                                        <div className="flex gap-2 mt-1">
                                            <input readOnly value={user.uid} className="w-full p-2 bg-white rounded text-sm font-mono border" onClick={e=>e.target.select()}/>
                                            <button type="button" onClick={()=>{navigator.clipboard.writeText(user.uid); alert("ID Disalin!")}} className="p-2 bg-blue-600 text-white rounded"><Icon name="copy" size={16}/></button>
                                        </div>
                                    </div>
                                    <input name="name" placeholder="Nama Toko" defaultValue={storeProfile?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="address" placeholder="Alamat Lengkap" defaultValue={storeProfile?.address} className="w-full p-3 border rounded-lg"/>
                                    <input name="phone" placeholder="No. Telepon" defaultValue={storeProfile?.phone} className="w-full p-3 border rounded-lg"/>
                                    <input name="logo" placeholder="URL Logo (Link Gambar)" defaultValue={storeProfile?.logo} className="w-full p-3 border rounded-lg"/>
                                    <textarea name="footerMessage" placeholder="Pesan di Bawah Struk" defaultValue={storeProfile?.footerMessage} className="w-full p-3 border rounded-lg"/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs">Pajak (%)</label><input name="taxRate" type="number" step="0.1" defaultValue={storeProfile?.taxRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                        <div><label className="text-xs">Service (%)</label><input name="serviceRate" type="number" step="0.1" defaultValue={storeProfile?.serviceRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">Ukuran Kertas Printer</label>
                                        <select name="paperSize" defaultValue={storeProfile?.paperSize || '58mm'} className="w-full p-3 border rounded-lg">
                                            <option value="58mm">58mm (Thermal Kecil)</option>
                                            <option value="80mm">80mm (Thermal Besar)</option>
                                        </select>
                                    </div>

                                    {/* [NEW] KONVERSI POIN */}
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">Konversi Poin (Rp untuk 1 Poin)</label>
                                        <input name="pointConversion" type="number" defaultValue={storeProfile?.pointConversion || 10000} className="w-full p-3 border rounded-lg"/>
                                    </div>

                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan Pengaturan</button>
                                </form>
                            )}
                            
                            {modalConfig.type === 'ingredient' && (
                                <form onSubmit={handleSubmit} className="space-y-4 capitalize">
                                    <input name="name" placeholder="Nama Bahan (Misal: Beras)" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="unit" placeholder="Satuan (kg, gram, butir)" required defaultValue={modalConfig.data?.unit} className="w-full p-3 border rounded-lg"/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="stock" type="number" placeholder="Stok Awal" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                        <input name="costPerUnit" type="number" placeholder="Harga Beli / Satuan" required defaultValue={modalConfig.data?.costPerUnit} className="w-full p-3 border rounded-lg"/>
                                    </div>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan Bahan</button>
                                </form>
                            )}

                            {modalConfig.type === 'recipe_setup' && (
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="bg-purple-50 p-3 rounded text-sm text-purple-700 font-bold border border-purple-200">
                                        Menambah komposisi resep untuk: <br/><span className="text-lg">{modalConfig.data.name}</span>
                                    </div>
                                    <select name="ingId" className="w-full p-3 border rounded-lg bg-white" required>
                                        <option value="">-- Pilih Bahan Baku --</option>
                                        {ingredients.map(i=><option key={i.id} value={i.id}>{i.name} ({i.unit})</option>)}
                                    </select>
                                    <input name="qty" type="number" step="0.01" placeholder="Jumlah Takaran Pemakaian" required className="w-full p-3 border rounded-lg"/>
                                    <p className="text-xs text-gray-500">Contoh: Jika Nasi Goreng butuh 200 gram beras, pilih "Beras" lalu isi "200".</p>
                                    <button className="w-full bg-purple-600 text-white p-3 rounded-lg font-bold">Tambahkan ke Resep</button>
                                </form>
                            )}

                            {['product', 'customer', 'supplier', 'expense', 'table', 'staff'].includes(modalConfig.type) && (
                                <form onSubmit={handleSubmit} className="space-y-4 capitalize">
                                    <input name="name" placeholder="Nama" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                    
                                    {modalConfig.type === 'product' && <>
                                        <div className="flex gap-2">
                                            <input name="barcode" placeholder="Barcode" defaultValue={modalConfig.data?.barcode} className="w-full p-3 border rounded-lg"/>
                                            <button type="button" onClick={()=>setScannerContext('form')} className="p-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><Icon name="camera"/></button>
                                        </div>
                                        <input name="category" placeholder="Kategori" defaultValue={modalConfig.data?.category} className="w-full p-3 border rounded-lg"/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="price" type="number" placeholder="Harga" required defaultValue={modalConfig.data?.price} className="w-full p-3 border rounded-lg"/>
                                            <input name="hpp" type="number" placeholder="HPP (Manual/Override)" defaultValue={modalConfig.data?.hpp} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="stock" type="number" placeholder="Stok (Produk Jadi)" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                            <input name="image" placeholder="Link Gambar" defaultValue={modalConfig.data?.image} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        
                                        <div className="p-3 bg-gray-50 border rounded-lg">
                                            <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Setting Harga Grosir</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <input name="wholesaleQty" type="number" placeholder="Min Qty (Misal: 10)" defaultValue={modalConfig.data?.wholesaleQty} className="w-full p-2 border rounded bg-white text-sm"/>
                                                <input name="wholesalePrice" type="number" placeholder="Harga Grosir (Rp)" defaultValue={modalConfig.data?.wholesalePrice} className="w-full p-2 border rounded bg-white text-sm"/>
                                            </div>
                                        </div>
                                    </>}

                                    {modalConfig.type === 'staff' && <>
                                        <input name="email" type="email" placeholder="Email Google Staff (Wajib)" required defaultValue={modalConfig.data?.email} className="w-full p-3 border rounded-lg"/>
                                        
                                        {/* [NEW] PENGATURAN JADWAL & STATUS */}
                                        <div className="bg-gray-100 p-3 rounded-lg border">
                                            <label className="text-xs font-bold text-gray-500 block mb-1">Jadwal Kerja (Otomatis)</label>
                                            <div className="flex gap-2 mb-2">
                                                <input type="time" name="shiftStart" defaultValue={modalConfig.data?.shiftStart || "08:00"} className="w-full p-2 border rounded"/>
                                                <span className="self-center">-</span>
                                                <input type="time" name="shiftEnd" defaultValue={modalConfig.data?.shiftEnd || "17:00"} className="w-full p-2 border rounded"/>
                                            </div>
                                            
                                            <label className="text-xs font-bold text-gray-500 block mb-1">Status Akun (Manual)</label>
                                            <select name="isActive" defaultValue={modalConfig.data?.isActive === false ? "false" : "true"} className="w-full p-2 border rounded bg-white">
                                                <option value="true">Aktif (Bisa Login)</option>
                                                <option value="false">Nonaktif (Blokir)</option>
                                            </select>
                                        </div>
                                        <input name="pin" type="text" placeholder="PIN Akses" required defaultValue={modalConfig.data?.pin} className="w-full p-3 border rounded-lg"/>
                                        <select name="role" defaultValue={modalConfig.data?.role||'kasir'} className="w-full p-3 border rounded-lg">
                                            <option value="kasir">Kasir (Jualan)</option>
                                            <option value="admin">Admin (Full Akses)</option>
                                            <option value="gudang">Gudang (Stok)</option>
                                            <option value="waiter">Waiter (Input Order)</option>
                                        </select>
                                    </>}
                                    
                                    {modalConfig.type === 'expense' && <>
                                        <input name="amount" type="number" placeholder="Jumlah Biaya (Rp)" required defaultValue={modalConfig.data?.amount} className="w-full p-3 border rounded-lg"/>
                                        <select name="category" defaultValue={modalConfig.data?.category} className="w-full p-3 border rounded-lg"><option value="Operasional">Operasional</option><option value="Gaji">Gaji Karyawan</option><option value="Belanja">Belanja Bahan</option><option value="Lainnya">Lainnya</option></select>
                                    </>}
                                    
                                    {modalConfig.type === 'customer' && <>
                                        <input name="phone" placeholder="No HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/>
                                        <input name="nik" placeholder="NIK (KTP)" defaultValue={modalConfig.data?.nik} className="w-full p-3 border rounded-lg"/>
                                        <input name="email" placeholder="Email (Opsional)" defaultValue={modalConfig.data?.email} className="w-full p-3 border rounded-lg"/>
                                    </>}
                                    
                                    {modalConfig.type === 'supplier' && <><input name="phone" placeholder="No HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/><input name="address" placeholder="Alamat" defaultValue={modalConfig.data?.address} className="w-full p-3 border rounded-lg"/></>}
                                    {modalConfig.type === 'table' && <input name="capacity" type="number" placeholder="Kapasitas (Orang)" defaultValue={modalConfig.data?.capacity} className="w-full p-3 border rounded-lg"/>}

                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan</button>
                                </form>
                            )}
                        </Modal>
                    )}

                    {scannerContext === 'form' && (
                        <BarcodeScanner onScan={handleScanResult} onClose={()=>setScannerContext(null)} isInline={false} />
                    )}

                    <Receipt data={lastTrans} storeProfile={storeProfile} onClose={()=>setLastTrans(null)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
