<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kasir Pro v10.7.1.3</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @media print { 
            .no-print { display: none !important; }
            @page { margin: 0; }
            body { margin: 0; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useEffect, useRef } = React;
        
        const Icon = ({ name, size = 20, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => { lucide.createIcons({ root: iconRef.current ? iconRef.current.parentNode : document, nameAttr: 'data-lucide', attrs: {class: className} }); }, [name]);
            return <i ref={iconRef} data-lucide={name} width={size} height={size} className={className}></i>;
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithPhoneNumber, RecaptchaVerifier } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp, query, where, orderBy, setDoc, limit, enableIndexedDbPersistence, increment, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC4t1Gya_QHDzTkYsF7U-pw1Uo1oQUABpM",
            authDomain: "websitemarkaz.firebaseapp.com",
            databaseURL: "https://websitemarkaz-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "websitemarkaz",
            storageBucket: "websitemarkaz.firebasestorage.app",
            messagingSenderId: "5529883980",
            appId: "1:5529883980:web:792ce6d869070e9a79ebe9"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch((err) => {});

        const APP_ID = "kasir-pintar-pro-v6";
        const formatCurrency = (val) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(val || 0);
        
        const formatNumberInput = (numStr) => {
            if (!numStr) return '';
            const num = numStr.replace(/\D/g, ''); 
            return new Intl.NumberFormat('id-ID').format(num);
        };

        const parseNumberInput = (formattedStr) => {
            if (!formattedStr) return 0;
            return Number(formattedStr.replace(/\./g, ''));
        };
        
        const formatDate = (ts) => {
            if (!ts) return '-';
            try {
                const date = ts.toDate ? ts.toDate() : new Date(ts);
                return new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium', timeStyle: 'short' }).format(date);
            } catch (e) { return '-'; }
        };

        // --- COMPONENTS ---
        const Modal = ({ title, onClose, children, maxWidth = "max-w-md" }) => (
            <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in" style={{zIndex: 1000}}>
                <div className={`bg-white rounded-2xl w-full ${maxWidth} shadow-2xl overflow-hidden flex flex-col max-h-[90vh]`}>
                    <div className="p-4 border-b flex justify-between items-center bg-gray-50">
                        <h3 className="font-bold text-lg text-gray-800 uppercase">{title}</h3>
                        <button onClick={onClose} className="hover:bg-gray-200 p-1 rounded-full"><Icon name="x" size={20}/></button>
                    </div>
                    <div className="p-6 overflow-y-auto">{children}</div>
                </div>
            </div>
        );

        const MemberCardModal = ({ customer, storeProfile, onClose }) => {
            const [isProcessing, setIsProcessing] = useState(false);
            const qrRef = useRef(null);
            // [FIX 1] Ref untuk melacak apakah komponen masih terpasang (mounted)
            const isMounted = useRef(true);

            useEffect(() => {
                // Cleanup function saat modal ditutup
                return () => { isMounted.current = false; };
            }, []);

            useEffect(() => {
                if (qrRef.current) {
                    qrRef.current.innerHTML = "";
                    try {
                        new QRCode(qrRef.current, {
                            text: customer.memberCode,
                            width: 100, height: 100,
                            colorDark : "#000000", colorLight : "#ffffff",
                            correctLevel : QRCode.CorrectLevel.H
                        });
                    } catch(e) { console.error("QR Error", e); }
                }
            }, [customer]);
            
            const handleShare = async () => {
                if (isProcessing) return;
                setIsProcessing(true);
                
                try {
                    const element = document.getElementById('member-card-capture');
                    if (!element) throw new Error("Elemen kartu tidak ditemukan");
                    
                    // Generate Canvas
                    const canvas = await html2canvas(element, { 
                        scale: 2, // Resolusi lebih baik
                        backgroundColor: null, 
                        logging: false, 
                        useCORS: true 
                    });

                    // [FIX 2] Konversi callback toBlob menjadi Promise agar bisa di-await & ditangkap try-catch
                    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));

                    if (!blob) throw new Error("Gagal membuat file gambar.");

                    const file = new File([blob], `Member-${customer.name}.png`, { type: "image/png" });

                    // Web Share API
                    if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                        await navigator.share({
                            title: `Member ${customer.name}`,
                            text: `Kartu Member ${storeProfile?.name || 'Toko'}.`,
                            files: [file]
                        });
                    } else {
                        // Fallback Download
                        const link = document.createElement('a');
                        const url = URL.createObjectURL(blob);
                        link.href = url;
                        link.download = `Member-${customer.name}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url); // [FIX 3] Bersihkan memori
                        alert("Gambar disimpan ke Download.");
                    }

                } catch (err) {
                    console.error("Capture Error:", err);
                    // Abaikan error jika user membatalkan share (AbortError)
                    if (err.name !== 'AbortError') {
                        alert("Gagal memproses gambar: " + err.message);
                    }
                } finally {
                    // [FIX 4] Cek isMounted sebelum update state untuk mencegah crash (layar putih)
                    if (isMounted.current) {
                        setIsProcessing(false);
                    }
                }
            };

            return (
                <Modal title="Kartu Member Digital" onClose={onClose}>
                    <div id="member-card-capture" className="bg-gradient-to-r from-blue-600 to-indigo-700 rounded-xl p-6 text-white shadow-xl relative overflow-hidden mb-4 transform-gpu">
                        <div className="absolute top-0 right-0 -mt-4 -mr-4 w-24 h-24 bg-white/10 rounded-full blur-xl"></div>
                        <div className="flex justify-between items-start">
                            <div>
                                <h3 className="font-bold text-xl">{storeProfile?.name || 'Toko Member'}</h3>
                                <p className="text-xs text-blue-200 uppercase tracking-widest mt-1">Kartu Keanggotaan</p>
                            </div>
                            <div className="bg-white p-2 rounded-lg">
                                <div ref={qrRef}></div>
                            </div>
                        </div>
                        <div className="mt-6">
                            <p className="text-2xl font-bold font-mono tracking-wider">{customer.memberCode}</p>
                            <p className="text-sm mt-1 font-bold uppercase">{customer.name}</p>
                            <div className="flex justify-between items-end mt-2">
                                <p className="text-xs text-blue-200">Member Sejak: {new Date().getFullYear()}</p>
                                <div className="text-right">
                                    <span className="text-[10px] text-blue-200 block">POIN</span>
                                    <span className="font-bold text-xl">{customer.points || 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button onClick={handleShare} disabled={isProcessing} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-green-700 transition">
                        {isProcessing ? 'Memproses...' : <><Icon name="share-2" size={18}/> Bagikan / Simpan Kartu</>}
                    </button>
                </Modal>
            );
        };

        const BarcodeScanner = ({ onScan, onClose, isInline = false }) => {
            const scannerRef = useRef(null);
            const html5QrCodeRef = useRef(null);

            useEffect(() => {
                const timer = setTimeout(() => {
                    const html5QrCode = new Html5Qrcode("reader");
                    html5QrCodeRef.current = html5QrCode;
                    const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                    html5QrCode.start({ facingMode: "environment" }, config, 
                        (decodedText) => onScan(decodedText),
                        (errorMessage) => {}
                    ).catch(err => {
                        console.error(err);
                        alert("Gagal membuka kamera.");
                        onClose();
                    });
                }, 300);
                return () => {
                    clearTimeout(timer);
                    if (html5QrCodeRef.current) {
                        if (html5QrCodeRef.current.isScanning) {
                            html5QrCodeRef.current.stop().then(() => html5QrCodeRef.current.clear()).catch(e=>{});
                        } else {
                            html5QrCodeRef.current.clear();
                        }
                    }
                };
            }, []);

            const content = (
                <div className="flex flex-col items-center w-full">
                    <div id="reader" className="w-full bg-black overflow-hidden rounded-lg relative" style={{minHeight: isInline ? '250px' : '300px'}}></div>
                    <p className="text-xs text-gray-500 mt-2 animate-pulse">Scan Barcode Produk / Member...</p>
                    {isInline && (
                        <button onClick={onClose} className="mt-3 bg-red-100 text-red-600 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                            <Icon name="x-circle" size={16}/> Tutup Kamera
                        </button>
                    )}
                </div>
            );
            if (isInline) return <div className="mb-4 p-4 bg-gray-100 rounded-xl border border-blue-200 shadow-inner">{content}</div>;
            return <Modal title="Scan Barcode" onClose={onClose}>{content}</Modal>;
        };

        const LoginScreen = () => {
            const [phone, setPhone] = useState('');
            const [otp, setOtp] = useState('');
            const [showOtp, setShowOtp] = useState(false);
            const [loading, setLoading] = useState(false);
            const [confirmObj, setConfirmObj] = useState(null);
            const recaptchaRef = useRef(null);

            useEffect(() => {
                if (window.recaptchaVerifier) window.recaptchaVerifier.clear();
                if (recaptchaRef.current) recaptchaRef.current.innerHTML = '';
            }, []);

            const handleGoogleLogin = async () => {
                try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (err) { alert(err.message); }
            };

            const handleSendOtp = async (e) => {
                e.preventDefault(); setLoading(true);
                let formatPhone = phone.trim().replace(/^0/, '+62');
                if (!formatPhone.startsWith('+')) formatPhone = '+62' + formatPhone;
                try {
                    if (!window.recaptchaVerifier) window.recaptchaVerifier = new RecaptchaVerifier(auth, recaptchaRef.current, { 'size': 'invisible' });
                    const confirmation = await signInWithPhoneNumber(auth, formatPhone, window.recaptchaVerifier);
                    setConfirmObj(confirmation); setShowOtp(true); setLoading(false);
                } catch (err) { alert(err.message); setLoading(false); }
            };

            const handleVerifyOtp = async (e) => {
                e.preventDefault(); setLoading(true);
                try { await confirmObj.confirm(otp); } catch (err) { alert("Kode Salah"); setLoading(false); }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-600 to-indigo-900 flex items-center justify-center p-4 font-sans">
                    <div className="bg-white w-full max-w-md rounded-2xl p-8 shadow-2xl overflow-hidden">
                        <div className="text-center mb-8">
                            <div className="bg-blue-100 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600"><Icon name="store" size={32}/></div>
                            <h1 className="text-2xl font-bold text-gray-800">Kasir Pintar Pro</h1>
                            <p className="text-gray-500 text-sm">Masuk untuk mengelola toko Anda</p>
                        </div>
                        {!showOtp ? (
                            <form onSubmit={handleSendOtp} className="space-y-4">
                                <input type="tel" className="w-full p-3 border rounded-lg" placeholder="Nomor HP (Contoh: 812xxx)" value={phone} onChange={e=>setPhone(e.target.value)} required />
                                <div ref={recaptchaRef}></div>
                                <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">{loading?'Loading...':'Kirim OTP'}</button>
                                <div className="text-center text-xs text-gray-400 mt-4">ATAU</div>
                                <button type="button" onClick={handleGoogleLogin} className="w-full border p-3 rounded-lg mt-2 font-bold text-gray-600">Masuk dengan Google</button>
                            </form>
                        ) : (
                            <form onSubmit={handleVerifyOtp} className="space-y-4">
                                <input type="number" className="w-full p-3 border rounded-lg text-center text-xl" placeholder="Kode OTP" value={otp} onChange={e=>setOtp(e.target.value)} />
                                <button disabled={loading} className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Verifikasi</button>
                            </form>
                        )}
                    </div>
                </div>
            );
        };

        const Receipt = ({ data, storeProfile, onClose }) => {
            if (!data) return null;
            const paperWidth = storeProfile?.paperSize === '80mm' ? '80mm' : '58mm';
            const change = (data.cashReceived || 0) - data.total;

            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white w-full max-w-md rounded-xl shadow-2xl overflow-hidden flex flex-col animate-fade-in" style={{maxWidth: '400px'}}>
                        <div className="bg-gray-900 text-white p-4 flex justify-between items-center no-print">
                            <h3 className="font-bold flex items-center gap-2"><Icon name="check-circle" size={18}/> Transaksi Sukses</h3>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div id="print-area" className="p-4 bg-white overflow-y-auto max-h-[70vh] mx-auto" style={{width: paperWidth, fontFamily: 'monospace', fontSize: '12px'}}>
                            <div className="text-center mb-4">
                                {storeProfile?.logo && <img src={storeProfile.logo} className="h-12 mx-auto mb-2 object-contain" />}
                                <h2 className="text-lg font-bold uppercase">{storeProfile?.name || 'Toko Kasir Pro'}</h2>
                                <p className="text-gray-500">{storeProfile?.address}</p>
                                <p className="text-gray-500">{storeProfile?.phone}</p>
                            </div>
                            <div className="border-b border-dashed border-gray-400 pb-2 mb-2">
                                <p>#{data.id.slice(0,8).toUpperCase()} | {formatDate(data.createdAt)}</p>
                                <p>Cst: {data.customerName}</p>
                                <p>Kasir: {data.cashierName || '-'}</p> 
                            </div>
                            <div className="space-y-2 mb-4">
                                {data.items.map((item, i) => (
                                    <div key={i} className="flex justify-between">
                                        <div className="flex-1 pr-2">
                                            <div>{item.name}</div>
                                            <div className="text-gray-500">{item.qty} x {formatCurrency(item.price)}</div>
                                        </div>
                                        <div>{formatCurrency((item.price * item.qty) - (item.itemDiscount || 0))}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-dashed border-gray-400 pt-2 text-right">
                                <div className="flex justify-between"><span>Subtotal</span><span>{formatCurrency(data.subtotal)}</span></div>
                                {/* [UPDATE] Tampilkan Diskon di Struk */}
                                {data.discount > 0 && (
                                    <div className="flex justify-between text-red-600"><span>Diskon</span><span>-{formatCurrency(data.discount)}</span></div>
                                )}
								<div className="flex justify-between font-bold text-lg border-t border-dotted mt-2 pt-1"><span>Total</span><span>{formatCurrency(data.total)}</span></div>
                                {data.paymentMethod === 'Tunai' && (
                                    <>
                                        <div className="flex justify-between text-xs mt-1"><span>Tunai:</span><span>{formatCurrency(data.cashReceived)}</span></div>
                                        <div className="flex justify-between text-xs"><span>Kembali:</span><span>{formatCurrency(change)}</span></div>
                                    </>
                                )}
                                {data.pointsEarned > 0 && (
                                    <div className="mt-2 pt-2 border-t border-dashed text-xs">
                                        <div className="flex justify-between"><span>Poin Transaksi:</span><span>+{data.pointsEarned}</span></div>
                                        <div className="flex justify-between font-bold"><span>Total Poin:</span><span>{data.customerPointsTotal}</span></div>
                                    </div>
                                )}
                                <div className="text-center mt-4 italic text-gray-500">{storeProfile?.footerMessage}</div>
                            </div>
                        </div>
                        <div className="p-4 bg-white border-t no-print">
                            <button onClick={() => {
                                const printContent = document.getElementById('print-area').innerHTML;
                                const originalContents = document.body.innerHTML;
                                document.body.innerHTML = printContent;
                                window.print();
                                document.body.innerHTML = originalContents;
                                window.location.reload(); 
                            }} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold flex items-center justify-center gap-2 hover:bg-blue-700">
                                <Icon name="printer" size={18}/> Cetak Struk
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [storeId, setStoreId] = useState(localStorage.getItem('kp_store_id')); 

            const [view, setView] = useState('pos');
            const [loading, setLoading] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            
            const [products, setProducts] = useState([]);
            const [ingredients, setIngredients] = useState([]);
            const [customers, setCustomers] = useState([]);
            const [suppliers, setSuppliers] = useState([]); 
            const [expenses, setExpenses] = useState([]); 
            const [debts, setDebts] = useState([]); 
            const [storeProfile, setStoreProfile] = useState({}); 
            const [tables, setTables] = useState([]); 
            const [shift, setShift] = useState(null); 
            const [transactions, setTransactions] = useState([]);
            const [stockHistory, setStockHistory] = useState([]); 

            const [cart, setCart] = useState([]);
            const [activeOrders, setActiveOrders] = useState([]); 
            const [selectedOrderId, setSelectedOrderId] = useState(null); 
            const [selectedCustomer, setSelectedCustomer] = useState(null);
            const [selectedTable, setSelectedTable] = useState(null); 
            const [discount, setDiscount] = useState(0); 
            const [paymentMethod, setPaymentMethod] = useState('Tunai');
            const [orderType, setOrderType] = useState('Dine In'); 
            const [lastTrans, setLastTrans] = useState(null);
            const [searchQuery, setSearchQuery] = useState("");
            const [cashReceived, setCashReceived] = useState(''); 
            
            const [staff, setStaff] = useState([]); 
            const [activeStaff, setActiveStaff] = useState(null); 
            
            const [editingItem, setEditingItem] = useState(null);
			const [tempVariantProduct, setTempVariantProduct] = useState(null); // Produk yg sedang dipilih variannya
            const [selectedVariantTemp, setSelectedVariantTemp] = useState(null); 
            const [tempModifiers, setTempModifiers] = useState([]); // Checkbox modifier yg dipilih
			const [splitSelection, setSplitSelection] = useState({}); // Item yg dipilih untuk Split Bill

			const [isMovingTable, setIsMovingTable] = useState(null);
			const [promos, setPromos] = useState([]); // Daftar semua promo
            const [appliedPromo, setAppliedPromo] = useState(null); // Promo yang dipakai saat ini
			const [transfers, setTransfers] = useState([]); // Riwayat transfer (Masuk & Keluar)
            const [transferCart, setTransferCart] = useState([]); // Barang yg mau dikirim
            const [targetStoreId, setTargetStoreId] = useState(''); // ID Toko Tujuan
            const [modalConfig, setModalConfig] = useState({ show: false, type: '', data: null });
            const [settingsTab, setSettingsTab] = useState('profile');
            const [scannerContext, setScannerContext] = useState(null); 

            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, (u) => { setUser(u); setLoading(false); });
                return unsubscribe;
            }, []);

            useEffect(() => {
                if (!user) return;
                if (!storeId) { setLoading(false); return; }

                setLoading(true);
                const basePath = ['artifacts', APP_ID, 'users', storeId];
                
                const unsubProd = onSnapshot(collection(db, ...basePath, 'products'), s => setProducts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubIng = onSnapshot(collection(db, ...basePath, 'ingredients'), s => setIngredients(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubCust = onSnapshot(collection(db, ...basePath, 'customers'), s => setCustomers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubSupp = onSnapshot(collection(db, ...basePath, 'suppliers'), s => setSuppliers(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubExp = onSnapshot(collection(db, ...basePath, 'expenses'), s => setExpenses(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubDebts = onSnapshot(collection(db, ...basePath, 'debts'), s => setDebts(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubStock = onSnapshot(query(collection(db, ...basePath, 'stock_history'), orderBy('createdAt', 'desc'), limit(50)), s => setStockHistory(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubTrans = onSnapshot(query(collection(db, ...basePath, 'transactions'), orderBy('createdAt', 'desc'), limit(50)), s => setTransactions(s.docs.map(d => ({id:d.id, ...d.data()}))));
                const unsubOrders = onSnapshot(query(collection(db, ...basePath, 'orders'), orderBy('createdAt', 'asc')), s => setActiveOrders(s.docs.map(d => ({id:d.id, ...d.data()}))));
				const unsubTables = onSnapshot(query(collection(db, ...basePath, 'tables'), orderBy('name', 'asc')), s => setTables(s.docs.map(d => ({id:d.id, ...d.data()}))));
                // [BARU] Listener Promo
                const unsubPromos = onSnapshot(query(collection(db, ...basePath, 'promos')), s => setPromos(s.docs.map(d => ({id:d.id, ...d.data()}))));
                // [BARU] Listener Transfer (Gabungan Masuk & Keluar)
                // 1. Barang Masuk (Ke Toko Ini)
                const qIn = query(collection(db, 'artifacts', APP_ID, 'transfers'), where('toId', '==', storeId), orderBy('createdAt', 'desc'));
                const unsubIn = onSnapshot(qIn, s => {
                    const inData = s.docs.map(d => ({id:d.id, dir:'in', ...d.data()}));
                    setTransfers(prev => {
                        const others = prev.filter(p => p.dir !== 'in'); // Hapus data lama yg 'in'
                        return [...others, ...inData].sort((a,b) => b.createdAt - a.createdAt);
                    });
                });

                // 2. Barang Keluar (Dari Toko Ini)
                const qOut = query(collection(db, 'artifacts', APP_ID, 'transfers'), where('fromId', '==', storeId), orderBy('createdAt', 'desc'));
                const unsubOut = onSnapshot(qOut, s => {
                    const outData = s.docs.map(d => ({id:d.id, dir:'out', ...d.data()}));
                    setTransfers(prev => {
                        const others = prev.filter(p => p.dir !== 'out'); // Hapus data lama yg 'out'
                        return [...others, ...outData].sort((a,b) => b.createdAt - a.createdAt);
                    });
                });
				const unsubStaff = onSnapshot(collection(db, ...basePath, 'staff'), s => {
                    const staffData = s.docs.map(d => ({id:d.id, ...d.data()}));
                    if(s.empty && storeId === user.uid) {
                        addDoc(collection(db, ...basePath, 'staff'), { name: 'Owner', email: user.email, role: 'admin', isActive: true });
                    }
                    setStaff(staffData);
                });
                
                const unsubSettings = onSnapshot(doc(db, ...basePath, 'settings', 'profile'), s => { if (s.exists()) setStoreProfile(s.data()); });
                const qShift = query(collection(db, ...basePath, 'shifts'), where('status', '==', 'open'));
                const unsubShift = onSnapshot(qShift, s => {}); 
                
                setTimeout(() => setLoading(false), 1000);
                // [FIX] Tambahkan unsubPromos, unsubIn, dan unsubOut ke sini:
                return () => { 
                    unsubProd(); unsubIng(); unsubCust(); unsubSupp(); unsubExp(); 
                    unsubDebts(); unsubStock(); unsubSettings(); unsubShift(); 
                    unsubTrans(); unsubTables(); unsubStaff(); 
                    if(unsubPromos) unsubPromos(); // Tambahan
                    if(unsubIn) unsubIn();         // Tambahan
                    if(unsubOut) unsubOut();       // Tambahan
                };
            }, [user, storeId]);

            // [AUTO LOGIN & VALIDATION LOGIC] - NO PIN
            useEffect(() => {
                if (user && staff.length > 0 && !activeStaff) {
                    if (storeId === user.uid) {
                        const ownerStaff = staff.find(s => s.role === 'admin' || s.email === user.email);
                        if (ownerStaff) {
                            setActiveStaff(ownerStaff);
                            setView('dashboard');
                        }
                    } else {
                        const myStaffProfile = staff.find(s => 
                            (user.email && s.email && s.email.toLowerCase() === user.email.toLowerCase()) ||
                            (user.phoneNumber && s.phone && s.phone === user.phoneNumber)
                        );

                        if (myStaffProfile) {
                            if(myStaffProfile.isActive === false) {
                                alert("Akun Anda dinonaktifkan oleh Owner.");
                                localStorage.removeItem('kp_store_id');
                                setStoreId(null);
                                return;
                            }
                            
                            // Cek Jam Kerja
                            if (myStaffProfile.role !== 'admin' && myStaffProfile.shiftStart && myStaffProfile.shiftEnd) {
                                const now = new Date();
                                const currentMin = now.getHours() * 60 + now.getMinutes();
                                const [sh, sm] = myStaffProfile.shiftStart.split(':').map(Number);
                                const [eh, em] = myStaffProfile.shiftEnd.split(':').map(Number);
                                const startMin = sh * 60 + sm;
                                const endMin = eh * 60 + em;
                                
                                if (currentMin < startMin || currentMin > endMin) {
                                    alert(`Diluar jam kerja (${myStaffProfile.shiftStart} - ${myStaffProfile.shiftEnd}). Akses ditolak.`);
                                    return; 
                                }
                            }
                            setActiveStaff(myStaffProfile);
                            setView('pos');
                        } else {
                            alert("Email Anda tidak terdaftar sebagai staff di toko ini.");
                            localStorage.removeItem('kp_store_id');
                            setStoreId(null);
                        }
                    }
                }
            }, [user, staff, storeId]);

            useEffect(() => {
                if(activeStaff && storeId) {
                    const basePath = ['artifacts', APP_ID, 'users', storeId];
                    const q = query(collection(db, ...basePath, 'shifts'), where('status', '==', 'open'), where('cashierName', '==', activeStaff.name));
                    const unsub = onSnapshot(q, s => {
                        setShift(s.empty ? null : {id: s.docs[0].id, ...s.docs[0].data()});
                    });
                    return unsub;
                }
            }, [activeStaff, storeId]);


            const getPrice = (prod, qty) => {
                if (prod.wholesaleQty && prod.wholesalePrice && qty >= prod.wholesaleQty) {
                    return Number(prod.wholesalePrice);
                }
                return Number(prod.price);
            };

            const addToCart = (p, variant = null, modifiers = null) => {
                // 1. Cek Varian (Jika produk punya varian tapi belum dipilih)
                if (!variant && p.variants && p.variants.length > 0) {
                    setTempVariantProduct(p);
                    setModalConfig({show: true, type: 'variant_select'});
                    return;
                }

                // 2. [BARU] Cek Modifier (Jika produk punya modifier, tapi belum ada list modifier yg dikirim)
                // Kita cek 'modifiers' === null artinya ini panggilan pertama, bukan callback dari modal modifier
                if (modifiers === null && p.modifiers && p.modifiers.length > 0) {
                    setTempVariantProduct(p);
                    setSelectedVariantTemp(variant); // Simpan varian yg sudah dipilih (kalau ada)
                    setTempModifiers([]); // Reset pilihan
                    setModalConfig({show: true, type: 'modifier_select'});
                    return;
                }

                const finalModifiers = modifiers || []; // Pastikan array
                
                // Hitung Harga Akhir (Harga Dasar/Varian + Total Harga Modifier)
                const basePrice = variant ? Number(variant.price) : getPrice(p, 1);
                const modifiersPrice = finalModifiers.reduce((a,b) => a + Number(b.price), 0);
                const finalPrice = basePrice + modifiersPrice;

                // Buat Nama Unik: "Nasi Goreng (Jumbo) + Telur + Pedas"
                let nameSuffix = variant ? ` (${variant.name})` : '';
                if(finalModifiers.length > 0) nameSuffix += ` + ${finalModifiers.map(m=>m.name).join(' + ')}`;
                const finalName = p.name + nameSuffix;

                // ID Unik Cart (ProdukID - Varian - ListModifierSorted)
                const modId = finalModifiers.map(m=>m.name).sort().join('-');
                const cartItemId = `${p.id}${variant ? '-'+variant.name : ''}${modId ? '-'+modId : ''}`;

                const hasRecipe = p.recipe && p.recipe.length > 0;
                if (!hasRecipe && p.stock <= 0) return alert("Stok Produk Habis!");

                setCart(prev => { 
                    const ex = prev.find(i => i.id === cartItemId); 
                    if (ex) {
                        const newQty = ex.qty + 1;
                        if (!hasRecipe && newQty > p.stock) return alert(`Stok Habis!`) || prev;
                        // Update harga total jika qty berubah
                        return prev.map(i => i.id === cartItemId ? {...i, qty: newQty} : i);
                    } else {
                        return [...prev, {
                            ...p, 
                            id: cartItemId, 
                            name: finalName, 
                            price: finalPrice, // Harga sudah termasuk modifier
                            qty: 1, 
                            itemDiscount: 0,
                            originalId: p.id,
                            isVariant: !!variant,
                            selectedModifiers: finalModifiers // Simpan data modifier
                        }];
                    }
                });
                
                // Tutup semua modal
                setModalConfig({show: false});
            };

            const handleScanResult = (code) => {
                if (scannerContext === 'pos') {
                    const prod = products.find(p => p.barcode === code);
                    if (prod) {
                        addToCart(prod);
                        return;
                    }
                    const cust = customers.find(c => c.memberCode === code);
                    if (cust) {
                        setSelectedCustomer(cust);
                        alert(`Pelanggan terdeteksi: ${cust.name} (Poin: ${cust.points||0})`);
                        return;
                    }
                    alert("Barcode tidak ditemukan (Produk/Member): " + code);
                } else if (scannerContext === 'form') {
                    setModalConfig(prev => ({ ...prev, data: { ...prev.data, barcode: code } }));
                    setScannerContext(null); 
                }
            };

            const holdTransaction = async () => {
                if(cart.length === 0) return alert("Keranjang kosong!");
                
                setIsProcessing(true);
                try {
                    // Siapkan data pesanan
                    const orderData = {
                        cust: selectedCustomer, 
                        cart: cart, 
                        table: selectedTable, 
                        orderType: orderType, 
                        createdAt: serverTimestamp(), 
                        waiter: activeStaff.name,
                        status: 'pending' // Kita pakai status 'pending' untuk tunda
                    };
                    
                    if (selectedOrderId) {
                        // Jika ini adalah pesanan lama yang diedit, kita update
                        await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', selectedOrderId), {
                            ...orderData,
                            updatedAt: serverTimestamp()
                        });
                        alert("Pesanan Antrean Diperbarui!");
                    } else {
                        // Jika pesanan baru, buat dokumen baru di Firebase
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'orders'), orderData);
                        alert("Transaksi Berhasil Ditunda (Tersimpan di Server).");
                    }

                    // Reset Layar POS
                    setCart([]); setSelectedCustomer(null); setSelectedTable(null); 
                    setCashReceived(''); setSelectedOrderId(null); setDiscount(0);
                } catch(e) {
                    alert("Gagal menunda transaksi: " + e.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleOrderToKitchen = async () => {
                if(cart.length === 0) return alert("Keranjang kosong!");
                if(!selectedTable && orderType === 'Dine In') return alert("Pilih Meja untuk Dine In!");
                
                setIsProcessing(true);
                try {
                    // [BARU] Simpan ke Firebase collection 'orders'
                    const orderData = {
                        cust: selectedCustomer, 
                        cart: cart, 
                        table: selectedTable, 
                        orderType: orderType, 
                        createdAt: serverTimestamp(), 
                        waiter: activeStaff.name,
                        status: 'cooking' // Status awal
                    };
                    
                    // Jika ini update pesanan yg sudah ada (tambah item), update doc lama
                    if (selectedOrderId) {
                        await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', selectedOrderId), {
                            cart: cart, // Update keranjang penuh
                            updatedAt: serverTimestamp()
                        });
                        alert("Pesanan Dapur Diperbarui!");
                    } else {
                        // Pesanan baru
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'orders'), orderData);
                        alert("Pesanan Terkirim ke Dapur!");
                    }
                    
                    // Reset POS
                    setCart([]); setSelectedCustomer(null); setSelectedTable(null); 
                    setCashReceived(''); setSelectedOrderId(null);
                } catch(e) {
                    alert("Gagal kirim: " + e.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const restoreTransaction = (h) => {
                if(cart.length > 0) { if(!confirm("Ada transaksi aktif di layar. Timpa?")) return; }
                setCart(h.cart); 
                setSelectedCustomer(h.cust); 
                setSelectedTable(h.table); 
                setOrderType(h.orderType || 'Dine In'); 
                setCashReceived('');
                setSelectedOrderId(h.id); // Simpan ID agar nanti bisa dihapus/diupdate
                setModalConfig({show: false});
            };

            const updateCartQty = (item, change) => {
                setCart(prev => {
                    return prev.map(i => {
                        if (i.id !== item.id) return i;
                        const newQty = i.qty + change;
                        if (newQty <= 0) return null;
                        const prod = products.find(p => p.id === i.id);
                        if (!prod) return i;
                        const hasRecipe = prod.recipe && prod.recipe.length > 0;
                        if (!hasRecipe && change > 0 && newQty > prod.stock) {
                            alert(`Maksimal stok tersedia: ${prod.stock}`);
                            return i; 
                        }
                        return { ...i, qty: newQty, price: getPrice(prod, newQty) }; 
                    }).filter(Boolean);
                });
            };

            const removeFromCart = (itemId) => {
                setCart(prev => prev.filter(item => item.id !== itemId));
            };

            const calculateTotals = () => {
                const subtotalRaw = cart.reduce((a,b) => a + (b.price * b.qty), 0);
                const itemDiscounts = cart.reduce((a,b) => a + (b.itemDiscount || 0), 0);
                let subtotal = subtotalRaw - itemDiscounts;
                
                // [BARU] LOGIKA PROMO OTOMATIS
                let promoDiscount = 0;
                let bonusItems = []; // Untuk promo Beli X Gratis Y (nanti ditampilkan di struk)

                if (appliedPromo) {
                    // Cek Syarat Minimum Belanja
                    if (subtotal >= (appliedPromo.minSpend || 0)) {
                        
                        // Tipe 1: Diskon Persen
                        if (appliedPromo.type === 'percent') {
                            promoDiscount = (subtotal * appliedPromo.value) / 100;
                            // Cek Maksimal Diskon (Cap)
                            if (appliedPromo.maxDiscount && promoDiscount > appliedPromo.maxDiscount) {
                                promoDiscount = appliedPromo.maxDiscount;
                            }
                        }
                        
                        // Tipe 2: Potongan Harga Tetap
                        else if (appliedPromo.type === 'fixed') {
                            promoDiscount = appliedPromo.value;
                        }
                    }
                }

                // Jangan sampai diskon lebih besar dari total belanja
                if (promoDiscount > subtotal) promoDiscount = subtotal;

                // Gabungkan Diskon Manual + Diskon Promo
                const totalDiscount = (Number(discount) || 0) + promoDiscount;

                // Hitung HPP (Logika Lama)
                const hppTotal = cart.reduce((a,b) => {
                     let itemHPP = b.hpp || 0;
                     if (b.recipe && b.recipe.length > 0) {
                        itemHPP = 0;
                        b.recipe.forEach(r => {
                            const ing = ingredients.find(i => i.id === r.ingId);
                            if(ing) itemHPP += (ing.costPerUnit || 0) * r.qty;
                        });
                     }
                     return a + (itemHPP * b.qty);
                }, 0);

                const serviceRate = storeProfile?.serviceRate || 0;
                const taxRate = storeProfile?.taxRate || 0;
                
                const taxableAmount = Math.max(0, subtotal - totalDiscount);
                
                const serviceCharge = (taxableAmount * serviceRate) / 100;
                const tax = ((taxableAmount + serviceCharge) * taxRate) / 100;
                const total = taxableAmount + serviceCharge + tax;
                
                return { 
                    subtotal, hppTotal, tax, serviceCharge, total, serviceRate, taxRate, 
                    discount: totalDiscount, // Total gabungan
                    promoDetails: appliedPromo ? { name: appliedPromo.name, amount: promoDiscount } : null 
                }; 
            };

            const checkIngredientsAvailability = () => {
                const requiredIngs = {};
                cart.forEach(item => {
                    if (item.recipe && item.recipe.length > 0) {
                        item.recipe.forEach(r => {
                            if (!requiredIngs[r.ingId]) requiredIngs[r.ingId] = 0;
                            requiredIngs[r.ingId] += (r.qty * item.qty);
                        });
                    }
                });
                for (const [id, needed] of Object.entries(requiredIngs)) {
                    const ing = ingredients.find(i => i.id === id);
                    if (!ing || ing.stock < needed) return `Stok Bahan Baku Kurang!`;
                }
                return null;
            };

            const handleCheckout = async () => {
                try {
                    if(!shift) { alert("Buka Shift dulu!"); return; }
                    if(cart.length === 0) return;
                    
                    const stockError = checkIngredientsAvailability();
                    if (stockError) { alert(stockError); return; }

                    if(paymentMethod === 'Hutang' && !selectedCustomer) { alert("Pilih Pelanggan!"); return; }
                    
                    const totals = calculateTotals();
                    const received = parseNumberInput(cashReceived);
                    
                    if (paymentMethod === 'Tunai' && received < totals.total) {
                        alert(`Uang kurang! Total: ${formatCurrency(totals.total)}`);
                        return;
                    }

                    setIsProcessing(true);
                    const profit = totals.total - totals.tax - totals.serviceCharge - totals.hppTotal;
                    
                    // [BARU] LOGIKA TIER & POIN
                    let pointsEarned = 0;
                    let newTier = selectedCustomer?.tier || 'Basic';
                    
                    if (selectedCustomer) {
                        const pointRate = storeProfile?.pointConversion || 10000;
                        const basePoints = Math.floor(totals.total / pointRate);
                        
                        // Multiplier berdasarkan Tier
                        let multiplier = 1;
                        if (selectedCustomer.tier === 'Platinum') multiplier = 2;
                        else if (selectedCustomer.tier === 'Gold') multiplier = 1.5;
                        else if (selectedCustomer.tier === 'Silver') multiplier = 1.2;
                        
                        pointsEarned = Math.floor(basePoints * multiplier);

                        // [BARU] Cek Naik Level (Dinamis dari Settings)
                        const currentSpending = (selectedCustomer.totalSpending || 0) + totals.total;
                        
                        // Ambil config dari storeProfile (atau default jika belum diset)
                        const tierLimit = {
                            silver: storeProfile?.tierSilver || 1000000,
                            gold: storeProfile?.tierGold || 5000000,
                            platinum: storeProfile?.tierPlatinum || 10000000
                        };

                        if (currentSpending >= tierLimit.platinum) newTier = 'Platinum';
                        else if (currentSpending >= tierLimit.gold) newTier = 'Gold';
                        else if (currentSpending >= tierLimit.silver) newTier = 'Silver';
                    }

                    const transData = {
                        items: cart, ...totals, profit, paymentMethod, orderType,
                        table: selectedTable ? selectedTable.name : null,
                        customerId: selectedCustomer ? selectedCustomer.id : null,
                        customerName: selectedCustomer ? selectedCustomer.name : 'Umum',
                        pointsEarned, 
                        customerPointsTotal: selectedCustomer ? (selectedCustomer.points || 0) + pointsEarned : 0,
                        cashReceived: paymentMethod === 'Tunai' ? received : totals.total,
                        cashierName: activeStaff.name, 
                        shiftId: shift.id, createdAt: serverTimestamp(), status: 'success'
                    };

                    const ref = await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'transactions'), transData);
                    // [BARU] Jika ini berasal dari pesanan dapur (Antrean), hapus dari list aktif karena sudah bayar
                    if (selectedOrderId) {
                        await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', selectedOrderId));
                        setSelectedOrderId(null);
                    }
					
                    if (paymentMethod === 'Hutang') {
                        await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'debts'), {
                            transactionId: ref.id, customerId: selectedCustomer.id, customerName: selectedCustomer.name,
                            amount: totals.total, paid: 0, status: 'unpaid', createdAt: serverTimestamp()
                        });
                    }

                    if(selectedCustomer) {
                        const custRef = doc(db, 'artifacts', APP_ID, 'users', storeId, 'customers', selectedCustomer.id);
                        await updateDoc(custRef, { 
                            points: increment(pointsEarned),
                            totalSpending: increment(totals.total), // Catat total belanja
                            tier: newTier // Update level member
                        });
                        if (newTier !== (selectedCustomer.tier || 'Basic')) {
                            alert(`Selamat! Pelanggan naik level menjadi ${newTier}!`);
                        }
                    }

                    const batchPromises = [];
                    const ingUpdates = {};
                    const prodUpdates = {};

                    cart.forEach(item => {
                        if (item.recipe && item.recipe.length > 0) {
                            item.recipe.forEach(r => {
                                if (!ingUpdates[r.ingId]) ingUpdates[r.ingId] = 0;
                                ingUpdates[r.ingId] += (r.qty * item.qty);
                            });
                        } else {
                            if (!prodUpdates[item.id]) prodUpdates[item.id] = 0;
                            prodUpdates[item.id] += item.qty;
                        }
                    });

                    for (const [id, qty] of Object.entries(ingUpdates)) {
                        const ing = ingredients.find(i => i.id === id);
                        if (ing) batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'ingredients', id), { stock: ing.stock - qty }));
                    }
                    for (const [id, qty] of Object.entries(prodUpdates)) {
                        const prod = products.find(p => p.id === id);
                        if (prod) {
                            batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', id), { stock: prod.stock - qty }));
                            batchPromises.push(addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'stock_history'), {
                                productId: id, productName: prod.name, change: -qty, type: 'sale', refId: ref.id, reason: 'Penjualan POS', createdAt: serverTimestamp()
                            }));
                        }
                    }

                    await Promise.all(batchPromises);

                    await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'shifts', shift.id), {
                        transactionsCount: (shift.transactionsCount || 0) + 1,
                        totalSales: (shift.totalSales || 0) + transData.total
                    });

                    setLastTrans({id: ref.id, ...transData, createdAt: new Date()});
                    setCart([]); setDiscount(0); setSelectedCustomer(null); setSelectedTable(null); setCashReceived('');

                    if(paymentMethod === 'QRIS') window.open("https://qris.id", "_blank");

                } catch (e) { 
                    console.error(e);
                    alert("Error: " + e.message); 
                } finally {
                    setIsProcessing(false);
                }
            };
			
			// [BARU] Fungsi Bayar Sebagian (Split Bill)
            const handleSplitCheckout = async () => {
                const selectedItems = cart.filter((_, idx) => splitSelection[idx]);
                if(selectedItems.length === 0) return alert("Pilih item yang mau dibayar!");
                
                if(!confirm(`Bayar ${selectedItems.length} item terpilih saja?`)) return;

                // 1. Simpan cart asli
                const originalCart = [...cart];
                
                // 2. Manipulasi cart sementara agar fungsi handleCheckout memproses item terpilih saja
                setCart(selectedItems);
                
                // 3. Jalankan checkout (tunggu sampai selesai)
                // Kita bungkus handleCheckout agar tidak mereset cart sepenuhnya
                // Karena handleCheckout didesain membersihkan cart, kita perlu trik sedikit
                // ATAU: Kita copy logika core checkout. Agar aman, kita gunakan logika manual disini:
                
                try {
                    // Hitung total khusus item terpilih
                    const subtotal = selectedItems.reduce((a,b) => a + (b.price * b.qty), 0);
                    const itemDiscounts = selectedItems.reduce((a,b) => a + (b.itemDiscount || 0), 0);
                    const taxableAmount = Math.max(0, (subtotal - itemDiscounts) - discount);
                    const serviceCharge = (taxableAmount * (storeProfile?.serviceRate||0)) / 100;
                    const tax = ((taxableAmount + serviceCharge) * (storeProfile?.taxRate||0)) / 100;
                    const total = taxableAmount + serviceCharge + tax;

                    // Buat Data Transaksi
                    const transData = {
                        items: selectedItems,
                        subtotal, tax, serviceCharge, total, discount,
                        profit: 0, // Disederhanakan untuk split
                        paymentMethod, orderType,
                        table: selectedTable ? selectedTable.name : null,
                        customerId: selectedCustomer ? selectedCustomer.id : null,
                        customerName: selectedCustomer ? selectedCustomer.name : 'Umum (Split)',
                        pointsEarned: 0,
                        cashReceived: total, // Asumsi pas/lunas untuk split
                        cashierName: activeStaff.name, 
                        shiftId: shift.id, createdAt: serverTimestamp(), status: 'success',
                        note: 'Split Bill'
                    };

                    const ref = await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'transactions'), transData);
                    
                    // Update Stok (Penting!)
                    const batchPromises = [];
                    selectedItems.forEach(item => {
                        // Logika potong stok sama seperti checkout biasa...
                        // Menggunakan item.originalId jika varian, atau item.id jika biasa
                        const realId = item.originalId || item.id;
                        const prod = products.find(p => p.id === realId);
                        if(prod && !prod.recipe) {
                             batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', realId), { stock: increment(-item.qty) }));
                        }
                    });
                    await Promise.all(batchPromises);

                    // Update Shift
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'shifts', shift.id), {
                        transactionsCount: increment(1),
                        totalSales: increment(total)
                    });

                    // 4. KEMBALIKAN SISA CART
                    const remainingItems = originalCart.filter((_, idx) => !splitSelection[idx]);
                    setCart(remainingItems);
                    setSplitSelection({});
                    setModalConfig({show: false});
                    setLastTrans({id: ref.id, ...transData, createdAt: new Date()});
                    
                    alert("Split Payment Berhasil!");

                } catch (e) {
                    alert("Gagal Split: " + e.message);
                    setCart(originalCart); // Restore jika gagal
                }
            };
			
			// [BARU] Fungsi Transfer Stok
            const handleSendTransfer = async () => {
                if(!targetStoreId || transferCart.length === 0) return alert("Data transfer belum lengkap!");
                if(!confirm(`Kirim ${transferCart.length} jenis produk ke Toko ID: ${targetStoreId}? Stok lokal akan berkurang.`)) return;
                
                setIsProcessing(true);
                try {
                    // 1. Kurangi Stok Lokal (Pengirim)
                    const batchPromises = transferCart.map(item => {
                         return updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', item.id), {
                             stock: increment(-item.qty)
                         });
                    });
                    
                    // 2. Buat Catatan Transfer di Database Global
                    // Kita simpan data produk lengkap agar toko penerima bisa bikin produk baru jika belum ada
                    batchPromises.push(addDoc(collection(db, 'artifacts', APP_ID, 'transfers'), {
                        fromId: storeId,
                        fromName: storeProfile?.name || 'Unknown',
                        toId: targetStoreId.trim(),
                        items: transferCart,
                        status: 'pending', // pending -> completed
                        note: 'Transfer Antar Cabang',
                        createdAt: serverTimestamp()
                    }));

                    await Promise.all(batchPromises);
                    
                    alert("Berhasil! Barang sedang dalam pengiriman.");
                    setTransferCart([]);
                    setTargetStoreId('');
                } catch(e) {
                    alert("Gagal kirim: " + e.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleAcceptTransfer = async (t) => {
                if(!confirm(`Terima barang dari ${t.fromName}? Stok akan ditambahkan ke gudang.`)) return;
                
                setIsProcessing(true);
                try {
                    const batchPromises = [];
                    
                    // 1. Tambah Stok Lokal (Penerima)
                    for (const item of t.items) {
                        // Cek apakah produk sudah ada (Cek Barcode dulu, lalu Nama)
                        const exist = products.find(p => (p.barcode && p.barcode === item.barcode) || p.name === item.name);
                        
                        if(exist) {
                             // Update produk ada
                             batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', exist.id), {
                                 stock: increment(item.qty)
                             }));
                        } else {
                             // Buat produk baru jika belum ada
                             const newProdData = {
                                 ...item,
                                 stock: item.qty,
                                 id: undefined // Hapus ID lama agar dibuatkan ID baru
                             };
                             delete newProdData.id; 
                             batchPromises.push(addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'products'), newProdData));
                        }
                    }

                    // 2. Update Status Transfer jadi Selesai
                    batchPromises.push(updateDoc(doc(db, 'artifacts', APP_ID, 'transfers', t.id), { 
                        status: 'completed', 
                        receivedAt: serverTimestamp() 
                    }));

                    await Promise.all(batchPromises);
                    alert("Stok berhasil diterima dan masuk gudang!");
                } catch(e) {
                    alert("Gagal terima: " + e.message);
                } finally {
                    setIsProcessing(false);
                }
            };
			
			// [BARU] Fungsi Pindah Meja (Move Table)
            const handleMoveTable = async (targetTable) => {
                if (!isMovingTable) return;
                
                try {
                    // Cek apakah meja target sudah terisi?
                    const isOccupied = activeOrders.some(o => o.table?.name === targetTable.name && o.status !== 'completed');
                    if (isOccupied) return alert("Meja tujuan sedang terisi! Silakan pilih meja kosong.");

                    if(!confirm(`Pindahkan pesanan ke ${targetTable.name}?`)) return;

                    // Update di Firebase
                    await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', isMovingTable.id), {
                        table: targetTable,
                        updatedAt: serverTimestamp()
                    });

                    alert("Berhasil pindah meja!");
                    setIsMovingTable(null); // Reset mode pindah
                    setModalConfig({show: false}); // Tutup modal
                } catch (e) {
                    alert("Gagal pindah: " + e.message);
                }
            };

            const handleOpenShift = async (e) => {
                e.preventDefault();
                await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'shifts'), {
                    startCash: Number(e.target.startCash.value),
                    startTime: serverTimestamp(),
                    status: 'open',
                    transactionsCount: 0,
                    totalSales: 0,
                    cashierName: activeStaff?.name || 'Unknown'
                });
            };

            const handleCloseShift = async (e) => {
                e.preventDefault();
                const endCash = Number(e.target.endCash.value);
                const cashSales = transactions.filter(t => t.paymentMethod === 'Tunai' && t.shiftId === shift.id).reduce((a,b) => a + (b.total || 0), 0);
                const totalExpenses = expenses.filter(ex => ex.date?.seconds >= shift.startTime?.seconds).reduce((a,b) => a + (b.amount || 0), 0);
                const expectedCash = (shift.startCash || 0) + cashSales - totalExpenses;
                const difference = endCash - expectedCash;

                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'shifts', shift.id), {
                    endCash, expectedCash, difference, cashSales, totalExpenses, status: 'closed', endTime: serverTimestamp()
                });
                setModalConfig({show: false});
                alert(`Shift Ditutup.`);
                setActiveStaff(null);
                setShift(null);
            };

            const handleDeleteTransaction = async (t) => {
                if(!confirm(`Hapus transaksi? Stok akan KEMBALI.`)) return;
                try {
                    const batchPromises = [];
                    t.items.forEach(item => {
                        if(item.recipe && item.recipe.length > 0) {
                            item.recipe.forEach(r => {
                                const ingRef = doc(db, 'artifacts', APP_ID, 'users', storeId, 'ingredients', r.ingId);
                                batchPromises.push(updateDoc(ingRef, { stock: increment(r.qty * item.qty) }));
                            });
                        } else {
                            const prodRef = doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', item.id);
                            batchPromises.push(updateDoc(prodRef, { stock: increment(item.qty) }));
                        }
                    });
                    batchPromises.push(deleteDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'transactions', t.id)));
                    const qDebt = query(collection(db, 'artifacts', APP_ID, 'users', storeId, 'debts'), where('transactionId', '==', t.id));
                    const debtSnap = await getDocs(qDebt);
                    debtSnap.forEach(d => batchPromises.push(deleteDoc(d.ref)));
                    
                    if(t.customerId && t.pointsEarned > 0) {
                        const custRef = doc(db, 'artifacts', APP_ID, 'users', storeId, 'customers', t.customerId);
                        batchPromises.push(updateDoc(custRef, { points: increment(-t.pointsEarned) }));
                    }

                    await Promise.all(batchPromises);
                    alert("Transaksi dihapus.");
                } catch(e) { alert("Gagal: " + e.message); }
            };

            const toggleStaffStatus = async (staffId, currentStatus) => {
                if(!confirm(`Ubah status staff ini?`)) return;
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'staff', staffId), {
                    isActive: !currentStatus
                });
            };

            const handlePaymentSubmit = async (e) => {
                e.preventDefault();
                const amount = Number(e.target.amount.value);
                const debt = modalConfig.data;
                const newPaid = (debt.paid || 0) + amount;
                const status = newPaid >= debt.amount ? 'paid' : 'partial';
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'debts', debt.id), {
                    paid: newPaid, status: status, lastPayment: serverTimestamp()
                });
                setModalConfig({show:false});
            };

            const handleAdjustStock = async (e) => { 
                e.preventDefault();
                const f = e.target;
                const qty = Number(f.qty.value);
                const type = f.type.value;
                const change = type === 'in' ? qty : -qty;
                const prod = modalConfig.data;
                await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'products', prod.id), { stock: prod.stock + change });
                await addDoc(collection(db, 'artifacts', APP_ID, 'users', storeId, 'stock_history'), {
                    productId: prod.id, productName: prod.name, change: change, type: 'adjustment', reason: f.reason.value, createdAt: serverTimestamp()
                });
                setModalConfig({show: false});
            };

            const saveSettings = async (e) => {
                e.preventDefault();
                const f = e.target;
                await setDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'settings', 'profile'), {
                    name: f.name.value, address: f.address.value, phone: f.phone.value, logo: f.logo.value,
                    footerMessage: f.footerMessage.value, 
                    taxRate: Number(f.taxRate.value), serviceRate: Number(f.serviceRate.value),
                    paperSize: f.paperSize.value,
                    pointConversion: Number(f.pointConversion.value)
                });
                setModalConfig({ show: false });
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                const f = e.target;
                const type = modalConfig.type;
                const collPath = ['artifacts', APP_ID, 'users', storeId];
                let collectionName = type + 's';
                if (type === 'staff') collectionName = 'staff';
                if (type === 'ingredient') collectionName = 'ingredients';
                let payload = {};

                try {
                    if (type === 'product') {
                        // [BARU] Parsing Varian
                        let variants = [];
                        const vStr = f.variants_str.value;
                        if(vStr) {
                            variants = vStr.split(',').map(s => {
                                const [vName, vPrice] = s.split(':');
                                return { name: vName.trim(), price: Number(vPrice) || 0 };
                            }).filter(v => v.name);
                        }
						let modifiers = [];
                        const mStr = f.modifiers_str.value;
                        if(mStr) {
                            modifiers = mStr.split(',').map(s => {
                                const [mName, mPrice] = s.split(':');
                                return { name: mName.trim(), price: Number(mPrice) || 0 };
                            }).filter(m => m.name);
                        }
                        payload = { 
                            name: f.name.value, barcode: f.barcode.value, category: f.category.value, 
                            variants: variants,
                            modifiers: modifiers, // Simpan ke DB
                            price: Number(f.price.value), hpp: Number(f.hpp.value), stock: Number(f.stock.value), image: f.image.value,
                            wholesaleQty: Number(f.wholesaleQty.value), wholesalePrice: Number(f.wholesalePrice.value)
                        };
                    } else if (type === 'ingredient') {
                         payload = { name: f.name.value, unit: f.unit.value, stock: Number(f.stock.value), costPerUnit: Number(f.costPerUnit.value) };
                    } else if (type === 'recipe_setup') {
                         const currentRecipe = modalConfig.data.recipe || [];
                         const newRecipe = [...currentRecipe, {ingId: f.ingId.value, qty: Number(f.qty.value)}];
                         await updateDoc(doc(db, ...collPath, 'products', modalConfig.data.id), { recipe: newRecipe });
                         setModalConfig({ show: false }); return;
                    } else if (type === 'customer') {
                        const timestamp = Date.now().toString().slice(-6);
                        payload = { 
                            name: f.name.value, phone: f.phone.value, email: f.email.value, 
                            nik: f.nik.value, memberCode: `MBR-${timestamp}` 
                        };
                    } else if (type === 'supplier') {
                        payload = { name: f.name.value, phone: f.phone.value, address: f.address.value };
                    } else if (type === 'table') {
                        payload = { name: f.name.value, capacity: f.capacity.value };
					} else if (type === 'promo') {
                        payload = { 
                            name: f.name.value, 
                            type: f.type.value, 
                            value: Number(f.value.value), 
                            minSpend: Number(f.minSpend.value),
                            maxDiscount: Number(f.maxDiscount.value) || 0,
                            isActive: true 
                        };
              
                    } else if (type === 'staff') {
                        // [FIXED] FORM STAFF: HAPUS PIN, ADA NAMA
                        let inputPhone = f.phone.value.trim();
                        if(inputPhone.startsWith('0')) inputPhone = '+62' + inputPhone.slice(1);

                        payload = { 
                            name: f.name.value, 
                            email: f.email.value.trim().toLowerCase(), 
                            phone: inputPhone, // Simpan No HP
                            role: f.role.value,
                            shiftStart: f.shiftStart.value,
                            shiftEnd: f.shiftEnd.value,
                        };
                        if(!modalConfig.data?.id) payload.isActive = true;
                    } else if (type === 'expense') {
                        payload = { name: f.name.value, amount: Number(f.amount.value), category: f.category.value, date: serverTimestamp() };
                    }

                    if (modalConfig.data?.id) await updateDoc(doc(db, ...collPath, collectionName, modalConfig.data.id), { ...payload, updatedAt: serverTimestamp() });
                    else {
                        const ref = await addDoc(collection(db, ...collPath, collectionName), { ...payload, createdAt: serverTimestamp() });
                        if(type === 'customer') {
                            setModalConfig({show: false});
                            setTimeout(() => setModalConfig({show: true, type: 'show_member_card', data: {...payload, id: ref.id}}), 500);
                            return;
                        }
                    }
                    
                    setModalConfig({ show: false });
                } catch (err) { alert("GAGAL SIMPAN: " + err.message); }
            };

            if (loading) return <div className="h-screen flex items-center justify-center text-blue-600 font-bold">Loading Kasir Pro...</div>;
            if (!user) return <LoginScreen />;
            
            // [UPDATE] LAYAR PILIH STORE (Hanya jika Store ID belum ada)
            if (user && !storeId) {
                return (
                    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4 font-sans">
                        <div className="bg-white w-full max-w-md rounded-2xl p-8 shadow-2xl text-center">
                            <h2 className="text-2xl font-bold mb-2">Halo, {user.displayName || 'User'}!</h2>
                            <p className="text-gray-500 mb-6 text-sm">Pilih akses masuk toko:</p>
                            
                            <div className="space-y-3">
                                <button onClick={() => {
                                    localStorage.setItem('kp_store_id', user.uid);
                                    setStoreId(user.uid);
                                }} className="w-full p-4 border-2 border-blue-100 rounded-xl hover:bg-blue-50 transition flex items-center gap-4 text-left">
                                    <div className="bg-blue-100 p-3 rounded-full text-blue-600"><Icon name="store" size={24}/></div>
                                    <div>
                                        <div className="font-bold text-blue-900">Saya Owner (Pemilik)</div>
                                        <div className="text-xs text-gray-500">Masuk ke toko saya sendiri</div>
                                    </div>
                                </button>

                                <div className="relative flex py-2 items-center">
                                    <div className="flex-grow border-t border-gray-200"></div>
                                    <span className="flex-shrink-0 mx-4 text-gray-400 text-xs">ATAU</span>
                                    <div className="flex-grow border-t border-gray-200"></div>
                                </div>

                                <button onClick={() => {
                                    const id = prompt("Masukkan ID Toko Owner:");
                                    if(id) {
                                        localStorage.setItem('kp_store_id', id);
                                        setStoreId(id);
                                    }
                                }} className="w-full p-4 border-2 border-orange-100 rounded-xl hover:bg-orange-50 transition flex items-center gap-4 text-left">
                                    <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Icon name="users" size={24}/></div>
                                    <div>
                                        <div className="font-bold text-orange-900">Saya Staff / Waiter</div>
                                        <div className="text-xs text-gray-500">Masuk ke toko orang lain</div>
                                    </div>
                                </button>
                            </div>
                            <div className="mt-6">
                                <button onClick={()=>signOut(auth)} className="text-xs text-red-500 hover:underline">Ganti Akun Google</button>
                            </div>
                        </div>
                    </div>
                );
            }
            
            if (user && storeId && !activeStaff) {
                 return (
                    <div className="h-screen bg-gray-50 flex items-center justify-center p-8 text-center flex-col">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full">
                            <div className="text-red-500 mb-4 mx-auto w-16 h-16 bg-red-100 rounded-full flex items-center justify-center"><Icon name="alert-triangle" size={32}/></div>
                            <h2 className="text-xl font-bold mb-2">Akses Ditolak / Belum Terdaftar</h2>
                            <p className="text-gray-500 text-sm mb-6">
                                Email <b>{user.email}</b> belum terdaftar sebagai Staff di toko ini, atau status akun sedang dinonaktifkan.
                            </p>
                            <p className="text-xs text-gray-400 mb-6">ID Toko: {storeId}</p>
                            <div className="space-y-3">
                                <button onClick={()=>{ localStorage.removeItem('kp_store_id'); setStoreId(null); }} className="w-full bg-blue-600 text-white py-3 rounded-lg font-bold">Ganti Toko / ID</button>
                                <button onClick={()=>signOut(auth)} className="w-full border py-3 rounded-lg font-bold text-gray-600">Ganti Akun Google</button>
                            </div>
                        </div>
                    </div>
                 );
            }

            if (user && !shift && (activeStaff?.role === 'kasir' || activeStaff?.role === 'admin') && view === 'pos') {
                return (
                    <Modal title="Buka Toko / Shift Baru" onClose={()=>{}}>
                        <form onSubmit={handleOpenShift}>
                            <div className="bg-blue-50 p-4 rounded-lg mb-4 text-sm text-blue-800">
                                Selamat Datang, <b>{activeStaff.name}</b>!<br/>Silakan masukkan uang modal di laci kasir sebelum mulai berjualan.
                            </div>
                            <input name="startCash" type="number" placeholder="Nominal Modal Awal (Rp)" required className="w-full p-3 border rounded-lg mb-4 text-lg font-bold"/>
                            <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Buka Toko</button>
                        </form>
                    </Modal>
                );
            }

            return (
                <div className="flex h-screen bg-gray-100 overflow-hidden text-slate-800">
                    <aside className="w-20 md:w-64 bg-slate-900 text-slate-300 flex flex-col flex-shrink-0 z-20 overflow-y-auto">
                        <div className="h-16 flex items-center justify-center md:justify-start md:px-6 bg-slate-950 text-white font-bold gap-3 flex-shrink-0 sticky top-0 z-10">
                            <div className="bg-blue-600 p-2 rounded-lg"><Icon name="zap" size={20}/></div>
                            <span className="hidden md:block">Kasir Pro v10.7.1.3</span>
                        </div>
                        <nav className="flex-1 py-4 space-y-1 px-2">
                            <div className="px-3 mb-6 flex items-center gap-3 pb-4 border-b border-slate-800">
                                <div className="w-8 h-8 rounded-full bg-blue-600 flex items-center justify-center font-bold text-white">{activeStaff?.name[0]}</div>
                                <div className="hidden md:block">
                                    <div className="text-sm font-bold text-white">{activeStaff?.name}</div>
                                    <div className="text-xs text-slate-500 uppercase">{activeStaff?.role}</div>
                                </div>
                                <button onClick={()=>{
                                    if(confirm('Keluar akun dan ganti toko?')) {
                                        localStorage.removeItem('kp_store_id');
                                        setStoreId(null);
                                        signOut(auth);
                                    }
                                }} className="ml-auto text-slate-500 hover:text-white" title="Keluar / Ganti Akun"><Icon name="log-out" size={16}/></button>
                            </div>

                            <div className="text-xs font-bold text-slate-500 px-3 mb-2 uppercase hidden md:block">Utama</div>
                            
                            {[
                                {id: 'pos', icon: 'monitor', label: 'Kasir / POS', roles: ['admin', 'kasir', 'waiter']},
                                {id: 'kitchen', icon: 'chef-hat', label: 'Layar Dapur', roles: ['admin', 'dapur', 'waiter']}, // MENU BARU
                                {id: 'dashboard', icon: 'layout-dashboard', label: 'Dashboard', roles: ['admin']},
                                {id: 'history', icon: 'history', label: 'Riwayat Transaksi', roles: ['admin', 'kasir']},
                                {id: 'expenses', icon: 'wallet', label: 'Pengeluaran', roles: ['admin', 'kasir']},
                                {id: 'debts', icon: 'book', label: 'Hutang / Kasbon', roles: ['admin', 'kasir']},
                                {id: 'customers', icon: 'users', label: 'Pelanggan', roles: ['admin', 'kasir']},
								{id: 'promos', icon: 'ticket', label: 'Voucher & Promo', roles: ['admin']},
								{id: 'transfer', icon: 'arrow-right-left', label: 'Transfer Stok', roles: ['admin', 'gudang']},
							].filter(m => m.roles.includes(activeStaff?.role)).map(m => (
                                <button key={m.id} onClick={() => setView(m.id)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m.id ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'}`}>
                                    <Icon name={m.icon} /> <span className="hidden md:block font-medium">{m.label}</span>
                                </button>
                            ))}
                            
                            {(activeStaff?.role === 'admin' || activeStaff?.role === 'gudang') && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Gudang & Data</div>
                                {['inventory', 'ingredients'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name={m==='inventory'?'clipboard-list':'flask-conical'} size={18} /> <span className="hidden md:block font-medium">{m==='inventory'?'Stok Opname':'Bahan Baku'}</span>
                                    </button>
                                ))}
                                {['products', 'staff', 'tables', 'suppliers'].map(m => (
                                    <button key={m} onClick={() => setView(m)} className={`w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl transition ${view===m ? 'bg-blue-600 text-white' : 'hover:bg-slate-800'} capitalize`}>
                                        <Icon name="database" size={18} /> <span className="hidden md:block font-medium">{m}</span>
                                    </button>
                                ))}
                            </>}
                            
                            {activeStaff?.role === 'admin' && <>
                                <div className="text-xs font-bold text-slate-500 px-3 mt-4 mb-2 uppercase hidden md:block">Sistem</div>
                                <button onClick={() => {setSettingsTab('profile'); setModalConfig({show:true, type:'settings'})}} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl hover:bg-slate-800">
                                    <Icon name="settings" /> <span className="hidden md:block font-medium">Pengaturan</span>
                                </button>
                            </>}
                        </nav>
                        
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={()=>setModalConfig({show:true, type:'close_shift'})} className="w-full flex items-center justify-center md:justify-start gap-3 p-3 rounded-xl bg-red-900/30 text-red-400 hover:bg-red-900/50 transition">
                                <Icon name="power" /> <span className="hidden md:block">Tutup Toko</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col overflow-hidden relative w-full">
                        {/* ... (View POS, Dashboard, dll - SAMA SEPERTI SEBELUMNYA) ... */}
                        {/* ... AGAR MUAT, SAYA TIDAK TULIS ULANG KODE BAGIAN UTAMA (POS/DASHBOARD/HISTORY/EXPENSE/DEBTS/INGREDIENTS) KARENA TIDAK BERUBAH ... */}
                        {/* ... PASTIKAN BAGIAN UTAMA ITU TETAP ADA (COPY DARI V9.6) ... */}
                        
                        {view === 'pos' && (
                           <div className="flex h-full flex-col md:flex-row">
                                {/* BAGIAN KIRI: DAFTAR PRODUK (TIDAK BERUBAH) */}
                                <div className="flex-1 bg-gray-50 flex flex-col min-w-0 h-full overflow-hidden">
                                    <div className="p-4 bg-white border-b flex flex-col gap-3">
                                        {scannerContext === 'pos' ? (
                                            <BarcodeScanner onScan={handleScanResult} onClose={()=>setScannerContext(null)} isInline={true} />
                                        ) : (
                                            <div className="flex gap-3 items-center">
                                                <div className="relative flex-1">
                                                    <Icon name="search" className="absolute left-3 top-3 text-gray-400"/>
                                                    <input className="w-full pl-10 p-2.5 rounded-lg border bg-gray-50 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="Cari produk..." value={searchQuery} onChange={e=>setSearchQuery(e.target.value)} autoFocus/>
                                                </div>
                                                <button onClick={()=>setScannerContext('pos')} className="p-2.5 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 flex items-center gap-2 font-bold" title="Scan Kamera">
                                                    <Icon name="camera" size={20}/>
                                                </button>
                                            </div>
                                        )}
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 content-start">
                                        {products.filter(p => p.name.toLowerCase().includes(searchQuery.toLowerCase()) || (p.barcode && p.barcode.includes(searchQuery))).sort((a,b) => {
                                            const stockA = (a.recipe && a.recipe.length > 0) ? 999 : a.stock;
                                            const stockB = (b.recipe && b.recipe.length > 0) ? 999 : b.stock;
                                            if (stockA > 0 && stockB <= 0) return -1;
                                            if (stockA <= 0 && stockB > 0) return 1;
                                            return 0;
                                        }).map(p => {
                                            const hasRecipe = p.recipe && p.recipe.length > 0;
                                            return (
                                                <div key={p.id} onClick={() => addToCart(p)} className={`relative bg-white rounded-xl shadow-sm border p-3 cursor-pointer hover:shadow-md transition ${!hasRecipe && p.stock<=0 && 'opacity-50'} ${!hasRecipe && p.stock<=5 && p.stock > 0 ? 'border-red-300 bg-red-50' : ''}`}>
                                                    {!hasRecipe && p.stock <= 5 && p.stock > 0 && <div className="absolute top-2 right-2 bg-red-600 text-white text-[10px] px-2 py-0.5 rounded-full z-10 animate-pulse">Menipis</div>}
                                                    <div className="h-24 bg-gray-100 rounded-lg mb-2 overflow-hidden">
                                                        {p.image ? <img src={p.image} className="w-full h-full object-cover"/> : <div className="w-full h-full flex items-center justify-center text-gray-300"><Icon name="image" size={32}/></div>}
                                                    </div>
                                                    <h4 className="font-bold truncate text-sm">{p.name}</h4>
                                                    <div className="flex justify-between mt-1 items-center">
                                                        <span className="text-blue-600 font-bold text-xs">{formatCurrency(p.price)}</span>
                                                        <span className={`text-[10px] px-1.5 py-0.5 rounded font-bold ${hasRecipe ? 'bg-purple-100 text-purple-700' : (p.stock<=5 ? 'bg-red-200 text-red-800' : 'bg-gray-100')}`}>
                                                            {hasRecipe ? 'F&B' : p.stock}
                                                        </span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* BAGIAN KANAN: KERANJANG (LAYOUT BARU) */}
                                <div className="w-full md:w-96 bg-white shadow-2xl z-20 flex flex-col border-l flex-shrink-0 h-auto md:h-full">
                                    
                                    {/* [UBAH] INPUT INFORMASI ORDER (1 BARIS) */}
                                    <div className="p-3 border-b bg-white flex gap-2">
                                        <select className="w-24 p-2 border rounded bg-gray-50 text-xs font-bold" value={orderType} onChange={e=>setOrderType(e.target.value)}>
                                            <option>Dine In</option>
                                            <option>Take Away</option>
                                        </select>
                                        
                                        {orderType === 'Dine In' && (
                                            <button onClick={()=>{setIsMovingTable(null); setModalConfig({show:true, type:'table_map'})}} className={`px-3 py-2 border rounded text-xs font-bold flex items-center gap-1 ${selectedTable ? 'bg-yellow-100 text-yellow-700 border-yellow-300' : 'bg-gray-50 text-gray-600'}`}>
                                                <Icon name="layout-grid" size={14}/>
                                                {selectedTable ? selectedTable.name : 'Pilih Meja'}
                                            </button>
                                        )}

                                        <select className="flex-1 p-2 border rounded bg-gray-50 text-xs truncate" value={selectedCustomer?.id||''} onChange={e=>setSelectedCustomer(customers.find(c=>c.id===e.target.value)||null)}>
                                            <option value="">Pelanggan Umum</option>
                                            {customers.map(c=><option key={c.id} value={c.id}>{c.name}</option>)}
                                        </select>
                                    </div>

                                    {/* INFO POIN MEMBER (JIKA ADA) */}
                                    {selectedCustomer && (
                                        <div className="px-3 py-2 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-800 text-[10px] flex justify-between items-center border-b border-blue-100">
                                            <div className="flex items-center gap-2">
                                                <span className={`font-bold px-1.5 py-0.5 rounded text-white ${
                                                    selectedCustomer.tier === 'Platinum' ? 'bg-slate-800' :
                                                    selectedCustomer.tier === 'Gold' ? 'bg-yellow-500' :
                                                    selectedCustomer.tier === 'Silver' ? 'bg-gray-400' : 'bg-blue-400'
                                                }`}>
                                                    {selectedCustomer.tier || 'Basic'}
                                                </span>
                                                <span>Poin: <b>{selectedCustomer.points || 0}</b></span>
                                            </div>
                                            {/* Hitung estimasi poin dengan multiplier tier */}
                                            <span>
                                                Est: +{(() => {
                                                    const base = Math.floor(calculateTotals().total / (storeProfile?.pointConversion || 10000));
                                                    const mult = selectedCustomer.tier==='Platinum'?2 : selectedCustomer.tier==='Gold'?1.5 : selectedCustomer.tier==='Silver'?1.2 : 1;
                                                    return Math.floor(base * mult);
                                                })()}
                                            </span>
                                        </div>
                                    )}

                                    {/* LIST ITEM KERANJANG */}
                                    <div className="flex-1 overflow-y-auto p-3 space-y-2 max-h-[300px] md:max-h-full bg-slate-50">
                                        {cart.length === 0 && <div className="text-center text-gray-400 text-xs mt-10 italic">Keranjang Kosong</div>}
                                        {cart.map(i => (
                                            <div key={i.id} onClick={()=>{setEditingItem({...i}); setModalConfig({show:true, type:'edit_cart_item'})}} className="flex justify-between items-center bg-white p-2 rounded shadow-sm border cursor-pointer hover:bg-blue-50">
                                                <div className="flex-1">
                                                    <div className="font-bold text-sm text-gray-800">{i.name}</div>
                                                    <div className="text-[10px] text-gray-500">
                                                        {formatCurrency(i.price)} x {i.qty} 
                                                        {i.wholesaleQty && i.qty >= i.wholesaleQty && <span className="text-green-600 font-bold ml-1">(Grosir)</span>}
                                                    </div>
                                                    {i.note && <div className="text-[10px] text-red-500 italic">"{i.note}"</div>}
                                                </div>
                                                <div className="flex items-center gap-2 mr-2" onClick={e=>e.stopPropagation()}>
                                                    <button onClick={()=>updateCartQty(i, -1)} className="w-6 h-6 bg-gray-100 border rounded text-sm hover:bg-gray-200 text-gray-600 font-bold">-</button>
                                                    <span className="font-bold text-sm w-4 text-center">{i.qty}</span>
                                                    <button onClick={()=>updateCartQty(i, 1)} className="w-6 h-6 bg-gray-100 border rounded text-sm hover:bg-gray-200 text-gray-600 font-bold">+</button>
                                                </div>
                                                <div className="font-bold text-sm">{formatCurrency((i.price*i.qty)- (i.itemDiscount||0))}</div>
                                            </div>
                                        ))}
                                    </div>

                                    {/* PANEL PEMBAYARAN BAWAH */}
                                    <div className="p-3 bg-white border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-30">
                                        {/* INPUT DISKON */}
                                        {/* PILIH PROMO & DISKON */}
                                            <div className="flex gap-2 mb-2">
                                                <div className="flex-1 relative">
                                                    <select className={`w-full p-2 border rounded text-xs appearance-none font-bold ${appliedPromo ? 'bg-purple-100 text-purple-700 border-purple-300' : 'bg-gray-50 text-gray-600'}`} 
                                                        value={appliedPromo ? appliedPromo.id : ''} 
                                                        onChange={(e) => {
                                                            const p = promos.find(pr => pr.id === e.target.value);
                                                            setAppliedPromo(p || null);
                                                        }}
                                                    >
                                                        <option value="">-- Pilih Promo / Voucher --</option>
                                                        {promos.filter(p => p.isActive).map(p => (
                                                            <option key={p.id} value={p.id}>
                                                                {p.name} ({p.type==='percent'?`${p.value}%`:formatCurrency(p.value)})
                                                            </option>
                                                        ))}
                                                    </select>
                                                    <Icon name="ticket" size={14} className="absolute right-2 top-2.5 text-gray-400 pointer-events-none"/>
                                                </div>
                                                {/* Input Diskon Manual Tetap Ada (Opsional) */}
                                                <input type="number" placeholder="Manual (Rp)" className="w-24 p-2 border rounded text-xs bg-gray-50" value={discount > 0 ? discount : ''} onChange={e=>setDiscount(Number(e.target.value))} />
                                            </div>

                                        {/* TOTAL HARGA */}
                                        <div className="space-y-1 text-xs pb-2 border-b border-dashed mb-2">
                                            <div className="flex justify-between text-gray-500"><span>Subtotal</span><span>{formatCurrency(calculateTotals().subtotal)}</span></div>
                                            {calculateTotals().tax > 0 && <div className="flex justify-between text-gray-500"><span>Pajak ({calculateTotals().taxRate}%)</span><span>{formatCurrency(calculateTotals().tax)}</span></div>}
                                            {calculateTotals().serviceCharge > 0 && <div className="flex justify-between text-gray-500"><span>Service ({calculateTotals().serviceRate}%)</span><span>{formatCurrency(calculateTotals().serviceCharge)}</span></div>}
                                            <div className="flex justify-between font-bold text-lg pt-1 text-slate-800"><span>Total</span><span>{formatCurrency(calculateTotals().total)}</span></div>
                                        </div>
                                        
                                        {/* INPUT TUNAI & KEMBALIAN (Hanya jika Tunai) */}
                                        {paymentMethod === 'Tunai' && (
                                            <div className="bg-blue-50 p-2 rounded-lg border border-blue-100 flex flex-col gap-1 mb-2">
                                                <div className="flex items-center">
                                                    <span className="text-xs font-bold w-16 text-blue-800">Diterima:</span>
                                                    <input 
                                                        type="tel" inputMode="numeric" 
                                                        value={formatNumberInput(cashReceived)} 
                                                        onChange={e => setCashReceived(e.target.value.replace(/\./g, ''))} 
                                                        className="flex-1 p-1 text-right text-sm border border-blue-200 rounded font-bold text-blue-600 focus:ring-2 focus:ring-blue-400 outline-none" 
                                                        placeholder="0"
                                                    />
                                                </div>
                                                <div className="flex justify-between items-center text-sm font-bold px-1">
                                                    <span className="text-xs text-blue-800">Kembali:</span>
                                                    <span className={parseNumberInput(cashReceived) < calculateTotals().total ? "text-red-500" : "text-green-600"}>
                                                        {formatCurrency(Math.max(0, parseNumberInput(cashReceived) - calculateTotals().total))}
                                                    </span>
                                                </div>
                                            </div>
                                        )}

                                        {/* [UBAH] METODE PEMBAYARAN (1 BARIS) */}
                                        <div className="flex gap-2 mb-3">
                                            <button onClick={()=>{setPaymentMethod('Tunai'); setCashReceived('');}} className={`flex-1 py-2 rounded-lg border text-xs font-bold transition ${paymentMethod==='Tunai' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white hover:bg-gray-50'}`}>Tunai</button>
                                            <button onClick={()=>{setPaymentMethod('QRIS'); setCashReceived('');}} className={`flex-1 py-2 rounded-lg border text-xs font-bold transition ${paymentMethod==='QRIS' ? 'bg-slate-800 text-white border-slate-800' : 'bg-white hover:bg-gray-50'}`}>QRIS</button>
                                            <button onClick={()=>{setPaymentMethod('Hutang'); setCashReceived('');}} className={`w-16 py-2 rounded-lg border text-[10px] font-bold transition ${paymentMethod==='Hutang' ? 'bg-red-100 text-red-700 border-red-200' : 'bg-white text-gray-500 hover:bg-gray-50'}`}>Hutang</button>
                                        </div>

                                        {/* [UBAH] TOMBOL AKSI UTAMA (ANTREAN, TUNDA, BAYAR) */}
                                        {/* [UBAH] TOMBOL AKSI UTAMA (ANTREAN, TUNDA, SPLIT, BAYAR) */}
                                    <div className="flex gap-2 h-12">
                                        {/* 1. Tombol Antrean (Logo) */}
                                        <button onClick={()=>setModalConfig({show: true, type: 'hold_list'})} className="w-12 h-full bg-orange-100 text-orange-600 rounded-xl flex items-center justify-center relative hover:bg-orange-200 transition border border-orange-200" title="Daftar Antrean">
                                            <Icon name="list" size={24}/>
                                            {activeOrders.length > 0 && <span className="absolute -top-1 -right-1 bg-red-600 text-white text-[10px] w-5 h-5 rounded-full flex items-center justify-center font-bold border-2 border-white">{activeOrders.length}</span>}
                                        </button>

                                        {/* 2. Tombol Tunda (Logo) */}
                                        <button onClick={holdTransaction} className="w-12 h-full bg-gray-100 text-gray-600 rounded-xl flex items-center justify-center hover:bg-gray-200 transition border border-gray-200" title="Tunda Transaksi">
                                            <Icon name="clock" size={24}/>
                                        </button>

                                        {/* 3. [KEMBALIKAN] Tombol Split Bill (Logo) */}
                                        <button onClick={()=>{
                                            if(cart.length === 0) return alert("Keranjang kosong");
                                            setSplitSelection({}); 
                                            setModalConfig({show: true, type: 'split_bill'});
                                        }} className="w-12 h-full bg-purple-100 text-purple-600 rounded-xl flex items-center justify-center hover:bg-purple-200 transition border border-purple-200" title="Split Bill">
                                            <Icon name="scissors" size={24}/>
                                        </button>

                                        {/* 4. Tombol Bayar / Kirim ke Dapur (Versi Anti-Crash) */}
                                        <button 
                                            onClick={activeStaff?.role === 'waiter' ? handleOrderToKitchen : handleCheckout} 
                                            disabled={!cart.length || isProcessing} 
                                            className={`flex-1 text-white rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 transition disabled:bg-gray-300 disabled:shadow-none ${activeStaff?.role === 'waiter' ? 'bg-orange-500 hover:bg-orange-600' : 'bg-blue-600 hover:bg-blue-700'}`}
                                        >
                                            {isProcessing ? (
                                                <span className="animate-pulse">Memproses...</span> 
                                            ) : (
                                                activeStaff?.role === 'waiter' ? (
                                                    <span>Ke Dapur</span> 
                                                ) : (
                                                    'Bayar'
                                                )
                                            )}
                                        </button>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        )}
						
						{view === 'kitchen' && (
                            <div className="p-4 h-full overflow-y-auto bg-gray-100">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold flex items-center gap-3">
                                        <Icon name="chef-hat" className="text-orange-600"/> 
                                        Daftar Pesanan Dapur
                                    </h2>
                                    <div className="bg-white px-4 py-2 rounded-lg shadow font-bold text-blue-600">
                                        {activeOrders.length} Pesanan Aktif
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                    {activeOrders.length === 0 && (
                                        <div className="col-span-full h-64 flex flex-col items-center justify-center text-gray-400">
                                            <Icon name="coffee" size={48} className="mb-2"/>
                                            <p>Tidak ada pesanan masuk.</p>
                                        </div>
                                    )}
                                    
                                    {activeOrders.map(order => (
                                        <div key={order.id} className="bg-white rounded-xl shadow-md border-l-4 border-l-orange-500 overflow-hidden flex flex-col animate-fade-in">
                                            <div className="p-3 bg-orange-50 border-b flex justify-between items-start">
                                                <div>
                                                    <h3 className="font-bold text-lg">{order.table ? order.table.name : `${order.orderType} #${order.id.slice(-4)}`}</h3>
                                                    <p className="text-xs text-gray-500">{order.cust ? order.cust.name : 'Pelanggan Umum'}</p>
                                                </div>
                                                <div className="text-right">
                                                    <span className="text-xs font-bold bg-white px-2 py-1 rounded border shadow-sm">{formatDate(order.createdAt).split(' ')[1]}</span>
                                                    <div className="text-[10px] text-gray-400 mt-1">{order.waiter}</div>
                                                </div>
                                            </div>
                                            <div className="p-4 flex-1 overflow-y-auto max-h-64">
                                                <ul className="space-y-3">
                                                    {order.cart.map((item, idx) => (
                                                        <li key={idx} className="flex justify-between items-start border-b border-dashed pb-2 last:border-0">
                                                            <div className="flex gap-3">
                                                                <div className="font-bold text-lg w-6 h-6 flex items-center justify-center bg-gray-100 rounded">{item.qty}</div>
                                                                <div>
                                                                    <div className="font-bold text-gray-800">{item.name}</div>
                                                                    {item.note && <div className="text-xs text-red-500 italic bg-red-50 px-1 rounded mt-1">Catatan: {item.note}</div>}
                                                                </div>
                                                            </div>
                                                        </li>
                                                    ))}
                                                </ul>
                                            </div>
                                            <div className="p-3 bg-gray-50 border-t grid grid-cols-2 gap-2">
                                                 {/* Tombol Print Struk Dapur (Opsional) */}
                                                <button onClick={()=>{
                                                    const content = `DAPUR: ${order.table?.name||order.orderType}\nItems:\n${order.cart.map(i=>`${i.qty}x ${i.name} ${i.note?`(${i.note})`:''}`).join('\n')}`;
                                                    alert("Simulasi Print ke Printer Dapur:\n\n" + content);
                                                }} className="bg-white border text-gray-600 py-2 rounded-lg font-bold text-sm hover:bg-gray-100">
                                                    Print
                                                </button>
                                                <button onClick={async ()=>{
                                                    if(confirm("Pesanan selesai dimasak?")) {
                                                        // Opsi A: Hapus langsung (Simple)
                                                        // await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', order.id));
                                                        
                                                        // Opsi B: Ubah status jadi 'ready' (Agar kasir tahu)
                                                        await updateDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', order.id), { status: 'ready' });
                                                    }
                                                }} className={`text-white py-2 rounded-lg font-bold text-sm ${order.status==='ready'?'bg-green-600':'bg-orange-600 hover:bg-orange-700'}`}>
                                                    {order.status==='ready' ? 'Siap Saji' : 'Selesai Masak'}
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
						
						{view === 'inventory' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-4">Stok Opname (Produk Jadi)</h2>
                                <div className="bg-white p-4 rounded-xl border">
                                    <div className="flex justify-between text-sm font-bold text-gray-500 mb-2 border-b pb-2">
                                        <span>Nama Produk</span>
                                        <span>Stok Saat Ini</span>
                                    </div>
                                    {products.map(p => (
                                        <div key={p.id} className="flex justify-between items-center border-b last:border-0 p-3 hover:bg-gray-50">
                                            <div>
                                                <div className="font-bold">{p.name}</div>
                                                <div className="text-xs text-gray-400">{p.category}</div>
                                            </div>
                                            <div className="flex items-center gap-4">
                                                <span className="font-bold text-lg">{p.stock}</span>
                                                <button onClick={()=>setModalConfig({show:true, type:'stock_adj', data:p})} className="text-blue-600 text-xs border border-blue-600 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition">
                                                    Sesuaikan
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                    {products.length === 0 && <p className="text-center text-gray-400 py-4">Belum ada produk.</p>}
                                </div>
                            </div>
                        )}

                        {['products', 'customers', 'suppliers', 'tables'].includes(view) && (
                            /* ... (Standard CRUD View - Paste from v9.6) ... */
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6 capitalize">
                                    <h2 className="text-2xl font-bold">{view}</h2>
                                    <button onClick={()=>setModalConfig({show:true, type: view.slice(0,-1)})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {(view==='products'?products:view==='customers'?customers:view==='suppliers'?suppliers:tables).map(item => (
                                         <div key={item.id} className="bg-white p-4 rounded-xl border hover:shadow-md transition relative group">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold flex-shrink-0">
                                                    {view==='products' && item.image ? <img src={item.image} className="w-full h-full object-cover rounded-full"/> : item.name[0]}
                                                </div>
                                                <div className="min-w-0 flex-1">
                                                    <h4 className="font-bold truncate">{item.name}</h4>
                                                    {view==='products' && <div className="text-sm text-blue-600 font-bold">{formatCurrency(item.price)}</div>}
                                                    {view==='products' && <div className="text-xs text-gray-500 mt-1">Stok: {item.stock}</div>}
                                                    
                                                    {view==='products' && (
                                                        <div className="mt-2 pt-2 border-t border-dashed">
                                                            {item.recipe && item.recipe.length > 0 ? (
                                                                <div className="text-[10px] space-y-1">
                                                                    <div className="font-bold text-gray-400">RESEP:</div>
                                                                    {item.recipe.map((r,idx) => {
                                                                        const ing = ingredients.find(i=>i.id===r.ingId);
                                                                        return <div key={idx} className="flex justify-between bg-purple-50 text-purple-700 px-1 rounded"><span>{ing?.name}</span><span>{r.qty} {ing?.unit}</span></div>
                                                                    })}
                                                                    <button onClick={()=>updateDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'products',item.id), {recipe: []})} className="text-red-500 hover:underline w-full text-center mt-1">Reset Resep</button>
                                                                </div>
                                                            ) : <div className="text-[10px] text-gray-400 italic">Tanpa Resep (Stok Langsung)</div>}
                                                            <button onClick={()=>setModalConfig({show:true, type:'recipe_setup', data:item})} className="w-full mt-1 bg-gray-100 text-xs py-1 rounded font-bold hover:bg-gray-200">+ Atur Resep</button>
                                                        </div>
                                                    )}
                                                    {view==='tables' && <div className="text-sm text-gray-500">Kapasitas: {item.capacity} org</div>}
                                                    {view==='customers' && (
                                                        <div className="mt-1 flex flex-wrap gap-1">
                                                            <div className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded inline-block">{item.memberCode}</div>
                                                            <div className={`text-[10px] px-2 py-0.5 rounded font-bold text-white ${
                                                                item.tier === 'Platinum' ? 'bg-slate-800' :
                                                                item.tier === 'Gold' ? 'bg-yellow-500' :
                                                                item.tier === 'Silver' ? 'bg-gray-400' : 'bg-green-500'
                                                            }`}>{item.tier || 'Basic'}</div>
                                                        </div>
                                                    )}
                                                    {view==='customers' && <div className="text-[10px] text-gray-500 mt-1">Poin: {item.points || 0} | Total Belanja: {formatCurrency(item.totalSpending || 0)}</div>}
                                                    {(view==='customers'||view==='suppliers') && <div className="text-sm text-gray-500">{item.phone}</div>}
                                                </div>
                                            </div>
                                            <div className="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition">
                                                {view==='customers' && <button onClick={()=>setModalConfig({show:true, type:'show_member_card', data:item})} className="p-1.5 bg-green-100 text-green-600 rounded" title="Kartu Member"><Icon name="credit-card" size={14}/></button>}
                                                <button onClick={()=>setModalConfig({show:true, type: view.slice(0,-1), data:item})} className="p-1.5 bg-gray-100 hover:text-blue-600 rounded"><Icon name="edit-2" size={14}/></button>
                                                <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',storeId,view,item.id))}} className="p-1.5 bg-gray-100 hover:text-red-600 rounded"><Icon name="trash" size={14}/></button>
                                            </div>
                                         </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* [FIXED] STAFF LIST VIEW (STATUS TOGGLE) */}
                        {view === 'staff' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Daftar Staff</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'staff'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><Icon name="plus"/> Tambah Staff</button>
                                </div>
                                <div className="grid grid-cols-1 gap-4">
                                    {staff.map(s => (
                                        <div key={s.id} className="bg-white p-4 rounded-xl border flex justify-between items-center">
                                            <div>
                                                <h4 className="font-bold">{s.name} <span className="text-xs bg-gray-100 text-gray-500 px-2 py-1 rounded ml-2 uppercase">{s.role}</span></h4>
                                                <p className="text-sm text-gray-500">{s.email}</p>
                                                <p className="text-xs text-gray-400 mt-1">Jadwal: {s.shiftStart || "08:00"} - {s.shiftEnd || "17:00"}</p>
                                            </div>
                                            <div className="flex items-center gap-3">
                                                {/* TOMBOL STATUS MANUAL */}
                                                {s.role !== 'admin' && (
                                                    <button 
                                                        onClick={()=>toggleStaffStatus(s.id, s.isActive)}
                                                        className={`px-4 py-2 rounded-lg font-bold text-xs transition ${s.isActive !== false ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}
                                                    >
                                                        {s.isActive !== false ? 'AKTIF' : 'NONAKTIF'}
                                                    </button>
                                                )}
                                                <button onClick={()=>setModalConfig({show:true, type:'staff', data:s})} className="p-2 bg-gray-100 hover:text-blue-600 rounded"><Icon name="edit-2" size={16}/></button>
                                                <button onClick={()=>{if(confirm('Hapus Staff?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',storeId,'staff',s.id))}} className="p-2 bg-gray-100 hover:text-red-600 rounded"><Icon name="trash" size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {/* RENDER VIEW LAINNYA (DASHBOARD, HISTORY, ETC) */}
                        {view === 'dashboard' && (
                            /* ... COPY PASTE DASHBOARD ... */
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Dashboard</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Omzet Kotor</p><h3 className="text-2xl font-bold text-blue-600">{formatCurrency(transactions.reduce((a,b)=>a+(b.total||0),0))}</h3></div>
                                    <div className="bg-gradient-to-br from-green-500 to-green-700 text-white p-5 rounded-xl shadow-lg"><p className="text-green-100 text-sm">Net Profit (Bersih)</p><h3 className="text-2xl font-bold">{formatCurrency(transactions.reduce((a,b)=>a+(b.profit||0),0) - expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Pengeluaran</p><h3 className="text-2xl font-bold text-red-600">{formatCurrency(expenses.reduce((a,b)=>a+(b.amount||0),0))}</h3></div>
                                    <div className="bg-white p-5 rounded-xl border shadow-sm"><p className="text-gray-500 text-sm">Piutang Belum Bayar</p><h3 className="text-2xl font-bold text-orange-600">{formatCurrency(debts.reduce((a,b)=>a + (b.status!=='paid' ? (b.amount - b.paid) : 0),0))}</h3></div>
                                </div>
                            </div>
                        )}
                        {view === 'history' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Riwayat Transaksi (Per Kasir)</h2>
                                
                                {/* LOGIKA PENGELOMPOKAN: Ambil daftar nama kasir unik */}
                                {[...new Set(transactions.map(t => t.cashierName || 'Owner'))].map(cashierName => {
                                    // Filter transaksi hanya milik kasir ini
                                    const cashierTrans = transactions.filter(t => (t.cashierName || 'Owner') === cashierName);
                                    // Hitung total penjualan khusus kasir ini
                                    const cashierTotal = cashierTrans.reduce((a,b) => a + (b.total || 0), 0);

                                    return (
                                        <div key={cashierName} className="mb-8 bg-white rounded-xl border shadow-sm overflow-hidden animate-fade-in">
                                            {/* HEADER GRUP KASIR */}
                                            <div className="bg-blue-50 p-4 border-b flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 bg-blue-200 rounded-full flex items-center justify-center text-blue-700 shadow-sm">
                                                        <Icon name="user" size={20}/>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold text-lg text-blue-900 capitalize">{cashierName}</h3>
                                                        <p className="text-xs text-blue-600 font-medium">{cashierTrans.length} Transaksi</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <div className="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Total Penjualan</div>
                                                    <div className="font-bold text-lg text-blue-700">{formatCurrency(cashierTotal)}</div>
                                                </div>
                                            </div>

                                            {/* TABEL TRANSAKSI UNTUK KASIR INI */}
                                            <table className="w-full text-left text-sm">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="p-4 text-gray-500 font-medium">ID / Waktu</th>
                                                        <th className="p-4 text-gray-500 font-medium">Pelanggan</th>
                                                        <th className="p-4 text-gray-500 font-medium">Total</th>
                                                        <th className="p-4 text-gray-500 font-medium">Metode</th>
                                                        <th className="p-4 text-center text-gray-500 font-medium">Aksi</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {cashierTrans.map(t => (
                                                        <tr key={t.id} className="border-b last:border-0 hover:bg-gray-50 transition">
                                                            <td className="p-4">
                                                                <div className="font-bold text-xs text-gray-500">#{t.id.slice(0,6)}</div>
                                                                <div>{formatDate(t.createdAt)}</div>
                                                            </td>
                                                            <td className="p-4">
                                                                <div className="font-bold text-gray-800">{t.customerName}</div>
                                                                <div className="text-xs text-gray-500">{t.orderType} {t.table ? `(${t.table})` : ''}</div>
                                                            </td>
                                                            <td className="p-4">
                                                                <div className="font-bold text-gray-800">{formatCurrency(t.total)}</div>
                                                                {/* [UPDATE] Tampilkan info diskon kecil di bawah harga */}
                                                                {t.discount > 0 && <div className="text-[10px] text-red-500">Disc: -{formatCurrency(t.discount)}</div>}
                                                            </td>
                                                            <td className="p-4 font-bold text-gray-800">{formatCurrency(t.total)}</td>
                                                            <td className="p-4"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs font-bold">{t.paymentMethod}</span></td>
                                                            <td className="p-4 flex justify-center gap-2">
                                                                <button onClick={()=>setLastTrans(t)} className="p-2 bg-white border shadow-sm rounded hover:bg-blue-50 text-blue-600 transition" title="Lihat/Print"><Icon name="printer" size={16}/></button>
                                                                {activeStaff?.role === 'admin' && (
                                                                    <button onClick={()=>handleDeleteTransaction(t)} className="p-2 bg-white border shadow-sm rounded hover:bg-red-50 text-red-600 transition" title="Hapus"><Icon name="trash-2" size={16}/></button>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    );
                                })}
                                
                                {transactions.length === 0 && <div className="p-10 text-center text-gray-400 border-2 border-dashed rounded-xl">Belum ada transaksi tercatat.</div>}
                            </div>
                        )}

                        {view === 'debts' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <h2 className="text-2xl font-bold mb-6">Buku Hutang (Piutang)</h2>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {debts.sort((a,b)=>b.createdAt-a.createdAt).map(d => (
                                        <div key={d.id} className={`bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition ${d.status==='paid' ? 'opacity-60 grayscale' : ''}`}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <h4 className="font-bold text-lg">{d.customerName}</h4>
                                                    <div className="text-xs text-gray-500">{formatDate(d.createdAt)}</div>
                                                </div>
                                                <span className={`text-xs px-2 py-1 rounded font-bold uppercase ${d.status==='paid'?'bg-green-100 text-green-700':'bg-orange-100 text-orange-700'}`}>{d.status}</span>
                                            </div>
                                            <div className="space-y-1 my-3 text-sm">
                                                <div className="flex justify-between"><span>Total Hutang:</span> <span className="font-bold">{formatCurrency(d.amount)}</span></div>
                                                <div className="flex justify-between text-green-600"><span>Sudah Bayar:</span> <span>{formatCurrency(d.paid || 0)}</span></div>
                                                <div className="flex justify-between text-red-600 border-t pt-1 font-bold"><span>Sisa:</span> <span>{formatCurrency(d.amount - (d.paid||0))}</span></div>
                                            </div>
                                            {d.status !== 'paid' && (
                                                <button onClick={()=>setModalConfig({show:true, type:'pay_debt', data:d})} className="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold mt-2 hover:bg-blue-700">Bayar / Cicil</button>
                                            )}
                                        </div>
                                    ))}
                                    {debts.length === 0 && <div className="col-span-full text-center text-gray-400 py-10">Tidak ada data hutang</div>}
                                </div>
                            </div>
                        )}

                        {view === 'expenses' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Pengeluaran Operasional</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'expense'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-gray-50 border-b"><tr><th className="p-4">Nama</th><th className="p-4">Kategori</th><th className="p-4">Tanggal</th><th className="p-4 text-right">Jumlah</th><th className="p-4 text-center">Aksi</th></tr></thead>
                                        <tbody>
                                            {expenses.map(e => (
                                                <tr key={e.id} className="border-b last:border-0 hover:bg-gray-50">
                                                    <td className="p-4 font-bold">{e.name}</td>
                                                    <td className="p-4"><span className="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">{e.category}</span></td>
                                                    <td className="p-4 text-sm text-gray-500">{formatDate(e.date)}</td>
                                                    <td className="p-4 text-right font-mono font-bold text-red-600">{formatCurrency(e.amount)}</td>
                                                    <td className="p-4 text-center">
                                                        <button onClick={()=>{if(confirm('Hapus?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',user.uid,'expenses',e.id))}} className="text-red-500 hover:bg-red-50 p-2 rounded"><Icon name="trash" size={16}/></button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {view === 'ingredients' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Stok Bahan Baku (Gudang)</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'ingredient'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2 hover:bg-blue-700"><Icon name="plus"/> Tambah</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                    {ingredients.map(i => (
                                        <div key={i.id} onClick={()=>setModalConfig({show:true, type:'ingredient', data:i})} className="bg-white p-4 rounded-xl border hover:shadow-md cursor-pointer">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600"><Icon name="flask-conical" size={20}/></div>
                                                <div>
                                                    <h4 className="font-bold">{i.name}</h4>
                                                    <div className="text-xs text-gray-500">Stok: <b className="text-blue-600">{i.stock} {i.unit}</b></div>
                                                </div>
                                            </div>
                                            <div className="mt-2 text-xs bg-gray-50 p-2 rounded text-center">Cost: {formatCurrency(i.costPerUnit)} / {i.unit}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
						
						{view === 'promos' && (
                            <div className="p-6 h-full overflow-y-auto">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Voucher & Promo</h2>
                                    <button onClick={()=>setModalConfig({show:true, type:'promo'})} className="bg-blue-600 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2"><Icon name="plus"/> Buat Promo Baru</button>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {promos.map(p => (
                                        <div key={p.id} className="bg-white p-4 rounded-xl border shadow-sm relative overflow-hidden">
                                            <div className={`absolute top-0 right-0 px-3 py-1 text-[10px] font-bold text-white rounded-bl-xl ${p.isActive ? 'bg-green-500' : 'bg-gray-400'}`}>
                                                {p.isActive ? 'AKTIF' : 'NON-AKTIF'}
                                            </div>
                                            <h3 className="font-bold text-lg text-purple-700">{p.name}</h3>
                                            <div className="text-sm text-gray-600 mt-1">
                                                {p.type === 'percent' ? `Diskon ${p.value}%` : `Potongan ${formatCurrency(p.value)}`}
                                            </div>
                                            <div className="mt-3 text-xs text-gray-500 space-y-1">
                                                <p>Min. Belanja: {formatCurrency(p.minSpend)}</p>
                                                {p.maxDiscount > 0 && <p>Maks. Diskon: {formatCurrency(p.maxDiscount)}</p>}
                                            </div>
                                            <div className="mt-4 pt-3 border-t flex justify-end gap-2">
                                                <button onClick={async ()=>{
                                                    await updateDoc(doc(db,'artifacts',APP_ID,'users',storeId,'promos',p.id), {isActive: !p.isActive});
                                                }} className="text-xs font-bold text-blue-600 border border-blue-200 px-3 py-1 rounded hover:bg-blue-50">
                                                    {p.isActive ? 'Matikan' : 'Aktifkan'}
                                                </button>
                                                <button onClick={()=>{if(confirm('Hapus promo ini?')) deleteDoc(doc(db,'artifacts',APP_ID,'users',storeId,'promos',p.id))}} className="text-red-500 hover:bg-red-50 p-1 rounded"><Icon name="trash" size={16}/></button>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
						
						{view === 'transfer' && (
                            <div className="p-6 h-full overflow-y-auto flex flex-col md:flex-row gap-6">
                                {/* BAGIAN KIRI: KIRIM BARANG */}
                                <div className="flex-1 bg-white p-6 rounded-xl border shadow-sm">
                                    <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="send" size={18}/> Kirim Barang Keluar</h3>
                                    
                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-gray-500">ID Toko Tujuan</label>
                                        <input value={targetStoreId} onChange={e=>setTargetStoreId(e.target.value)} placeholder="Tempel ID Toko Cabang disini..." className="w-full p-3 border rounded-lg bg-gray-50 font-mono text-sm"/>
                                    </div>

                                    <div className="mb-4">
                                        <label className="text-xs font-bold text-gray-500 mb-1 block">Pilih Produk</label>
                                        <div className="relative">
                                            <Icon name="search" className="absolute left-3 top-3 text-gray-400" size={18}/>
                                            <input className="w-full pl-10 p-3 border rounded-lg text-sm" placeholder="Cari produk untuk dikirim..." 
                                                onChange={(e)=>{
                                                    const kw = e.target.value.toLowerCase();
                                                    if(!kw) return;
                                                    // Simple autocomplete logic could go here, for now using direct add logic via search is tricky.
                                                    // Let's iterate products
                                                }}
                                            />
                                            {/* Dropdown Hasil Pencarian Simple */}
                                            <div className="border rounded-lg mt-2 max-h-40 overflow-y-auto bg-gray-50">
                                                {products.map(p => (
                                                    <div key={p.id} onClick={()=>{
                                                        if(p.stock <= 0) return alert("Stok habis!");
                                                        setTransferCart(prev => {
                                                            const ex = prev.find(x=>x.id===p.id);
                                                            return ex ? prev.map(x=>x.id===p.id?{...x, qty:x.qty+1}:x) : [...prev, {...p, qty:1}];
                                                        });
                                                    }} className="p-2 hover:bg-blue-50 cursor-pointer flex justify-between text-sm border-b last:border-0">
                                                        <span>{p.name}</span>
                                                        <span className="font-bold text-blue-600">Stok: {p.stock}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    {/* List Keranjang Transfer */}
                                    <div className="bg-gray-50 rounded-lg p-3 min-h-[150px] mb-4">
                                        {transferCart.length === 0 && <p className="text-center text-gray-400 text-xs py-10">Belum ada barang dipilih</p>}
                                        {transferCart.map((item, idx) => (
                                            <div key={idx} className="flex justify-between items-center border-b border-dashed last:border-0 py-2">
                                                <div className="text-sm">
                                                    <div className="font-bold">{item.name}</div>
                                                    <div className="text-xs text-gray-500">Stok Awal: {item.stock}</div>
                                                </div>
                                                <div className="flex items-center gap-2">
                                                    <input type="number" min="1" max={item.stock} value={item.qty} 
                                                        onChange={(e)=> {
                                                            const val = Number(e.target.value);
                                                            if(val > item.stock) return alert("Melebihi stok tersedia");
                                                            setTransferCart(prev => prev.map(x=>x.id===item.id?{...x, qty:val}:x));
                                                        }}
                                                        className="w-16 p-1 border rounded text-center text-sm"
                                                    />
                                                    <button onClick={()=>setTransferCart(prev=>prev.filter(x=>x.id!==item.id))} className="text-red-500"><Icon name="x" size={16}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <button onClick={handleSendTransfer} disabled={isProcessing || transferCart.length===0} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 disabled:bg-gray-300">
                                        {isProcessing ? 'Mengirim...' : 'Kirim Stok Sekarang'}
                                    </button>
                                </div>

                                {/* BAGIAN KANAN: RIWAYAT & BARANG MASUK */}
                                <div className="w-full md:w-96 flex flex-col gap-4">
                                    <div className="bg-white p-4 rounded-xl border shadow-sm flex-1 overflow-y-auto">
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="history" size={18}/> Riwayat Transfer</h3>
                                        
                                        {transfers.length === 0 && <p className="text-center text-gray-400 text-xs">Belum ada riwayat.</p>}

                                        <div className="space-y-3">
                                            {transfers.map(t => (
                                                <div key={t.id} className={`p-3 rounded-lg border text-sm ${t.dir==='in'?'bg-green-50 border-green-200':'bg-blue-50 border-blue-200'}`}>
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div>
                                                            <span className={`text-[10px] font-bold px-2 py-0.5 rounded ${t.dir==='in'?'bg-green-200 text-green-800':'bg-blue-200 text-blue-800'}`}>
                                                                {t.dir==='in' ? 'MASUK' : 'KELUAR'}
                                                            </span>
                                                            <div className="font-bold mt-1 text-gray-700">
                                                                {t.dir==='in' ? `Dari: ${t.fromName}` : `Ke: ${t.toId.slice(0,6)}...`}
                                                            </div>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-[10px] text-gray-400">{formatDate(t.createdAt)}</div>
                                                            <span className={`text-[10px] font-bold uppercase ${t.status==='completed'?'text-green-600':'text-orange-500'}`}>{t.status}</span>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="text-xs text-gray-500 mb-2">
                                                        {t.items.map(i=> `${i.qty}x ${i.name}`).join(', ')}
                                                    </div>

                                                    {/* TOMBOL TERIMA (Hanya jika barang masuk & belum diterima) */}
                                                    {t.dir === 'in' && t.status === 'pending' && (
                                                        <button onClick={()=>handleAcceptTransfer(t)} className="w-full bg-green-600 text-white py-2 rounded font-bold text-xs hover:bg-green-700 flex items-center justify-center gap-1">
                                                            <Icon name="check-circle" size={14}/> Terima Barang
                                                        </button>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* DYNAMIC MODAL FORM */}
                    {modalConfig.show && (
                        <Modal title={modalConfig.type.replace('_', ' ')} onClose={()=>setModalConfig({show:false})}>
                             
                             {modalConfig.type === 'show_member_card' && <MemberCardModal customer={modalConfig.data} storeProfile={storeProfile} onClose={()=>setModalConfig({show:false})} />}
                             
                             {modalConfig.type === 'hold_list' && (
                                <div className="space-y-3">
                                    <div className="bg-blue-50 p-2 rounded text-xs text-blue-800 mb-2">
                                        Data diambil dari server (Real-time). Klik untuk memproses pembayaran.
                                    </div>
                                    {activeOrders.length === 0 && <p className="text-center text-gray-400 py-4">Tidak ada pesanan aktif.</p>}
                                    {activeOrders.map(h => (
                                        <div key={h.id} className={`p-3 border rounded-lg hover:bg-blue-50 flex justify-between items-center relative group ${h.status==='ready' ? 'bg-green-50 border-green-200' : ''}`}>
                                            {/* Klik area kiri untuk restore/bayar */}
                                            <div className="flex-1 cursor-pointer" onClick={()=>restoreTransaction(h)}>
                                                {h.status==='ready' && <span className="absolute top-0 right-10 bg-green-600 text-white text-[10px] px-2 rounded-bl-lg">SIAP SAJI</span>}
                                                <div className="font-bold text-lg">{h.table ? h.table.name : h.orderType}</div>
                                                <div className="font-medium">{h.cust?.name || 'Pelanggan Umum'}</div>
                                                <div className="text-xs text-gray-500">
                                                    {h.cart.reduce((a,b)=>a+b.qty,0)} Item  {formatDate(h.createdAt)}
                                                </div>
                                            </div>

                                            {/* [BARU] Tombol Hapus / Batal Pesanan */}
                                            <button onClick={async (e) => {
                                                e.stopPropagation(); // Agar tidak men-trigger restoreTransaction
                                                if(confirm(`Batalkan pesanan ${h.table?.name || h.orderType}? Data akan dihapus permanen.`)) {
                                                    await deleteDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'orders', h.id));
                                                }
                                            }} className="p-2 text-red-400 hover:text-red-600 hover:bg-red-100 rounded-full transition z-10" title="Batalkan Pesanan">
                                                <Icon name="x-circle" size={24}/>
                                            </button>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {modalConfig.type === 'close_shift' && (
                                <form onSubmit={handleCloseShift} className="space-y-4">
                                    <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg mb-4 text-sm">
                                        <h4 className="font-bold text-yellow-800 mb-2">Ringkasan Shift</h4>
                                        <div className="flex justify-between"><span>Modal Awal:</span> <b>{formatCurrency(shift?.startCash)}</b></div>
                                        <div className="flex justify-between"><span>Penjualan Tunai:</span> <b>{formatCurrency(transactions.filter(t=>t.paymentMethod==='Tunai' && t.shiftId===shift.id).reduce((a,b)=>a+(b.total||0),0))}</b></div>
                                        <div className="flex justify-between text-red-600"><span>Pengeluaran:</span> <b>-{formatCurrency(expenses.filter(ex=>ex.date?.seconds>=shift.startTime?.seconds).reduce((a,b)=>a+(b.amount||0),0))}</b></div>
                                    </div>
                                    <label className="block text-sm font-bold text-gray-700">Total Uang Fisik di Laci</label>
                                    <input name="endCash" type="number" placeholder="Hitung uang tunai..." required className="w-full p-3 border rounded-lg text-lg font-bold" autoFocus/>
                                    <button className="w-full bg-red-600 text-white p-3 rounded-lg font-bold">Setor & Tutup Toko</button>
                                </form>
                            )}
							
							
							{modalConfig.type === 'settings' && (
                                <form onSubmit={async (e) => {
                                    e.preventDefault();
                                    const f = e.target;
                                    const isPublic = f.isPublic.checked;
                                    
                                    // 1. Simpan Setting Lokal
                                    const profileData = {
                                        name: f.name.value, address: f.address.value, phone: f.phone.value, logo: f.logo.value,
                                        footerMessage: f.footerMessage.value, 
                                        taxRate: Number(f.taxRate.value), serviceRate: Number(f.serviceRate.value),
                                        paperSize: f.paperSize.value,
                                        pointConversion: Number(f.pointConversion.value),
                                        isPublic: isPublic // Simpan status
										tierSilver: Number(f.tierSilver.value),
                                        tierGold: Number(f.tierGold.value),
                                        tierPlatinum: Number(f.tierPlatinum.value),
                                        tierAchieveWindow: Number(f.tierAchieveWindow.value),
                                        tierValidity: Number(f.tierValidity.value)
                                    };
                                    
                                    await setDoc(doc(db, 'artifacts', APP_ID, 'users', storeId, 'settings', 'profile'), profileData);
                                    
                                    // 2. LOGIKA MARKETPLACE (GO ONLINE)
                                    // Simpan ke koleksi GLOBAL 'market_shops' agar muncul di store.html
                                    const publicRef = doc(db, 'artifacts', APP_ID, 'market_shops', storeId);
                                    
                                    if (isPublic) {
                                        await setDoc(publicRef, {
                                            id: storeId,
                                            name: profileData.name,
                                            address: profileData.address,
                                            logo: profileData.logo,
                                            phone: profileData.phone,
                                            isOpen: true,
                                            updatedAt: serverTimestamp()
                                        });
                                        alert("Pengaturan Disimpan. Toko Anda SEKARANG ONLINE di Marketplace!");
                                    } else {
                                        await deleteDoc(publicRef);
                                        alert("Pengaturan Disimpan. Toko Anda disembunyikan dari Marketplace.");
                                    }

                                    setModalConfig({ show: false });
                                }} className="space-y-4">
                                    
                                    {/* FITUR MARKETPLACE TOGGLE */}
                                    <div className="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 rounded-xl text-white shadow-lg flex justify-between items-center">
                                        <div>
                                            <h4 className="font-bold flex items-center gap-2"><Icon name="globe" size={18}/> Publikasikan Toko</h4>
                                            <p className="text-xs text-purple-100 opacity-90">Tampil di halaman depan Toko Online.</p>
                                        </div>
                                        <label className="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" name="isPublic" defaultChecked={storeProfile?.isPublic} className="sr-only peer"/>
                                            <div className="w-11 h-6 bg-purple-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-400"></div>
                                        </label>
                                    </div>

                                    <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                        <label className="text-xs font-bold text-blue-600 uppercase">ID Toko (Untuk Staff)</label>
                                        <div className="flex gap-2 mt-1">
                                            <input readOnly value={user.uid} className="w-full p-2 bg-white rounded text-sm font-mono border" onClick={e=>e.target.select()}/>
                                            <button type="button" onClick={()=>{navigator.clipboard.writeText(user.uid); alert("ID Disalin!")}} className="p-2 bg-blue-600 text-white rounded"><Icon name="copy" size={16}/></button>
                                        </div>
                                    </div>

                                    <input name="name" placeholder="Nama Toko" defaultValue={storeProfile?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="address" placeholder="Alamat Lengkap" defaultValue={storeProfile?.address} className="w-full p-3 border rounded-lg"/>
                                    <input name="phone" placeholder="No. Telepon (WA)" defaultValue={storeProfile?.phone} className="w-full p-3 border rounded-lg"/>
                                    <input name="logo" placeholder="URL Logo (Link Gambar)" defaultValue={storeProfile?.logo} className="w-full p-3 border rounded-lg"/>
                                    <textarea name="footerMessage" placeholder="Pesan di Bawah Struk" defaultValue={storeProfile?.footerMessage} className="w-full p-3 border rounded-lg"/>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs">Pajak (%)</label><input name="taxRate" type="number" step="0.1" defaultValue={storeProfile?.taxRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                        <div><label className="text-xs">Service (%)</label><input name="serviceRate" type="number" step="0.1" defaultValue={storeProfile?.serviceRate || 0} className="w-full p-3 border rounded-lg"/></div>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-gray-500">Ukuran Kertas Printer</label>
                                        <select name="paperSize" defaultValue={storeProfile?.paperSize || '58mm'} className="w-full p-3 border rounded-lg">
                                            <option value="58mm">58mm (Thermal Kecil)</option>
                                            <option value="80mm">80mm (Thermal Besar)</option>
                                        </select>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-gray-500">Konversi Poin (Rp untuk 1 Poin)</label>
                                        <input name="pointConversion" type="number" defaultValue={storeProfile?.pointConversion || 10000} className="w-full p-3 border rounded-lg"/>
                                    </div>
									
									{/* [BARU] KONFIGURASI TIER MEMBERSHIP */}
                                    <div className="bg-yellow-50 p-4 rounded-xl border border-yellow-200">
                                        <h4 className="font-bold text-yellow-800 text-sm mb-3 flex items-center gap-2"><Icon name="crown" size={16}/> Aturan Membership</h4>
                                        
                                        <div className="grid grid-cols-3 gap-3 mb-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-500 uppercase">Silver (Rp)</label>
                                                <input name="tierSilver" type="number" defaultValue={storeProfile?.tierSilver || 1000000} className="w-full p-2 border rounded text-sm font-bold text-gray-700"/>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-500 uppercase">Gold (Rp)</label>
                                                <input name="tierGold" type="number" defaultValue={storeProfile?.tierGold || 5000000} className="w-full p-2 border rounded text-sm font-bold text-yellow-600"/>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-500 uppercase">Platinum (Rp)</label>
                                                <input name="tierPlatinum" type="number" defaultValue={storeProfile?.tierPlatinum || 10000000} className="w-full p-2 border rounded text-sm font-bold text-slate-700"/>
                                            </div>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-3">
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-500 uppercase">Periode Evaluasi (Bulan)</label>
                                                <input name="tierAchieveWindow" type="number" placeholder="12" defaultValue={storeProfile?.tierAchieveWindow || 12} className="w-full p-2 border rounded text-sm"/>
                                                <p className="text-[9px] text-gray-400 mt-1">Batas waktu mengumpulkan poin/belanja.</p>
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-bold text-gray-500 uppercase">Masa Aktif Tier (Bulan)</label>
                                                <input name="tierValidity" type="number" placeholder="12" defaultValue={storeProfile?.tierValidity || 12} className="w-full p-2 border rounded text-sm"/>
                                                <p className="text-[9px] text-gray-400 mt-1">Lama status tier bertahan setelah didapat.</p>
                                            </div>
                                        </div>
                                    </div>

                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan & Update</button>
                                </form>
                            )}
							
							{modalConfig.type === 'ingredient' && (
                                <form onSubmit={handleSubmit} className="space-y-4 capitalize">
                                    <input name="name" placeholder="Nama Bahan (Misal: Beras)" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                    <input name="unit" placeholder="Satuan (kg, gram, butir)" required defaultValue={modalConfig.data?.unit} className="w-full p-3 border rounded-lg"/>
                                    <div className="grid grid-cols-2 gap-4">
                                        <input name="stock" type="number" placeholder="Stok Awal" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                        <input name="costPerUnit" type="number" placeholder="Harga Beli / Satuan" required defaultValue={modalConfig.data?.costPerUnit} className="w-full p-3 border rounded-lg"/>
                                    </div>
                                    <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold">Simpan Bahan</button>
                                </form>
                            )}
							
							{modalConfig.type === 'promo' && (
                                <form onSubmit={handleSubmit} className="space-y-4">
                                    <div className="bg-purple-50 p-3 rounded border border-purple-200 mb-2">
                                        <h4 className="font-bold text-purple-800 text-sm mb-1">Jenis Promo</h4>
                                        <select name="type" className="w-full p-2 border rounded text-sm">
                                            <option value="percent">Diskon Persen (%)</option>
                                            <option value="fixed">Potongan Rupiah (Rp)</option>
                                        </select>
                                    </div>
                                    
                                    <input name="name" placeholder="Nama Promo (Cth: Diskon Merdeka)" required className="w-full p-3 border rounded-lg"/>
                                    
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Nilai (Rp / %)</label>
                                            <input name="value" type="number" required placeholder="Contoh: 10 atau 5000" className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-500">Min. Belanja (Rp)</label>
                                            <input name="minSpend" type="number" defaultValue="0" className="w-full p-3 border rounded-lg"/>
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-gray-500">Maksimal Diskon (Rp) - Opsional</label>
                                        <input name="maxDiscount" type="number" placeholder="Kosongkan jika tanpa batas" className="w-full p-3 border rounded-lg"/>
                                        <p className="text-[10px] text-gray-400 mt-1">*Hanya berlaku untuk diskon persen</p>
                                    </div>

                                    <button className="w-full bg-purple-600 text-white p-3 rounded-lg font-bold">Buat Promo</button>
                                </form>
                            )}
                             
                             {/* FORM DINAMIS LAINNYA */}
                             {['pay_debt', 'stock_adj', 'edit_cart_item', 'recipe_setup', 'product', 'customer', 'supplier', 'expense', 'table', 'staff'].includes(modalConfig.type) && (
                                 <form onSubmit={
                                     ['settings'].includes(modalConfig.type) ? saveSettings :
                                     ['pay_debt'].includes(modalConfig.type) ? handlePaymentSubmit :
                                     ['stock_adj'].includes(modalConfig.type) ? handleAdjustStock :
                                     handleSubmit 
                                 } className="space-y-4 capitalize">
                                     
                                     {/* FORM: EDIT CART ITEM */}
                                     {modalConfig.type === 'edit_cart_item' ? (
                                         <div className="space-y-4">
                                            <h3 className="font-bold">{editingItem.name}</h3>
                                            <div className="flex gap-4 items-center">
                                                <button type="button" onClick={()=>setEditingItem(p=>({...p, qty: Math.max(1, p.qty-1)}))} className="p-2 bg-gray-200 rounded">-</button>
                                                <span className="font-bold">{editingItem.qty}</span>
                                                <button type="button" onClick={()=>setEditingItem(p=>({...p, qty: p.qty+1}))} className="p-2 bg-gray-200 rounded">+</button>
                                            </div>
                                            <input type="text" placeholder="Catatan Item" value={editingItem.note||''} onChange={e=>setEditingItem(p=>({...p, note:e.target.value}))} className="w-full p-2 border rounded text-sm"/>
                                            <div className="flex gap-2">
                                                <button type="button" onClick={()=>{setCart(cart.filter(c=>c.id!==editingItem.id)); setModalConfig({show:false});}} className="flex-1 bg-red-100 text-red-600 py-3 rounded">Hapus</button>
                                                <button type="button" onClick={()=>{setCart(cart.map(c=>c.id===editingItem.id ? editingItem : c)); setModalConfig({show:false});}} className="flex-1 bg-blue-600 text-white py-3 rounded">Simpan</button>
                                            </div>
                                         </div>
                                     ) : (
                                         /* FORM STANDAR (DENGAN UPDATE INPUT STAFF BARU) */
                                         <>
                                            {/* ... INPUT FIELDS ... */}
                                            {modalConfig.type === 'pay_debt' && <input name="amount" type="number" placeholder="Jumlah Bayar" className="w-full p-3 border rounded-lg"/>}
                                            {modalConfig.type === 'stock_adj' && (
                                                <>
                                                    <div className="text-sm">Produk: <b>{modalConfig.data.name}</b></div>
                                                    <select name="type" className="w-full p-3 border rounded-lg"><option value="in">Masuk</option><option value="out">Keluar</option></select>
                                                    <input name="qty" type="number" placeholder="Jumlah" required className="w-full p-3 border rounded-lg"/>
                                                    <textarea name="reason" placeholder="Keterangan" className="w-full p-3 border rounded-lg" required></textarea>
                                                </>
                                            )}
                                            
                                            
                                            {/* [FIXED] FORM STAFF: ADA NAMA, TIDAK ADA PIN */}
                                            {modalConfig.type === 'staff' && <>
                                                <input name="name" type="text" placeholder="Nama Staff (Wajib)" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                                
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                    <input name="email" type="email" placeholder="Email Google (Opsional)" defaultValue={modalConfig.data?.email} className="w-full p-3 border rounded-lg"/>
                                                    <input name="phone" type="tel" placeholder="No. HP (08xx) untuk Login" required defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/>
                                                </div>
                                                <p className="text-xs text-gray-500 -mt-2 mb-2">*Isi minimal salah satu (Email atau No HP) untuk login.</p>
												
                                                <div className="bg-gray-100 p-3 rounded-lg border">
                                                    <label className="text-xs font-bold text-gray-500 block mb-1">Jadwal Kerja (Otomatis)</label>
                                                    <div className="flex gap-2 mb-2">
                                                        <input type="time" name="shiftStart" defaultValue={modalConfig.data?.shiftStart || "08:00"} className="w-full p-2 border rounded"/>
                                                        <span className="self-center">-</span>
                                                        <input type="time" name="shiftEnd" defaultValue={modalConfig.data?.shiftEnd || "17:00"} className="w-full p-2 border rounded"/>
                                                    </div>
                                                </div>
                                                {/* PIN sudah dihapus */}
                                                <select name="role" defaultValue={modalConfig.data?.role||'kasir'} className="w-full p-3 border rounded-lg">
                                                    <option value="kasir">Kasir (Jualan)</option>
                                                    <option value="admin">Admin (Full Akses)</option>
                                                    <option value="gudang">Gudang (Stok)</option>
                                                    <option value="waiter">Waiter (Input Order)</option>
													<option value="dapur">Dapur (Lihat Pesanan)</option>
                                                </select>
                                            </>}
											
											

                                            {/* ... SISA FORM (SAMA SEPERTI v9.6) ... */}
                                            {modalConfig.type === 'expense' && <><input name="amount" type="number" placeholder="Jumlah" className="w-full p-3 border rounded-lg"/><select name="category" className="w-full p-3 border rounded-lg"><option value="Operasional">Operasional</option><option value="Gaji">Gaji</option><option value="Belanja">Belanja</option></select></>}
                                            {modalConfig.type === 'customer' && <><input name="name" placeholder="Nama" defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/><input name="phone" placeholder="HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/><input name="nik" placeholder="NIK" defaultValue={modalConfig.data?.nik} className="w-full p-3 border rounded-lg"/><input name="email" placeholder="Email" defaultValue={modalConfig.data?.email} className="w-full p-3 border rounded-lg"/></>}
                                            {modalConfig.type === 'supplier' && <><input name="name" placeholder="Nama" defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/><input name="phone" placeholder="HP" defaultValue={modalConfig.data?.phone} className="w-full p-3 border rounded-lg"/><input name="address" placeholder="Alamat" defaultValue={modalConfig.data?.address} className="w-full p-3 border rounded-lg"/></>}
                                            {modalConfig.type === 'table' && <><input name="name" placeholder="Nama Meja" defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/><input name="capacity" type="number" placeholder="Kapasitas" defaultValue={modalConfig.data?.capacity} className="w-full p-3 border rounded-lg"/></>}
                                            {modalConfig.type === 'product' && <>
                                        {/* Input Nama Wajib Ada agar tombol Simpan berfungsi */}
                                        <input name="name" placeholder="Nama Produk" required defaultValue={modalConfig.data?.name} className="w-full p-3 border rounded-lg"/>
                                        {/* [BARU] Input Varian Sederhana */}
                                                <div className="bg-gray-50 p-3 rounded border">
                                                    <label className="text-xs font-bold text-gray-500 block mb-2">Varian Produk (Opsional)</label>
                                                    <p className="text-[10px] text-gray-400 mb-2">Pisahkan dengan koma. Contoh Format: <b>Panas:5000, Dingin:7000</b></p>
                                                    <input name="variants_str" placeholder="Contoh: Panas:10000, Dingin:12000" 
                                                        defaultValue={modalConfig.data?.variants ? modalConfig.data.variants.map(v => `${v.name}:${v.price}`).join(', ') : ''} 
                                                        className="w-full p-2 border rounded text-sm"/>
													<div className="bg-orange-50 p-3 rounded border border-orange-200 mt-2">
                                                    <label className="text-xs font-bold text-orange-800 block mb-2">Add-ons / Toping (Opsional)</label>
                                                    <p className="text-[10px] text-gray-500 mb-2">Format: Nama:Harga Tambahan (Pisahkan koma).</p>
                                                    <input name="modifiers_str" placeholder="Contoh: Telur:3000, Keju:2000, Pedas:0" 
                                                        defaultValue={modalConfig.data?.modifiers ? modalConfig.data.modifiers.map(m => `${m.name}:${m.price}`).join(', ') : ''} 
                                                        className="w-full p-2 border rounded text-sm"/>
                                                </div>
                                                </div>
                                        <div className="flex gap-2">
                                            <input name="barcode" placeholder="Barcode" defaultValue={modalConfig.data?.barcode} className="w-full p-3 border rounded-lg"/>
                                            <button type="button" onClick={()=>setScannerContext('form')} className="p-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><Icon name="camera"/></button>
                                        </div>
                                        <input name="category" placeholder="Kategori" defaultValue={modalConfig.data?.category} className="w-full p-3 border rounded-lg"/>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="price" type="number" placeholder="Harga Jual" required defaultValue={modalConfig.data?.price} className="w-full p-3 border rounded-lg"/>
                                            <input name="hpp" type="number" placeholder="HPP (Modal)" defaultValue={modalConfig.data?.hpp} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <input name="stock" type="number" placeholder="Stok Awal" required defaultValue={modalConfig.data?.stock} className="w-full p-3 border rounded-lg"/>
                                            <input name="image" placeholder="Link Gambar (URL)" defaultValue={modalConfig.data?.image} className="w-full p-3 border rounded-lg"/>
                                        </div>
                                        
                                        <div className="p-3 bg-gray-50 border rounded-lg">
                                            <h4 className="text-xs font-bold text-gray-500 mb-2 uppercase">Setting Harga Grosir</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                <input name="wholesaleQty" type="number" placeholder="Min Qty (Misal: 10)" defaultValue={modalConfig.data?.wholesaleQty} className="w-full p-2 border rounded bg-white text-sm"/>
                                                <input name="wholesalePrice" type="number" placeholder="Harga Grosir (Rp)" defaultValue={modalConfig.data?.wholesalePrice} className="w-full p-2 border rounded bg-white text-sm"/>
                                            </div>
                                        </div>
                                    </>}

                                            <button className="w-full bg-blue-600 text-white p-3 rounded-lg font-bold mt-4">Simpan</button>
                                         </>
                                     )}
                                 </form>
                             )}
							 
							 {/* [BARU] MODAL PILIH VARIAN */}
                             {modalConfig.type === 'variant_select' && (
                                <div className="space-y-3">
                                    <div className="text-center mb-4">
                                        <h4 className="font-bold text-lg">{tempVariantProduct?.name}</h4>
                                        <p className="text-sm text-gray-500">Pilih salah satu varian:</p>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        {tempVariantProduct?.variants?.map((v, i) => (
                                            <button key={i} onClick={() => addToCart(tempVariantProduct, v)} className="p-4 border rounded-xl hover:bg-blue-50 hover:border-blue-500 transition text-center">
                                                <div className="font-bold">{v.name}</div>
                                                <div className="text-blue-600 font-bold">{formatCurrency(v.price)}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                             )}
							 
							 {/* [BARU] MODAL PILIH MODIFIER / ADD-ONS */}
                             {modalConfig.type === 'modifier_select' && (
                                <div className="flex flex-col h-[60vh]">
                                    <div className="bg-orange-50 p-3 rounded mb-3 text-center">
                                        <h4 className="font-bold text-gray-800">{tempVariantProduct?.name} {selectedVariantTemp ? `(${selectedVariantTemp.name})` : ''}</h4>
                                        <p className="text-xs text-gray-500">Pilih tambahan (Boleh lebih dari satu)</p>
                                    </div>
                                    
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                                        {tempVariantProduct?.modifiers?.map((m, i) => {
                                            const isSelected = tempModifiers.some(tm => tm.name === m.name);
                                            return (
                                                <div key={i} onClick={()=>{
                                                    if(isSelected) setTempModifiers(prev => prev.filter(x => x.name !== m.name));
                                                    else setTempModifiers(prev => [...prev, m]);
                                                }} className={`p-3 border rounded-xl cursor-pointer flex justify-between items-center transition ${isSelected ? 'bg-orange-100 border-orange-500' : 'hover:bg-gray-50'}`}>
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center ${isSelected ? 'bg-orange-500 border-orange-500' : 'border-gray-400'}`}>
                                                            {isSelected && <Icon name="check" size={14} className="text-white"/>}
                                                        </div>
                                                        <span className="font-bold text-sm">{m.name}</span>
                                                    </div>
                                                    <span className="text-xs font-bold text-orange-600">+{formatCurrency(m.price)}</span>
                                                </div>
                                            );
                                        })}
                                    </div>

                                    <div className="pt-4 border-t mt-2">
                                        <button onClick={() => addToCart(tempVariantProduct, selectedVariantTemp, tempModifiers)} className="w-full bg-orange-600 text-white py-3 rounded-xl font-bold hover:bg-orange-700 flex justify-center gap-2">
                                            <span>Simpan & Masuk Keranjang</span>
                                            {tempModifiers.length > 0 && <span className="bg-white/20 px-2 rounded text-xs py-0.5">+{formatCurrency(tempModifiers.reduce((a,b)=>a+b.price,0))}</span>}
                                        </button>
                                    </div>
                                </div>
                             )}

                             {/* [BARU] MODAL SPLIT BILL */}
                             {modalConfig.type === 'split_bill' && (
                                <div className="flex flex-col h-[60vh]">
                                    <div className="bg-purple-50 p-3 rounded mb-3 text-xs text-purple-800">
                                        Pilih item yang ingin dibayar sekarang. Sisanya akan tetap di keranjang.
                                    </div>
                                    <div className="flex-1 overflow-y-auto space-y-2 pr-2">
                                        {cart.map((item, idx) => (
                                            <label key={idx} className={`flex items-center p-3 border rounded-lg cursor-pointer transition ${splitSelection[idx] ? 'bg-blue-50 border-blue-500' : 'hover:bg-gray-50'}`}>
                                                <input type="checkbox" 
                                                    checked={!!splitSelection[idx]} 
                                                    onChange={e => setSplitSelection({...splitSelection, [idx]: e.target.checked})}
                                                    className="w-5 h-5 text-blue-600 rounded mr-3"
                                                />
                                                <div className="flex-1">
                                                    <div className="font-bold text-sm">{item.name}</div>
                                                    <div className="text-xs text-gray-500">{item.qty} x {formatCurrency(item.price)}</div>
                                                </div>
                                                <div className="font-bold">{formatCurrency(item.price * item.qty)}</div>
                                            </label>
                                        ))}
                                    </div>
                                    <div className="pt-4 border-t mt-2">
                                        <div className="flex justify-between font-bold text-lg mb-4">
                                            <span>Total Split:</span>
                                            <span>
                                                {formatCurrency(cart.reduce((a,b,i) => splitSelection[i] ? a + (b.price * b.qty) : a, 0))}
                                            </span>
                                        </div>
                                        <button onClick={handleSplitCheckout} className="w-full bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700">
                                            Bayar Item Terpilih
                                        </button>
										<button onClick={()=>setModalConfig({show:false})} className="w-full mt-2 py-3 text-gray-500 font-bold hover:bg-gray-100 rounded-xl">Batal</button>
                                    </div>
                                </div>
                             )}
							 
							 {/* [BARU] MODAL VISUAL FLOOR PLAN (DENAH MEJA) */}
                             {modalConfig.type === 'table_map' && (
                                <div className="p-2">
                                    <div className="flex justify-between items-center mb-4 bg-gray-50 p-2 rounded">
                                        <div className="flex gap-4 text-sm">
                                            <div className="flex items-center gap-1"><div className="w-4 h-4 bg-green-100 border border-green-500 rounded"></div> Kosong</div>
                                            <div className="flex items-center gap-1"><div className="w-4 h-4 bg-red-100 border border-red-500 rounded"></div> Terisi</div>
                                            <div className="flex items-center gap-1"><div className="w-4 h-4 bg-yellow-100 border border-yellow-500 rounded animate-pulse"></div> Dipilih</div>
                                        </div>
                                        {isMovingTable && <div className="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded">Mode Pindah Meja</div>}
                                    </div>

                                    <div className="grid grid-cols-3 gap-3 max-h-[60vh] overflow-y-auto">
                                        {tables.map(t => {
                                            // Cek status meja berdasarkan activeOrders
                                            const activeOrder = activeOrders.find(o => o.table?.name === t.name && o.status !== 'completed');
                                            const isOccupied = !!activeOrder;
                                            const isSelected = selectedTable?.name === t.name;

                                            return (
                                                <div key={t.id} 
                                                    onClick={() => {
                                                        if (isMovingTable) {
                                                            handleMoveTable(t);
                                                        } else if (isOccupied) {
                                                            // Jika terisi, tawarkan opsi lihat order / pindah
                                                            if(confirm(`Meja ${t.name} terisi oleh ${activeOrder.cust?.name || 'Umum'}.\n\nKlik OK untuk MEMINDAHKAN meja ini.`)) {
                                                                setIsMovingTable(activeOrder); // Aktifkan mode pindah
                                                                alert(`Silakan klik MEJA KOSONG tujuan untuk memindahkan ${t.name}.`);
                                                            }
                                                        } else {
                                                            // Pilih meja untuk order baru
                                                            setSelectedTable(t);
                                                            setModalConfig({show: false});
                                                        }
                                                    }}
                                                    className={`p-4 rounded-xl border-2 flex flex-col items-center justify-center cursor-pointer transition relative min-h-[100px]
                                                        ${isOccupied 
                                                            ? 'bg-red-50 border-red-500 text-red-700' 
                                                            : (isSelected ? 'bg-yellow-50 border-yellow-500' : 'bg-green-50 border-green-500 text-green-700 hover:bg-green-100')
                                                        }
                                                    `}
                                                >
                                                    <div className="font-bold text-lg">{t.name}</div>
                                                    <div className="text-xs opacity-70">{t.capacity} Kursi</div>
                                                    
                                                    {isOccupied && (
                                                        <div className="absolute bottom-1 w-full text-center text-[10px] font-bold bg-red-200 py-0.5 truncate px-1">
                                                            {activeOrder.cust?.name || 'Umum'}
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        
                                        {/* Tombol Tambah Meja Cepat */}
                                        <div onClick={()=>setModalConfig({show:true, type:'table'})} className="p-4 rounded-xl border-2 border-dashed border-gray-300 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-50 text-gray-400">
                                            <Icon name="plus" size={24}/>
                                            <span className="text-xs mt-1">Tambah</span>
                                        </div>
                                    </div>
                                </div>
                             )}
							 
							 
                        </Modal>
                    )}

                    {scannerContext === 'form' && (
                        <BarcodeScanner onScan={handleScanResult} onClose={()=>setScannerContext(null)} isInline={false} />
                    )}

                    <Receipt data={lastTrans} storeProfile={storeProfile} onClose={()=>setLastTrans(null)} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
