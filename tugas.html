<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Tugas - Yayasan Markaz Yatim Duafa Qurani</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <style>
        :root {
            --primary-color: #2c5e2e;
            --secondary-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --info-color: #0d6efd;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-gray); color: var(--dark-gray); }
        .container { width: 90%; max-width: 1000px; margin: 20px auto; }
        .hidden { display: none !important; }
        .page-header { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .section { background-color: #ffffff; padding: 25px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; border: none; color: white; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #1e4220; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--dark-gray); }
        .btn-secondary:hover { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: #0b5ed7; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
        #editor-container, #submission-editor-container { height: 250px; }
        .ql-toolbar { border-radius: 5px 5px 0 0; }
        .ql-container { border-radius: 0 0 5px 5px; }
        .content-display img { max-width: 100%; height: auto; border-radius: 8px; }
        #messageBox { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 3000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: top 0.5s ease-in-out; }
        #messageBox.show { top: 20px; }
        #messageBox.success { background-color: #28a745; }
        #messageBox.error { background-color: #dc3545; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="messageBox"></div>
    <div id="loading-overlay" class="hidden"><div class="loader"></div></div>

    <div class="container">
        <div class="page-header">
            <h1 class="text-2xl font-bold text-gray-800">Halaman Tugas</h1>
            <a href="index.html" class="btn btn-secondary">Kembali ke Beranda</a>
        </div>

        <div id="initial-view" class="section text-center"><p>Memeriksa sesi login Anda...</p></div>

        <div id="teacher-view" class="hidden">
            <div class="section flex justify-between items-center">
                <h2 class="text-xl font-bold">Dashboard Guru</h2>
                <button id="btn-create-new" class="btn btn-primary">Buat Tugas Baru</button>
            </div>
            <div class="section">
                <h3 class="text-lg font-semibold mb-4">Daftar Tugas yang Telah Dibuat</h3>
                <div id="tugas-list-teacher" class="space-y-3"><p>Memuat daftar tugas...</p></div>
            </div>
        </div>

        <div id="student-view" class="hidden">
             <div class="section">
                <h2 class="text-xl font-bold mb-4">Daftar Tugas</h2>
                <div id="tugas-list-student" class="space-y-3"><p>Memuat daftar tugas...</p></div>
            </div>
        </div>
        
        <div id="form-view" class="hidden section">
            <h2 id="form-title" class="text-xl font-bold mb-6">Buat Tugas Baru</h2>
            <form id="form-tugas">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="input-judul">Judul Tugas</label>
                        <input type="text" id="input-judul" required>
                    </div>
                    <div class="form-group">
                        <label for="input-materi">Untuk Materi Pelajaran</label>
                        <select id="input-materi" required><option value="">Memuat materi...</option></select>
                    </div>
                </div>
                 <div class="form-group">
                    <label for="input-deadline">Batas Waktu Pengumpulan</label>
                    <input type="date" id="input-deadline" required>
                </div>
                <div class="form-group">
                    <label>Instruksi / Soal Tugas</label>
                    <div id="editor-container"></div>
                </div>
                <div class="flex gap-4 mt-8">
                    <button type="submit" class="btn btn-primary">Simpan Tugas</button>
                    <button type="button" id="btn-cancel-form" class="btn btn-secondary">Batal</button>
                </div>
            </form>
        </div>
        
        <div id="submission-view" class="hidden section">
             <h2 id="submission-title" class="text-xl font-bold mb-2"></h2>
             <p class="text-sm text-gray-500 mb-4" id="submission-deadline"></p>
             <div class="p-4 border rounded-lg bg-gray-50 mb-6">
                 <h3 class="font-semibold mb-2">Instruksi Tugas:</h3>
                 <div id="submission-instruction" class="prose content-display"></div>
             </div>
             <form id="form-submission">
                 <input type="hidden" id="submission-tugas-id">
                 <div class="form-group">
                     <label>Jawaban Anda</label>
                     <div id="submission-editor-container"></div>
                 </div>
                 <div class="flex gap-4 mt-8">
                    <button type="submit" class="btn btn-primary">Kirim Jawaban</button>
                    <button type="button" id="btn-cancel-submission" class="btn btn-secondary">Kembali</button>
                </div>
             </form>
        </div>

        <div id="grading-view" class="hidden section">
            <h2 id="grading-title" class="text-xl font-bold mb-4"></h2>
            <div id="submission-list" class="space-y-6"><p>Memuat jawaban santri...</p></div>
            <button id="btn-back-to-teacher-dash" class="btn btn-secondary mt-6">Kembali ke Dashboard</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const CONFIG = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec",
    };
    
    let academicMonthRanges = []; // Diisi saat inisialisasi

    const views = { initial: document.getElementById('initial-view'), teacher: document.getElementById('teacher-view'), student: document.getElementById('student-view'), form: document.getElementById('form-view'), submission: document.getElementById('submission-view'), grading: document.getElementById('grading-view'), };
    const loadingOverlay = document.getElementById('loading-overlay');
    const messageBox = document.getElementById('messageBox');
    
    let editor, submissionEditor;

    const showLoading = () => loadingOverlay.classList.remove('hidden');
    const hideLoading = () => loadingOverlay.classList.add('hidden');
    const showMessage = (message, type = 'error') => { messageBox.textContent = message; messageBox.className = `message-box ${type} show`; setTimeout(() => messageBox.classList.remove('show'), 3500); };
    const getActiveSession = () => JSON.parse(localStorage.getItem('userSession') || sessionStorage.getItem('userSession') || 'null');
    
    function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewId]) views[viewId].classList.remove('hidden'); }
    function initializeEditor(containerId) { return new Quill(containerId, { theme: 'snow', modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], ['link', 'image'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] } }); }
    
    function findAcademicMonthForDate(referenceDateStr) {
        if (!referenceDateStr || !referenceDateStr.includes('-')) return 0;
        const refParts = referenceDateStr.split('-');
        const referenceDate = new Date(refParts[0], refParts[1] - 1, refParts[2]);
        if (academicMonthRanges.length === 0) return 0;
        const foundRange = academicMonthRanges.find(range => referenceDate >= range.start && referenceDate <= range.end);
        return foundRange ? foundRange.month : 0;
    }

    async function checkUserAccess() {
        showView('initial');
        showLoading();
        const session = getActiveSession();

        if (!session || !session.loggedIn) {
            views.initial.innerHTML = '<p class="text-red-500">Anda harus login untuk mengakses halaman ini. Silakan kembali ke <a href="index.html" class="underline">halaman utama</a> untuk login.</p>';
            hideLoading();
            return;
        }

        const user = session.userData;
        const username = user.username;
        const jabatan = (user.jabatan || '').toLowerCase();

        const canTeach = jabatan === 'guru' || ['wawan', 'mia', 'aria', 'admin'].includes(username);
        const canLearn = jabatan === 'santri' || ['wawan', 'admin'].includes(username);

        if (canTeach) { await loadTeacherDashboard(); showView('teacher'); } 
        else if (canLearn) { await loadStudentDashboard(); showView('student'); } 
        else { views.initial.innerHTML = '<p class="text-red-500">Anda tidak memiliki hak akses untuk halaman tugas.</p>'; }
        hideLoading();
    }

    async function loadTeacherDashboard() {
        const container = document.getElementById('tugas-list-teacher');
        container.innerHTML = '<p>Memuat daftar tugas...</p>';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getTugas', for: 'teacher' }) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            container.innerHTML = result.data.length === 0 ? '<p class="text-gray-500">Belum ada tugas yang dibuat.</p>' : '';
            result.data.forEach(tugas => {
                const deadline = new Date(tugas.Deadline).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
                const div = document.createElement('div');
                div.className = 'border p-4 rounded-lg flex justify-between items-center';
                div.innerHTML = `
                    <div>
                        <p class="font-bold">${tugas.Judul}</p>
                        <p class="text-sm text-gray-500">Untuk: ${tugas.KodeMateri || 'Umum'} | Batas Waktu: ${deadline}</p>
                    </div>
                    <div class="flex gap-2">
                        <button class="btn btn-info btn-grade" data-id="${tugas.ID}">Lihat & Nilai (${tugas.JumlahKiriman || 0})</button>
                    </div>`;
                container.appendChild(div);
            });
        } catch (error) { container.innerHTML = `<p class="text-red-500">Gagal memuat tugas: ${error.message}</p>`; }
    }
    
    async function showCreateForm() {
        showView('form');
        document.getElementById('form-title').textContent = 'Buat Tugas Baru';
        document.getElementById('form-tugas').reset();
        if (!editor) editor = initializeEditor('#editor-container');
        editor.setContents([]);

        // Populate dropdown materi
        const materiSelect = document.getElementById('input-materi');
        materiSelect.innerHTML = '<option value="">Memuat materi...</option>';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getRosterData' }) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            const uniqueSubjects = new Map();
            result.data.forEach(item => {
                if (item.subject && item.subject.includes(':')) {
                    const code = item.subject.split(':')[0].trim();
                    if (!uniqueSubjects.has(code)) {
                        uniqueSubjects.set(code, item.subject);
                    }
                }
            });

            materiSelect.innerHTML = '<option value="">-- Pilih Materi Pelajaran --</option>';
            Array.from(uniqueSubjects.entries())
                 .sort((a,b) => a[1].localeCompare(b[1]))
                 .forEach(([code, subject]) => {
                    const option = document.createElement('option');
                    option.value = code;
                    option.textContent = subject;
                    materiSelect.appendChild(option);
            });
        } catch (error) {
            materiSelect.innerHTML = `<option value="">Gagal memuat: ${error.message}</option>`;
        }
    }

    async function handleSaveTugas(event) {
        event.preventDefault(); showLoading();
        const session = getActiveSession();
        const data = {
            action: 'createTugas',
            Judul: document.getElementById('input-judul').value,
            KodeMateri: document.getElementById('input-materi').value,
            Deadline: document.getElementById('input-deadline').value,
            KontenHTML: editor.root.innerHTML,
            DibuatOleh: session.userData.profileName
        };

        if (data.KontenHTML === '<p><br></p>') { showMessage('Instruksi tugas tidak boleh kosong.', 'error'); hideLoading(); return; }

        try {
            const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            showMessage('Tugas berhasil disimpan!', 'success');
            await loadTeacherDashboard();
            showView('teacher');
        } catch (error) { showMessage(`Gagal menyimpan: ${error.message}`, 'error'); } 
        finally { hideLoading(); }
    }

    async function loadStudentDashboard() {
    const container = document.getElementById('tugas-list-student');
    container.innerHTML = '<p>Memuat daftar tugas...</p>';
    try {
        const session = getActiveSession();
        // HAPUS parameter 'bulan' dari data yang dikirim ke backend
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getTugas', 
                for: 'student', 
                username: session.username, 
                namaSantri: session.userData.profileName 
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        container.innerHTML = result.data.length === 0 ? '<p class="text-gray-500">Tidak ada tugas yang relevan untuk Anda saat ini.</p>' : '';
        result.data.forEach(tugas => {
            const deadline = new Date(tugas.Deadline).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            let statusHtml = `<button class="btn btn-info btn-work" data-id="${tugas.ID}">Kerjakan</button>`;
            if (tugas.Status === 'Terkirim') {
                const nilaiText = tugas.Nilai ? `Nilai: ${tugas.Nilai}` : 'Belum Dinilai';
                statusHtml = `<div class="text-sm font-semibold text-green-600">Terkirim (${nilaiText})</div>`;
            }
            const div = document.createElement('div');
            div.className = 'border p-4 rounded-lg flex justify-between items-center';
            div.innerHTML = `
                <div>
                    <p class="font-bold">${tugas.Judul}</p>
                    <p class="text-sm text-gray-500">Untuk: ${tugas.KodeMateri} | Batas Waktu: ${deadline}</p>
                </div>
                <div>${statusHtml}</div>`;
            container.appendChild(div);
        });
    } catch (error) { 
        container.innerHTML = `<p class="text-red-500">Gagal memuat tugas: ${error.message}</p>`; 
    }
}
    
	async function showGradingView(tugasId) { showView('grading'); showLoading(); const container = document.getElementById('submission-list'); container.innerHTML = '<p>Memuat jawaban santri...</p>'; try { const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSubmissions', tugasId: tugasId }) }); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); document.getElementById('grading-title').textContent = `Kiriman untuk Tugas: ${result.tugasJudul || ''}`; container.innerHTML = ''; if (result.data.length === 0) { container.innerHTML = '<p class="text-gray-500">Belum ada santri yang mengirimkan tugas ini.</p>'; return; } result.data.forEach(sub => { const div = document.createElement('div'); div.className = 'border-t pt-6'; div.innerHTML = ` <div class="flex justify-between items-start"> <p class="font-bold">${sub.NamaSantri}</p> <p class="text-sm text-gray-500">Dikirim: ${new Date(sub.Timestamp).toLocaleString('id-ID')}</p> </div> <div class="prose content-display mt-2 p-3 border bg-gray-50 rounded-md">${sub.KontenHTML}</div> <div class="mt-3 flex items-center gap-3"> <label class="font-semibold">Nilai:</label> <input type="number" min="0" max="100" class="w-24 p-2 border rounded" value="${sub.Nilai || ''}" placeholder="0-100"> <button class="btn btn-primary btn-save-grade" data-id="${sub.ID}">Simpan Nilai</button> </div>`; container.appendChild(div); }); } catch (error) { container.innerHTML = `<p class="text-red-500">Gagal memuat kiriman: ${error.message}</p>`; } finally { hideLoading(); } }
     async function handleGradeSubmission(submissionId, nilai, button) { showLoading(); button.disabled = true; try { const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'gradeTugas', submissionId: submissionId, nilai: nilai }) }); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); showMessage('Nilai berhasil disimpan!', 'success'); } catch (error) { showMessage(`Gagal menyimpan nilai: ${error.message}`, 'error'); } finally { hideLoading(); button.disabled = false; } }
     
	
	
    function showSubmissionView(tugasId) {
        showView('submission');
        showLoading();
        document.getElementById('form-submission').reset();
        document.getElementById('submission-tugas-id').value = tugasId;

        // Cari data tugas dari daftar yang sudah dimuat
        const tugasData = Array.from(document.querySelectorAll('#tugas-list-student .border')).find(div => div.querySelector('button')?.dataset.id === tugasId);
        if(tugasData) {
            const judul = tugasData.querySelector('.font-bold').textContent;
            const deadline = tugasData.querySelector('.text-gray-500').textContent;
            document.getElementById('submission-title').textContent = judul;
            document.getElementById('submission-deadline').textContent = deadline;
        }

        // Ambil instruksi detail dari backend
        fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getTugasDetail', tugasId: tugasId }) })
            .then(res => res.json())
            .then(result => {
                if (result.status !== 'success') throw new Error(result.message);
                document.getElementById('submission-instruction').innerHTML = result.data.KontenHTML;
                if(!submissionEditor) submissionEditor = initializeEditor('#submission-editor-container');
                submissionEditor.setContents([]);
            })
            .catch(error => document.getElementById('submission-instruction').innerHTML = `<p class="text-red-500">${error.message}</p>`)
            .finally(() => hideLoading());
    }

    async function handleSubmitTugas(event) {
        event.preventDefault();
        showLoading();
        
        const session = getActiveSession();
        const data = {
            action: 'submitTugas',
            TugasID: document.getElementById('submission-tugas-id').value,
            UsernameSantri: session.username,
            NamaSantri: session.userData.profileName,
            KontenHTML: submissionEditor.root.innerHTML
        };

        if (data.KontenHTML === '<p><br></p>') {
            showMessage('Jawaban tidak boleh kosong.', 'error');
            hideLoading();
            return;
        }

        try {
            const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            showMessage('Tugas berhasil dikirim!', 'success');
            await loadStudentDashboard();
            showView('student');
        } catch (error) {
            showMessage(`Gagal mengirim: ${error.message}`, 'error');
        } finally {
            hideLoading();
        }
    }


    // === Event Listeners ===
    document.getElementById('btn-create-new')?.addEventListener('click', showCreateForm);
    document.getElementById('form-tugas')?.addEventListener('submit', handleSaveTugas);
    document.getElementById('btn-cancel-form')?.addEventListener('click', () => {
        showView('teacher');
        loadTeacherDashboard();
    });
    document.getElementById('btn-back-to-teacher-dash')?.addEventListener('click', () => {
        showView('teacher');
        loadTeacherDashboard();
    });
    
    // Event listener untuk tombol kerjakan/nilai (event delegation)
    document.body.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-grade')) {
            showGradingView(event.target.dataset.id);
        }
        if (event.target.classList.contains('btn-work')) {
            showSubmissionView(event.target.dataset.id);
        }
        if (event.target.classList.contains('btn-save-grade')) {
            const submissionId = event.target.dataset.id;
            const nilaiInput = event.target.previousElementSibling;
            handleGradeSubmission(submissionId, nilaiInput.value, event.target);
        }
    });

    // Event listener untuk form kirim tugas (santri)
    document.getElementById('form-submission')?.addEventListener('submit', handleSubmitTugas);
    document.getElementById('btn-cancel-submission')?.addEventListener('click', () => {
        showView('student');
        loadStudentDashboard();
    });

async function initializeApp() {
    // === Inisialisasi Aplikasi ===
    checkUserAccess();
	}
	 initializeApp();
});
</script>
</body>
</html>