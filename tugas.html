<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Tugas - Yayasan Markaz Yatim Duafa Qurani</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
	
	<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>

    <style>
        :root {
            --primary-color: #2c5e2e;
            --secondary-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --info-color: #0d6efd;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--light-gray); color: var(--dark-gray); }
        .container { width: 90%; max-width: 1000px; margin: 20px auto; }
        .hidden { display: none !important; }
        .page-header { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .section { background-color: #ffffff; padding: 25px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn { padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; border: none; color: white; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #1e4220; }
        .btn-secondary { background-color: var(--secondary-color); color: var(--dark-gray); }
        .btn-secondary:hover { background-color: #e0a800; }
        .btn-info { background-color: var(--info-color); }
        .btn-info:hover { background-color: #0b5ed7; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
        #editor-container, #submission-editor-container { height: 250px; }
        .ql-toolbar { border-radius: 5px 5px 0 0; }
        .ql-container { border-radius: 0 0 5px 5px; }
        .content-display img { max-width: 100%; height: auto; border-radius: 8px; }
        #messageBox { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 3000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: top 0.5s ease-in-out; }
        #messageBox.show { top: 20px; }
        #messageBox.success { background-color: #28a745; }
        #messageBox.error { background-color: #dc3545; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.7); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .loader { border: 8px solid #f3f3f3; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
		@keyframes flash-red-border {
            0%   { border-color: #ef4444; } /* red-500 */
            50%  { border-color: #fecaca; } /* red-200 */
            100% { border-color: #ef4444; }
        }
        .deadline-warning {
            animation: flash-red-border 1.5s infinite;
            border-width: 2px;
            border-style: solid;
        }
		.is-archived {
            display: none; /* Sembunyikan arsip secara default */
            background-color: #f9fafb; /* bg-gray-50 */
            opacity: 0.7;
        }
		
		/* (BARU) CSS untuk Form Tugas Dinamis */
        .dynamic-form-section {
            display: none; /* Sembunyi secara default */
        }
        .dynamic-form-section.active {
            display: block; /* Tampil jika aktif */
        }
        
        /* (BARU) Styling untuk Form Makalah Santri */
        .makalah-field {
            margin-bottom: 20px;
        }
        .makalah-field label {
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
            margin-bottom: 10px;
            display: block;
        }
        .makalah-field textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
        }
        /* (BARU) Styling untuk bagian Pendahuluan (read-only) */
        .makalah-pendahuluan {
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            padding: 15px;
        }
        .makalah-pendahuluan h4 {
            font-weight: 600;
            color: #333;
            margin-top: 0;
            margin-bottom: 8px;
        }
        .makalah-pendahuluan p {
            margin: 0 0 10px 0;
            color: #555;
            white-space: pre-wrap; /* Agar baris baru tetap terlihat */
        }
        
        /* (BARU) Styling untuk Penjelasan Masalah Dinamis */
        .penjelasan-masalah-item {
            position: relative;
            padding-right: 40px; /* Ruang untuk tombol hapus */
            margin-bottom: 10px;
        }
        .btn-hapus-masalah {
            position: absolute;
            top: 5px;
            right: 0;
            background: #dc3545;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            line-height: 30px;
            text-align: center;
        }
		
		/* (BARU) CSS untuk editor-editor di form Makalah Santri */
        .quill-makalah-editor {
            min-height: 150px; /* Beri tinggi minimal */
            border: 1px solid #ced4da;
            border-radius: 5px;
        }
        .quill-makalah-editor .ql-container {
            border-bottom-left-radius: 5px;
            border-bottom-right-radius: 5px;
        }
        .quill-makalah-editor .ql-toolbar {
            border-top-left-radius: 5px;
            border-top-right-radius: 5px;
        }
		
    </style>
</head>
<body>
    <div id="messageBox"></div>
    <div id="loading-overlay" class="hidden"><div class="loader"></div></div>

    <div class="container">
        <div class="page-header justify-start items-center gap-4">
            <a href="index.html" class="btn bg-red-600 hover:bg-red-700">Kembali ke Beranda</a>
            <h1 class="text-2xl font-bold text-gray-800">Halaman Tugas</h1>
        </div>

        <div id="initial-view" class="section text-center"><p>Memeriksa sesi login Anda...</p></div>

        <div id="teacher-view" class="hidden">
            <div class="section flex justify-between items-center">
                <h2 class="text-xl font-bold">Dashboard Guru</h2>
                <button id="btn-create-new" class="btn btn-primary">Buat Tugas Baru</button>
            </div>
            <div class="section">
                <h3 class="text-lg font-semibold mb-4">Daftar Tugas yang Telah Dibuat</h3>

                <div class="text-right mb-4">
                    <button id="btn-toggle-archive-teacher" class="text-sm text-blue-600 hover:underline">
                        Tampilkan Arsip Tugas (0)
                    </button>
                </div>
                <div id="tugas-list-teacher" class="space-y-3"><p>Memuat daftar tugas...</p></div>
            </div>
        </div>

        <div id="student-view" class="hidden">
             <div class="section">
                <h2 class="text-xl font-bold mb-4">Daftar Tugas</h2>
                
                <div class="text-right mb-4">
                    <button id="btn-toggle-archive" class="text-sm text-blue-600 hover:underline">
                        Tampilkan Arsip Tugas (0)
                    </button>
                </div>
                <div id="tugas-list-student" class="space-y-3"><p>Memuat daftar tugas...</p></div>
            </div>
        </div>
        
        <div id="form-view" class="hidden section">
    <h2 id="form-title" class="text-xl font-bold mb-6">Buat Tugas Baru</h2>
    <form id="form-tugas">
        <div class="form-group">
            <label for="input-jenis-tugas">Jenis Tugas</label>
            <select id="input-jenis-tugas" required>
                <option value="Essay">Essay (Default)</option>
                <option value="Makalah">Makalah</option>
                <option value="Proposal">Proposal</option>
                <option value="Pilihan Ganda">Pilihan Ganda</option>
                <option value="Praktik">Praktik</option>
                <option value="Presentasi">Presentasi</option>
                <option value="Tugas Lainnya">Tugas Lainnya</option>
            </select>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="form-group">
                <label for="input-judul">Judul Tugas</label>
                <input type="text" id="input-judul" required>
            </div>
            <div class="form-group">
                <label for="input-materi">Untuk Materi Pelajaran</label>
                <select id="input-materi" required><option value="">Memuat materi...</option></select>
            </div>
        </div>
         <div class="form-group">
            <label for="input-deadline">Batas Waktu Pengumpulan</label>
            <input type="date" id="input-deadline" required>
        </div>
        
        <div id="essay-form-fields" class="dynamic-form-section active">
            <div class="form-group">
                <label>Instruksi / Soal Tugas</label>
                <div id="editor-container"></div>
            </div>
        </div>
        
        <div id="makalah-form-fields" class="dynamic-form-section">
            <div class="form-group">
                <label for="input-makalah-penjelasan">Penjelasan Tugas (Latar Belakang)</label>
                <textarea id="input-makalah-penjelasan" rows="5" class="w-full p-3 border rounded-md"></textarea>
            </div>
            <div class="form-group">
                <label for="input-makalah-masalah">Permasalahan (Apa yang harus dicari santri)</label>
                <textarea id="input-makalah-masalah" rows="5" class="w-full p-3 border rounded-md"></textarea>
            </div>
            <div class="form-group">
                <label for="input-makalah-tujuan">Tujuan Tugas</label>
                <textarea id="input-makalah-tujuan" rows="3" class="w-full p-3 border rounded-md"></textarea>
            </div>
        </div>
        
        <div class="flex gap-4 mt-8">
            <button type="submit" class="btn btn-primary">Simpan Tugas</button>
            <button type="button" id="btn-cancel-form" class="btn btn-secondary">Batal</button>
        </div>
    </form>
</div>
        
        <div id="submission-view" class="hidden section">
     <button type="button" id="btn-cancel-submission-top" class="btn btn-secondary float-right">Kembali ke Daftar Tugas</button>
     
     <h2 id="submission-title" class="text-xl font-bold mb-2"></h2>
     <p class="text-sm text-gray-500 mb-4" id="submission-deadline"></p>
     
     <div class="p-4 border rounded-lg bg-gray-50 mb-6">
         <h3 class="font-semibold mb-2">Instruksi Tugas:</h3>
         <div id="submission-instruction" class="prose content-display"></div>
     </div>
     
     <form id="form-submission">
         <input type="hidden" id="submission-tugas-id">
         <input type="hidden" id="submission-jenis-tugas"> <div id="essay-submission-fields" class="dynamic-form-section active">
             <div class="form-group">
                 <label>Jawaban Anda</label>
                 <div id="submission-editor-container"></div>
             </div>
         </div>
         
         <div id="makalah-submission-fields" class="dynamic-form-section">
            <div class="makalah-field">
                <label for="makalah-cover">Cover (Judul, Nama, Kelas)</label>
                <div id="makalah-cover" class="quill-makalah-editor"></div>
            </div>
            <div class="makalah-field">
                <label for="makalah-pengantar">Kata Pengantar</label>
                <div id="makalah-pengantar" class="quill-makalah-editor"></div>
            </div>
            
            <div class="makalah-field">
                <label>Pendahuluan (Dari Guru)</label>
                <div id="makalah-pendahuluan" class="makalah-pendahuluan">
                    </div>
            </div>
            
            <div class="makalah-field">
                <label>Pembahasan Masalah</label>
                <div id="penjelasan-masalah-container">
                    </div>
                <button type="button" id="btn-tambah-masalah" class="btn btn-info mt-2">+ Tambah Bagian Pembahasan</button>
            </div>
            
             <div class="makalah-field">
                <label for="makalah-kesimpulan">Kesimpulan dan Saran</label>
                <div id="makalah-kesimpulan" class="quill-makalah-editor"></div>
            </div>
             <div class="makalah-field">
                <label for="makalah-pustaka">Sumber (Daftar Pustaka)</label>
                <div id="makalah-pustaka" class="quill-makalah-editor"></div>
            </div>
         </div>
         
         <div class="flex gap-4 mt-8">
            <button type="submit" class="btn btn-primary">Kirim Jawaban</button>
            <button type="button" id="btn-cancel-submission" class="btn btn-secondary">Kembali ke Daftar Tugas</button>
        </div>
     </form>
</div>

        <div id="grading-view" class="hidden section">
            <button id="btn-back-to-teacher-dash-top" class="btn btn-secondary float-right">Kembali ke Daftar Tugas</button>
            
            <h2 id="grading-title" class="text-xl font-bold mb-4"></h2>
            <div id="submission-list" class="space-y-6"><p>Memuat jawaban santri...</p></div>
            <button id="btn-back-to-teacher-dash" class="btn btn-secondary mt-6">Kembali ke Daftar Tugas</button>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const CONFIG = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec",
    };
    
    let academicMonthRanges = []; // Diisi saat inisialisasi

    const views = { initial: document.getElementById('initial-view'), teacher: document.getElementById('teacher-view'), student: document.getElementById('student-view'), form: document.getElementById('form-view'), submission: document.getElementById('submission-view'), grading: document.getElementById('grading-view'), };
    const loadingOverlay = document.getElementById('loading-overlay');
    const messageBox = document.getElementById('messageBox');
    
    let editor, submissionEditor;
	let makalahEditors = {}; // Untuk menyimpan semua instance editor makalah
    let isFormDirty = false;  // Untuk melacak perubahan form

    const showLoading = () => loadingOverlay.classList.remove('hidden');
    const hideLoading = () => loadingOverlay.classList.add('hidden');
    const showMessage = (message, type = 'error') => { messageBox.textContent = message; messageBox.className = `message-box ${type} show`; setTimeout(() => messageBox.classList.remove('show'), 3500); };
    const getActiveSession = () => JSON.parse(localStorage.getItem('userSession') || sessionStorage.getItem('userSession') || 'null');
    
    function showView(viewId) { Object.values(views).forEach(v => v.classList.add('hidden')); if(views[viewId]) views[viewId].classList.remove('hidden'); }
    function initializeEditor(containerId) { return new Quill(containerId, { theme: 'snow', modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], ['link', 'image', 'formula'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] } }); }
    
	function addPenjelasanMasalah(nomor, konten = '') {
        const container = document.getElementById('penjelasan-masalah-container');
        const newItem = document.createElement('div');
        newItem.className = 'penjelasan-masalah-item';
        const newEditorId = `makalah-masalah-${nomor}`; // ID unik untuk div

        // (DIUBAH) Buat div untuk Quill, bukan textarea
        newItem.innerHTML = `
            <div id="${newEditorId}" class="quill-makalah-editor">${konten}</div>
            <button type="button" class="btn-hapus-masalah" data-id="${newEditorId}">Ã—</button>
        `;
        container.appendChild(newItem);

        // (BARU) Inisialisasi Quill untuk editor baru
        const newEditor = initializeEditor(`#${newEditorId}`);
        makalahEditors[newEditorId] = newEditor; // Simpan instance editor
        
        // (BARU) Pasang listener untuk 'form dirty' (Request 2)
        newEditor.on('text-change', () => { isFormDirty = true; });

        // Pasang listener ke tombol hapus
        newItem.querySelector('.btn-hapus-masalah').addEventListener('click', (e) => {
            if (document.querySelectorAll('.penjelasan-masalah-item').length > 1) {
                const editorId = e.target.dataset.id;
                delete makalahEditors[editorId]; // Hapus instance editor dari object
                e.target.closest('.penjelasan-masalah-item').remove();
            } else {
                showMessage('Minimal harus ada satu bagian pembahasan.', 'error');
            }
        });
    }

// (BARU) Fungsi untuk menggabungkan jawaban Makalah
function combineMakalahAnswers() {
        let html = '';
        
        const addSection = (title, contentHtml) => {
            // Cek jika konten BUKAN default Quill (<p><br></p>)
            if (contentHtml && contentHtml !== '<p><br></p>') {
                // Tidak perlu replace \n, karena Quill sudah menghasilkan HTML
                html += `<h2>${title}</h2><div>${contentHtml}</div><br /><hr /><br />`;
            }
        };

        // (DIUBAH) Ambil konten dari editor Quill
        addSection('Cover', makalahEditors.cover.root.innerHTML);
        addSection('Kata Pengantar', makalahEditors.pengantar.root.innerHTML);
        
        // Ambil Pendahuluan (yang read-only)
        const pendahuluanEl = document.getElementById('makalah-pendahuluan');
        html += `<h2>Pendahuluan (Instruksi Guru)</h2>
                 <div style="background:#f4f4f4; padding:10px; border-radius:5px;">
                   <h4>Latar Belakang:</h4>
                   <p>${pendahuluanEl.querySelector('#guru-penjelasan').innerHTML}</p>
                   <h4>Permasalahan:</h4>
                   <p>${pendahuluanEl.querySelector('#guru-masalah').innerHTML}</p>
                   <h4>Tujuan:</h4>
                   <p>${pendahuluanEl.querySelector('#guru-tujuan').innerHTML}</p>
                 </div><br /><hr /><br />`;
        
        // Ambil semua Pembahasan Masalah
        Object.keys(makalahEditors).forEach(key => {
            if (key.startsWith('makalah-masalah-')) {
                const nomor = key.split('-')[2];
                addSection(`Pembahasan Masalah ${nomor}`, makalahEditors[key].root.innerHTML);
            }
        });

        // (DIUBAH) Ambil konten dari editor Quill
        addSection('Kesimpulan dan Saran', makalahEditors.kesimpulan.root.innerHTML);
        addSection('Daftar Pustaka', makalahEditors.pustaka.root.innerHTML);

        return html;
    }
	
    function findAcademicMonthForDate(referenceDateStr) {
        if (!referenceDateStr || !referenceDateStr.includes('-')) return 0;
        const refParts = referenceDateStr.split('-');
        const referenceDate = new Date(refParts[0], refParts[1] - 1, refParts[2]);
        if (academicMonthRanges.length === 0) return 0;
        const foundRange = academicMonthRanges.find(range => referenceDate >= range.start && referenceDate <= range.end);
        return foundRange ? foundRange.month : 0;
    }

    async function checkUserAccess() {
        showView('initial');
        showLoading();
        const session = getActiveSession();

        if (!session || !session.loggedIn) {
            views.initial.innerHTML = '<p class="text-red-500">Anda harus login untuk mengakses halaman ini. Silakan kembali ke <a href="index.html" class="underline">halaman utama</a> untuk login.</p>';
            hideLoading();
            return;
        }

        const user = session.userData;
        const username = user.username;
        const jabatan = (user.jabatan || '').toLowerCase();

        const canTeach = jabatan === 'guru' || ['wawan', 'mia', 'aria', 'admin'].includes(username);
        const canLearn = jabatan === 'santri' || ['wawan', 'admin'].includes(username);

        if (canTeach) { await loadTeacherDashboard(); showView('teacher'); } 
        else if (canLearn) { await loadStudentDashboard(); showView('student'); } 
        else { views.initial.innerHTML = '<p class="text-red-500">Anda tidak memiliki hak akses untuk halaman tugas.</p>'; }
        hideLoading();
    }

    async function loadTeacherDashboard() {
    const container = document.getElementById('tugas-list-teacher');
    const archiveBtn = document.getElementById('btn-toggle-archive-teacher'); 
    container.innerHTML = '<p>Memuat daftar tugas...</p>';
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getTugas', for: 'teacher' }) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        container.innerHTML = result.data.length === 0 ? '<p class="text-gray-500">Belum ada tugas yang dibuat.</p>' : '';
        
        const now = new Date();
        now.setHours(0,0,0,0);
        let archivedCount = 0;

        result.data.forEach(tugas => {
            const deadline = new Date(tugas.Deadline);
            deadline.setHours(23, 59, 59, 999);
            const deadlineString = deadline.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            const totalKiriman = tugas.JumlahKiriman || 0;
            const totalDinilai = tugas.JumlahDinilai || 0;
            const allGraded = (totalKiriman > 0 && totalKiriman === totalDinilai);
            const partiallyGraded = (totalDinilai > 0 && totalKiriman > totalDinilai);

            const diffTime = now - deadline;
            const daysPassed = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const isArchived = (allGraded && daysPassed > 14);

            let buttonHtml = '';
            let buttonText = '';
            let buttonColorClass = '';

            if (totalKiriman === 0) {
                buttonText = `Lihat & Nilai (0)`;
                buttonColorClass = 'btn-secondary'; 
            } else if (allGraded) {
                buttonText = `Sudah Dinilai (${totalDinilai})`;
                buttonColorClass = 'bg-gray-500 hover:bg-gray-600 text-white'; 
            } else if (partiallyGraded) {
                buttonText = `Dinilai Sebagian (${totalDinilai}/${totalKiriman})`;
                buttonColorClass = 'btn-info'; 
            } else {
                buttonText = `Lihat & Nilai (${totalKiriman})`;
                buttonColorClass = 'btn-info'; 
            }
            
            buttonHtml = `<button class="btn btn-grade ${buttonColorClass}" data-id="${tugas.ID}">
                              ${buttonText}
                          </button>`;
            
            const editButton = `<button class="btn btn-secondary btn-edit-tugas" data-id="${tugas.ID}">Edit</button>`;

            const div = document.createElement('div');
            div.className = 'border p-4 rounded-lg flex justify-between items-center';
            
            if (isArchived) {
                div.classList.add('is-archived');
                
                // --- (PERBAIKAN BUG DI SINI) ---
                // Secara paksa sembunyikan elemen ini saat pertama kali dibuat
                div.style.display = 'none'; 
                // --- AKHIR PERBAIKAN ---

                archivedCount++;
            }

            div.innerHTML = `
                <div>
                    <p class="font-bold">${tugas.Judul}</p>
                    <p class="text-sm text-gray-500">Untuk: ${tugas.KodeMateri || 'Umum'} | Batas Waktu: ${deadlineString}</p>
                </div>
                <div class="flex gap-2">
                    ${editButton}
                    ${buttonHtml}
                </div>`;
            container.appendChild(div);
        });

        // Update teks tombol arsip
        archiveBtn.textContent = `Tampilkan Arsip Tugas (${archivedCount})`;
        archiveBtn.dataset.state = "hidden";

    } catch (error) { 
        container.innerHTML = `<p class="text-red-500">Gagal memuat tugas: ${error.message}</p>`; 
    }
}
    
    async function showCreateForm(isEditing = false) { 
        showView('form');
        document.getElementById('form-title').textContent = 'Buat Tugas Baru';
        
        isFormDirty = false; // (BARU) Reset status

        if (!editor) editor = initializeEditor('#editor-container');
        
        const jenisTugasSelect = document.getElementById('input-jenis-tugas');
        const essayFields = document.getElementById('essay-form-fields');
        const makalahFields = document.getElementById('makalah-form-fields');
        
        if (!isEditing) {
            document.getElementById('form-tugas').reset();
            if (editor) editor.setContents([]);
            jenisTugasSelect.value = "Essay"; 
        }
        
        essayFields.classList.add('active');
        makalahFields.classList.remove('active');

        jenisTugasSelect.removeEventListener('change', handleJenisTugasChange);
        jenisTugasSelect.addEventListener('change', handleJenisTugasChange);
        
        // --- (BARU) Pasang listener 'dirty' ---
        editor.on('text-change', () => { isFormDirty = true; });
        document.getElementById('input-judul').oninput = () => { isFormDirty = true; };
        document.getElementById('input-deadline').oninput = () => { isFormDirty = true; };
        document.getElementById('input-makalah-penjelasan').oninput = () => { isFormDirty = true; };
        document.getElementById('input-makalah-masalah').oninput = () => { isFormDirty = true; };
        document.getElementById('input-makalah-tujuan').oninput = () => { isFormDirty = true; };
        // --- AKHIR BLOK BARU ---


        // Populate dropdown materi (Logic tetap sama)
        const materiSelect = document.getElementById('input-materi');
        materiSelect.innerHTML = '<option value="">Memuat materi...</option>';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getRosterData' }) });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            const uniqueSubjects = new Map();
            result.data.forEach(item => { if (item.subject && item.subject.includes(':')) { const code = item.subject.split(':')[0].trim(); if (!uniqueSubjects.has(code)) { uniqueSubjects.set(code, item.subject); } } });
            materiSelect.innerHTML = '<option value="">-- Pilih Materi Pelajaran --</option>';
            Array.from(uniqueSubjects.entries()).sort((a,b) => a[1].localeCompare(b[1])).forEach(([code, subject]) => { const option = document.createElement('option'); option.value = code; option.textContent = subject; materiSelect.appendChild(option); });
        } catch (error) {
            materiSelect.innerHTML = `<option value="">Gagal memuat: ${error.message}</option>`;
        }
    }

function handleJenisTugasChange() {
    const jenis = document.getElementById('input-jenis-tugas').value;
    const essayFields = document.getElementById('essay-form-fields');
    const makalahFields = document.getElementById('makalah-form-fields');

    // Sembunyikan semua
    essayFields.classList.remove('active');
    makalahFields.classList.remove('active');

    // Tampilkan yang relevan
    if (jenis === 'Makalah') {
        makalahFields.classList.add('active');
    } else {
        // Default ke Essay (untuk Essay, Praktik, Presentasi, dll)
        essayFields.classList.add('active');
    }
}

    async function handleSaveTugas(event) {
    event.preventDefault();

    if (isFormDirty) { // (BARU) Hanya setel false jika memang dirty
        isFormDirty = false; // (BARU) Nonaktifkan peringatan
    }

    showLoading();
    // ... (sisa kodenya sama persis) ...
    const form = event.target;
    const tugasIdInput = form.querySelector('input[name="tugasId"]');
    const isEditing = tugasIdInput && tugasIdInput.value;
    const jenisTugas = document.getElementById('input-jenis-tugas').value;
    const session = getActiveSession();
    const data = {
        action: isEditing ? 'updateTugas' : 'createTugas',
        Judul: document.getElementById('input-judul').value,
        KodeMateri: document.getElementById('input-materi').value,
        Deadline: document.getElementById('input-deadline').value,
        DibuatOleh: session.userData.profileName,
        JenisTugas: jenisTugas
    };
    if (isEditing) { data.tugasId = tugasIdInput.value; }
    if (jenisTugas === 'Makalah') {
        const makalahData = {
            penjelasan: document.getElementById('input-makalah-penjelasan').value,
            masalah: document.getElementById('input-makalah-masalah').value,
            tujuan: document.getElementById('input-makalah-tujuan').value
        };
        data.KontenHTML = JSON.stringify(makalahData);
    } else {
        data.KontenHTML = editor.root.innerHTML;
        if (data.KontenHTML === '<p><br></p>') {
            showMessage('Instruksi tugas tidak boleh kosong.', 'error');
            hideLoading();
            isFormDirty = true; // (BARU) Gagal simpan, aktifkan lagi
            return;
        }
    }
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        showMessage(`Tugas berhasil ${isEditing ? 'diperbarui' : 'disimpan'}!`, 'success');
        if (tugasIdInput) { tugasIdInput.value = ''; }
        await loadTeacherDashboard();
        showView('teacher');
    } catch (error) {
        showMessage(`Gagal menyimpan: ${error.message}`, 'error');
        isFormDirty = true; // (BARU) Gagal simpan, aktifkan lagi
    } finally {
        hideLoading();
    }
}
	
	async function showEditForm(tugasId) {
    showLoading();
    await showCreateForm(true); // Panggil form, tapi tandai sebagai mode edit
    showView('form'); 

    const form = document.getElementById('form-tugas');
    let idInput = form.querySelector('input[name="tugasId"]');
    if (!idInput) {
        idInput = document.createElement('input');
        idInput.type = 'hidden';
        idInput.name = 'tugasId';
        form.appendChild(idInput);
    }
    idInput.value = tugasId;

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getTugasDetail', tugasId: tugasId }) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        const tugas = result.data;
        document.getElementById('form-title').textContent = 'Edit Tugas';
        document.getElementById('input-judul').value = tugas.Judul;
        document.getElementById('input-deadline').value = new Date(tugas.Deadline).toISOString().split('T')[0];

        // (BARU) Set Jenis Tugas dan picu listener-nya
        const jenisTugasSelect = document.getElementById('input-jenis-tugas');
        jenisTugasSelect.value = tugas.JenisTugas || 'Essay';
        handleJenisTugasChange(); // Panggil ini untuk menampilkan form yang benar

        // (BARU) Isi form sesuai JenisTugas
        if (tugas.JenisTugas === 'Makalah') {
            try {
                const makalahData = JSON.parse(tugas.KontenHTML);
                document.getElementById('input-makalah-penjelasan').value = makalahData.penjelasan || '';
                document.getElementById('input-makalah-masalah').value = makalahData.masalah || '';
                document.getElementById('input-makalah-tujuan').value = makalahData.tujuan || '';
            } catch(e) {
                console.error("Gagal parse JSON Makalah:", e);
            }
        } else {
            // Jika Essay (atau lainnya), isi editor
            if (!editor) editor = initializeEditor('#editor-container');
            editor.root.innerHTML = tugas.KontenHTML;
        }

        setTimeout(() => {
            document.getElementById('input-materi').value = tugas.KodeMateri;
        }, 100); 

    } catch (error) {
        showMessage(`Gagal memuat data tugas: ${error.message}`, 'error');
        showView('teacher');
    } finally {
        hideLoading();
    }
}


    async function loadStudentDashboard() {
    const container = document.getElementById('tugas-list-student');
    const archiveBtn = document.getElementById('btn-toggle-archive');
    container.innerHTML = '<p>Memuat daftar tugas...</p>';
    
    try {
        const session = getActiveSession();
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getTugas', 
                for: 'student', 
                username: session.username, 
                namaSantri: session.userData.profileName 
            })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        container.innerHTML = result.data.length === 0 ? '<p class="text-gray-500">Tidak ada tugas yang relevan untuk Anda saat ini.</p>' : '';
        
        const now = new Date();
        now.setHours(0,0,0,0);
        let archivedCount = 0;

        result.data.forEach(tugas => {
            const deadlineDate = new Date(tugas.Deadline);
            deadlineDate.setHours(23, 59, 59, 999);
            const sudahDinilai = (tugas.Nilai !== null && tugas.Nilai !== undefined && tugas.Nilai !== '');
            const diffTime = now - deadlineDate;
            const daysPassed = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            // (PERBAIKAN DI SINI) Tentukan status 'Gagal'
            const isGagal = (tugas.Status === 'Gagal');

            // (PERBAIKAN - REQ 2) Logika Arsip baru
            const isArchived = (sudahDinilai && daysPassed > 14) || // Tugas lama yang sudah dinilai
                               (isGagal); // (BARU) Tugas yang Gagal (lewat deadline, 0)
            
            const deadlineString = deadlineDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            let statusHtml = '';

            if (tugas.Status === 'Terkirim') {
                const lewatBatasWaktu = now > deadlineDate;
                if (sudahDinilai) {
                    statusHtml = `<button class="btn bg-gray-400 text-gray-800 cursor-not-allowed" disabled>Selesai (Nilai: ${tugas.Nilai})</button>`;
                } else if (lewatBatasWaktu) {
                    statusHtml = `<div class="text-sm font-semibold text-red-500">Batas Waktu Habis</div>`;
                } else {
                    statusHtml = `<button class="btn btn-secondary btn-edit-jawaban" data-id="${tugas.ID}" data-submission-id="${tugas.SubmissionID}">Edit Jawaban</button>`;
                }
            } else if (isGagal) { // (PERBAIKAN) Gunakan status 'Gagal'
                statusHtml = `<button class="btn bg-red-600 text-white cursor-not-allowed" disabled>Tugas Tidak Selesai (Nilai: 0)</button>`;
            } else { // Status 'Belum Dikerjakan'
                statusHtml = `<button class="btn btn-info btn-work" data-id="${tugas.ID}">Kerjakan</button>`;
            }

            const div = document.createElement('div');
            div.className = 'border p-4 rounded-lg flex justify-between items-center';
            
            if (isArchived) {
                div.classList.add('is-archived');
                div.style.display = 'none'; 
                archivedCount++;
            }

            const diffDaysUntilDeadline = Math.ceil((deadlineDate - now) / (1000 * 60 * 60 * 24));
            if (tugas.Status === 'Belum Dikerjakan' && diffDaysUntilDeadline <= 2 && diffDaysUntilDeadline >= 0) {
                div.classList.add('deadline-warning');
            }

            div.innerHTML = `
                <div>
                    <p class="font-bold">${tugas.Judul}</p>
                    <p class="text-sm text-gray-500">Untuk: ${tugas.KodeMateri} | Batas Waktu: ${deadlineString}</p>
                </div>
                <div>${statusHtml}</div>`;
            container.appendChild(div);
        });

        archiveBtn.textContent = `Tampilkan Arsip Tugas (${archivedCount})`;
        archiveBtn.dataset.state = "hidden";

    } catch (error) { 
        container.innerHTML = `<p class="text-red-500">Gagal memuat tugas: ${error.message}</p>`; 
    }
}

async function fetchGradingNotifications() {
    try {
        const session = getActiveSession();
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getGradingNotifications',
                profileName: session.userData.profileName
            })
        });
        const result = await response.json();
        if (result.status === 'success' && result.count > 0) {
            const wrapper = document.querySelector('#tugasNav .nav-link-wrapper');
            if (wrapper) {
                const oldDot = wrapper.querySelector('.notification-dot');
                if (oldDot) oldDot.remove(); // Hapus dot lama jika ada
                
                const dot = document.createElement('span');
                dot.className = 'notification-dot';
                dot.textContent = result.count;
                wrapper.appendChild(dot);
            }
        }
    } catch (error) {
        console.error("Gagal mengambil notifikasi grading:", error);
    }
}

async function showEditJawabanForm(tugasId, submissionId) {
    showView('submission');
    showLoading();
    document.getElementById('form-submission').reset();

    // Simpan ID tugas dan ID jawaban di form
    document.getElementById('submission-tugas-id').value = tugasId;
    
    const form = document.getElementById('form-submission');
    let submissionIdInput = form.querySelector('input[name="submissionId"]');
    if (!submissionIdInput) {
        submissionIdInput = document.createElement('input');
        submissionIdInput.type = 'hidden';
        submissionIdInput.name = 'submissionId';
        form.appendChild(submissionIdInput);
    }
    submissionIdInput.value = submissionId;

    try {
        // Ambil detail instruksi tugas DAN jawaban lama dari backend
        const response = await fetch(CONFIG.SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: 'getTugasDanJawabanDetail', tugasId: tugasId, submissionId: submissionId }) 
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        // Tampilkan instruksi
        document.getElementById('submission-title').textContent = result.data.tugas.Judul;
        document.getElementById('submission-deadline').textContent = `Batas Waktu: ${new Date(result.data.tugas.Deadline).toLocaleDateString('id-ID')}`;
        document.getElementById('submission-instruction').innerHTML = result.data.tugas.KontenHTML;
        
        // Tampilkan jawaban lama di editor
        if(!submissionEditor) submissionEditor = initializeEditor('#submission-editor-container');
        submissionEditor.root.innerHTML = result.data.jawaban.KontenHTML;

    } catch (error) {
        showMessage(`Gagal memuat data: ${error.message}`, 'error');
        showView('student');
    } finally {
        hideLoading();
    }
}

    
	async function showGradingView(tugasId) { showView('grading'); showLoading(); const container = document.getElementById('submission-list'); container.innerHTML = '<p>Memuat jawaban santri...</p>'; try { const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSubmissions', tugasId: tugasId }) }); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); document.getElementById('grading-title').textContent = `Kiriman untuk Tugas: ${result.tugasJudul || ''}`; container.innerHTML = ''; if (result.data.length === 0) { container.innerHTML = '<p class="text-gray-500">Belum ada santri yang mengirimkan tugas ini.</p>'; return; } result.data.forEach(sub => { const div = document.createElement('div'); div.className = 'border-t pt-6'; div.innerHTML = ` <div class="flex justify-between items-start"> <p class="font-bold">${sub.NamaSantri}</p> <p class="text-sm text-gray-500">Dikirim: ${new Date(sub.Timestamp).toLocaleString('id-ID')}</p> </div> <div class="prose content-display mt-2 p-3 border bg-gray-50 rounded-md">${sub.KontenHTML}</div> <div class="mt-3 flex items-center gap-3"> <label class="font-semibold">Nilai:</label> <input type="number" min="0" max="100" class="w-24 p-2 border rounded" value="${sub.Nilai || ''}" placeholder="0-100"> <button class="btn btn-primary btn-save-grade" data-id="${sub.ID}">Simpan Nilai</button> </div>`; container.appendChild(div); }); } catch (error) { container.innerHTML = `<p class="text-red-500">Gagal memuat kiriman: ${error.message}</p>`; } finally { hideLoading(); } }
     async function handleGradeSubmission(submissionId, nilai, button) { showLoading(); button.disabled = true; try { const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'gradeTugas', submissionId: submissionId, nilai: nilai }) }); const result = await response.json(); if (result.status !== 'success') throw new Error(result.message); showMessage('Nilai berhasil disimpan!', 'success'); } catch (error) { showMessage(`Gagal menyimpan nilai: ${error.message}`, 'error'); } finally { hideLoading(); button.disabled = false; } }
     
	
	
    function showSubmissionView(tugasId) {
        showView('submission');
        showLoading();
        isFormDirty = false; // (BARU) Reset status

        document.getElementById('form-submission').reset();
        document.getElementById('submission-tugas-id').value = tugasId;

        const essayFields = document.getElementById('essay-submission-fields');
        const makalahFields = document.getElementById('makalah-submission-fields');
        const instructionContainer = document.getElementById('submission-instruction');
        const pendahuluanContainer = document.getElementById('makalah-pendahuluan');
        
        essayFields.classList.remove('active');
        makalahFields.classList.remove('active');

        // (BARU) Hapus semua editor makalah lama
        Object.values(makalahEditors).forEach(editor => {
            if (editor && typeof editor.disable === 'function') {
                editor.disable();
            }
        });
        makalahEditors = {};

        fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getTugasDetail', tugasId: tugasId }) })
            .then(res => res.json())
            .then(result => {
                if (result.status !== 'success') throw new Error(result.message);
                
                const tugas = result.data;
                document.getElementById('submission-title').textContent = tugas.Judul;
                document.getElementById('submission-deadline').textContent = `Batas Waktu: ${new Date(tugas.Deadline).toLocaleDateString('id-ID')}`;
                document.getElementById('submission-jenis-tugas').value = tugas.JenisTugas;

                if (tugas.JenisTugas === 'Makalah') {
                    makalahFields.classList.add('active');
                    instructionContainer.innerHTML = 'Silakan isi formulir makalah di bawah ini.';
                    try {
                        const makalahData = JSON.parse(tugas.KontenHTML);
                        pendahuluanContainer.innerHTML = `
                            <h4>Latar Belakang:</h4>
                            <p id="guru-penjelasan">${makalahData.penjelasan || ''}</p>
                            <h4>Permasalahan:</h4>
                            <p id="guru-masalah">${makalahData.masalah || ''}</p>
                            <h4>Tujuan:</h4>
                            <p id="guru-tujuan">${makalahData.tujuan || ''}</p>
                        `;
                    } catch (e) {
                        pendahuluanContainer.innerHTML = '<p class="text-red-500">Gagal memuat instruksi makalah.</p>';
                    }
                    
                    document.getElementById('penjelasan-masalah-container').innerHTML = '';
                    
                    makalahEditors.cover = initializeEditor('#makalah-cover');
                    makalahEditors.pengantar = initializeEditor('#makalah-pengantar');
                    makalahEditors.kesimpulan = initializeEditor('#makalah-kesimpulan');
                    makalahEditors.pustaka = initializeEditor('#makalah-pustaka');
                    addPenjelasanMasalah(1); 

                    // (BARU) Pasang listener 'dirty'
                    Object.values(makalahEditors).forEach(editor => {
                        editor.on('text-change', () => { isFormDirty = true; });
                    });

                } else {
                    essayFields.classList.add('active');
                    instructionContainer.innerHTML = tugas.KontenHTML;
                    if(!submissionEditor) submissionEditor = initializeEditor('#submission-editor-container');
                    submissionEditor.setContents([]);
                    
                    // (BARU) Pasang listener 'dirty'
                    submissionEditor.on('text-change', () => { isFormDirty = true; });
                }
            })
            .catch(error => instructionContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`)
            .finally(() => hideLoading());
    }

    async function handleSubmitTugas(event) {
    event.preventDefault();

    if (isFormDirty) { // (BARU) Hanya setel false jika memang dirty
        isFormDirty = false; // (BARU) Nonaktifkan peringatan
    }

    showLoading();
    // ... (sisa kodenya sama persis) ...
    const form = event.target;
    const submissionIdInput = form.querySelector('input[name="submissionId"]');
    const isEditing = submissionIdInput && submissionIdInput.value;
    const jenisTugas = document.getElementById('submission-jenis-tugas').value;
    const session = getActiveSession();
    const data = {
        action: isEditing ? 'updateJawaban' : 'submitTugas',
        TugasID: document.getElementById('submission-tugas-id').value,
        UsernameSantri: session.username,
        NamaSantri: session.userData.profileName,
        KontenHTML: ''
    };
    if (isEditing) { data.submissionId = submissionIdInput.value; }
    if (jenisTugas === 'Makalah') {
        data.KontenHTML = combineMakalahAnswers();
        if (data.KontenHTML.length < 100) { 
             showMessage('Harap isi semua bagian makalah.', 'error');
             hideLoading();
             isFormDirty = true; // (BARU) Gagal, aktifkan lagi
             return;
        }
    } else {
        data.KontenHTML = submissionEditor.root.innerHTML;
        if (data.KontenHTML === '<p><br></p>') {
            showMessage('Jawaban tidak boleh kosong.', 'error');
            hideLoading();
            isFormDirty = true; // (BARU) Gagal, aktifkan lagi
            return;
        }
    }
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        showMessage(`Jawaban berhasil ${isEditing ? 'diperbarui' : 'dikirim'}!`, 'success');
        if (submissionIdInput) { submissionIdInput.value = ''; }
        await loadStudentDashboard();
        showView('student');
    } catch (error) {
        showMessage(`Gagal mengirim: ${error.message}`, 'error');
        isFormDirty = true; // (BARU) Gagal, aktifkan lagi
    } finally {
        hideLoading();
    }
}


    // === Event Listeners ===
	document.getElementById('btn-cancel-form')?.addEventListener('click', () => {
        // (BARU) Cek 'dirty'
        if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali?')) {
            return;
        }
        isFormDirty = false; // Reset
        showView('teacher');
        loadTeacherDashboard();
    });
    
    // (DIUBAH) Menggunakan tombol Bawah
    document.getElementById('btn-back-to-teacher-dash')?.addEventListener('click', () => {
        // (BARU) Cek 'dirty'
        if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali?')) {
            return;
        }
        isFormDirty = false; // Reset
        showView('teacher');
        loadTeacherDashboard();
    });
    // (BARU) Menggunakan tombol Atas
    document.getElementById('btn-back-to-teacher-dash-top')?.addEventListener('click', () => {
        // (BARU) Cek 'dirty'
        if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali?')) {
            return;
        }
        isFormDirty = false; // Reset
        showView('teacher');
        loadTeacherDashboard();
    });
    
    // (DIUBAH) Menggunakan tombol Bawah
    document.getElementById('btn-cancel-submission')?.addEventListener('click', () => {
        // (BARU) Cek 'dirty'
        if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali?')) {
            return;
        }
        isFormDirty = false; // Reset
        showView('student');
        loadStudentDashboard();
    });
    // (BARU) Menggunakan tombol Atas
    document.getElementById('btn-cancel-submission-top')?.addEventListener('click', () => {
        // (BARU) Cek 'dirty'
        if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali?')) {
            return;
        }
        isFormDirty = false; // Reset
        showView('student');
        loadStudentDashboard();
    });
	document.getElementById('btn-tambah-masalah')?.addEventListener('click', () => {
    const count = document.querySelectorAll('.penjelasan-masalah-item').length;
    addPenjelasanMasalah(count + 1);
});
    document.getElementById('btn-create-new')?.addEventListener('click', () => showCreateForm(false)); // (DIUBAH)
    document.getElementById('form-tugas')?.addEventListener('submit', handleSaveTugas);
    document.getElementById('btn-cancel-form')?.addEventListener('click', () => {
        showView('teacher');
        loadTeacherDashboard();
    });
    document.getElementById('btn-toggle-archive')?.addEventListener('click', (e) => {
        const btn = e.target;
        const archivedTasks = document.querySelectorAll('.is-archived');
        
        if (btn.dataset.state === "hidden") {
            // Tampilkan arsip
            archivedTasks.forEach(task => {
                task.style.display = 'flex'; // Gunakan 'flex' agar layout tetap
            });
            btn.textContent = `Sembunyikan Arsip (${archivedTasks.length})`;
            btn.dataset.state = "shown";
        } else {
            // Sembunyikan arsip
            archivedTasks.forEach(task => {
                task.style.display = 'none';
            });
            btn.textContent = `Tampilkan Arsip (${archivedTasks.length})`;
            btn.dataset.state = "hidden";
        }
    });
	
	document.getElementById('btn-toggle-archive-teacher')?.addEventListener('click', (e) => {
    const btn = e.target;
    const archivedTasks = document.querySelectorAll('#tugas-list-teacher .is-archived');

    if (btn.dataset.state === "hidden") {
        // Tampilkan arsip
        archivedTasks.forEach(task => {
            task.style.display = 'flex'; // Gunakan 'flex' agar layout tetap
        });
        btn.textContent = `Sembunyikan Arsip (${archivedTasks.length})`;
        btn.dataset.state = "shown";
    } else {
        // Sembunyikan arsip
        archivedTasks.forEach(task => {
            task.style.display = 'none';
        });
        btn.textContent = `Tampilkan Arsip (${archivedTasks.length})`;
        btn.dataset.state = "hidden";
    }
});
	
    // (DIUBAH) Menggunakan tombol Bawah
    document.getElementById('btn-back-to-teacher-dash')?.addEventListener('click', () => {
        showView('teacher');
        loadTeacherDashboard();
    });
    // (BARU) Menggunakan tombol Atas
    document.getElementById('btn-back-to-teacher-dash-top')?.addEventListener('click', () => {
        showView('teacher');
        loadTeacherDashboard();
    });
    
    // (DIUBAH) Menggunakan tombol Bawah
    document.getElementById('btn-cancel-submission')?.addEventListener('click', () => {
        showView('student');
        loadStudentDashboard();
    });
    // (BARU) Menggunakan tombol Atas
    document.getElementById('btn-cancel-submission-top')?.addEventListener('click', () => {
        showView('student');
        loadStudentDashboard();
    });

    // Event listener untuk tombol kerjakan/nilai (event delegation)
    document.body.addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-edit-tugas')) {
            showEditForm(event.target.dataset.id);
        }
        if (event.target.classList.contains('btn-edit-jawaban')) {
            const tugasId = event.target.dataset.id;
            const submissionId = event.target.dataset.submissionId;
            showEditJawabanForm(tugasId, submissionId);
        }
        if (event.target.classList.contains('btn-grade')) {
            showGradingView(event.target.dataset.id);
        }
        if (event.target.classList.contains('btn-work')) {
            showSubmissionView(event.target.dataset.id);
        }
        if (event.target.classList.contains('btn-save-grade')) {
            const submissionId = event.target.dataset.id;
            const nilaiInput = event.target.previousElementSibling;
            handleGradeSubmission(submissionId, nilaiInput.value, event.target);
        }
    });

    // Event listener untuk form kirim tugas (santri)
    document.getElementById('form-submission')?.addEventListener('submit', handleSubmitTugas);

    async function initializeApp() {
        // (BARU) Listener Peringatan Keluar Halaman (Keluar/Refresh Browser)
        window.addEventListener('beforeunload', (event) => {
            if (isFormDirty) {
                // Tampilkan pesan konfirmasi browser
                event.preventDefault();
                event.returnValue = ''; // Wajib untuk browser modern
                return ''; // Untuk browser lama
            }
        });
        
        // (BARU) Listener untuk tombol navigasi internal (Kembali ke Beranda)
        document.querySelector('.page-header a[href="index.html"]').addEventListener('click', (e) => {
            if (isFormDirty && !confirm('Anda memiliki perubahan yang belum disimpan. Yakin ingin kembali ke Beranda?')) {
                e.preventDefault(); // Batalkan pindah halaman
            } else {
                isFormDirty = false; // Izinkan pindah halaman
            }
        });
        // === Inisialisasi Aplikasi ===
        checkUserAccess();
    }
    initializeApp();
});
</script>
</body>
</html>
