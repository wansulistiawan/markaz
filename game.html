<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Santri - Yayasan Markaz Yatim Duafa Qurani</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<style>
        :root {
            --primary: #10b981;
            --dark: #064e3b;
            --accent: #f59e0b;
            --bg: #ecfdf5;
            --matched-bg: #2563eb; /* Biru saat cocok */
            --sidebar-bg: #ffffff;
            --slot-bg: #e5e7eb;
        }
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
        }

        /* --- MENU UTAMA (GAME SELECTION) --- */
        #gameMenu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px;
        }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; }
        .game-card {
            background: white; border-radius: 15px; padding: 20px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;
            border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .game-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .status-ready { background: #d1fae5; color: #065f46; font-size: 0.8rem; padding: 4px 10px; border-radius: 10px; font-weight: bold; }
        .status-soon { background: #f3f4f6; color: #6b7280; font-size: 0.8rem; padding: 4px 10px; border-radius: 10px; font-weight: bold; }

        /* --- GAME UI STRUCTURE --- */
        #gameUI { display: none; flex-direction: column; height: 100%; }
        
        .header {
    background: var(--dark); 
    color: white; 
    width: 100%; 
    padding: 8px 15px; 
    display: flex; 
    justify-content: space-between; /* Kiri dan Kanan mentok */
    align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
    flex-shrink: 0; 
    z-index: 50;
    position: relative; /* Penting untuk centering judul */
}
        .header h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .home-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .user-info {
            position: relative !important; /* Penting */
            overflow: visible !important;  /* Agar mahkota yang keluar tidak terpotong */
            transition: all 0.3s ease;
        }
		.big-champion-crown {
            position: absolute;
            top: -20px;  /* Geser ke atas keluar border */
            left: -20px; /* Geser ke kiri keluar border */
            font-size: 3.5rem; /* Ukuran SANGAT BESAR */
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); /* Efek bayangan agar menonjol */
            z-index: 10; /* Pastikan di layer paling atas */
            transform: rotate(-15deg); /* Miring sedikit biar gaya */
        }

        .main-container {
            display: flex; flex: 1; width: 100%; max-width: 1200px; margin: 0 auto;
            padding: 10px; gap: 15px; overflow: hidden; 
        }

        .game-area {
            flex: 3; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
            overflow: hidden; /* Kunci area utama */
        }

        .sidebar {
            flex: 1; background: var(--sidebar-bg); border-radius: 10px; padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
            height: 100%; overflow-y: auto; display: flex; flex-direction: column;
        }

        .controls-bar { width: 100%; display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .status-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 8px; font-size: 1rem; font-weight: bold; color: var(--dark); flex-shrink: 0; }
        .badge { background: white; padding: 2px 15px; border-radius: 15px; border: 1px solid var(--primary); font-size: 0.9rem; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 6px; font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- MUFRODAT BOARD --- */
        .timer-container { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        .timer-bar { height: 100%; background: var(--primary); width: 100%; transition: width 0.1s linear; }
        
        .game-board-mufrodat {
            display: grid; 
            gap: 8px; 
            width: 100%; 
            /* Gunakan flex-grow agar mengisi sisa ruang, min-height 0 penting untuk scroll */
            flex-grow: 1; 
            min-height: 0; 
            align-content: start; /* Kartu mulai dari atas */
            justify-content: center; 
            perspective: 1000px;
            overflow-y: auto; /* Scroll muncul hanya di area kartu jika sempit */
            padding-bottom: 20px; /* Ruang nafas bawah */
        }
        .card {
            background-color: transparent;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            /* Animasi dipercepat jadi 0.2 detik */
            transition: transform 0.2s cubic-bezier(0.4, 0.0, 0.2, 1);
            aspect-ratio: 1 / 1;
            max-width: 120px; 
            max-height: 120px;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { transform: rotateY(180deg); cursor: default; }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 8px; font-weight: bold; padding: 2px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .front { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; font-size: 2.5rem; border: 2px solid white; }
        .back { background: white; transform: rotateY(180deg); border: 2px solid var(--primary); color: var(--dark); font-size: 1.2rem; line-height: 1.1; overflow:hidden; word-wrap:break-word;}
        .card.matched .back { background-color: var(--matched-bg) !important; color: white !important; border-color: #93c5fd; animation: pulse 0.5s ease-in-out; }
        .arabic-text { font-family: 'Amiri', serif; font-size: 2.2rem !important; font-weight: 900; line-height: 1; margin-top: -5px; }

        /* --- FIQIH BOARD --- */
        .fiqih-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 20px; }
        .fiqih-question { text-align: center; font-size: 1.3rem; font-weight: bold; color: var(--dark); margin-bottom: 10px; }
        .slots-area { display: flex; flex-direction: column; gap: 8px; }
        .slot { background: var(--slot-bg); border: 2px dashed #ccc; border-radius: 8px; min-height: 50px; display: flex; align-items: center; padding: 0 15px; position: relative; }
        .slot-number { background: var(--dark); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0; }
        .slot.filled { border-style: solid; border-color: var(--primary); background: white; }
        .slot.correct { background-color: #d1fae5; border-color: #10b981; }
        .slot.wrong { background-color: #fee2e2; border-color: #ef4444; }
        .pieces-area { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 10px; border: 1px solid #ccc; }
        .puzzle-piece { background: white; border: 2px solid var(--primary); color: var(--dark); padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .puzzle-piece:hover { transform: scale(1.05); background: var(--bg); }

        @keyframes pulse { 0% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.1); } 100% { transform: rotateY(180deg) scale(1); } }

        /* MODAL & OVERLAY */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; animation: popIn 0.3s ease; }
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* LEADERBOARD */
        .lb-item { padding: 8px; border-bottom: 1px solid #f3f4f6; margin-bottom: 4px; }
        .lb-rank { width: 20px; height: 20px; font-size: 0.7rem; background:var(--dark); color:white; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-right:5px;}
        .rank-badge { font-size: 0.65rem; padding: 1px 5px; border-radius:4px; font-weight:bold;}
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FDB931); color: #5c4004; }
        .rank-2 { background: linear-gradient(45deg, #E0E0E0, #BDBDBD); color: #424242; }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #A0522D); color: #fff; }
        .rank-legend { background: linear-gradient(45deg, #f59e0b, #b45309); color: white; }
        .rank-master { background: #fbcfe8; color: #9d174d; }
        .rank-high { background: #fef08a; color: #854d0e; }
        .rank-mid { background: #bfdbfe; color: #1e40af; }
        .rank-new { background: #e5e7eb; color: #374151; }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; padding: 5px; }
            .game-area { width: 100%; height: 65vh; }
            .sidebar { display: none; }
            .game-board-mufrodat { max-height: none; }
        }
		
		/* --- TAJWID GAME --- */
        .tajwid-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 20px; align-items: center; }
        .tajwid-question { 
            text-align: center; font-size: 1.3rem; font-weight: bold; color: var(--dark); 
            background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            width: 100%; border-left: 5px solid var(--accent);
        }
        .quran-display {
            font-family: 'Amiri', serif;
            font-size: 2.2rem;
            line-height: 2.2;
            text-align: center;
            direction: rtl; /* Arab kanan ke kiri */
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            width: 100%;
            border: 1px solid #e5e7eb;
        }
        
        /* Kata-kata dalam ayat bisa diklik */
        .tajwid-word {
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 5px;
            transition: all 0.2s;
            display: inline-block; /* Agar padding bekerja */
        }
        .tajwid-word:hover {
            background-color: #f3f4f6;
            transform: scale(1.1);
        }
        .tajwid-word.correct {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #10b981;
        }
        .tajwid-word.wrong {
            background-color: #fee2e2;
            color: #ef4444;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
		.timer-bar.bonus {
            background-color: #fbbf24 !important; /* Kuning Emas */
            box-shadow: 0 0 15px #fbbf24; /* Efek Glow */
            transition: background-color 0.1s;
        }
		/* --- EFEK TEKS WAKTU MELAYANG --- */
        .floating-time-text {
            position: absolute;
            top: 140px; /* Muncul di bawah timer / atas kartu */
            left: 50%;
            transform: translateX(-50%);
            color: #fbbf24; /* Warna Emas */
            font-family: 'Fredoka', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            text-shadow: 
                2px 2px 0px #000, 
                0px 0px 10px rgba(255, 255, 255, 0.5);
            pointer-events: none; /* Agar tidak mengganggu klik */
            z-index: 100;
            animation: floatUpFade 1.2s ease-out forwards;
        }

        @keyframes floatUpFade {
            0% { 
                opacity: 0; 
                transform: translate(-50%, 20px) scale(0.5); 
            }
            20% { 
                opacity: 1; 
                transform: translate(-50%, 0) scale(1.2); 
            }
            100% { 
                opacity: 0; 
                transform: translate(-50%, -80px) scale(1); 
            }
        }
		
		/* --- LCC GAME STYLES --- */
        .lcc-lobby {
            display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 500px;
            background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .lcc-arena {
            display: flex; flex-direction: column; width: 100%; height: 100%;
        }

        /* Scoreboard LCC */
        .lcc-scoreboard {
            display: flex; justify-content: space-around; padding: 10px;
            background: var(--dark); color: white; border-radius: 0 0 15px 15px;
            margin-bottom: 15px;
        }
        .team-score {
            text-align: center; position: relative; padding: 5px 15px; border-radius: 10px;
            transition: all 0.3s;
        }
        .team-score.active {
            background: rgba(255,255,255,0.2); box-shadow: 0 0 15px var(--accent); border: 2px solid var(--accent);
        }
        .team-score h3 { margin: 0; font-size: 0.9rem; opacity: 0.8; }
        .team-score span { font-size: 1.5rem; font-weight: bold; }
        
        /* Indikator Lampu Bel */
        .buzzer-light {
            width: 15px; height: 15px; border-radius: 50%; background: #555;
            margin: 5px auto; border: 2px solid #fff; transition: background 0.2s;
        }
        .active .buzzer-light { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        /* Area Pertanyaan */
        .question-display {
            flex: 1; display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 20px; font-size: 1.4rem; font-weight: bold;
            color: var(--dark); min-height: 150px;
        }

        /* Tombol Bel Besar */
        .buzzer-btn {
            width: 120px; height: 120px; border-radius: 50%;
            background: radial-gradient(circleAt 30% 30%, #ff6b6b, #c0392b);
            border: 5px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 5px 10px rgba(255,255,255,0.3);
            color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer;
            margin: 0 auto 20px; transition: transform 0.1s;
            display: flex; align-items: center; justify-content: center;
        }
        .buzzer-btn:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .buzzer-btn:disabled { filter: grayscale(1); cursor: not-allowed; }

        /* Mode User vs User Lobby */
        .room-code { font-size: 2rem; letter-spacing: 5px; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .player-list { list-style: none; padding: 0; text-align: left; }
        .player-list li { padding: 8px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
    
	.category-badge {
    align-self: center;
    background-color: #f3f4f6;
    color: #374151;
    font-size: 0.9rem;
    font-weight: bold;
    padding: 8px 25px;
    border-radius: 50px;
    margin-top: 15px;    /* Jarak dari skor */
    margin-bottom: 10px; /* Jarak dari soal */
    border: 1px solid #d1d5db;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    display: none; /* Sembunyikan default, muncul via JS */
}

/* Efek visual untuk pemain yang sudah salah jawab di ronde ini */
.eliminated {
    opacity: 0.5;
    filter: grayscale(100%);
    pointer-events: none; /* Tidak bisa diklik */
    transition: all 0.3s;
}

/* Agar buzzer mati total bagi yang tereliminasi */
.eliminated .buzzer-btn {
    background: #555 !important;
    cursor: not-allowed;
}
	
	.window-controls {
    display: flex;
    gap: 8px;
    align-items: center;
}

.win-btn {
    background: rgba(255,255,255,0.15);
    border: 1px solid rgba(255,255,255,0.2);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1rem;
    transition: all 0.2s;
}

.win-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
.win-btn.btn-close { background: rgba(239, 68, 68, 0.8); border-color: #ef4444; }
.win-btn.btn-close:hover { background: #dc2626; }

/* --- MODE MAXIMIZE (Menyembunyikan Sidebar) --- */
body.maximize-mode .sidebar {
    display: none !important; /* Hilangkan sidebar */
}
body.maximize-mode .game-area {
    flex: 1; /* Area game ambil semua ruang */
    width: 100%;
}
	/* --- LCC TIMER BAR --- */
.lcc-timer-wrapper {
    width: 100%;
    height: 6px;
    background-color: #e5e7eb;
    margin-top: 10px;
    border-radius: 3px;
    overflow: hidden;
    display: none; /* Sembunyikan default */
}

.lcc-timer-progress {
    height: 100%;
    width: 100%;
    background-color: #f59e0b; /* Warna Kuning/Emas */
    transition: width 0.1s linear;
}

/* Warna merah jika waktu mau habis */
.lcc-timer-progress.critical {
    background-color: #ef4444; 
}

.timer-clock {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: conic-gradient(var(--color) var(--deg), #e5e7eb 0deg);
    display: none; /* Sembunyi default */
    justify-content: center;
    align-items: center;
    margin: 10px auto;
    position: relative;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    transition: --deg 0.1s linear; /* Animasi halus */
}

/* Lingkaran dalam agar jadi cincin (Donut Chart) */
.timer-clock::after {
    content: "";
    position: absolute;
    width: 65px; 
    height: 65px;
    background: white;
    border-radius: 50%;
    z-index: 1;
}

/* Angka di tengah */
.timer-text {
    z-index: 2;
    font-weight: 900;
    font-size: 1.5rem;
    color: var(--dark);
    font-family: 'Fredoka', sans-serif;
}

/* Indikator Babak */
.stage-indicator {
    background: var(--dark);
    color: #fbbf24;
    padding: 5px 15px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 5px;
    display: inline-block;
}

/* --- SETTINGS FORM DI LOBBY --- */
.settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin: 15px 0;
    text-align: left;
    background: #f9fafb;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #eee;
}

.setting-item label {
    font-size: 0.8rem;
    font-weight: bold;
    color: #555;
    display: block;
    margin-bottom: 3px;
}

.setting-item input, .setting-item select {
    width: 100%;
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.9rem;
}

.role-selector {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
}
.role-option {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    text-align: center;
    font-size: 0.9rem;
}
.role-option.selected {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
	</style>
</head>
<body>

    <div id="loadingOverlay"><div class="loader"></div><p>Memproses...</p></div>

    <div id="gameMenu">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="color:var(--dark); font-size:2.5rem; margin:0;">ğŸ® Arcade Santri</h1>
            <p style="color:#555;">Belajar sambil bermain!</p>
        </div>
        <div class="menu-grid">
            <div class="game-card" onclick="selectGame('mufrodat')">
                <div style="font-size:3rem;">ğŸ§ </div>
                <div style="font-weight:bold; font-size:1.2rem;">Master Mufrodat</div>
                <div style="font-size:0.9rem; color:#666;">Hafalan kosakata kartu.</div>
                <div class="status-ready">MAIN SEKARANG</div>
            </div>
            <div class="game-card" onclick="selectGame('fiqih')">
                <div style="font-size:3rem;">ğŸ§©</div>
                <div style="font-weight:bold; font-size:1.2rem;">Puzzle Fiqih</div>
                <div style="font-size:0.9rem; color:#666;">Urutkan tata cara ibadah.</div>
                <div class="status-ready">MAIN SEKARANG</div>
            </div>
            <div class="game-card" onclick="selectGame('tajwid')">
                <div style="font-size:3rem;">ğŸ”</div>
                <div style="font-weight:bold; font-size:1.2rem;">Detektif Tajwid</div>
                <div style="font-size:0.9rem; color:#666;">Temukan hukum bacaan dalam ayat.</div>
                <div class="status-ready">MAIN SEKARANG</div> </div>
            <div class="game-card" onclick="selectGame('tahfidz')">
                <div style="font-size:3rem;">ğŸ“–</div><div style="font-weight:bold;">Sambung Ayat</div><div class="status-soon">SEGERA HADIR</div>
            </div>
            <div class="game-card" onclick="selectGame('nahwu')">
                <div style="font-size:3rem;">ğŸ—ï¸</div><div style="font-weight:bold;">Juragan Nahwu</div><div class="status-soon">SEGERA HADIR</div>
            </div>
			<div class="game-card" onclick="selectGame('lcc')">
                <div style="font-size:3rem;">ğŸ””</div>
                <div class="game-title">LCC Cerdas Cermat</div>
                <div class="game-desc">Adu kecepatan & ketepatan! Lawan Bot atau Teman.</div>
                <div class="status-ready">MULTIPLAYER</div>
            </div>
        </div>
    </div>

    <div id="gameUI">
        <div class="header" style="position: relative;"> <div style="display:flex; align-items:center; gap:15px; z-index:10;">
        <button class="home-btn" onclick="confirmExit()">ğŸ  Home</button>
        <button id="muteBtn" class="home-btn" onclick="toggleMute()">ğŸ”Š On</button>
    </div>

    <h1 id="gameTitleDisplay" style="
        position: absolute; 
        left: 50%; 
        transform: translateX(-50%); 
        font-size: 1.1rem; 
        margin: 0; 
        white-space: nowrap;
        pointer-events: none;">
        ğŸ® Game
    </h1>

    <div style="display:flex; align-items:center; gap:10px; z-index:10;">
        <div class="window-controls">
            <button class="win-btn" onclick="toggleMaximize()" title="Perlebar Tampilan">â†”ï¸</button>
            <button class="win-btn" onclick="toggleFullscreen()" title="Layar Penuh">ğŸ“º</button>
        </div>
        <div class="user-info" id="userStatus">Tamu</div>
    </div>
</div>

        <div class="main-container">
            <div class="game-area">
                <div class="controls-bar">
                    <button class="btn btn-blue" onclick="fetchLeaderboard(true)">ğŸ† Peringkat</button>
                    <button class="btn btn-accent" id="btnSave" onclick="saveProgress()" disabled>ğŸ’¾ Simpan</button>
                    <button class="btn btn-primary" id="btnLoad" onclick="loadProgress()" disabled>ğŸ“‚ Muat Ulang</button>
                </div>

                <div class="status-bar">
                    <div class="badge">Lv: <span id="levelDisplay">1</span></div>
                    <div class="badge">Skor: <span id="scoreDisplay">0</span></div>
                </div>

                <div class="timer-container" id="mufrodatTimerContainer">
                    <div class="timer-bar" id="timerBar"></div>
                </div>
                <div class="game-board-mufrodat" id="gameBoardMufrodat" style="display:none;"></div>

                <div class="fiqih-container" id="gameBoardFiqih" style="display:none;">
                    <div class="fiqih-question" id="fiqihQuestion">Urutkan Rukun Wudhu</div>
                    <div class="slots-area" id="fiqihSlots"></div>
                    <div style="text-align:center; margin:10px 0;"><p style="font-size:0.9rem; color:#666;">Klik potongan di bawah.</p></div>
                    <div class="pieces-area" id="fiqihPieces"></div>
                    <button class="btn btn-primary" id="checkFiqihBtn" style="width:100%; padding:12px;" onclick="checkFiqihAnswer()">âœ… Cek Jawaban</button>
                </div>
				
				<div id="lccLobby" class="lcc-lobby" style="display:none;">
    <h2 style="text-align:center; color:var(--dark);">LCC Multiplayer</h2>
    
    <input type="text" id="playerNameInput" placeholder="Nama Kamu / Tim" class="w-full p-2 border rounded mb-2" style="width:100%; padding:10px; margin-bottom:10px;">

    <div id="hostRoleSection" style="display:none; animation: popIn 0.3s ease;">
        <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">Peran Host:</p>
        <div class="role-selector">
            <div id="rolePlayer" class="role-option selected" onclick="setHostRole('player')">ğŸ® Ikut Main</div>
            <div id="roleReferee" class="role-option" onclick="setHostRole('referee')">âš–ï¸ Juri (Wasit)</div>
        </div>

        <p style="font-size:0.9rem; font-weight:bold; margin-bottom:5px;">Aturan Permainan:</p>
        <div class="settings-grid">
            <div class="setting-item">
                <label>Jml Babak</label>
                <input type="number" id="confStages" value="3" min="1" max="5">
            </div>
            <div class="setting-item">
                <label>Soal / Babak</label>
                <input type="number" id="confQuestions" value="5" min="1" max="20">
            </div>
            <div class="setting-item">
                <label>Waktu Rebutan (dtk)</label>
                <input type="number" id="confTimerBuzz" value="7" min="3" max="20">
            </div>
            <div class="setting-item">
                <label>Waktu Jawab (dtk)</label>
                <input type="number" id="confTimerAns" value="10" min="5" max="30">
            </div>
        </div>

        <button class="btn btn-accent" style="width:100%; margin-top:10px;" onclick="createRoom()">ğŸš€ Konfirmasi & Buat Room</button>
        <button class="btn" style="width:100%; margin-top:5px; background:#ccc;" onclick="cancelHostSetup()">Batal</button>
    </div>

    <div id="lobbyButtons">
        <div class="flex gap-2" style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn btn-accent" style="flex:1" onclick="showHostSetup()">Buat Room</button>
            <button class="btn btn-blue" style="flex:1" onclick="joinRoomPrompt()">Gabung</button>
        </div>
        <button class="btn btn-primary" onclick="startLccBotMode()" style="width:100%; margin-top:10px;">ğŸ¤– Latihan vs Bot</button>
    </div>

    <div id="waitingRoom" class="hidden mt-4 text-center" style="display:none; margin-top:20px; text-align:center; border-top:1px dashed #ccc; padding-top:10px;">
        <p>Kode Room:</p>
        <div id="displayRoomCode" class="room-code">---</div>
        <p class="text-sm text-gray-500">Menunggu pemain lain...</p>
        <ul id="lobbyPlayerList" class="player-list"></ul>
        <button id="btnStartMulti" class="btn btn-primary w-full mt-2 hidden" style="display:none; width:100%;" onclick="startMultiplayerGame()">Mulai Game</button>
    </div>
</div>
                

                <div id="lccArena" class="lcc-arena" style="display:none;">
    
    <div style="text-align:center; margin-top:10px;">
        <span id="stageDisplay" class="stage-indicator">BABAK 1: PENYISIHAN</span>
    </div>

    <div class="lcc-scoreboard">
        <div class="team-score" id="teamA">
             <div class="buzzer-light"></div>
             <h3 id="nameA">Kamu</h3><span id="scoreA">0</span>
        </div>
        <div class="team-score" id="teamB">
             <div class="buzzer-light"></div>
             <h3 id="nameB">Lawan 1</h3><span id="scoreB">0</span>
        </div>
        <div class="team-score" id="teamC">
             <div class="buzzer-light"></div>
             <h3 id="nameC">Lawan 2</h3><span id="scoreC">0</span>
        </div>
    </div>

    <div id="lccCategoryBadge" class="category-badge"></div>

    <div class="question-display" id="lccQuestionText">
        Persiapan...
    </div>

    <div id="lccTimerClock" class="timer-clock" style="--deg: 0deg; --color: #10b981;">
        <span id="lccTimerText" class="timer-text">0</span>
    </div>

    <div style="padding:20px; text-align:center;">
        <button id="buzzerBtn" class="buzzer-btn" onclick="pressBuzzer()">BEL</button>
        <div id="answerOptions" class="hidden grid grid-cols-2 gap-2 mt-4"></div>
    </div>
</div>
				
				<div class="tajwid-container" id="gameBoardTajwid" style="display:none;">
                    <div class="tajwid-question" id="tajwidQuestText">Pertanyaan akan muncul di sini...</div>
                    
                    <div class="quran-display" id="quranTextDisplay">
                        </div>

                    <div id="tajwidFeedback" style="height: 20px; font-weight:bold; text-align:center;"></div>
                </div>
            </div>

            <div class="sidebar">
                <h2>ğŸ† Peringkat Top 10</h2>
                <div id="leaderboardList"><p style="text-align:center; color:#999;">...</p></div>
                <div style="margin-top:10px; text-align:center;">
                    <button class="btn btn-blue" onclick="fetchLeaderboard()" style="width:100%;">ğŸ”„ Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="leaderboardModal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="color: var(--dark); margin-top:0;">ğŸ† Top 10</h2>
            <div id="modalLbContent">Memuat...</div>
            <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('leaderboardModal').style.display='none'">Tutup</button>
        </div>
    </div>

    <div class="modal" id="levelModal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-top:0;">Ahlan Wa Sahlan! ğŸ‰</h2>
            <p>Level <span id="nextLevelNum" style="font-weight:bold; font-size:1.5rem;"></span> TerTbuka!</p>
            <p>Bonus: +<span id="timeBonus"></span> Poin</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="nextLevel()">Lanjut</button>
                <button class="btn btn-accent" onclick="document.getElementById('levelModal').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 style="color: #ef4444; margin-top:0;" id="gameOverTitle">Waktu Habis! â³</h2>
            <p>Skor Akhir: <span id="finalScore" style="font-weight:bold; font-size:1.5rem;"></span></p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="restartLevel()">Ulangi</button>
                <button class="btn btn-accent" onclick="restartGame()">Reset</button>
            </div>
        </div>
    </div>

<div class="modal" id="guestModal" style="z-index: 2000;">
        <div class="modal-content" style="max-width: 350px;">
            <h2 style="color: var(--dark); margin-top:0;">Siapa Nama Antum?</h2>
            <p style="color:#666; font-size:0.9rem;">Masukkan nama panggilan untuk dicatat di Papan Peringkat.</p>
            
            <input type="text" id="guestNameInput" placeholder="Contoh: Abdullah" 
                   style="width:100%; padding:12px; margin:15px 0; border:2px solid #ddd; border-radius:8px; font-size:1.1rem; text-align:center; font-weight:bold;">
            
            <button class="btn btn-primary" style="width:100%;" onclick="submitGuestName()">Mulai Bermain ğŸš€</button>
        </div>
    </div>g

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec"; 
    
	// === SOUND MANAGER (GENERATOR SUARA TANPA FILE MP3) ===
    const sfx = {
        ctx: new (window.AudioContext || window.webkitAudioContext)(),
        
        // Helper untuk membunyikan nada
        playTone: function(freq, type, duration, vol = 0.3) {
            if (this.ctx.state === 'suspended') this.ctx.resume();
            const osc = this.ctx.createOscillator();
            const gain = this.ctx.createGain();
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
            
            gain.gain.setValueAtTime(vol, this.ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);

            osc.connect(gain);
            gain.connect(this.ctx.destination);
            osc.start();
            osc.stop(this.ctx.currentTime + duration);
        },

        // Suara Balik Kartu / Klik
        flip: function() {
            this.playTone(600, 'sine', 0.1, 0.2);
        },

        // Suara Benar (Ting!)
        correct: function() {
            this.playTone(880, 'sine', 0.1, 0.3); // A5
            setTimeout(() => this.playTone(1108, 'sine', 0.3, 0.3), 100); // C#6
        },

        // Suara Salah (Tetot!)
        wrong: function() {
            this.playTone(150, 'sawtooth', 0.3, 0.3);
            setTimeout(() => this.playTone(100, 'sawtooth', 0.4, 0.3), 150);
        },

        // Suara Menang Level (Fanfare Kecil)
        win: function() {
            [523, 659, 784, 1046].forEach((freq, i) => { // C Major Arpeggio
                setTimeout(() => this.playTone(freq, 'square', 0.2, 0.4), i * 100);
            });
        },

        // Suara Game Over
        lose: function() {
            [392, 370, 349, 330].forEach((freq, i) => { // Descending
                setTimeout(() => this.playTone(freq, 'triangle', 0.4, 0.4), i * 200);
            });
        }
    };
	
	const firebaseConfig = {
  apiKey: "AIzaSyC4t1Gya_QHDzTkYsF7U-pw1Uo1oQUABpM",
  authDomain: "websitemarkaz.firebaseapp.com",
  databaseURL: "https://websitemarkaz-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "websitemarkaz",
  storageBucket: "websitemarkaz.firebasestorage.app",
  messagingSenderId: "5529883980",
  appId: "1:5529883980:web:792ce6d869070e9a79ebe9"
};

    // Inisialisasi Firebase (Cek agar tidak error jika config kosong)
    let db;
    try {
        if(firebase.apps.length === 0) firebase.initializeApp(firebaseConfig);
        db = firebase.database();
    } catch(e) {
        console.warn("Firebase belum dikonfigurasi. Multiplayer tidak aktif.");
    }
	
	
	// === DATABASE SOAL LCC (DARI FIREBASE) ===
    // === DATABASE SOAL LCC (TERPISAH) ===
    let lccData = {
        umum: [],
        diniyah: []
    };

    // Fungsi untuk mengambil soal dari Firebase
    function fetchLccQuestionsFromFirebase() {
        if (!db) return console.error("Firebase belum siap.");
        
        showLoading(true); 
        
        // Ambil seluruh node 'soal_lcc' yang berisi 'umum' dan 'diniyah'
        db.ref('soal_lcc').once('value')
            .then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    
                    // Simpan ke variabel terpisah & pastikan formatnya Array
                    lccData.umum = Array.isArray(data.umum) ? data.umum : Object.values(data.umum || {});
                    lccData.diniyah = Array.isArray(data.diniyah) ? data.diniyah : Object.values(data.diniyah || {});
                    
                    console.log(`Soal Umum: ${lccData.umum.length}, Soal Diniyah: ${lccData.diniyah.length}`);
                    
                    if (lccData.umum.length === 0 && lccData.diniyah.length === 0) {
                        alert("Database soal kosong!");
                        backToMenu();
                    } else {
                        initLccGame(); 
                    }
                } else {
                    alert("Database soal LCC belum dibuat di Firebase!");
                    backToMenu();
                }
            })
            .catch((error) => {
                console.error(error);
                alert("Gagal mengambil soal. Periksa koneksi/konfigurasi.");
                backToMenu();
            })
            .finally(() => {
                showLoading(false);
            });
    }
	
	let lccMode = ''; // 'bot' or 'multi'
    let lccRound = 0;
    let lccScores = { A: 0, B: 0, C: 0 };
    let lccCurrentQ = null;
    let lccBuzzerLocked = false;
    let lccTimer = null;
    let lccTypeInterval = null;
	let lccBotTimer = null;
	let lccRoomId = null;
    let lccMyPlayerId = null; // p1, p2, p3, p4
    let lccDbRef = null;
	let lccCurrentStage = 1; // 1: Penyisihan, 2: Semifinal, 3: Final
    let MAX_STAGES = 3;
    let QUESTIONS_PER_STAGE = 9;
    let TIMER_BUZZER_DURATION = 7; // Waktu rebutan
    let TIMER_ANSWER_DURATION = 10; // Waktu menjawab
    
    let isHostReferee = false; // Status apakah saya juri
    let hostRoleSelection = 'player'; // Ubah jadi 10 jika ingin lebih lama
	let lccSessionScore = 0; // Menyimpan total poin sesi ini (misal: 1100)
    let lccSessionLevel = 0; // Menyimpan total babak sesi ini (misal: 6)
    
    // Variabel Timer
    let lccGameTimer = null;
    // Variabel untuk melacak posisi huruf
    let lccCharIndex = 0; 
    let lccFullText = ""; // Menyimpan teks soal lengkap
    // Variabel baru untuk melacak posisi teks
    let lccWordIndex = 0; 
    let lccCurrentWords = [];
	let lccAttemptedPlayers = []; // Menyimpan 'A', 'B', atau 'C' yang sudah salah
	
    let currentGameMode = ''; 
    let currentLevel = 1;
    let score = 0;
    let currentUser = null;
	

    // === DATA MUFRODAT LENGKAP (7 TIER) ===
    // Tier 1: Benda Sehari-hari
    const tier1 = [
        {a:"ÙƒÙØªÙØ§Ø¨ÙŒ", i:"Buku"}, {a:"Ù‚ÙÙ„ÙÙ…ÙŒ", i:"Pena"}, {a:"Ù…ÙÙƒÙ’ØªÙØ¨ÙŒ", i:"Meja"}, {a:"ÙƒÙØ±Ù’Ø³ÙÙŠÙŒÙ‘", i:"Kursi"}, {a:"Ø¨ÙØ§Ø¨ÙŒ", i:"Pintu"}, {a:"Ù†ÙØ§ÙÙØ°ÙØ©ÙŒ", i:"Jendela"},
        {a:"ÙÙØµÙ’Ù„ÙŒ", i:"Kelas"}, {a:"Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©ÙŒ", i:"Sekolah"}, {a:"Ø£ÙØ³Ù’ØªÙØ§Ø°ÙŒ", i:"Guru (Lk)"}, {a:"ØªÙÙ„Ù’Ù…ÙÙŠÙ’Ø°ÙŒ", i:"Murid"}, {a:"Ø³ÙØ¨ÙÙ‘ÙˆÙ’Ø±ÙØ©ÙŒ", i:"Papan Tulis"}, {a:"Ù…ÙÙ…Ù’Ø³ÙØ­ÙØ©ÙŒ", i:"Penghapus"},
        {a:"Ø­ÙÙ‚ÙÙŠÙ’Ø¨ÙØ©ÙŒ", i:"Tas"}, {a:"Ù…Ø³Ø·Ø±Ø©", i:"Penggaris"}, {a:"Ø³ÙØ§Ø¹ÙØ©ÙŒ", i:"Jam"}, {a:"Ø¨ÙÙŠÙ’ØªÙŒ", i:"Rumah"}, {a:"ØºÙØ±Ù’ÙÙØ©ÙŒ", i:"Kamar"}, {a:"Ù…ÙØ·Ù’Ø¨ÙØ®ÙŒ", i:"Dapur"},
        {a:"Ø­ÙÙ…ÙÙ‘Ø§Ù…ÙŒ", i:"Kamar Mandi"}, {a:"Ø³ÙØ±ÙÙŠÙ’Ø±ÙŒ", i:"Ranjang"}, {a:"Ù…ÙØ±Ù’Ø¢Ø©ÙŒ", i:"Cermin"}, {a:"Ù…ÙØµÙ’Ø¨ÙØ§Ø­ÙŒ", i:"Lampu"}, {a:"Ø«ÙÙˆÙ’Ø¨ÙŒ", i:"Baju"}, {a:"Ø­ÙØ°ÙØ§Ø¡ÙŒ", i:"Sepatu"},
        {a:"Ø¬ÙÙˆÙ’Ø±ÙØ¨ÙŒ", i:"Kaos Kaki"}, {a:"Ù‚ÙÙ„ÙÙ†Ù’Ø³ÙÙˆÙØ©ÙŒ", i:"Peci"}, {a:"Ù…ÙØ§Ø¡ÙŒ", i:"Air"}, {a:"Ø®ÙØ¨Ù’Ø²ÙŒ", i:"Roti"}, {a:"Ù„ÙØ­Ù’Ù…ÙŒ", i:"Daging"}, {a:"Ø³ÙÙ…ÙÙƒÙŒ", i:"Ikan"}
    ];
    // Tier 2: Kata Kerja & Sifat
    const tier2 = [
        {a:"Ø£ÙÙƒÙÙ„Ù", i:"Makan"}, {a:"Ø´ÙØ±ÙØ¨Ù", i:"Minum"}, {a:"Ù†ÙØ§Ù…Ù", i:"Tidur"}, {a:"Ù‚ÙØ§Ù…Ù", i:"Berdiri"}, {a:"Ø¬ÙÙ„ÙØ³Ù", i:"Duduk"}, {a:"Ø°ÙÙ‡ÙØ¨Ù", i:"Pergi"},
        {a:"Ø±ÙØ¬ÙØ¹Ù", i:"Pulang"}, {a:"Ù‚ÙØ±ÙØ£Ù", i:"Membaca"}, {a:"ÙƒÙØªÙØ¨Ù", i:"Menulis"}, {a:"Ø¯ÙØ®ÙÙ„Ù", i:"Masuk"}, {a:"Ø®ÙØ±ÙØ¬Ù", i:"Keluar"}, {a:"ÙÙØªÙØ­Ù", i:"Membuka"},
        {a:"ØºÙÙ„ÙÙ‚Ù", i:"Menutup"}, {a:"Ù†ÙØ¸ÙØ±Ù", i:"Melihat"}, {a:"Ø³ÙÙ…ÙØ¹Ù", i:"Mendengar"}, {a:"ÙƒÙØ¨ÙŠØ±ÙŒ", i:"Besar"}, {a:"ØµÙØºÙÙŠÙ’Ø±ÙŒ", i:"Kecil"}, {a:"Ø·ÙÙˆÙÙŠÙ’Ù„ÙŒ", i:"Panjang"},
        {a:"Ù‚ÙØµÙÙŠÙ’Ø±ÙŒ", i:"Pendek"}, {a:"Ø¬ÙØ¯ÙÙŠÙ’Ø¯ÙŒ", i:"Baru"}, {a:"Ù‚ÙØ¯ÙÙŠÙ’Ù…ÙŒ", i:"Lama"}, {a:"Ù†ÙØ¸ÙÙŠÙ’ÙÙŒ", i:"Bersih"}, {a:"ÙˆÙØ³ÙØ®ÙŒ", i:"Kotor"}, {a:"Ø¬ÙÙ…ÙÙŠÙ’Ù„ÙŒ", i:"Indah"},
        {a:"Ù‚ÙØ¨ÙÙŠÙ’Ø­ÙŒ", i:"Jelek"}, {a:"Ù‚ÙØ±ÙÙŠÙ’Ø¨ÙŒ", i:"Dekat"}, {a:"Ø¨ÙØ¹ÙÙŠÙ’Ø¯ÙŒ", i:"Jauh"}, {a:"Ø³ÙØ±ÙÙŠÙ’Ø¹ÙŒ", i:"Cepat"}, {a:"Ø¨ÙØ·ÙÙŠÙ’Ø¡ÙŒ", i:"Lambat"}, {a:"Ù‚ÙÙˆÙÙŠÙŒÙ‘", i:"Kuat"}
    ];
    // Tier 3: Alam & Tubuh
    const tier3 = [
        {a:"Ø³ÙÙ…ÙØ§Ø¡ÙŒ", i:"Langit"}, {a:"Ø£ÙØ±Ù’Ø¶ÙŒ", i:"Bumi"}, {a:"Ø´ÙÙ…Ù’Ø³ÙŒ", i:"Matahari"}, {a:"Ù‚ÙÙ…ÙØ±ÙŒ", i:"Bulan"}, {a:"Ù†ÙØ¬Ù’Ù…ÙŒ", i:"Bintang"}, {a:"Ø¬ÙØ¨ÙÙ„ÙŒ", i:"Gunung"},
        {a:"Ø¨ÙØ­Ù’Ø±ÙŒ", i:"Laut"}, {a:"Ù†ÙÙ‡Ù’Ø±ÙŒ", i:"Sungai"}, {a:"Ø´ÙØ¬ÙØ±ÙØ©ÙŒ", i:"Pohon"}, {a:"Ø²ÙÙ‡Ù’Ø±ÙØ©ÙŒ", i:"Bunga"}, {a:"Ø£ÙØ³ÙØ¯ÙŒ", i:"Singa"}, {a:"ÙÙÙŠÙ’Ù„ÙŒ", i:"Gajah"},
        {a:"Ù‚ÙØ·ÙŒÙ‘", i:"Kucing"}, {a:"ÙƒÙÙ„Ù’Ø¨ÙŒ", i:"Anjing"}, {a:"Ø·ÙØ§Ø¦ÙØ±ÙŒ", i:"Burung"}, {a:"Ø±ÙØ£Ù’Ø³ÙŒ", i:"Kepala"}, {a:"Ø¹ÙÙŠÙ’Ù†ÙŒ", i:"Mata"}, {a:"Ø£ÙÙ†Ù’ÙÙŒ", i:"Hidung"},
        {a:"Ø£ÙØ°ÙÙ†ÙŒ", i:"Telinga"}, {a:"ÙÙÙ…ÙŒ", i:"Mulut"}, {a:"ÙŠÙØ¯ÙŒ", i:"Tangan"}, {a:"Ø±ÙØ¬Ù’Ù„ÙŒ", i:"Kaki"}, {a:"Ù‚ÙÙ„Ù’Ø¨ÙŒ", i:"Jantung"}, {a:"Ø¨ÙØ·Ù’Ù†ÙŒ", i:"Perut"},
        {a:"Ø´ÙØ¹Ù’Ø±ÙŒ", i:"Rambut"}, {a:"Ù„ÙØ³ÙØ§Ù†ÙŒ", i:"Lidah"}, {a:"Ø³ÙÙ†ÙŒÙ‘", i:"Gigi"}
    ];
    // Tier 4: Agama
    const tier4 = [
        {a:"ØµÙÙ„ÙØ§Ø©ÙŒ", i:"Sholat"}, {a:"ØµÙÙˆÙ’Ù…ÙŒ", i:"Puasa"}, {a:"Ø²ÙÙƒÙØ§Ø©ÙŒ", i:"Zakat"}, {a:"Ø­ÙØ¬ÙŒÙ‘", i:"Haji"}, {a:"Ø¥ÙÙŠÙ’Ù…ÙØ§Ù†ÙŒ", i:"Iman"}, {a:"ØªÙÙ‚Ù’ÙˆÙÙ‰", i:"Taqwa"},
        {a:"Ø¬ÙÙ†ÙÙ‘Ø©ÙŒ", i:"Surga"}, {a:"Ù†ÙØ§Ø±ÙŒ", i:"Neraka"}, {a:"Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©ÙŒ", i:"Malaikat"}, {a:"Ø´ÙÙŠÙ’Ø·ÙØ§Ù†ÙŒ", i:"Setan"}, {a:"Ù‚ÙÙŠÙØ§Ù…ÙØ©ÙŒ", i:"Kiamat"}, {a:"Ø°ÙÙ†Ù’Ø¨ÙŒ", i:"Dosa"},
        {a:"Ø«ÙÙˆÙØ§Ø¨ÙŒ", i:"Pahala"}, {a:"Ø¥ÙØ®Ù’Ù„ÙØ§ØµÙŒ", i:"Ikhlas"}, {a:"ØµÙØ¨Ù’Ø±ÙŒ", i:"Sabar"}, {a:"Ø´ÙÙƒÙ’Ø±ÙŒ", i:"Syukur"}, {a:"Ø¹ÙÙ„Ù’Ù…ÙŒ", i:"Ilmu"}, {a:"Ø¹ÙÙ…ÙÙ„ÙŒ", i:"Amal"},
        {a:"ØµÙØ¯Ù’Ù‚ÙŒ", i:"Jujur"}, {a:"ÙƒÙØ°Ù’Ø¨ÙŒ", i:"Dusta"}, {a:"Ø®ÙÙŠÙ’Ø±Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", i:"Sebaik Manusia"}, {a:"Ø·ÙÙ„ÙØ¨Ù Ø§Ù„Ù’Ø¹ÙÙ„Ù’Ù…Ù", i:"Menuntut Ilmu"}, {a:"Ø¨ÙØ±ÙÙ‘ Ø§Ù„Ù’ÙˆÙØ§Ù„ÙØ¯ÙÙŠÙ’Ù†Ù", i:"Berbakti Ortu"},
        {a:"Ù…ÙÙ†Ù’ Ø¬ÙØ¯ÙÙ‘ ÙˆÙØ¬ÙØ¯Ù", i:"Siapa bersungguh dapat"}, {a:"Ø§Ù„ØµÙÙ‘Ø¨Ù’Ø±Ù Ø¶ÙÙŠÙØ§Ø¡ÙŒ", i:"Sabar itu cahaya"}
    ];
    // Tier 5: Profesi & Keluarga
    const tier5 = [
        {a:"Ø·ÙØ¨ÙÙŠÙ’Ø¨ÙŒ", i:"Dokter"}, {a:"Ù…ÙÙ‡ÙÙ†Ù’Ø¯ÙØ³ÙŒ", i:"Insinyur"}, {a:"ØªÙØ§Ø¬ÙØ±ÙŒ", i:"Pedagang"}, {a:"ÙÙÙ„ÙÙ‘Ø§Ø­ÙŒ", i:"Petani"}, {a:"Ø´ÙØ±Ù’Ø·ÙÙŠÙŒÙ‘", i:"Polisi"}, {a:"Ø¬ÙÙ†Ù’Ø¯ÙÙŠÙŒÙ‘", i:"Tentara"},
        {a:"Ø³ÙØ§Ø¦ÙÙ‚ÙŒ", i:"Sopir"}, {a:"Ø·ÙØ¨ÙÙ‘Ø§Ø®ÙŒ", i:"Koki"}, {a:"Ø£ÙØ¨ÙŒ", i:"Ayah"}, {a:"Ø£ÙÙ…ÙŒÙ‘", i:"Ibu"}, {a:"Ø£ÙØ®ÙŒ", i:"Saudara (Lk)"}, {a:"Ø£ÙØ®Ù’ØªÙŒ", i:"Saudari (Pr)"},
        {a:"Ø¬ÙØ¯ÙŒÙ‘", i:"Kakek"}, {a:"Ø¬ÙØ¯ÙÙ‘Ø©ÙŒ", i:"Nenek"}, {a:"Ø¹ÙÙ…ÙŒÙ‘", i:"Paman (Ayah)"}, {a:"Ø¹ÙÙ…ÙÙ‘Ø©ÙŒ", i:"Bibi (Ayah)"}, {a:"Ø®ÙØ§Ù„ÙŒ", i:"Paman (Ibu)"}, {a:"Ø®ÙØ§Ù„ÙØ©ÙŒ", i:"Bibi (Ibu)"},
        {a:"ÙˆÙÙ„ÙØ¯ÙŒ", i:"Anak (Lk)"}, {a:"Ø¨ÙÙ†Ù’ØªÙŒ", i:"Anak (Pr)"}, {a:"Ø²ÙÙˆÙ’Ø¬ÙŒ", i:"Suami"}, {a:"Ø²ÙÙˆÙ’Ø¬ÙØ©ÙŒ", i:"Istri"}, {a:"Ù‚ÙØ§Ø¶Ù", i:"Hakim"}, {a:"ØµÙÙŠÙÙ‘Ø§Ø¯ÙŒ", i:"Nelayan"}, {a:"Ù…ÙÙ…ÙØ±ÙÙ‘Ø¶ÙŒ", i:"Perawat"}
    ];
    // Tier 6: Waktu, Arah & Transportasi
    const tier6 = [
        {a:"ØµÙØ¨ÙØ§Ø­ÙŒ", i:"Pagi"}, {a:"Ù†ÙÙ‡ÙØ§Ø±ÙŒ", i:"Siang"}, {a:"Ù…ÙØ³ÙØ§Ø¡ÙŒ", i:"Sore"}, {a:"Ù„ÙÙŠÙ’Ù„ÙŒ", i:"Malam"}, {a:"ÙŠÙÙˆÙ’Ù…ÙŒ", i:"Hari"}, {a:"Ø£ÙØ³Ù’Ø¨ÙÙˆÙ’Ø¹ÙŒ", i:"Minggu"},
        {a:"Ø´ÙÙ‡Ù’Ø±ÙŒ", i:"Bulan"}, {a:"Ø³ÙÙ†ÙØ©ÙŒ", i:"Tahun"}, {a:"Ø³ÙØ§Ø¹ÙØ©ÙŒ", i:"Jam"}, {a:"Ø¯ÙÙ‚ÙÙŠÙ’Ù‚ÙØ©ÙŒ", i:"Menit"}, {a:"Ø«ÙØ§Ù†ÙÙŠÙØ©ÙŒ", i:"Detik"}, {a:"Ø£ÙÙ…ÙØ§Ù…Ù", i:"Depan"},
        {a:"ÙˆÙØ±ÙØ§Ø¡Ù", i:"Belakang"}, {a:"ÙÙÙˆÙ’Ù‚Ù", i:"Atas"}, {a:"ØªÙØ­Ù’ØªÙ", i:"Bawah"}, {a:"ÙŠÙÙ…ÙÙŠÙ’Ù†Ù", i:"Kanan"}, {a:"ÙŠÙØ³ÙØ§Ø±Ù", i:"Kiri"}, {a:"Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©ÙŒ", i:"Mobil"},
        {a:"Ø·ÙØ§Ø¦ÙØ±ÙØ©ÙŒ", i:"Pesawat"}, {a:"Ù‚ÙØ·ÙØ§Ø±ÙŒ", i:"Kereta Api"}, {a:"Ø¯ÙØ±ÙÙ‘Ø§Ø¬ÙØ©ÙŒ", i:"Sepeda"}, {a:"Ø³ÙÙÙÙŠÙ’Ù†ÙØ©ÙŒ", i:"Kapal"}, {a:"Ø­ÙØ§ÙÙÙ„ÙØ©ÙŒ", i:"Bus"}, {a:"Ø´ÙØ§Ø±ÙØ¹ÙŒ", i:"Jalan"}, {a:"Ù…ÙØ·ÙØ§Ø±ÙŒ", i:"Bandara"}
    ];
    // Tier 7: Hewan Ternak, Warna & Sifat Lanjutan
    const tier7 = [
        {a:"Ø£ÙØ­Ù’Ù…ÙØ±Ù", i:"Merah"}, {a:"Ø£ÙØ¨Ù’ÙŠÙØ¶Ù", i:"Putih"}, {a:"Ø£ÙØ³Ù’ÙˆÙØ¯Ù", i:"Hitam"}, {a:"Ø£ÙØ®Ù’Ø¶ÙØ±Ù", i:"Hijau"}, {a:"Ø£ÙØ²Ù’Ø±ÙÙ‚Ù", i:"Biru"}, {a:"Ø£ÙØµÙ’ÙÙØ±Ù", i:"Kuning"},
        {a:"Ø¬ÙÙ…ÙÙ„ÙŒ", i:"Unta"}, {a:"Ø­ÙØµÙØ§Ù†ÙŒ", i:"Kuda"}, {a:"ØºÙÙ†ÙÙ…ÙŒ", i:"Kambing"}, {a:"Ø¨ÙÙ‚ÙØ±ÙØ©ÙŒ", i:"Sapi"}, {a:"Ø¯ÙØ¬ÙØ§Ø¬ÙØ©ÙŒ", i:"Ayam"}, {a:"Ø¨ÙØ·ÙÙ‘Ø©ÙŒ", i:"Bebek"},
        {a:"Ø£ÙØ±Ù’Ù†ÙØ¨ÙŒ", i:"Kelinci"}, {a:"Ù†ÙÙ…Ù’Ù„ÙØ©ÙŒ", i:"Semut"}, {a:"Ù†ÙØ­Ù’Ù„ÙØ©ÙŒ", i:"Lebah"}, {a:"Ø¨ÙØ¹ÙÙˆÙ’Ø¶ÙØ©ÙŒ", i:"Nyamuk"}, {a:"Ø°ÙØ¨ÙØ§Ø¨ÙŒ", i:"Lalat"}, {a:"Ù†ÙØ´ÙÙŠÙ’Ø·ÙŒ", i:"Rajin"},
        {a:"ÙƒÙØ³Ù’Ù„ÙØ§Ù†Ù", i:"Malas"}, {a:"Ù…ÙØ§Ù‡ÙØ±ÙŒ", i:"Pintar"}, {a:"Ø¬ÙØ§Ù‡ÙÙ„ÙŒ", i:"Bodoh"}, {a:"Ø³ÙÙ…ÙÙŠÙ’Ù†ÙŒ", i:"Gemuk"}, {a:"Ù†ÙØ­ÙÙŠÙ’ÙÙŒ", i:"Kurus"}, {a:"ØºÙØ§Ù„Ù", i:"Mahal"}, {a:"Ø±ÙØ®ÙÙŠÙ’ØµÙŒ", i:"Murah"}
    ];

    // FIQIH DATA
    // === DATA FIQIH (50 LEVEL LENGKAP) ===
    const fiqihData = [
        // LEVEL 1-10: DASAR (Urutan Wajib)
        { title: "Rukun Islam", steps: ["Syahadat", "Sholat", "Zakat", "Puasa", "Haji"] },
        { title: "Rukun Iman", steps: ["Iman kpd Allah", "Malaikat", "Kitab-kitab", "Rasul", "Hari Kiamat", "Qada & Qadar"] },
        { title: "Urutan Rukun Wudhu", steps: ["Niat", "Basuh Muka", "Basuh Tangan", "Usap Kepala", "Basuh Kaki", "Tertib"] },
        { title: "Rukun Sholat (Bagian Awal)", steps: ["Niat", "Takbiratul Ihram", "Berdiri", "Al-Fatihah", "Ruku'", "I'tidal", "Sujud"] },
        { title: "Gerakan Sholat (Satu Rakaat)", steps: ["Takbir", "Fatihah & Surat", "Ruku'", "I'tidal", "Sujud", "Duduk Antara", "Sujud Kedua"] },
        { title: "Mengurus Jenazah", steps: ["Memandikan", "Mengafani", "Menyolatkan", "Menguburkan"] },
        { title: "Waktu Sholat Fardhu", steps: ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"] },
        { title: "Urutan Tayammum", steps: ["Niat", "Usap Muka", "Usap Tangan", "Tertib"] },
        { title: "Rukun Haji", steps: ["Ihram", "Wukuf", "Thawaf Ifadhah", "Sa'i", "Tahallul", "Tertib"] },
        { title: "Urutan Mandi Wajib", steps: ["Niat", "Cuci Tangan", "Bersihkan Kemaluan", "Wudhu", "Siram Kepala", "Siram Badan"] },

        // LEVEL 11-20: VARIASI (Kelompok/Set - Tidak Harus Urut)
        { title: "3 Macam Najis (Urutan Bebas)", steps: ["Mukhaffafah (Ringan)", "Mutawassitah (Sedang)", "Mughallazah (Berat)"], mode: 'unordered' },
        { title: "3 Waktu Haram Sholat", steps: ["Pas Terbit Matahari", "Pas Matahari di Atas", "Pas Terbenam Matahari"], mode: 'unordered' },
        { title: "3 Hari Tasyrik", steps: ["11 Dzulhijjah", "12 Dzulhijjah", "13 Dzulhijjah"], mode: 'unordered' },
        { title: "4 Bulan Haram", steps: ["Dzulqa'dah", "Dzulhijjah", "Muharram", "Rajab"], mode: 'unordered' },
        { title: "5 Hukum Taklifi", steps: ["Wajib", "Sunnah", "Mubah", "Makruh", "Haram"], mode: 'unordered' },
        { title: "Air Yang Suci (Pilih 4)", steps: ["Air Hujan", "Air Sumur", "Air Laut", "Air Sungai"], mode: 'unordered' },
        { title: "Anggota Sujud (7 Tulang)", steps: ["Dahi", "Dua Telapak Tangan", "Dua Lutut", "Dua Ujung Kaki"], mode: 'unordered' },
        { title: "Yang Membatalkan Wudhu (Pilih 3)", steps: ["Keluar Sesuatu dr Kubul/Dubur", "Hilang Akal", "Bersentuhan Kulit Non-Mahram"], mode: 'unordered' },
        { title: "Najis Mutawassitah (Pilih 3)", steps: ["Darah", "Nanah", "Khamr (Arak)"], mode: 'unordered' },
        { title: "Syarat Wajib Sholat (Pilih 3)", steps: ["Islam", "Baligh", "Berakal"], mode: 'unordered' },

        // LEVEL 21-30: URUTAN LANJUTAN (Lafaz & Proses)
        { title: "Urutan Lafaz Adzan (Awal)", steps: ["Allahu Akbar (4x)", "Asyhadu alla ilaha illallah (2x)", "Asyhadu anna Muhammadar Rasulullah (2x)"] },
        { title: "Urutan Lafaz Adzan (Akhir)", steps: ["Hayya 'alas Sholah (2x)", "Hayya 'alal Falah (2x)", "Allahu Akbar (2x)", "La ilaha illallah"] },
        { title: "Urutan Lafaz Iqamah", steps: ["Allahu Akbar", "Syahadatain", "Hayya 'alas Sholah", "Hayya 'alal Falah", "Qad qamatis sholah", "Takbir & Tahlil"] },
        { title: "Urutan Wali Nikah (Prioritas)", steps: ["Ayah Kandung", "Kakek (Ayah dari Ayah)", "Saudara Laki-laki Kandung", "Saudara Laki-laki Seayah", "Paman"] },
        { title: "Urutan Sholat Jumat", steps: ["Adzan Pertama", "Khutbah", "Iqamah", "Sholat 2 Rakaat"] },
        { title: "Rukun Khutbah Jumat", steps: ["Hamdalah", "Sholawat Nabi", "Wasiat Taqwa", "Membaca Ayat Quran", "Doa untuk Mukminin"] },
        { title: "Proses Jual Beli (Rukun)", steps: ["Penjual & Pembeli", "Barang & Harga", "Ijab Qabul (Serah Terima)"] },
        { title: "Urutan Wirid Ba'da Sholat", steps: ["Istighfar", "Tasbih 33x", "Tahmid 33x", "Takbir 33x", "Tahlil", "Doa"] },
        { title: "Menyucikan Najis Berat (Anjing)", steps: ["Hilangkan Wujud", "Basuh 7 Kali Air", "Salah Satunya Campur Tanah"] },
        { title: "Urutan Umrah", steps: ["Ihram dari Miqat", "Thawaf", "Sa'i", "Tahallul", "Tertib"] },

        // LEVEL 31-40: TANTANGAN CAMPURAN 1
        { title: "Rukun Puasa", steps: ["Niat (Malam Hari)", "Menahan Diri (Terbit-Terbenam)"] },
        { title: "Sebab Sujud Sahwi (Pilih 3)", steps: ["Lupa Tasyahud Awal", "Ragu Jumlah Rakaat", "Lupa Doa Qunut"], mode: 'unordered' },
        { title: "Golongan Penerima Zakat 1", steps: ["Fakir", "Miskin", "Amil", "Mualaf"], mode: 'unordered' },
        { title: "Golongan Penerima Zakat 2", steps: ["Riqab (Hamba Sahaya)", "Gharim (Berhutang)", "Sabilillah", "Ibnu Sabil"], mode: 'unordered' },
        { title: "Sunnah Puasa (Pilih 3)", steps: ["Sahur", "Menyegerakan Berbuka", "Berdoa saat Berbuka"], mode: 'unordered' },
        { title: "Sebab Mandi Wajib (Pilih 3)", steps: ["Jima' (Hubungan Suami Istri)", "Haid", "Nifas"], mode: 'unordered' },
        { title: "Rukun Sholat Jenazah", steps: ["Niat", "Berdiri", "4x Takbir", "Salam"] },
        { title: "Bacaan Sholat Jenazah (Urut Takbir)", steps: ["Al-Fatihah", "Sholawat Nabi", "Doa untuk Jenazah", "Doa untuk Keluarga"] },
        { title: "Urutan Peristiwa Kiamat", steps: ["Kematian", "Kebangkitan", "Padang Mahsyar", "Hisab/Mizan", "Sirat", "Surga/Neraka"] },
        { title: "Tanda Baligh (Pilih 3)", steps: ["Mimpi Basah", "Haid (Perempuan)", "Berumur 15 Tahun"], mode: 'unordered' },

        // LEVEL 41-50: TANTANGAN CAMPURAN 2 (EXPERT)
        { title: "Rukun Wakaf", steps: ["Wakif (Pemberi)", "Mauquf (Harta)", "Mauquf 'Alaih (Penerima)", "Sighat (Ikrar)"] },
        { title: "Syarat Sah Sholat Jumat (Pilih 3)", steps: ["Masuk Waktu Dzuhur", "Berjamaah", "Didahului 2 Khutbah"], mode: 'unordered' },
        { title: "Sunnah Wudhu (Pilih 4)", steps: ["Membaca Basmalah", "Siwak", "Kumur-kumur", "Istinsyaq (Hirup Air)"], mode: 'unordered' },
        { title: "Hadas Besar (Pilih 3)", steps: ["Jima'", "Keluar Mani", "Haid"], mode: 'unordered' },
        { title: "Hadas Kecil (Pilih 3)", steps: ["Buang Air Kecil", "Buang Air Besar", "Buang Angin"], mode: 'unordered' },
        { title: "Rukun Qiradh/Mudharabah", steps: ["Pemilik Modal", "Pengelola", "Modal", "Pekerjaan", "Keuntungan"] },
        { title: "Macam Puasa Sunnah (Pilih 3)", steps: ["Senin Kamis", "Ayyamul Bidh", "Puasa Daud"], mode: 'unordered' },
        { title: "Urutan Mengkafani (Laki-laki)", steps: ["Bentangkan Tali", "Bentangkan 3 Lapis Kain", "Letakkan Jenazah", "Lipat Kain", "Ikat Tali"] },
        { title: "Syarat Hewan Qurban (Pilih 3)", steps: ["Binatang Ternak", "Cukup Umur", "Tidak Cacat"], mode: 'unordered' },
        { title: "Rukun Nikah", steps: ["Mempelai Pria", "Mempelai Wanita", "Wali", "Dua Saksi", "Ijab Qabul"] }
    ];
	
	// === DATA TAJWID (50 LEVEL LENGKAP) ===
    const tajwidData = [
        // LEVEL 1-10: NUN SUKUN & TANWIN DASAR
        { text: "Ù…ÙÙ†Ù’ Ø´ÙØ±ÙÙ‘ Ù…ÙØ§ Ø®ÙÙ„ÙÙ‚Ù", question: "Temukan Ikhfa Haqiqi", targetIndex: [0] },
        { text: "ÙˆÙÙ…ÙÙ†Ù’ Ø´ÙØ±ÙÙ‘ ØºÙØ§Ø³ÙÙ‚Ù Ø¥ÙØ°ÙØ§ ÙˆÙÙ‚ÙØ¨Ù", question: "Temukan Izhar Halqi (Tanwin)", targetIndex: [2] },
        { text: "ÙƒÙÙ„ÙÙ‘Ø§ Ù„ÙÙŠÙÙ†Ù’Ø¨ÙØ°ÙÙ†ÙÙ‘ ÙÙÙŠ Ø§Ù„Ù’Ø­ÙØ·ÙÙ…ÙØ©Ù", question: "Temukan Iqlab", targetIndex: [1] },
        { text: "ÙÙÙŠ Ø¬ÙÙŠØ¯ÙÙ‡ÙØ§ Ø­ÙØ¨Ù’Ù„ÙŒ Ù…ÙÙ†Ù’ Ù…ÙØ³ÙØ¯Ù", question: "Temukan Idgham Bighunnah", targetIndex: [2] },
        { text: "Ù…ÙÙ†Ù’ Ù„ÙØ¯ÙÙ†Ù’ÙƒÙ Ø±ÙØ­Ù’Ù…ÙØ©Ù‹", question: "Temukan Idgham Bilaghunnah", targetIndex: [0] },
        { text: "Ø³ÙÙ„ÙØ§Ù…ÙŒ Ù‡ÙÙŠÙ Ø­ÙØªÙÙ‘Ù‰Ù° Ù…ÙØ·Ù’Ù„ÙØ¹Ù Ø§Ù„Ù’ÙÙØ¬Ù’Ø±Ù", question: "Temukan Izhar Halqi", targetIndex: [0] },
        { text: "ÙÙØ°ÙÙƒÙÙ‘Ø±Ù’ Ø¥ÙÙ†ÙÙ‘Ù…ÙØ§ Ø£ÙÙ†Ù’ØªÙ Ù…ÙØ°ÙÙƒÙÙ‘Ø±ÙŒ", question: "Temukan Ikhfa Syafawi (Mim Mati)", targetIndex: [2] }, 
        { text: "Ø¹ÙÙ†Ù’ Ù†ÙØ¨ÙØ¥Ù Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù", question: "Temukan Idgham Bighunnah (Nun Mati)", targetIndex: [0] },
        { text: "ÙƒÙØ±ÙØ§Ù…Ù‹Ø§ ÙƒÙØ§ØªÙØ¨ÙÙŠÙ†Ù", question: "Temukan Ikhfa Haqiqi", targetIndex: [0] },
        { text: "Ù„ÙÙ†ÙØ³Ù’ÙÙØ¹Ù‹Ø§ Ø¨ÙØ§Ù„Ù†ÙÙ‘Ø§ØµÙÙŠÙØ©Ù", question: "Temukan Iqlab (Tanwin)", targetIndex: [0] },

        // LEVEL 11-20: MIM SUKUN & QALQALAH
        { text: "Ù„ÙÙ‡ÙÙ…Ù’ Ù…ÙØ§ ÙŠÙØ´ÙØ§Ø¡ÙÙˆÙ†Ù", question: "Temukan Idgham Mimi", targetIndex: [0] },
        { text: "ØªÙØ±Ù’Ù…ÙÙŠÙ‡ÙÙ…Ù’ Ø¨ÙØ­ÙØ¬ÙØ§Ø±ÙØ©Ù", question: "Temukan Ikhfa Syafawi", targetIndex: [0] },
        { text: "Ø£ÙÙ„ÙÙ…Ù’ ØªÙØ±Ù ÙƒÙÙŠÙ’ÙÙ", question: "Temukan Izhar Syafawi", targetIndex: [0] },
        { text: "Ù‚ÙÙ„Ù’ Ù‡ÙÙˆÙ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙØ­ÙØ¯ÙŒ", question: "Temukan Qalqalah Kubra", targetIndex: [3] },
        { text: "ÙˆÙØ§Ù„Ù’Ø¹ÙØ§Ø¯ÙÙŠÙØ§ØªÙ Ø¶ÙØ¨Ù’Ø­Ù‹Ø§", question: "Temukan Qalqalah Sugra", targetIndex: [1] },
        { text: "Ù„ÙÙƒÙÙ…Ù’ Ø¯ÙÙŠÙ†ÙÙƒÙÙ…Ù’ ÙˆÙÙ„ÙÙŠÙ Ø¯ÙÙŠÙ†Ù", question: "Temukan Izhar Syafawi", targetIndex: [0, 1] },
        { text: "ÙÙÙŠ Ø¬ÙÙŠØ¯ÙÙ‡ÙØ§ Ø­ÙØ¨Ù’Ù„ÙŒ", question: "Temukan Qalqalah Sugra", targetIndex: [2] },
        { text: "Ø¥ÙÙ†ÙÙ‘ Ø±ÙØ¨ÙÙ‘Ù‡ÙÙ…Ù’ Ø¨ÙÙ‡ÙÙ…Ù’", question: "Temukan Ikhfa Syafawi", targetIndex: [1] },
        { text: "ÙˆÙÙ…ÙØ§ Ù„ÙÙ‡ÙÙ…Ù’ Ù…ÙÙ†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù", question: "Temukan Idgham Mimi", targetIndex: [1] },
        { text: "Ù…ÙØ§ Ø£ÙØºÙ’Ù†ÙÙ‰Ù° Ø¹ÙÙ†Ù’Ù‡Ù Ù…ÙØ§Ù„ÙÙ‡Ù ÙˆÙÙ…ÙØ§ ÙƒÙØ³ÙØ¨Ù", question: "Temukan Qalqalah Kubra", targetIndex: [5] },

        // LEVEL 21-30: LAM & RA & GUNNAH
        { text: "Ø§ÙÙ„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„Ù‘Ù°Ù‡Ù Ø±ÙØ¨ÙÙ‘ Ø§Ù„Ù’Ø¹Ù°Ù„ÙÙ…ÙÙŠÙ’Ù†Ù", question: "Temukan Alif Lam Qamariyah", targetIndex: [0, 3] },
        { text: "Ù…ÙØ§Ù„ÙÙƒÙ ÙŠÙÙˆÙ’Ù…Ù Ø§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù", question: "Temukan Alif Lam Syamsiyah", targetIndex: [2] },
        { text: "ØºÙÙŠÙ’Ø±Ù Ø§Ù„Ù’Ù…ÙØºÙ’Ø¶ÙÙˆØ¨Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡ÙÙ…Ù’", question: "Temukan Ra Tarqiq (Tipis)", targetIndex: [0] },
        { text: "Ù†ÙØµÙ’Ø±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ§Ù„Ù’ÙÙØªÙ’Ø­Ù", question: "Temukan Lafzul Jalalah Tafkhim", targetIndex: [1] },
        { text: "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…ÙÙ°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÙŠÙ…Ù", question: "Temukan Lafzul Jalalah Tarqiq", targetIndex: [1] },
        { text: "Ø¥ÙÙ†ÙÙ‘ Ø§Ù„Ù’Ø¥ÙÙ†Ù’Ø³ÙØ§Ù†Ù Ù„ÙÙÙÙŠ Ø®ÙØ³Ù’Ø±Ù", question: "Temukan Gunnah (Nun Bertasydid)", targetIndex: [0] },
        { text: "Ø«ÙÙ…ÙÙ‘ Ù„ÙØªÙØ³Ù’Ø£ÙÙ„ÙÙ†ÙÙ‘ ÙŠÙÙˆÙ’Ù…ÙØ¦ÙØ°Ù", question: "Temukan Gunnah (Mim Bertasydid)", targetIndex: [0] },
        { text: "ÙˆÙØ§Ù„Ø´ÙÙ‘Ù…Ù’Ø³Ù ÙˆÙØ¶ÙØ­ÙØ§Ù‡ÙØ§", question: "Temukan Alif Lam Syamsiyah", targetIndex: [0] },
        { text: "ÙˆÙØ§Ù„Ù’Ù‚ÙÙ…ÙØ±Ù Ø¥ÙØ°ÙØ§ ØªÙÙ„ÙØ§Ù‡ÙØ§", question: "Temukan Alif Lam Qamariyah", targetIndex: [0] },
        { text: "ÙÙØ±Ù’Ø¹ÙÙˆÙ’Ù†Ù Ø°ÙÙŠ Ø§Ù„Ù’Ø£ÙÙˆÙ’ØªÙØ§Ø¯Ù", question: "Temukan Ra Tarqiq", targetIndex: [0] },

        // LEVEL 31-40: MAD (PANJANG)
        { text: "Ø¥ÙÙ†ÙÙ‘Ø§ Ø£ÙØ¹Ù’Ø·ÙÙŠÙ’Ù†ÙØ§ÙƒÙ Ø§Ù„Ù’ÙƒÙÙˆÙ’Ø«ÙØ±Ù", question: "Temukan Mad Jaiz Munfasil", targetIndex: [0] },
        { text: "Ø¥ÙØ°ÙØ§ Ø¬ÙØ§Ø¡Ù Ù†ÙØµÙ’Ø±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù", question: "Temukan Mad Wajib Muttasil", targetIndex: [1] },
        { text: "Ø£ÙØ±ÙØ£ÙÙŠÙ’ØªÙ Ø§Ù„ÙÙ‘Ø°ÙÙŠ ÙŠÙÙƒÙØ°ÙÙ‘Ø¨Ù Ø¨ÙØ§Ù„Ø¯ÙÙ‘ÙŠÙ†Ù", question: "Temukan Mad Arid Lissukun", targetIndex: [3] },
        { text: "ÙˆÙÙ„ÙØ§ Ø§Ù„Ø¶ÙÙ‘Ø§Ù„ÙÙ‘ÙŠÙ†Ù", question: "Temukan Mad Lazim Kilmi Mutsaqqal", targetIndex: [1] },
        { text: "Ù†ÙÙˆØ­ÙŠÙÙ‡ÙØ§", question: "Temukan Mad Thabi'i", targetIndex: [0] },
        { text: "Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ø£ÙØ·Ù’Ø¹ÙÙ…ÙÙ‡ÙÙ…Ù’ Ù…ÙÙ†Ù’ Ø¬ÙÙˆØ¹Ù", question: "Temukan Mad Jaiz Munfasil", targetIndex: [0] },
        { text: "Ù‚ÙÙ„Ù’ ÙŠÙØ§ Ø£ÙÙŠÙÙ‘Ù‡ÙØ§ Ø§Ù„Ù’ÙƒÙØ§ÙÙØ±ÙÙˆÙ†Ù", question: "Temukan Mad Jaiz Munfasil", targetIndex: [1] },
        { text: "Ø³ÙÙŠÙØµÙ’Ù„ÙÙ‰Ù° Ù†ÙØ§Ø±Ù‹Ø§ Ø°ÙØ§ØªÙ Ù„ÙÙ‡ÙØ¨Ù", question: "Temukan Mad Thabi'i", targetIndex: [2] },
        { text: "Ù„ÙØ¥ÙÙŠÙ„ÙØ§ÙÙ Ù‚ÙØ±ÙÙŠÙ’Ø´Ù", question: "Temukan Mad Badal (Hamzah ketemu Mad)", targetIndex: [0] },
        { text: "ÙÙÙ„Ù’ÙŠÙØ¹Ù’Ø¨ÙØ¯ÙÙˆØ§ Ø±ÙØ¨ÙÙ‘ Ù‡ÙÙ°Ø°ÙØ§ Ø§Ù„Ù’Ø¨ÙÙŠÙ’ØªÙ", question: "Temukan Mad Layyin (Wau Sukun didahului Fathah)", targetIndex: [3] },

        // LEVEL 41-50: GHARIB & LANJUTAN
        { text: "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ù…ÙØ¬Ù’Ø±ÙÙŠÙ’Ù‡ÙØ§", question: "Temukan Bacaan Imalah (Majreha)", targetIndex: [2] },
        { text: "Ù„ÙØ§ ØªÙØ£Ù’Ù…ÙÙ†ÙÙ‘Ø§ Ø¹ÙÙ„ÙÙ‰Ù° ÙŠÙÙˆØ³ÙÙÙ", question: "Temukan Bacaan Isymam (Ta'manna)", targetIndex: [1] },
        { text: "Ø¡ÙØ§Û¬Ø¹Ù’Ø¬ÙÙ…ÙÙŠÙŒÙ‘ ÙˆÙØ¹ÙØ±ÙØ¨ÙÙŠÙŒÙ‘", question: "Temukan Bacaan Tashil (A-a'jamiyyun)", targetIndex: [0] },
        { text: "Ø¨ÙØ¦Ù’Ø³Ù Ø§Ù„ÙØ§Ø³Ù’Ù…Ù Ø§Ù„Ù’ÙÙØ³ÙÙˆÙ‚Ù", question: "Temukan Bacaan Naql (Bisa'lismu)", targetIndex: [1] },
        { text: "ÙƒÙÙ„ÙÙ‘Ø§ Û– Ø¨ÙÙ„Ù’ Ûœ Ø±ÙØ§Ù†Ù", question: "Temukan Bacaan Saktah (Berhenti sejenak tanpa nafas)", targetIndex: [2] },
        { text: "ÙˆÙÙ‚ÙÙŠÙ„Ù Ù…ÙÙ†Ù’ Ûœ Ø±ÙØ§Ù‚Ù", question: "Temukan Bacaan Saktah", targetIndex: [1] },
        { text: "Ø§Ù„Ù… ï´¿Ù¡ï´¾ Ø°ÙÙ°Ù„ÙÙƒÙ Ø§Ù„Ù’ÙƒÙØªÙØ§Ø¨Ù", question: "Temukan Mad Lazim Harfi", targetIndex: [0] },
        { text: "ÙƒÙ‡ÙŠØ¹Øµ", question: "Temukan Mad Lazim Harfi Mukhaffaf", targetIndex: [0] },
        { text: "Ø·Ø³Ù…", question: "Temukan Mad Lazim Harfi Mutsaqqal", targetIndex: [0] },
        { text: "Ù‚ÙÙ„Ù Ø§Ù„Ù„Ù‘ÙÙ‡ÙÙ…Ù‘Ù Ù…ÙØ§Ù„ÙÙƒÙ Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ", question: "Temukan Lafzul Jalalah Tafkhim", targetIndex: [1] }
    ];
	
	
    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    
    function selectGame(gameId) {
        // 1. Filter Game yang Belum Siap
        if (gameId === 'nahwu') { 
            alert("Game ini sedang dalam pengembangan.");
            return;
        } else if (gameId === 'tahfidz') {
            alert("Game Sambung Ayat sedang disiapkan!");
            return;
        }
        
        // 2. Simpan Mode Game
        currentGameMode = gameId;
        
        // TAMBAHAN KHUSUS LCC
        if (gameId === 'lcc') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ”” LCC Cerdas Cermat";
            lccSessionScore = 0;
            lccSessionLevel = 0;
            // Sembunyikan board lain
            document.getElementById('gameBoardMufrodat').style.display = 'none';
            document.getElementById('mufrodatTimerContainer').style.display = 'none'; 
            document.getElementById('gameBoardFiqih').style.display = 'none';
            document.getElementById('gameBoardTajwid').style.display = 'none';
            
            // Tampilkan LCC Lobby
            document.getElementById('lccLobby').style.display = 'flex';
            document.getElementById('lccArena').style.display = 'none';

            // LOGIKA BARU: Hanya download soal jika main LCC dan soal belum ada
            if (lccData.umum.length === 0 && lccData.diniyah.length === 0) {
                 setTimeout(() => fetchLccQuestionsFromFirebase(), 500);
            }
        } 
        
        // 3. CEK USER DENGAN TELITI
        // Panggil checkSession() dulu untuk memastikan data terbaru terbaca
        const isLoggedIn = checkSession();

        if (!isLoggedIn) {
            // Jika benar-benar belum login, baru munculkan modal
            document.getElementById('guestModal').style.display = 'flex';
            document.getElementById('guestNameInput').focus();
            return; 
        }

        // 4. Jika sudah ada user, lanjut ke Tampilan Game
        startGameSequence();
    }

    // Fungsi helper untuk memulai game (dipisahkan agar rapi)
    function startGameSequence() {
        // 1. Sembunyikan Menu Utama & Tampilkan UI Game
        document.getElementById('gameMenu').style.display = 'none';
        document.getElementById('gameUI').style.display = 'flex';

        // 2. Reset Score & Level
        currentLevel = 1; 
        score = 0;

        // 3. HARD RESET: Sembunyikan SEMUA Papan Game & Lobby
        // Ini memastikan tidak ada game yang saling tumpuk
        document.getElementById('gameBoardMufrodat').style.display = 'none';
        document.getElementById('mufrodatTimerContainer').style.display = 'none'; 
        document.getElementById('gameBoardFiqih').style.display = 'none';
        document.getElementById('gameBoardTajwid').style.display = 'none';
        
        // PENTING: Sembunyikan Elemen LCC juga!
        document.getElementById('lccLobby').style.display = 'none';
        document.getElementById('lccArena').style.display = 'none';

        // 4. Tampilkan Papan Game sesuai Mode yang dipilih
        if (currentGameMode === 'mufrodat') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ§  Master Mufrodat";
            document.getElementById('gameBoardMufrodat').style.display = 'grid';
            document.getElementById('mufrodatTimerContainer').style.display = 'block';
            
        } else if (currentGameMode === 'fiqih') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ§© Puzzle Fiqih";
            document.getElementById('gameBoardFiqih').style.display = 'flex';
            
        } else if (currentGameMode === 'tajwid') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ” Detektif Tajwid";
            document.getElementById('gameBoardTajwid').style.display = 'flex';
        
        } else if (currentGameMode === 'lcc') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ”” LCC Cerdas Cermat";
            // Khusus LCC, tampilkan Lobby dulu
            document.getElementById('lccLobby').style.display = 'flex';
            
            // Cek apakah perlu download soal
            if (lccData.umum.length === 0 && lccData.diniyah.length === 0) {
                 setTimeout(() => fetchLccQuestionsFromFirebase(), 500);
            }
        }

        // 5. Update Leaderboard lokal
        fetchLeaderboard(false, true);
    }
	
	// === PENGATURAN SUARA ===
    let isMuted = false;

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('muteBtn');
        
        if (isMuted) {
            sfx.ctx.suspend(); // Matikan Audio Context
            btn.innerText = "ğŸ”‡ Off";
            btn.style.background = "rgba(239, 68, 68, 0.5)"; // Merah
        } else {
            sfx.ctx.resume(); // Hidupkan Audio Context
            btn.innerText = "ğŸ”Š On";
            btn.style.background = "rgba(255, 255, 255, 0.2)"; // Normal
        }
    }

    function backToMenu() {
        clearInterval(mufrodatInterval);
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('gameMenu').style.display = 'flex';
    }

    function checkSession() {
        // Cek 1: Login Utama dari Website Yayasan
        const sessionStr = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
        if (sessionStr) {
            const session = JSON.parse(sessionStr);
            if (session.loggedIn) {
                currentUser = session.userData;
                updateUserUI();
                return true; // Sudah Login
            }
        }

        // Cek 2: Login Tamu (Sesi Sementara Game)
        const guestStr = sessionStorage.getItem('guestSession');
        if (guestStr) {
            currentUser = JSON.parse(guestStr);
            updateUserUI();
            return true; // Sudah Login sebagai Tamu
        } 
        
        // Jika tidak ada keduanya
        currentUser = null;
        document.getElementById('userStatus').innerHTML = `Tamu`;
        document.getElementById('btnSave').disabled = true;
        document.getElementById('btnLoad').disabled = true;
        fetchLeaderboard(false, false); // Load leaderboard umum
        return false; // Belum Login
    }

    function updateUserUI() {
        document.getElementById('userStatus').innerHTML = `<b>ğŸ‘¤ ${currentUser.profileName}</b>`;
        document.getElementById('btnSave').disabled = false;
        document.getElementById('btnLoad').disabled = false;
        fetchLeaderboard(false, true);
    }

	// --- MODE LAWAN BOT (LATIHAN) ---
    function initLccGame() {
        // Fungsi ini kosongkan saja atau isi logika reset jika perlu
        // Karena user masih di Lobby LCC menunggu klik tombol "Lawan Bot"
    }
	
	// --- FUNGSI UI HOST ---
    function showHostSetup() {
        // Sembunyikan tombol awal, Munculkan settingan
        document.getElementById('lobbyButtons').style.display = 'none';
        document.getElementById('hostRoleSection').style.display = 'block';
    }

    function cancelHostSetup() {
        // Balik ke tampilan awal
        document.getElementById('hostRoleSection').style.display = 'none';
        document.getElementById('lobbyButtons').style.display = 'block';
    }

    function setHostRole(role) {
        hostRoleSelection = role;
        document.getElementById('rolePlayer').className = role === 'player' ? 'role-option selected' : 'role-option';
        document.getElementById('roleReferee').className = role === 'referee' ? 'role-option selected' : 'role-option';
    }

    // --- UPDATE: CREATE ROOM DENGAN ERROR HANDLING ---
    function createRoom() {
        // 1. Cek Koneksi Firebase
        if (!db) {
            Swal.fire('Error', 'Koneksi Database Gagal. Cek internet/config.', 'error');
            return;
        }

        const name = document.getElementById('playerNameInput').value || "Host";
        if (!name.trim()) {
            Swal.fire('Peringatan', 'Masukkan nama dulu!', 'warning');
            return;
        }

        const roomId = Math.floor(1000 + Math.random() * 9000).toString();
        
        // 2. Tampilkan Loading
        Swal.fire({
            title: 'Membuat Room...',
            text: 'Mohon tunggu sebentar',
            allowOutsideClick: false,
            didOpen: () => { Swal.showLoading(); }
        });

        // Ambil Config
        const config = {
            stages: parseInt(document.getElementById('confStages').value) || 3,
            qPerStage: parseInt(document.getElementById('confQuestions').value) || 5,
            tBuzz: parseInt(document.getElementById('confTimerBuzz').value) || 7,
            tAns: parseInt(document.getElementById('confTimerAns').value) || 10
        };

        // Set Global Var
        MAX_STAGES = config.stages;
        QUESTIONS_PER_STAGE = config.qPerStage;
        TIMER_BUZZER_DURATION = config.tBuzz;
        TIMER_ANSWER_DURATION = config.tAns;
        isHostReferee = (hostRoleSelection === 'referee');
        
        lccRoomId = roomId;
        lccMyPlayerId = 'p1';
        lccMode = 'multi';
        
        const roomData = {
            status: 'waiting',
            host: name,
            config: config,
            currentRound: -1, 
            buzzer: null,     
            scores: { p1: 0, p2: 0, p3: 0, p4: 0 },
            players: {
                p1: { name: name, role: hostRoleSelection, ready: true }
            }
        };

        // 3. COBA SIMPAN KE FIREBASE
        db.ref('rooms/' + roomId).set(roomData)
            .then(() => {
                // BERHASIL
                Swal.close(); // Tutup loading
                
                // Sembunyikan form setup
                document.getElementById('hostRoleSection').style.display = 'none';
                
                // Masuk Waiting Room
                showWaitingRoom(roomId, true);
                watchGameRoom(roomId);
            })
            .catch((error) => {
                // GAGAL
                console.error("Firebase Error:", error);
                Swal.fire({
                    icon: 'error',
                    title: 'Gagal Membuat Room',
                    text: 'Kemungkinan Database Rules terkunci. ' + error.message
                });
            });
    }


    function startLccBotMode() {
        // PERBAIKAN: Cek ke lccData (umum & diniyah), bukan lccQuestions
        if (lccData.umum.length === 0 && lccData.diniyah.length === 0) {
            alert("Sedang memuat soal dari server...");
            fetchLccQuestionsFromFirebase();
            return;
        }

        lccMode = 'bot';
        document.getElementById('lccLobby').style.display = 'none';
        document.getElementById('lccArena').style.display = 'flex';
        
        // Reset Skor
        lccScores = { A: 0, B: 0, C: 0 };
		lccCurrentStage = 1; // Reset Babak
        lccRound = 0;
		
		document.getElementById('stageDisplay').innerText = "BABAK 1: PENYISIHAN";
        updateScoreUI();
		
        document.getElementById('nameA').innerText = currentUser ? currentUser.profileName.split(' ')[0] : "Kamu";
        document.getElementById('nameB').innerText = "Bot Alfa";
        document.getElementById('nameC').innerText = "Bot Beta";
        
        nextLccQuestion();
    }

    function nextLccQuestion() {
        // Cek apakah soal dalam babak ini sudah habis?
        if (lccRound >= QUESTIONS_PER_STAGE) {
            handleStageTransition();
            return;
        }

        // 1. Reset State Ronde
        lccAttemptedPlayers = []; // Kosongkan daftar penjahat (eh, penjawab salah)
        lccBuzzerLocked = false;
        clearTimeout(lccBotTimer);
        clearInterval(lccTypeInterval);
		stopLccTimer(); // Pastikan timer mati

        // 2. Reset UI (Hilangkan efek eliminated & active)
        document.querySelectorAll('.team-score').forEach(el => {
            el.classList.remove('active', 'eliminated');
        });

        document.getElementById('buzzerBtn').disabled = false;
        document.getElementById('buzzerBtn').style.background = "radial-gradient(circleAt 30% 30%, #ff6b6b, #c0392b)";
        document.getElementById('buzzerBtn').innerText = "BEL";
		
        const optionsDiv = document.getElementById('answerOptions');
        optionsDiv.classList.add('hidden');
        
        // 3. Logika Pilih Soal (Sama seperti sebelumnya)
        let selectedCategory;
        const umumAda = lccData.umum.length > 0;
        const diniyahAda = lccData.diniyah.length > 0;

        if (umumAda && diniyahAda) {
            selectedCategory = Math.random() < 0.5 ? 'umum' : 'diniyah';
        } else if (umumAda) {
            selectedCategory = 'umum';
        } else {
            selectedCategory = 'diniyah';
        }

        const sourceArray = lccData[selectedCategory];
        lccCurrentQ = sourceArray[Math.floor(Math.random() * sourceArray.length)];
        
        // Update Label & Teks
        const labelEl = document.getElementById('lccCategoryBadge');
        labelEl.innerText = selectedCategory === 'umum' ? "ğŸŒ Pengetahuan Umum" : "â˜ªï¸ Pengetahuan Diniyah";
        labelEl.style.display = 'block';

        const qText = document.getElementById('lccQuestionText');
        qText.innerHTML = ""; 
        lccFullText = lccCurrentQ.q; 
        lccCharIndex = 0;           

        resumeReadingQuestion();
    }
	
	// --- FUNGSI BARU: TRANSISI BABAK & SAVE ---
    function handleStageTransition() {
        if (lccCurrentStage < MAX_STAGES) {
            // Lanjut ke Babak Berikutnya
            lccCurrentStage++;
            lccRound = 0; // Reset hitungan soal
            
            // Nama Babak
            let stageName = "";
            if (lccCurrentStage === 2) stageName = "SEMIFINAL";
            if (lccCurrentStage === 3) stageName = "FINAL";

            // Update UI
            document.getElementById('stageDisplay').innerText = `BABAK ${lccCurrentStage}: ${stageName}`;

            Swal.fire({
                title: 'Babak Selesai!',
                text: `Selamat! Lanjut ke Babak ${lccCurrentStage}: ${stageName}`,
                icon: 'success',
                confirmButtonText: 'Lanjut Main ğŸš€'
            }).then(() => {
                nextLccQuestion();
            });

        } else {
            // GAME OVER (Sudah Babak Terakhir)
            finishLccGame();
        }
    }

    function finishLccGame() {
        // Stop semua aktivitas
        stopAllGameLogic();
		
		// 1. AKUMULASI KE DATA SESI
        // Tambahkan skor pertandingan ini ke total sesi
        lccSessionScore += lccScores.A; 
        
        // Tambahkan jumlah babak yang dimainkan (biasanya 3 jika tamat) ke total sesi
        lccSessionLevel += lccCurrentStage;

        let title, subtext, icon;
        // Cek Menang/Kalah (Misal user harus Top 1)
        if (lccScores.A > lccScores.B && lccScores.A > lccScores.C) {
            title = "ğŸ† JUARA 1! ğŸ†";
            subtext = "Masya Allah! Performa yang luar biasa.";
            icon = "success";
            if(typeof sfx !== 'undefined') sfx.win();
        } else if (lccScores.A >= lccScores.B || lccScores.A >= lccScores.C) {
            title = "Runner Up! ğŸ¥ˆ"; // Juara 2 atau 3
            subtext = "Bagus! Sedikit lagi jadi juara.";
            icon = "info";
        } else {
            title = "Jangan Menyerah! ğŸ’ª";
            subtext = "Teruslah belajar dan coba lagi.";
            icon = "warning";
        }

        Swal.fire({
            title: title,
            html: `
                <div style="margin-bottom:10px; font-size:0.9rem; color:#666;">
                    Total Poin Sesi Ini (Hari Ini):
                </div>
                
                <div style="background: #f0fdf4; border: 2px solid #10b981; border-radius: 15px; padding: 20px; margin: 10px 0;">
                    <div style="font-size: 3.5rem; font-weight: 900; color: #10b981; line-height: 1;">
                        ${lccSessionScore}
                    </div>
                    <div style="font-size: 0.8rem; color: #065f46; margin-top:5px;">
                        (+${lccSessionLevel} Babak)
                    </div>
                </div>

                <div style="font-size:0.8rem; color:#888;">
                    Skor Match Terakhir: ${lccScores.A}
                </div>

                <div style="display:flex; justify-content:space-around; font-size:0.9rem; color:#666;">
                    <span>ğŸ¤– Bot Alfa: <b>${lccScores.B}</b></span>
                    <span>ğŸ¤– Bot Beta: <b>${lccScores.C}</b></span>
                </div>
            `,
            icon: icon,
            showDenyButton: true,       // Mengaktifkan tombol kedua
            confirmButtonText: 'ğŸ”„ Lanjut Main',
            denyButtonText: 'ğŸ  Selesai',
            confirmButtonColor: '#3b82f6', // Biru untuk Lanjut
            denyButtonColor: '#6b7280',    // Abu-abu untuk Selesai
            allowOutsideClick: false,
            allowEscapeKey: false
        }).then((result) => {
            if (result.isConfirmed) {
                // TOMBOL LANJUT -> Restart Game dari awal
                startLccBotMode();
            } else if (result.isDenied) {
			// SIMPAN KE SHEET OTOMATIS
        
        // Simpan dengan nama game 'lcc' dan level = Total Babak yang diselesaikan
        saveLccToSheet(); 
                // TOMBOL SELESAI -> Kembali ke Menu Utama
                backToMenu();
            }
        });
    }

    // Fungsi Khusus Simpan LCC
    function saveLccToSheet() {
        if (!currentUser) return;
        
        // Tampilkan notifikasi kecil
        const Toast = Swal.mixin({
            toast: true, position: 'top-end', showConfirmButton: false, timer: 3000
        });
        Toast.fire({ icon: 'info', title: 'Menyimpan skor...' });
		
		// --- LOGIKA PERHITUNGAN BARU (AKUMULASI) ---
        // currentLevel = Level total dari database (Global)
        // lccCurrentStage = Babak yang baru saja dimainkan (1, 2, atau 3)
        const finalLevel = currentLevel + lccSessionLevel;

        // score = Skor total dari database (Global)
        // lccScores.A = Poin yang didapat di sesi LCC ini
        const finalScore = score + lccSessionScore;

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'saveGameProgress', 
                username: currentUser.username, 
                nama: currentUser.profileName,
                level: finalLevel, 
                skor: finalScore,      // Simpan Skor total
                namaGame: 'lcc' 
            })
        }).then(r=>r.json()).then(res => {
            Toast.fire({ icon: 'success', title: 'Skor LCC tersimpan!' });
			currentLevel = finalLevel;
            score = finalScore;
            fetchLeaderboard(false, false); // Refresh leaderboard
        });
    }
	
	// --- FUNGSI BARU: MENANGANI JAWABAN SALAH ---
    function handleWrongAnswer(teamId) {
        // 1. Pastikan tombol jawaban HILANG TOTAL jika user (A) yang salah
        if (teamId === 'A') {
            const optionsDiv = document.getElementById('answerOptions');
            optionsDiv.classList.add('hidden');
            optionsDiv.innerHTML = ''; 
        }

        // 2. Masukkan ke daftar pemain yang sudah mencoba (jika belum ada)
        if (!lccAttemptedPlayers.includes(teamId)) {
            lccAttemptedPlayers.push(teamId);
        }
        
        // 3. Tandai visual (Redupkan skor pemain tsb & bunyikan suara salah)
        const teamEl = document.getElementById(`team${teamId}`);
        if(teamEl) {
            teamEl.classList.remove('active');
            teamEl.classList.add('eliminated');
        }
        if(typeof sfx !== 'undefined') sfx.wrong();

        // 4. Update Skor (Kurangi poin)
        updateLccScore(teamId, -50);

        // ============================================================
        // 5. CEK: Apakah SEMUA sudah salah? (Jumlah pemain = 3)
        // ============================================================
        if (lccAttemptedPlayers.length >= 3) {
            // Hentikan semua timer bot agar tidak tumpang tindih
            clearTimeout(lccBotTimer);
            clearInterval(lccTypeInterval);
            
            // Tampilkan Jawaban Benar & Lanjut
            showCorrectAnswer("Semua Salah!");
        
        } else {
            // JIKA BELUM SEMUA SALAH -> Oper Giliran
            
            // Pesan singkat
            Swal.fire({
                icon: 'error',
                title: 'Salah!',
                text: 'Kesempatan dilempar ke pemain lain...',
                timer: 1000,
                showConfirmButton: false
            }).then(() => {
                resumeGameAfterWrong();
            });
        }
    }

// --- FUNGSI BARU: TAMPILKAN JAWABAN BENAR ---
    function showCorrectAnswer(titleMsg) {
        // Ambil teks jawaban benar berdasarkan index kunci (correct)
        // lccCurrentQ.a adalah array pilihan jawaban, lccCurrentQ.correct adalah index jawaban benar (0-3)
        const correctAnswerText = lccCurrentQ.a[lccCurrentQ.correct];
        
        // Tampilkan Info
        Swal.fire({
            icon: 'info',
            title: titleMsg,
            html: `Jawaban yang benar adalah:<br><br><b style="font-size:1.2rem; color:#10b981;">${correctAnswerText}</b>`,
            timer: 4000, // Tampil selama 4 detik
            showConfirmButton: false,
            backdrop: `rgba(0,0,0,0.8)` // Gelapkan background biar fokus
        });

        // Lanjut ke soal berikutnya setelah popup hilang
        setTimeout(() => {
            lccRound++;
            nextLccQuestion();
        }, 4000);
    }

    // --- FUNGSI BARU: MELANJUTKAN GAME SETELAH SALAH ---
    function resumeGameAfterWrong() {
        // Buka kunci buzzer (global)
        lccBuzzerLocked = false;
        
        // Jika User ('A') belum tereliminasi, nyalakan tombol Bel-nya
        if (!lccAttemptedPlayers.includes('A')) {
            document.getElementById('buzzerBtn').disabled = false;
            document.getElementById('buzzerBtn').innerText = "BEL";
        } else {
            // Jika User sudah salah, tombol tetap mati (biar cuma bisa nonton bot)
            document.getElementById('buzzerBtn').disabled = true;
            document.getElementById('buzzerBtn').innerText = "ğŸš«";
        }

        // PENTING: Trigger Bot untuk mikir lagi (jika bot belum tereliminasi)
        // Cek apakah teks soal sudah selesai diketik?
        if (lccCharIndex >= lccFullText.length) {
            // Teks sudah selesai. 
            // Kita nyalakan timer visual (7 detik) TAPI callbacknya biarkan kosong atau handling timeout standar
            // Tujuannya memberi tekanan waktu, tapi membiarkan Bot mengambil keputusan sendiri
            
            startLccTimer(7, function() {
                // Jika waktu habis beneran (bot gak mau jawab & user gak jawab), baru paksa random
                handleNoBuzzerTimeout(); 
            });
            triggerBotThinking(); // Suruh bot mikir langsung
        } else {
            resumeReadingQuestion(); // Lanjut ketik soal
        }
    }

    // --- FUNGSI BARU: TAMPILKAN JAWABAN BENAR ---
    function showCorrectAnswer(msgTitle) {
        // Ambil teks jawaban benar dari array opsi
        const correctAnswerText = lccCurrentQ.a[lccCurrentQ.correct];
        
        Swal.fire({
            icon: 'info',
            title: msgTitle,
            html: `Jawaban yang benar adalah:<br><b>${correctAnswerText}</b>`,
            timer: 3000,
            showConfirmButton: false
        });

        // Lanjut soal setelah 2 detik
        lccRound++;
        setTimeout(nextLccQuestion, 3000);
    }


    // Fungsi Terpisah: Melanjutkan Pembacaan Soal
    function resumeReadingQuestion() {
        const qText = document.getElementById('lccQuestionText');
        
        clearInterval(lccTypeInterval);
        
        // Animasi Huruf per Huruf (40ms = Cukup halus & cepat)
        lccTypeInterval = setInterval(() => {
            if (lccCharIndex < lccFullText.length) {
                // Tambahkan satu huruf
                qText.innerHTML += lccFullText.charAt(lccCharIndex);
                lccCharIndex++;
            } else {
                // --- KETIK SELESAI ---
                clearInterval(lccTypeInterval);
                
				if (!lccBuzzerLocked) {
                    startLccTimer(7, function() {
                        handleNoBuzzerTimeout(); // Aksi jika tidak ada yang tekan bel
                    });
                }
                // --- PERBAIKAN 3: BOT BARU MIKIR SETELAH SELESAI KETIK ---
                if (!lccBuzzerLocked && lccMode === 'bot') {
                    // Beri jeda "berpikir" acak antara 1 sampai 3 detik setelah soal selesai
                    const thinkingTime = Math.random() * 2000 + 1000; 
                    
                    lccBotTimer = setTimeout(() => {
                        if (!lccBuzzerLocked) {
                            // Bot menekan bel (Peluang bot nekan 50% agar tidak selalu bot yg main)
                            if(Math.random() < 0.5) {
                                const botId = Math.random() > 0.5 ? 'B' : 'C';
                                botPressBuzzer(botId);
                            }
                        }
                    }, thinkingTime);
                }
            }
        }, 50); 
    }
	
	function handleNoBuzzerTimeout() {
        if (lccBuzzerLocked) return;

        // Cari siapa saja yang BELUM tereliminasi
        let activePlayers = ['A', 'B', 'C'].filter(id => !lccAttemptedPlayers.includes(id));
        
        if (activePlayers.length === 0) return; // Harusnya tidak terjadi

        // Pilih satu secara acak
        const randomVictim = activePlayers[Math.floor(Math.random() * activePlayers.length)];

        Swal.fire({
            icon: 'warning',
            title: 'Waktu Habis!',
            text: `Sistem menunjuk ${randomVictim === 'A' ? 'KAMU' : 'Bot ' + randomVictim} untuk menjawab!`,
            timer: 1500,
            showConfirmButton: false
        }).then(() => {
            // Paksa tekan bel buat dia
            if (randomVictim === 'A') {
                pressBuzzer(); 
            } else {
                botPressBuzzer(randomVictim);
            }
        });
    }
	
    // --- FUNGSI BARU: LOGIKA BOT BERPIKIR (DIPISAH) ---
    function triggerBotThinking() {
        if (lccBuzzerLocked || lccMode !== 'bot') return;

        // Tentukan Bot mana yang masih boleh main
        // Filter bot (B atau C) yang TIDAK ada di lccAttemptedPlayers
        let eligibleBots = ['B', 'C'].filter(id => !lccAttemptedPlayers.includes(id));

        if (eligibleBots.length === 0) return; // Semua bot sudah salah/gugur

        const thinkingTime = Math.random() * 2000 + 1000; 
        
        clearTimeout(lccBotTimer);
        lccBotTimer = setTimeout(() => {
            if (!lccBuzzerLocked) {
                // Pilih satu bot secara acak dari yang tersisa
                const randomBot = eligibleBots[Math.floor(Math.random() * eligibleBots.length)];
                
                // Peluang menekan bel (bisa diatur)
                if(Math.random() < 0.75) { 
                    botPressBuzzer(randomBot);
                }
            }
        }, thinkingTime);
    }

    function pressBuzzer() {
		if (lccBuzzerLocked && document.getElementById('buzzerBtn').innerText !== 'BEL') return;

        // 1. Matikan Timer Rebutan
        stopLccTimer();
        // --- LOGIKA BOT (LAMA) ---
        clearInterval(lccTypeInterval); 
        clearTimeout(lccBotTimer);      
        if(typeof sfx !== 'undefined') sfx.correct();
		
		if (lccBuzzerLocked) return;

        // --- LOGIKA MULTIPLAYER ---
        if (lccMode === 'multi') {
            // Gunakan Transaction agar rebutan bel adil (siapa cepat dia dapat di server)
            lccDbRef.child('buzzer').transaction((currentVal) => {
                // Jika kosong (null), berarti belum ada yang tekan -> Saya yang tekan
                return currentVal === null ? lccMyPlayerId : undefined; 
            }, (error, committed, snapshot) => {
                if (committed) {
                    // Saya berhasil menekan bel pertama!
                    sfx.correct();
                } else {
                    // Telat, orang lain sudah tekan
                    console.log("Keduluan orang lain!");
                }
            });
            return; 
        }
		
        // LOGIKA SINGLE PLAYER
        lccBuzzerLocked = true;
        document.getElementById('buzzerBtn').disabled = true;
        document.getElementById('buzzerBtn').innerText = "A";
        document.getElementById(`teamA`).classList.add('active');

        // Tampilkan Tombol Jawaban
        handleBuzzerWin('A'); 

        // 2. MULAI TIMER MENJAWAB (Misal 10 Detik)
        // Jika habis -> Anggap Salah
        startLccTimer(10, function() {
            // Waktu jawab habis!
            handleWrongAnswer('A'); 
        });
    }

    function botPressBuzzer(teamId) {
		stopLccTimer();
        // Hentikan timer & ketikan
        clearInterval(lccTypeInterval); 
        clearTimeout(lccBotTimer);
        
        if(typeof sfx !== 'undefined') sfx.flip();
        
        // Tampilkan full text
        document.getElementById('lccQuestionText').innerText = lccCurrentQ.q;
        
        // Kunci bel & Highlight Bot
        lccBuzzerLocked = true;
        document.getElementById('buzzerBtn').disabled = true;
        document.getElementById('buzzerBtn').innerText = teamId;
        document.getElementById(`team${teamId}`).classList.add('active');

        startLccTimer(5, null);
		// Bot Menjawab (Delay 1.5 detik seolah mikir)
        setTimeout(() => {
            // Logika Bot Menjawab Benar/Salah
            const isCorrect = Math.random() < 0.5; // 50% Peluang Benar
            
            if (isCorrect) {
                updateLccScore(teamId, 100);
                if(typeof sfx !== 'undefined') sfx.win();
                Swal.fire({ icon: 'success', title: `Bot ${teamId} Benar!`, timer: 1500, showConfirmButton:false });
                showAnswerAndNext(true, `Bot ${teamId}`);
				lccRound++;
                setTimeout(nextLccQuestion, 2000);
            } else {
                // BOT SALAH -> Lempar ke handleWrongAnswer
                Swal.fire({ icon: 'error', title: `Bot ${teamId} Salah!`, timer: 1000, showConfirmButton:false }).then(() => {
                    handleWrongAnswer(teamId);
                });
            }
        }, 1500);
    }
	
	function handleMultiBuzzerWin(winnerId) {
        lccBuzzerLocked = true;
        document.getElementById('buzzerBtn').disabled = true;
        
        // Tampilkan siapa yang menekan
        // Mapping ID: p1->A, p2->B, p3->C
        let uiId = 'A';
        if (winnerId === 'p2') uiId = 'B';
        if (winnerId === 'p3') uiId = 'C';

        document.getElementById('buzzerBtn').innerText = document.getElementById('name'+uiId).innerText;
        document.getElementById(`team${uiId}`).classList.add('active');
        if(typeof sfx !== 'undefined') sfx.flip();

        // Jika SAYA yang menang, tampilkan tombol jawaban
        if (winnerId === lccMyPlayerId) {
            const optionsDiv = document.getElementById('answerOptions');
            optionsDiv.innerHTML = '';
            optionsDiv.classList.remove('hidden');
            
            // Shuffle opsi jawaban
            let shuffledOptions = lccCurrentQ.a.map((text, index) => ({ text, index }));
            shuffledOptions.sort(() => Math.random() - 0.5);

            shuffledOptions.forEach((opt) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.fontSize = '0.9rem';
                btn.innerText = opt.text;
                btn.onclick = () => checkLccAnswer(opt.index); // Kirim jawaban
                optionsDiv.appendChild(btn);
            });
        }
    }

    function handleBuzzerWin(teamId) {
        lccBuzzerLocked = true;
        document.getElementById('buzzerBtn').disabled = true;
        document.getElementById('buzzerBtn').innerText = teamId;
        document.getElementById(`team${teamId}`).classList.add('active');

        if (teamId === 'A') {
            // Tampilkan Opsi Jawaban User
            const optionsDiv = document.getElementById('answerOptions');
            optionsDiv.innerHTML = '';
            optionsDiv.classList.remove('hidden');
            
            // --- LOGIKA BARU: SHUFFLE (ACAK) POSISI TOMBOL ---
            
            // 1. Buat array objek yang menyimpan teks dan index aslinya
            let shuffledOptions = lccCurrentQ.a.map((text, index) => ({
                text: text,
                originalIndex: index
            }));

            // 2. Acak urutan array tersebut
            shuffledOptions.sort(() => Math.random() - 0.5);

            // 3. Render tombol berdasarkan urutan yang sudah diacak
            shuffledOptions.forEach((opt) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-primary';
                btn.style.fontSize = '0.9rem';
                btn.innerText = opt.text;
                
                // Saat diklik, kita kirim index ASLI-nya untuk dicek
                btn.onclick = () => checkLccAnswer(opt.originalIndex);
                
                optionsDiv.appendChild(btn);
            });
        }
    }

    function checkLccAnswer(idx) {
        const optionsDiv = document.getElementById('answerOptions');

        // PROTEKSI 1: Cek apakah tombol jawaban seharusnya TERSEMBUNYI?
        // Jika class 'hidden' ada, berarti user mencoba klik tombol hantu/ilegal.
        if (optionsDiv.classList.contains('hidden')) {
            return; // Abaikan klik sepenuhnya
        }

        // PROTEKSI 2: Cek apakah BEL SUDAH DITEKAN oleh TIM A (User)?
        const isMyTurn = document.getElementById('teamA').classList.contains('active');
        if (!lccBuzzerLocked || !isMyTurn) {
            Swal.fire({
                icon: 'warning',
                title: 'Tekan Bel Dulu!',
                text: 'Anda tidak bisa menjawab sebelum menekan bel.',
                timer: 1000,
                showConfirmButton: false
            });
            // Paksa sembunyikan tombol jika muncul ilegal
            optionsDiv.classList.add('hidden');
            optionsDiv.innerHTML = ''; 
            return;
        }

        // PROTEKSI 3: Cek apakah sudah pernah salah jawab
        if (lccAttemptedPlayers.includes('A')) return;
		
		stopLccTimer();

        // --- VALIDASI LOLOS, PROSES JAWABAN ---
        
        // Hilangkan tombol segera
        optionsDiv.classList.add('hidden');
        optionsDiv.innerHTML = ''; 

        // Cek Jawaban Benar/Salah
        if (idx === lccCurrentQ.correct) {
            if(typeof sfx !== 'undefined') sfx.win();
            updateLccScore('A', 100);
            Swal.fire({ icon: 'success', title: 'Benar!', timer: 1500, showConfirmButton:false });
			showAnswerAndNext(true, "Kamu");
            lccRound++;
            setTimeout(nextLccQuestion, 2000);
        } else {
            handleWrongAnswer('A');
        }
    }

    function updateLccScore(team, amount) {
        lccScores[team] += amount;
		// --- TAMBAHAN PENTING ---
        // Jika yang dapat poin adalah Tim A (User), update juga variabel global 'score'
        // agar bisa disimpan ke database dan masuk leaderboard.
        
        updateScoreUI();
    }

    function updateScoreUI() {
        document.getElementById('scoreA').innerText = lccScores.A;
        document.getElementById('scoreB').innerText = lccScores.B;
        document.getElementById('scoreC').innerText = lccScores.C;
    }

	function startLccTimer(durationSeconds, onTimeoutCallback) {
        clearInterval(lccGameTimer);
        
        const clockEl = document.getElementById('lccTimerClock');
        const textEl = document.getElementById('lccTimerText');
        
        clockEl.style.display = 'flex';
        clockEl.style.setProperty('--deg', '360deg'); // Mulai penuh
        clockEl.style.setProperty('--color', '#10b981'); // Hijau
        
        let timeLeft = durationSeconds;
        const totalTime = durationSeconds;
        
        // Update tampilan awal
        textEl.innerText = Math.ceil(timeLeft);

        lccGameTimer = setInterval(() => {
            timeLeft -= 0.1; 
            
            // Hitung Derajat (360 derajat = 100%)
            const percentage = (timeLeft / totalTime);
            const degrees = percentage * 360;
            
            clockEl.style.setProperty('--deg', `${degrees}deg`);
            textEl.innerText = Math.ceil(timeLeft);

            // Ubah Warna: Kuning di 50%, Merah di 20%
            if (percentage < 0.2) clockEl.style.setProperty('--color', '#ef4444');
            else if (percentage < 0.5) clockEl.style.setProperty('--color', '#f59e0b');

            if (timeLeft <= 0) {
                clearInterval(lccGameTimer);
                clockEl.style.display = 'none';
                if (onTimeoutCallback) onTimeoutCallback();
            }
        }, 100);
    }

    function stopLccTimer() {
        clearInterval(lccGameTimer);
        document.getElementById('lccTimerClock').style.display = 'none';
    }
	
    // --- MODE MULTIPLAYER (FIREBASE) ---
    // Ini adalah kerangka dasar. User perlu memasukkan Config Firebase di atas.
    
    
    
    function joinRoomPrompt() {
        if (!db) return alert("Firebase belum siap.");
        const name = document.getElementById('playerNameInput').value || "Player 2";
        const roomId = prompt("Masukkan Kode Room (4 Digit):");
        
        if (roomId) {
            const roomRef = db.ref('rooms/' + roomId);
            roomRef.get().then((snapshot) => {
                if (snapshot.exists()) {
                    const data = snapshot.val();
                    if (data.status !== 'waiting') return alert("Game sudah berjalan!");
                    
                    // Cari slot kosong (p2, p3, p4)
                    let myId = null;
                    for(let i=2; i<=4; i++) {
                        if(!data.players || !data.players['p'+i]) {
                            myId = 'p'+i;
                            break;
                        }
                    }

                    if (!myId) return alert("Room penuh (Maks 4 orang)!");

                    // Simpan info & Update Firebase
                    lccRoomId = roomId;
                    lccMyPlayerId = myId;
                    lccMode = 'multi';
                    
                    roomRef.child('players/' + myId).set({ name: name, score: 0 });
                    
                    showWaitingRoom(roomId, false);
                    watchGameRoom(roomId);
                } else {
                    alert("Room tidak ditemukan.");
                }
            });
        }
    }

    function showWaitingRoom(roomId, isHost) {
        // 1. Sembunyikan elemen input & tombol lobi agar bersih
        document.getElementById('playerNameInput').style.display = 'none';
        document.getElementById('lobbyButtons').style.display = 'none';
        document.getElementById('hostRoleSection').style.display = 'none';

        // 2. Tampilkan Area Menunggu (Paksa display block)
        const waitingDiv = document.getElementById('waitingRoom');
        waitingDiv.style.display = 'block';
        waitingDiv.classList.remove('hidden');

        // 3. Set Kode Room
        document.getElementById('displayRoomCode').innerText = roomId;

        // 4. Tampilkan Tombol Mulai (Hanya untuk Host)
        if (isHost) {
            const startBtn = document.getElementById('btnStartMulti');
            startBtn.style.display = 'inline-block'; // Munculkan tombol
            startBtn.classList.remove('hidden');
        }
    }

    // FUNGSI YANG HILANG SEBELUMNYA
    function startMultiplayerGame() {
        // 1. Pastikan soal sudah siap
        if (lccData.umum.length === 0 && lccData.diniyah.length === 0) {
            alert("Sedang memuat soal...");
            fetchLccQuestionsFromFirebase();
            return;
        }

        // 2. Generate Soal Acak untuk Sesi Ini (10 Soal)
        // Kita simpan index kategori dan index soalnya agar sinkron semua pemain
        let gameQuestions = [];
        for(let i=0; i<10; i++) {
            // Pilih kategori (50:50 logic)
            const cat = (Math.random() < 0.5 && lccData.umum.length > 0) ? 'umum' : 'diniyah';
            // Pilih index soal
            const qIndex = Math.floor(Math.random() * lccData[cat].length);
            gameQuestions.push({ cat: cat, idx: qIndex });
        }

        // 3. Update Firebase untuk Memulai Game
        db.ref('rooms/' + lccRoomId).update({
            status: 'playing',
            questionList: gameQuestions,
            currentRound: 0,
            buzzer: null
        });
    }
	
	function watchGameRoom(roomId) {
        lccDbRef = db.ref('rooms/' + roomId);

        lccDbRef.on('value', (snapshot) => {
            const data = snapshot.val();
            if (!data) return; 

            // 1. SYNC ATURAN MAIN (PENTING BAGI YANG JOIN)
            if (data.config) {
                MAX_STAGES = data.config.stages;
                QUESTIONS_PER_STAGE = data.config.qPerStage;
                TIMER_BUZZER_DURATION = data.config.tBuzz;
                TIMER_ANSWER_DURATION = data.config.tAns;
            }

            // 2. Update List Pemain
            const list = document.getElementById('lobbyPlayerList');
            list.innerHTML = '';
            for (let pid in data.players) {
                let roleLabel = "";
                if(data.players[pid].role === 'referee') roleLabel = " (JURI âš–ï¸)";
                list.innerHTML += `<li>${data.players[pid].name} ${roleLabel}</li>`;
            }

            // 3. Deteksi Game Mulai
            if (data.status === 'playing') {
                document.getElementById('lccLobby').style.display = 'none';
                document.getElementById('lccArena').style.display = 'flex';
                
                // CEK APAKAH SAYA JURI?
                // Jika saya p1 dan role di DB adalah referee
                if (lccMyPlayerId === 'p1' && data.players.p1.role === 'referee') {
                    isHostReferee = true;
                    // Sembunyikan Tombol Bel Total
                    document.getElementById('buzzerBtn').style.display = 'none';
                    // Tampilkan pesan Juri
                    const badge = document.createElement('div');
                    badge.innerHTML = "<b>ANDA ADALAH JURI</b><br>Mengawasi Pertandingan";
                    badge.style.cssText = "background:#333; color:white; padding:10px; border-radius:8px; margin-bottom:10px;";
                    document.querySelector('#lccArena').prepend(badge);
                }

                // ... (Sisa logika update skor sama seperti sebelumnya) ...
                for(let i=1; i<=3; i++) { 
                     if(data.players['p'+i]) {
                         document.getElementById('name'+ String.fromCharCode(64+i)).innerText = data.players['p'+i].name;
                         document.getElementById('score'+ String.fromCharCode(64+i)).innerText = data.scores['p'+i] || 0;
                     }
                }
                
                if (!window.multiQuestions && data.questionList) {
                    window.multiQuestions = data.questionList;
                }

                if (data.currentRound !== lccRound) {
                    lccRound = data.currentRound;
                    // Cek batas soal menggunakan variabel dynamic
                    if (lccRound < (QUESTIONS_PER_STAGE * MAX_STAGES)) { // Logic simpel total soal
                        displayMultiQuestion(data.currentRound);
                    } else {
                        // Game Over logic
                    }
                }

                if (data.buzzer) {
                    handleMultiBuzzerWin(data.buzzer);
                } else {
                    if (document.getElementById('buzzerBtn').innerText !== "BEL" && !isHostReferee) {
                        resetBuzzerUI(); 
                    }
                }
            }
        });
    }
	
	// --- FUNGSI BARU: TAMPILKAN HASIL JAWABAN (USER/BOT/LAWAN) ---
    function showAnswerAndNext(isCorrect, winnerName) {
        // Ambil jawaban benar
        const correctAnswerText = lccCurrentQ.a[lccCurrentQ.correct];
        
        let title, icon, htmlContent;

        if (isCorrect) {
            title = `Benar! ğŸ‰`;
            icon = 'success';
            htmlContent = `${winnerName} menjawab dengan tepat.<br><br>Jawaban: <b>${correctAnswerText}</b>`;
        } else {
            title = `Salah! âŒ`;
            icon = 'error';
            htmlContent = `Jawaban kurang tepat.<br><br>Yang benar adalah: <b style="color:#10b981;">${correctAnswerText}</b>`;
        }

        // Tampilkan Popup selama 3 detik
        Swal.fire({
            title: title,
            html: htmlContent,
            timer: 3000,
            showConfirmButton: false,
            backdrop: `rgba(0,0,0,0.5)`
        }).then(() => {
            // Setelah popup, lanjut ke soal berikutnya
            // Jika Multiplayer: Host update firebase
            // Jika Single: Panggil nextLccQuestion
            if (lccMode === 'multi') {
                 // Di Multiplayer, biarkan listener yang handle perubahan ronde
                 // Kecuali saya Host, maka saya yang update ronde
                 if (lccMyPlayerId === 'p1') {
                     // Host mengupdate ronde setelah delay tampil jawaban
                     lccDbRef.update({
                        buzzer: null,
                        currentRound: lccRound + 1
                    });
                 }
            } else {
                lccRound++;
                nextLccQuestion();
            }
        });
    }

    function displayMultiQuestion(roundIdx) {
        // Reset UI
        resetBuzzerUI();
        
        // Ambil Soal dari Cache
        const qData = window.multiQuestions[roundIdx];
        lccCurrentQ = lccData[qData.cat][qData.idx];

        // Tampilkan Teks (Langsung full text biar adil masalah koneksi)
        document.getElementById('lccQuestionText').innerHTML = 
            `<div style="font-size:0.8rem;color:#666;">Soal ${roundIdx+1}/10</div>` + lccCurrentQ.q;
    }

    function resetBuzzerUI() {
        lccBuzzerLocked = false;
        document.getElementById('buzzerBtn').disabled = false;
        document.getElementById('buzzerBtn').style.background = "";
        document.getElementById('buzzerBtn').innerText = "BEL";
        document.getElementById('answerOptions').classList.add('hidden');
        document.querySelectorAll('.team-score').forEach(el => el.classList.remove('active'));
    }

	function submitGuestName() {
        const nameInput = document.getElementById('guestNameInput');
        const name = nameInput.value.trim();

        if (name.length < 3) {
            alert("Nama terlalu pendek (min 3 huruf).");
            return;
        }

        // Buat ID unik untuk tamu agar tidak menimpa data orang lain di server
        // Format: guest_TIMESTAMP_ACAK
        const formattedName = `${name} (Tamu)`;

        const guestUser = {
            username: formattedName,     // ID Unik untuk database
            profileName: name + " (Tamu)", // Nama Tampilan
            isGuest: true
        };

        // Simpan ke Session Storage (Hilang kalau tutup browser, tapi tahan refresh)
        sessionStorage.setItem('guestSession', JSON.stringify(guestUser));
        
        // Set global user
        currentUser = guestUser;
        updateUserUI();

        // Tutup modal dan mulai game
        document.getElementById('guestModal').style.display = 'none';
        startGameSequence();
    }

    function getRankInfo(level) {
        if (level >= 46) return { title: "ğŸ‘‘ Syaikhul 'Ilmi", class: "rank-legend" };
        if (level >= 31) return { title: "âš”ï¸ Farisul Lughah", class: "rank-master" };
        if (level >= 16) return { title: "ğŸ“š Hafizh Mufrodat", class: "rank-high" };
        if (level >= 6)  return { title: "ğŸ”¥ Thalib Mujtahid", class: "rank-mid" };
        return { title: "ğŸŒ± Thalib Jadid", class: "rank-new" };
    }

    function startGameLevel() {
        if (currentGameMode === 'mufrodat') startMufrodatLevel();
        else if (currentGameMode === 'fiqih') startFiqihLevel();
		else if (currentGameMode === 'tajwid') startTajwidLevel();
    }

    // === SAVE/LOAD ===
    function saveProgress(silent = false) {
        if (!currentUser) { if(!silent) alert("Login dulu!"); return; }
        if(!silent) showLoading(true);
        const btnSave = document.getElementById('btnSave');
        if(silent) btnSave.innerText = "â³...";

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'saveGameProgress', 
                username: currentUser.username, 
                nama: currentUser.profileName,
                level: currentLevel, skor: score,
                namaGame: currentGameMode 
            })
        }).then(r=>r.json()).then(res => {
            if(!silent) { showLoading(false); alert("Tersimpan!"); }
            else { btnSave.innerText = "âœ…"; setTimeout(()=>btnSave.innerText="ğŸ’¾ Simpan", 2000); }
            fetchLeaderboard(false, false);
        }).catch(e => { if(!silent) showLoading(false); });
    }

    function loadProgress() {
        if (!currentUser) return alert("Login dulu!");
        fetchLeaderboard(false, true);
    }

    function fetchLeaderboard(showModal = false, sync = false) {
        const lbContainer = document.getElementById('leaderboardList');
        if(!showModal && !sync) lbContainer.innerHTML = '<p style="text-align:center; color:#999;">...</p>';

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getGameLeaderboardAndProgress', 
                username: currentUser ? currentUser.username : '',
                namaGame: currentGameMode
            })
        }).then(r=>r.json()).then(res => {
            if(res.status === 'success') {
                const html = renderLbHtml(res.leaderboard, res.myProgress);
                lbContainer.innerHTML = html;
                
                // --- LOGIKA MAHKOTA HEADER (UPDATE BESAR) ---
                if (currentUser && res.leaderboard.length > 0) {
                    const champion = res.leaderboard[0];
                    const statusDiv = document.getElementById('userStatus');
                    
                    if (champion.username === currentUser.username) {
                        // JIKA JUARA 1: Pakai span khusus 'big-champion-crown'
                        // Dan beri padding kiri ekstra agar nama tidak tertutup mahkota besar
                        statusDiv.innerHTML = `<b><span class="big-champion-crown">ğŸ‘‘</span> ğŸ‘¤ ${currentUser.profileName}</b>`;
                        
                        // Style kotak emas
                        statusDiv.style.border = "3px solid #FFD700"; 
                        statusDiv.style.background = "linear-gradient(135deg, #064e3b 0%, #b45309 100%)";
                        statusDiv.style.boxShadow = "0 0 15px rgba(255, 215, 0, 0.5)"; // Efek bersinar
                        statusDiv.style.paddingLeft = "40px"; // Beri ruang untuk mahkota besar
                        statusDiv.style.paddingTop = "8px";
                        statusDiv.style.paddingBottom = "8px";
                    } else {
                        // JIKA BUKAN JUARA 1: Kembali normal
                        statusDiv.innerHTML = `<b>ğŸ‘¤ ${currentUser.profileName}</b>`;
                        statusDiv.style.border = "1px solid rgba(255,255,255,0.3)";
                        statusDiv.style.background = "rgba(255,255,255,0.15)";
                        statusDiv.style.boxShadow = "none";
                        statusDiv.style.paddingLeft = "10px"; // Reset padding
                        statusDiv.style.paddingTop = "4px";
                        statusDiv.style.paddingBottom = "4px";
                    }
                }
                // ----------------------------

                if(showModal) {
                    document.getElementById('modalLbContent').innerHTML = html;
                    document.getElementById('leaderboardModal').style.display = 'flex';
                }
                if(sync) {
                    if (res.myProgress) {
                        currentLevel = res.myProgress.level;
                        score = res.myProgress.skor;
                        document.getElementById('levelDisplay').innerText = currentLevel;
                        document.getElementById('scoreDisplay').innerText = score;
                        document.getElementById('btnLoad').innerText = `ğŸ“‚ Muat Ulang (Lv ${currentLevel})`;
                        startGameLevel();
                    } else {
                        startGameLevel();
                    }
                }
            }
        });
    }

    function renderLbHtml(list, me) {
        let html = '';
        list.forEach((item, i) => {
            let rankBadge = "";
            let rankClass = "";
            
            // Tentukan Ikon Juara (Disamping Nama)
            if (i === 0) { 
                rankBadge = " ğŸ¥‡ <span style='color:#d97706; font-weight:bold;'>The Champion</span>"; 
                rankClass = "rank-1";
            } 
            else if (i === 1) { 
                rankBadge = " ğŸ¥ˆ <span style='color:#4b5563; font-weight:bold;'>Runner Up</span>"; 
                rankClass = "rank-2";
            } 
            else if (i === 2) { 
                rankBadge = " ğŸ¥‰ <span style='color:#b45309; font-weight:bold;'>3rd Place</span>"; 
                rankClass = "rank-3";
            }

            // Gelar Level (Tetap muncul)
            let levelInfo = getRankInfo(item.level);

            const isMe = (me && item.username === me.username) ? 'my-rank-item' : '';
            
            html += `
            <div class="lb-item ${isMe}">
                <div class="lb-header">
                    <div>
                        <span class="lb-rank ${rankClass}">${i+1}</span> 
                        <span style="font-weight:bold;">${item.username}</span>
                        ${rankBadge} </div>
                    <span>${item.skor}</span>
                </div>
                <div class="lb-details">
                    <span class="rank-badge ${levelInfo.class}">${levelInfo.title}</span>
                    Lv ${item.level}
                </div>
            </div>`;
        });

        // Tampilkan posisi saya sendiri jika tidak masuk Top 10
        if(me && !list.find(i => i.username === me.username)) {
             let levelInfo = getRankInfo(me.level);
             html += `<div style="margin-top:10px; border-top:2px dashed #ccc; padding-top:10px;">
                <div class="lb-item my-rank-item">
                    <div class="lb-header">
                        <div><span class="lb-rank">?</span> Anda (${me.username})</div>
                        <span>${me.skor}</span>
                    </div>
                    <div class="lb-details">
                        <span class="rank-badge ${levelInfo.class}">${levelInfo.title}</span>
                        Lv ${me.level}
                    </div>
                </div>
            </div>`;
        }
        return html || '<p style="text-align:center;">Belum ada data.</p>';
    }

    // === MUFRODAT LOGIC (FULL) ===
    let mufrodatInterval, mfFirstCard, mfSecondCard, mfLockBoard, mfMatches, mfPairsNeeded, mfTimeLeft, mfTotalTime;

    function getLevelConfig(level) {
        let tierData, gridCols, pairs, timePerPair;
        
        if (level <= 10) { tierData = tier1; gridCols = 3; timePerPair = 15; } 
        else if (level <= 20) { tierData = [...tier1, ...tier2]; gridCols = 4; timePerPair = 12; } 
        else if (level <= 30) { tierData = [...tier2, ...tier3]; gridCols = 4; timePerPair = 10; } 
        else if (level <= 35) { tierData = [...tier3, ...tier4]; gridCols = 4; timePerPair = 10; }
        else if (level <= 40) { tierData = [...tier4, ...tier5]; gridCols = 5; timePerPair = 9; }
        else if (level <= 45) { tierData = [...tier5, ...tier6]; gridCols = 5; timePerPair = 8; }
        else { tierData = [...tier6, ...tier7]; gridCols = 5; timePerPair = 8; } 

        pairs = Math.min(4 + Math.floor(level / 3), 15); 
        if (window.innerWidth < 600 && gridCols > 4) gridCols = 4;

        return { data: tierData, cols: gridCols, pairs: pairs, time: Math.floor(pairs * timePerPair) + 10 };
    }

    function startMufrodatLevel() {
        const board = document.getElementById('gameBoardMufrodat');
        board.innerHTML = '';
        
        const config = getLevelConfig(currentLevel);
        
        mfPairsNeeded = config.pairs;
        mfTotalTime = config.time;
        mfTimeLeft = mfTotalTime;
        mfMatches = 0; mfLockBoard = false; mfFirstCard = null; mfSecondCard = null;

        document.getElementById('levelDisplay').innerText = currentLevel;
        document.getElementById('scoreDisplay').innerText = score;
        board.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;

        const shuffled = config.data.sort(() => 0.5 - Math.random()).slice(0, mfPairsNeeded);
        let deck = [];
        shuffled.forEach((item, i) => {
            deck.push({ id: i, content: item.a, type: 'arab' });
            deck.push({ id: i, content: item.i, type: 'indo' });
        });
        deck.sort(() => 0.5 - Math.random());

        deck.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = item.id;
            card.innerHTML = `<div class="face front">â“</div><div class="face back ${item.type==='arab'?'arabic-text':''}">${item.content}</div>`;
            card.addEventListener('click', flipMufrodatCard);
            board.appendChild(card);
        });

        startMufrodatTimer();
    }

    function startMufrodatTimer() {
        clearInterval(mufrodatInterval);
        const bar = document.getElementById('timerBar');
        bar.style.width = '100%';
        mufrodatInterval = setInterval(() => {
            mfTimeLeft -= 0.1;
            bar.style.width = `${(mfTimeLeft/mfTotalTime)*100}%`;
            if(mfTimeLeft <= 0) { clearInterval(mufrodatInterval); showGameOver(); }
        }, 100);
    }

// Fungsi untuk memunculkan efek teks
    function showFloatingTime(text) {
        const gameArea = document.querySelector('.game-area');
        const floatingEl = document.createElement('div');
        floatingEl.className = 'floating-time-text';
        floatingEl.innerText = text;
        
        // Masukkan elemen ke area game
        gameArea.appendChild(floatingEl);

        // Hapus elemen otomatis setelah animasi selesai (1.2 detik)
        setTimeout(() => {
            floatingEl.remove();
        }, 1200);
    }

    function flipMufrodatCard() {
        if (mfLockBoard || this === mfFirstCard || this.classList.contains('matched')) return;

        if(typeof sfx !== 'undefined') sfx.flip();
        this.classList.add('flipped');

        if (!mfFirstCard) { mfFirstCard = this; return; }
        mfSecondCard = this; mfLockBoard = true;

        if (mfFirstCard.dataset.id === mfSecondCard.dataset.id) {
            // --- JAWABAN BENAR ---
            if(typeof sfx !== 'undefined') sfx.correct();
            
            score += 10; mfMatches++;
            document.getElementById('scoreDisplay').innerText = score;
            mfFirstCard.classList.add('matched'); mfSecondCard.classList.add('matched');
            
            // === LOGIKA BONUS WAKTU & TEKS ===
            let bonus = 0;
            let textBonus = "";

            if (currentLevel >= 40) {
                bonus = 6;
                textBonus = "+6 Menit";
            } else if (currentLevel >= 20) {
                bonus = 5;
                textBonus = "+5 Menit";
            } else {
                bonus = 4;
                textBonus = "+4 Menit";
            }
            
            mfTimeLeft += bonus;
            // Batasi agar tidak melebihi waktu maksimal awal
            if(mfTimeLeft > mfTotalTime) mfTimeLeft = mfTotalTime;

            // PANGGIL EFEK TEKS
            showFloatingTime(textBonus);

            // Efek Bar Berkedip
            const bar = document.getElementById('timerBar');
            bar.classList.add('bonus'); 
            setTimeout(() => bar.classList.remove('bonus'), 500);
            
            mfFirstCard = null; mfSecondCard = null; mfLockBoard = false;
            if (mfMatches === mfPairsNeeded) showLevelComplete(Math.floor(mfTimeLeft));
        } else {
            // --- JAWABAN SALAH ---
            if(typeof sfx !== 'undefined') sfx.wrong();
            setTimeout(() => {
                mfFirstCard.classList.remove('flipped'); mfSecondCard.classList.remove('flipped');
                mfFirstCard = null; mfSecondCard = null; mfLockBoard = false;
            }, 1000);
        }
    }

    // === FIQIH LOGIC ===
    let fiqihCurrentSeq = [];

    function startFiqihLevel() {
        document.getElementById('levelDisplay').innerText = currentLevel;
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('checkFiqihBtn').innerText = "âœ… Cek Jawaban";

        const idx = (currentLevel - 1) % fiqihData.length;
        const data = fiqihData[idx];
        fiqihCurrentSeq = data.steps;

        // Update Judul
        document.getElementById('fiqihQuestion').innerText = data.title;
        
        // Update Instruksi berdasarkan Mode
        const instructionText = document.querySelector('#gameBoardFiqih p'); // Cari elemen <p> instruksi
        if(instructionText) {
            if(data.mode === 'unordered') {
                instructionText.innerText = "Urutan BEBAS. Klik potongan yang termasuk dalam kategori di atas.";
                instructionText.style.color = "#059669"; // Hijau biar beda
            } else {
                instructionText.innerText = "Klik potongan di bawah untuk menyusun URUTAN yang benar.";
                instructionText.style.color = "#666";
            }
        }

        const slotsArea = document.getElementById('fiqihSlots');
        slotsArea.innerHTML = '';
        fiqihCurrentSeq.forEach((_, i) => {
            const d = document.createElement('div');
            d.className = 'slot'; 
            d.dataset.index = i;
            // Tampilkan nomor hanya jika mode urutan
            const numberHtml = (data.mode === 'unordered') ? 'â€¢' : (i + 1);
            d.innerHTML = `<div class="slot-number">${numberHtml}</div><div class="slot-content"></div>`;
            d.addEventListener('click', handleSlotClick);
            slotsArea.appendChild(d);
        });

        const piecesArea = document.getElementById('fiqihPieces');
        piecesArea.innerHTML = '';
        // Acak potongan soal
        [...fiqihCurrentSeq].sort(()=>0.5-Math.random()).forEach(txt => {
            const p = document.createElement('div');
            p.className = 'puzzle-piece'; 
            p.innerText = txt;
            p.addEventListener('click', handlePieceClick);
            piecesArea.appendChild(p);
        });
    }

    function handlePieceClick() {
        const empty = Array.from(document.querySelectorAll('.slot')).find(s => !s.classList.contains('filled'));
        if(empty) {
			sfx.flip();
            empty.querySelector('.slot-content').innerText = this.innerText;
            empty.classList.add('filled'); empty.dataset.value = this.innerText;
            this.remove();
        }
    }

    function handleSlotClick() {
        if(!this.classList.contains('filled')) return;
        const txt = this.dataset.value;
        const p = document.createElement('div');
        p.className = 'puzzle-piece'; p.innerText = txt;
        p.addEventListener('click', handlePieceClick);
        document.getElementById('fiqihPieces').appendChild(p);
        this.classList.remove('filled','correct','wrong');
        this.querySelector('.slot-content').innerText = '';
        this.dataset.value = '';
    }

    function checkFiqihAnswer() {
        const slots = document.querySelectorAll('.slot');
        let correctCount = 0;
        let isFull = true;
        
        // Ambil data level saat ini untuk cek mode
        const idx = (currentLevel - 1) % fiqihData.length;
        const currentData = fiqihData[idx];
        const isUnordered = currentData.mode === 'unordered';

        // Cek apakah semua slot terisi
        slots.forEach(slot => {
            if (!slot.classList.contains('filled')) isFull = false;
        });

        if (!isFull) return alert("Lengkapi semua kotak dulu!");

        // Logika Pengecekan
        slots.forEach((slot, i) => {
            const userValue = slot.dataset.value;
            
            if (isUnordered) {
                // Mode ACAK: Cek apakah jawaban user ADA di dalam kunci jawaban manapun?
                // Dan pastikan tidak duplikat (sudah dicek oleh mekanisme puzzle piece yang hilang saat diklik)
                if (fiqihCurrentSeq.includes(userValue)) {
                    slot.classList.add('correct');
                    correctCount++;
                } else {
                    slot.classList.add('wrong');
                }
            } else {
                // Mode URUTAN (Default): Cek indeks harus sama persis
                if (userValue === fiqihCurrentSeq[i]) {
                    slot.classList.add('correct');
                    correctCount++;
                } else {
                    slot.classList.add('wrong');
                }
            }
        });

        if (correctCount === fiqihCurrentSeq.length) {
			sfx.win();
            score += 50; 
            showLevelComplete(0); 
        } else {
			sfx.wrong();
            score = Math.max(0, score - 10); 
            document.getElementById('scoreDisplay').innerText = score;
            alert("Masih ada yang salah, coba lagi!");
            setTimeout(() => {
                slots.forEach(s => s.classList.remove('correct', 'wrong'));
            }, 1500);
        }
    }

	// ============================================
    // === LOGIKA GAME 3: DETEKTIF TAJWID ===
    // ============================================
    let tajwidTargetIndices = [];

    function startTajwidLevel() {
        document.getElementById('levelDisplay').innerText = currentLevel;
        document.getElementById('scoreDisplay').innerText = score;
        document.getElementById('tajwidFeedback').innerText = ""; // Reset feedback

        // Ambil data soal (Looping jika level > jumlah soal)
        const idx = (currentLevel - 1) % tajwidData.length;
        const data = tajwidData[idx];
        
        tajwidTargetIndices = data.targetIndex; // Array kunci jawaban

        document.getElementById('tajwidQuestText').innerText = data.question;

        const quranContainer = document.getElementById('quranTextDisplay');
        quranContainer.innerHTML = '';

        // Pecah ayat menjadi kata-kata berdasarkan spasi
        const words = data.text.split(" ");

        words.forEach((word, index) => {
            const span = document.createElement('span');
            span.className = 'tajwid-word';
            span.innerText = word;
            span.dataset.index = index;
            
            span.addEventListener('click', function() {
                checkTajwidAnswer(this, parseInt(this.dataset.index));
            });

            quranContainer.appendChild(span);
            // Tambah spasi visual antar kata
            quranContainer.appendChild(document.createTextNode(" "));
        });
    }

    function checkTajwidAnswer(element, clickedIndex) {
        // Cek apakah indeks yang diklik ada di dalam kunci jawaban
        if (tajwidTargetIndices.includes(clickedIndex)) {
            // BENAR
			sfx.correct();
            element.classList.add('correct');
            document.getElementById('tajwidFeedback').style.color = "#10b981";
            document.getElementById('tajwidFeedback').innerText = "Benar! Mumtaz!";
            
            // Poin & Lanjut
            score += 20;
            setTimeout(() => {
                showLevelComplete(0); // Tidak ada bonus waktu
            }, 1000);
        } else {
            // SALAH
			sfx.wrong();
            element.classList.add('wrong');
            score = Math.max(0, score - 5);
            document.getElementById('scoreDisplay').innerText = score;
            
            document.getElementById('tajwidFeedback').style.color = "#ef4444";
            document.getElementById('tajwidFeedback').innerText = "Kurang tepat, coba lagi.";
            
            // Hapus warna merah setelah sebentar
            setTimeout(() => {
                element.classList.remove('wrong');
            }, 500);
        }
    }


    // === SHARED LOGIC ===
    function showLevelComplete(bonus) {
		sfx.win();
        clearInterval(mufrodatInterval);
        score += bonus;
        document.getElementById('scoreDisplay').innerText = score;
        saveProgress(true);
        document.getElementById('nextLevelNum').innerText = currentLevel + 1;
        document.getElementById('timeBonus').innerText = bonus;
        document.getElementById('levelModal').style.display = 'flex';
    }

    function showGameOver() {
		sfx.lose();
        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverModal').style.display = 'flex';
    }

    function nextLevel() {
        currentLevel++;
        document.getElementById('levelModal').style.display = 'none';
        startGameLevel();
    }

    function restartLevel() {
        document.getElementById('gameOverModal').style.display = 'none';
        startGameLevel();
    }

    function restartGame() {
        currentLevel = 1; score = 0;
        document.getElementById('gameOverModal').style.display = 'none';
        startGameLevel();
    }
	
	// --- FITUR BARU: KONFIRMASI KELUAR ---
    function confirmExit() {
        // Tampilkan peringatan
        Swal.fire({
            title: 'Keluar Permainan?',
            text: "Progres level ini akan hilang.",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Ya, Keluar',
            cancelButtonText: 'Batal'
        }).then((result) => {
            if (result.isConfirmed) {
                stopAllGameLogic(); // Matikan semua mesin game
                backToMenu();       // Kembali ke menu
            }
        });
    }

    // --- FUNGSI BARU: MEMATIKAN SEMUA LOGIKA GAME ---
    function stopAllGameLogic() {
        // 1. Matikan Timer Mufrodat
        clearInterval(mufrodatInterval);
        
        // 2. Matikan Timer LCC (Penting!)
        clearInterval(lccTypeInterval); // Stop animasi mengetik
        clearTimeout(lccBotTimer);      // Stop bot berpikir
        clearTimeout(lccTimer);         // Stop timer lain jika ada
		clearInterval(lccGameTimer);    // Stop Timer Lingkaran
        const clockEl = document.getElementById('lccTimerClock');
        if(clockEl) clockEl.style.display = 'none';
        
        // 3. Matikan Koneksi Multiplayer (Firebase)
        if (lccDbRef) {
            lccDbRef.off(); // Putus hubungan dengan room agar tidak update di background
            lccDbRef = null;
        }

        // 4. Reset State Global
        lccBuzzerLocked = false;
        lccMode = '';
		lccAttemptedPlayers = [];
        
        // 5. Matikan Audio (Opsional, agar tidak ada sisa suara)
        if(sfx && sfx.ctx && sfx.ctx.state === 'running') {
            sfx.ctx.suspend();
            setTimeout(() => sfx.ctx.resume(), 1000); // Resume nanti saat masuk game lagi
        }

        console.log("Semua game engine dimatikan.");
    }

    // --- UPDATE FUNGSI backToMenu ---
    // Pastikan fungsi backToMenu Anda isinya seperti ini:
    function backToMenu() {
        // Panggil stop logic untuk jaga-jaga
        stopAllGameLogic(); 

        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('gameMenu').style.display = 'flex';
        
        // Reset tampilan Header
        document.getElementById('gameTitleDisplay').textContent = "ğŸ® Game";
    }
	
	// --- FITUR WINDOW CONTROLS ---
    function toggleMaximize() {
        // Tambah/Hapus class 'maximize-mode' di body
        document.body.classList.toggle('maximize-mode');
    }

    function toggleFullscreen() {
        if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(err => {
                alert(`Error: ${err.message}`);
            });
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }
    }
	
</script>
</body>
</html>
