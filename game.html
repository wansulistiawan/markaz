<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Mufrodat - Yayasan Markaz Yatim Duafa Qurani</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --dark: #064e3b;
            --accent: #f59e0b;
            --bg: #ecfdf5;
            --matched-bg: #2563eb; /* Biru saat cocok */
            --sidebar-bg: #ffffff;
        }
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
        }
        
        /* --- HEADER --- */
        .header {
            background: var(--dark);
            color: white;
            width: 100%;
            padding: 8px 20px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-shrink: 0; 
            z-index: 50;
        }
        .header h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .user-info { font-size: 0.9rem; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); }

        /* --- MAIN LAYOUT --- */
        .main-container {
            display: flex;
            flex: 1;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px; 
            gap: 15px;
            overflow: hidden; 
        }

        .game-area {
            flex: 3; 
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            height: 100%;
        }

        .sidebar {
            flex: 1;
            background: var(--sidebar-bg);
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            height: 100%; 
            overflow-y: auto; 
            display: flex;
            flex-direction: column;
        }

        /* --- CONTROLS --- */
        .controls-bar {
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 8px;
            flex-shrink: 0;
        }
        
        .status-bar {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 8px;
            font-size: 1rem;
            font-weight: bold;
            color: var(--dark);
            flex-shrink: 0;
        }
        .badge {
            background: white;
            padding: 2px 15px;
            border-radius: 15px;
            border: 1px solid var(--primary);
            font-size: 0.9rem;
        }

        .timer-container {
            width: 100%;
            height: 8px; 
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
            flex-shrink: 0;
        }
        .timer-bar {
            height: 100%;
            background: var(--primary);
            width: 100%;
            transition: width 0.1s linear;
        }

        /* --- GAME BOARD --- */
        .game-board {
            display: grid;
            gap: 8px; 
            width: 100%;
            height: 100%;
            max-height: calc(100vh - 160px); 
            align-content: center; 
            justify-content: center;
            perspective: 1000px;
        }

        /* --- CARD STYLING (ANIMASI DIPERCEPAT) --- */
        .card {
            background-color: transparent;
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            
            /* PERUBAHAN: Durasi transisi diubah dari 0.6s menjadi 0.3s */
            transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            
            aspect-ratio: 1 / 1;
            max-width: 120px; 
            max-height: 120px;
        }
        
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { transform: rotateY(180deg); cursor: default; }

        .face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 8px;
            font-weight: bold;
            padding: 2px; 
            box-sizing: border-box;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .front { 
            background: linear-gradient(135deg, var(--primary), var(--dark)); 
            color: white; 
            font-size: 2.5rem; 
            border: 2px solid white; 
        }
        
        .back { 
            background: white; 
            transform: rotateY(180deg); 
            border: 2px solid var(--primary); 
            color: var(--dark); 
            font-size: 1.2rem; 
            line-height: 1.1;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .card.matched .back { 
            background-color: var(--matched-bg) !important; 
            color: white !important; 
            border-color: #93c5fd; 
            animation: pulse 0.5s ease-in-out; 
        }

        .arabic-text { 
            font-family: 'Amiri', serif; 
            font-size: 2.2rem !important; 
            font-weight: 900;
            line-height: 1;
            margin-top: -5px; 
        }

        @keyframes pulse { 0% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.1); } 100% { transform: rotateY(180deg) scale(1); } }

        /* Buttons */
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-family: 'Fredoka', sans-serif;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 5px;
            transition: background 0.3s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--dark); }
        .btn-accent { background: var(--accent); color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Leaderboard */
        .sidebar h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 1.1rem; margin-bottom: 10px; }
        .lb-item { padding: 8px; border-bottom: 1px solid #f3f4f6; margin-bottom: 4px; }
        .lb-rank { width: 20px; height: 20px; font-size: 0.7rem; }
        .rank-badge { font-size: 0.65rem; padding: 1px 5px; }
        
        .rank-new { background: #e5e7eb; color: #374151; }
        .rank-mid { background: #bfdbfe; color: #1e40af; }
        .rank-high { background: #fef08a; color: #854d0e; }
        .rank-master { background: #fbcfe8; color: #9d174d; }
        .rank-legend { background: linear-gradient(45deg, #f59e0b, #b45309); color: white; }
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FDB931); color: #5c4004; border: 1px solid #b8860b; }
        .rank-2 { background: linear-gradient(45deg, #E0E0E0, #BDBDBD); color: #424242; border: 1px solid #9e9e9e; }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #A0522D); color: #fff; border: 1px solid #8b4513; }

        /* Modal */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; animation: popIn 0.3s ease; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        /* Loading Overlay */
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; padding: 5px; }
            .game-area { width: 100%; height: 65vh; }
            .sidebar { display: none; }
            .mobile-lb-btn { display: block; }
            .game-board { max-height: none; } 
        }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div class="loader"></div>
        <p>Memproses...</p>
    </div>

    <div class="header">
        <h1>ğŸ® Master Mufrodat</h1>
        <div class="user-info" id="userStatus">Tamu</div>
    </div>

    <div class="main-container">
        
        <div class="game-area">
            <div class="controls-bar">
                <button class="btn btn-blue" onclick="fetchLeaderboard(true)">ğŸ† Peringkat</button>
                <button class="btn btn-accent" id="btnSave" onclick="saveProgress()" disabled>ğŸ’¾ Simpan</button>
                <button class="btn btn-primary" id="btnLoad" onclick="loadProgress()" disabled>ğŸ“‚ Muat Ulang</button>
            </div>

            <div class="status-bar">
                <div class="badge">Lv: <span id="levelDisplay">1</span></div>
                <div class="badge">Skor: <span id="scoreDisplay">0</span></div>
            </div>

            <div class="timer-container">
                <div class="timer-bar" id="timerBar"></div>
            </div>

            <div class="game-board" id="gameBoard"></div>
        </div>

        <div class="sidebar">
            <h2>ğŸ† Papan Peringkat</h2>
            <div id="leaderboardList">
                <p style="text-align:center; color:#999;">Memuat...</p>
            </div>
            <div style="margin-top:10px; text-align:center;">
                <button class="btn btn-blue" onclick="fetchLeaderboard()" style="width:100%;">ğŸ”„ Refresh</button>
            </div>
        </div>

    </div>

    <div class="modal" id="leaderboardModal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="color: var(--dark); margin-top:0;">ğŸ† Top 10</h2>
            <div id="modalLbContent">Memuat...</div>
            <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('leaderboardModal').style.display='none'">Tutup</button>
        </div>
    </div>

    <div class="modal" id="levelModal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-top:0;">Ahlan Wa Sahlan! ğŸ‰</h2>
            <p>Level <span id="nextLevelNum" style="font-weight:bold; font-size:1.5rem;"></span> Terbuka!</p>
            <p>Bonus: +<span id="timeBonus"></span> Poin</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="nextLevel()">Lanjut</button>
                <button class="btn btn-accent" onclick="document.getElementById('levelModal').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 style="color: #ef4444; margin-top:0;">Waktu Habis! â³</h2>
            <p>Skor Akhir: <span id="finalScore" style="font-weight:bold; font-size:1.5rem;"></span></p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="restartLevel()">Ulangi</button>
                <button class="btn btn-accent" onclick="restartGame()">Reset</button>
            </div>
        </div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec"; 

    // === DATABASE KOSAKATA ===
    const tier1 = [
        {a:"ÙƒÙØªÙØ§Ø¨ÙŒ", i:"Buku"}, {a:"Ù‚ÙÙ„ÙÙ…ÙŒ", i:"Pena"}, {a:"Ù…ÙÙƒÙ’ØªÙØ¨ÙŒ", i:"Meja"}, 
        {a:"ÙƒÙØ±Ù’Ø³ÙÙŠÙŒÙ‘", i:"Kursi"}, {a:"Ø¨ÙØ§Ø¨ÙŒ", i:"Pintu"}, {a:"Ù†ÙØ§ÙÙØ°ÙØ©ÙŒ", i:"Jendela"},
        {a:"ÙÙØµÙ’Ù„ÙŒ", i:"Kelas"}, {a:"Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©ÙŒ", i:"Sekolah"}, {a:"Ø£ÙØ³Ù’ØªÙØ§Ø°ÙŒ", i:"Guru (Lk)"},
        {a:"ØªÙÙ„Ù’Ù…ÙÙŠÙ’Ø°ÙŒ", i:"Murid"}, {a:"Ø³ÙØ¨ÙÙ‘ÙˆÙ’Ø±ÙØ©ÙŒ", i:"Papan Tulis"}, {a:"Ù…ÙÙ…Ù’Ø³ÙØ­ÙØ©ÙŒ", i:"Penghapus"},
        {a:"Ø­ÙÙ‚ÙÙŠÙ’Ø¨ÙØ©ÙŒ", i:"Tas"}, {a:"Ù…Ø³Ø·Ø±Ø©", i:"Penggaris"}, {a:"Ø³ÙØ§Ø¹ÙØ©ÙŒ", i:"Jam"},
        {a:"Ø¨ÙÙŠÙ’ØªÙŒ", i:"Rumah"}, {a:"ØºÙØ±Ù’ÙÙØ©ÙŒ", i:"Kamar"}, {a:"Ù…ÙØ·Ù’Ø¨ÙØ®ÙŒ", i:"Dapur"},
        {a:"Ø­ÙÙ…ÙÙ‘Ø§Ù…ÙŒ", i:"Kamar Mandi"}, {a:"Ø³ÙØ±ÙÙŠÙ’Ø±ÙŒ", i:"Ranjang"}, {a:"Ù…ÙØ±Ù’Ø¢Ø©ÙŒ", i:"Cermin"},
        {a:"Ù…ÙØµÙ’Ø¨ÙØ§Ø­ÙŒ", i:"Lampu"}, {a:"Ø«ÙÙˆÙ’Ø¨ÙŒ", i:"Baju"}, {a:"Ø­ÙØ°ÙØ§Ø¡ÙŒ", i:"Sepatu"},
        {a:"Ø¬ÙÙˆÙ’Ø±ÙØ¨ÙŒ", i:"Kaos Kaki"}, {a:"Ù‚ÙÙ„ÙÙ†Ù’Ø³ÙÙˆÙØ©ÙŒ", i:"Peci"}, {a:"Ù…ÙØ§Ø¡ÙŒ", i:"Air"},
        {a:"Ø®ÙØ¨Ù’Ø²ÙŒ", i:"Roti"}, {a:"Ù„ÙØ­Ù’Ù…ÙŒ", i:"Daging"}, {a:"Ø³ÙÙ…ÙÙƒÙŒ", i:"Ikan"}
    ];

    const tier2 = [
        {a:"Ø£ÙÙƒÙÙ„Ù", i:"Makan"}, {a:"Ø´ÙØ±ÙØ¨Ù", i:"Minum"}, {a:"Ù†ÙØ§Ù…Ù", i:"Tidur"},
        {a:"Ù‚ÙØ§Ù…Ù", i:"Berdiri"}, {a:"Ø¬ÙÙ„ÙØ³Ù", i:"Duduk"}, {a:"Ø°ÙÙ‡ÙØ¨Ù", i:"Pergi"},
        {a:"Ø±ÙØ¬ÙØ¹Ù", i:"Pulang"}, {a:"Ù‚ÙØ±ÙØ£Ù", i:"Membaca"}, {a:"ÙƒÙØªÙØ¨Ù", i:"Menulis"},
        {a:"Ø¯ÙØ®ÙÙ„Ù", i:"Masuk"}, {a:"Ø®ÙØ±ÙØ¬Ù", i:"Keluar"}, {a:"ÙÙØªÙØ­Ù", i:"Membuka"},
        {a:"ØºÙÙ„ÙÙ‚Ù", i:"Menutup"}, {a:"Ù†ÙØ¸ÙØ±Ù", i:"Melihat"}, {a:"Ø³ÙÙ…ÙØ¹Ù", i:"Mendengar"},
        {a:"ÙƒÙØ¨ÙŠØ±ÙŒ", i:"Besar"}, {a:"ØµÙØºÙÙŠÙ’Ø±ÙŒ", i:"Kecil"}, {a:"Ø·ÙÙˆÙÙŠÙ’Ù„ÙŒ", i:"Panjang"},
        {a:"Ù‚ÙØµÙÙŠÙ’Ø±ÙŒ", i:"Pendek"}, {a:"Ø¬ÙØ¯ÙÙŠÙ’Ø¯ÙŒ", i:"Baru"}, {a:"Ù‚ÙØ¯ÙÙŠÙ’Ù…ÙŒ", i:"Lama"},
        {a:"Ù†ÙØ¸ÙÙŠÙ’ÙÙŒ", i:"Bersih"}, {a:"ÙˆÙØ³ÙØ®ÙŒ", i:"Kotor"}, {a:"Ø¬ÙÙ…ÙÙŠÙ’Ù„ÙŒ", i:"Indah"},
        {a:"Ù‚ÙØ¨ÙÙŠÙ’Ø­ÙŒ", i:"Jelek"}, {a:"Ù‚ÙØ±ÙÙŠÙ’Ø¨ÙŒ", i:"Dekat"}, {a:"Ø¨ÙØ¹ÙÙŠÙ’Ø¯ÙŒ", i:"Jauh"},
        {a:"Ø³ÙØ±ÙÙŠÙ’Ø¹ÙŒ", i:"Cepat"}, {a:"Ø¨ÙØ·ÙÙŠÙ’Ø¡ÙŒ", i:"Lambat"}, {a:"Ù‚ÙÙˆÙÙŠÙŒÙ‘", i:"Kuat"}
    ];

    const tier3 = [
        {a:"Ø³ÙÙ…ÙØ§Ø¡ÙŒ", i:"Langit"}, {a:"Ø£ÙØ±Ù’Ø¶ÙŒ", i:"Bumi"}, {a:"Ø´ÙÙ…Ù’Ø³ÙŒ", i:"Matahari"},
        {a:"Ù‚ÙÙ…ÙØ±ÙŒ", i:"Bulan"}, {a:"Ù†ÙØ¬Ù’Ù…ÙŒ", i:"Bintang"}, {a:"Ø¬ÙØ¨ÙÙ„ÙŒ", i:"Gunung"},
        {a:"Ø¨ÙØ­Ù’Ø±ÙŒ", i:"Laut"}, {a:"Ù†ÙÙ‡Ù’Ø±ÙŒ", i:"Sungai"}, {a:"Ø´ÙØ¬ÙØ±ÙØ©ÙŒ", i:"Pohon"},
        {a:"Ø²ÙÙ‡Ù’Ø±ÙØ©ÙŒ", i:"Bunga"}, {a:"Ø£ÙØ³ÙØ¯ÙŒ", i:"Singa"}, {a:"ÙÙÙŠÙ’Ù„ÙŒ", i:"Gajah"},
        {a:"Ù‚ÙØ·ÙŒÙ‘", i:"Kucing"}, {a:"ÙƒÙÙ„Ù’Ø¨ÙŒ", i:"Anjing"}, {a:"Ø·ÙØ§Ø¦ÙØ±ÙŒ", i:"Burung"},
        {a:"Ø±ÙØ£Ù’Ø³ÙŒ", i:"Kepala"}, {a:"Ø¹ÙÙŠÙ’Ù†ÙŒ", i:"Mata"}, {a:"Ø£ÙÙ†Ù’ÙÙŒ", i:"Hidung"},
        {a:"Ø£ÙØ°ÙÙ†ÙŒ", i:"Telinga"}, {a:"ÙÙÙ…ÙŒ", i:"Mulut"}, {a:"ÙŠÙØ¯ÙŒ", i:"Tangan"},
        {a:"Ø±ÙØ¬Ù’Ù„ÙŒ", i:"Kaki"}, {a:"Ù‚ÙÙ„Ù’Ø¨ÙŒ", i:"Jantung"}, {a:"Ø¨ÙØ·Ù’Ù†ÙŒ", i:"Perut"},
        {a:"Ø´ÙØ¹Ù’Ø±ÙŒ", i:"Rambut"}, {a:"Ù„ÙØ³ÙØ§Ù†ÙŒ", i:"Lidah"}, {a:"Ø³ÙÙ†ÙŒÙ‘", i:"Gigi"}
    ];

    const tier4 = [
        {a:"ØµÙÙ„ÙØ§Ø©ÙŒ", i:"Sholat"}, {a:"ØµÙÙˆÙ’Ù…ÙŒ", i:"Puasa"}, {a:"Ø²ÙÙƒÙØ§Ø©ÙŒ", i:"Zakat"},
        {a:"Ø­ÙØ¬ÙŒÙ‘", i:"Haji"}, {a:"Ø¥ÙÙŠÙ’Ù…ÙØ§Ù†ÙŒ", i:"Iman"}, {a:"ØªÙÙ‚Ù’ÙˆÙÙ‰", i:"Taqwa"},
        {a:"Ø¬ÙÙ†ÙÙ‘Ø©ÙŒ", i:"Surga"}, {a:"Ù†ÙØ§Ø±ÙŒ", i:"Neraka"}, {a:"Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©ÙŒ", i:"Malaikat"},
        {a:"Ø´ÙÙŠÙ’Ø·ÙØ§Ù†ÙŒ", i:"Setan"}, {a:"Ù‚ÙÙŠÙØ§Ù…ÙØ©ÙŒ", i:"Kiamat"}, {a:"Ø°ÙÙ†Ù’Ø¨ÙŒ", i:"Dosa"},
        {a:"Ø«ÙÙˆÙØ§Ø¨ÙŒ", i:"Pahala"}, {a:"Ø¥ÙØ®Ù’Ù„ÙØ§ØµÙŒ", i:"Ikhlas"}, {a:"ØµÙØ¨Ù’Ø±ÙŒ", i:"Sabar"},
        {a:"Ø´ÙÙƒÙ’Ø±ÙŒ", i:"Syukur"}, {a:"Ø¹ÙÙ„Ù’Ù…ÙŒ", i:"Ilmu"}, {a:"Ø¹ÙÙ…ÙÙ„ÙŒ", i:"Amal"},
        {a:"ØµÙØ¯Ù’Ù‚ÙŒ", i:"Jujur"}, {a:"ÙƒÙØ°Ù’Ø¨ÙŒ", i:"Dusta"}, {a:"Ø®ÙÙŠÙ’Ø±Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", i:"Sebaik Manusia"},
        {a:"Ø·ÙÙ„ÙØ¨Ù Ø§Ù„Ù’Ø¹ÙÙ„Ù’Ù…Ù", i:"Menuntut Ilmu"}, {a:"Ø¨ÙØ±ÙÙ‘ Ø§Ù„Ù’ÙˆÙØ§Ù„ÙØ¯ÙÙŠÙ’Ù†Ù", i:"Berbakti Ortu"},
        {a:"Ù…ÙÙ†Ù’ Ø¬ÙØ¯ÙÙ‘ ÙˆÙØ¬ÙØ¯Ù", i:"Siapa bersungguh dapat"}, {a:"Ø§Ù„ØµÙÙ‘Ø¨Ù’Ø±Ù Ø¶ÙÙŠÙØ§Ø¡ÙŒ", i:"Sabar itu cahaya"}
    ];

    // === GAME STATE ===
    let currentLevel = 1;
    let score = 0;
    let timeLeft = 0;
    let totalTime = 0;
    let timerInterval = null;
    let isPaused = false;
    
    let firstCard = null;
    let secondCard = null;
    let lockBoard = false;
    let matchesFound = 0;
    let pairsNeeded = 0;

    let currentUser = null;

    const gameBoard = document.getElementById('gameBoard');
    const timerBar = document.getElementById('timerBar');
    const levelDisplay = document.getElementById('levelDisplay');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const btnLoad = document.getElementById('btnLoad');

    // === INITIALIZATION & SESSION ===
    function checkSession() {
        const sessionStr = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
        if (sessionStr) {
            const session = JSON.parse(sessionStr);
            if (session.loggedIn) {
                currentUser = session.userData;
                document.getElementById('userStatus').innerHTML = `<b>ğŸ‘¤ ${currentUser.profileName}</b>`;
                document.getElementById('btnSave').disabled = false;
                btnLoad.disabled = false;
                
                // PENTING: Langsung ambil data & sync saat login
                // Parameter: showModal=false, syncGameData=true
                fetchLeaderboard(false, true); 
            }
        } else {
            // Tamu: Load leaderboard, mulai Level 1
            fetchLeaderboard(false, false);
            startLevel(); 
        }
    }

    function getRankInfo(level) {
        if (level >= 46) return { title: "ğŸ‘‘ Syaikhul 'Ilmi", class: "rank-legend" };
        if (level >= 31) return { title: "âš”ï¸ Farisul Lughah", class: "rank-master" };
        if (level >= 16) return { title: "ğŸ“š Hafizh Mufrodat", class: "rank-high" };
        if (level >= 6)  return { title: "ğŸ”¥ Thalib Mujtahid", class: "rank-mid" };
        return { title: "ğŸŒ± Thalib Jadid", class: "rank-new" };
    }

    function showLoading(show) {
        loadingOverlay.style.display = show ? 'flex' : 'none';
    }

    // === API ACTIONS ===

    // Fungsi Load Progress (Manual Click)
    function loadProgress() {
        if (!currentUser) return alert("Login dulu!");
        // Panggil fetch dengan mode SYNC = true
        fetchLeaderboard(false, true);
    }

    function saveProgress(silent = false) {
        if (!currentUser) {
            if(!silent) alert("Login dulu untuk menyimpan!");
            return;
        }
        
        if(!silent) showLoading(true);
        const btnSave = document.getElementById('btnSave');
        const originalBtnText = btnSave.innerText;
        if(silent) btnSave.innerText = "â³ Menyimpan...";
        
        const data = {
            action: 'saveGameProgress',
            username: currentUser.username,
            nama: currentUser.profileName,
            level: currentLevel,
            skor: score
        };

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(res => res.json())
        .then(result => {
            if(!silent) showLoading(false);
            if(result.status === 'success') {
                if(!silent) {
                    alert("Tersimpan!");
                    document.getElementById('levelModal').style.display = 'none';
                } else {
                    btnSave.innerText = "âœ… Tersimpan";
                    setTimeout(() => btnSave.innerText = "ğŸ’¾ Simpan", 2000);
                }
                fetchLeaderboard(); // Refresh sidebar
                
                // Update tombol Lanjut agar sesuai data terbaru
                btnLoad.innerText = `ğŸ“‚ Muat Ulang (Lv ${currentLevel})`;
            } else {
                if(!silent) alert("Gagal: " + result.message);
                if(silent) btnSave.innerText = "âŒ Gagal";
            }
        })
        .catch(err => { 
            if(!silent) showLoading(false); 
            if(silent) btnSave.innerText = "âŒ Error";
        });
    }

    // Fungsi Multi-guna: Ambil Leaderboard + Sync Data User
    function fetchLeaderboard(showModal = false, syncGameData = false) {
        const lbContainer = document.getElementById('leaderboardList');
        if(!showModal && !syncGameData) lbContainer.innerHTML = '<p style="text-align:center; color:#999;">...</p>';

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getGameLeaderboardAndProgress', 
                username: currentUser ? currentUser.username : '' 
            }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(res => res.json())
        .then(result => {
            if(result.status === 'success') {
                // 1. Render Leaderboard
                const html = generateLeaderboardHTML(result.leaderboard, result.myProgress);
                lbContainer.innerHTML = html;
                
                if(showModal) {
                    document.getElementById('modalLbContent').innerHTML = html;
                    document.getElementById('leaderboardModal').style.display = 'flex';
                }

                // 2. LOGIKA AUTO-SYNC (LANJUTKAN LEVEL)
                if (syncGameData) {
                    if(result.myProgress) {
                        // Update State Lokal
                        currentLevel = result.myProgress.level;
                        score = result.myProgress.skor;
                        
                        // Update UI
                        levelDisplay.innerText = currentLevel;
                        scoreDisplay.innerText = score;
                        
                        // Update Tombol Lanjut
                        btnLoad.innerText = `ğŸ“‚ Muat Ulang (Lv ${currentLevel})`;
                        
                        // Mulai Game di Level Tersebut
                        startLevel();
                    } else {
                        // Jika belum ada data (New User), mulai level 1
                        startLevel();
                    }
                }
            }
        })
        .catch(err => {
            console.error(err);
            lbContainer.innerHTML = '<p style="text-align:center; color:red;">Offline.</p>';
            // Fallback: jika error saat sync, tetap mulai level 1
            if(syncGameData) startLevel();
        });
    }

    function generateLeaderboardHTML(data, myData) {
        let html = '';
        data.forEach((item, index) => {
            let rankInfo = getRankInfo(item.level); 
            if (index === 0) { rankInfo = { title: "ğŸ¥‡ The Champion", class: "rank-1" }; } 
            else if (index === 1) { rankInfo = { title: "ğŸ¥ˆ Runner Up", class: "rank-2" }; } 
            else if (index === 2) { rankInfo = { title: "ğŸ¥‰ 3rd Place", class: "rank-3" }; }

            const isMe = (myData && item.username === myData.username) ? 'my-rank-item' : '';
            
            html += `
            <div class="lb-item ${isMe}">
                <div class="lb-header">
                    <div class="lb-name-wrap">
                        <span class="lb-rank">${index + 1}</span>
                        <span>${item.username}</span> 
                    </div>
                    <span>${item.skor}</span>
                </div>
                <div class="lb-details">
                    <span class="rank-badge ${rankInfo.class}">${rankInfo.title}</span>
                    <span>Lv ${item.level}</span>
                </div>
            </div>`;
        });

        if(myData) {
            const myRankInfo = getRankInfo(myData.level);
            const inTop10 = data.some(d => d.username === myData.username);
            if(!inTop10) {
                html += `
                <div style="margin-top:10px; border-top:2px dashed #ccc; padding-top:10px;">
                    <div class="lb-item my-rank-item">
                        <div class="lb-header">
                            <div class="lb-name-wrap">
                                <span class="lb-rank">?</span>
                                <span>Anda (${myData.username})</span>
                            </div>
                            <span>${myData.skor}</span>
                        </div>
                        <div class="lb-details">
                            <span class="rank-badge ${myRankInfo.class}">${myRankInfo.title}</span>
                            <span>Lv ${myData.level}</span>
                        </div>
                    </div>
                </div>`;
            }
        }
        return html || '<p style="text-align:center;">Belum ada data.</p>';
    }

    // === GAMEPLAY UTAMA ===
    function getLevelConfig(level) {
        let tierData, gridCols, pairs, timePerPair;
        if (level <= 15) { tierData = tier1; gridCols = 3; timePerPair = 15; } 
        else if (level <= 30) { tierData = [...tier1, ...tier2]; gridCols = 4; timePerPair = 12; } 
        else if (level <= 40) { tierData = [...tier2, ...tier3]; gridCols = 4; timePerPair = 10; } 
        else { tierData = [...tier3, ...tier4]; gridCols = 5; timePerPair = 8; } 

        pairs = Math.min(4 + Math.floor(level / 3), 15); 
        if (window.innerWidth < 600 && gridCols > 4) gridCols = 4;

        return { data: tierData, cols: gridCols, pairs: pairs, time: Math.floor(pairs * timePerPair) + 10 };
    }

    function startLevel() {
        gameBoard.innerHTML = '';
        firstCard = null; secondCard = null;
        lockBoard = false; matchesFound = 0;
        isPaused = false;

        levelDisplay.innerText = currentLevel;
        scoreDisplay.innerText = score;

        const config = getLevelConfig(currentLevel);
        pairsNeeded = config.pairs;
        totalTime = config.time;
        timeLeft = totalTime;

        gameBoard.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;

        const shuffledData = config.data.sort(() => 0.5 - Math.random());
        let selectedWords = shuffledData.slice(0, pairsNeeded);

        let deck = [];
        selectedWords.forEach((item, index) => {
            deck.push({ id: index, content: item.a, type: 'arab' });
            deck.push({ id: index, content: item.i, type: 'indo' });
        });

        deck.sort(() => 0.5 - Math.random());

        deck.forEach(item => {
            const card = document.createElement('div');
            card.classList.add('card');
            card.dataset.id = item.id;

            const front = document.createElement('div');
            front.classList.add('face', 'front');
            front.innerText = "â“"; 

            const back = document.createElement('div');
            back.classList.add('face', 'back');
            back.innerText = item.content;
            if(item.type === 'arab') back.classList.add('arabic-text');

            card.appendChild(front);
            card.appendChild(back);
            card.addEventListener('click', flipCard);
            gameBoard.appendChild(card);
        });

        startTimer();
    }

    function startTimer() {
        clearInterval(timerInterval);
        timerBar.style.width = '100%';
        timerBar.style.background = '#10b981';
        
        timerInterval = setInterval(() => {
            if(isPaused) return;
            timeLeft -= 0.1; 
            const percentage = (timeLeft / totalTime) * 100;
            timerBar.style.width = `${percentage}%`;
            if(percentage < 30) timerBar.style.background = '#ef4444';
            else if(percentage < 60) timerBar.style.background = '#f59e0b';

            if (timeLeft <= 0) gameOver();
        }, 100);
    }

    function flipCard() {
        if (lockBoard) return;
        if (this === firstCard) return;
        if (this.classList.contains('matched')) return;

        this.classList.add('flipped');

        if (!firstCard) {
            firstCard = this;
            return;
        }

        secondCard = this;
        lockBoard = true;
        checkForMatch();
    }

    function checkForMatch() {
        let isMatch = firstCard.dataset.id === secondCard.dataset.id;
        isMatch ? disableCards() : unflipCards();
    }

    function disableCards() {
        score += 10; 
        scoreDisplay.innerText = score;
        matchesFound++;
        firstCard.classList.add('matched');
        secondCard.classList.add('matched');

        // --- UPDATE LOGIC: ADD TIME BONUS ---
        let bonusTime = 0;
        if (currentLevel < 20) {
            bonusTime = 3;
        } else if (currentLevel < 40) {
            bonusTime = 4;
        } else {
            bonusTime = 5;
        }
        timeLeft += bonusTime;

        resetBoard();
        if (matchesFound === pairsNeeded) levelComplete();
    }

    function unflipCards() {
        setTimeout(() => {
            firstCard.classList.remove('flipped');
            secondCard.classList.remove('flipped');
            resetBoard();
        }, 1000); // Adjusted to 1s to match faster pace
    }

    function resetBoard() {
        [firstCard, secondCard] = [null, null];
        lockBoard = false;
    }

    // --- MODIFIED: LEVEL COMPLETE WITH AUTO SAVE ---
    function levelComplete() {
        clearInterval(timerInterval);
        const bonus = Math.floor(timeLeft * 5);
        score += bonus;
        scoreDisplay.innerText = score;
        
        // SAVE OTOMATIS (SILENT)
        saveProgress(true);

        document.getElementById('nextLevelNum').innerText = currentLevel + 1;
        document.getElementById('timeBonus').innerText = bonus;
        document.getElementById('levelModal').style.display = 'flex';
    }

    function saveAndExit() {
        // Ini untuk tombol manual di modal (jika user ingin memastikan)
        saveProgress();
    }

    function gameOver() {
        clearInterval(timerInterval);
        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverModal').style.display = 'flex';
    }

    function nextLevel() {
        currentLevel++;
        if (currentLevel > 50) {
            alert("MashaAllah! Antum Luar Biasa! Game Tamat.");
            currentLevel = 1; score = 0;
        }
        document.getElementById('levelModal').style.display = 'none';
        startLevel();
    }

    function restartLevel() {
        document.getElementById('gameOverModal').style.display = 'none';
        startLevel();
    }

    function restartGame() {
        currentLevel = 1; score = 0;
        document.getElementById('gameOverModal').style.display = 'none';
        startLevel();
    }

    // === JALANKAN SAAT LOAD ===
    checkSession();

</script>
</body>
</html>
