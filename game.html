<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcade Santri - Yayasan Markaz Yatim Duafa Qurani</title>
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Fredoka:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --dark: #064e3b;
            --accent: #f59e0b;
            --bg: #ecfdf5;
            --matched-bg: #2563eb; /* Biru saat cocok */
            --sidebar-bg: #ffffff;
            --slot-bg: #e5e7eb;
        }
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh; 
            overflow: hidden; 
            user-select: none;
        }

        /* --- MENU UTAMA (GAME SELECTION) --- */
        #gameMenu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow-y: auto; padding: 20px;
        }
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; width: 100%; max-width: 1000px; }
        .game-card {
            background: white; border-radius: 15px; padding: 20px; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s;
            border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .game-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .status-ready { background: #d1fae5; color: #065f46; font-size: 0.8rem; padding: 4px 10px; border-radius: 10px; font-weight: bold; }
        .status-soon { background: #f3f4f6; color: #6b7280; font-size: 0.8rem; padding: 4px 10px; border-radius: 10px; font-weight: bold; }

        /* --- GAME UI STRUCTURE --- */
        #gameUI { display: none; flex-direction: column; height: 100%; }
        
        .header {
            background: var(--dark); color: white; width: 100%; padding: 8px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 50;
        }
        .header h1 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .home-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .user-info { font-size: 0.9rem; background: rgba(255,255,255,0.15); padding: 4px 10px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.3); }

        .main-container {
            display: flex; flex: 1; width: 100%; max-width: 1200px; margin: 0 auto;
            padding: 10px; gap: 15px; overflow: hidden; 
        }

        .game-area {
            flex: 3; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; height: 100%; overflow-y: auto; 
        }

        .sidebar {
            flex: 1; background: var(--sidebar-bg); border-radius: 10px; padding: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
            height: 100%; overflow-y: auto; display: flex; flex-direction: column;
        }

        .controls-bar { width: 100%; display: flex; justify-content: center; gap: 8px; margin-bottom: 8px; flex-shrink: 0; }
        .status-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 8px; font-size: 1rem; font-weight: bold; color: var(--dark); flex-shrink: 0; }
        .badge { background: white; padding: 2px 15px; border-radius: 15px; border: 1px solid var(--primary); font-size: 0.9rem; }
        
        .btn { padding: 6px 12px; border: none; border-radius: 6px; font-family: 'Fredoka', sans-serif; font-weight: 600; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; transition: background 0.3s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-blue { background: #3b82f6; color: white; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- MUFRODAT BOARD --- */
        .timer-container { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-bottom: 10px; flex-shrink: 0; }
        .timer-bar { height: 100%; background: var(--primary); width: 100%; transition: width 0.1s linear; }
        
        .game-board-mufrodat {
            display: grid; gap: 8px; width: 100%; height: 100%;
            max-height: calc(100vh - 160px); align-content: center; justify-content: center; perspective: 1000px;
        }
        .card {
            background-color: transparent; border-radius: 8px; cursor: pointer; position: relative;
            transform-style: preserve-3d; transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            aspect-ratio: 1 / 1; max-width: 120px; max-height: 120px;
        }
        .card.flipped { transform: rotateY(180deg); }
        .card.matched { transform: rotateY(180deg); cursor: default; }
        .face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; justify-content: center; align-items: center; border-radius: 8px; font-weight: bold; padding: 2px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .front { background: linear-gradient(135deg, var(--primary), var(--dark)); color: white; font-size: 2.5rem; border: 2px solid white; }
        .back { background: white; transform: rotateY(180deg); border: 2px solid var(--primary); color: var(--dark); font-size: 1.2rem; line-height: 1.1; overflow:hidden; word-wrap:break-word;}
        .card.matched .back { background-color: var(--matched-bg) !important; color: white !important; border-color: #93c5fd; animation: pulse 0.5s ease-in-out; }
        .arabic-text { font-family: 'Amiri', serif; font-size: 2.2rem !important; font-weight: 900; line-height: 1; margin-top: -5px; }

        /* --- FIQIH BOARD --- */
        .fiqih-container { width: 100%; max-width: 700px; display: flex; flex-direction: column; gap: 20px; padding-bottom: 20px; }
        .fiqih-question { text-align: center; font-size: 1.3rem; font-weight: bold; color: var(--dark); margin-bottom: 10px; }
        .slots-area { display: flex; flex-direction: column; gap: 8px; }
        .slot { background: var(--slot-bg); border: 2px dashed #ccc; border-radius: 8px; min-height: 50px; display: flex; align-items: center; padding: 0 15px; position: relative; }
        .slot-number { background: var(--dark); color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px; flex-shrink: 0; }
        .slot.filled { border-style: solid; border-color: var(--primary); background: white; }
        .slot.correct { background-color: #d1fae5; border-color: #10b981; }
        .slot.wrong { background-color: #fee2e2; border-color: #ef4444; }
        .pieces-area { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; padding: 15px; background: rgba(255,255,255,0.5); border-radius: 10px; border: 1px solid #ccc; }
        .puzzle-piece { background: white; border: 2px solid var(--primary); color: var(--dark); padding: 10px 15px; border-radius: 8px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .puzzle-piece:hover { transform: scale(1.05); background: var(--bg); }

        @keyframes pulse { 0% { transform: rotateY(180deg) scale(1); } 50% { transform: rotateY(180deg) scale(1.1); } 100% { transform: rotateY(180deg) scale(1); } }

        /* MODAL & OVERLAY */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; text-align: center; width: 90%; max-width: 350px; animation: popIn 0.3s ease; }
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 200; justify-content: center; align-items: center; flex-direction: column; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes popIn { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* LEADERBOARD */
        .lb-item { padding: 8px; border-bottom: 1px solid #f3f4f6; margin-bottom: 4px; }
        .lb-rank { width: 20px; height: 20px; font-size: 0.7rem; background:var(--dark); color:white; border-radius:50%; display:inline-flex; align-items:center; justify-content:center; margin-right:5px;}
        .rank-badge { font-size: 0.65rem; padding: 1px 5px; border-radius:4px; font-weight:bold;}
        .rank-1 { background: linear-gradient(45deg, #FFD700, #FDB931); color: #5c4004; }
        .rank-2 { background: linear-gradient(45deg, #E0E0E0, #BDBDBD); color: #424242; }
        .rank-3 { background: linear-gradient(45deg, #CD7F32, #A0522D); color: #fff; }
        .rank-legend { background: linear-gradient(45deg, #f59e0b, #b45309); color: white; }
        .rank-master { background: #fbcfe8; color: #9d174d; }
        .rank-high { background: #fef08a; color: #854d0e; }
        .rank-mid { background: #bfdbfe; color: #1e40af; }
        .rank-new { background: #e5e7eb; color: #374151; }

        @media (max-width: 900px) {
            .main-container { flex-direction: column; padding: 5px; }
            .game-area { width: 100%; height: 65vh; }
            .sidebar { display: none; }
            .game-board-mufrodat { max-height: none; }
        }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="loader"></div><p>Memproses...</p></div>

    <div id="gameMenu">
        <div style="text-align:center; margin-bottom:30px;">
            <h1 style="color:var(--dark); font-size:2.5rem; margin:0;">ğŸ® Arcade Santri</h1>
            <p style="color:#555;">Belajar sambil bermain!</p>
        </div>
        <div class="menu-grid">
            <div class="game-card" onclick="selectGame('mufrodat')">
                <div style="font-size:3rem;">ğŸ§ </div>
                <div style="font-weight:bold; font-size:1.2rem;">Master Mufrodat</div>
                <div style="font-size:0.9rem; color:#666;">Hafalan kosakata kartu.</div>
                <div class="status-ready">MAIN SEKARANG</div>
            </div>
            <div class="game-card" onclick="selectGame('fiqih')">
                <div style="font-size:3rem;">ğŸ§©</div>
                <div style="font-weight:bold; font-size:1.2rem;">Puzzle Fiqih</div>
                <div style="font-size:0.9rem; color:#666;">Urutkan tata cara ibadah.</div>
                <div class="status-ready">MAIN SEKARANG</div>
            </div>
            <div class="game-card" onclick="selectGame('tajwid')">
                <div style="font-size:3rem;">ğŸ”</div><div style="font-weight:bold;">Detektif Tajwid</div><div class="status-soon">SEGERA HADIR</div>
            </div>
            <div class="game-card" onclick="selectGame('tahfidz')">
                <div style="font-size:3rem;">ğŸ“–</div><div style="font-weight:bold;">Sambung Ayat</div><div class="status-soon">SEGERA HADIR</div>
            </div>
            <div class="game-card" onclick="selectGame('nahwu')">
                <div style="font-size:3rem;">ğŸ—ï¸</div><div style="font-weight:bold;">Juragan Nahwu</div><div class="status-soon">SEGERA HADIR</div>
            </div>
        </div>
    </div>

    <div id="gameUI">
        <div class="header">
            <div style="display:flex; align-items:center; gap:15px;">
                <button class="home-btn" onclick="backToMenu()">ğŸ  Home</button>
                <h1 id="gameTitleDisplay">ğŸ® Game</h1>
            </div>
            <div class="user-info" id="userStatus">Tamu</div>
        </div>

        <div class="main-container">
            <div class="game-area">
                <div class="controls-bar">
                    <button class="btn btn-blue" onclick="fetchLeaderboard(true)">ğŸ† Peringkat</button>
                    <button class="btn btn-accent" id="btnSave" onclick="saveProgress()" disabled>ğŸ’¾ Simpan</button>
                    <button class="btn btn-primary" id="btnLoad" onclick="loadProgress()" disabled>ğŸ“‚ Muat Ulang</button>
                </div>

                <div class="status-bar">
                    <div class="badge">Lv: <span id="levelDisplay">1</span></div>
                    <div class="badge">Skor: <span id="scoreDisplay">0</span></div>
                </div>

                <div class="timer-container" id="mufrodatTimerContainer">
                    <div class="timer-bar" id="timerBar"></div>
                </div>
                <div class="game-board-mufrodat" id="gameBoardMufrodat" style="display:none;"></div>

                <div class="fiqih-container" id="gameBoardFiqih" style="display:none;">
                    <div class="fiqih-question" id="fiqihQuestion">Urutkan Rukun Wudhu</div>
                    <div class="slots-area" id="fiqihSlots"></div>
                    <div style="text-align:center; margin:10px 0;"><p style="font-size:0.9rem; color:#666;">Klik potongan di bawah.</p></div>
                    <div class="pieces-area" id="fiqihPieces"></div>
                    <button class="btn btn-primary" id="checkFiqihBtn" style="width:100%; padding:12px;" onclick="checkFiqihAnswer()">âœ… Cek Jawaban</button>
                </div>
            </div>

            <div class="sidebar">
                <h2>ğŸ† Peringkat Top 10</h2>
                <div id="leaderboardList"><p style="text-align:center; color:#999;">...</p></div>
                <div style="margin-top:10px; text-align:center;">
                    <button class="btn btn-blue" onclick="fetchLeaderboard()" style="width:100%;">ğŸ”„ Refresh</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="leaderboardModal">
        <div class="modal-content" style="max-height: 80vh; overflow-y: auto;">
            <h2 style="color: var(--dark); margin-top:0;">ğŸ† Top 10</h2>
            <div id="modalLbContent">Memuat...</div>
            <button class="btn btn-primary" style="margin-top: 15px; width: 100%;" onclick="document.getElementById('leaderboardModal').style.display='none'">Tutup</button>
        </div>
    </div>

    <div class="modal" id="levelModal">
        <div class="modal-content">
            <h2 style="color: var(--primary); margin-top:0;">Ahlan Wa Sahlan! ğŸ‰</h2>
            <p>Level <span id="nextLevelNum" style="font-weight:bold; font-size:1.5rem;"></span> Terbuka!</p>
            <p>Bonus: +<span id="timeBonus"></span> Poin</p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="nextLevel()">Lanjut</button>
                <button class="btn btn-accent" onclick="document.getElementById('levelModal').style.display='none'">Tutup</button>
            </div>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 style="color: #ef4444; margin-top:0;" id="gameOverTitle">Waktu Habis! â³</h2>
            <p>Skor Akhir: <span id="finalScore" style="font-weight:bold; font-size:1.5rem;"></span></p>
            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                <button class="btn btn-primary" onclick="restartLevel()">Ulangi</button>
                <button class="btn btn-accent" onclick="restartGame()">Reset</button>
            </div>
        </div>
    </div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec"; 
    
    let currentGameMode = ''; 
    let currentLevel = 1;
    let score = 0;
    let currentUser = null;

    // === DATA MUFRODAT LENGKAP (7 TIER) ===
    // Tier 1: Benda Sehari-hari
    const tier1 = [
        {a:"ÙƒÙØªÙØ§Ø¨ÙŒ", i:"Buku"}, {a:"Ù‚ÙÙ„ÙÙ…ÙŒ", i:"Pena"}, {a:"Ù…ÙÙƒÙ’ØªÙØ¨ÙŒ", i:"Meja"}, {a:"ÙƒÙØ±Ù’Ø³ÙÙŠÙŒÙ‘", i:"Kursi"}, {a:"Ø¨ÙØ§Ø¨ÙŒ", i:"Pintu"}, {a:"Ù†ÙØ§ÙÙØ°ÙØ©ÙŒ", i:"Jendela"},
        {a:"ÙÙØµÙ’Ù„ÙŒ", i:"Kelas"}, {a:"Ù…ÙØ¯Ù’Ø±ÙØ³ÙØ©ÙŒ", i:"Sekolah"}, {a:"Ø£ÙØ³Ù’ØªÙØ§Ø°ÙŒ", i:"Guru (Lk)"}, {a:"ØªÙÙ„Ù’Ù…ÙÙŠÙ’Ø°ÙŒ", i:"Murid"}, {a:"Ø³ÙØ¨ÙÙ‘ÙˆÙ’Ø±ÙØ©ÙŒ", i:"Papan Tulis"}, {a:"Ù…ÙÙ…Ù’Ø³ÙØ­ÙØ©ÙŒ", i:"Penghapus"},
        {a:"Ø­ÙÙ‚ÙÙŠÙ’Ø¨ÙØ©ÙŒ", i:"Tas"}, {a:"Ù…Ø³Ø·Ø±Ø©", i:"Penggaris"}, {a:"Ø³ÙØ§Ø¹ÙØ©ÙŒ", i:"Jam"}, {a:"Ø¨ÙÙŠÙ’ØªÙŒ", i:"Rumah"}, {a:"ØºÙØ±Ù’ÙÙØ©ÙŒ", i:"Kamar"}, {a:"Ù…ÙØ·Ù’Ø¨ÙØ®ÙŒ", i:"Dapur"},
        {a:"Ø­ÙÙ…ÙÙ‘Ø§Ù…ÙŒ", i:"Kamar Mandi"}, {a:"Ø³ÙØ±ÙÙŠÙ’Ø±ÙŒ", i:"Ranjang"}, {a:"Ù…ÙØ±Ù’Ø¢Ø©ÙŒ", i:"Cermin"}, {a:"Ù…ÙØµÙ’Ø¨ÙØ§Ø­ÙŒ", i:"Lampu"}, {a:"Ø«ÙÙˆÙ’Ø¨ÙŒ", i:"Baju"}, {a:"Ø­ÙØ°ÙØ§Ø¡ÙŒ", i:"Sepatu"},
        {a:"Ø¬ÙÙˆÙ’Ø±ÙØ¨ÙŒ", i:"Kaos Kaki"}, {a:"Ù‚ÙÙ„ÙÙ†Ù’Ø³ÙÙˆÙØ©ÙŒ", i:"Peci"}, {a:"Ù…ÙØ§Ø¡ÙŒ", i:"Air"}, {a:"Ø®ÙØ¨Ù’Ø²ÙŒ", i:"Roti"}, {a:"Ù„ÙØ­Ù’Ù…ÙŒ", i:"Daging"}, {a:"Ø³ÙÙ…ÙÙƒÙŒ", i:"Ikan"}
    ];
    // Tier 2: Kata Kerja & Sifat
    const tier2 = [
        {a:"Ø£ÙÙƒÙÙ„Ù", i:"Makan"}, {a:"Ø´ÙØ±ÙØ¨Ù", i:"Minum"}, {a:"Ù†ÙØ§Ù…Ù", i:"Tidur"}, {a:"Ù‚ÙØ§Ù…Ù", i:"Berdiri"}, {a:"Ø¬ÙÙ„ÙØ³Ù", i:"Duduk"}, {a:"Ø°ÙÙ‡ÙØ¨Ù", i:"Pergi"},
        {a:"Ø±ÙØ¬ÙØ¹Ù", i:"Pulang"}, {a:"Ù‚ÙØ±ÙØ£Ù", i:"Membaca"}, {a:"ÙƒÙØªÙØ¨Ù", i:"Menulis"}, {a:"Ø¯ÙØ®ÙÙ„Ù", i:"Masuk"}, {a:"Ø®ÙØ±ÙØ¬Ù", i:"Keluar"}, {a:"ÙÙØªÙØ­Ù", i:"Membuka"},
        {a:"ØºÙÙ„ÙÙ‚Ù", i:"Menutup"}, {a:"Ù†ÙØ¸ÙØ±Ù", i:"Melihat"}, {a:"Ø³ÙÙ…ÙØ¹Ù", i:"Mendengar"}, {a:"ÙƒÙØ¨ÙŠØ±ÙŒ", i:"Besar"}, {a:"ØµÙØºÙÙŠÙ’Ø±ÙŒ", i:"Kecil"}, {a:"Ø·ÙÙˆÙÙŠÙ’Ù„ÙŒ", i:"Panjang"},
        {a:"Ù‚ÙØµÙÙŠÙ’Ø±ÙŒ", i:"Pendek"}, {a:"Ø¬ÙØ¯ÙÙŠÙ’Ø¯ÙŒ", i:"Baru"}, {a:"Ù‚ÙØ¯ÙÙŠÙ’Ù…ÙŒ", i:"Lama"}, {a:"Ù†ÙØ¸ÙÙŠÙ’ÙÙŒ", i:"Bersih"}, {a:"ÙˆÙØ³ÙØ®ÙŒ", i:"Kotor"}, {a:"Ø¬ÙÙ…ÙÙŠÙ’Ù„ÙŒ", i:"Indah"},
        {a:"Ù‚ÙØ¨ÙÙŠÙ’Ø­ÙŒ", i:"Jelek"}, {a:"Ù‚ÙØ±ÙÙŠÙ’Ø¨ÙŒ", i:"Dekat"}, {a:"Ø¨ÙØ¹ÙÙŠÙ’Ø¯ÙŒ", i:"Jauh"}, {a:"Ø³ÙØ±ÙÙŠÙ’Ø¹ÙŒ", i:"Cepat"}, {a:"Ø¨ÙØ·ÙÙŠÙ’Ø¡ÙŒ", i:"Lambat"}, {a:"Ù‚ÙÙˆÙÙŠÙŒÙ‘", i:"Kuat"}
    ];
    // Tier 3: Alam & Tubuh
    const tier3 = [
        {a:"Ø³ÙÙ…ÙØ§Ø¡ÙŒ", i:"Langit"}, {a:"Ø£ÙØ±Ù’Ø¶ÙŒ", i:"Bumi"}, {a:"Ø´ÙÙ…Ù’Ø³ÙŒ", i:"Matahari"}, {a:"Ù‚ÙÙ…ÙØ±ÙŒ", i:"Bulan"}, {a:"Ù†ÙØ¬Ù’Ù…ÙŒ", i:"Bintang"}, {a:"Ø¬ÙØ¨ÙÙ„ÙŒ", i:"Gunung"},
        {a:"Ø¨ÙØ­Ù’Ø±ÙŒ", i:"Laut"}, {a:"Ù†ÙÙ‡Ù’Ø±ÙŒ", i:"Sungai"}, {a:"Ø´ÙØ¬ÙØ±ÙØ©ÙŒ", i:"Pohon"}, {a:"Ø²ÙÙ‡Ù’Ø±ÙØ©ÙŒ", i:"Bunga"}, {a:"Ø£ÙØ³ÙØ¯ÙŒ", i:"Singa"}, {a:"ÙÙÙŠÙ’Ù„ÙŒ", i:"Gajah"},
        {a:"Ù‚ÙØ·ÙŒÙ‘", i:"Kucing"}, {a:"ÙƒÙÙ„Ù’Ø¨ÙŒ", i:"Anjing"}, {a:"Ø·ÙØ§Ø¦ÙØ±ÙŒ", i:"Burung"}, {a:"Ø±ÙØ£Ù’Ø³ÙŒ", i:"Kepala"}, {a:"Ø¹ÙÙŠÙ’Ù†ÙŒ", i:"Mata"}, {a:"Ø£ÙÙ†Ù’ÙÙŒ", i:"Hidung"},
        {a:"Ø£ÙØ°ÙÙ†ÙŒ", i:"Telinga"}, {a:"ÙÙÙ…ÙŒ", i:"Mulut"}, {a:"ÙŠÙØ¯ÙŒ", i:"Tangan"}, {a:"Ø±ÙØ¬Ù’Ù„ÙŒ", i:"Kaki"}, {a:"Ù‚ÙÙ„Ù’Ø¨ÙŒ", i:"Jantung"}, {a:"Ø¨ÙØ·Ù’Ù†ÙŒ", i:"Perut"},
        {a:"Ø´ÙØ¹Ù’Ø±ÙŒ", i:"Rambut"}, {a:"Ù„ÙØ³ÙØ§Ù†ÙŒ", i:"Lidah"}, {a:"Ø³ÙÙ†ÙŒÙ‘", i:"Gigi"}
    ];
    // Tier 4: Agama
    const tier4 = [
        {a:"ØµÙÙ„ÙØ§Ø©ÙŒ", i:"Sholat"}, {a:"ØµÙÙˆÙ’Ù…ÙŒ", i:"Puasa"}, {a:"Ø²ÙÙƒÙØ§Ø©ÙŒ", i:"Zakat"}, {a:"Ø­ÙØ¬ÙŒÙ‘", i:"Haji"}, {a:"Ø¥ÙÙŠÙ’Ù…ÙØ§Ù†ÙŒ", i:"Iman"}, {a:"ØªÙÙ‚Ù’ÙˆÙÙ‰", i:"Taqwa"},
        {a:"Ø¬ÙÙ†ÙÙ‘Ø©ÙŒ", i:"Surga"}, {a:"Ù†ÙØ§Ø±ÙŒ", i:"Neraka"}, {a:"Ù…ÙÙ„ÙØ§Ø¦ÙÙƒÙØ©ÙŒ", i:"Malaikat"}, {a:"Ø´ÙÙŠÙ’Ø·ÙØ§Ù†ÙŒ", i:"Setan"}, {a:"Ù‚ÙÙŠÙØ§Ù…ÙØ©ÙŒ", i:"Kiamat"}, {a:"Ø°ÙÙ†Ù’Ø¨ÙŒ", i:"Dosa"},
        {a:"Ø«ÙÙˆÙØ§Ø¨ÙŒ", i:"Pahala"}, {a:"Ø¥ÙØ®Ù’Ù„ÙØ§ØµÙŒ", i:"Ikhlas"}, {a:"ØµÙØ¨Ù’Ø±ÙŒ", i:"Sabar"}, {a:"Ø´ÙÙƒÙ’Ø±ÙŒ", i:"Syukur"}, {a:"Ø¹ÙÙ„Ù’Ù…ÙŒ", i:"Ilmu"}, {a:"Ø¹ÙÙ…ÙÙ„ÙŒ", i:"Amal"},
        {a:"ØµÙØ¯Ù’Ù‚ÙŒ", i:"Jujur"}, {a:"ÙƒÙØ°Ù’Ø¨ÙŒ", i:"Dusta"}, {a:"Ø®ÙÙŠÙ’Ø±Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø³Ù", i:"Sebaik Manusia"}, {a:"Ø·ÙÙ„ÙØ¨Ù Ø§Ù„Ù’Ø¹ÙÙ„Ù’Ù…Ù", i:"Menuntut Ilmu"}, {a:"Ø¨ÙØ±ÙÙ‘ Ø§Ù„Ù’ÙˆÙØ§Ù„ÙØ¯ÙÙŠÙ’Ù†Ù", i:"Berbakti Ortu"},
        {a:"Ù…ÙÙ†Ù’ Ø¬ÙØ¯ÙÙ‘ ÙˆÙØ¬ÙØ¯Ù", i:"Siapa bersungguh dapat"}, {a:"Ø§Ù„ØµÙÙ‘Ø¨Ù’Ø±Ù Ø¶ÙÙŠÙØ§Ø¡ÙŒ", i:"Sabar itu cahaya"}
    ];
    // Tier 5: Profesi & Keluarga
    const tier5 = [
        {a:"Ø·ÙØ¨ÙÙŠÙ’Ø¨ÙŒ", i:"Dokter"}, {a:"Ù…ÙÙ‡ÙÙ†Ù’Ø¯ÙØ³ÙŒ", i:"Insinyur"}, {a:"ØªÙØ§Ø¬ÙØ±ÙŒ", i:"Pedagang"}, {a:"ÙÙÙ„ÙÙ‘Ø§Ø­ÙŒ", i:"Petani"}, {a:"Ø´ÙØ±Ù’Ø·ÙÙŠÙŒÙ‘", i:"Polisi"}, {a:"Ø¬ÙÙ†Ù’Ø¯ÙÙŠÙŒÙ‘", i:"Tentara"},
        {a:"Ø³ÙØ§Ø¦ÙÙ‚ÙŒ", i:"Sopir"}, {a:"Ø·ÙØ¨ÙÙ‘Ø§Ø®ÙŒ", i:"Koki"}, {a:"Ø£ÙØ¨ÙŒ", i:"Ayah"}, {a:"Ø£ÙÙ…ÙŒÙ‘", i:"Ibu"}, {a:"Ø£ÙØ®ÙŒ", i:"Saudara (Lk)"}, {a:"Ø£ÙØ®Ù’ØªÙŒ", i:"Saudari (Pr)"},
        {a:"Ø¬ÙØ¯ÙŒÙ‘", i:"Kakek"}, {a:"Ø¬ÙØ¯ÙÙ‘Ø©ÙŒ", i:"Nenek"}, {a:"Ø¹ÙÙ…ÙŒÙ‘", i:"Paman (Ayah)"}, {a:"Ø¹ÙÙ…ÙÙ‘Ø©ÙŒ", i:"Bibi (Ayah)"}, {a:"Ø®ÙØ§Ù„ÙŒ", i:"Paman (Ibu)"}, {a:"Ø®ÙØ§Ù„ÙØ©ÙŒ", i:"Bibi (Ibu)"},
        {a:"ÙˆÙÙ„ÙØ¯ÙŒ", i:"Anak (Lk)"}, {a:"Ø¨ÙÙ†Ù’ØªÙŒ", i:"Anak (Pr)"}, {a:"Ø²ÙÙˆÙ’Ø¬ÙŒ", i:"Suami"}, {a:"Ø²ÙÙˆÙ’Ø¬ÙØ©ÙŒ", i:"Istri"}, {a:"Ù‚ÙØ§Ø¶Ù", i:"Hakim"}, {a:"ØµÙÙŠÙÙ‘Ø§Ø¯ÙŒ", i:"Nelayan"}, {a:"Ù…ÙÙ…ÙØ±ÙÙ‘Ø¶ÙŒ", i:"Perawat"}
    ];
    // Tier 6: Waktu, Arah & Transportasi
    const tier6 = [
        {a:"ØµÙØ¨ÙØ§Ø­ÙŒ", i:"Pagi"}, {a:"Ù†ÙÙ‡ÙØ§Ø±ÙŒ", i:"Siang"}, {a:"Ù…ÙØ³ÙØ§Ø¡ÙŒ", i:"Sore"}, {a:"Ù„ÙÙŠÙ’Ù„ÙŒ", i:"Malam"}, {a:"ÙŠÙÙˆÙ’Ù…ÙŒ", i:"Hari"}, {a:"Ø£ÙØ³Ù’Ø¨ÙÙˆÙ’Ø¹ÙŒ", i:"Minggu"},
        {a:"Ø´ÙÙ‡Ù’Ø±ÙŒ", i:"Bulan"}, {a:"Ø³ÙÙ†ÙØ©ÙŒ", i:"Tahun"}, {a:"Ø³ÙØ§Ø¹ÙØ©ÙŒ", i:"Jam"}, {a:"Ø¯ÙÙ‚ÙÙŠÙ’Ù‚ÙØ©ÙŒ", i:"Menit"}, {a:"Ø«ÙØ§Ù†ÙÙŠÙØ©ÙŒ", i:"Detik"}, {a:"Ø£ÙÙ…ÙØ§Ù…Ù", i:"Depan"},
        {a:"ÙˆÙØ±ÙØ§Ø¡Ù", i:"Belakang"}, {a:"ÙÙÙˆÙ’Ù‚Ù", i:"Atas"}, {a:"ØªÙØ­Ù’ØªÙ", i:"Bawah"}, {a:"ÙŠÙÙ…ÙÙŠÙ’Ù†Ù", i:"Kanan"}, {a:"ÙŠÙØ³ÙØ§Ø±Ù", i:"Kiri"}, {a:"Ø³ÙÙŠÙÙ‘Ø§Ø±ÙØ©ÙŒ", i:"Mobil"},
        {a:"Ø·ÙØ§Ø¦ÙØ±ÙØ©ÙŒ", i:"Pesawat"}, {a:"Ù‚ÙØ·ÙØ§Ø±ÙŒ", i:"Kereta Api"}, {a:"Ø¯ÙØ±ÙÙ‘Ø§Ø¬ÙØ©ÙŒ", i:"Sepeda"}, {a:"Ø³ÙÙÙÙŠÙ’Ù†ÙØ©ÙŒ", i:"Kapal"}, {a:"Ø­ÙØ§ÙÙÙ„ÙØ©ÙŒ", i:"Bus"}, {a:"Ø´ÙØ§Ø±ÙØ¹ÙŒ", i:"Jalan"}, {a:"Ù…ÙØ·ÙØ§Ø±ÙŒ", i:"Bandara"}
    ];
    // Tier 7: Hewan Ternak, Warna & Sifat Lanjutan
    const tier7 = [
        {a:"Ø£ÙØ­Ù’Ù…ÙØ±Ù", i:"Merah"}, {a:"Ø£ÙØ¨Ù’ÙŠÙØ¶Ù", i:"Putih"}, {a:"Ø£ÙØ³Ù’ÙˆÙØ¯Ù", i:"Hitam"}, {a:"Ø£ÙØ®Ù’Ø¶ÙØ±Ù", i:"Hijau"}, {a:"Ø£ÙØ²Ù’Ø±ÙÙ‚Ù", i:"Biru"}, {a:"Ø£ÙØµÙ’ÙÙØ±Ù", i:"Kuning"},
        {a:"Ø¬ÙÙ…ÙÙ„ÙŒ", i:"Unta"}, {a:"Ø­ÙØµÙØ§Ù†ÙŒ", i:"Kuda"}, {a:"ØºÙÙ†ÙÙ…ÙŒ", i:"Kambing"}, {a:"Ø¨ÙÙ‚ÙØ±ÙØ©ÙŒ", i:"Sapi"}, {a:"Ø¯ÙØ¬ÙØ§Ø¬ÙØ©ÙŒ", i:"Ayam"}, {a:"Ø¨ÙØ·ÙÙ‘Ø©ÙŒ", i:"Bebek"},
        {a:"Ø£ÙØ±Ù’Ù†ÙØ¨ÙŒ", i:"Kelinci"}, {a:"Ù†ÙÙ…Ù’Ù„ÙØ©ÙŒ", i:"Semut"}, {a:"Ù†ÙØ­Ù’Ù„ÙØ©ÙŒ", i:"Lebah"}, {a:"Ø¨ÙØ¹ÙÙˆÙ’Ø¶ÙØ©ÙŒ", i:"Nyamuk"}, {a:"Ø°ÙØ¨ÙØ§Ø¨ÙŒ", i:"Lalat"}, {a:"Ù†ÙØ´ÙÙŠÙ’Ø·ÙŒ", i:"Rajin"},
        {a:"ÙƒÙØ³Ù’Ù„ÙØ§Ù†Ù", i:"Malas"}, {a:"Ù…ÙØ§Ù‡ÙØ±ÙŒ", i:"Pintar"}, {a:"Ø¬ÙØ§Ù‡ÙÙ„ÙŒ", i:"Bodoh"}, {a:"Ø³ÙÙ…ÙÙŠÙ’Ù†ÙŒ", i:"Gemuk"}, {a:"Ù†ÙØ­ÙÙŠÙ’ÙÙŒ", i:"Kurus"}, {a:"ØºÙØ§Ù„Ù", i:"Mahal"}, {a:"Ø±ÙØ®ÙÙŠÙ’ØµÙŒ", i:"Murah"}
    ];

    // FIQIH DATA
    const fiqihData = [
        { title: "Rukun Islam", steps: ["Syahadat", "Sholat", "Zakat", "Puasa", "Haji"] },
        { title: "Rukun Iman", steps: ["Iman kpd Allah", "Malaikat", "Kitab-kitab", "Rasul", "Hari Kiamat", "Qada & Qadar"] },
        { title: "Urutan Wudhu (Rukun)", steps: ["Niat", "Basuh Muka", "Basuh Tangan", "Usap Kepala", "Basuh Kaki", "Tertib"] },
        { title: "Rukun Sholat (Awal)", steps: ["Niat", "Takbiratul Ihram", "Berdiri", "Al-Fatihah", "Ruku'", "I'tidal", "Sujud"] },
        { title: "Gerakan Sholat (Rakaat 1)", steps: ["Takbir", "Fatihah & Surat", "Ruku'", "I'tidal", "Sujud", "Duduk Antara 2 Sujud", "Sujud Kedua"] },
        { title: "Mengurus Jenazah", steps: ["Memandikan", "Mengafani", "Menyolatkan", "Menguburkan"] },
        { title: "Syarat Wajib Sholat", steps: ["Islam", "Baligh", "Berakal", "Suci dari Hadas", "Masuk Waktu", "Menutup Aurat"] },
        { title: "Waktu Sholat Fardhu", steps: ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"] },
        { title: "Urutan Tayammum", steps: ["Niat", "Usap Muka", "Usap Tangan", "Tertib"] },
        { title: "Rukun Haji", steps: ["Ihram", "Wukuf", "Thawaf Ifadhah", "Sa'i", "Tahallul", "Tertib"] }
    ];

    function showLoading(show) { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
    
    function selectGame(gameId) {
        if (gameId === 'tajwid' || gameId === 'nahwu') {
            alert("Game ini sedang dalam pengembangan.");
            return;
        } else if (gameId === 'tahfidz') {
            alert("Game Sambung Ayat sedang disiapkan!");
            return;
        }

        currentGameMode = gameId;
        document.getElementById('gameMenu').style.display = 'none';
        document.getElementById('gameUI').style.display = 'flex';

        // Reset
        currentLevel = 1; score = 0;

        if (gameId === 'mufrodat') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ® Master Mufrodat";
            document.getElementById('gameBoardMufrodat').style.display = 'grid';
            document.getElementById('mufrodatTimerContainer').style.display = 'block';
            document.getElementById('gameBoardFiqih').style.display = 'none';
        } else if (gameId === 'fiqih') {
            document.getElementById('gameTitleDisplay').textContent = "ğŸ§© Puzzle Fiqih";
            document.getElementById('gameBoardMufrodat').style.display = 'none';
            document.getElementById('mufrodatTimerContainer').style.display = 'none'; 
            document.getElementById('gameBoardFiqih').style.display = 'flex';
        }
        checkSession();
    }

    function backToMenu() {
        clearInterval(mufrodatInterval);
        document.getElementById('gameUI').style.display = 'none';
        document.getElementById('gameMenu').style.display = 'flex';
    }

    function checkSession() {
        const sessionStr = localStorage.getItem('userSession') || sessionStorage.getItem('userSession');
        if (sessionStr) {
            const session = JSON.parse(sessionStr);
            if (session.loggedIn) {
                currentUser = session.userData;
                document.getElementById('userStatus').innerHTML = `<b>ğŸ‘¤ ${currentUser.profileName}</b>`;
                document.getElementById('btnSave').disabled = false;
                document.getElementById('btnLoad').disabled = false;
                fetchLeaderboard(false, true); // Sync user data
            }
        } else {
            fetchLeaderboard(false, false); // Guest
            startGameLevel();
        }
    }

    function getRankInfo(level) {
        if (level >= 46) return { title: "ğŸ‘‘ Syaikhul 'Ilmi", class: "rank-legend" };
        if (level >= 31) return { title: "âš”ï¸ Farisul Lughah", class: "rank-master" };
        if (level >= 16) return { title: "ğŸ“š Hafizh Mufrodat", class: "rank-high" };
        if (level >= 6)  return { title: "ğŸ”¥ Thalib Mujtahid", class: "rank-mid" };
        return { title: "ğŸŒ± Thalib Jadid", class: "rank-new" };
    }

    function startGameLevel() {
        if (currentGameMode === 'mufrodat') startMufrodatLevel();
        else if (currentGameMode === 'fiqih') startFiqihLevel();
    }

    // === SAVE/LOAD ===
    function saveProgress(silent = false) {
        if (!currentUser) { if(!silent) alert("Login dulu!"); return; }
        if(!silent) showLoading(true);
        const btnSave = document.getElementById('btnSave');
        if(silent) btnSave.innerText = "â³...";

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'saveGameProgress', 
                username: currentUser.username, 
                nama: currentUser.profileName,
                level: currentLevel, skor: score,
                namaGame: currentGameMode 
            })
        }).then(r=>r.json()).then(res => {
            if(!silent) { showLoading(false); alert("Tersimpan!"); }
            else { btnSave.innerText = "âœ…"; setTimeout(()=>btnSave.innerText="ğŸ’¾ Simpan", 2000); }
            fetchLeaderboard(false, false);
        }).catch(e => { if(!silent) showLoading(false); });
    }

    function loadProgress() {
        if (!currentUser) return alert("Login dulu!");
        fetchLeaderboard(false, true);
    }

    function fetchLeaderboard(showModal = false, sync = false) {
        const lbContainer = document.getElementById('leaderboardList');
        if(!showModal && !sync) lbContainer.innerHTML = '<p style="text-align:center; color:#999;">...</p>';

        fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getGameLeaderboardAndProgress', 
                username: currentUser ? currentUser.username : '',
                namaGame: currentGameMode
            })
        }).then(r=>r.json()).then(res => {
            if(res.status === 'success') {
                const html = renderLbHtml(res.leaderboard, res.myProgress);
                lbContainer.innerHTML = html;
                if(showModal) {
                    document.getElementById('modalLbContent').innerHTML = html;
                    document.getElementById('leaderboardModal').style.display = 'flex';
                }
                if(sync) {
                    if (res.myProgress) {
                        currentLevel = res.myProgress.level;
                        score = res.myProgress.skor;
                        document.getElementById('levelDisplay').innerText = currentLevel;
                        document.getElementById('scoreDisplay').innerText = score;
                        document.getElementById('btnLoad').innerText = `ğŸ“‚ Muat Ulang (Lv ${currentLevel})`;
                        startGameLevel();
                    } else {
                        startGameLevel();
                    }
                }
            }
        });
    }

    function renderLbHtml(list, me) {
        let html = '';
        list.forEach((item, i) => {
            // 1. Ambil gelar dasar berdasarkan Level (Default)
            let rankInfo = getRankInfo(item.level); 
            
            // 2. CSS untuk nomor urut (Lingkaran angka)
            let rankClass = ""; 

            // 3. LOGIKA JUARA: Timpa gelar level jika masuk Top 3
            if (i === 0) { 
                rankClass = "rank-1"; // Lingkaran Emas
                rankInfo = { title: "ğŸ¥‡ The Champion", class: "rank-1" }; // Gelar Emas
            } 
            else if (i === 1) { 
                rankClass = "rank-2"; // Lingkaran Perak
                rankInfo = { title: "ğŸ¥ˆ Runner Up", class: "rank-2" }; 
            } 
            else if (i === 2) { 
                rankClass = "rank-3"; // Lingkaran Perunggu
                rankInfo = { title: "ğŸ¥‰ 3rd Place", class: "rank-3" }; 
            }

            const isMe = (me && item.username === me.username) ? 'my-rank-item' : '';
            
            html += `
            <div class="lb-item ${isMe}">
                <div class="lb-header">
                    <div>
                        <span class="lb-rank ${rankClass}">${i+1}</span> 
                        ${item.username}
                    </div>
                    <span>${item.skor}</span>
                </div>
                <div class="lb-details">
                    <span class="rank-badge ${rankInfo.class}">${rankInfo.title}</span>
                    Lv ${item.level}
                </div>
            </div>`;
        });

        // Tampilkan posisi saya sendiri jika tidak masuk Top 10
        if(me && !list.find(i => i.username === me.username)) {
             let rankInfo = getRankInfo(me.level);
             html += `<div style="margin-top:10px; border-top:2px dashed #ccc; padding-top:10px;">
                <div class="lb-item my-rank-item">
                    <div class="lb-header">
                        <div><span class="lb-rank">?</span> Anda (${me.username})</div>
                        <span>${me.skor}</span>
                    </div>
                    <div class="lb-details">
                        <span class="rank-badge ${rankInfo.class}">${rankInfo.title}</span>
                        Lv ${me.level}
                    </div>
                </div>
            </div>`;
        }
        return html || '<p style="text-align:center;">Belum ada data.</p>';
    }

    // === MUFRODAT LOGIC (FULL) ===
    let mufrodatInterval, mfFirstCard, mfSecondCard, mfLockBoard, mfMatches, mfPairsNeeded, mfTimeLeft, mfTotalTime;

    function getLevelConfig(level) {
        let tierData, gridCols, pairs, timePerPair;
        
        if (level <= 10) { tierData = tier1; gridCols = 3; timePerPair = 15; } 
        else if (level <= 20) { tierData = [...tier1, ...tier2]; gridCols = 4; timePerPair = 12; } 
        else if (level <= 30) { tierData = [...tier2, ...tier3]; gridCols = 4; timePerPair = 10; } 
        else if (level <= 35) { tierData = [...tier3, ...tier4]; gridCols = 4; timePerPair = 10; }
        else if (level <= 40) { tierData = [...tier4, ...tier5]; gridCols = 5; timePerPair = 9; }
        else if (level <= 45) { tierData = [...tier5, ...tier6]; gridCols = 5; timePerPair = 8; }
        else { tierData = [...tier6, ...tier7]; gridCols = 5; timePerPair = 8; } 

        pairs = Math.min(4 + Math.floor(level / 3), 15); 
        if (window.innerWidth < 600 && gridCols > 4) gridCols = 4;

        return { data: tierData, cols: gridCols, pairs: pairs, time: Math.floor(pairs * timePerPair) + 10 };
    }

    function startMufrodatLevel() {
        const board = document.getElementById('gameBoardMufrodat');
        board.innerHTML = '';
        
        const config = getLevelConfig(currentLevel);
        
        mfPairsNeeded = config.pairs;
        mfTotalTime = config.time;
        mfTimeLeft = mfTotalTime;
        mfMatches = 0; mfLockBoard = false; mfFirstCard = null; mfSecondCard = null;

        document.getElementById('levelDisplay').innerText = currentLevel;
        document.getElementById('scoreDisplay').innerText = score;
        board.style.gridTemplateColumns = `repeat(${config.cols}, 1fr)`;

        const shuffled = config.data.sort(() => 0.5 - Math.random()).slice(0, mfPairsNeeded);
        let deck = [];
        shuffled.forEach((item, i) => {
            deck.push({ id: i, content: item.a, type: 'arab' });
            deck.push({ id: i, content: item.i, type: 'indo' });
        });
        deck.sort(() => 0.5 - Math.random());

        deck.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = item.id;
            card.innerHTML = `<div class="face front">â“</div><div class="face back ${item.type==='arab'?'arabic-text':''}">${item.content}</div>`;
            card.addEventListener('click', flipMufrodatCard);
            board.appendChild(card);
        });

        startMufrodatTimer();
    }

    function startMufrodatTimer() {
        clearInterval(mufrodatInterval);
        const bar = document.getElementById('timerBar');
        bar.style.width = '100%';
        mufrodatInterval = setInterval(() => {
            mfTimeLeft -= 0.1;
            bar.style.width = `${(mfTimeLeft/mfTotalTime)*100}%`;
            if(mfTimeLeft <= 0) { clearInterval(mufrodatInterval); showGameOver(); }
        }, 100);
    }

    function flipMufrodatCard() {
        if (mfLockBoard || this === mfFirstCard || this.classList.contains('matched')) return;
        this.classList.add('flipped');

        if (!mfFirstCard) { mfFirstCard = this; return; }
        mfSecondCard = this; mfLockBoard = true;

        if (mfFirstCard.dataset.id === mfSecondCard.dataset.id) {
            score += 10; mfMatches++;
            document.getElementById('scoreDisplay').innerText = score;
            mfFirstCard.classList.add('matched'); mfSecondCard.classList.add('matched');
            
            let bonus = 3;
            if(currentLevel >= 20) bonus = 4;
            if(currentLevel >= 40) bonus = 5;
            mfTimeLeft += bonus;
            
            mfFirstCard = null; mfSecondCard = null; mfLockBoard = false;
            if (mfMatches === mfPairsNeeded) showLevelComplete(Math.floor(mfTimeLeft));
        } else {
            setTimeout(() => {
                mfFirstCard.classList.remove('flipped'); mfSecondCard.classList.remove('flipped');
                mfFirstCard = null; mfSecondCard = null; mfLockBoard = false;
            }, 1000);
        }
    }

    // === FIQIH LOGIC ===
    let fiqihCurrentSeq = [];

    function startFiqihLevel() {
        document.getElementById('levelDisplay').innerText = currentLevel;
        document.getElementById('scoreDisplay').innerText = score;
        const idx = (currentLevel - 1) % fiqihData.length;
        const data = fiqihData[idx];
        fiqihCurrentSeq = data.steps;
        document.getElementById('fiqihQuestion').innerText = data.title;

        const slots = document.getElementById('fiqihSlots');
        slots.innerHTML = '';
        fiqihCurrentSeq.forEach((_, i) => {
            const d = document.createElement('div');
            d.className = 'slot'; d.innerHTML = `<div class="slot-number">${i+1}</div><div class="slot-content"></div>`;
            d.addEventListener('click', handleSlotClick);
            slots.appendChild(d);
        });

        const pieces = document.getElementById('fiqihPieces');
        pieces.innerHTML = '';
        [...fiqihCurrentSeq].sort(()=>0.5-Math.random()).forEach(txt => {
            const p = document.createElement('div');
            p.className = 'puzzle-piece'; p.innerText = txt;
            p.addEventListener('click', handlePieceClick);
            pieces.appendChild(p);
        });
    }

    function handlePieceClick() {
        const empty = Array.from(document.querySelectorAll('.slot')).find(s => !s.classList.contains('filled'));
        if(empty) {
            empty.querySelector('.slot-content').innerText = this.innerText;
            empty.classList.add('filled'); empty.dataset.value = this.innerText;
            this.remove();
        }
    }

    function handleSlotClick() {
        if(!this.classList.contains('filled')) return;
        const txt = this.dataset.value;
        const p = document.createElement('div');
        p.className = 'puzzle-piece'; p.innerText = txt;
        p.addEventListener('click', handlePieceClick);
        document.getElementById('fiqihPieces').appendChild(p);
        this.classList.remove('filled','correct','wrong');
        this.querySelector('.slot-content').innerText = '';
        this.dataset.value = '';
    }

    function checkFiqihAnswer() {
        const slots = document.querySelectorAll('.slot');
        let correct = 0; let full = true;
        slots.forEach((s, i) => {
            if(!s.classList.contains('filled')) { full = false; return; }
            if(s.dataset.value === fiqihCurrentSeq[i]) { s.classList.add('correct'); correct++; }
            else s.classList.add('wrong');
        });
        if(!full) return alert("Lengkapi dulu!");
        if(correct === fiqihCurrentSeq.length) {
            score += 50; showLevelComplete(0);
        } else {
            score = Math.max(0, score - 10);
            document.getElementById('scoreDisplay').innerText = score;
            alert("Masih salah!");
            setTimeout(() => slots.forEach(s => s.classList.remove('correct','wrong')), 1500);
        }
    }

    // === SHARED LOGIC ===
    function showLevelComplete(bonus) {
        clearInterval(mufrodatInterval);
        score += bonus;
        document.getElementById('scoreDisplay').innerText = score;
        saveProgress(true);
        document.getElementById('nextLevelNum').innerText = currentLevel + 1;
        document.getElementById('timeBonus').innerText = bonus;
        document.getElementById('levelModal').style.display = 'flex';
    }

    function showGameOver() {
        document.getElementById('finalScore').innerText = score;
        document.getElementById('gameOverModal').style.display = 'flex';
    }

    function nextLevel() {
        currentLevel++;
        document.getElementById('levelModal').style.display = 'none';
        startGameLevel();
    }

    function restartLevel() {
        document.getElementById('gameOverModal').style.display = 'none';
        startGameLevel();
    }

    function restartGame() {
        currentLevel = 1; score = 0;
        document.getElementById('gameOverModal').style.display = 'none';
        startGameLevel();
    }
</script>
</body>
</html>
