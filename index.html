<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yayasan Markaz Yatim Duafa Qurani - Beranda</title>
    
    <!-- Script & Font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Times+New+Roman&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bagian CSS untuk Styling -->
    <style>
        :root {
            --primary-color: #2c5e2e;
            --secondary-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #0d6efd; 
            --info-color-hover: #0b5ed7;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.7;
        }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; padding: 20px 0; }
        header { background-color: #ffffff; padding: 20px 0; border-bottom: 1px solid #e9ecef; }
        header .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
        header .logo-container { display: flex; align-items: center; }
        header img.logo { height: 60px; margin-right: 15px; }
        header .title-container h1 { margin: 0; font-size: 1.8em; color: var(--primary-color); }
        header .title-container p { margin: 0; font-size: 0.9em; color: #6c757d; }
        #date-display { text-align: right; font-size: 0.9em; color: var(--dark-gray); line-height: 1.5; }
        #date-display .hijri-date { font-weight: 600; color: var(--primary-color); }
        .header-right-items { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        
        .nav-wrapper { position: sticky; top: 0; z-index: 1001; background-color: var(--primary-color); }
        .nav-container-wrapper { position: relative; width: 90%; max-width: 1200px; margin: 0 auto; overflow: visible; }
        nav .nav-container { display: flex; align-items: center; flex-wrap: nowrap; overflow: visible; scrollbar-width: none; -ms-overflow-style: none; }
        nav .nav-container::-webkit-scrollbar { display: none; }
        nav a { color: #ffffff; padding: 15px 20px; text-decoration: none; font-weight: 500; transition: background-color: 0.3s; border-radius: 4px; white-space: nowrap; }
        nav a:hover, nav a.active { background-color: #1e4220; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(44, 94, 46, 0.8); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .nav-arrow.visible { opacity: 1; pointer-events: auto; }
        #nav-arrow-left { left: -15px; }
        #nav-arrow-right { right: -15px; }
        @media (max-width: 768px) { .nav-arrow { background-color: rgba(44, 94, 46, 0.5); } }

/* Tambahkan selector ini ke CSS Anda */
#pengunjung-hari-ini {
    background-color: #fef9c3; /* Warna kuning muda */
    border: 1px solid #fde047;
}
#visitor-list {
    list-style-type: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
#visitor-list li {
    background-color: var(--primary-color);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    font-weight: 500;
}

#ujianOnlineNav {
    background-color: #ff69b4; /* Warna pink */
}

.santri-hide {
    display: none !important;
}


        #attendanceNav { background-color: var(--error-color); }
        #attendanceNav:hover, #attendanceNav.active { background-color: #c82333; }
        #sistemInformasiNav { background-color: var(--info-color); }
        #sistemInformasiNav:hover, #sistemInformasiNav.active { background-color: var(--info-color-hover); }
        #userProfile { display: flex; align-items: center; gap: 15px; color: var(--dark-gray); font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 6px; transition: background-color: 0.3s; }
        #userProfile:hover { background-color: var(--light-gray); }
        #userProfileName { max-width: 150px; line-height: 1.2; text-align: left; word-break: break-word; }
        #navProfilePic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .auth-button { color: #212529; border-radius: 5px; padding: 10px 20px; font-weight: bold; border: none; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; transition: background-color: 0.3s; }
        #loginButton { background-color: var(--secondary-color); }
        #loginButton:hover { background-color: #e0a800; }
        #marquee-container { background-color: var(--secondary-color); color: var(--dark-gray); padding: 10px 0; overflow: hidden; white-space: nowrap; box-sizing: border-box; position: sticky; top: 56px; /* Adjusted height */  }
        #marquee-text-wrapper { display: inline-block; padding-left: 100%; animation: marquee 200s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .hero { position: relative; color: #ffffff; text-align: center; overflow: hidden; height: 450px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .slideshow-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1.5s ease-in-out; transform: scale(1.05); animation: kenburns 30s infinite; }
        .slide.active { opacity: 1; }
        .hero-content { position: relative; z-index: 2; background-color: rgba(0, 0, 0, 0.5); padding: 20px 40px; border-radius: 8px; }
        @keyframes kenburns { 0% { transform: scale(1.05); } 100% { transform: scale(1.2); } }
        .hero h2 { font-size: 2.5em; md:font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .hero p { font-size: 1.1em; md:font-size: 1.2em; max-width: 700px; margin: 0 auto 20px auto; }
        .hero .cta-button { background-color: var(--success-color); color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; transition: background-color: 0.3s; cursor: pointer; }
        .hero .cta-button:hover { background-color: #218838; }
        .page-section { scroll-margin-top: 120px; }
        .page-section.hidden { display: none; }
        .section { background-color: #ffffff; padding: 30px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section h2 { font-size: 2em; color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; transition: box-shadow 0.3s; display: flex; flex-direction: column; }
        .card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 20px; flex-grow: 1; }
        .card-content h3 { margin-top: 0; }
        .card-content .meta { font-size: 0.8em; color: #6c757d; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .calendar-month { background-color: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .calendar-grid .holiday { color: #dc2626; font-weight: 500; }
        .event-green { background-color: #d1fae5; }
        .event-lightblue { background-color: #dbeafe; }
        .event-darkblue { background-color: #c7d2fe; }
        .event-yellow { background-color: #fef9c3; }
        .event-orange { background-color: #ffedd5; }
        .today { position: relative; color: #ffffff !important; font-weight: 700; z-index: 1; }
        .today::before { content: ''; position: absolute; top: 50%; left: 50%; width: 2.25rem; height: 2.25rem; background-color: #2563eb; border-radius: 50%; z-index: -1; transform: translate(-50%, -50%); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { transform: translate(-50%, -50%) scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        footer { background-color: var(--dark-gray); color: var(--light-gray); padding: 40px 0; text-align: center; }
        footer p { margin: 5px 0; }
        footer a { color: var(--secondary-color); text-decoration: none; }
        .custom-form { max-width: 600px; margin: 40px auto; padding: 30px; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: #ffffff; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: background-color: 0.3s; }
        .submit-btn:hover { background: #1e4220; }
        .submit-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .password-container { position: relative; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; user-select: none; color: #6c757d; }
        .remember-me { display: flex; align-items: center; justify-content: space-between; font-size: 0.9em; }
        .remember-me label { margin: 0 0 0 8px; font-weight: normal; }
        .forgot-password { color: var(--primary-color); text-decoration: none; }
        .forgot-password:hover { text-decoration: underline; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; padding: 5px; }
        .role-selector label { flex: 1; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .role-selector input[type="radio"] { display: none; }
        .role-selector input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; font-weight: bold; }
        .profile-picture-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; }
        #profilePicturePreview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #e9ecef; }
        #profilePictureInput { display: none; }
        #uploadPictureLabel { background-color: var(--secondary-color); color: var(--dark-gray); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; animation: slideIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); } to { transform: translateY(0); } }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .download-btn { display: block; width: fit-content; margin: 10px auto 0 auto; padding: 10px 25px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.3s; }
        .download-btn:hover { background-color: #1e4220; }
        .message-box { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 3000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: top 0.5s ease-in-out; }
        .message-box.show { top: 20px; }
        .message-box.success { background-color: var(--success-color); }
        .message-box.error { background-color: var(--error-color); }
        .hidden { display: none !important; }
        
        /* GAYA UNTUK SISTEM INFORMASI (DIGABUNG) */
        .schedule-grid { display: grid; grid-template-columns: 90px repeat(6, 1fr); gap: 4px; }
        .time-slot { font-weight: 600; text-align: center; padding: 8px 4px; position: sticky; left: 0; z-index: 15; background-color: #f1f5f9; }
        .day-header { font-weight: 600; text-align: center; padding: 8px 4px; position: sticky; top: 0; /* <-- PERBAIKAN POSISI */ z-index: 10; background-color: #f1f5f9; }
        .schedule-grid > .day-header:first-child { left: 0; z-index: 20; }
        .schedule-cell { border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; min-height: 120px; transition: all 0.3s ease-in-out; background-color: white; display: flex; flex-direction: column; }
        .subject { flex-grow: 1; }
        .highlight { background-color: #f0fdfa; border-color: #14b8a6; transform: scale(1.03); z-index: 10; position: relative; animation: glow-animation 2s ease-in-out infinite; }
        .dimmed { opacity: 0.3; filter: grayscale(80%); }
        @keyframes glow-animation { 0% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); } 50% { box-shadow: 0 0 20px 5px rgba(20, 184, 166, 0.8); } 100% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); } }
        .room-rbm { background-color: #fff7ed; border-color: #fb923c; border-style: dashed; }
        .room-rbm .subject { font-style: italic; color: #c2410c; }
        .room-madinah { background-color: rgba(59, 130, 246, 0.1); border-color: #60a5fa; }
        .room-mekah { background-color: rgba(132, 204, 22, 0.1); border-color: #a3e635; }
        .arrow-icon { transition: transform 0.3s ease-in-out; }
        .rotate-180 { transform: rotate(180deg); }
        .tab-btn, .semester-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active, .semester-btn.active { background-color: #0d9488; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .filter-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2.5rem; }
        #khs-container { font-family: 'Times New Roman', Times, serif; }
        #khs-display table td, #khs-display table th { padding: 2px 4px; }
        @media print { 
            @page { size: A4 landscape; margin: 1cm; } 
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
            #filter-section, #schedule-actions, #teacher-data-container, #module-data-container, #santri-data-container, #krs-container, #khs-container, header, #tabs-container, #semester-tabs-container, #mainNav, #marquee-container, footer, .auth-section, #date-display { display: none !important; } 
            #main-content { padding: 0; margin: 0; } 
            #schedule-container { box-shadow: none; border: none; padding: 0; overflow: visible; max-height: none; } 
            .schedule-grid { font-size: 8pt; gap: 1px; border: 1px solid #ccc; } 
            .schedule-cell { min-height: auto; padding: 4px; border: 1px solid #eee; } 
            .highlight, .dimmed { transform: none; opacity: 1; filter: none; animation: none; box-shadow: none !important; } 
            .schedule-cell.highlight { border: 1px solid #14b8a6; background-color: #f0fdfa !important; } 
            .schedule-cell.dimmed { visibility: hidden !important; }
        }
        /* === PERBAIKAN TAMPILAN HEADER DI SELULER === */
@media (max-width: 768px) {
    header .header-content {
        flex-direction: column; /* Ubah dari baris menjadi kolom */
        justify-content: center; /* Pusatkan item di tengah */
        gap: 15px; /* Kurangi jarak antar elemen */
    }
    header .logo-container {
        flex-direction: column; /* Tumpuk logo dan judul secara vertikal */
        text-align: center; /* Ratakan teks judul ke tengah */
    }
    header img.logo {
        height: 50px; /* Perkecil sedikit logo */
        margin-right: 0; /* Hapus margin kanan */
        margin-bottom: 10px; /* Beri jarak bawah */
    }
    header .title-container h1 {
        font-size: 1.4em; /* Perkecil ukuran judul utama */
        line-height: 1.2;
    }
    header .title-container p {
        font-size: 0.8em; /* Perkecil ukuran sub-judul */
    }
    .header-right-items {
        flex-direction: column; /* Tumpuk tanggal dan profil secara vertikal */
        gap: 15px;
    }
    #date-display {
        text-align: center; /* Ratakan tanggal ke tengah */
    }
    #navProfilePic {
        width: 60px;  /* Perkecil foto profil */
        height: 60px; /* Perkecil foto profil */
    }
    #userProfile {
        justify-content: center; /* Pusatkan foto profil dan nama */
    }
	nav .nav-container {
        overflow-x: auto; /* Memungkinkan scroll horizontal */
		overflow-y: visible;
		padding-bottom: 8px;
        -webkit-overflow-scrolling: touch; /* Scroll lebih mulus di iOS */
        scrollbar-width: none; /* Sembunyikan scrollbar untuk Firefox */
        -ms-overflow-style: none;  /* Sembunyikan scrollbar untuk IE/Edge */
    }
    nav .nav-container::-webkit-scrollbar {
        display: none; /* Sembunyikan scrollbar untuk Chrome/Safari */
    }

    #schedule-container {
        font-size: 12px; 
    }
    /* Perkecil kolom waktu dan jarak antar sel */
    .schedule-grid {
        grid-template-columns: 60px repeat(6, 1fr); 
        gap: 2px;
    }
    /* Perkecil header hari dan waktu */
    .time-slot, .day-header {
        padding: 4px 2px;
        font-size: 10px;
    }
    /* Buat sel menjadi lebih ringkas */
    .schedule-cell {
        min-height: auto; /* Biarkan tinggi sel menyesuaikan konten */
        padding: 5px;
        border-radius: 4px;
    }

    .modal-content {
        padding: 20px; /* Kurangi padding pada layar kecil */
        margin: 10% auto; /* Beri sedikit jarak dari atas */
    }
    
    .modal-content h2 {
        font-size: 1.5em; /* Perkecil ukuran judul */
    }

    /* Atur ulang ukuran font di dalam sel agar proporsional */
    .schedule-cell .subject, .schedule-cell .subject a {
        font-size: 1em; /* 1em akan relatif terhadap 12px yang kita atur di atas */
        font-weight: 600; /* Sedikit tebalkan agar mudah dibaca */
    }
    .schedule-cell .group-display,
    .schedule-cell .teacher {
        font-size: 0.85em; /* Perkecil lagi font info grup dan guru */
        margin-top: 3px;
        line-height: 1.3;
    }
    /* Tumpuk info grup & ruang secara vertikal untuk hemat tempat */
    .schedule-cell .group-display span {
        display: block; 
        margin-left: 0 !important;
    }
    .schedule-cell .group-display .room {
        margin-left: 0 !important;
    }
}

.dropdown:hover .dropdown-content,
.dropdown:focus-within .dropdown-content {
    display: block;
}

/* === GAYA FORMULIR NEON UNTUK MUSYRIF/AH === */
.form-glow-kegiatan {
    border: 2px solid #2dd4bf; /* Neon Teal */
    box-shadow: 0 0 15px rgba(20, 184, 166, 0.6);
}

.form-glow-tahfidz {
    border: 2px solid #818cf8; /* Neon Indigo */
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
}

.form-glow-pelanggaran {
    border: 2px solid #fb7185; /* Neon Rose */
    box-shadow: 0 0 15px rgba(244, 63, 94, 0.6);
}

/* === TAMBAHKAN SEMUA GAYA DROPDOWN DI BAWAH INI === */
/* === GANTI SEMUA GAYA DROPDOWN SEBELUMNYA DENGAN BLOK INI === */

/* Wadah dropdown di dalam navigasi */
.dropdown {
    position: relative; /* Tetap relative untuk referensi awal */
    display: inline-block;
}

/* Tombol Dropdown */
.dropbtn {
    background-color: var(--info-color);
}

/* GAYA UNTUK TOMBOL YANG AKTIF (saat menu terbuka) */
.dropbtn.active {
    background-color: var(--info-color-hover);
    border-radius: 5px 5px 0 0;
}

/* Konten Dropdown (Submenu) */
.dropdown-content {
    display: none; /* Awalnya tetap disembunyikan */
    position: fixed; /* KUNCI #1: Diubah ke FIXED agar tidak terkurung */
    background-color: #f1f1f1;
    min-width: 200px; /* Atur lebar minimal submenu */
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 9999; /* KUNCI #2: Z-INDEX SUPER TINGGI untuk berada di paling atas */
    border-radius: 0 0 5px 5px;
    overflow: hidden;
}

/* Class untuk menampilkan submenu via JavaScript */
.dropdown-content-show {
    display: block;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-weight: normal;
}

.dropdown-content a:hover {
    background-color: #ddd;
}

/* Pastikan dropdown di dalam nav utama tidak merusak layout */
#mainNav .nav-container > .dropdown {
    display: flex;
    padding: 0;
}

.krs-btn-color {
    background-color: var(--primary-color) !important; /* Warna hijau tua */
}
.krs-btn-color:hover {
    background-color: #1e4220 !important;
}
.khs-btn-color {
    background-color: var(--info-color) !important; /* Warna biru info */
}
.khs-btn-color:hover {
    background-color: var(--info-color-hover) !important;
}

/* --- Tambahkan kode ini ke dalam tag <style> Anda --- */

/* Gaya untuk Kontainer Ujian */
#exam-container {
    font-family: 'Inter', sans-serif;
}

/* Gaya untuk setiap soal */
.question-block {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid #e5e7eb;
    border-left: 5px solid var(--primary-color);
    border-radius: 8px;
}

/* Gaya untuk Pilihan Jawaban */
.answer-option {
    display: block;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.answer-option:hover {
    background-color: #f9fafb;
    border-color: var(--primary-color);
}
.answer-option input[type="radio"] {
    display: none;
}
.answer-option.selected {
    background-color: #e0f2fe; /* light-blue */
    border-color: #3b82f6; /* blue */
    font-weight: 600;
    color: #1e3a8a; /* dark-blue */
}

/* Gaya untuk hasil ujian */
#result-score.pass {
    color: #16a34a; /* green */
}
#result-score.fail {
    color: #dc2626; /* red */
}

#mainNav .nav-container > .dropdown {
    /* Aturan ini memastikan DIV dropdown tidak merusak alur flex */
    display: flex;
    padding: 0;
}



    </style>
</head>
<body>
    <div id="messageBox" class="message-box"></div>

    <header>
        <div class="container header-content">
            <div class="logo-container">
                <img src="Logo_yayasan.png" alt="Logo Yayasan" class="logo" onerror="this.onerror=null;this.src='https://placehold.co/60x60/2c5e2e/ffffff?text=Y';">
                <div class="title-container">
                    <h1>Yayasan Markaz Yatim Duafa Qurani</h1>
                    <p>Berdasarkan Al-Qur'an dan Sunnah Sesuai Pemahaman Salafush Shalih</p>
                </div>
            </div>
            <div class="header-right-items">
                <div id="date-display"></div>
                <div class="auth-section">
                    <div id="userProfile" class="hidden">
                        <img id="navProfilePic" src="https://placehold.co/80x80/e9ecef/343a40?text=F" alt="Foto Profil">
                        <span id="userProfileName"></span>
                    </div>
                    <a href="#login" id="loginButton" class="auth-button">Login</a>
                </div>
            </div>
        </div>
    </header>

    <div class="nav-wrapper">
        <div class="nav-container-wrapper">
            <nav id="mainNav">
                <div class="nav-container">
                    <a href="#beranda" class="active">Beranda</a>
                    <a href="#lembaga">Lembaga</a>
                    <a href="#tentang">Tentang</a>
					<div id="sistemInformasiDropdown" class="dropdown hidden">
					<a href="#" id="sistemInformasiNav" class="dropbtn">Sistem Informasi &#9662;</a>
						<div class="dropdown-content">
						<a href="#roster-kbm" id="rosterKbmNav">Roster KBM</a>
						<a href="#krs" id="krsNav">KRS (Kartu Rencana Studi)</a>
						<a href="#khs" id="khsNav">KHS (Kartu Hasil Studi)</a>
						<a href="#slip-gaji" id="slipGajiNav">Slip Gaji</a>
						<a href="#laporan-keuangan" id="laporanKeuanganNav">Laporan Keuangan</a>
						<a href="#laporan" id="laporanNav">Laporan Tahfidz</a>
						<a href="#musyrif" id="musyrifNav">Halaman Musyrif</a>
						<a href="#musyrifah" id="musyrifahNav">Halaman Musyrifah</a>
						<a href="#input-soal" id="inputSoalNav">Input Soal Ujian</a>
						<a href="#halaman-guru" id="halamanGuruNav">Bank Soal Guru</a>
						</div>
					</div>
					<a href="#absensi" id="attendanceNav" class="hidden">Absensi</a>
					<a href="#ujian-online" id="ujianOnlineNav" class="hidden" style="background-color: #ff69b4;">Ujian Online</a>
					<a href="#penerimaan">Penerimaan</a>
                    <a href="#kegiatan">Kegiatan</a>
                    <a href="#legalitas">Legalitas</a>
                    <a href="#mitra">Mitra</a>
                </div>
            </nav>
            <div id="nav-arrow-left" class="nav-arrow"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>
            <div id="nav-arrow-right" class="nav-arrow"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></div>
        </div>
    </div>
    
	<!-- ======================================================= -->
<!-- === AWAL HALAMAN LAPORAN TAHFIDZ === -->
<!-- ======================================================= -->
<div id="laporan" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Laporan Nilai Tahfidz Santri</h2>
    <p class="mb-6 text-gray-600">Pilih tanggal untuk melihat semua laporan nilai tahfidz yang masuk.</p>
    
    <div class="form-group bg-white p-4 rounded-lg shadow-sm" style="max-width: 350px;">
        <label for="laporanTanggal" class="text-base font-semibold">Pilih Tanggal Laporan</label>
        <input type="date" id="laporanTanggal" class="mt-2">
    </div>

    <div id="laporanContainer" class="mt-8 overflow-x-auto bg-white rounded-lg shadow">
        <p class="p-8 text-center text-gray-500">Silakan pilih tanggal untuk melihat laporan.</p>
    </div>
</div>
<!-- === AKHIR HALAMAN LAPORAN TAHFIDZ === -->

<div id="slip-gaji" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Slip Gaji Karyawan</h2>
    <p class="mb-8 text-gray-600">Silakan pilih periode bulan untuk melihat rincian gaji Anda.</p>

    <div id="slipGajiFilters" class="bg-gray-100 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4 mb-8">
        <div id="employeeSelectorContainer" class="form-group hidden flex-grow">
            <label for="employeeSelect" class="font-semibold">Pilih Karyawan</label>
            <select id="employeeSelect" class="filter-select w-full mt-1"></select>
        </div>
        
        <div class="form-group flex-grow" style="min-width: 150px;">
			<label for="monthSelectNew" class="font-semibold">Pilih Bulan</label>
			<select id="monthSelectNew" class="filter-select w-full mt-1"></select>
		</div>
		<div class="form-group" style="width: 120px;">
			<label for="yearSelect" class="font-semibold">Tahun</label>
			<select id="yearSelect" class="filter-select w-full mt-1"></select>
		</div>
        
        <div class="form-group">
            <button id="showSlipGajiBtn" class="bg-teal-600 text-white py-3 px-6 rounded-md hover:bg-teal-700 w-full md:w-auto">Tampilkan</button>
        </div>
    </div>

    <div id="slipGajiContainer" class="mt-8">
        <p class="p-8 text-center text-gray-500">Silakan pilih nama (jika tersedia) dan bulan, lalu klik "Tampilkan".</p>
    </div>
	<div id="downloadSlipContainer" class="mt-6 text-center hidden">
    <button id="downloadSlipBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg">
        Unduh Slip Gaji (PDF)
    </button>
	</div>
</div>
	
    <div id="marquee-container" class="hidden">
        <div id="marquee-text-wrapper">
            <span id="marquee-text"></span>
        </div>
    </div>

    <div id="beranda" class="page-section">
        <section class="hero">
            <div id="slideshow" class="slideshow-container"></div>
            <div class="hero-content">
                <h2>Membina Generasi Qur'ani, Memuliakan Yatim & Dhuafa</h2>
                <p>Menjadi bagian dari kebaikan dengan mendukung program pendidikan penghafal Al-Qur'an dan menyantuni mereka yang membutuhkan.</p>
                <a id="donasiBtn" class="cta-button">Donasi Sekarang</a>
            </div>
        </section>
        <main class="container">
            <section id="berita" class="section">
                <h2>Berita & Pengumuman Terbaru</h2>
                <div id="news-container" class="grid-container"></div>
            </section>
            <section id="kalenderPendidikanSection" class="section hidden">
                <h2>Kalender Pendidikan Madrasah 2025/2026</h2>
                <div id="dynamic-calendar-grid" class="calendar-grid"></div>
                <footer class="text-center mt-12 text-gray-500 text-sm">
                    <p>Update terakhir kalender 08 Agustus 2025</p>
                </footer>
            </section>
<section id="pengunjung-hari-ini" class="section hidden">
    <h2>Pengguna Aktif Hari Ini</h2>
    <div id="visitor-list-container">
        <p>Memuat data...</p>
    </div>
</section>

        </main>
    </div>
    <div id="lembaga" class="page-section hidden container section"><h2>Lembaga di Bawah Naungan Kami</h2><div class="grid-container"><div class="card"><div class="card-content"><h3>Lembaga Pendidikan: Rumah Tahfidz Qur'an Markaz Qur'an Al-Maa'un</h3><p>Fokus pada pendidikan dan pembinaan generasi muda untuk menjadi penghafal Al-Qur'an yang berakhlak mulia.</p></div></div><div class="card"><div class="card-content"><h3>Lembaga Sosial: Rumah Anak Yatim Abu Darda</h3><p>Memberikan perlindungan, kasih sayang, dan pemenuhan kebutuhan hidup bagi anak-anak yatim dan dhuafa.</p></div></div></div></div>
    <div id="tentang" class="page-section hidden container section"><h2>Tentang Yayasan</h2><p><strong>Yayasan Markaz Yatim Duafa Qurani</strong> adalah organisasi nirlaba berlandaskan Al-Qur'an dan Sunnah dengan pemahaman Salafus Shalih.</p><h3>Visi & Misi</h3><p>Menjadi yayasan Islam yang unggul dan amanah dalam mencetak generasi Qur'ani serta menjadi pelopor dalam kesejahteraan sosial umat.</p></div>
    <div id="absensi" class="page-section hidden container section">
        <h2>Formulir Absensi</h2>
        <p>Silakan pilih peran Anda dan isi formulir di bawah ini.</p>
        <div class="role-selector">
            <input type="radio" id="roleGuru" name="role" value="guru" checked><label for="roleGuru">Guru</label>
            <input type="radio" id="roleStaf" name="role" value="staf"><label for="roleStaf">Staf</label>
            <input type="radio" id="roleRapat" name="role" value="rapat"><label for="roleRapat">Rapat</label>
        </div>
        <form id="attendanceFormGuru" class="custom-form">
            <div class="form-group"><label for="teacherNameDisplay">Nama Guru</label><input type="text" id="teacherNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="attendanceDateGuru">Tanggal</label><input type="date" id="attendanceDateGuru" required></div>
            <div class="form-group"><label for="className">Kelas</label><select id="className" class="w-full p-3 border border-gray-300 rounded-md" required><option value="">Pilih Kelas...</option></select></div>
            <div class="form-group"><label for="lateMinutesGuru">Menit Terlambat</label><input type="number" id="lateMinutesGuru" min="0" placeholder="Isi hanya jika terlambat"></div>
            
            <!-- FITUR GURU PENGGANTI -->
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="isSubstituteTeacher" name="isSubstitute" style="width: auto; height: 1.2em;">
                    <label for="isSubstituteTeacher" style="margin: 0; font-weight: normal;">Saya Menggantikan Guru Lain</label>
                </div>
            </div>
            <!-- PERUBAHAN: Hanya ada satu dropdown untuk nama guru -->
            <div id="substituteTeacherSection" class="form-group hidden">
                <label for="substituteTeacherName">Guru yang Digantikan</label>
                <select id="substituteTeacherName" name="substituteFor">
                    <option value="">Pilih Guru...</option>
                </select>
            </div>
            <!-- AKHIR PERUBAHAN -->

            <div class="form-group"><label for="remarksGuru">Keterangan</label><textarea id="remarksGuru" rows="3"></textarea></div>
            <button type="submit" class="submit-btn">Kirim Absensi Guru</button>
        </form>
        <form id="attendanceFormStaf" class="custom-form hidden">
            <div class="form-group"><label for="stafNameDisplay">Nama Staf</label><input type="text" id="stafNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="attendanceDateStaf">Tanggal</label><input type="date" id="attendanceDateStaf" required></div>
            <div class="form-group"><label for="jabatanStaf">Jabatan</label><input type="text" id="jabatanStaf" readonly required style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="lateMinutesStaf">Menit Izin</label><input type="number" id="lateMinutesStaf" min="0" placeholder="Isi hanya jika Izin"></div>
            <div class="form-group"><label for="remarksStaf">Keterangan</label><textarea id="remarksStaf" rows="3"></textarea></div>
            <button type="submit" class="submit-btn">Kirim Absensi Staf</button>
        </form>
        <form id="attendanceFormRapat" class="custom-form hidden">
            <div class="form-group"><label for="rapatNameDisplay">Nama</label><input type="text" id="rapatNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="rapatDate">Tanggal</label><input type="date" id="rapatDate" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="rapatStartTime">Jam Mulai</label><input type="time" id="rapatStartTime" required></div>
            <div class="form-group"><label for="rapatEndTime">Jam Selesai</label><input type="time" id="rapatEndTime" required></div>
            <div class="form-group"><label for="rapatRemarks">Keterangan Rapat</label><textarea id="rapatRemarks" rows="3" required></textarea></div>
            <button type="submit" class="submit-btn">Kirim Absensi Rapat</button>
        </form>
		
			<div id="attendanceHistorySection" class="mt-12 pt-8 border-t-2 border-gray-200">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Riwayat Absensi Anda (30 Hari Terakhir)</h2>
		<div id="historyContainer" class="overflow-x-auto bg-white rounded-lg shadow">
			<p class="p-6 text-center text-gray-500">Memuat riwayat absensi...</p>
		</div>
	</div>
		
    </div>
    

	
    <!-- KONTEN UNTUK SISTEM INFORMASI -->
    <div id="roster-kbm" class="page-section hidden">
        <div id="page-wrapper" class="relative min-h-screen">
            <main id="main-content" class="flex-1 p-4 md:p-6 lg:p-8">
                <header class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Roster KBM Dinamis</h1>
                    <h2 class="text-xl md:text-2xl font-semibold text-teal-700">Markaz Qur'an Al-Maa'un</h2>
                </header>

                <div id="filter-section" class="bg-white p-3 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 items-center">
                        <select id="filter-group" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Kelompok</option>
                            <option value="KF">Kelas Fondasi</option>
                            <option value="KG">Kelas Gabungan</option>
                        </select>
                        <select id="filter-cluster" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md" disabled>
                            <option value="all">Semua Klaster</option>
                            <option value="LKS">Literasi & Kreatif Syariah</option>
                            <option value="STT">Sains & Teknologi Terapan</option>
                        </select>
                        <select id="filter-teacher" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Guru</option>
                        </select>
                        <select id="filter-room" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Ruang</option>
                            <option value="Kelas Mekah">Kelas Mekah</option>
                            <option value="Kelas Madinah">Kelas Madinah</option>
                            <option value="RBM">RBM</option>
                        </select>
                        <button id="reset-filters" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition text-sm">Reset Filter</button>
                    </div>
                </div>

                <div id="semester-tabs-container" class="mb-2 flex space-x-2">
                    <button id="semester-ganjil-btn" class="semester-btn flex-1 p-2 rounded-md font-semibold active">Semester Ganjil</button>
                    <button id="semester-genap-btn" class="semester-btn flex-1 p-2 rounded-md font-semibold">Semester Genap</button>
                </div>

                <div id="ganjil-tabs">
                    <div id="tabs-container" class="mb-4 bg-slate-200 p-1 rounded-lg flex space-x-1">
                        <button id="tab-bulan1" class="tab-btn flex-1 p-2 rounded-md font-semibold active">Bulan I</button>
                        <button id="tab-bulan2" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan II</button>
                        <button id="tab-bulan3" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan III</button>
                        <button id="tab-bulan4" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan IV</button>
                    </div>
                </div>
                <div id="genap-tabs" class="hidden">
                     <div id="tabs-container-genap" class="mb-4 bg-slate-200 p-1 rounded-lg flex space-x-1">
                        <button id="tab-bulan5" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan V</button>
                        <button id="tab-bulan6" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan VI</button>
                        <button id="tab-bulan7" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan VII</button>
                        <button id="tab-bulan8" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan VIII</button>
                    </div>
                </div>

                <div id="schedule-container" class="bg-white p-2 rounded-xl shadow-lg overflow-auto max-h-[80vh]"></div>
                
                <div id="schedule-actions" class="flex justify-center gap-4 mt-6">
                    <button id="reset-schedule" class="flex items-center gap-2 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg> Reset Jadwal</button>
                    <button id="print-schedule" class="flex items-center gap-2 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg> Cetak</button>
                    <button id="download-schedule-pdf" class="flex items-center gap-2 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Unduh Jadwal (PDF)</button>
                </div>
                
                <div id="teacher-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Data Guru</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="teacher-table" class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Guru</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bidang / Jurusan</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hari</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jadwal (Slot Waktu)</th></tr></thead><tbody class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>
                <div id="module-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Perpustakaan Modul</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="module-table" class="min-w-full"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" colspan="7">Guru & Modul</th></tr></thead><tbody class="bg-white"></tbody></table></div></div></div>
                <div id="santri-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Data Santri</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="santri-table" class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jenis Kelamin</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelompok</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelas</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jurusan</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="santri-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>

            </main>
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100"><svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">Konfirmasi</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500" id="modal-message">Apakah Anda yakin?</p></div><div class="items-center px-4 py-3"><button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Ya, Lanjutkan</button><button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Batal</button></div></div></div></div>
        </div>
    </div>
<div id="santri" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Informasi Santri</h2>
    <p class="mb-8 text-gray-600">Silakan pilih bulan untuk melihat Kartu Rencana Studi (KRS) atau Kartu Hasil Studi (KHS).</p>

    <div id="santri-selection-container" class="bg-gray-50 p-6 rounded-lg shadow-md mb-8 max-w-lg mx-auto hidden">
        <div class="space-y-2 mb-6">
            <div class="flex">
                <span class="w-28 font-semibold text-gray-700">Nama Santri</span>
                <span id="santri-selector-name" class="font-bold text-gray-900">: </span>
            </div>
            <div class="flex">
                <span class="w-28 font-semibold text-gray-700">Kelompok</span>
                <span id="santri-selector-group" class="font-bold text-gray-900">: </span>
            </div>
        </div>
        <div class="form-group">
            <label for="santri-month-selector" class="font-semibold text-gray-700">Pilih Bulan</label>
            <select id="santri-month-selector" class="filter-select w-full mt-1">
                </select>
        </div>
        <div class="form-group mt-6">
            <button id="show-report-btn" class="submit-btn w-full">Tampilkan</button>
        </div>
    </div>

    <div id="krs-container" class="mt-8 mb-8 p-4 sm:p-6 rounded-xl shadow-lg bg-gray-50 hidden">
        <div id="krs-display" class="mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8" style="width: 210mm;">
            <header class="text-center border-b-2 border-gray-200 pb-4 mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">KARTU RENCANA STUDI (KRS)</h1>
                <h2 class="text-lg md:text-xl font-semibold text-gray-700 mt-1">Markaz Qur'an Al-Maa'un</h2>
                <p class="text-md text-gray-600">Semester Ganjil</p>
            </header>
            <section id="info-santri-krs" class="mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-700">
                    <div class="flex"><span class="w-36 font-semibold">Nama Santri</span><span id="nama-santri-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Total SKS yang bisa diambil</span><span id="total-sks-ambil-krs">: 40 sks</span></div>
                    <div class="flex"><span class="w-36 font-semibold">Jurusan</span><span id="jurusan-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Kelas</span><span id="kelas-krs">: </span></div>
                    <div class="flex"><span class="w-36 font-semibold">Kelompok</span><span id="kelompok-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Materi untuk Bulan ke</span><span id="materi-bulan-krs">: </span></div>
                </div>
            </section>
            <section>
                <div class="overflow-x-auto">
                    <table id="tabel-krs" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">Hari</th>
                                <th scope="col" class="px-4 py-3">Waktu</th>
                                <th scope="col" class="px-4 py-3">Kode</th>
                                <th scope="col" class="px-4 py-3">Mata Pelajaran / Modul</th>
                                <th scope="col" class="px-4 py-3">Ruang</th>
                                <th scope="col" class="px-4 py-3 text-center">SKS</th>
                                <th scope="col" class="px-4 py-3">Guru</th>
                                <th scope="col" class="px-4 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="krs-table-body"></tbody>
                        <tfoot>
                            <tr class="font-semibold text-gray-900 bg-gray-100">
                                <td colspan="5" class="px-4 py-3 text-right">Total SKS yang Diambil</td>
                                <td id="total-sks-diambil" class="px-4 py-3 text-center">0</td>
                                <td colspan="2" class="px-4 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </div>
        <div class="mt-8 text-center flex justify-center items-center gap-4">
            <button id="add-krs-row" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-opacity-50">+ Tambah Baris</button>
            <button id="download-krs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 inline-flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh PDF</span></button>
            <button id="close-krs-btn-bottom" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Tutup</button>
        </div>
    </div>
    
    <div id="khs-container" class="mt-8 mb-8 p-4 sm:p-6 rounded-xl shadow-lg bg-gray-50 hidden">
        <div id="khs-display" class="mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8" style="width: 210mm;"></div>
        <div class="mt-8 text-center flex justify-center items-center gap-4">
            <button id="download-khs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 inline-flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh PDF</span></button>
            <button id="close-khs-btn-bottom" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Tutup</button>
        </div>
    </div>
</div>
    <div id="penerimaan" class="page-section hidden container section"><h2>Informasi Penerimaan</h2><p>Informasi penerimaan santri baru akan diumumkan di sini.</p></div>
    <div id="kegiatan" class="page-section hidden container section"><h2>Galeri Kegiatan</h2><div id="gallery-container" class="grid-container"></div></div>
    <div id="legalitas" class="page-section hidden container section"><h2>Akreditas & Legalitas</h2><ul><li><strong>Akta Notaris:</strong> Nomor 12 Tgl 10 Feb 2022</li><li><strong>SK Kemenkumham:</strong> AHU-0004281.AH.01.04.Tahun 2022</li><li><strong>NPWP:</strong> 63.382.276.2-115.000</li></ul></div>
    <div id="mitra" class="page-section hidden container section"><h2>Mitra Kebaikan</h2><p>Kami bekerja sama dengan berbagai pihak, termasuk <strong>Yayasan Sahabat Yatim Indonesia</strong>.</p></div>
	
	
	<div id="laporan-keuangan" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Laporan Keuangan</h2>

    <div id="keuangan-form-container" class="hidden mb-12">
        
<h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Input Transaksi Keuangan</h3>
<div class="bg-gray-50 p-6 rounded-lg">
    
    <<div class="form-group max-w-sm">
    <label for="tanggalKeuangan">Pilih Tanggal Transaksi</label>
    <div class="flex items-center gap-2 mt-1">
        <input type="date" id="tanggalKeuangan" class="flex-grow">
        <button type="button" id="setTanggalDefaultBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg text-sm">Set</button>
    </div>
</div>

    <!-- Langkah 2: Tabel Input (Awalnya Tersembunyi) -->
    <div id="keuangan-input-table-container" class="hidden mt-6">
        <div class="overflow-x-auto">
            <table class="min-w-full border">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2 border text-left">Keterangan</th>
                        <th class="px-4 py-2 border text-left w-48">Masuk (Rp)</th>
                        <th class="px-4 py-2 border text-left w-48">Keluar (Rp)</th>
                        <th class="px-4 py-2 border text-left w-64">Kelompok</th>
                        <th class="px-4 py-2 border w-16"></th>
                    </tr>
                </thead>
                <tbody id="keuangan-input-tbody">
                    <!-- Baris input akan ditambahkan oleh JavaScript di sini -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-between items-center mt-4">
            <button type="button" id="addKeuanganRowBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Baris</button>
            <button type="button" id="saveKeuanganBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Simpan Semua</button>
        </div>
    </div>
</div>
<!-- === SAMPAI DI SINI === -->
    </div>
<div id="daily-transaction-container" class="mt-8"></div>
    <div>
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Lihat Laporan Bulanan</h3>
        <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4 mb-8">
            <div class="form-group flex-grow" style="min-width: 150px;">
                <label for="laporanBulan" class="font-semibold">Pilih Bulan</label>
                <select id="laporanBulan" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group" style="width: 120px;">
                <label for="laporanTahun" class="font-semibold">Tahun</label>
                <select id="laporanTahun" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group">
                <button id="tampilkanLaporanKeuanganBtn" class="bg-teal-600 text-white py-3 px-6 rounded-md hover:bg-teal-700 w-full md:w-auto">Tampilkan</button>
            </div>
        </div>

        <div id="keuangan-report-container" class="mt-8">
            <p class="p-8 text-center text-gray-500">Silakan pilih bulan dan tahun, lalu klik "Tampilkan".</p>
        </div>
		

<div id="yearly-summary-container" class="mt-8">
    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Ringkasan Tahunan</h3>

    <div class="flex justify-end gap-2 mb-4">
        <button id="shareYearlySummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Bagikan</button>
        <button id="downloadYearlySummaryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Unduh</button>
    </div>

    <div id="printable-summary" class="p-4 bg-white rounded-lg border">
        <div id="group-totals-container" class="mb-6"></div>

        <div class="mb-4 flex justify-center gap-4 text-sm" id="chart-options">
            <label><input type="radio" name="chartType" value="income_expense" checked> Dana Masuk vs Keluar</label>
            <label><input type="radio" name="chartType" value="income_groups"> Kelompok Dana Masuk</label>
            <label><input type="radio" name="chartType" value="expense_groups"> Kelompok Dana Keluar</label>
        </div>

        <div id="keuangan-chart-container" style="height: 350px;">
            <canvas id="keuanganChart"></canvas>
        </div>
    </div>
</div>
    </div>

</div>
	<!-- ======================================================= -->
<!-- === AWAL HALAMAN MUSYRIF === -->
<!-- ======================================================= -->
<div id="musyrif" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-teal-800">Laporan Harian Musyrif</h2>
    <p class="mb-8 text-gray-600">Silakan isi formulir di bawah untuk mencatat aktivitas santri binaan.</p>

    <!-- FORM KEGIATAN HARIAN -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-kegiatan">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Laporan Kegiatan Harian Santri</h3>
        <form id="formKegiatanMusyrif" class="custom-form p-0 shadow-none max-w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group"><label for="santriKegiatanMusyrif">Nama Santri</label><select id="santriKegiatanMusyrif" required></select></div>
                <div class="form-group"><label for="tanggalKegiatanMusyrif">Tanggal</label><input type="date" id="tanggalKegiatanMusyrif" readonly style="background-color: #e9ecef;"></div>
            </div>
            <div class="form-group">
                <label>Status Pelaksanaan</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrif" value="Sudah dilaksanakan semua" checked class="mr-2"> Sudah dilaksanakan semua</label>
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrif" value="Ada yang tidak dikerjakan" class="mr-2"> Ada yang tidak dikerjakan</label>
                </div>
            </div>
            <div id="keteranganKegiatanMusyrifContainer" class="form-group hidden">
                <label for="keteranganKegiatanMusyrif">Masukkan yang tidak dikerjakan</label>
                <textarea id="keteranganKegiatanMusyrif" rows="3"></textarea>
            </div>
            <button type="submit" class="submit-btn">Simpan Laporan Kegiatan</button>
        </form>
    </div>

    <!-- FORM NILAI TAHFIDZ -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-tahfidz">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Laporan Nilai Tahfidz</h3>
        <form id="formTahfidzMusyrif" class="custom-form p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><label for="santriTahfidzMusyrif">Nama Santri</label><select id="santriTahfidzMusyrif" required></select></div>
                 <div class="form-group"><label for="tanggalTahfidzMusyrif">Tanggal</label><input type="date" id="tanggalTahfidzMusyrif" readonly style="background-color: #e9ecef;"></div>
             </div>
             <!-- GANTI BLOK LAMA DENGAN YANG BARU INI -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
    <!-- Ziyadah P -->
    <div class="form-group md:col-span-2"><label>Ziyadah (P) - Surat & Ayat</label><input type="text" id="ziyadahPTextMusyrif" placeholder="Cth: Al-Baqarah 1-5"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="ziyadahPoinMusyrif" placeholder="Cth: 7"></div>
    <!-- Ziyadah S -->
    <div class="form-group md:col-span-2"><label>Ziyadah (S) - Surat & Ayat</label><input type="text" id="ziyadahSTextMusyrif" placeholder="Cth: An-Nisa 10-15"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="ziyadahSoinMusyrif" placeholder="Cth: 8"></div>
    <!-- Muraja'ah -->
    <div class="form-group md:col-span-2"><label>Muraja'ah - Surat/Juz</label><input type="text" id="murajaahTextMusyrif" placeholder="Cth: Juz 30"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="murajaahPoinMusyrif" placeholder="Cth: 9"></div>
</div>
            <button type="submit" class="submit-btn">Simpan Nilai Tahfidz</button>
        </form>
    </div>

    <!-- FORM PELANGGARAN -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-pelanggaran">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Laporan Pelanggaran Santri</h3>
        <form id="formPelanggaranMusyrif" class="custom-form p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><label for="santriPelanggaranMusyrif">Nama Santri</label><select id="santriPelanggaranMusyrif" required></select></div>
                 <div class="form-group"><label for="tanggalPelanggaranMusyrif">Tanggal</label><input type="date" id="tanggalPelanggaranMusyrif" readonly style="background-color: #e9ecef;"></div>
             </div>
             <div class="form-group"><label for="isiPelanggaranMusyrif">Masukkan Pelanggaran</label><textarea id="isiPelanggaranMusyrif" rows="3" required></textarea></div>
             <div class="form-group"><label for="solusiPelanggaranMusyrif">Masukkan Solusi</label><textarea id="solusiPelanggaranMusyrif" rows="3" required></textarea></div>
            <button type="submit" class="submit-btn">Simpan Laporan Pelanggaran</button>
        </form>
    </div>

    <!-- AREA TAMPILAN LAPORAN HARI INI -->
     <div id="dailyReportContainerMusyrif" class="mt-12 pt-8 border-t-2 border-gray-200">
         <h2 class="text-2xl font-semibold text-gray-700 mb-4">Laporan Masuk Hari Ini</h2>
         <div id="reportTableMusyrif" class="overflow-x-auto bg-white rounded-lg shadow">
             <p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>
         </div>
     </div>
</div>
<!-- === AKHIR HALAMAN MUSYRIF === -->


<!-- ======================================================= -->
<!-- === AWAL HALAMAN MUSYRIFAH === -->
<!-- ======================================================= -->
<div id="musyrifah" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-purple-800">Laporan Harian Musyrifah</h2>
    <p class="mb-8 text-gray-600">Silakan isi formulir di bawah untuk mencatat aktivitas santri binaan.</p>

    <!-- FORM KEGIATAN HARIAN -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-kegiatan">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Laporan Kegiatan Harian Santri</h3>
        <form id="formKegiatanMusyrifah" class="custom-form p-0 shadow-none max-w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group"><label for="santriKegiatanMusyrifah">Nama Santri</label><select id="santriKegiatanMusyrifah" required></select></div>
                <div class="form-group"><label for="tanggalKegiatanMusyrifah">Tanggal</label><input type="date" id="tanggalKegiatanMusyrifah" readonly style="background-color: #e9ecef;"></div>
            </div>
            <div class="form-group">
                <label>Status Pelaksanaan</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrifah" value="Sudah dilaksanakan semua" checked class="mr-2"> Sudah dilaksanakan semua</label>
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrifah" value="Ada yang tidak dikerjakan" class="mr-2"> Ada yang tidak dikerjakan</label>
                </div>
            </div>
            <div id="keteranganKegiatanMusyrifahContainer" class="form-group hidden">
                <label for="keteranganKegiatanMusyrifah">Masukkan yang tidak dikerjakan</label>
                <textarea id="keteranganKegiatanMusyrifah" rows="3"></textarea>
            </div>
            <button type="submit" class="submit-btn">Simpan Laporan Kegiatan</button>
        </form>
    </div>

    <!-- FORM NILAI TAHFIDZ -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-tahfidz">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Laporan Nilai Tahfidz</h3>
        <form id="formTahfidzMusyrifah" class="custom-form p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><label for="santriTahfidzMusyrifah">Nama Santri</label><select id="santriTahfidzMusyrifah" required></select></div>
                 <div class="form-group"><label for="tanggalTahfidzMusyrifah">Tanggal</label><input type="date" id="tanggalTahfidzMusyrifah" readonly style="background-color: #e9ecef;"></div>
             </div>
             <!-- GANTI BLOK LAMA DENGAN YANG BARU INI (UNTUK MUSYRIFAH) -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4">
    <!-- Ziyadah P -->
    <div class="form-group md:col-span-2"><label>Ziyadah (P) - Surat & Ayat</label><input type="text" id="ziyadahPTextMusyrifah" placeholder="Cth: Al-Baqarah 1-5"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="ziyadahPoinMusyrifah" placeholder="Cth: 7"></div>
    <!-- Ziyadah S -->
    <div class="form-group md:col-span-2"><label>Ziyadah (S) - Surat & Ayat</label><input type="text" id="ziyadahSTextMusyrifah" placeholder="Cth: An-Nisa 10-15"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="ziyadahSoinMusyrifah" placeholder="Cth: 8"></div>
    <!-- Muraja'ah -->
    <div class="form-group md:col-span-2"><label>Muraja'ah - Surat/Juz</label><input type="text" id="murajaahTextMusyrifah" placeholder="Cth: Juz 30"></div>
    <div class="form-group"><label>Poin</label><input type="text" id="murajaahPoinMusyrifah" placeholder="Cth: 9"></div>
</div>
            <button type="submit" class="submit-btn">Simpan Nilai Tahfidz</button>
        </form>
    </div>

    <!-- FORM PELANGGARAN -->
    <div class="bg-white p-6 rounded-xl shadow-md mb-8 form-glow-pelanggaran">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Laporan Pelanggaran Santri</h3>
        <form id="formPelanggaranMusyrifah" class="custom-form p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><label for="santriPelanggaranMusyrifah">Nama Santri</label><select id="santriPelanggaranMusyrifah" required></select></div>
                 <div class="form-group"><label for="tanggalPelanggaranMusyrifah">Tanggal</label><input type="date" id="tanggalPelanggaranMusyrifah" readonly style="background-color: #e9ecef;"></div>
             </div>
             <div class="form-group"><label for="isiPelanggaranMusyrifah">Masukkan Pelanggaran</label><textarea id="isiPelanggaranMusyrifah" rows="3" required></textarea></div>
             <div class="form-group"><label for="solusiPelanggaranMusyrifah">Masukkan Solusi</label><textarea id="solusiPelanggaranMusyrifah" rows="3" required></textarea></div>
            <button type="submit" class="submit-btn">Simpan Laporan Pelanggaran</button>
        </form>
    </div>
    
    <!-- AREA TAMPILAN LAPORAN HARI INI -->
     <div id="dailyReportContainerMusyrifah" class="mt-12 pt-8 border-t-2 border-gray-200">
         <h2 class="text-2xl font-semibold text-gray-700 mb-4">Laporan Masuk Hari Ini</h2>
         <div id="reportTableMusyrifah" class="overflow-x-auto bg-white rounded-lg shadow">
             <p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>
         </div>
     </div>
</div>
<!-- === AKHIR HALAMAN MUSYRIFAH === -->
<<div id="ujian-online" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Jadwal Ujian Online</h2>
    <p class="mb-8 text-gray-600">Silakan pilih mata pelajaran di bawah ini untuk memulai ujian. Pastikan Anda sudah siap sebelum memulai.</p>
    
    <div id="ujian-schedule-container" class="bg-white p-2 rounded-xl shadow-lg overflow-auto max-h-[80vh]">
        </div>
</div>

<div id="input-soal" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Input Bank Soal Ujian</h2>
    <p class="mb-8 text-gray-600">Halaman ini khusus untuk mengelola bank soal. Soal akan disimpan di Google Sheet "soal".</p>

    <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="form-group max-w-md mb-6">
            <label for="materi-soal-select" class="text-base font-semibold">1. Pilih Materi Ujian</label>
            <select id="materi-soal-select" class="filter-select w-full mt-2">
                <option value="">Pilih Materi...</option>
                </select>
        </div>

        <div class="form-group mb-6">
            <label for="paste-soal-area" class="text-base font-semibold">2. Salin dan Tempel Soal dari MS. Word</label>
            <p class="text-sm text-gray-500 mb-2">Pastikan setiap soal diawali dengan angka dan titik (contoh: 1. Soal pertama). Web akan otomatis memisahkannya.</p>
            <textarea id="paste-soal-area" rows="10" class="w-full p-3 border border-gray-300 rounded-md" placeholder="Contoh:
1. Apa ibu kota Indonesia?
a. Bandung
b. Surabaya
c. Jakarta
d. Medan

2. Siapa presiden pertama Indonesia?
a. Soeharto
b. Soekarno
..."></textarea>
        </div>

        <div class="form-group">
            <h3 class="text-base font-semibold mb-2">3. Pratinjau, Isi Kunci Jawaban, dan Simpan</h3>
            <div id="soal-preview-container" class="border rounded-lg overflow-hidden">
                <p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini setelah Anda mem-paste teks di atas.</p>
                </div>
        </div>
        
        <div class="mt-8 text-right">
            <button id="simpan-soal-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg hidden">
                Simpan Semua Soal
            </button>
        </div>
    </div>
</div>

<div id="halaman-guru" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Bank Soal Anda</h2>
    <p class="mb-8 text-gray-600">Di halaman ini, Anda dapat melihat dan melengkapi kunci jawaban serta poin untuk soal-soal dari materi yang Anda ajar.</p>

    <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="form-group max-w-md mb-6">
            <label for="guru-materi-select" class="text-base font-semibold">Pilih Materi Ujian</label>
            <select id="guru-materi-select" class="filter-select w-full mt-2">
                <option value="all">Tampilkan Semua Materi</option>
                </select>
        </div>
        
        <div id="guru-soal-container" class="border rounded-lg overflow-hidden">
            <p class="p-8 text-center text-gray-400">Pilih materi untuk menampilkan soal.</p>
        </div>
        
        <div class="mt-8 text-right">
            <button id="update-soal-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg hidden">
                Simpan Perubahan
            </button>
        </div>
    </div>
</div>

<div id="exam-warning-modal" class="modal">
    <div class="modal-content text-center">
        <h2 class="text-2xl font-bold text-yellow-600 mb-4">Konfirmasi Memulai Ujian</h2>
        <p id="exam-warning-subject" class="text-gray-700 text-lg mb-2">Anda akan memulai ujian untuk mata pelajaran:</p>
        <p id="exam-subject-title" class="font-bold text-xl text-gray-800 mb-6"></p>
        <p class="text-gray-600 mb-6">Pastikan Anda berada di tempat yang kondusif. Halaman akan memasuki mode layar penuh dan waktu akan dihitung saat Anda menekan tombol "Mulai".</p>
        <div class="flex justify-center gap-4">
            <button id="start-exam-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">Mulai</button>
            <button id="cancel-exam-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">Batal</button>
        </div>
    </div>
</div>

<div id="exam-container" class="fixed top-0 left-0 w-full h-full bg-gray-100 z-[5000] p-8 overflow-y-auto hidden">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-2xl">
        <div id="exam-header" class="border-b pb-4 mb-6">
            <h1 id="exam-title" class="text-3xl font-bold text-gray-800">Ujian Online</h1>
            <p id="exam-subtitle" class="text-lg text-gray-600"></p>
        </div>
        <div id="exam-questions">
            </div>
        <div id="exam-footer" class="mt-8 pt-4 border-t">
            <button id="submit-exam-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg text-xl">Selesai & Kirim Jawaban</button>
        </div>
    </div>
</div>

<div id="exam-result-modal" class="modal">
    <div class="modal-content text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4">Hasil Ujian Anda</h2>
        <p id="result-score" class="text-8xl font-bold my-8"></p>
        <p id="result-message" class="text-lg text-gray-700 mb-8"></p>
        <div id="result-actions">
            </div>
    </div>
</div>
	
    <div id="login" class="page-section hidden container"><form id="loginForm" class="custom-form"><h2 style="text-align: center;">Login Pengurus / Staf</h2><div class="form-group"><label for="username">Username</label><input type="text" id="username" name="username" autocomplete="username" required></div><div class="form-group password-container"><label for="password">Password</label><input type="password" id="password" name="password" required><span class="toggle-password"></span></div><div class="form-group remember-me"><div><input type="checkbox" id="remember" name="remember"><label for="remember">Ingat saya selama 30 hari</label></div><a href="#" id="forgotPasswordLink" class="forgot-password">Lupa Sandi?</a></div><button type="submit" class="submit-btn">Masuk</button></form></div>
    <div id="donasiModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Tata Cara Donasi</h2><p>Silakan transfer ke <strong>Bank BRI: 7040-0102-7168535</strong> a/n Markaz Yatim Duafa Qurani.</p><p style="text-align:center; margin-top:1rem;">Atau scan QRIS:</p><img src="qrisdonasi.png" alt="QRIS Donasi" style="width:250px;display:block;margin:15px auto;border-radius:8px;" onerror="this.onerror=null;this.src='https://placehold.co/250x250/cccccc/FFFFFF?text=QRIS+Error';"><a href="qrisdonasi.png" class="download-btn" download="qrisdonasi.png">Unduh QRIS</a><p>Konfirmasi ke <strong>085261804096</strong>.</p></div></div>
    <div id="profileModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Profil Saya</h2><form id="profileForm"><div class="profile-picture-container"><img id="profilePicturePreview" src="https://placehold.co/128x128/e9ecef/343a40?text=Foto" alt="Foto Profil"><input type="file" id="profilePictureInput" accept="image/*"><label for="profilePictureInput" id="uploadPictureLabel">Ganti Foto</label></div><div class="form-group"><label for="profileName">Nama Profil</label><input type="text" id="profileName" required></div><div class="form-group"><label for="profileDob">Tanggal Lahir</label><input type="date" id="profileDob"></div><div class="form-group"><label for="profileAddress">Alamat</label><textarea id="profileAddress" rows="3"></textarea></div><div class="form-group"><label for="profileJabatan">Jabatan</label><input type="text" id="profileJabatan"></div><div class="form-group"><label for="profileUsername">Username</label><input type="text" id="profileUsername" required readonly style="background-color:#e9ecef;cursor:not-allowed;"></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="submit" class="submit-btn" style="flex:1;">Simpan</button><button type="button" id="changePasswordFromProfile" class="auth-button" style="flex:1;background-color:var(--secondary-color);">Ganti Sandi</button><button type="button" id="logoutFromProfile" class="auth-button" style="flex:1;background-color:var(--error-color);color:white;">Logout</button></div></form></div></div>
    <div id="changePasswordModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Ganti Kata Sandi</h2><form id="changePasswordForm"><div class="form-group password-container"><label for="currentPassword">Sandi Saat Ini</label><input type="password" id="currentPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="newPassword">Sandi Baru</label><input type="password" id="newPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="confirmNewPassword">Konfirmasi Sandi Baru</label><input type="password" id="confirmNewPassword" required><span class="toggle-password"></span></div><button type="submit" class="submit-btn">Simpan</button></form></div></div>
    <div id="forgotPasswordModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><div id="forgotPasswordStep1"><h2>Lupa Kata Sandi</h2><form id="forgotPasswordVerifyForm"><div class="form-group"><label for="forgotUsername">Username</label><input type="text" id="forgotUsername" required></div><div class="form-group"><label for="forgotDob">Tanggal Lahir</label><input type="date" id="forgotDob" required></div><button type="submit" class="submit-btn">Verifikasi</button></form></div><div id="forgotPasswordStep2" class="hidden"><h2>Atur Ulang Sandi</h2><form id="forgotPasswordResetForm"><div class="form-group password-container"><label for="forgotNewPassword">Sandi Baru</label><input type="password" id="forgotNewPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="forgotConfirmPassword">Konfirmasi Sandi Baru</label><input type="password"id="forgotConfirmPassword" required><span class="toggle-password"></span></div><button type="submit" class="submit-btn">Simpan</button></form></div></div></div>
    <div id="announcementPopup" class="modal">
    <div class="modal-content text-center">
        <span id="closePopupBtn" class="close-button">&times;</span>
        <h2 class="text-2xl font-bold text-green-700 mb-4">Pemberitahuan Penting</h2>
        <img src="warning.png" alt="Pengumuman" class="mx-auto mb-4 rounded-lg" style="max-height: 200px;">
        <p class="text-gray-700 mb-6">
            update terbaru :
        </p>
		<ul class="list-disc list-inside text-gray-700 text-left space-y-2 mb-6">
            <li>Login akun santri</li>
            <li>Pengelompokan beberapa menu ke dalam menu Sistem Informasi</li>
            <li>Input soal untuk TU (Tata Usaha)</li>
            <li>Akses bank soal untuk Guru</li>
            <li>KRS dan KHS untuk Santri</li>
            <li>Ujian online untuk Santri</li>
        </ul>
        <button id="understandPopupBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
            Saya Mengerti
        </button>
    </div>
</div>
	<footer><div class="container"><p>&copy; 2025 Yayasan Markaz Yatim Duafa Qurani. Semua Hak Cipta Dilindungi.</p><p>Jl. Protokol Desa Sei Kamah II, Sei Dadap, Asahan, Sumut | <a href="mailto:markazyatimduafaqurani@gmail.com">markazyatimduafaqurani@gmail.com</a> | 085261804096</p></div></footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- BAGIAN 1: KONFIGURASI & DATA UTAMA ---
    const CONFIG = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec",
        CLOUDINARY_URL: "https://api.cloudinary.com/v1_1/deva5eknr/image/upload",
        CLOUDINARY_UPLOAD_PRESET: "markaz",
        ICONS: {
            eye: `<svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            eyeOff: `<svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`
        }
    };

    const appData = {
        heroImages: ["anakdidik.jpg", "anakdidik01.jpg", "anakdidik02.jpg", "anakdidik03.jpg", "anakdidik04.jpg"],
        news: [{ img: 'https://placehold.co/400x200/28a745/FFFFFF?text=Penerimaan+Santri', title: 'Penerimaan Santri Baru Telah Dibuka!', meta: '30 Juli 2025 | Pendidikan', desc: 'Pendaftaran santri baru untuk program Tahfidz di Markaz Qur\'an Al-Maa\'un telah resmi dibuka.' }, { img: 'https://placehold.co/400x200/17a2b8/FFFFFF?text=Santunan+Yatim', title: 'Santunan Rutin Anak Yatim', meta: '25 Juli 2025 | Sosial', desc: 'Kegiatan santunan bulanan untuk anak-anak yatim binaan Rumah Anak Yatim Abu Darda.' }, { img: 'https://placehold.co/400x200/ffc107/FFFFFF?text=Kajian+Umum', title: 'Kajian Umum Bulanan', meta: '22 Juli 2025 | Dakwah', desc: 'Yayasan akan mengadakan kajian umum terbuka untuk masyarakat. Informasi lokasi akan diumumkan segera.' }],
        gallery: [{ img: 'https://placehold.co/400x250/6f42c1/FFFFFF?text=Halaqah+Tahfidz', title: 'Halaqah Tahfidz Pagi', desc: 'Para santri sedang menyetorkan hafalan Al-Qur\'an kepada Musyrif.' }, { img: 'https://placehold.co/400x250/fd7e14/FFFFFF?text=Buka+Puasa+Bersama', title: 'Buka Puasa Bersama', desc: 'Kegiatan buka puasa bersama anak-anak yatim dan dhuafa di bulan Ramadhan.' }, { img: 'https://placehold.co/400x250/20c997/FFFFFF?text=Penyaluran+Bantuan', title: 'Penyaluran Bantuan', desc: 'Distribusi bantuan sembako dari para donatur kepada masyarakat sekitar.' }],
        calendarEvents: [ { date: "2025-07-14", title: "Pengenalan Lingkungan Madrasah", color: "event-green", span: 3 }, { date: "2025-08-11", title: "Ujian Bulanan", color: "event-darkblue", span: 6 }, { date: "2025-08-17", title: "Hari Kemerdekaan RI", color: "holiday" }, { date: "2025-08-18", title: "Libur Nasional", color: "holiday" }, { date: "2025-09-05", title: "Maulid Nabi Muhammad SAW", color: "holiday" }, { date: "2025-12-01", title: "Penilaian Akhir Semester (PAS)", color: "event-lightblue", span: 12 }, { date: "2025-12-13", title: "Penerimaan Rapor", color: "event-darkblue" }, { date: "2025-12-15", title: "Libur Akhir Semester", color: "event-orange", span: 17 }, { date: "2026-01-01", title: "Tahun Baru Masehi 2026", color: "holiday" }, { date: "2026-01-05", title: "Awal Masuk Semester Genap", color: "" }, { date: "2026-01-26", title: "Isra Mi'raj Nabi Muhammad SAW", color: "holiday" }, { date: "2026-02-23", title: "Perkiraan Libur Awal Ramadan", color: "event-yellow", span: 3 }, { date: "2026-02-26", title: "Awal Puasa Ramadan 1447 H", color: "holiday" }, { date: "2026-03-20", title: "Perkiraan Libur Idul Fitri", color: "event-yellow", span: 12 }, { date: "2026-03-28", title: "Hari Raya Idul Fitri 1447 H", color: "holiday", span: 2 }, { date: "2026-04-01", title: "Perkiraan Libur Idul Fitri", color: "event-yellow", span: 4 }, { date: "2026-05-01", title: "Hari Buruh Internasional", color: "holiday" }, { date: "2026-06-01", title: "Hari Lahir Pancasila", color: "holiday" }, { date: "2026-06-01", title: "Penilaian Akhir Tahun (PAT)", color: "event-lightblue", span: 12 }, { date: "2026-06-04", title: "Hari Raya Idul Adha 1447 H", color: "holiday" }, { date: "2026-06-13", title: "Penerimaan Rapor", color: "event-darkblue" }, { date: "2026-06-14", title: "Tahun Baru Islam 1448 H", color: "holiday" }, { date: "2026-06-15", title: "Libur Akhir Tahun", color: "event-orange", span: 28 } ],
		santriMusyrif: ["Abdullah Ridho Selamet", "Ahmad Royyan", "Ahsin Lutfaka", "Ibrahim", "M. Alvin Ramadhan Lubis", "Rizki Fadilla", "Yasir Al-Fath"].sort(),
		santriMusyrifah: ["Aisyah Az-Zahra", "Aisyah Nur Fadilla", "Annisa Akbar Siregar", "Aprilia Alvani Rikay", "Aprilia Alvana Rikay", "Dedek Suci Ramadhani", "Dira Adiana Putri", "Hadzira Inayah Safa", "Intan Akbar Siregar", "Nur Alfia Fauzana", "Nur Halimah", "Putri Maharani Br. Tarigan", "Rahmah Azizah Lubis", "Rara Azahra", "Suci Agus Anggira", "Zaenab"].sort(),
        santri: [ { id: 1, nama: "Ahmad Royyan", gender: "Laki-Laki", grup: "KG LKS", kelas: "XII", jurusan: "Bisnis & Manajemen" }, { id: 2, nama: "M. Alvin Ramadhan Lubis", gender: "Laki-Laki", grup: "KF", kelas: "X", jurusan: "Non Jurusan" }, { id: 3, nama: "Abdullah Ridho Selamet", gender: "Laki-Laki", grup: "KG LKS", kelas: "X", jurusan: "Bisnis & Manajemen" }, { id: 4, nama: "Rizki Fadilah", gender: "Laki-Laki", grup: "KF", kelas: "VIII", jurusan: "Non Jurusan" }, { id: 5, nama: "Annisa Akbar Siregar", gender: "Perempuan", grup: "KG STT", kelas: "XII", jurusan: "Agribisnis (Pertanian & Peternakan)" }, { id: 6, nama: "Intan Akbar Siregar", gender: "Perempuan", grup: "KG STT", kelas: "IX", jurusan: "Sains & Teknologi" }, { id: 7, nama: "Aprilia Alvana Rikay", gender: "Perempuan", grup: "KG LKS", kelas: "X", jurusan: "Pendidikan Agama Islam" }, { id: 8, nama: "Aprilia Alvani Rikay", gender: "Perempuan", grup: "KG LKS", kelas: "X", jurusan: "Pendidikan Agama Islam" }, { id: 9, nama: "Rahmah Azizah Lubis", gender: "Perempuan", grup: "KG LKS", kelas: "XI", jurusan: "Tahfidz & Bahasa Arab" }, { id: 10, nama: "Aisyah Az-Zahra", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Tahfidz & Bahasa Arab" }, { id: 11, nama: "Nur Halimah", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Tahfidz & Bahasa Arab" }, { id: 12, nama: "Nur Alfia Fauzana", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Pendidikan Agama Islam" }, { id: 13, nama: "Putri Maharani Br. Tarigan", gender: "Perempuan", grup: "KF", kelas: "VIII", jurusan: "Non Jurusan" }, { id: 14, nama: "Dedek Suci Ramadhani", gender: "Perempuan", grup: "KF", kelas: "VII", jurusan: "Non Jurusan" }, { id: 15, nama: "Aisyah Nur Fadillah", gender: "Perempuan", grup: "KF", kelas: "VII", jurusan: "Non Jurusan" } ],
        teachers: [ { no: 1, name: "Sulistiawan, S.Kom", major: "Pelajaran Umum & Keterampilan", hari: "Semua hari & jam", schedule: "Guru Cadangan" }, { no: 2, name: "Zhofri F. Majdi, S.Sos", major: "Diniyah", hari: "Kamis, Jumat, Sabtu", schedule: "Kamis (08-10), Jumat & Sabtu (Semua Jam)" }, { no: 3, name: "M. Ryza Anshori, S.Pd", major: "Diniyah", hari: "Jumat", schedule: "Semua Jam" }, { no: 4, name: "Erwan Syahputra, S.Pd", major: "Diniyah", hari: "Selasa, Rabu, Sabtu", schedule: "Selasa (Semua Jam), Rabu & Sabtu (sampai 10.00)" }, { no: 5, name: "Ariyanti R. Siregar, S.Kom", major: "Pelajaran Umum", hari: "Senin, Rabu, Kamis", schedule: "12.45 - 14.15" }, { no: 6, name: "Mia A. Lubis, S.Kom", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "10.00 - 12.15 (Guru Cadangan)" }, { no: 7, name: "Mahadi Sentosa, S.Sos", major: "Diniyah", hari: "Sabtu", schedule: "13.00-14.30" }, { no: 8, name: "Suprasojo, S.Pd.I., M.Pd.", major: "Diniyah", hari: "Senin, Rabu", schedule: "8.00-11.30" }, { no: 9, name: "Aria Atmaja", major: "Teknik Mekanik Elektronik", hari: "Rabu", schedule: "08:00-09:30" } ],
        schedules: {
            bulan1: [
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-101: Menyimak Efektif: Adab & Teknik", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1PAGwVSmVj3_JFW6mekxZGK7xZh54XlDH/view?usp=drive_link" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-201: Pengantar Thibbun Nabawi", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ZjmZkzVknCL8sNPz4nWwaARTN62AN1qG/view" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-101: Greetings & Introductions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1LYRMv43xr0ei9aHJ4Rm8VVGEZv2LMoJT/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-201: Riset Pasar & Analisis Kompetitor", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ibVSjYmLhxxAhmAm_EGJ-qowFDPy3aZ_/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-101: ABY Jilid 1A Unit 1-2 (Perkenalan & Keluarga)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1KNuZMEsYPEznGzEcyhTR5GDb5J3gUwM5/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "PANC-201: Implementasi nilai-nilai Pancasila Dalam Kehidupan", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1V0ZYiN9sYr5ZYXR3yfk5p80uLFNlbv9g/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-201: ABY Jilid 1B Unit 7-8 (Pendidikan & Pekerjaan)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/19dfcrahHUBSjFQx0bNvcGDxm2gJw35Tt/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-101: Pertolongan Pertama Pada Kecelakaan (P3K)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1X7OG1Z2rdwVPn4B8VqZM--wV7zDddOFw/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-101: Makna & Konsekuensi 2 Kalimat Syahadat", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/11yClAXt_5YcDrzyZ9-Ee4fJOSIwGQWcK/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-201: Gerak Lurus dan Gaya", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/170mKM_vLYEeO0tIUOP063-k1wMW1a1jD/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-201: Pengantar Ilmu Hadits (Definisi & Sejarah)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1b839aBuE0qPkPX5TISgiloV3qGljV2EF/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-101: Pengantar Mindset Wirausaha Muslim", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1OY6JWCfKPjxgKECTDUoWadrY_eoMMdCj/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-201: Pengenalan Alat-Alat Servis", teacher: "Aria Atmaja", downloadLink: "https://drive.google.com/file/d/1tgiZzRH8P-WWtoNdtRWkJW8qGDBcrU8b/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-101: Aku & Lingkungan Sekitarku", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1FlPhTpeWb9ARmQRa8g-dV74_tabkmwFI/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-201: Public Speaking 1: Struktur Pidato & Mengatasi Gugup", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/1HlMC_lIGb7L9rDr2MocXm3VCMP6uqyeg/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-201: Hobbies & Free Time", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/15-9a1S4ogBTjKjG6i2_268-tLqrquC4P/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-101: Hadits Arba'in 1 (Hafalan & Makna Hadits #1-5)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1pND30uoMlg5Dqyzm5C4_Yl27_H5LXHh9/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-101: Pengenalan Perangkat Keras & Lunak Komputer", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1JTJjRA_rWZ-62_W82aBKL23b2K0244bL/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-201: Studi Kitab Tauhid 1", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1WoluRi1U0edST8BBaqPkLNiEIZLCPwvt/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-201: Pengolah Kata (Word) Lanjutan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1KzWoTzH_VqgVjd-0Sc3z9Xmwz7Z19TSX/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-201: Masuk dan Berkembangnya Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1X0S3XBjJEdEkKCGAUjcDze8Kfh2MWjuG/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-101: Ciri Makhluk Hidup & Klasifikasi Sederhana", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1x-u8VWwCD2KJW16-wG0z_ZBrmbAb4Lpf/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-201: Sejarah Penulisan & Pengumpulan Al-Qur'an", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1b_WMo_1KKAWPXKzilPSKsFzNzUmdW4V8/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-101: Wudhu & Tayammum", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1ZLRZNGtttzsv0KQ7E9S2vezp3ma5vfwE/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-201: Tanda-tanda I'rab untuk Isim", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1WX-53Q4hY5gvzAVbKsEjLHKACWgKo1K1/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-101: Kondisi Dunia Sebelum Kenabian & Masa Kecil Nabi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1uULQr6lFC2YylJ4ZdcktlUXbgKEPzdp-/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-101: Pengantar Ilmu Balaghah", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1UyC0-W-l-Xfli8SSvpMcihgiuFc1zYS0/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-201: Tafsir & Tadabbur Surat Al-Maa'un & Al-Kafirun", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1uy5pOjhibrZbLUOUfRJHNKtqV4AT6obY/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-101: Adab Kepada Allah", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1bXBq9UzfDsnIxEnh1cMHZchqlEHB8etK/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-101: Tafsir & Tadabbur Surat Al-Fatihah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1XyXIN1bsnIKVeGX3_H9MkaGlgrB2dhCu/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-201: Membaca 3 (Membedakan Fakta & Opini dalam Teks)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/12D_Sk1hB2q5e3BdNX1-Iw8kIjTrm6UId/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-201: Peristiwa Boikot & Wafatnya Khadijah dan Abu Thalib", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1vJCQq48tCQNX_S5X8NF3DqTE9weOhGse/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-101: Pengenalan Kalimat (Jumlah Mufidah) & Jenis Kata", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "https://drive.google.com/file/d/1kbTKODSzvge5WUbkRA5wpf3SJl8WVXci/view?usp=drive_link" },
					
 { day: "Senin", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Selasa", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Rabu", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Kamis", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Jumat", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
                ],
                bulan2: [
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-102: Pecahan & Desimal", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/14mAyOGGZXxbiC0OM9lUWFkY3xzkpDCD2/view?usp=drive_link" },
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-102: Pecahan & Desimal", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/14mAyOGGZXxbiC0OM9lUWFkY3xzkpDCD2/view?usp=drive_link" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-102: Berbicara 1: Perkenalan Diri & Sapaan Santun", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/12C3tX82DIS6BqYBt2DdKlvCRKTgNzX8Y/view?usp=drive_link" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-202: Adab kepada Orang Tua & Guru (Gabungan)", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/1k_P5RN0TS25K_3K3yc4yMNGsOj1qOtE2/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-102: Classroom Objects & Instructions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1q2btB5Fv1-ifXl9n7tOLT9bk1CmpsMYt/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-202: Validasi Ide & Model Bisnis Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1rR-udDxso8F9x2pExZTfemJoiZQDknDn/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-102: ABY Jilid 1A: Unit 3-4 (Tempat Tinggal & Kehidupan Harian)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1_YO9Z4NlH6JjtycqQCZC7i26IZdS_K3M/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-202: Hifzhu Shihhah (Pola Hidup Sehat Rasulullah )", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/10qcUn-Ycfqfw03SiS2F2zZg8TbGHu4_E/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-202: ABY Jilid 1B: Unit 9-10 (Berbelanja & Cuaca)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/14EF5H4lZaA-Kx4WHvIqL3_WxDNhtEj3F/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-102: Manajemen Kesehatan Dasar & Penyakit Umum", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ROzqQ6HtB3t4UwQLVuGGZBwE6uZO8_Zc/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-102: Studi Kitab Tauhid 1", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1qjYbEFYXgoJa5oBrE8-D3-8XcpML3qfc/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-202: Sistem Gerak pada Manusia (Rangka & Sendi)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/16GiZXYA0pLnivjI-AgZxa0cs1bm5onLt/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-202: Klasifikasi Hadits (Shahih, Hasan, Dha'if)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/15Wdnf8x9oqPhjhurjqJC8eEN5VlG51uY/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-102: Dasar-dasar Produk Halal & Thayyib", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1RAq8tygsge8GoCBrhn21gnHbDnu4pbZy/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-202: Praktik Menggunakan Alat Tangan & Solder", teacher: "Aria Atmaja", downloadLink: "https://drive.google.com/file/d/1g6ZMvLvlZz5ML1wFJla4tEsd8Thi6ixr/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-102: Kebutuhan Manusia & Ekonomi Dasar", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1X1TZ0rn3LEjpuGPitnEuwU3_4LVC307_/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-202: Public Speaking 2: Teknik Vokal & Bahasa Tubuh", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/15A_dulFxCo0C-KfJI8SwDUJ8JHC9chNp/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-202: Food & Drinks", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1tfAqtezxc2QjgaPf8DRrwEFKgsg6FRN9/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-102: Hadits Arba'in 2 (Hafalan & Makna Hadits #6-10)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1XJ9TQok3F0kbpDwCI7tp3h16GqeSL6ST/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-102: Sistem Operasi & Manajemen File Dasar", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1Hvgbz7Feoo77Y9sN623wZBWTI0rGUBr0/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-202: Studi Kitab Tauhid 2", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/17YsFPW2yfT7vAp0NJ_P15maejVzPqvJ-/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-202: Pengolah Angka (Excel) Lanjutan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1srJaLqp4ooThoEfI7wtsbFaykdgyu99e/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-202: Kerajaan-Kerajaan Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1C46LEPWD7RqtMk9VCbSrmgrsfoacOmwx/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-102: Zat dan Wujudnya (Padat, Cair, Gas)", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1RNX57pp79q4_ng6jNbbL9noyIkSVh_za/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-202: Pengantar Ulumul Qur'an (Makkiyah & Madaniyah)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1zjGj93zp0Q75e-R910X9rJD3vDwvJjRO/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-102: Shalat 1: Syarat & Rukun Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1N8ElP99WQz3mtS3Grci-OhJSaIYd7kXc/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-202: I'rab Isim Mutsanna & Jamak Mudzakkar Salim", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1QwWpcn3ulii4n4C50In2dlF6uPTBTODV/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-102: Masa Kenabian & Dakwah di Mekah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1ru17RARAr5mBS8fXP_tD_2HE3KH41ZeW/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-102: Ilmu Ma'ani: Kalam Khabari & Insya'i", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1_sbsi-bfwpLPjzgR7G00yOCRj-4fZIIK/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-202: Tafsir & Tadabbur Surat Al-'Asr & Al-Humazah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/14DD1UeZQ-_1UojKNOZ6n_-8Z1BXQlMms/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-102: Adab kepada Sesama & Lingkungan", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1j_-GAHn0VUbq3pjBHRvo2tajQUMcvIyM/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-102: Tafsir & Tadabbur Ayat Kursi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/18T2MoUIgArVl5bpl62IiX-lbMa4Xz5Wr/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-202: Menulis 3: Membuat Ringkasan & Peta Konsep", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1EX9Suwx3tz13lBY6ZDl8WbBoh4d925zp/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-202: Peristiwa Isra' Mi'raj & Perintah Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1bWBklTc9RNC0TC-X2S_4paK5nyU_BrjA/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-102: Jumlah Ismiyah (Kalimat Nominal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "https://drive.google.com/file/d/1A-2Xy_Z9VgG22wWRI9_dOPJuvVK12mOq/view?usp=drive_link" },
                ],
                bulan3: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-103: Aritmetika Sosial 1: Harga & Jual Beli", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-103: Aritmetika Sosial 1: Harga & Jual Beli", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-103: Membaca 1: Memahami Teks Informasi Sederhana", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-203: Isra' Mi'raj & Perintah Shalat", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-103: Alphabet, Numbers, & Telling Time", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-202: Analisis Kompetitor & SWOT Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-103: ABY Jilid 1A: Unit 5-6 (Makanan & Shalat)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-203: Makanan & Minuman Penyembuh Sesuai Wahyu", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-203: ABY Jilid 1B: Unit 11-12 (Manusia, Tempat & Hobi)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-103: Penanganan Luka & Pendarahan", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-103: Rukun Iman & Pembagian Tauhid", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-203: Sistem Pencernaan Manusia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-203: Pengantar Sanad & Matan Hadits", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-103: Menemukan Ide Bisnis dari Masalah Sekitar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-203: Praktik Menggunakan Alat Ukur & Perawatan Alat", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-103: Interaksi Sosial & Adab", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-203: Public Speaking 3: Praktik Pidato Singkat (Kultum)", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-203: Grammar 3: Present Continuous Tense", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-103: Hadits Arba'in 3 (Hafalan & Makna Hadits #11-15)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-103: Latihan Mengetik 10 Jari (Typing)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-203: Studi Kitab Tauhid 3", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-203: Aplikasi Presentasi (PowerPoint) - Dasar", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-203: Geografi Jazirah Arab", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-103: Suhu, Kalor, & Pemuaian", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-203: Pengantar Ilmu Tafsir (Definisi & Sejarah)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-103: Shalat 2: Sunnah & Pembatal Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-203: Penerapan Tanda Asli pada Isim Mufrad & Jamak Taksir", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-103: Hijrah ke Habasyah & Pemboikotan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-103: Ilmu Bayan: Seni Perumpamaan (Tasybih)", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-203: Tafsir & Tadabbur Surat At-Takatsur & Al-'Adiyat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-103: Adab Menuntut Ilmu", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-103: Tafsir & Tadabbur Surat Al-Ikhlas, Al-Falaq, An-Nas", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-203: Berbicara 3: Menyampaikan Pendapat dalam Diskusi", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-203: Bai'at 'Aqabah & Rencana Hijrah ke Madinah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-103: Jumlah Fi'liyah (Kalimat Verbal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },
 ],
                bulan4: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-104: Pengenalan Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-104: Pengenalan Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-104: Menulis 1: Menulis Paragraf Deskriptif", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-204: Hijrah ke Habasyah", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-104: My Family & My Friends", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-204: Analisis SWOT Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-104: Mufrodat 1: Kosakata Benda di Kelas & Rumah", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-204: Terapi Pengobatan Nabawi (Bekam & Ruqyah)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-204: Kitabah 2: Menulis Paragraf Sederhana & Imla' Lanjutan", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-104: Penanganan Kasus Umum & Simulasi P3K", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-104: Hadits Arba'in 4 (Hafalan & Makna Hadits #16-20)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-204: Usaha & Pesawat Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-204: Studi Sanad & Matan Sederhana", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-104: Menyusun Rencana Bisnis Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-204: Praktik Menggunakan Alat Ukur & Perawatan Alat", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-104: Peta & Kompas", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-204: Public Speaking 4: Praktik Kultum di Depan Kelas", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-204: Asking & Giving Directions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-104: Hadits Arba'in 4 (Hafalan & Makna Hadits #16-20)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-104: Latihan Mengetik 10 Jari (Typing)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-204: Studi Kitab Tauhid 4", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-204: Desain Grafis Dasar 1 (dengan Canva)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-204: Geografi Jazirah Arab", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-104: Suhu, Kalor, & Pemuaian", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-204: Tafsir Ayat-ayat Pilihan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-104: Shalat 4: Dzikir & Doa Setelah Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-204: Isim-isim yang Manshub (Manshubat al-Asma')", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-104: Masa Remaja Nabi & Perjalanan Dagang", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-104: Ilmu Badi': Keindahan Lafaz (Jinas & Thibaq)", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-204: Tafsir & Tadabbur Surat Al-'Adiyat & Al-Qari'ah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-104: Adab Menuntut Ilmu", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-104: Tafsir & Tadabbur Surat Al-Ikhlas, Al-Falaq, An-Nas", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-204: Kaidah Bahasa 3: Imbuhan Dasar (me-, di-, ber-)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-204: Dakwah Terang-terangan & Reaksi Kafir Quraisy", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-104: Jumlah Fi'liyah (Kalimat Verbal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },
 ],
                bulan5: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-105: Luas & Keliling Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-105: Luas & Keliling Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-105: Menulis 2: Menulis Surat Sederhana", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-205: Adab Berpakaian & Berhias", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-105: Daily Activities", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-205: Pemasaran Digital Dasar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-105: Mufrodat 2: Anggota Tubuh & Pakaian", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-205: Studi Kasus Pengobatan Nabawi", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-205: Muhadatsah 1: Praktik Percakapan Harian", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-105: Dasar-dasar Menjahit & Kerajinan Tangan", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-105: Pembatal Keislaman", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-205: Sistem Pernapasan Manusia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-205: Takhrij Hadits Sederhana", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-105: Praktik Membuat Rencana Bisnis", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-205: Proyek Elektronika Sederhana", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-105: Sejarah Lokal & Pahlawan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-205: Manajemen Dakwah & Kepemimpinan", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-205: Reading Comprehension 1", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-105: Hadits Arba'in 5 (Hafalan & Makna Hadits #21-25)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-105: Pengenalan Internet & Email", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-205: Studi Kitab Tauhid 5", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-205: Desain Grafis Dasar 2 (Praktik)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-205: Sejarah Peradaban Islam Dunia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-105: Pengenalan Tata Surya", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-205: Studi Tematik Al-Qur'an", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-105: Zakat & Puasa", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-205: Isim-isim yang Majrur (Majrurat al-Asma')", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-105: Pernikahan Nabi & Peristiwa Penting", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-105: Praktik Analisis Balaghah", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-205: Tafsir & Tadabbur Surat Al-Qari'ah & Al-Zalzalah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-105: Akhlak Terpuji (Mahmudah)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-105: Tafsir & Tadabbur Juz 'Amma Pilihan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-205: Menulis Kreatif: Cerpen & Puisi", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-205: Hijrah ke Madinah & Pembangunan Masjid Nabawi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-105: Pengenalan Fi'il (Kata Kerja)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },

 ], bulan6: [], bulan7: [], bulan8: []
        }
    };
 
    const ui = { messageBox: document.getElementById('messageBox'), donasiModal: document.getElementById("donasiModal"), donasiBtn: document.getElementById("donasiBtn"), loginButton: document.getElementById('loginButton'), userProfile: document.getElementById('userProfile'), userProfileName: document.getElementById('userProfileName'), navProfilePic: document.getElementById('navProfilePic'), attendanceNav: document.getElementById('attendanceNav'), sistemInformasiNav: document.getElementById('sistemInformasiNav'), kalenderPendidikan: document.getElementById('kalenderPendidikanSection'), marqueeContainer: document.getElementById('marquee-container'), marqueeText: document.getElementById('marquee-text'), dynamicCalendarGrid: document.getElementById('dynamic-calendar-grid'), slideshowContainer: document.getElementById('slideshow') };
    
	let appState = {
        activeMonthKey: 'bulan1', // Kunci untuk mengakses data di appData.schedules
        filters: {
            group: 'all',
            cluster: 'all',
            teacher: 'all',
            room: 'all'
        },
        // Data yang sudah diproses akan disimpan di sini
       processedSchedules: {}
    };
	
	const krsContainer = document.getElementById('krs-container');
    const krsDisplay = document.getElementById('krs-display');
    const closeKrsBtnBottom = document.getElementById('close-krs-btn-bottom');
    const downloadKrsBtn = document.getElementById('download-krs-btn');
    const krsTableBody = document.getElementById('krs-table-body');
    const addKrsRowBtn = document.getElementById('add-krs-row');
    const khsContainer = document.getElementById('khs-container');
    const khsDisplay = document.getElementById('khs-display');
    const downloadKhsBtn = document.getElementById('download-khs-btn');
    const closeKhsBtnBottom = document.getElementById('close-khs-btn-bottom');
	
    let isSistemInformasiInitialized = false;

// --- Tempelkan semua kode di bawah ini sebelum BAGIAN 2 ---

// =======================================================
// === VARIABEL DAN DATA UNTUK UJIAN ONLINE ===
// =======================================================
let currentExamData = {};
let currentQuestions = [];
let examAnswers = {};
let firstAttemptScore = null;


// =======================================================
// === FUNGSI-FUNGSI UNTUK UJIAN ONLINE ===
// =======================================================
async function renderExamSchedule() {
    const container = document.getElementById('ujian-schedule-container');
    if (!container) return;
    
    container.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat jadwal ujian...</p>';
    const session = getActiveSession();
    const santriData = appData.santri.find(s => s.nama === session.userData.profileName);
    if (!session || !session.loggedIn || !santriData) {
        container.innerHTML = '<p class="p-8 text-center text-red-500">Data santri tidak ditemukan, silakan login ulang.</p>';
        return;
    }

    const santriGroupInfo = santriData.grup; // e.g., "KG LKS"
    const santriGroup = santriGroupInfo.split(' ')[0]; // e.g., "KG"
    const santriCluster = santriGroupInfo.split(' ')[1] || ''; // e.g., "LKS"

    let availableExams = [];
    let nilaiUjian = {};
    try {
        const [examsResponse, nilaiResponse] = await Promise.all([
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAvailableExams' }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }}),
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getNilaiUjian', username: session.username }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }})
        ]);
        
        const examsResult = await examsResponse.json();
        if (examsResult.status === 'success') availableExams = examsResult.availableExams;
        else throw new Error(`Gagal memuat daftar ujian: ${examsResult.message}`);

        const nilaiResult = await nilaiResponse.json();
        if (nilaiResult.status === 'success') nilaiUjian = nilaiResult.nilai;
        else throw new Error(`Gagal memuat riwayat nilai: ${nilaiResult.message}`);

    } catch (error) {
        container.innerHTML = `<p class="p-8 text-center text-red-500">${error.message}</p>`;
        return;
    }
    
    container.innerHTML = '';
    const grid = document.createElement('div');
    grid.className = 'schedule-grid';
    const days = ["", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    const timeSlots = ["08:00-09:30", "10:00-11:30", "13:00-14:30"];
    const scheduleData = appData.schedules.bulan1;

    days.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-header text-slate-600 bg-slate-100';
        dayHeader.textContent = day;
        grid.appendChild(dayHeader);
    });

    timeSlots.forEach(time => {
        const timeHeader = document.createElement('div');
        timeHeader.className = 'time-slot text-teal-700 bg-slate-100 flex items-center justify-center';
        timeHeader.textContent = time;
        grid.appendChild(timeHeader);

        days.slice(1).forEach(day => {
            const cell = document.createElement('div');
            cell.className = 'schedule-cell p-2';
            
            // PERBAIKAN: Filter jadwal sesuai kelompok & klaster santri
            const item = scheduleData.find(d => 
                d.day === day && 
                d.time === time &&
                (d.group === santriGroup || (d.group === "KG" && d.cluster === "Wajib")) &&
                (santriGroup !== "KG" || !d.cluster || d.cluster === "Wajib" || d.cluster === santriCluster)
            );

            if (item && item.subject.includes(':')) {
                const subjectCode = item.subject.split(':')[0].trim();
                const hasQuestions = availableExams.includes(subjectCode);
                
                let buttonText = 'Soal Belum Tersedia';
                let buttonColor = 'bg-gray-400 cursor-not-allowed';
                let buttonDisabled = 'disabled';

                if (hasQuestions) {
                    const riwayat = nilaiUjian[subjectCode];
                    if (riwayat) {
                        if (riwayat.skor >= 80) {
                            buttonText = `Selesai (${riwayat.skor})`;
                            buttonColor = 'bg-green-600 cursor-not-allowed';
                        } else if (riwayat.percobaan >= 2) {
                            buttonText = `Selesai (${riwayat.skor})`;
                            buttonColor = 'bg-yellow-600 cursor-not-allowed';
                        } else {
                             buttonText = 'Kerjakan Ulang';
                             buttonColor = 'bg-blue-600 hover:bg-blue-700';
                             buttonDisabled = '';
                        }
                    } else {
                        buttonText = 'Mulai Ujian';
                        buttonColor = 'bg-blue-600 hover:bg-blue-700';
                        buttonDisabled = '';
                    }
                }

                cell.innerHTML = `
                    <div class="subject flex-grow font-bold text-sm text-teal-900">${item.subject}</div>
                    <div class="teacher text-xs text-slate-600 mt-1"> ${item.teacher}</div>
                    <button class="start-exam-trigger w-full mt-3 py-2 px-4 rounded-md text-white text-sm font-semibold ${buttonColor}" 
                            data-subject-code="${subjectCode}" 
                            data-subject-title="${item.subject}" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                `;
            }
            grid.appendChild(cell);
        });
    });
    container.appendChild(grid);
}

function setupExamListeners() {
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('start-exam-trigger')) {
            const subjectCode = e.target.dataset.subjectCode;
            const subjectTitle = e.target.dataset.subjectTitle;
            currentExamData = { code: subjectCode, title: subjectTitle };
            document.getElementById('exam-subject-title').textContent = subjectTitle;
            document.getElementById('exam-warning-modal').style.display = 'block';
        }
    });

    document.getElementById('cancel-exam-btn').addEventListener('click', () => {
        document.getElementById('exam-warning-modal').style.display = 'none';
    });

    document.getElementById('start-exam-btn').addEventListener('click', () => {
        document.getElementById('exam-warning-modal').style.display = 'none';
        enterFullscreen(document.documentElement);
        startExam();
    });

    document.getElementById('submit-exam-btn').addEventListener('click', () => {
        if (Object.keys(examAnswers).length < currentQuestions.length) {
            alert('Harap jawab semua pertanyaan sebelum mengirim.');
            return;
        }
        if (confirm('Apakah Anda yakin ingin mengirim jawaban Anda?')) {
            exitFullscreen();
            calculateAndShowResult();
        }
    });
}

function setupResultModalListeners() {
    document.getElementById('result-actions').addEventListener('click', function(e) {
        if (e.target.id === 'result-done-btn' || e.target.id === 'result-later-btn') {
            closeResultModal();
        } else if (e.target.id === 'result-remedial-btn') {
            startRemedial();
        }
    });
}


async function startExam() {
    const examContainer = document.getElementById('exam-container');
    const questionsContainer = document.getElementById('exam-questions');
    
    document.getElementById('exam-subtitle').textContent = currentExamData.title;
    questionsContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat soal ujian...</p>';
    examContainer.classList.remove('hidden');

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getBankSoal', kodeMateri: currentExamData.code }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);
        
        currentQuestions = result.questions;
        if (currentQuestions.length === 0) {
            throw new Error("Tidak ada soal yang ditemukan untuk materi ini.");
        }

    } catch (error) {
        questionsContainer.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat soal: ${error.message}</p>`;
        return;
    }
    
    examAnswers = {};
    questionsContainer.innerHTML = '';

    currentQuestions.forEach((q, index) => {
        const questionId = `q${index}`;
        let optionsHtml = '';
        const shuffledOptions = [...q.o].sort(() => Math.random() - 0.5);
        
        shuffledOptions.forEach((option, i) => {
            const optionId = `q${index}_opt${i}`;
            optionsHtml += `
                <label for="${optionId}" class="answer-option">
                    <input type="radio" name="${questionId}" id="${optionId}" value="${option}">
                    <span>${String.fromCharCode(65 + i)}. ${option}</span>
                </label>
            `;
        });

        questionsContainer.innerHTML += `
            <div class="question-block" id="${questionId}_block">
                <div class="flex justify-between items-start">
                    <p class="text-lg font-semibold mb-4 flex-1">${index + 1}. ${q.q}</p>
                    <span class="text-sm font-bold text-gray-500 ml-4">${q.p || 4} Poin</span>
                </div>
                <div class="answer-options">${optionsHtml}</div>
            </div>
        `;
    });
    
    questionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            examAnswers[e.target.name] = e.target.value;
            document.querySelectorAll(`label[for^="${e.target.name}"]`).forEach(label => label.classList.remove('selected'));
            document.querySelector(`label[for="${e.target.id}"]`).classList.add('selected');
        });
    });
}

function calculateAndShowResult() {
    let correctAnswers = 0;
    currentQuestions.forEach((q, index) => {
        // PERBAIKAN: Mencocokkan jawaban yang dipilih dengan kunci jawaban dari sheet (berupa teks, bukan huruf A/B/C)
        // Contoh: q.a berisi "Jakarta", examAnswers[`q${index}`] juga harus berisi "Jakarta"
        if (examAnswers[`q${index}`] === q.a) {
            correctAnswers++;
        }
    });

    const totalQuestions = currentQuestions.length;
    const score = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
    
    let finalScore;
    let isRemedial = firstAttemptScore !== null;

    if (isRemedial) {
        // Jika ini remedial, ambil nilai tertinggi, tapi maksimal 80
        finalScore = Math.min(Math.max(firstAttemptScore, score), 80);
    } else {
        // Jika ini percobaan pertama
        firstAttemptScore = score;
        finalScore = score;
    }
    
    const resultScoreEl = document.getElementById('result-score');
    const resultMessageEl = document.getElementById('result-message');
    const resultActionsEl = document.getElementById('result-actions');
    
    // Kirim nilai ke Google Sheet
    const session = getActiveSession();
    const dataToSave = {
        action: 'simpanNilaiUjian',
        username: session.username,
        namaSantri: session.userData.profileName,
        kodeMateri: currentExamData.code,
        judulMateri: currentExamData.title,
        skor: firstAttemptScore, // Selalu kirim skor percobaan pertama
        skorAkhir: finalScore
    };
    
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(dataToSave),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    }).then(res => res.json()).then(result => {
        if (result.status !== 'success') {
            console.error("Gagal menyimpan nilai:", result.message);
            // Tetap tampilkan hasil ke pengguna meskipun gagal simpan
        }
    }).catch(err => console.error("Error saat menyimpan nilai:", err));


    resultScoreEl.textContent = finalScore;
    
    // Logika Tampilan Modal Hasil
    if (finalScore >= 80) {
        resultScoreEl.className = 'text-8xl font-bold my-8 pass';
        resultMessageEl.textContent = 'Selamat, nilai Anda sangat baik! Nilai akhir Anda akan dicatat di KHS.';
        resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
    } else if (finalScore >= 75 && finalScore <= 79) {
        resultScoreEl.className = 'text-8xl font-bold my-8 pass';
        if (isRemedial) {
             resultMessageEl.textContent = `Selamat, Anda lulus! Nilai akhir Anda (${finalScore}) akan dicatat di KHS.`;
             resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
        } else {
            resultMessageEl.textContent = `Anda sudah lulus (KKM 75), namun Anda bisa mencoba 1x lagi untuk memperbaiki nilai (maksimal 80).`;
            resultActionsEl.innerHTML = `<button id="result-remedial-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">Ujian Ulang</button>
                                         <button id="result-later-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg mt-2">Cukup</button>`;
        }
    } else { // Di bawah 75
        resultScoreEl.className = 'text-8xl font-bold my-8 fail';
        if (isRemedial) {
            resultMessageEl.textContent = `Anda telah menyelesaikan remedial. Nilai akhir Anda (${finalScore}) akan dicatat di KHS.`;
            resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
        } else {
            resultMessageEl.textContent = 'Anda belum mencapai nilai minimum. Anda diberi kesempatan untuk 1x remedial.';
            resultActionsEl.innerHTML = `<button id="result-remedial-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">Mulai Remedial</button>
                                         <button id="result-later-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg mt-2">Nanti Saja</button>`;
        }
    }

    document.getElementById('exam-container').classList.add('hidden');
    document.getElementById('exam-result-modal').style.display = 'block';
}

function closeResultModal() {
    document.getElementById('exam-result-modal').style.display = 'none';
    firstAttemptScore = null;
	window.location.hash = '#ujian-online';
}

function startRemedial() {
    document.getElementById('exam-result-modal').style.display = 'none';
    enterFullscreen(document.documentElement);
    startExam();
}

// Fungsi Bantuan Fullscreen
function enterFullscreen(element) {
    if (element.requestFullscreen) { element.requestFullscreen(); } 
    else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } 
    else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } 
    else if (element.msRequestFullscreen) { element.msRequestFullscreen(); }
}

function exitFullscreen() {
    if (document.exitFullscreen) { document.exitFullscreen(); } 
    else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
    else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
}

// =======================================================
// === FUNGSI-FUNGSI UNTUK INPUT SOAL ===
// =======================================================

function setupInputSoalPage() {
    const materiSelect = document.getElementById('materi-soal-select');
    const pasteArea = document.getElementById('paste-soal-area');
    const previewContainer = document.getElementById('soal-preview-container');
    const simpanBtn = document.getElementById('simpan-soal-btn');

    // 1. Isi dropdown materi dari data jadwal yang ada
    if (materiSelect && materiSelect.options.length <= 1) {
        const uniqueSubjects = {};
        Object.values(appData.schedules).flat().forEach(item => {
            if (item.subject && item.subject.includes(':')) {
                const code = item.subject.split(':')[0].trim();
                if (!uniqueSubjects[code]) {
                    uniqueSubjects[code] = item.subject;
                }
            }
        });
        for (const code in uniqueSubjects) {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = uniqueSubjects[code];
            materiSelect.appendChild(option);
        }
    }

    // 2. Event listener untuk textarea
    if (pasteArea) {
        pasteArea.addEventListener('paste', (e) => {
            // Beri sedikit waktu agar teks hasil paste masuk ke textarea
            setTimeout(() => renderSoalPreview(e.target.value), 100);
        });
        pasteArea.addEventListener('keyup', (e) => {
             renderSoalPreview(e.target.value);
        });
    }

    // 3. Fungsi untuk merender pratinjau
    function renderSoalPreview(fullText) {
        // Regex untuk memisahkan soal berdasarkan "angka." atau "angka)"
        const soalArray = fullText.split(/\n(?=\d+[.)])/).map(s => s.trim()).filter(Boolean);

        if (soalArray.length === 0) {
            previewContainer.innerHTML = `<p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini.</p>`;
            simpanBtn.classList.add('hidden');
            return;
        }

        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Isi Soal</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-48">Kunci Jawaban (A/B/C/D)</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Poin</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

        soalArray.forEach((soal, index) => {
            // Hapus nomor di awal soal untuk kebersihan data
            const cleanSoal = soal.replace(/^\d+[.)]\s*/, '');
            tableHTML += `
                <tr class="soal-row">
                    <td class="px-4 py-3 align-top">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-800 whitespace-pre-wrap">${cleanSoal}</td>
                    <td class="px-4 py-3 align-top">
                        <input type="text" class="kunci-jawaban-input w-full p-2 border rounded-md uppercase" maxlength="1" placeholder="Cth: A">
                    </td>
                    <td class="px-4 py-3 align-top">
                        <input type="number" class="poin-soal-input w-full p-2 border rounded-md" value="4">
                    </td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;
        previewContainer.innerHTML = tableHTML;
        simpanBtn.classList.remove('hidden');
    }

    // 4. Event listener untuk tombol simpan
    if (simpanBtn) {
        simpanBtn.addEventListener('click', handleSimpanSoal);
    }
}

function handleSimpanSoal() {
    const materiSelect = document.getElementById('materi-soal-select');
    const materiKode = materiSelect.value;
    if (!materiKode) {
        showMessage('Silakan pilih materi terlebih dahulu.', 'error');
        return;
    }

    const rows = document.querySelectorAll('#soal-preview-container .soal-row');
    const dataSoal = [];
    let isValid = true;

    rows.forEach((row, index) => {
        const isiSoal = row.querySelector('td:nth-child(2)').textContent;
        const kunciJawaban = row.querySelector('.kunci-jawaban-input').value.toUpperCase() || ''; // Jadi string kosong jika tidak diisi
		const poin = row.querySelector('.poin-soal-input').value || 4;

        if (!kunciJawaban || !poin) {
            isValid = false;
        }

        dataSoal.push({
            kodeMateri: materiKode,
            nomorSoal: index + 1,
            isiSoal: isiSoal,
            kunciJawaban: kunciJawaban,
            poin: parseInt(poin)
        });
    });

    
    
    if (!confirm(`Anda akan menyimpan ${dataSoal.length} soal untuk materi ${materiKode}. Lanjutkan?`)) {
        return;
    }

    const simpanBtn = document.getElementById('simpan-soal-btn');
    simpanBtn.disabled = true;
    simpanBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'simpanBankSoal', soalData: dataSoal }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            // Reset halaman input
            document.getElementById('paste-soal-area').value = '';
            document.getElementById('soal-preview-container').innerHTML = `<p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini.</p>`;
            simpanBtn.classList.add('hidden');
            materiSelect.value = '';
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        simpanBtn.disabled = false;
        simpanBtn.textContent = 'Simpan Semua Soal';
    });
}

// =======================================================
// === FUNGSI-FUNGSI UNTUK HALAMAN GURU ===
// =======================================================
let soalGuruData = []; // Untuk menyimpan data soal yang diambil

async function setupHalamanGuru() {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;

    const guruMateriSelect = document.getElementById('guru-materi-select');
    const soalContainer = document.getElementById('guru-soal-container');
    const updateBtn = document.getElementById('update-soal-btn');
    
    soalContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat data soal...</p>';
    
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getSoalUntukGuru', namaGuru: session.userData.profileName }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        soalGuruData = result.soal; // Simpan data soal secara global
        const materiGuru = result.materi;

        // Isi dropdown materi
        guruMateriSelect.innerHTML = '<option value="all">Tampilkan Semua Materi</option>';
        for (const kode in materiGuru) {
            const option = document.createElement('option');
            option.value = kode;
            option.textContent = materiGuru[kode];
            guruMateriSelect.appendChild(option);
        }

        renderSoalUntukGuru('all'); // Tampilkan semua soal pada awalnya

    } catch (error) {
        soalContainer.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat data: ${error.message}</p>`;
    }

    guruMateriSelect.addEventListener('change', (e) => {
        renderSoalUntukGuru(e.target.value);
    });
    
    updateBtn.addEventListener('click', handleUpdateSoal);
}

function renderSoalUntukGuru(filterKodeMateri) {
    const soalContainer = document.getElementById('guru-soal-container');
    const updateBtn = document.getElementById('update-soal-btn');
    
    const filteredSoal = filterKodeMateri === 'all' 
        ? soalGuruData 
        : soalGuruData.filter(s => s.KodeMateri === filterKodeMateri);

    if (filteredSoal.length === 0) {
        soalContainer.innerHTML = `<p class="p-8 text-center text-gray-400">Tidak ada soal untuk materi ini.</p>`;
        updateBtn.classList.add('hidden');
        return;
    }

    let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Isi Soal</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-48">Kunci Jawaban</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Poin</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">`;

    filteredSoal.forEach((soal, index) => {
        tableHTML += `
            <tr class="soal-row-guru" data-kode-materi="${soal.KodeMateri}" data-nomor-soal="${soal.NomorSoal}">
                <td class="px-4 py-3 align-top">${index + 1}</td>
                <td class="px-4 py-3 text-sm text-gray-800 whitespace-pre-wrap">${soal.IsiSoal}</td>
                <td class="px-4 py-3 align-top">
                    <input type="text" class="kunci-jawaban-input w-full p-2 border rounded-md uppercase" maxlength="1" value="${soal.KunciJawaban || ''}">
                </td>
                <td class="px-4 py-3 align-top">
                    <input type="number" class="poin-soal-input w-full p-2 border rounded-md" value="${soal.Poin || 0}">
                </td>
            </tr>
        `;
    });

    tableHTML += `</tbody></table>`;
    soalContainer.innerHTML = tableHTML;
    updateBtn.classList.remove('hidden');
}

function handleUpdateSoal() {
    const rows = document.querySelectorAll('#guru-soal-container .soal-row-guru');
    const dataToUpdate = [];

    rows.forEach(row => {
        dataToUpdate.push({
            kodeMateri: row.dataset.kodeMateri,
            nomorSoal: parseInt(row.dataset.nomorSoal),
            isiSoal: row.querySelector('td:nth-child(2)').textContent, // Kirimkan juga isi soal
            kunciJawaban: row.querySelector('.kunci-jawaban-input').value.toUpperCase() || '',
            poin: row.querySelector('.poin-soal-input').value || 0
        });
    });

    if (dataToUpdate.length === 0) {
        showMessage('Tidak ada data untuk diperbarui.', 'error');
        return;
    }

    if (!confirm(`Anda akan memperbarui ${dataToUpdate.length} soal. Lanjutkan?`)) {
        return;
    }

    const updateBtn = document.getElementById('update-soal-btn');
    updateBtn.disabled = true;
    updateBtn.textContent = 'Menyimpan...';

    // Kita gunakan kembali fungsi 'simpanBankSoal' karena logikanya sama (hapus lalu tambah)
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'simpanBankSoal', soalData: dataToUpdate }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            // Muat ulang data untuk merefleksikan perubahan
            setupHalamanGuru(); 
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        updateBtn.disabled = false;
        updateBtn.textContent = 'Simpan Perubahan';
    });
}

    // --- BAGIAN 2: DEFINISI SEMUA FUNGSI ---
    // FUNGSI BANTUAN UNTUK MENGAMBIL TANGGAL HARI INI
function getClientDateString() {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    return `${day}/${month}/${year}`;
}
	
    function showMessage(message, type = 'error') { ui.messageBox.textContent = message; ui.messageBox.className = `message-box ${type} show`; setTimeout(() => { ui.messageBox.classList.remove('show'); }, 3500); }
    function getActiveSession() { return JSON.parse(localStorage.getItem('userSession') || sessionStorage.getItem('userSession') || 'null'); }

function showAnnouncementPopup() {
    const popup = document.getElementById('announcementPopup');
    const closeBtn = document.getElementById('closePopupBtn');
    const understandBtn = document.getElementById('understandPopupBtn');

    const closePopup = () => {
        popup.style.display = 'none';
    };

    // Langsung tampilkan popup
    popup.style.display = 'block';

    // Pasang event listener untuk tombol tutup
    closeBtn.onclick = closePopup;
    understandBtn.onclick = closePopup;
}

// FUNGSI BARU UNTUK MENAMPILKAN TRANSAKSI HARIAN
function renderDailyTransactions(allMonthData, selectedDate) {
    const container = document.getElementById('daily-transaction-container');

    // Normalisasi tanggal yang dipilih (menghilangkan masalah zona waktu)
    const targetDate = new Date(selectedDate + 'T00:00:00');
    const targetDateString = targetDate.toLocaleDateString('id-ID');

    const dailyData = allMonthData.filter(row => {
        // Normalisasi tanggal dari data sheet
        const transactionDate = new Date(row[0]);
        const transactionDateString = transactionDate.toLocaleDateString('id-ID');
        return transactionDateString === targetDateString;
    });

    let runningTotal = 0; // Inisialisasi saldo berjalan
    const rowsHTML = dailyData.map(row => {
        const isIncome = row[1] === 'Uang Masuk';
        const amount = parseFloat(row[4]) || 0;
        runningTotal += isIncome ? amount : -amount;

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border">${new Date(row[0]).toLocaleDateString('id-ID')}</td>
                <td class="px-2 py-2 border">${row[3]}</td>
                <td class="px-2 py-2 border text-right">${isIncome ? amount.toLocaleString('id-ID') : '-'}</td>
                <td class="px-2 py-2 border text-right">${!isIncome ? amount.toLocaleString('id-ID') : '-'}</td>
                <td class="px-2 py-2 border text-right font-semibold">${runningTotal.toLocaleString('id-ID')}</td>
                <td class="px-2 py-2 border">${row[2]}</td>
                <td class="px-2 py-2 border text-center"><button class="text-red-500 hover:text-red-700" onclick="handleDeleteTransaction('${new Date(row[0]).getTime()}')">Hapus</button></td>
            </tr>
        `;
    }).join('');

    const displayDate = targetDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    container.innerHTML = `
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Rincian Transaksi Tanggal ${displayDate}</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm mt-2 mb-4 border-collapse">
                <thead class="bg-gray-100"><tr>
                    <th class="px-2 py-2 border text-left">Tanggal</th><th class="px-2 py-2 border text-left">Keterangan</th>
                    <th class="px-2 py-2 border text-right">Masuk</th><th class="px-2 py-2 border text-right">Keluar</th>
                    <th class="px-2 py-2 border text-right">Total</th><th class="px-2 py-2 border text-left">Kelompok</th>
                    <th class="px-2 py-2 border">Aksi</th>
                </tr></thead>
                <tbody>${rowsHTML || `<tr><td colspan="7" class="p-4 text-center border">Tidak ada transaksi pada tanggal ini.</td></tr>`}</tbody>
            </table>
        </div>`;
}

// FUNGSI BARU UNTUK MENGHAPUS TRANSAKSI
function handleDeleteTransaction(timestamp) {
    if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteTransaction', timestamp: timestamp }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            document.getElementById('tampilkanLaporanKeuanganBtn').click(); // Refresh laporan
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menghapus: ${error.message}`, 'error'));
}

// FUNGSI BARU UNTUK MENGUNDUH/MEMBAGIKAN GAMBAR
function downloadOrShareSummary(action = 'download') {
    const summaryNode = document.getElementById('printable-summary');
    html2canvas(summaryNode, { scale: 2 }).then(canvas => {
        canvas.toBlob(function(blob) {
            const fileName = `Ringkasan Keuangan Tahunan - ${document.getElementById('laporanTahun').value}.png`;
            if (action === 'download') {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = URL.createObjectURL(blob);
                link.click();
            } else if (action === 'share' && navigator.share) {
                navigator.share({
                    files: [new File([blob], fileName, { type: 'image/png' })],
                    title: 'Ringkasan Keuangan Tahunan',
                }).catch(err => console.error("Error sharing:", err));
            }
        });
    });
}



// =======================================================
// === FUNGSI-FUNGSI BARU UNTUK LAPORAN KEUANGAN ===
// =======================================================

function setupKeuanganEventListeners() {
    document.getElementById('tampilkanLaporanKeuanganBtn')?.addEventListener('click', () => {
        const bulan = document.getElementById('laporanBulan').value;
        const tahun = document.getElementById('laporanTahun').value;
        fetchAndRenderKeuanganReport(tahun, bulan);
    });
    document.getElementById('addKeuanganRowBtn')?.addEventListener('click', addKeuanganInputRow);
    document.getElementById('saveKeuanganBtn')?.addEventListener('click', handleSaveKeuangan);

	document.getElementById('setTanggalDefaultBtn')?.addEventListener('click', handleSetDefaultDate);


    // Listener untuk pilihan grafik
    document.querySelectorAll('input[name="chartType"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const tahun = document.getElementById('laporanTahun').value;
            // Panggil lagi fungsi fetch data tahunan untuk menggambar ulang grafik
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getYearlyFinancialData', year: parseInt(tahun) }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            }).then(res=>res.json()).then(result => {
                if (result.status === 'success') {
                    renderKeuanganChartAndTotals(result.data, tahun);
                }
            });
        });
    });

    // Listener untuk tombol unduh dan bagikan
    document.getElementById('downloadYearlySummaryBtn')?.addEventListener('click', () => downloadOrShareSummary('download'));
    document.getElementById('shareYearlySummaryBtn')?.addEventListener('click', () => downloadOrShareSummary('share'));
	
}

function updateKelompokKeuangan() {
    const jenis = document.querySelector('input[name="jenisTransaksi"]:checked').value;
    const selectKelompok = document.getElementById('kelompokKeuangan');
    selectKelompok.innerHTML = ''; // Kosongkan pilihan

    const kelompokMasuk = ["Infak Langsung", "Infak Bulanan", "Kotak Infak", "SPP", "Jual Sembako", "Keuntungan Usaha"];
    const kelompokKeluar = ["Kebutuhan Anak Yatim", "Kebutuhan Rumah", "Buku/ATK", "Kesehatan dan Pengobatan", "Kebutuhan Rumah Tahfidz", "Transport", "Gaji dan Tunjangan", "Pengembangan Usaha"];
    const options = (jenis === 'Uang Masuk') ? kelompokMasuk : kelompokKeluar;

    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectKelompok.appendChild(option);
    });
}

function handleKeuanganSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Menyimpan...';

    const data = {
        action: 'submitKeuangan',
        tanggal: document.getElementById('tanggalKeuangan').value,
        jenis: document.querySelector('input[name="jenisTransaksi"]:checked').value,
        jumlah: document.getElementById('jumlahKeuangan').value,
        kelompok: document.getElementById('kelompokKeuangan').value,
        keterangan: document.getElementById('keteranganKeuangan').value
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            form.reset();
            updateKelompokKeuangan(); // Reset dropdown ke default
            // Otomatis refresh laporan jika melihat bulan yang sama
            const bulan = (new Date(data.tanggal).getMonth() + 1).toString().padStart(2, '0');
            const tahun = new Date(data.tanggal).getFullYear().toString();
            if (document.getElementById('laporanBulan').value == bulan && document.getElementById('laporanTahun').value == tahun) {
                fetchAndRenderKeuanganReport(tahun, bulan);
            }
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan Transaksi';
    });
}
// === TAMBAHKAN FUNGSI YANG HILANG INI ===
const createTable = (title, data, headers) => {
    let rows = data.map(row => `
        <tr>
            <td class="px-4 py-2 border">${new Date(row[headers.date]).toLocaleDateString('id-ID')}</td>
            <td class="px-4 py-2 border">${row[headers.group]}</td>
            <td class="px-4 py-2 border">${row[headers.desc]}</td>
            <td class="px-4 py-2 border text-right">${(parseFloat(row[headers.amount]) || 0).toLocaleString('id-ID')}</td>
        </tr>
    `).join('');
    return `
        <h4 class="font-bold text-lg ${title.includes('Masuk') ? 'text-green-600' : 'text-red-600'}">${title}</h4>
        <table class="w-full text-sm mt-2 mb-4 border-collapse">
            <thead><tr class="bg-gray-100">
                <th class="px-4 py-2 border text-left">Tanggal</th><th class="px-4 py-2 border text-left">Kelompok</th>
                <th class="px-4 py-2 border text-left">Keterangan</th><th class="px-4 py-2 border text-right">Jumlah</th>
            </tr></thead>
            <tbody>${rows || `<tr><td colspan="4" class="p-4 text-center border">Tidak ada data.</td></tr>`}</tbody>
        </table>`;
};
// GANTI FUNGSI LAMA DENGAN VERSI BARU INI
function fetchAndRenderKeuanganReport(tahun, bulan) {
    const reportContainer = document.getElementById('keuangan-report-container');
    reportContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat laporan bulanan...</p>';
    document.getElementById('yearly-summary-container').classList.add('hidden');
    document.getElementById('daily-transaction-container').innerHTML = ''; // Kosongkan rincian harian

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getLaporanKeuangan', year: parseInt(tahun), month: parseInt(bulan) }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status !== 'success') throw new Error(result.message);

        const l = result.laporan;
        const formatRp = num => `Rp ${num.toLocaleString('id-ID')}`;

        const headerIndexes = { date: 0, group: 2, desc: 3, amount: 4 };
        const tableMasuk = createTable('Rincian Dana Masuk', l.danaMasuk, headerIndexes);
        const tableKeluar = createTable('Rincian Dana Keluar', l.danaKeluar, headerIndexes);

        const reportHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>${tableMasuk}</div>
                <div>${tableKeluar}</div>
            </div>
            <div class="mt-8 p-4 bg-gray-50 rounded-lg border">
                <h4 class="font-bold text-xl mb-4 text-center">Ringkasan Keuangan</h4>
                <div class="space-y-3">
                    <div class="flex justify-between text-gray-700"><span>Saldo Kas Bulan Lalu</span> <span>${formatRp(l.saldoBulanLalu)}</span></div>
                    <div class="flex justify-between text-green-600"><span>Total Dana Masuk Bulan Ini</span> <span>${formatRp(l.totalMasuk)}</span></div>
                    <div class="flex justify-between text-red-600"><span>Total Dana Keluar Bulan Ini</span> <span>-${formatRp(l.totalKeluar)}</span></div>
                    <div class="flex justify-between font-bold border-t pt-2"><span>Selisih Bulan Ini</span> <span>${formatRp(l.selisihBulanIni)}</span></div>
                    <div class="flex justify-between font-bold text-xl text-blue-600 border-t-2 pt-2 mt-2"><span>Sisa Saldo Kas Akhir Bulan Ini</span> <span>${formatRp(l.saldoAkhirBulanIni)}</span></div>
                </div>
            </div>`;
        reportContainer.innerHTML = reportHTML;

        const selectedDate = document.getElementById('tanggalKeuangan').value;
        const allMonthData = l.danaMasuk.concat(l.danaKeluar);
        renderDailyTransactions(allMonthData, selectedDate);

        return fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getYearlyFinancialData', year: parseInt(tahun) }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
    })
    .then(res => res.json())
    .then(result => {
        if (result.status !== 'success') throw new Error(result.message);
        document.getElementById('yearly-summary-container').classList.remove('hidden');
        renderKeuanganChartAndTotals(result.data, tahun);
    })
    .catch(error => {
        reportContainer.innerHTML = `<p class="p-8 text-center text-red-600 bg-red-50 rounded-lg">Gagal memuat laporan: ${error.message}</p>`;
    });
}

let keuanganChartInstance = null;
function renderKeuanganChartAndTotals(yearlyData, year) {
    const groupTotalsContainer = document.getElementById('group-totals-container');
    const chartType = document.querySelector('input[name="chartType"]:checked').value;
    const ctx = document.getElementById('keuanganChart').getContext('2d');

    // Proses data tahunan
    const monthlyTotals = Array(12).fill(0).map(() => ({ masuk: 0, keluar: 0 }));
    const incomeGroups = {};
    const expenseGroups = {};

    yearlyData.forEach(row => {
        const date = new Date(row[0]);
        const month = date.getMonth(); // 0-11
        const jenis = row[1];
        const kelompok = row[2];
        const jumlah = parseFloat(row[4]) || 0;

        if (jenis === 'Uang Masuk') {
            monthlyTotals[month].masuk += jumlah;
            incomeGroups[kelompok] = (incomeGroups[kelompok] || 0) + jumlah;
        } else if (jenis === 'Uang Keluar') {
            monthlyTotals[month].keluar += jumlah;
            expenseGroups[kelompok] = (expenseGroups[kelompok] || 0) + jumlah;
        }
    });

    // Tampilkan total per kelompok
    let totalsHTML = '<h4 class="font-bold mb-2">Total per Kelompok Tahun ' + year + '</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">';
    totalsHTML += '<div><span class="font-semibold block">Dana Masuk</span>';
    for(const key in incomeGroups) totalsHTML += `<div class="flex justify-between"><span>${key}</span><span>${incomeGroups[key].toLocaleString('id-ID')}</span></div>`;
    totalsHTML += '</div><div><span class="font-semibold block">Dana Keluar</span>';
    for(const key in expenseGroups) totalsHTML += `<div class="flex justify-between"><span>${key}</span><span>${expenseGroups[key].toLocaleString('id-ID')}</span></div>`;
    totalsHTML += '</div></div>';
    groupTotalsContainer.innerHTML = totalsHTML;

    // Atur data untuk grafik
    let chartConfig;
    const monthLabels = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];

    if (chartType === 'income_expense') {
        chartConfig = {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [
                    { label: 'Dana Masuk', data: monthlyTotals.map(m => m.masuk), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                    { label: 'Dana Keluar', data: monthlyTotals.map(m => m.keluar), backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                ]
            }
        };
    } else if (chartType === 'income_groups') {
        chartConfig = {
            type: 'doughnut',
            data: {
                labels: Object.keys(incomeGroups),
                datasets: [{ data: Object.values(incomeGroups) }]
            }
        };
    } else { // expense_groups
        chartConfig = {
            type: 'doughnut',
            data: {
                labels: Object.keys(expenseGroups),
                datasets: [{ data: Object.values(expenseGroups) }]
            }
        };
    }

    chartConfig.options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } };

    if (keuanganChartInstance) keuanganChartInstance.destroy();
    keuanganChartInstance = new Chart(ctx, chartConfig);
}

// === TAMBAHKAN SEMUA FUNGSI BARU DI BAWAH INI ===

// Baca tanggal terakhir dari localStorage, atau gunakan tanggal hari ini jika tidak ada
let lastKeuanganDate = localStorage.getItem('lastKeuanganDate') || new Date().toISOString().slice(0, 10);

// === GANTI SELURUH FUNGSI INI ===
function addKeuanganInputRow() {
    const tbody = document.getElementById('keuangan-input-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'keuangan-input-row';
    // Hapus atribut oninput dari HTML
    newRow.innerHTML = `
        <td class="border p-1"><input type="text" class="w-full p-2 border-gray-300 rounded" placeholder="Keterangan transaksi..."></td>
        <td class="border p-1"><input type="number" step="500" class="w-full p-2 border-gray-300 rounded" placeholder="0"></td>
        <td class="border p-1"><input type="number" step="500" class="w-full p-2 border-gray-300 rounded" placeholder="0"></td>
        <td class="border p-1"><select class="w-full p-2 border-gray-300 rounded bg-white"></select></td>
        <td class="border p-1 text-center"><button class="text-red-500 hover:text-red-700 font-bold">X</button></td>
    `;
    tbody.appendChild(newRow);

    // Pasang event listener menggunakan JavaScript
    const masukInput = newRow.querySelector('td:nth-child(2) input');
    const keluarInput = newRow.querySelector('td:nth-child(3) input');

    masukInput.addEventListener('input', () => handleAmountInput(masukInput, 'masuk'));
    keluarInput.addEventListener('input', () => handleAmountInput(keluarInput, 'keluar'));

    updateKelompokForRow(newRow); // Isi dropdown untuk baris baru

    newRow.querySelector('button').addEventListener('click', () => newRow.remove());
}

function handleAmountInput(inputElement, type) {
    const row = inputElement.closest('tr');
    const masukInput = row.querySelector('td:nth-child(2) input');
    const keluarInput = row.querySelector('td:nth-child(3) input');

    if (type === 'masuk' && inputElement.value > 0) {
        keluarInput.value = '';
    } else if (type === 'keluar' && inputElement.value > 0) {
        masukInput.value = '';
    }
    updateKelompokForRow(row);
}

function updateKelompokForRow(row) {
    const masukValue = row.querySelector('td:nth-child(2) input').value;
    const keluarValue = row.querySelector('td:nth-child(3) input').value;
    const selectEl = row.querySelector('select');
    selectEl.innerHTML = '';

    const kelompokMasuk = ["Infak Langsung", "Infak Bulanan", "Kotak Infak", "SPP", "Jual Sembako", "Keuntungan Usaha"];
    const kelompokKeluar = ["Kebutuhan Anak Yatim", "Kebutuhan Rumah", "Buku/ATK", "Kesehatan dan Pengobatan", "Kebutuhan Rumah Tahfidz", "Transport", "Gaji dan Tunjangan", "Pengembangan Usaha"];

    let options = [];
    if (keluarValue > 0) {
    options = kelompokKeluar;
} else { 
    options = kelompokMasuk;
}

    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectEl.appendChild(option);
    });
}

function handleSaveKeuangan() {
    const tanggal = document.getElementById('tanggalKeuangan').value;
    const rows = document.querySelectorAll('.keuangan-input-row');
    const transactions = [];

    rows.forEach(row => {
        const keterangan = row.querySelector('td:nth-child(1) input').value.trim();
        const masuk = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
        const keluar = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
        const kelompok = row.querySelector('select').value;

        if (keterangan && (masuk > 0 || keluar > 0)) {
            transactions.push({
                tanggal: tanggal,
                jenis: masuk > 0 ? 'Uang Masuk' : 'Uang Keluar',
                jumlah: masuk > 0 ? masuk : keluar,
                kelompok: kelompok,
                keterangan: keterangan
            });
        }
    });

    if (transactions.length === 0) {
        showMessage('Tidak ada data valid untuk disimpan.', 'error');
        return;
    }

    const saveBtn = document.getElementById('saveKeuanganBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'submitKeuanganBatch', transactions: transactions }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            lastKeuanganDate = tanggal; // Simpan tanggal terakhir
            document.getElementById('keuangan-input-tbody').innerHTML = ''; // Kosongkan tabel
            addKeuanganInputRow(); // Tambah satu baris baru
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan Semua';
    });
}
// === SAMPAI DI SINI ===

// === TAMBAHKAN FUNGSI BARU INI ===
function handleSetDefaultDate() {
    const tanggalInput = document.getElementById('tanggalKeuangan');
    if (!tanggalInput.value) {
        showMessage('Silakan pilih tanggal terlebih dahulu.', 'error');
        return;
    }
    lastKeuanganDate = tanggalInput.value;
    localStorage.setItem('lastKeuanganDate', lastKeuanganDate); // Simpan ke localStorage
    showMessage(`Tanggal default diatur ke ${new Date(lastKeuanganDate + 'T00:00:00').toLocaleDateString('id-ID')}`, 'success');

    document.getElementById('tampilkanLaporanKeuanganBtn').click();
}

// FUNGSI BARU UNTUK MENGUNDUH SLIP GAJI SEBAGAI PDF
function downloadSlipPDF() {
    const slipNode = document.getElementById('slipGajiContent'); // Kita akan tambahkan ID ini nanti
    if (!slipNode) return;

    const namaKaryawan = slipNode.dataset.nama;
    const periode = slipNode.dataset.periode;
    const fileName = `Slip Gaji - ${namaKaryawan} - ${periode}.pdf`;

    html2canvas(slipNode, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(fileName);
    });
}


// GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU INI
function showPage(hash) {
    // Selalu sembunyikan semua bagian dulu
    document.querySelectorAll('.page-section').forEach(sec => sec.classList.add('hidden'));
	
	
    // =======================================================
    // === BLOK PRIORITAS KHUSUS UNTUK KRS & KHS ===
    // =======================================================
    if (hash === '#krs' || hash === '#khs') {
	
	// Cek apakah fungsi-fungsi penting (seperti handleKrsClick) sudah siap.
    // Jika belum, jalankan inisialisasi satu kali.
    if (!isSistemInformasiInitialized) {
        initializeSistemInformasi();
    }
    // --- AKHIR PENAMBAHAN KODE ---
	
        const santriSection = document.getElementById('santri');
        if (santriSection) {
            // 1. Tampilkan kontainer utama untuk santri
            santriSection.classList.remove('hidden');

            // 2. Jalankan logika untuk menampilkan form pilihan
            const session = getActiveSession();
            if (session && session.userData && (session.userData.jabatan || '').trim().toLowerCase() === 'santri') {
                if (session && session.userData && (session.userData.jabatan || '').trim().toLowerCase() === 'santri') {
    const loggedInSantriName = session.userData.profileName;
    
    // Cari data lengkap santri di dalam appData berdasarkan nama
    const santriData = appData.santri.find(s => s.nama === loggedInSantriName);
    
    // Ambil data kelompok dari hasil pencarian
    const kelompokSantri = santriData ? santriData.grup : 'Data tidak ditemukan';

    document.getElementById('santri-selection-container').classList.remove('hidden');
    document.getElementById('santri-selector-name').textContent = `: ${loggedInSantriName}`;
    document.getElementById('santri-selector-group').textContent = `: ${kelompokSantri}`; // Tampilkan data kelompok yang benar

    const monthSelector = document.getElementById('santri-month-selector');
    if (monthSelector.options.length === 0) {
        const months = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = month;
            monthSelector.appendChild(option);
        });
    }
    
    const showReportBtn = document.getElementById('show-report-btn');
    showReportBtn.classList.remove('krs-btn-color', 'khs-btn-color');
    if (hash === '#krs') {
        showReportBtn.textContent = 'Tampilkan KRS';
        showReportBtn.dataset.reportType = 'krs';
        showReportBtn.classList.add('krs-btn-color');
    } else {
        showReportBtn.textContent = 'Tampilkan KHS';
        showReportBtn.dataset.reportType = 'khs';
        showReportBtn.classList.add('khs-btn-color');
    }
}
                
                // 3. Pastikan kontainer hasil disembunyikan pada awalnya
                document.getElementById('krs-container').classList.add('hidden');
                document.getElementById('khs-container').classList.add('hidden');
            }
        }
        return; // <-- PENTING: Hentikan fungsi di sini agar tidak menjalankan kode lain di bawah
    }

    // =======================================================
    // === LOGIKA STANDAR UNTUK SEMUA HALAMAN LAINNYA ===
    // =======================================================
    const targetHash = (hash === '' || hash === '#') ? '#beranda' : hash;
    const sectionToShow = document.querySelector(targetHash);

    if (sectionToShow) {
        sectionToShow.classList.remove('hidden');
        // Kode asli Anda untuk menangani halaman lain (absensi, sistem-informasi, dll.)
        if (targetHash === '#roster-kbm' && !isSistemInformasiInitialized) {
            initializeSistemInformasi();
        } else if (targetHash === '#absensi') {
            const session = getActiveSession();
            const name = (session && session.userData) ? session.userData.profileName : "Anda harus login";
            const jabatan = (session && session.userData) ? session.userData.jabatan || '' : "Anda harus login";
            document.getElementById('teacherNameDisplay').value = name;
            document.getElementById('stafNameDisplay').value = name;
            document.getElementById('rapatNameDisplay').value = name;
            document.getElementById('jabatanStaf').value = jabatan;
            populateTeacherClasses(session, document.getElementById('attendanceDateGuru').value);
            if (session && session.loggedIn) {
                fetchAndRenderAttendanceHistory(session.userData.profileName);
            }
        } else if (targetHash === '#musyrif') {
            const session = getActiveSession();
            if (session && session.loggedIn && session.userData.jabatan === 'Musyrif') {
                populateSantriDropdowns('musyrif');
                setupMusyrifEventListeners('musyrif');
                fetchAndRenderDailyReports('musyrif');
                document.querySelectorAll('#musyrif input[type="date"]').forEach(input => input.value = new Date().toISOString().slice(0, 10));
            }
        } else if (targetHash === '#musyrifah') {
             const session = getActiveSession();
            if (session && session.loggedIn && session.userData.jabatan === 'Musyrifah') {
                populateSantriDropdowns('musyrifah');
                setupMusyrifEventListeners('musyrifah');
                fetchAndRenderDailyReports('musyrifah');
                document.querySelectorAll('#musyrifah input[type="date"]').forEach(input => input.value = new Date().toISOString().slice(0, 10));
            }
        } else if (targetHash === '#laporan') {
            const session = getActiveSession();
            const userJabatan = (session && session.userData) ? session.userData.jabatan : '';
            if (session && session.loggedIn && (userJabatan === 'Kepala' || userJabatan === 'Waka Kurikulum' || userJabatan === 'Kepala Rumah Anak Yatim' || userJabatan === 'Kepala Rumah Tahfidz Quran')) {
                const datePicker = document.getElementById('laporanTanggal');
                if (!datePicker.dataset.listenerAttached) {
                    datePicker.addEventListener('change', (e) => {
                        fetchAndRenderTahfidzReport(e.target.value);
                    });
                    datePicker.dataset.listenerAttached = 'true';
                }
                datePicker.value = new Date().toISOString().slice(0, 10);
                fetchAndRenderTahfidzReport(datePicker.value);
            }
        } else if (targetHash === '#slip-gaji') {
            const session = getActiveSession();
            if (session && session.loggedIn) {
                const userJabatan = session.userData.jabatan || '';
                const isAdmin = (session.username === 'aria' || session.username === 'wawan' || session.username === 'admin');
                const employeeSelector = document.getElementById('employeeSelectorContainer');
                
                populateMonthYearDropdowns(document.getElementById('monthSelectNew'), document.getElementById('yearSelect'));

                if (isAdmin) {
                    employeeSelector.classList.remove('hidden');
                    populateEmployeeDropdown();
                } else {
                    employeeSelector.classList.add('hidden');
                }
                
                const showBtn = document.getElementById('showSlipGajiBtn');
                if (!showBtn.dataset.listenerAttached) {
                    showBtn.addEventListener('click', fetchAndRenderSlipGaji);
                    showBtn.dataset.listenerAttached = 'true';
                }
            }
        } else if (targetHash === '#laporan-keuangan') {
            const session = getActiveSession();
            const allowedUsers = ['mia', 'wawan', 'aria', 'yeni', 'admin'];
            if (session && session.loggedIn && allowedUsers.includes(session.username)) {
                setupKeuanganEventListeners();
                const bulanSelect = document.getElementById('laporanBulan');
                const tahunSelect = document.getElementById('laporanTahun');
                if (bulanSelect.options.length === 0) {
                    populateMonthYearDropdowns(bulanSelect, tahunSelect);
                }
                const formContainer = document.getElementById('keuangan-form-container');
                const tableContainer = document.getElementById('keuangan-input-table-container');
                const tanggalInput = document.getElementById('tanggalKeuangan');
                formContainer.classList.remove('hidden');
                tanggalInput.value = lastKeuanganDate;
                if (session.username === 'mia') {
                    tableContainer.classList.remove('hidden');
                    if (document.getElementById('keuangan-input-tbody').children.length === 0) {
                        addKeuanganInputRow();
                    }
                } else {
                    tableContainer.classList.add('hidden');
                }
                if (!tanggalInput.dataset.listenerAttached) {
                    tanggalInput.addEventListener('change', () => {
                        if (session.username === 'mia') {
                            tableContainer.classList.remove('hidden');
                            if (document.getElementById('keuangan-input-tbody').children.length === 0) {
                                addKeuanganInputRow();
                            }
                        }
                        document.getElementById('tampilkanLaporanKeuanganBtn').click();
                    });
                    tanggalInput.dataset.listenerAttached = 'true';
                }
                setupKeuanganEventListeners();
                document.getElementById('tampilkanLaporanKeuanganBtn').click();
            }
        }
else if (targetHash === '#halaman-guru') {
    setupHalamanGuru();
}
    } else {
        // Jika tidak ada hash atau hash tidak ditemukan, tampilkan beranda
        document.getElementById('beranda').classList.remove('hidden');
    }
}


    function showLoggedInView(userData) {
        ui.loginButton.classList.add('hidden');
        ui.attendanceNav.classList.remove('hidden');
        ui.sistemInformasiNav.classList.remove('hidden');
        ui.kalenderPendidikan.classList.remove('hidden');
        if (userData && userData.profileName) {
            ui.userProfileName.textContent = userData.profileName;
            ui.navProfilePic.src = userData.profilePicture || 'https://placehold.co/80x80/e9ecef/343a40?text=F';
            ui.navProfilePic.onerror = () => { ui.navProfilePic.src = 'https://placehold.co/80x80/e9ecef/343a40?text=E'; };
        } else {
            ui.userProfileName.textContent = `Hi, Pengguna`;
            ui.navProfilePic.src = 'https://placehold.co/80x80/e9ecef/343a40?text=F';
        }
        ui.userProfile.classList.remove('hidden');
		const adminUsers = ['mia', 'wawan', 'admin'];
document.getElementById('inputSoalNav').classList.toggle('hidden', !adminUsers.includes(userData.username));
		// === GANTI SEMUA IF/ELSE NAVIGASI DENGAN BLOK INI ===
const session = getActiveSession();
if (session && session.loggedIn) {
    const username = session.username;
    const jabatan = session.userData.jabatan || '';
    // PERUBAHAN: Membuat pengecekan jabatan 'Santri' tidak sensitif terhadap huruf besar/kecil dan spasi
    const isSantri = (jabatan || '').trim().toLowerCase() === 'santri';

    // KOMENTAR: Variabel-variabel ini digunakan untuk menentukan peran selain santri
    const isKepalaOrWaka = jabatan === 'Kepala Rumah Anak Yatim' || jabatan === 'Kepala Rumah Tahfidz' || jabatan === 'Waka Kurikulum';
    const isMusyrif = jabatan === 'Musyrif';
    const isMusyrifah = jabatan === 'Musyrifah';
    const financeUsers = ['mia', 'wawan', 'aria', 'yeni', 'admin'];
    const karyawanUsers = ['wawan', 'admin', 'aria', 'yeni', 'mia', 'zhofri', 'erwan', 'mahadi', 'zaidun', 'yanti', 'ryza', 'reza', 'uswah', 'erma'];
	const isGuru = (userData.jabatan || '').trim().toLowerCase() === 'guru';
	const canAccessBankSoal = isGuru || userData.username === 'mia' || userData.username === 'wawan' || userData.username === 'admin';
	document.getElementById('halamanGuruNav').classList.toggle('hidden', !canAccessBankSoal);
    // PERUBAHAN: Logika untuk menampilkan/menyembunyikan menu utama berdasarkan peran Santri
    document.getElementById('attendanceNav').classList.toggle('hidden', isSantri);
    document.getElementById('ujianOnlineNav').classList.toggle('hidden', !isSantri);

    // PERUBAHAN: Logika untuk menampilkan dropdown Sistem Informasi jika user memiliki akses ke salah satu sub-menunya
    const showDropdown = isSantri || isKepalaOrWaka || isMusyrif || isMusyrifah || financeUsers.includes(username) || karyawanUsers.includes(username);
    document.getElementById('sistemInformasiDropdown').classList.toggle('hidden', !showDropdown);
    
    // KOMENTAR: Kode ini mengatur visibilitas setiap sub-menu di dalam dropdown
    document.getElementById('krsNav').classList.toggle('hidden', !isSantri);
    document.getElementById('khsNav').classList.toggle('hidden', !isSantri);
    document.getElementById('slipGajiNav').classList.toggle('hidden', !karyawanUsers.includes(username));
    document.getElementById('laporanKeuanganNav').classList.toggle('hidden', !financeUsers.includes(username));
    document.getElementById('laporanNav').classList.toggle('hidden', !isKepalaOrWaka);
    document.getElementById('musyrifNav').classList.toggle('hidden', !isMusyrif);
    document.getElementById('musyrifahNav').classList.toggle('hidden', !isMusyrifah);
}
		

        if (window.location.hash === '#login') { window.location.hash = '#beranda'; }
    }

    function showLoggedOutView() {
        ui.loginButton.classList.remove('hidden');
        ui.userProfile.classList.add('hidden');
        ui.attendanceNav.classList.add('hidden');
        ui.sistemInformasiNav.classList.add('hidden');
        ui.kalenderPendidikan.classList.add('hidden');
        document.getElementById('pengunjung-hari-ini')?.classList.add('hidden'); // Sembunyikan saat logout
		document.getElementById('musyrifNav').classList.add('hidden');
		document.getElementById('musyrifahNav').classList.add('hidden');
		document.getElementById('laporanNav').classList.add('hidden');
		document.getElementById('slipGajiNav').classList.add('hidden');
		document.getElementById('laporanKeuanganNav').classList.add('hidden');
		document.getElementById('sistemInformasiDropdown').classList.add('hidden');
        localStorage.removeItem('userSession');
        sessionStorage.removeItem('userSession');
        const protectedHashes = ['#absensi', '#profile', '#sistem-informasi'];
        if (protectedHashes.includes(window.location.hash)) { window.location.hash = '#beranda'; }
    }

    function logUserVisit() {
        const session = getActiveSession();
        if (session && session.loggedIn) {
            const data = {
                action: 'logVisit',
                username: session.username,
				dateString: getClientDateString()
            };
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(result => {
                if(result.status !== 'success') {
                    console.error("Gagal mencatat kunjungan:", result.message);
                }
            })
            .catch(error => console.error('Error saat mencatat kunjungan:', error));
        }
    }

    function fetchDailyVisitors() {
        const data = { action: 'getTodaysVisitors', dateString: getClientDateString() };
        const visitorSection = document.getElementById('pengunjung-hari-ini');
        const visitorContainer = document.getElementById('visitor-list-container');
        if (!visitorSection || !visitorContainer) return;

        fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(res => res.json())
        .then(result => {
            // Selalu tampilkan section setelah fetch berhasil
            visitorSection.classList.remove('hidden'); 
            if (result.status === 'success' && result.visitors.length > 0) {
                let listHtml = '<ul id="visitor-list">';
                result.visitors.forEach(visitorName => {
                    listHtml += `<li>${visitorName}</li>`;
                });
                listHtml += '</ul>';
                visitorContainer.innerHTML = listHtml;
            } else {
                // Tampilkan pesan jika tidak ada pengunjung
                visitorContainer.innerHTML = '<p>Belum ada pengguna yang aktif hari ini.</p>';
            }
        })
        .catch(error => {
            console.error('Gagal mengambil data pengunjung:', error);
            // Tampilkan section dan pesan error jika fetch gagal
            visitorSection.classList.remove('hidden'); 
            visitorContainer.innerHTML = '<p>Gagal memuat data pengunjung.</p>';
        });
    }

// KOMENTAR: Fungsi baru untuk menangani tombol "Tampilkan" KRS/KHS
function setupSantriSelectorListeners() {
    const showReportBtn = document.getElementById('show-report-btn');
    if (!showReportBtn) return;

    showReportBtn.addEventListener('click', () => {
        const reportType = showReportBtn.dataset.reportType;
        const selectedMonth = document.getElementById('santri-month-selector').value;
        
        // KOMENTAR: Klik tab bulan yang sesuai secara programatik untuk memastikan data benar
        const tabToClick = document.getElementById(`tab-bulan${selectedMonth}`);
        if (tabToClick) {
            tabToClick.click();
        } else {
            showMessage('Bulan yang dipilih tidak valid.', 'error');
            return;
        }

        // Panggil fungsi untuk menampilkan laporan
        const session = getActiveSession();
        if (reportType === 'krs') {
            handleKrsClick(null, session.userData);
        } else {
            handleKhsClick(null, session.userData);
        }

        // Sembunyikan kembali kontainer pilihan
        document.getElementById('santri-selection-container').classList.add('hidden');
    });
}


    function renderNewsCards() { const container = document.getElementById('news-container'); if (container) container.innerHTML = appData.news.map(item => `<div class="card"><img src="${item.img}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/FFFFFF?text=Error';"><div class="card-content"><h3>${item.title}</h3><p class="meta">${item.meta}</p><p>${item.desc}</p></div></div>`).join(''); }
    function renderGalleryCards() { const container = document.getElementById('gallery-container'); if (container) container.innerHTML = appData.gallery.map(item => `<div class="card"><img src="${item.img}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/FFFFFF?text=Error';"><div class="card-content"><h3>${item.title}</h3><p>${item.desc}</p></div></div>`).join(''); }
    function fetchMarqueeText() { const session = getActiveSession(); const isLoggedIn = !!(session && session.loggedIn); const data = { action: 'getMarqueeText', isLoggedIn: isLoggedIn }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.ok ? res.json() : Promise.reject(res)).then(result => { if (result.status === 'success' && result.text && result.text.trim() !== '') { const textContent = ` ${result.text}  `; ui.marqueeText.textContent = textContent.repeat(10); ui.marqueeContainer.classList.remove('hidden'); } else { ui.marqueeContainer.classList.add('hidden'); } }).catch(error => { console.error('Error fetching marquee text:', error); ui.marqueeContainer.classList.add('hidden'); }); }
    
    function renderDynamicCalendar(startYear, startMonth, numMonths) {
        if (!ui.dynamicCalendarGrid) return;
        ui.dynamicCalendarGrid.innerHTML = '';
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        let currentYear = startYear; let currentMonth = startMonth - 1;
        for (let i = 0; i < numMonths; i++) {
            const monthDate = new Date(currentYear, currentMonth, 1);
            const monthName = monthNames[monthDate.getMonth()];
            const year = monthDate.getFullYear();
            const firstDay = monthDate.getDay();
            const daysInMonth = new Date(year, monthDate.getMonth() + 1, 0).getDate();
            let monthHtml = `<div class="calendar-month"><h3 class="font-bold text-lg text-center mb-4 text-gray-700">${monthName} ${year}</h3><div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-semibold mb-2"><div class="holiday">Mgg</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div></div><div class="grid grid-cols-7 gap-1 text-center text-sm">`;
            for (let j = 0; j < firstDay; j++) { monthHtml += `<div></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(monthDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayClasses = 'py-1 relative';
                if (new Date(dateStr).getDay() === 0) dayClasses += ' holiday';
                if (dateStr === todayStr) dayClasses += ' today';
                appData.calendarEvents.forEach(event => { const eventStartDate = new Date(event.date); const eventEndDate = new Date(eventStartDate); if (event.span) { eventEndDate.setDate(eventStartDate.getDate() + event.span - 1); } const currentDate = new Date(dateStr); if (currentDate >= eventStartDate && currentDate <= eventEndDate) { dayClasses += ` rounded-md ${event.color}`; } });
                monthHtml += `<div class="${dayClasses}" data-date="${dateStr}">${day}</div>`;
            }
            monthHtml += `</div><div class="mt-auto pt-3 border-t text-xs space-y-2">`;
            const monthEvents = appData.calendarEvents.filter(e => new Date(e.date).getMonth() === monthDate.getMonth() && new Date(e.date).getFullYear() === year);
            const uniqueEvents = [...new Map(monthEvents.map(item => [item.title, item])).values()];
            uniqueEvents.forEach(event => {
                const startDate = new Date(event.date); let legendText;
                if (event.span && event.span > 1) { const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + event.span - 1); if(startDate.getMonth() !== endDate.getMonth()) { legendText = `${startDate.getDate()} ${monthNames[startDate.getMonth()]} - ${endDate.getDate()} ${monthNames[endDate.getMonth()]}: ${event.title}`; } else { legendText = `${startDate.getDate()}-${endDate.getDate()}: ${event.title}`; } } else { legendText = `${startDate.getDate()}: ${event.title}`; }
                if (event.color === 'holiday') { monthHtml += `<div class="flex items-center"><span class="holiday">${legendText}</span></div>`; } else if (event.color) { monthHtml += `<div class="flex items-center"><span class="w-3 h-3 rounded-sm mr-2 ${event.color}"></span><span>${legendText}</span></div>`; } else { monthHtml += `<div class="flex items-center"><span>${legendText}</span></div>`; }
            });
            monthHtml += `</div></div>`;
            ui.dynamicCalendarGrid.innerHTML += monthHtml;
            currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        }
    }

    function setupSlideshow() {
        if (!ui.slideshowContainer) return;
        appData.heroImages.forEach((img, index) => {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slide.style.backgroundImage = `url('${img}')`;
            if (index === 0) slide.classList.add('active');
            ui.slideshowContainer.appendChild(slide);
        });
        let currentSlide = 0;
        const slides = ui.slideshowContainer.querySelectorAll('.slide');
        setInterval(() => {
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }, 5000);
    }
    
    function populateTeacherClasses(session, selectedDateStr, targetTeacherName = null) {
        const selectedDate = new Date(selectedDateStr + 'T00:00:00'); 
        const dayIndex = selectedDate.getDay();
        const daysInIndonesian = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const currentDayName = daysInIndonesian[dayIndex];
        const classNameSelect = document.getElementById('className');
        
        classNameSelect.innerHTML = '<option value="">Memuat kelas...</option>';
        
        const teacherName = targetTeacherName || (session && session.userData ? session.userData.profileName : null);
        if (teacherName) {
            let taughtClasses = new Set();
            for (const monthKey in appData.schedules) {
                appData.schedules[monthKey].forEach(scheduleItem => {
                    if (scheduleItem.teacher === teacherName && scheduleItem.day === currentDayName) {
                        taughtClasses.add(scheduleItem.subject);
                    }
                });
            }
            classNameSelect.innerHTML = '';
            if (taughtClasses.size > 0) {
                classNameSelect.innerHTML = '<option value="">Pilih Kelas...</option>';
                taughtClasses.forEach(subject => {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    classNameSelect.appendChild(option);
                });
            } else {
                classNameSelect.innerHTML = '<option value="">Tidak ada jadwal mengajar pada tanggal ini</option>';
            }
        } else {
            classNameSelect.innerHTML = '<option value="">Silakan login terlebih dahulu</option>';
        }
    }

    function populateSubstituteTeachers() {
        const selectElement = document.getElementById('substituteTeacherName');
        if (!selectElement) return;
        const session = getActiveSession();
        const currentTeacherName = (session && session.userData) ? session.userData.profileName : '';
        selectElement.innerHTML = '<option value="">Pilih Guru...</option>'; 
        appData.teachers.forEach(teacher => {
            if (teacher.name !== currentTeacherName) {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                selectElement.appendChild(option);
            }
        });
    }
    
function handleLoginSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = "Memeriksa...";
    submitBtn.disabled = true;

    const data = {
        action: 'login',
        username: form.username.value,
        password: form.password.value
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(result => {
        if (result.status === "success" && result.userData) {
            showMessage("Login berhasil!", 'success');
            const sessionData = { loggedIn: true, username: result.userData.username, userData: result.userData };
            if (document.getElementById('remember').checked) {
                localStorage.setItem('userSession', JSON.stringify(sessionData));
            } else {
                sessionStorage.setItem('userSession', JSON.stringify(sessionData));
            }

            // LANGSUNG JALANKAN FUNGSI YANG DIPERLUKAN, BUKAN initializeApp()
            showLoggedInView(result.userData);
            logUserVisit();
            fetchDailyVisitors();
            fetchMarqueeText(); // Panggil juga ini agar teks berjalan update

        } else {
            showMessage(result.message || "Username atau password salah.", 'error');
        }
    })
    .catch(error => {
        console.error('Login Error:', error);
        showMessage(`Gagal terhubung.`, 'error');
    })
    .finally(() => {
        submitBtn.textContent = "Masuk";
        submitBtn.disabled = false;
    });
}
    function handleLogout() { document.getElementById('profileModal').style.display = 'none'; showLoggedOutView(); fetchMarqueeText(); showMessage("Anda telah berhasil logout.", "success"); }
    function openProfileModal() { const session = getActiveSession(); if (session && session.userData) { const ud = session.userData; document.getElementById('profileName').value = ud.profileName || ''; document.getElementById('profileDob').value = ud.dob || ''; document.getElementById('profileAddress').value = ud.address || ''; document.getElementById('profileJabatan').value = ud.jabatan || ''; document.getElementById('profileJabatan').readOnly = true; document.getElementById('profileUsername').value = ud.username || ''; const preview = document.getElementById('profilePicturePreview'); preview.src = ud.profilePicture || 'https://placehold.co/128x128/e9ecef/343a40?text=F'; preview.onerror = () => { preview.src = 'https://placehold.co/128x128/e9ecef/343a40?text=E'; }; document.getElementById('profileModal').style.display = 'block'; } else { showMessage('Data profil tidak ditemukan.', 'error'); } }
    async function handleProfileSubmit(event) { event.preventDefault(); const submitBtn = event.target.querySelector('button[type="submit"]'); const file = document.getElementById('profilePictureInput').files[0]; const sendProfileDataToSheet = (imageUrl) => { submitBtn.textContent = "Menyimpan..."; const session = getActiveSession(); const data = { action: 'updateProfile', username: session.username, profileName: profileName.value, dob: profileDob.value, address: profileAddress.value, jabatan: profileJabatan.value, profilePicture: imageUrl }; if (!imageUrl) { delete data.profilePicture; } fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if(result.status === 'success' && result.updatedData) { showMessage('Profil berhasil diperbarui!', 'success'); session.userData = result.updatedData; if (localStorage.getItem('userSession')) { localStorage.setItem('userSession', JSON.stringify(session)); } else { sessionStorage.setItem('userSession', JSON.stringify(session)); } showLoggedInView(result.updatedData); document.getElementById('profileModal').style.display = 'none'; } else { showMessage(result.message || 'Gagal update.', 'error'); } }).catch(error => { console.error('Profile Update Error:', error); showMessage('Koneksi error.', 'error'); }).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }; submitBtn.disabled = true; if (file) { if (typeof imageCompression !== 'function') { showMessage('Library kompresi error.', 'error'); submitBtn.disabled = false; return; } const options = { maxSizeMB: 0.29, maxWidthOrHeight: 1024, useWebWorker: true, onProgress: (p) => { submitBtn.textContent = `Mengompres... ${Math.round(p)}%`; }, }; try { const compressedFile = await imageCompression(file, options); submitBtn.textContent = "Mengunggah..."; const formData = new FormData(); formData.append('file', compressedFile, file.name); formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET); const cloudinaryResponse = await fetch(CONFIG.CLOUDINARY_URL, { method: 'POST', body: formData }); if (!cloudinaryResponse.ok) { throw new Error(`Upload error: ${cloudinaryResponse.status}`); } const cloudinaryData = await cloudinaryResponse.json(); if (cloudinaryData.secure_url) { sendProfileDataToSheet(cloudinaryData.secure_url); } else { throw new Error('URL Cloudinary tidak ditemukan.'); } } catch (error) { console.error('Image Upload Error:', error); showMessage(`Error unggah foto: ${error.message}`, 'error'); submitBtn.textContent = "Simpan"; submitBtn.disabled = false; } } else { sendProfileDataToSheet(null); } }
    function handleChangePasswordSubmit(event) { event.preventDefault(); const newPassword = document.getElementById('newPassword').value; if (newPassword.length < 6) { showMessage('Password minimal 6 karakter.', 'error'); return; } if (newPassword !== document.getElementById('confirmNewPassword').value) { showMessage('Konfirmasi password tidak cocok.', 'error'); return; } const session = getActiveSession(); if (!session || !session.loggedIn) { showMessage('Sesi tidak valid.', 'error'); return; } const data = { action: 'changePassword', username: session.username, currentPassword: document.getElementById('currentPassword').value, newPassword: newPassword }; const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Menyimpan..."; submitBtn.disabled = true; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { showMessage('Password berhasil diubah.', 'success'); document.getElementById('changePasswordModal').style.display = "none"; event.target.reset(); } else { showMessage(result.message || 'Gagal ubah password.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }
    function handleForgotVerifySubmit(event) { event.preventDefault(); const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Memeriksa..."; submitBtn.disabled = true; const data = { action: 'verifyUser', username: document.getElementById('forgotUsername').value, dob: document.getElementById('forgotDob').value }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { window.verifiedUsername = data.username; document.getElementById('forgotPasswordStep1').classList.add('hidden'); document.getElementById('forgotPasswordStep2').classList.remove('hidden'); } else { showMessage(result.message || 'Verifikasi gagal.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Verifikasi"; submitBtn.disabled = false; }); }
    function handleForgotResetSubmit(event) { event.preventDefault(); const newPassword = document.getElementById('forgotNewPassword').value; if (newPassword.length < 6) { showMessage('Password baru minimal 6 karakter.', 'error'); return; } if (newPassword !== document.getElementById('forgotConfirmPassword').value) { showMessage('Konfirmasi password tidak cocok.', 'error'); return; } const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Menyimpan..."; submitBtn.disabled = true; const data = { action: 'resetPassword', username: window.verifiedUsername, newPassword: newPassword }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { showMessage('Password berhasil direset! Silakan login.', 'success'); document.getElementById('forgotPasswordModal').style.display = 'none'; event.target.reset(); document.getElementById('forgotPasswordStep2').classList.add('hidden'); document.getElementById('forgotPasswordStep1').classList.remove('hidden'); } else { showMessage(result.message || 'Gagal reset password.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }
    function handleAttendanceSubmit(event, role) {
        event.preventDefault();
        const session = getActiveSession();
        if (!session || !session.loggedIn) {
            showMessage('Anda harus login.', 'error');
            window.location.hash = '#login';
            return;
        }
        const form = event.target;
        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.textContent = "Mengirim...";
        submitBtn.disabled = true;
        let data;
        if (role === 'guru') {
            const isSubstitute = form.querySelector('#isSubstituteTeacher').checked;
            const substituteFor = form.querySelector('#substituteTeacherName').value;
            const className = form.querySelector('#className').value;
            const remarksInput = form.querySelector('#remarksGuru');
            if (isSubstitute && (!substituteFor || !className)) {
                showMessage('Silakan pilih guru dan kelas yang Anda gantikan.', 'error');
                submitBtn.disabled = false;
                submitBtn.textContent = `Kirim Absensi Guru`;
                return;
            }
            let finalRemarks = remarksInput.value;
            if (isSubstitute) {
                const substituteRemark = `[Guru Pengganti untuk ${substituteFor} di kelas: ${className}]`;
                finalRemarks = substituteRemark + (finalRemarks ? `\n${finalRemarks}` : '');
            }
            data = { action: 'submitAttendance', role: 'guru', teacherName: session.userData.profileName, attendanceDate: form.querySelector('#attendanceDateGuru').value, className: className, lateMinutes: form.querySelector('#lateMinutesGuru').value || '0', remarks: finalRemarks, substituteFor: isSubstitute ? substituteFor : '' };
        } else if (role === 'staf') {
            data = { action: 'submitAttendance', role: 'staf', stafName: session.userData.profileName, attendanceDate: form.querySelector('#attendanceDateStaf').value, jabatan: form.querySelector('#jabatanStaf').value, lateMinutes: form.querySelector('#lateMinutesStaf').value || '0', remarks: form.querySelector('#remarksStaf').value };
        } else {
            data = { action: 'submitAttendance', role: 'rapat', name: session.userData.profileName, date: form.querySelector('#rapatDate').value, startTime: form.querySelector('#rapatStartTime').value, endTime: form.querySelector('#rapatEndTime').value, remarks: form.querySelector('#rapatRemarks').value };
        }
        fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.ok ? res.json() : Promise.reject(res)).then(result => {if (result.status === "success") {showMessage('Absensi berhasil direkam!', 'success');const namaGuru = form.querySelector('#teacherNameDisplay').value;form.reset();form.querySelector('#teacherNameDisplay').value = namaGuru;setTodayDate();fetchAndRenderAttendanceHistory(session.userData.profileName);} else if (result.status === "duplicate") {showMessage(result.message, 'error');} else {showMessage(result.message || 'Gagal mengirim absensi.', 'error');}}).catch(error => { console.error('Attendance Error:', error); showMessage('Gagal terhubung.', 'error'); }).finally(() => { submitBtn.textContent = `Kirim Absensi ${role.charAt(0).toUpperCase() + role.slice(1)}`; submitBtn.disabled = false; });
    }

// =======================================================
// === FUNGSI-FUNGSI BARU UNTUK FITUR SLIP GAJI ===
// =======================================================

function populateMonthYearDropdowns(monthSelect, yearSelect) {
    monthSelect.innerHTML = '';
    yearSelect.innerHTML = '';

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    monthNames.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = (index + 1).toString().padStart(2, '0');
        option.textContent = month;
        monthSelect.appendChild(option);
    });

    const currentYear = new Date().getFullYear();
    for (let y = 2025; y <= currentYear; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
    }

    monthSelect.value = (new Date().getMonth() + 1).toString().padStart(2, '0');
    yearSelect.value = currentYear;
}

function populateEmployeeDropdown() {
    const employeeSelect = document.getElementById('employeeSelect');
    employeeSelect.innerHTML = '<option value="">Memuat karyawan...</option>';
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getEmployeeList' }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            employeeSelect.innerHTML = '<option value="">Pilih Karyawan...</option>';
            result.employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeSelect.appendChild(option);
            });
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        employeeSelect.innerHTML = `<option value="">${error.message}</option>`;
    });
}

// GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU INI
function fetchAndRenderSlipGaji() {
    const slipContainer = document.getElementById('slipGajiContainer');
    const downloadContainer = document.getElementById('downloadSlipContainer');
    downloadContainer.classList.add('hidden'); // Sembunyikan tombol setiap kali memuat

    const session = getActiveSession();
    const userJabatan = (session && session.userData) ? session.userData.jabatan : '';
    const isAdmin = (session.username === 'aria' || session.username === 'wawan' || session.username === 'admin');
    const targetProfileName = isAdmin ? document.getElementById('employeeSelect').value : session.userData.profileName;
    const selectedMonth = document.getElementById('monthSelectNew').value;
    const selectedYear = document.getElementById('yearSelect').value;
    const targetMonth = `${selectedYear}-${selectedMonth}`;

    if (isAdmin && !targetProfileName) {
        showMessage('Silakan pilih nama karyawan terlebih dahulu.', 'error');
        return;
    }

    slipContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat slip gaji...</p>';

    const data = {
        action: 'getSlipGaji',
        targetProfileName: targetProfileName,
        targetMonth: targetMonth,
        requesterUsername: session.username,
        requesterJabatan: userJabatan
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            const s = result.slip;

            // Fungsi pembulatan
            const roundToHundred = num => Math.round(num / 100) * 100;

            // Bangun HTML Rincian Pendapatan
            let pendapatanHTML = '';
            if (s.pendapatan.gajiPokok > 0) pendapatanHTML += `<div class="flex justify-between"><span>Gaji Pokok</span> <span>${s.pendapatan.gajiPokok.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.honorMengajar > 0) pendapatanHTML += `<div class="flex justify-between"><span>Honor Mengajar</span> <span>${s.pendapatan.honorMengajar.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.tunjanganMakan > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan Makan</span> <span>${s.pendapatan.tunjanganMakan.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.tunjanganBPJS > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan BPJamsostek</span> <span>${s.pendapatan.tunjanganBPJS.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.tunjanganFasilitas > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan Fasilitas</span> <span>${s.pendapatan.tunjanganFasilitas.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.lembur > 0) pendapatanHTML += `<div class="flex justify-between"><span>Lembur</span> <span>${s.pendapatan.lembur.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.bonusLain > 0) pendapatanHTML += `<div class="flex justify-between"><span>Bonus Lain</span> <span>${s.pendapatan.bonusLain.toLocaleString('id-ID')}</span></div>`;
            if (s.pendapatan.bonusRapat > 0) pendapatanHTML += `<div class="flex justify-between"><span>Bonus Rapat</span> <span>${Math.round(s.pendapatan.bonusRapat).toLocaleString('id-ID')}</span></div>`;

            // Bangun HTML Rincian Potongan
            let potonganHTML = '';
            if (s.potongan.potonganMakan > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Makan</span> <span>${s.potongan.potonganMakan.toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.potonganBPJS > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan BPJamsostek</span> <span>${s.potongan.potonganBPJS.toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.potonganFasilitas > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Fasilitas (Rumah, Listrik, Air, Internet, dll.)</span> <span>${s.potongan.potonganFasilitas.toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.potonganAbsen > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Absen (${s.kehadiran.totalAbsen} hari)</span> <span>${roundToHundred(s.potongan.potonganAbsen).toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.potonganTerlambat > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Terlambat</span> <span>${s.potongan.potonganTerlambat.toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.hutang > 0) potonganHTML += `<div class="flex justify-between"><span>Hutang</span> <span>${s.potongan.hutang.toLocaleString('id-ID')}</span></div>`;
            if (s.potongan.denda > 0) potonganHTML += `<div class="flex justify-between"><span>Denda</span> <span>${s.potongan.denda.toLocaleString('id-ID')}</span></div>`;

            let kehadiranHTML = '';
            if (s.kehadiran.totalMengajar > 0) kehadiranHTML += `<li>Total Mengajar: ${s.kehadiran.totalMengajar} sesi</li>`;
            if (s.kehadiran.hariKerja > 0) kehadiranHTML += `<li>Kehadiran Staf: ${s.kehadiran.totalMasuk} dari ${s.kehadiran.hariKerja} hari kerja</li>`;

            const totalPendapatan = Object.values(s.pendapatan).reduce((a, b) => a + b, 0);
            const totalPotongan = Object.values(s.potongan).reduce((a, b) => a + b, 0);
            const gajiBersih = totalPendapatan - totalPotongan;

            const slipHTML = `
                <div id="slipGajiContent" data-nama="${s.nama}" data-periode="${s.periode}">
                    <div class="bg-white p-6 rounded-lg shadow-lg border">
                        <div class="text-center border-b pb-4 mb-4">
                            <h3 class="text-2xl font-bold">SLIP GAJI</h3>
                            <p class="text-gray-600">Periode: ${new Date(s.periode + '-02').toLocaleString('id-ID', {month:'long', year:'numeric'})}</p>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                            <div><span class="font-semibold">Nama:</span> ${s.nama}</div>
                            <div><span class="font-semibold">Jabatan:</span> ${s.jabatan}</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold text-lg text-green-600 border-b mb-2 pb-1">Pendapatan</h4>
                                <div class="space-y-2">${pendapatanHTML || '<div class="flex justify-between"><span>-</span> <span>0</span></div>'}</div>
                                <div class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total Pendapatan</span> <span>${roundToHundred(totalPendapatan).toLocaleString('id-ID')}</span></div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg text-red-600 border-b mb-2 pb-1">Potongan</h4>
                                <div class="space-y-2">${potonganHTML || '<div class="flex justify-between"><span>-</span> <span>0</span></div>'}</div>
                                <div class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total Potongan</span> <span>${roundToHundred(totalPotongan).toLocaleString('id-ID')}</span></div>
                            </div>
                        </div>
                        <div class="border-t mt-6 pt-4">
                           <div class="flex justify-between font-bold text-xl">
                                <span>GAJI BERSIH</span>
                                <span>Rp ${roundToHundred(gajiBersih).toLocaleString('id-ID')}</span>
                           </div>
                        </div>
                        ${kehadiranHTML ? `<div class="text-xs text-gray-500 mt-6 border-t pt-2"><b>Rincian Kehadiran:</b><ul>${kehadiranHTML}</ul></div>` : ''}
                    </div>
                </div>`;
            slipContainer.innerHTML = slipHTML;
            downloadContainer.classList.remove('hidden'); // Tampilkan tombol unduh
            document.getElementById('downloadSlipBtn').onclick = downloadSlipPDF; // Pasang event listener
        } else if (result.status === 'pending') {
            slipContainer.innerHTML = `<p class="p-8 text-center text-blue-600 bg-blue-50 rounded-lg">${result.message}</p>`;
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        slipContainer.innerHTML = `<p class="p-8 text-center text-red-600 bg-red-50 rounded-lg">Gagal memuat slip gaji: ${error.message}</p>`;
    });
}

	
	// FUNGSI BARU UNTUK MENGAMBIL DAN MENAMPILKAN RIWAYAT
function fetchAndRenderAttendanceHistory(profileName) {
    const historyContainer = document.getElementById('historyContainer');
    if (!historyContainer) return;

    historyContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Memuat riwayat absensi...</p>';

    const data = {
        action: 'getAttendanceHistory',
        profileName: profileName // PERBAIKAN: Pastikan kunci dan nilainya menggunakan profileName
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            if (result.history.length > 0) {
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Informasi</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>' +
                                '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                result.history.forEach(item => {
                    tableHTML += `<tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.tanggal}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.peran}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.informasi}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${item.keterangan}</td>
                                  </tr>`;
                });

                tableHTML += '</tbody></table>';
                historyContainer.innerHTML = tableHTML;
            } else {
                historyContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Tidak ada riwayat absensi dalam 30 hari terakhir.</p>';
            }
        } else {
            throw new Error(result.message || 'Gagal mengambil data.');
        }
    })
    .catch(error => {
        console.error('Error fetching attendance history:', error);
        historyContainer.innerHTML = `<p class="p-6 text-center text-red-500">Terjadi kesalahan: ${error.message}</p>`;
    });
}

    function updateActiveLink() {
    const hash = window.location.hash || '#beranda';
    showPage(hash);

    // Reset semua link
    document.querySelectorAll('#mainNav a').forEach(a => a.classList.remove('active'));

    // BARIS BARU YANG SUDAH DIPERBAIKI
const subMenuHashes = ['#roster-kbm', '#krs', '#khs', '#santri', '#slip-gaji', '#laporan-keuangan', '#laporan', '#musyrif', '#musyrifah'];

    if (subMenuHashes.includes(hash) || hash === '#sistem-informasi') {
        // Jika hash adalah salah satu submenu, aktifkan tombol utama "Sistem Informasi"
        const mainBtn = document.getElementById('sistemInformasiNav');
        if (mainBtn) mainBtn.classList.add('active');
    } else {
        // Jika bukan, cari link yang cocok
        const activeLink = document.querySelector(`#mainNav a[href="${hash}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
}
    
    function updateDateTime() {
        const WAKTU_MAGHRIB = 18.5; // 18:30
        const ZONA_WAKTU_OFFSET_JAM = 7; // WIB adalah UTC+7
        const tanggalMasehiAsli = new Date();
        const optionsMasehi = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' };
        const dateStringMasehi = tanggalMasehiAsli.toLocaleDateString('id-ID', optionsMasehi);
        let dateForHijri = new Date();
        dateForHijri.setHours(dateForHijri.getHours() + ZONA_WAKTU_OFFSET_JAM);
        const jamLokal = tanggalMasehiAsli.getHours() + (tanggalMasehiAsli.getMinutes() / 60);
        if (jamLokal >= WAKTU_MAGHRIB) {
            dateForHijri.setDate(dateForHijri.getDate() + 1);
        }
        const namaBulanHijriah = ["Muharram", "Safar", "Rabi'ul Awal", "Rabi'ul Akhir", "Jumadil Awal", "Jumadil Akhir", "Rajab", "Sya'ban", "Ramadhan", "Syawwal", "Dzulqa'dah", "Dzulhijjah"];
        const optionsHijriNumeric = { calendar: 'islamic-umalqura', day: 'numeric', month: 'numeric', year: 'numeric', timeZone: 'UTC' };
        const formatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic-umalqura-nu-latn', optionsHijriNumeric);
        const parts = formatter.formatToParts(dateForHijri);
        const day = parts.find(p => p.type === 'day').value;
        const monthIndex = parts.find(p => p.type === 'month').value - 1;
        const year = parts.find(p => p.type === 'year').value;
        const dateStringHijri = `${day} ${namaBulanHijriah[monthIndex]} ${year} H`;
        document.getElementById('date-display').innerHTML = `${dateStringMasehi}<br><span class="hijri-date">${dateStringHijri}</span>`;
    }

    function setTodayDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedToday = `${year}-${month}-${day}`;
        document.getElementById('attendanceDateGuru').value = formattedToday;
        document.getElementById('attendanceDateStaf').value = formattedToday;
        document.getElementById('rapatDate').value = formattedToday;
    }
    // =======================================================
// === FUNGSI-FUNGSI BARU UNTUK FITUR MUSYRIF/AH ===
// =======================================================

function populateSantriDropdowns(role) {
    const santriList = (role === 'musyrif') ? appData.santriMusyrif : appData.santriMusyrifah;
    const pageSelector = `#${role}`;
    const selects = document.querySelectorAll(`${pageSelector} select`);
    
    selects.forEach(select => {
        select.innerHTML = '<option value="">Pilih Nama Santri...</option>'; // Opsi default
        santriList.forEach(santriName => {
            const option = document.createElement('option');
            option.value = santriName;
            option.textContent = santriName;
            select.appendChild(option);
        });
    });
}

function setupMusyrifEventListeners(role) {
    const pageSelector = `#${role}`;
    const formKegiatan = document.querySelector(`${pageSelector} #formKegiatan${role.charAt(0).toUpperCase() + role.slice(1)}`);
    const formTahfidz = document.querySelector(`${pageSelector} #formTahfidz${role.charAt(0).toUpperCase() + role.slice(1)}`);
    const formPelanggaran = document.querySelector(`${pageSelector} #formPelanggaran${role.charAt(0).toUpperCase() + role.slice(1)}`);
    
    // Logika untuk menampilkan/menyembunyikan keterangan kegiatan
    const statusRadios = document.querySelectorAll(`input[name="statusKegiatan${role.charAt(0).toUpperCase() + role.slice(1)}"]`);
    const keteranganContainer = document.getElementById(`keteranganKegiatan${role.charAt(0).toUpperCase() + role.slice(1)}Container`);
    statusRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            keteranganContainer.classList.toggle('hidden', this.value !== 'Ada yang tidak dikerjakan');
        });
    });

    // Event listener untuk form
    formKegiatan.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'Kegiatan'));
    formTahfidz.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'Tahfidz'));
    formPelanggaran.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'Pelanggaran'));
}

// GANTI SELURUH ISI FUNGSI INI
function handleMusyrifFormSubmit(event, role, type) {
    event.preventDefault();
    const session = getActiveSession();
    if (!session || !session.loggedIn) {
        showMessage('Sesi Anda telah berakhir, silakan login kembali.', 'error');
        return;
    }

    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const santriSelect = form.querySelector('select');

    // VALIDASI: Pastikan nama santri sudah dipilih
    if (!santriSelect.value) {
        showMessage('Silakan pilih nama santri terlebih dahulu.', 'error');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Mengirim...';

    let data = {
        action: `submit${type}`,
        musyrif: session.userData.profileName,
        tanggal: form.querySelector('input[type="date"]').value,
        namaSantri: santriSelect.value,
    };

    const roleCapitalized = role.charAt(0).toUpperCase() + role.slice(1);

    if (type === 'Kegiatan') {
        data.status = form.querySelector(`input[name="statusKegiatan${roleCapitalized}"]:checked`).value;
        data.keterangan = form.querySelector(`#keteranganKegiatan${roleCapitalized}`).value || '-';
    } else if (type === 'Tahfidz') {
        data.ziyadahP = document.getElementById(`ziyadahPoin${roleCapitalized}`).value || '0';
        data.ziyadahPText = document.getElementById(`ziyadahPText${roleCapitalized}`).value || '-';
        data.ziyadahS = document.getElementById(`ziyadahSoin${roleCapitalized}`).value || '0';
        data.ziyadahSText = document.getElementById(`ziyadahSText${roleCapitalized}`).value || '-';
        data.murajaah = document.getElementById(`murajaahPoin${roleCapitalized}`).value || '0';
        data.murajaahText = document.getElementById(`murajaahText${roleCapitalized}`).value || '-';
    } else if (type === 'Pelanggaran') {
        data.pelanggaran = document.getElementById(`isiPelanggaran${roleCapitalized}`).value;
        data.solusi = document.getElementById(`solusiPelanggaran${roleCapitalized}`).value;
    }

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(`Laporan ${type} berhasil disimpan!`, 'success');
            form.reset();
			form.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            // Mengembalikan radio button ke default setelah reset
            if(type === 'Kegiatan') {
                form.querySelector('input[value="Sudah dilaksanakan semua"]').checked = true;
                document.getElementById(`keteranganKegiatan${roleCapitalized}Container`).classList.add('hidden');
            }
            fetchAndRenderDailyReports(role); // Refresh tampilan
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        showMessage(`Gagal menyimpan: ${error.message}`, 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = `Simpan Laporan ${type}`;
    });
}

function fetchAndRenderDailyReports(role) {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;

    const reportContainer = document.getElementById(`reportTable${role.charAt(0).toUpperCase() + role.slice(1)}`);
    reportContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Memuat laporan hari ini...</p>';

    const data = {
        action: 'getDailyReports',
        profileName: session.userData.profileName,
        dateString: getClientDateString()
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            if (result.reports.length > 0) {
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Santri</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Laporan</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>' +
                                '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                result.reports.forEach(item => {
                    let detail = '';
                    if (item.type === 'Kegiatan') {
                        detail = `<b>Status:</b> ${item.status}. ${item.status === 'Ada yang tidak dikerjakan' ? `<b>Ket:</b> ${item.keterangan}` : ''}`;
                    } else if (item.type === 'Tahfidz') {
                        detail = `Ziyadah(P): <b>${item.ziyadahP}</b>, Ziyadah(S): <b>${item.ziyadahS}</b>, Muraja'ah: <b>${item.murajaah}</b>`;
                    } else if (item.type === 'Pelanggaran') {
                        detail = `<b>Pelanggaran:</b> ${item.pelanggaran}. <b>Solusi:</b> ${item.solusi}`;
                    }
                    
                    tableHTML += `<tr>
                                    <td class="px-4 py-4 font-medium text-gray-900">${item.namaSantri}</td>
                                    <td class="px-4 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.type === 'Pelanggaran' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${item.type}</span></td>
                                    <td class="px-4 py-4 text-sm text-gray-600">${detail}</td>
                                  </tr>`;
                });

                tableHTML += '</tbody></table>';
                reportContainer.innerHTML = tableHTML;
            } else {
                reportContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>';
            }
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        reportContainer.innerHTML = `<p class="p-6 text-center text-red-500">Gagal memuat laporan: ${error.message}</p>`;
    });
}

// FUNGSI BARU UNTUK HALAMAN LAPORAN TAHFIDZ
function fetchAndRenderTahfidzReport(dateString) {
    const reportContainer = document.getElementById('laporanContainer');
    reportContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Memuat laporan untuk tanggal ' + dateString + '...</p>';

    // Ubah format YYYY-MM-DD dari date picker ke DD/MM/YYYY yang dibutuhkan script
    const parts = dateString.split('-');
    const formattedDateForScript = `${parts[2]}/${parts[1]}/${parts[0]}`;

    const data = {
        action: 'getTahfidzReport',
        dateString: formattedDateForScript
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            if (result.reports.length > 0) {
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Santri</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Musyrif/ah</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ziyadah (P)</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ziyadah (S)</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Muraja\'ah</th>' +
                                '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                result.reports.forEach(item => {
                    tableHTML += `<tr>
                                    <td class="px-4 py-4 font-medium text-gray-900">${item.namaSantri}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">${item.musyrif}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">${item.ziyadahPText || '-'} (${item.ziyadahP || '0'})</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">${item.ziyadahSText || '-'} (${item.ziyadahS || '0'})</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">${item.murajaahText || '-'} (${item.murajaah || '0'})</td>
                                  </tr>`;
                });

                tableHTML += '</tbody></table>';
                reportContainer.innerHTML = tableHTML;
            } else {
                reportContainer.innerHTML = `<p class="p-6 text-center text-gray-500">Tidak ada laporan Tahfidz yang masuk pada tanggal ${dateString}.</p>`;
            }
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        reportContainer.innerHTML = `<p class="p-6 text-center text-red-500">Gagal memuat laporan: ${error.message}</p>`;
    });
}	
const handleKrsClick = (event, userData = null) => {
    if (!userData) {
        console.error("Tidak ada data pengguna untuk menampilkan KRS.");
        return;
    }

    const loggedInSantriName = userData.profileName;
    
    // CARI DATA LENGKAP SANTRI DI DALAM appData BERDASARKAN NAMA
    const santriData = appData.santri.find(s => s.nama === loggedInSantriName);

    // Jika data santri tidak ditemukan, hentikan.
    if (!santriData) {
        alert(`Data untuk santri bernama "${loggedInSantriName}" tidak ditemukan dalam daftar.`);
        return;
    }

    // AMBIL SEMUA DATA DARI HASIL PENCARIAN
    const santriName = santriData.nama;
    const groupInfo = santriData.grup; // contoh: "KG LKS"
    const santriKelas = santriData.kelas;
    const santriJurusan = santriData.jurusan;
    
    const groupInfoParts = (typeof groupInfo === 'string' && groupInfo) ? groupInfo.split(' ') : [];
    const santriGroup = groupInfoParts[0] || '';
    const santriCluster = groupInfoParts[1] || '';
    
    const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];

    // Tampilkan data di header KRS
    document.getElementById('nama-santri-krs').textContent = `: ${santriName}`;
    document.getElementById('jurusan-krs').textContent = `: ${santriJurusan}`;
    document.getElementById('kelas-krs').textContent = `: ${santriKelas}`;
    document.getElementById('kelompok-krs').textContent = `: ${groupInfo}`;
    const activeTab = document.querySelector('.tab-btn.active');
    document.getElementById('materi-bulan-krs').textContent = `: ${activeTab.textContent.replace('Bulan ', '')}`;

    // Filter data jadwal berdasarkan kelompok santri
    let krsData = [];
    if (santriGroup === 'KF') {
        krsData = currentScheduleData.filter(item => item.group === 'KF');
    } else if (santriGroup === 'KG' && santriCluster) {
        krsData = currentScheduleData.filter(item => item.group === 'KG' && (item.cluster === santriCluster || item.cluster === 'Wajib'));
    }

    krsTableBody.innerHTML = ''; 
    if (krsData.length > 0) {
        krsData
            .filter(item => item.group !== 'Istirahat' && item.subject && item.subject.trim() !== 'Kosong' && !item.subject.toLowerCase().includes('tugas mandiri'))
            .sort((a, b) => {
                const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
                return days.indexOf(a.day) - days.indexOf(b.day) || a.time.localeCompare(b.time);
            })
            .forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.className = index % 2 === 0 ? 'bg-white border-b' : 'bg-gray-50 border-b';
                const code = item.subject.split(':')[0];
                tr.innerHTML = `<td class="px-4 py-2" contenteditable="false">${item.day}</td><td class="px-4 py-2" contenteditable="false">${item.time}</td><td class="px-4 py-2" contenteditable="false">${code}</td><td class="px-4 py-2" contenteditable="false">${item.subject.substring(code.length + 1).trim()}</td><td class="px-4 py-2" contenteditable="false">${item.room}</td><td class="px-4 py-2 text-center" contenteditable="false">${item.sks}</td><td class="px-4 py-2" contenteditable="false">${item.teacher}</td><td class="px-4 py-2 text-center"><button class="delete-krs-row text-red-500 hover:text-red-700">Hapus</button></td>`;
                krsTableBody.appendChild(tr);
            });
    } else {
         krsTableBody.innerHTML = `<tr><td colspan="8" class="text-center px-4 py-3 text-gray-500">Tidak ada data KRS untuk ditampilkan.</td></tr>`;
    }

    updateKrsTotalSks();
    krsContainer.classList.remove('hidden');
    khsContainer.classList.add('hidden');
    krsContainer.scrollIntoView({ behavior: 'smooth' });
};

async function handleKhsClick(event, userData = null) {
    if (!userData) return;

    const loggedInSantriName = userData.profileName;
    const santriData = appData.santri.find(s => s.nama === loggedInSantriName);
    if (!santriData) {
        alert(`Data untuk santri "${loggedInSantriName}" tidak ditemukan.`);
        return;
    }
    
    const khsDisplay = document.getElementById('khs-display');
    khsDisplay.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat data KHS...</p>';
    khsContainer.classList.remove('hidden');
    krsContainer.classList.add('hidden');
    khsContainer.scrollIntoView({ behavior: 'smooth' });

    const activeTab = document.querySelector('.tab-btn.active');
    const bulan = activeTab.textContent.replace('Bulan ', '');
    const activeMonthKey = `bulan${activeTab.id.replace('tab-bulan', '')}`;
    
    let userScores = {};
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getKHSData', username: userData.username, bulan: bulan }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if(result.status === 'success') {
            userScores = result.nilai;
        } else {
            throw new Error(result.message);
        }
    } catch(error) {
        khsDisplay.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat nilai: ${error.message}</p>`;
        return;
    }

    const scheduleThisMonth = appData.schedules[activeMonthKey] || [];
    const groupInfo = santriData.grup;
    const santriGroup = groupInfo.split(' ')[0];
    const santriCluster = groupInfo.split(' ')[1] || '';

    let khsData = [];
if (santriGroup === 'KF') {
    khsData = scheduleThisMonth.filter(item => item.group === 'KF');
} else if (santriGroup === 'KG' && santriCluster) {
    khsData = scheduleThisMonth.filter(item => item.group === 'KG' && (item.cluster === santriCluster || item.cluster === 'Wajib'));
}

// Proses data yang sudah difilter dengan benar
khsData = khsData
    .filter(item => item.group !== 'Istirahat' && item.subject && item.subject.trim() !== 'Kosong' && !item.subject.toLowerCase().includes('tugas mandiri'))
    .map((item, index) => {
        const code = item.subject.split(':')[0].trim();
        const nilai = userScores[code] !== undefined ? userScores[code] : 0;
        let huruf = 'E';
        let bobot = 0.00;
        if (nilai >= 90) { huruf = 'A'; bobot = 4.00; }
        else if (nilai >= 85) { huruf = 'A-'; bobot = 3.75; }
        else if (nilai >= 80) { huruf = 'B+'; bobot = 3.50; }
        else if (nilai >= 75) { huruf = 'B'; bobot = 3.00; }
        else if (nilai >= 70) { huruf = 'B-'; bobot = 2.75; }
        else if (nilai >= 65) { huruf = 'C+'; bobot = 2.50; }
        else if (nilai >= 60) { huruf = 'C'; bobot = 2.00; }
        else if (nilai >= 55) { huruf = 'D'; bobot = 1.00; }
        
        return {
            no: index + 1,
            kode: code,
            materi: item.subject.substring(code.length + 1).trim(),
            sks: item.sks,
            huruf: huruf,
            bobot: bobot,
            nilai: parseFloat(nilai).toFixed(2)
        };
    });

    let tableRows = '', totalSks = 0, totalNilaiBobot = 0;
    khsData.forEach(item => {
        tableRows += `<tr><td class="border border-black text-center">${item.no}</td><td class="border border-black">${item.kode}</td><td class="border border-black">${item.materi}</td><td class="border border-black text-center">${item.sks}</td><td class="border border-black text-center">${item.huruf}</td><td class="border border-black text-center">${item.bobot.toFixed(2)}</td><td class="border border-black text-center">${item.nilai}</td></tr>`;
        totalSks += item.sks;
        totalNilaiBobot += item.sks * item.bobot;
    });
    const ip = totalSks > 0 ? (totalNilaiBobot / totalSks).toFixed(2) : "0.00";
    
    // Perbarui innerHTML dari khsDisplay dengan template KHS yang sudah ada
    // Template KHS Anda dari file (tidak disertakan ulang di sini agar ringkas)
    khsDisplay.innerHTML = `<header class="flex items-center justify-between border-b-2 border-black pb-2"><div class="flex items-center"><img src="Logo_yayasan.png" alt="Logo Institusi" class="h-16 w-16 mr-4" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex'"><div class="h-16 w-16 mr-4 bg-gray-200 items-center justify-center text-gray-500 font-bold" style="display: none;">LOGO</div><div><h1 class="text-xl font-bold">MARKAZ QUR'AN AL-MAA'UN</h1><p class="text-xs">Lembaga Pendidikan Islam Terpadu</p></div></div></header><div class="text-center my-4"><h3 class="text-xl font-bold underline">KARTU HASIL STUDI (KHS)</h3></div><section id="info-santri-khs" class="grid grid-cols-2 gap-x-8 text-sm mb-4"></section><section><table id="tabel-nilai" class="w-full text-sm border-collapse border border-black"><thead class="bg-gray-200"><tr><th class="border border-black">NO</th><th class="border border-black">KODE</th><th class="border border-black text-left">MATERI</th><th class="border border-black">SKS</th><th class="border border-black">Huruf</th><th class="border border-black">Bobot</th><th class="border border-black">Nilai</th></tr></thead><tbody></tbody><tfoot></tfoot></table></section><footer class="flex justify-between items-start mt-6 text-xs" style="background-color: white; color: black;"><div><p>1 lembar untuk Santri</p><p>1 lembar untuk bid. kurikulum</p><p>1 lembar untuk Arsip</p></div><div class="text-center"><p>Sei Kamah II, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p><p>Mudir,</p><div class="h-12"></div><p class="font-bold underline">Aria Atmaja</p></div></footer>`;

    // Isi bagian yang dinamis secara terpisah
    khsDisplay.querySelector('tbody').innerHTML = tableRows;
    khsDisplay.querySelector('tfoot').innerHTML = `<tr class="font-bold bg-gray-100"><td colspan="3" class="border border-black text-right pr-2">Jumlah SKS</td><td class="border border-black text-center">${totalSks}</td><td colspan="3" class="border border-black"></td></tr><tr class="font-bold bg-gray-100"><td colspan="5" class="border border-black text-right pr-2">IP Bulanan</td><td class="border border-black text-center">${ip}</td><td class="border border-black"></td></tr>`;
    khsDisplay.querySelector('#info-santri-khs').innerHTML = `<div><div class="flex"><span class="w-32">NAMA</span><span>: ${santriData.nama}</span></div><div class="flex"><span class="w-32">Kelas / Jurusan</span><span>: ${santriData.kelas} / ${santriData.jurusan}</span></div></div><div><div class="flex"><span class="w-28">Semester / Bulan</span><span>: Ganjil / ${bulan}</span></div><div class="flex"><span class="w-28">Klaster</span><span>: ${santriData.grup}</span></div></div>`;
};    
	
	const updateKrsTotalSks = () => {
        const totalSksElement = document.getElementById('total-sks-diambil');
        let totalSks = 0;
        const sksCells = krsTableBody.querySelectorAll('tr td:nth-child(6)');
        sksCells.forEach(cell => { totalSks += parseInt(cell.textContent, 10) || 0; });
        totalSksElement.textContent = totalSks;
    };
	
    // --- (Fungsi-fungsi SI KBM di sini) ---
function initializeSistemInformasi() {
    console.log("Menginisialisasi Sistem Informasi KBM...");

    // =================================================================
    // *** PENYEDERHANAAN: 2. MENGELOLA STATE APLIKASI ***
    // =================================================================
    
    const session = getActiveSession();
    // PERUBAHAN: Membuat pengecekan jabatan 'Santri' tidak sensitif terhadap huruf besar/kecil dan spasi, sama seperti pada perbaikan menu sebelumnya.
    const isSantri = session && session.userData && (session.userData.jabatan || '').trim().toLowerCase() === 'santri';

    if (isSantri) {
        document.getElementById('teacher-data-container').classList.add('hidden');
        document.getElementById('module-data-container').classList.add('hidden');
        document.getElementById('santri-data-container').classList.add('hidden');
    }
	
    // --- DOM ELEMENTS ---
    const scheduleContainer = document.getElementById('schedule-container');
    const filterGroup = document.getElementById('filter-group');
    const filterCluster = document.getElementById('filter-cluster');
    const filterTeacher = document.getElementById('filter-teacher');
    const filterRoom = document.getElementById('filter-room');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const teacherTableBody = document.querySelector('#teacher-table tbody');
    const moduleTableBody = document.querySelector('#module-table tbody');
    const santriTableBody = document.getElementById('santri-table-body');
    const modal = document.getElementById('confirmation-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalMessage = document.getElementById('modal-message');
    


    // --- UTILITY & HELPER FUNCTIONS ---
    const getGroupNameFromCode = (code) => {
        if (!code || !code.includes('-') || code.split('-')[1].length !== 3) {
            return "Modul Lain-lain";
        }
        const numStr = code.split('-')[1];
        const bagian = numStr.charAt(0);
        const sesi = numStr.charAt(2);
        const sesiMap = { '1': 'Sesi Pertama', '2': 'Sesi Kedua', '3': 'Sesi Ketiga', '4': 'Sesi Keempat', '5': 'Sesi Kelima', '6': 'Sesi Keenam' };
        const sesiText = sesiMap[sesi] || `Sesi ke-${sesi}`;
        return `Materi Bagian ${bagian} - ${sesiText}`;
    };

    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            const confirmHandler = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(true);
            };
            const cancelHandler = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(false);
            };
            const cleanup = () => {
                modalConfirmBtn.removeEventListener('click', confirmHandler);
                modalCancelBtn.removeEventListener('click', cancelHandler);
            };
            modalConfirmBtn.addEventListener('click', confirmHandler);
            modalCancelBtn.addEventListener('click', cancelHandler);
        });
    };
    
    const processAndFillScheduleData = (originalData) => {
        let processedData = originalData.filter(item => item.time !== "11:30-12:15");
        processedData = JSON.parse(JSON.stringify(processedData)); 
        
        const timeSlots = ["08:00-09:30", "10:00-11:30", "13:00-14:30"];
        const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];

        days.forEach(day => {
            rooms.forEach(room => {
                processedData.push({
                    day: day, time: "11:30-12:15", sks: 1, room: room, group: "Istirahat", cluster: "", 
                    subject: "Istirahat Qailullah", teacher: "", downloadLink: ""
                });
            });

            timeSlots.forEach(time => {
                if (day === "Jumat" && time === "13:00-14:30") return;

                const slotEntries = processedData.filter(item => item.day === day && item.time === time);
                const hasLKS = slotEntries.some(item => item.group === 'KG' && item.cluster === 'LKS');
                const hasSTT = slotEntries.some(item => item.group === 'KG' && item.cluster === 'STT');

                if (hasLKS && !hasSTT) {
                    processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KG", cluster: "STT", 
                        subject: "Tugas Mandiri KG (STT)", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                } else if (hasSTT && !hasLKS) {
                     processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KG", cluster: "LKS", 
                        subject: "Tugas Mandiri KG (LKS)", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                }

                const kfInMainRooms = slotEntries.some(item => item.group === 'KF' && (item.room === 'Kelas Mekah' || item.room === 'Kelas Madinah'));
                const rbmIsOccupied = slotEntries.some(item => item.room === 'RBM');

                if (!kfInMainRooms && !rbmIsOccupied) { 
                    processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KF", cluster: "", 
                        subject: "Tugas Mandiri KF", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                }
            });
        });
        return processedData;
    };

    // --- RENDER FUNCTIONS ---
    const renderSchedule = () => {
        scheduleContainer.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'schedule-grid';
        const days = ["", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const timeSlots = ["08:00-09:30", "10:00-11:30", "13:00-14:30"];
        const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];

        days.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header text-slate-600 bg-slate-100';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        timeSlots.forEach(time => {
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-slot text-teal-700 bg-slate-100 flex items-center justify-center';
            timeHeader.textContent = time;
            grid.appendChild(timeHeader);

            days.slice(1).forEach(day => {
                const cellContainer = document.createElement('div');
                cellContainer.className = 'p-1 bg-slate-100 rounded-lg space-y-1 flex flex-col justify-around';
                const dayTimeData = currentScheduleData.filter(item => item.day === day && item.time === time);

                rooms.forEach(room => {
                    const item = dayTimeData.find(d => d.room === room);
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell';

                    if (item) {
                        cell.dataset.group = item.group;
                        cell.dataset.teacher = item.teacher;
                        cell.dataset.room = item.room;
                        cell.dataset.cluster = item.cluster;

                        if (item.room === 'RBM') cell.classList.add('room-rbm');
                        if (item.room === 'Kelas Madinah') cell.classList.add('room-madinah');
                        if (item.room === 'Kelas Mekah') cell.classList.add('room-mekah');

                        let displayGroup = item.group;
                        if (item.group === 'KG' && item.cluster) {
                            displayGroup = `KG (${item.cluster})`;
                        }
                        
                        let subjectHtml = `<div class="font-bold text-sm text-teal-900"> ${item.subject || 'Kosong'}</div>`;
                        if (item.downloadLink && !isSantri) {
                            subjectHtml = `<a href="${item.downloadLink}" target="_blank" rel="noopener noreferrer" class="font-bold text-sm text-teal-900 hover:text-teal-600 hover:underline"> ${item.subject || 'Kosong'}</a>`;
                        }

                        cell.innerHTML = `
                            <div class="subject flex-grow">${subjectHtml}</div>
                            <div class="mt-2">
                                <div class="group-display font-semibold text-xs text-slate-600">
                                    <span> ${displayGroup}</span>
                                    <span class="room ml-2 ${item.room === 'RBM' ? 'text-orange-700' : 'text-sky-700'}"> ${item.room}</span>
                                </div>
                                <div class="teacher font-semibold text-xs text-teal-600 mt-1"> ${item.teacher || ''}</div>
                            </div>`;
                    }
                    cellContainer.appendChild(cell);
                });
                grid.appendChild(cellContainer);
            });
        });
        scheduleContainer.appendChild(grid);
        applyFilters();
    };

    const renderModuleTable = () => {
        const allScheduleEntries = Object.values(appData.schedules).flat();
        const parentSubjectMap = { 'MAT': 'Matematika', 'IND': 'Bahasa Indonesia', 'THI': 'Thibbun Nabawi', 'ENG': 'Bahasa Inggris', 'KWU': 'Kewirausahaan', 'ARB': 'Bahasa Arab', 'KES': 'Kesehatan', 'KTR': 'Keterampilan', 'TAU': 'Tauhid', 'IPA': 'IPA Terpadu', 'ULH': 'Ulumul Hadits', 'TME': 'Teknik Mekanik Elektronik', 'IPS': 'IPS Terpadu', 'PANC': 'Pancasila', 'HAD': 'Hadits', 'TIK': 'Teknologi Informasi', 'ULQ': 'Ulumul Quran', 'FIQ': 'Fiqih', 'NAH': 'Nahwu', 'SIR': 'Sirah Nabawiyah', 'BAL': 'Balaghah', 'TAF': 'Tafsir', 'AKH': 'Akhlak' };
        const uniqueModules = {};

        allScheduleEntries.forEach(item => {
            if (item.subject && item.subject.includes(':') && !uniqueModules[item.subject]) {
                uniqueModules[item.subject] = { teacher: item.teacher || "N/A", link: item.downloadLink || "", sks: item.sks };
            }
        });

        const defaultModules = Object.keys(uniqueModules).map((subject, index) => {
            const itemData = uniqueModules[subject];
            const [code, ...nameParts] = subject.split(':');
            const moduleName = nameParts.join(':').trim();
            const prefix = code.trim().split('-')[0];
            return { no: index + 1, teacher: itemData.teacher, parent_subject: parentSubjectMap[prefix] || 'Lainnya', code: code.trim(), module: moduleName, sks: itemData.sks, downloadLink: itemData.link };
        });
        
        moduleTableBody.innerHTML = '';
        const modulesByTeacher = defaultModules.reduce((acc, module) => {
            const teacherName = module.teacher || "Tanpa Guru";
            if (!acc[teacherName]) { acc[teacherName] = []; }
            acc[teacherName].push(module);
            return acc;
        }, {});

        Object.keys(modulesByTeacher).sort().forEach(teacherName => {
            const modules = modulesByTeacher[teacherName];
            const teacherRow = document.createElement('tr');
            teacherRow.className = 'bg-slate-50 hover:bg-slate-100 cursor-pointer border-b border-slate-200';
            teacherRow.innerHTML = `<td class="px-6 py-4 font-bold text-teal-700" colspan="7"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><svg class="w-5 h-5 transition-transform duration-300 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg><span>${teacherName}</span></div><span class="bg-teal-100 text-teal-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">${modules.length} Modul</span></div></td>`;
            moduleTableBody.appendChild(teacherRow);

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'hidden';
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 7;
            detailsCell.className = "p-0";
            const modulesContainer = document.createElement('div');
            modulesContainer.className = "bg-white";

            const groupsWithinTeacher = modules.sort((a, b) => a.code.localeCompare(b.code)).reduce((acc, mod) => {
                const groupName = getGroupNameFromCode(mod.code);
                if (!acc[groupName]) { acc[groupName] = []; }
                acc[groupName].push(mod);
                return acc;
            }, {});

            Object.keys(groupsWithinTeacher).sort((a, b) => parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0])).forEach(groupName => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center justify-between px-4 py-3 text-base font-bold text-teal-800 bg-teal-50 border-t border-b border-teal-100 cursor-pointer hover:bg-teal-200 transition';
                groupHeader.innerHTML = `<span>${groupName}</span><svg class="w-5 h-5 transition-transform duration-300 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg>`;
                modulesContainer.appendChild(groupHeader);
                
                const singleGroupContainer = document.createElement('div');
                singleGroupContainer.className = 'divide-y divide-slate-100 hidden';
                
                groupsWithinTeacher[groupName].forEach(mod => {
                    const moduleItem = document.createElement('div');
                    moduleItem.className = 'grid grid-cols-7 gap-4 p-4 items-center text-sm hover:bg-slate-50 transition';
                    moduleItem.innerHTML = `<div class="px-2 text-slate-500 font-medium">${mod.no}</div><div class="col-span-1 px-2 text-slate-800 font-semibold">${mod.parent_subject}</div><div class="col-span-1 px-2 text-slate-600">${mod.code}</div><div class="col-span-2 px-2 text-slate-800">${mod.module}</div><div class="px-2 text-slate-600">${mod.sks ? mod.sks + ' SKS' : 'N/A'}</div><div class="px-2 text-right">${mod.downloadLink ? `<a href="${mod.downloadLink}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-green-200 transition"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>Unduh</a>` : `<span class="inline-flex items-center gap-2 bg-slate-100 text-slate-500 text-xs font-semibold px-2.5 py-1 rounded-full cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg>Kosong</span>`}</div>`;
                    singleGroupContainer.appendChild(moduleItem);
                });
                modulesContainer.appendChild(singleGroupContainer);
                groupHeader.addEventListener('click', () => {
                    singleGroupContainer.classList.toggle('hidden');
                    groupHeader.querySelector('.arrow-icon').classList.toggle('rotate-90');
                });
            });
            detailsCell.appendChild(modulesContainer);
            detailsRow.appendChild(detailsCell);
            moduleTableBody.appendChild(detailsRow);
            teacherRow.addEventListener('click', () => {
                detailsRow.classList.toggle('hidden');
                teacherRow.querySelector('.arrow-icon').classList.toggle('rotate-90');
            });
        });
    };

    const renderTeacherTable = () => {
        teacherTableBody.innerHTML = '';
        appData.teachers.forEach(teacher => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500">${teacher.no}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${teacher.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.major}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.hari}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.schedule}</td>`;
            teacherTableBody.appendChild(row);
        });
    };

    const renderSantriTable = () => {
        santriTableBody.innerHTML = '';
        appData.santri.forEach(santri => {
            const row = document.createElement('tr');
            row.dataset.santriId = santri.id;
            row.dataset.santriName = santri.nama;
            row.dataset.santriGroup = santri.grup;
            row.dataset.santriKelas = santri.kelas;
            row.dataset.santriJurusan = santri.jurusan;
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.id}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${santri.nama}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.gender}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.grup}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.kelas}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.jurusan}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2"><button class="krs-btn text-indigo-600 hover:text-indigo-900">Lihat KRS</button><button class="khs-btn text-green-600 hover:text-green-900">Lihat KHS</button></td>`;
            santriTableBody.appendChild(row);
        });
    };

    const applyFilters = () => {
        const { group, cluster, teacher, room } = appState.filters;

        filterCluster.disabled = (group !== 'KG');
        if (group !== 'KG' && appState.filters.cluster !== 'all') {
            appState.filters.cluster = 'all';
            filterCluster.value = 'all';
        }

        document.querySelectorAll('.schedule-cell').forEach(cell => {
            const cellData = cell.dataset;
            if (!cellData.group) {
                cell.classList.remove('highlight', 'dimmed');
                return;
            }
            let isMatch = true;
            if (group !== 'all' && cellData.group !== group) isMatch = false;
            if (cluster !== 'all' && cellData.cluster !== cluster && !(cellData.cluster === 'Wajib' && group === 'KG')) isMatch = false;
            if (teacher !== 'all' && cellData.teacher !== teacher) isMatch = false;
            if (room !== 'all' && cellData.room !== room) isMatch = false;

            if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
                cell.classList.remove('highlight', 'dimmed');
            } else if (isMatch) {
                cell.classList.add('highlight');
                cell.classList.remove('dimmed');
            } else {
                cell.classList.remove('highlight');
                cell.classList.add('dimmed');
            }
        });
    };
    
    const getFilteredScheduleData = () => {
        const { group, cluster, teacher, room } = appState.filters;
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];

        if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
            return currentScheduleData.filter(item => item.group && item.group !== 'Istirahat' && item.subject && item.subject.trim() !== '');
        }

        return currentScheduleData.filter(item => {
            if (!item.group || item.group === 'Istirahat' || !item.subject || item.subject.trim() === '') return false;
            const groupMatch = (group === 'all') || (item.group === group);
            const clusterMatch = (cluster === 'all') || (item.cluster === cluster) || (item.group === 'KG' && item.cluster === 'Wajib');
            const teacherMatch = (teacher === 'all') || (item.teacher === teacher);
            const roomMatch = (room === 'all') || (item.room === room);
            return (group === 'KG') ? (groupMatch && clusterMatch && teacherMatch && roomMatch) : (groupMatch && teacherMatch && roomMatch);
        });
    };

    const populateTeacherFilter = () => {
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];
        const teachers = [...new Set(currentScheduleData.map(item => item.teacher).filter(Boolean))].sort();
        filterTeacher.innerHTML = '<option value="all">Semua Guru</option>';
        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher;
            option.textContent = teacher;
            filterTeacher.appendChild(option);
        });
    };

    // --- KRS & KHS LOGIC ---
    

    

    // --- EVENT LISTENERS & HANDLERS ---
    function setupEventListeners() {
        // Filter listeners
        filterGroup.addEventListener('change', (e) => { appState.filters.group = e.target.value; applyFilters(); });
        filterCluster.addEventListener('change', (e) => { appState.filters.cluster = e.target.value; applyFilters(); });
        filterTeacher.addEventListener('change', (e) => { appState.filters.teacher = e.target.value; applyFilters(); });
        filterRoom.addEventListener('change', (e) => { appState.filters.room = e.target.value; applyFilters(); });
        
        resetFiltersBtn.addEventListener('click', () => {
            appState.filters = { group: 'all', cluster: 'all', teacher: 'all', room: 'all' };
            filterGroup.value = 'all';
            filterCluster.value = 'all';
            filterTeacher.value = 'all';
            filterRoom.value = 'all';
            applyFilters();
        });

        // Tab listeners
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const monthKey = `bulan${e.target.id.replace('tab-bulan', '')}`;
                appState.activeMonthKey = monthKey;
                
                document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');

                renderSchedule();
                populateTeacherFilter();
                krsContainer.classList.add('hidden');
                khsContainer.classList.add('hidden');
            });
        });

        document.querySelectorAll('.semester-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.id === 'semester-ganjil-btn') {
                    document.getElementById('ganjil-tabs').classList.remove('hidden');
                    document.getElementById('genap-tabs').classList.add('hidden');
                    document.getElementById('tab-bulan1').click();
                } else {
                    document.getElementById('ganjil-tabs').classList.add('hidden');
                    document.getElementById('genap-tabs').classList.remove('hidden');
                    document.getElementById('tab-bulan5').click();
                }
            });
        });
        
        // Accordion listeners
        document.querySelectorAll('.data-header').forEach(header => {
            header.addEventListener('click', () => {
                header.nextElementSibling.classList.toggle('hidden');
                header.querySelector('.arrow-icon').classList.toggle('rotate-180');
            });
        });

        // Event Delegation for dynamic buttons
        santriTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('krs-btn')) handleKrsClick(event);
            if (event.target.classList.contains('khs-btn')) handleKhsClick(event);
        });
        krsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-krs-row')) {
                event.target.closest('tr').remove();
                updateKrsTotalSks();
            }
        });
        krsTableBody.addEventListener('input', (event) => {
            if (event.target.tagName === 'TD') updateKrsTotalSks();
        });

        // Other action buttons
        document.getElementById('reset-schedule').addEventListener('click', async () => {
            if (await showConfirmation('Yakin ingin reset jadwal?')) {
                document.getElementById('tab-bulan1').click();
            }
        });
        document.getElementById('print-schedule').addEventListener('click', () => {
            const style = document.createElement('style');
            style.innerHTML = `@media print { .schedule-cell.dimmed { visibility: hidden !important; } }`;
            document.head.appendChild(style);
            window.print();
            setTimeout(() => { document.head.removeChild(style); }, 500);
        });
        document.getElementById('download-schedule-pdf').addEventListener('click', function() { /* ...logic... */ });
        addKrsRowBtn.addEventListener('click', () => {
            const newRow = document.createElement('tr');
            newRow.innerHTML = `<td class="px-4 py-2" contenteditable="true">Hari Baru</td><td class="px-4 py-2" contenteditable="true">Waktu Baru</td><td class="px-4 py-2" contenteditable="true">KODE</td><td class="px-4 py-2" contenteditable="true">Mata Pelajaran Baru</td><td class="px-4 py-2" contenteditable="true">Ruang Baru</td><td class="px-4 py-2 text-center" contenteditable="true">2</td><td class="px-4 py-2" contenteditable="true">Guru Baru</td><td class="px-4 py-2 text-center"><button class="delete-krs-row text-red-500 hover:text-red-700">Hapus</button></td>`;
            krsTableBody.appendChild(newRow);
            updateKrsTotalSks();
        });
        closeKrsBtnBottom.addEventListener('click', () => krsContainer.classList.add('hidden'));
        closeKhsBtnBottom.addEventListener('click', () => khsContainer.classList.add('hidden'));
        downloadKrsBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [210, 330]
            });
            const margin = 15;
            let y = 10;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.text('KARTU RENCANA STUDI (KRS)', 105, y, { align: 'center' });
            y += 6;
            pdf.setFontSize(10);
            pdf.text("Markaz Qur'an Al-Maa'un", 105, y, { align: 'center' });
            y += 4;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.text('Semester Ganjil', 105, y, { align: 'center' });
            y += 8;

            pdf.setFontSize(8);
            const info = {
                left: [
                    { label: 'Nama Santri', value: document.getElementById('nama-santri-krs').textContent.substring(1).trim() },
                    { label: 'Jurusan', value: document.getElementById('jurusan-krs').textContent.substring(1).trim() },
                    { label: 'Kelompok', value: document.getElementById('kelompok-krs').textContent.substring(1).trim() }
                ],
                right: [
                    { label: 'Total SKS yang bisa diambil', value: document.getElementById('total-sks-ambil-krs').textContent.substring(1).trim() },
                    { label: 'Kelas', value: document.getElementById('kelas-krs').textContent.substring(1).trim() },
                    { label: 'Materi untuk Bulan ke', value: document.getElementById('materi-bulan-krs').textContent.substring(1).trim() }
                ]
            };
            
            const leftLabelX = margin;
            const leftColonX = leftLabelX + 45;
            const leftValueX = leftColonX + 2;
            const rightLabelX = 110;
            const rightColonX = rightLabelX + 45;
            const rightValueX = rightColonX + 2;
            const lineHeight = 5;

            const maxRows = Math.max(info.left.length, info.right.length);

            for (let i = 0; i < maxRows; i++) {
                if (info.left[i]) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(info.left[i].label, leftLabelX, y);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(':', leftColonX, y);
                    pdf.text(info.left[i].value, leftValueX, y, { maxWidth: rightLabelX - leftValueX - 5 });
                }
                if (info.right[i]) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(info.right[i].label, rightLabelX, y);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(':', rightColonX, y);
                    pdf.text(info.right[i].value, rightValueX, y);
                }
                y += lineHeight;
            }
            
            pdf.autoTable({
                html: '#tabel-krs',
                startY: y,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 8,
                    cellPadding: 1,
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [243, 244, 246],
                    textColor: [31, 41, 55],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                },
                footStyles: {
                    fillColor: [243, 244, 246],
                    textColor: [31, 41, 55],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                    halign: 'right'
                },
                columnStyles: {
                    5: { halign: 'center' } 
                },
                didParseCell: function (data) {
                    if (data.row.section === 'foot') {
                        data.cell.styles.halign = 'right';
                        if(data.column.index === 0) {
                            data.cell.text = data.cell.text[0].replace(/:/g, '');
                        }
                    }
                },
                columns: [
                    { header: 'Hari', dataKey: 0 },
                    { header: 'Waktu', dataKey: 1 },
                    { header: 'Kode', dataKey: 2 },
                    { header: 'Mata Pelajaran / Modul', dataKey: 3 },
                    { header: 'Ruang', dataKey: 4 },
                    { header: 'SKS', dataKey: 5 },
                    { header: 'Guru', dataKey: 6 },
                ]
            });

            pdf.save(`KRS_${document.getElementById('nama-santri-krs').textContent.substring(1).trim()}.pdf`);
        });
        // PERUBAHAN: Mengganti metode unduh KHS dari .html() menjadi .autoTable()
        downloadKhsBtn.addEventListener('click', () => {
            const infoSantriKhs = document.getElementById('info-santri-khs');
            if (!infoSantriKhs || khsContainer.classList.contains('hidden')) {
                showMessage('Tampilkan KHS terlebih dahulu sebelum mengunduh.', 'error');
                return; // KOMENTAR: Hentikan fungsi jika konten KHS tidak terlihat
            }
			
			const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [210, 330] // Menggunakan format standar F4 untuk KHS
            });

            // KOMENTAR: Ambil data dari elemen info KHS
           
            const santriName = infoSantriKhs.querySelector('.flex:nth-child(1) span:last-child').textContent.trim();
            const kelasJurusan = infoSantriKhs.querySelector('.flex:nth-child(2) span:last-child').textContent.trim();
            const semesterBulan = infoSantriKhs.querySelector('.flex:nth-child(3) span:last-child').textContent.trim();
            const klaster = infoSantriKhs.querySelector('.flex:nth-child(4) span:last-child').textContent.trim();
            const fileName = `KHS - ${santriName}.pdf`;

            doc.autoTable({
                html: '#tabel-nilai',
                startY: 55, // KOMENTAR: Atur posisi awal tabel agar ada ruang untuk header
                didDrawPage: function(data) {
                    // KOMENTAR: Fungsi untuk menggambar header PDF secara manual
                    doc.setFontSize(16);
                    doc.setFont("times", "bold");
                    doc.text("KARTU HASIL STUDI (KHS)", doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.setFont("times", "normal");
                    doc.text("Markaz Qur'an Al-Maa'un", doc.internal.pageSize.getWidth() / 2, 28, { align: 'center' });
                    
                    // KOMENTAR: Menggambar informasi santri
                    doc.setFontSize(10);
                    let infoY = 40;
                    doc.text(`Nama Santri: ${santriName}`, data.settings.margin.left, infoY);
                    doc.text(`Semester / Bulan: ${semesterBulan}`, doc.internal.pageSize.getWidth() - data.settings.margin.right, infoY, { align: 'right' });
                    infoY += 6;
                    doc.text(`Kelas / Jurusan: ${kelasJurusan}`, data.settings.margin.left, infoY);
                    doc.text(`Klaster: ${klaster}`, doc.internal.pageSize.getWidth() - data.settings.margin.right, infoY, { align: 'right' });
                },
                theme: 'grid', // KOMENTAR: Menggunakan tema 'grid' agar mirip dengan KRS
                styles: {
                    font: 'times',
                    fontSize: 9,
                    cellPadding: 2,
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [44, 94, 46], // Warna hijau primer
                    textColor: [255, 255, 255],
                    fontStyle: 'bold'
                },
                footStyles: {
                    fillColor: [248, 249, 250], // Warna abu-abu terang
                    textColor: [0, 0, 0],
                    fontStyle: 'bold'
                }
            });

            doc.save(fileName);
        });
    }

    // --- INITIALIZATION ---
    function initializeApp() {
        // Proses semua data jadwal sekali saat aplikasi dimuat
        for (const key in appData.schedules) {
            appState.processedSchedules[key] = processAndFillScheduleData(appData.schedules[key]);
        }

        // Render semua bagian aplikasi
        renderSantriTable();
        renderTeacherTable();
        renderModuleTable();
        renderSchedule(); // Render jadwal awal (Bulan 1)
        populateTeacherFilter();
        
        // Pasang semua event listener
        setupEventListeners();
    }

    initializeApp();
   
    // Tandai bahwa inisialisasi sudah selesai
    isSistemInformasiInitialized = true;
}

  // --- BAGIAN 3: EVENT LISTENERS & INISIALISASI ---

  function setupMainEventListeners() {
    if (ui.donasiBtn) ui.donasiBtn.onclick = () => document.getElementById('donasiModal').style.display = "block";
    if (ui.userProfile) ui.userProfile.onclick = () => openProfileModal();
		
    document.querySelectorAll('.close-button').forEach(btn => { btn.onclick = () => { btn.closest('.modal').style.display = 'none'; }; });
    window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.style.display = "none"; } }
    window.addEventListener('hashchange', updateActiveLink);
    document.querySelectorAll('.toggle-password').forEach(toggle => { toggle.innerHTML = CONFIG.ICONS.eye; toggle.addEventListener('click', function () { const input = this.parentElement.querySelector('input'); if (input.type === 'password') { input.type = 'text'; this.innerHTML = CONFIG.ICONS.eyeOff; } else { input.type = 'password'; this.innerHTML = CONFIG.ICONS.eye; } }); });
    document.getElementById('loginForm')?.addEventListener('submit', handleLoginSubmit);
    document.getElementById('profileForm')?.addEventListener('submit', handleProfileSubmit);
    document.getElementById('changePasswordForm')?.addEventListener('submit', handleChangePasswordSubmit);
    document.getElementById('forgotPasswordVerifyForm')?.addEventListener('submit', handleForgotVerifySubmit);
    document.getElementById('forgotPasswordResetForm')?.addEventListener('submit', handleForgotResetSubmit);
    document.getElementById('attendanceFormGuru')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'guru'));
    document.getElementById('attendanceFormStaf')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'staf'));
    document.getElementById('attendanceFormRapat')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'rapat'));
    document.getElementById('logoutFromProfile')?.addEventListener('click', handleLogout);
    document.getElementById('changePasswordFromProfile')?.addEventListener('click', () => { document.getElementById('profileModal').style.display = 'none'; document.getElementById('changePasswordModal').style.display = 'block'; document.getElementById('changePasswordForm').reset(); });
    document.getElementById('forgotPasswordLink')?.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('forgotPasswordModal').style.display = 'block'; });
    document.querySelectorAll('input[name="role"]').forEach(radio => { radio.addEventListener('change', function() { document.getElementById('attendanceFormGuru').classList.toggle('hidden', this.value !== 'guru'); document.getElementById('attendanceFormStaf').classList.toggle('hidden', this.value !== 'staf'); document.getElementById('attendanceFormRapat').classList.toggle('hidden', this.value !== 'rapat'); }); });
    document.getElementById('isSubstituteTeacher')?.addEventListener('change', function() {
      document.getElementById('substituteTeacherSection').classList.toggle('hidden', !this.checked);
      if (!this.checked) {
        populateTeacherClasses(getActiveSession(), document.getElementById('attendanceDateGuru').value);
      } else {
        const selectedTeacher = document.getElementById('substituteTeacherName').value;
        if (selectedTeacher) {
          populateTeacherClasses(null, document.getElementById('attendanceDateGuru').value, selectedTeacher);
        }
      }
    });
    document.getElementById('attendanceDateGuru')?.addEventListener('change', (e) => {
      const isSubstitute = document.getElementById('isSubstituteTeacher').checked;
      const selectedTeacher = document.getElementById('substituteTeacherName').value;
      if (isSubstitute && selectedTeacher) {
        populateTeacherClasses(null, e.target.value, selectedTeacher);
      } else {
        populateTeacherClasses(getActiveSession(), e.target.value);
      }
    });
    document.getElementById('substituteTeacherName')?.addEventListener('change', (e) => {
      const selectedTeacher = e.target.value;
      const selectedDate = document.getElementById('attendanceDateGuru').value;
      populateTeacherClasses(null, selectedDate, selectedTeacher);
    });
		
  }

  function initializeApp() {
    updateDateTime();
    setTodayDate();
		
   
    const session = getActiveSession();
    if (session && session.loggedIn) {
      showLoggedInView(session.userData);
      logUserVisit();
      fetchDailyVisitors();
    } else {
      showLoggedOutView();
    }
   const currentHash = window.location.hash || '#beranda';
    if (currentHash === '#beranda') {
        showAnnouncementPopup();
    }
    updateActiveLink();
    setupMainEventListeners();
		setupAdvancedDropdown(); 
    renderNewsCards();
    renderGalleryCards();
    fetchMarqueeText();
    renderDynamicCalendar(2025, 7, 12);
    setupSlideshow();
    populateSubstituteTeachers();
		setupSantriSelectorListeners();
		renderExamSchedule();
    setupExamListeners();
	setupResultModalListeners();
	setupInputSoalPage();
  }

// HAPUS FUNGSI LAMA setupDropdownMobile() DAN GANTI DENGAN INI
function setupAdvancedDropdown() {
    const dropbtn = document.querySelector('#sistemInformasiDropdown .dropbtn');
    const dropdownContent = document.querySelector('#sistemInformasiDropdown .dropdown-content');
    
    // Jika elemen tidak ditemukan, hentikan fungsi
    if (!dropbtn || !dropdownContent) return;

    const originalParent = dropdownContent.parentElement; // Simpan "rumah" asli dari submenu

    // Fungsi untuk menutup menu
    const closeMenu = () => {
        if (dropdownContent.classList.contains('dropdown-content-show')) {
            dropdownContent.classList.remove('dropdown-content-show');
            dropbtn.classList.remove('active');
            // Kembalikan submenu ke "rumah" aslinya setelah animasi selesai
            setTimeout(() => {
                originalParent.appendChild(dropdownContent);
                // Hapus style posisi agar tidak bentrok nanti
                dropdownContent.style.left = '';
                dropdownContent.style.top = '';
                dropdownContent.style.width = '';
            }, 150);
        }
    };

    // Saat tombol "Sistem Informasi" di-klik
    dropbtn.addEventListener('click', function(event) {
        event.preventDefault();
        event.stopPropagation(); // Mencegah klik menyebar ke window

        const isMenuOpen = dropdownContent.classList.contains('dropdown-content-show');

        if (isMenuOpen) {
            closeMenu();
        } else {
            // "Bebaskan" submenu dengan memindahkannya ke <body>
            document.body.appendChild(dropdownContent);

            // Hitung posisi tombol di layar
            const btnRect = dropbtn.getBoundingClientRect();

            // Atur posisi submenu tepat di bawah tombol
            dropdownContent.style.left = `${btnRect.left}px`;
            dropdownContent.style.top = `${btnRect.bottom}px`;
            // Samakan lebar submenu dengan tombolnya agar rapi
            dropdownContent.style.width = `${btnRect.width}px`;

            // Tampilkan submenu
            dropdownContent.classList.add('dropdown-content-show');
            dropbtn.classList.add('active');
        }
    });

    // Tambahkan event listener untuk menutup menu jika mengklik di tempat lain
    window.addEventListener('click', closeMenu);
}
    


  // --- MULAI APLIKASI ---
  initializeApp();
});
</script>
</body>
</html>
