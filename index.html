<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster KBM Interaktif - RTQ Markaz Qur'an Al-Maa'un</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>




/* Tambahkan ini di dalam tag <style> Anda */

/* Kelas ini akan ditambahkan oleh JS untuk menampilkan sidebar di mobile */
#filter-sidebar.show {
    transform: translateX(0);
}

/* Cetak: Sembunyikan sidebar dan tombolnya saat mencetak */
@media print {
    #page-wrapper {
        display: block; /* Kembalikan ke layout normal saat print */
    }
    #filter-sidebar, #open-filter-btn {
        display: none !important;
    }
    #main-content {
        padding: 0;
        margin: 0;
    }
}
        body { 
            font-family: 'Inter', sans-serif; 
        }

        /* Grid Layout for Schedule */
        .schedule-grid {
            display: grid;
            grid-template-columns: 90px repeat(6, 1fr);
            gap: 4px;
        }

.time-slot {
    font-weight: 600;
    text-align: center;
    padding: 8px 4px;
    /* Membuat kolom waktu menempel di kiri */
    position: sticky;
    left: 0;
    z-index: 15; /* Z-index lebih tinggi dari header hari */
    background-color: #f1f5f9; /* Pastikan ada background */
}

.day-header {
    font-weight: 600;
    text-align: center;
    padding: 8px 4px;
    /* Membuat header hari menempel di atas */
    position: sticky;
    top: 0;
    z-index: 10; /* Z-index agar di atas sel jadwal */
    background-color: #f1f5f9; /* Pastikan ada background, misal bg-slate-100 */
}

/* Ini untuk menargetkan sel pojok kiri atas (persimpangan header dan waktu) */
.schedule-grid > .day-header:first-child {
    left: 0; /* Menempel juga di kiri */
    z-index: 20; /* Z-index paling tinggi agar di atas segalanya */
}
        .schedule-cell {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            min-height: 120px;
            transition: all 0.3s ease-in-out;
            background-color: white;
            display: flex;
            flex-direction: column;
        }

        /* Highlighting and Effects */
        .highlight {
            background-color: #f0fdfa; /* teal-50 */
            border-color: #14b8a6; /* teal-500 */
            transform: scale(1.03);
            z-index: 10;
            position: relative;
            animation: glow-animation 2s ease-in-out infinite;
        }

        .dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }

        @keyframes glow-animation {
            0% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); }
            50% { box-shadow: 0 0 20px 5px rgba(20, 184, 166, 0.8); }
            100% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); }
        }

        /* Room Specific Styles */
        .room-rbm {
            background-color: #fff7ed; /* orange-50 */
            border-color: #fb923c;   /* orange-400 */
            border-style: dashed;
        }
        .room-rbm .subject {
            font-style: italic;
            color: #c2410c; /* orange-700 */
        }
        .room-madinah {
            background-color: rgba(59, 130, 246, 0.1); /* blue-500 with 10% opacity */
            border-color: #60a5fa; /* blue-400 */
        }
        .room-mekah {
            background-color: rgba(132, 204, 22, 0.1); /* lime-500 with 10% opacity */
            border-color: #a3e635; /* lime-400 */
        }

        .subject {
            flex-grow: 1;
        }

        /* Custom Select Arrow */
        .filter-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Editable Cell Styles */
        .editable-cell {
            background-color: #f0fdfa;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: text;
        }
        .editable-cell:focus {
            background-color: #ccfbf1;
            outline: 2px solid #14b8a6;
        }

        /* Floating Action Buttons (FAB) */
        #floating-action-buttons {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #floating-action-buttons button {
            position: relative;
            display: flex;
            align-items: center;
        }
        .fab-label {
            position: absolute;
            right: 100%;
            margin-right: 16px;
            background-color: #1f2937; /* bg-gray-800 */
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(10px);
            pointer-events: none;
            transition: all 0.2s ease-in-out;
        }
        #floating-action-buttons button:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }

        /* Print Styles */
        @media print {
            @page {
                size: landscape;
                margin: 2cm;
            }
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            header, .sticky.top-0, #floating-action-buttons, #teacher-data-container, #module-data-container {
                display: none !important;
            }
            #schedule-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                padding: 0;
                overflow: visible;
            }
            .schedule-grid {
                font-size: 8pt;
                gap: 1px;
                border: 1px solid #ccc;
            }
            .schedule-cell {
                min-height: auto;
                padding: 4px;
                border: 1px solid #eee;
            }
            .schedule-cell .room, .schedule-cell .teacher {
                font-size: 12pt;
            }
            .highlight, .dimmed {
                transform: none;
                opacity: 1;
                filter: none;
                animation: none;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="page-wrapper" class="relative min-h-screen lg:flex">

        <aside id="filter-sidebar" class="bg-white lg:bg-transparent w-72 lg:w-80 p-4 border-r border-slate-200 fixed lg:sticky top-0 h-full lg:h-screen overflow-y-auto z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-teal-800">Filter Jadwal</h3>
                <button id="close-filter-btn" class="lg:hidden text-slate-500 hover:text-slate-800">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label for="filter-group" class="block text-sm font-medium text-slate-700">Kelompok</label>
                    <select id="filter-group" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Kelompok</option>
                        <option value="KF">Kelas Fondasi</option>
                        <option value="KG">Kelas Gabungan</option>
                    </select>
                </div>
                <div>
                    <label for="filter-cluster" class="block text-sm font-medium text-slate-700">Klaster</label>
                    <select id="filter-cluster" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md" disabled>
                        <option value="all">Semua Klaster</option>
                        <option value="LKS">Literasi & Kreatif Syariah</option>
                        <option value="STT">Sains & Teknologi Terapan</option>
                    </select>
                </div>
                <div>
                    <label for="filter-teacher" class="block text-sm font-medium text-slate-700">Guru</label>
                    <select id="filter-teacher" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Guru</option>
                        </select>
                </div>
                <div>
                    <label for="filter-room" class="block text-sm font-medium text-slate-700">Ruang</label>
                    <select id="filter-room" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Ruang</option>
                        <option value="Kelas Mekah">Kelas Mekah</option>
                        <option value="Kelas Madinah">Kelas Madinah</option>
                        <option value="RBM">RBM</option>
                    </select>
                </div>
                <div>
                    <button id="reset-filters" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition">
                        Reset Filter
                    </button>
                </div>
            </div>
        </aside>

        <div id="filter-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <main id="main-content" class="flex-1 p-4 md:p-6">
            <header class="text-center mb-6">
                 <div class="lg:hidden mb-4">
                    <button id="open-filter-btn" class="w-full flex items-center justify-center gap-2 bg-white p-3 rounded-lg shadow font-semibold text-teal-700">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                        </svg>
                        Buka Filter
                    </button>
                </div>

                <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Roster KBM Dinamis</h1>
                <h2 class="text-3xl md:text-4xl font-bold text-teal-800">Markaz Qur'an Al-Maa'un</h2>
                <p class="text-slate-600 mt-2">Semester Ganjil</p>
            </header>

            <div id="schedule-container" class="bg-white p-2 rounded-xl shadow-lg overflow-auto max-h-[80vh]">
                </div>
            
            <div id="teacher-data-container" class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-teal-800">Data Guru</h3>
                    <button id="add-teacher-row" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Tambah Guru
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="teacher-table" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Guru</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bidang / Jurusan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hari</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jadwal (Slot Waktu)</th>
                                <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
            </div>
            
            <div id="module-data-container" class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold text-teal-800">Data Modul</h3>
                    <button id="add-module-row" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        Tambah Modul
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="module-table" class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th>
                                <th scope="col" id="sort-by-guru" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer hover:bg-slate-200 transition">
    <span>Guru</span>
    <span id="sort-guru-indicator"></span> </th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Mapel Induk</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kode Modul</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Modul</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">SKS</th>
                                <th scope="col" class="relative px-6 py-3 w-20"><span class="sr-only">Aksi</span></th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
            </div>

        </main>

    <!-- Floating Action Buttons -->
    <div id="floating-action-buttons">
        <button id="reset-schedule" title="Reset Jadwal ke Awal" class="bg-red-600 text-white rounded-full p-3 shadow-lg hover:bg-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Reset Jadwal</span>
        </button>
        <button id="print-schedule" title="Cetak Jadwal" class="bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Cetak</span>
        </button>
        <button id="download-jpg" title="Unduh sebagai JPG" class="bg-green-600 text-white rounded-full p-3 shadow-lg hover:bg-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Unduh Jadwal</span>
        </button>
    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">Konfirmasi</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message">Apakah Anda yakin?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Ya, Lanjutkan
                    </button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {

// ===== KODE BARU UNTUK SIDEBAR =====
    const sidebar = document.getElementById('filter-sidebar');
    const overlay = document.getElementById('filter-overlay');
    const openBtn = document.getElementById('open-filter-btn');
    const closeBtn = document.getElementById('close-filter-btn');

    const toggleSidebar = () => {
        sidebar.classList.toggle('show');
        overlay.classList.toggle('hidden');
    };

    if (openBtn) {
        openBtn.addEventListener('click', toggleSidebar);
    }
    if (closeBtn) {
        closeBtn.addEventListener('click', toggleSidebar);
    }
    if (overlay) {
        overlay.addEventListener('click', toggleSidebar);
    }
    // ===== AKHIR KODE BARU =====


        // --- DATA ---
const initialScheduleData = [
    // Senin
    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
    { day: "Senin", time: "08:00-09:30", sks: 2, room: "RBM", group: "kelompok", cluster: "klaster", subject: "Kosong", teacher: "Kosong", downloadLink: "" },
    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-101: Menyimak Efektif: Adab & Teknik", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1PAGwVSmVj3_JFW6mekxZGK7xZh54XlDH/view?usp=drive_link" },
    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-201: Pengantar Thibbun Nabawi", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ZjmZkzVknCL8sNPz4nWwaARTN62AN1qG/view" },
    { day: "Senin", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Tugas : MAT-101", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
    { day: "Senin", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Senin", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Senin", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "LKS", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-101: Greetings & Introductions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1LYRMv43xr0ei9aHJ4Rm8VVGEZv2LMoJT/view?usp=drive_link" },
    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-201: Riset Pasar & Analisis Kompetitor", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/KWU-201.pdf" },
    { day: "Senin", time: "13:00-14:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Tugas: MAT-101", teacher: "Sulistiawan, S.Kom", downloadLink: "" },

    // Selasa
    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-101: ABY Jilid 1A Unit 1-2 (Perkenalan & Keluarga)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/1KNuZMEsYPEznGzEcyhTR5GDb5J3gUwM5/view?usp=drive_link" },
    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "KES-201: Pengantar Anatomi & Fisiologi", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/KES-201.pdf" },
    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Tugas: PAI-201: Public Speaking 1: Struktur Pidato & Mengatasi Gugup", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-201: ABY Jilid 1B Unit 7-8 (Pendidikan & Pekerjaan)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://drive.google.com/file/d/19dfcrahHUBSjFQx0bNvcGDxm2gJw35Tt/view?usp=drive_link" },
    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-101: Pertolongan Pertama Pada Kecelakaan (P3K)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/KTR-101.pdf" },
    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "", teacher: "", downloadLink: "" },
    { day: "Selasa", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Selasa", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KF", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Selasa", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "STT", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-101: Makna & Konsekuensi 2 Kalimat Syahadat", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://url-penyimpanan-anda.com/modul/TAU-101.pdf" },
    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-201: Gerak Lurus dan Gaya", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/170mKM_vLYEeO0tIUOP063-k1wMW1a1jD/view?usp=drive_link" },
    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "Materi", teacher: "", downloadLink: "" },

    // Rabu
    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-201: Pengantar Ilmu Hadits (Definisi & Sejarah)", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://url-penyimpanan-anda.com/modul/ULH-201.pdf" },
    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-101: Pengantar Mindset Wirausaha Muslim", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/KWU-101.pdf" },
    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-201: Pengenalan Alat-Alat Servis", teacher: "Aria Atmaja", downloadLink: "https://url-penyimpanan-anda.com/modul/TME-201.pdf" },
    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPS-101: Aku & Lingkungan Sekitarku", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1FlPhTpeWb9ARmQRa8g-dV74_tabkmwFI/view?usp=drive_link" },
    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "PANC-201: Implementasi nilai-nilai Pancasila Dalam Kehidupan", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/PANC-201.pdf" },
    { day: "Rabu", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Rabu", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-201: Hobbies & Free Time", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/15-9a1S4ogBTjKjG6i2_268-tLqrquC4P/view?usp=drive_link" },
    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-101: Hadits Arba'in 1 (Hafalan & Makna Hadits #1-5", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/HAD-101.pdf" },

    // Kamis
    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-101: Pengenalan Perangkat Keras & Lunak Komputer", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/TIK-101.pdf" },
    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-201: Studi Kitab Tauhid 1", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/TAU-201.pdf" },
    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "", teacher: "", downloadLink: "" },
    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-201: Pengolah Kata (Word) Lanjutan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/TIK-201.pdf" },
    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-201: Masuk dan Berkembangnya Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/IPS-201.pdf" },
    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "RBM", group: "KF", cluster: "Wajib", subject: "Tugas: MAT-101", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
    { day: "Kamis", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Kamis", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-101: Ciri Makhluk Hidup & Klasifikasi Sederhana", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/IPA-101.pdf" },
    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-201: Sejarah Penulisan & Pengumpulan Al-Qur'an", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/ULQ-201.pdf" },

    // Jumat
    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-101: Wudhu & Tayammum", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/FIQ-101.pdf" },
    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-201: Tanda-tanda I'rab untuk Isim", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://url-penyimpanan-anda.com/modul/NAH-201.pdf" },
    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "AGB-201: Pengantar Agribisnis & Fikih Pertanian", downloadLink: "Sulistiawan, S.Kom" },
    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-101: Kondisi Dunia Sebelum Kenabian & Masa Kecil Nabi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/SIR-101.pdf" },
    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-101: Pengantar Ilmu Balaghah", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://url-penyimpanan-anda.com/modul/BAL-203.pdf" },
    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "IPS-201: Masuk dan Berkembangnya Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "" },

    // Sabtu
    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-201: Tafsir & Tadabbur Surat Al-Maa'un & Al-Kafirun", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/TAF-201.pdf" },
    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-101: Adab Kepada Allah", teacher: "Erwan Syahputra, S.Pd", downloadLink: "https://url-penyimpanan-anda.com/modul/AKH-101.pdf" },
    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "", teacher: "", downloadLink: "" },
    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-101: Tafsir & Tadabbur Surat Al-Fatihah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/TAF-101.pdf" },
    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-201: Membaca 3 (Membedakan Fakta & Opini dalam Teks)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/IND-201.pdf" },
    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "", teacher: "", downloadLink: "" },
    { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "STT", subject: "ISTIRAHAT TIDUR SIANG", teacher: "", downloadLink: "" },
    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-201: Peristiwa Boikot & Wafatnya Khadijah dan Abu Thalib", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/SIR-201.pdf" },
    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-101: Pengenalan Kalimat (Jumlah Mufidah) & Jenis Kata", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "https://url-penyimpanan-anda.com/modul/NAH-101.pdf" },
    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "RBM", group: "", cluster: "", subject: "", teacher: "", downloadLink: "" },
];


        
        const defaultTeachers = [
            { no: 1, name: "Sulistiawan, S.Kom", major: "Pelajaran Umum & Keterampilan", hari: "Semua hari & jam", schedule: "Guru Cadangan" },
            { no: 2, name: "Zhofri F. Majdi, S.Sos", major: "Diniyah", hari: "Kamis, Jumat, Sabtu", schedule: "Kamis (08-10), Jumat & Sabtu (Semua Jam)" },
            { no: 3, name: "M. Ryza Anshori, S.Pd", major: "Diniyah", hari: "Jumat", schedule: "Semua Jam" },
            { no: 4, name: "Erwan Syahputra, S.Pd", major: "Diniyah", hari: "Selasa, Rabu, Sabtu", schedule: "Selasa (Semua Jam), Rabu & Sabtu (sampai 10.00)" },
            { no: 5, name: "Ariyanti R. Siregar, S.Kom", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "12.45 - 14.15" },
            { no: 6, name: "Mia A. Lubis, S.Kom", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "10.00 - 12.15 (Guru Cadangan)" },
            { no: 7, name: "Mahadi Sentosa, S.Sos", major: "Diniyah", hari: "Sabtu", schedule: "13.00-14.30" },
        ];

        // ===== LOGIKA PEMBUATAN MODUL =====
        const parentSubjectMap = { 'MAT': 'Matematika', 'IND': 'Bahasa Indonesia', 'THI': 'Thibbun Nabawi', 'ENG': 'Bahasa Inggris', 'KWU': 'Kewirausahaan', 'ARB': 'Bahasa Arab', 'KES': 'Kesehatan', 'KTR': 'Keterampilan', 'TAU': 'Tauhid', 'IPA': 'IPA Terpadu', 'ULH': 'Ulumul Hadits', 'TME': 'Teknik Mekanik Elektronik', 'IPS': 'IPS Terpadu', 'PANC': 'Pancasila', 'HAD': 'Hadits', 'TIK': 'Teknologi Informasi', 'ULQ': 'Ulumul Quran', 'FIQ': 'Fiqih', 'NAH': 'Nahwu', 'SIR': 'Sirah Nabawiyah', 'BAL': 'Balaghah', 'TAF': 'Tafsir', 'AKH': 'Akhlak' };
        const majorMap = { 'LKS': 'Literasi & Kreatif Syariah', 'STT': 'Sains & Teknologi Terapan', 'Wajib': 'Jurusan Wajib', '': 'Kelas Fondasi' };
        const uniqueModules = {};
        initialScheduleData.forEach(item => {
            if (item.subject && item.subject.includes(':')) {
                if (!uniqueModules[item.subject]) {
                    uniqueModules[item.subject] = {
                        
                        teacher: item.teacher || "N/A",
                        link: item.downloadLink || ""
                    };
                }
            }
        });
        let moduleCounter = 1;
        const defaultModules = Object.keys(uniqueModules).map(subject => {
            const itemData = uniqueModules[subject];
            const [code, ...nameParts] = subject.split(':');
            const moduleName = nameParts.join(':').trim();
            const prefix = code.trim().split('-')[0];
            return {
                no: moduleCounter++,
                teacher: itemData.teacher,
                parent_subject: parentSubjectMap[prefix] || 'Lainnya',
                code: code.trim(),
                module: moduleName,
               
                downloadLink: itemData.link
            };
        });
        
        // // 1. Mengurutkan array defaultModules berdasarkan nama guru (properti 'teacher')
        defaultModules.sort((a, b) => a.teacher.localeCompare(b.teacher));

        // 2. Memperbarui nomor urut (properti 'no') setelah data diurutkan
        defaultModules.forEach((mod, index) => {
            mod.no = index + 1;
        });






        // --- GLOBAL STATE ---
        let scheduleData = JSON.parse(localStorage.getItem('mySchedule')) || initialScheduleData;

        // --- DOM ELEMENTS ---
        const scheduleContainer = document.getElementById('schedule-container');
        const filterGroup = document.getElementById('filter-group');
        const filterCluster = document.getElementById('filter-cluster');
        const filterTeacher = document.getElementById('filter-teacher');
        const filterRoom = document.getElementById('filter-room');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const teacherTableBody = document.querySelector('#teacher-table tbody');
        const addTeacherBtn = document.getElementById('add-teacher-row');
        const moduleTableBody = document.querySelector('#module-table tbody');
        const addModuleBtn = document.getElementById('add-module-row');
        const modal = document.getElementById('confirmation-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalMessage = document.getElementById('modal-message');

        // --- UTILITY & HELPER FUNCTIONS ---
        const showConfirmation = (message) => {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
                const confirmHandler = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(true);
                };
                const cancelHandler = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(false);
                };
                const cleanup = () => {
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                };
                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        };
        const saveSchedule = () => {
            localStorage.setItem('mySchedule', JSON.stringify(scheduleData));
        };
        const createEditableCell = (content) => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap';
            const div = document.createElement('div');
            div.className = 'text-sm text-slate-900 editable-cell';
            div.setAttribute('contenteditable', 'true');
            div.textContent = content;
            cell.appendChild(div);
            return cell;
        };

        // --- SCHEDULE RENDER & FILTER LOGIC ---
        const populateTeacherFilter = () => {
            const teachers = [...new Set(scheduleData.map(item => item.teacher).filter(Boolean))];
            teachers.sort();
            filterTeacher.innerHTML = '<option value="all">Semua Guru</option>';
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                filterTeacher.appendChild(option);
            });
        };
        const renderSchedule = () => {
            scheduleContainer.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';
            const days = ["", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const timeSlots = ["08:00-09:30", "10:00-11:30", "11:30-12:15", "13:00-14:30"];
            const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];
            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header text-slate-600 bg-slate-100';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });
            timeSlots.forEach(time => {
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-slot text-teal-700 bg-slate-100 flex items-center justify-center';
                timeHeader.textContent = time;
                grid.appendChild(timeHeader);
                days.slice(1).forEach(day => {
                    const cellContainer = document.createElement('div');
                    cellContainer.className = 'p-1 bg-slate-100 rounded-lg space-y-1 flex flex-col justify-around';
                    const dayTimeData = scheduleData.filter(item => item.day === day && item.time === time);
                    if (day === 'Jumat' && time === '11:30-12:15') {
                        // ... logic jumat bersih
                    } else {
                        rooms.forEach(room => {
                            const item = dayTimeData.find(d => d.room === room);
                            const cell = document.createElement('div');
                            cell.className = 'schedule-cell';
                            if (item) {
                                cell.dataset.group = item.group;
                                cell.dataset.teacher = item.teacher;
                                cell.dataset.room = item.room;
                                cell.dataset.cluster = item.cluster;
                                if (item.room === 'RBM') cell.classList.add('room-rbm');
                                if (item.room === 'Kelas Madinah') cell.classList.add('room-madinah');
                                if (item.room === 'Kelas Mekah') cell.classList.add('room-mekah');
                                let displayGroup = item.group;
                                if (item.group === 'KG' && item.cluster) {
                                    displayGroup = `KG (${item.cluster})`;
                                }
                                cell.innerHTML = `<div class="subject font-bold text-sm text-teal-900" contenteditable="true">üìò${item.subject}</div><div class="group-display font-semibold text-xs text-slate-600">üßë‚Äçü§ù‚Äçüßë${displayGroup}</div><div class="sks-display font-bold text-xs text-teal-500 text-right"> ${item.sks} SKS</div><div class="teacher font-semibold text-xs text-teal-600 mt-2" contenteditable="true">üë§${item.teacher || ''}</div><div class="room text-xs font-semibold ${item.room === 'RBM' ? 'text-orange-700' : 'text-sky-700'} mt-1">üìç ${item.room}</div>`;
                            }
                            cellContainer.appendChild(cell);
                        });
                    }
                    grid.appendChild(cellContainer);
                });
            });
            scheduleContainer.appendChild(grid);
            applyFilters();
        };
        const applyFilters = () => {
            const group = filterGroup.value;
            let cluster = filterCluster.value;
            const teacher = filterTeacher.value;
            const room = filterRoom.value;
            filterCluster.disabled = (group !== 'KG');
            if (group !== 'KG') {
                filterCluster.value = 'all';
                cluster = 'all';
            }
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                const cellData = cell.dataset;
                if (!cellData.group) {
                    cell.classList.remove('highlight', 'dimmed');
                    return;
                }
                let isMatch = true;
                if (group !== 'all' && cellData.group !== group) isMatch = false;
                if (cluster !== 'all' && cellData.cluster !== cluster && cellData.cluster !== 'Wajib') isMatch = false;
                if (teacher !== 'all' && cellData.teacher !== teacher) isMatch = false;
                if (room !== 'all' && cellData.room !== room) isMatch = false;
                if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
                    cell.classList.remove('highlight', 'dimmed');
                } else if (isMatch) {
                    cell.classList.add('highlight');
                    cell.classList.remove('dimmed');
                } else {
                    cell.classList.remove('highlight');
                    cell.classList.add('dimmed');
                }
            });
        };
        
        // --- DATA TABLE LOGIC ---
        const addTableRow = (tableBody, data, createRowFn) => {
            const row = createRowFn(data);
            tableBody.appendChild(row);
        };
        const updateRowNumbers = (tableBody) => {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        };
        const createDeleteButton = (row, tableBody) => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
            const button = document.createElement('button');
            button.className = 'text-red-600 hover:text-red-900';
            button.innerHTML = 'Hapus';
            button.onclick = async () => {
                const confirmed = await showConfirmation('Apakah Anda yakin ingin menghapus baris ini?');
                if (confirmed) {
                    row.remove();
                    updateRowNumbers(tableBody);
                }
            };
            cell.appendChild(button);
            return cell;
        };
        const createTeacherRow = (teacherData) => {
            const row = document.createElement('tr');
            const noCell = document.createElement('td');
            noCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500';
            noCell.textContent = teacherData.no;
            row.appendChild(noCell);
            row.appendChild(createEditableCell(teacherData.name));
            row.appendChild(createEditableCell(teacherData.major));
            row.appendChild(createEditableCell(teacherData.hari));
            row.appendChild(createEditableCell(teacherData.schedule));
            row.appendChild(createDeleteButton(row, teacherTableBody));
            return row;
        };

        // ===== FUNGSI createModuleRow YANG SUDAH DIPERBAIKI =====
        const createModuleRow = (moduleData) => {
            const row = document.createElement('tr');
            
            // Tambah sel No, Jurusan, Mapel Induk, Kode, Modul, SKS
            const noCell = document.createElement('td');
            noCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500';
            noCell.textContent = moduleData.no;
            row.appendChild(noCell);
            row.appendChild(createEditableCell(moduleData.teacher));
            row.appendChild(createEditableCell(moduleData.parent_subject));
            row.appendChild(createEditableCell(moduleData.code));
            row.appendChild(createEditableCell(moduleData.module));
            row.appendChild(createEditableCell(moduleData.sks));

            // Tambah sel untuk Tombol Aksi (Unduh)
            const actionCell = document.createElement('td');
            actionCell.className = 'px-6 py-4 whitespace-nowrap text-center';
            if (moduleData.downloadLink) {
                const downloadLink = document.createElement('a');
                downloadLink.href = moduleData.downloadLink;
                        // Buka link di tab baru, bukan langsung download
        downloadLink.setAttribute('target', '_blank');
        downloadLink.setAttribute('rel', 'noopener noreferrer'); // Tambahan untuk keamanan
 
                downloadLink.className = 'inline-flex items-center gap-2 bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-green-200 transition';
                downloadLink.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg> Unduh`;
                actionCell.appendChild(downloadLink);
            } else {
                const noLinkButton = document.createElement('span');
                noLinkButton.className = 'inline-flex items-center gap-2 bg-slate-100 text-slate-500 text-xs font-semibold px-2.5 py-1 rounded-full cursor-not-allowed';
                noLinkButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg> Kosong`;
                actionCell.appendChild(noLinkButton);
            }
            row.appendChild(actionCell);
            
            // Tambah sel untuk Tombol Hapus
            row.appendChild(createDeleteButton(row, moduleTableBody));
            
            return row;
        };

        // --- EVENT LISTENERS ---
        filterGroup.addEventListener('change', applyFilters);
        filterCluster.addEventListener('change', applyFilters);
        filterTeacher.addEventListener('change', applyFilters);
        filterRoom.addEventListener('change', applyFilters);
        resetFiltersBtn.addEventListener('click', () => {
            filterGroup.value = 'all';
            filterCluster.value = 'all';
            filterTeacher.value = 'all';
            filterRoom.value = 'all';
            applyFilters();
        });
        document.getElementById('reset-schedule').addEventListener('click', async () => {
            const confirmed = await showConfirmation('Apakah Anda yakin ingin mengembalikan jadwal ke data semula? Semua perubahan akan hilang.');
            if (confirmed) {
                localStorage.removeItem('mySchedule');
                scheduleData = initialScheduleData;
                renderSchedule();
                populateTeacherFilter();
            }
        });
        document.getElementById('print-schedule').addEventListener('click', () => window.print());
        document.getElementById('download-jpg').addEventListener('click', function() {
            const downloadBtn = this;
            const label = downloadBtn.querySelector('.fab-label');
            const originalText = label.textContent;
            const scheduleContainer = document.getElementById('schedule-container');
            label.textContent = 'Menyiapkan...';
            downloadBtn.disabled = true;
            const options = {
                scale: 2,
                useCORS: true,
                onclone: (documentClone) => {
                    const container = documentClone.getElementById('schedule-container');
                    if (container) {
                        container.style.maxHeight = 'none';
                        container.style.overflow = 'visible';
                    }
                }
            };
            html2canvas(scheduleContainer, options).then(canvas => {
                const link = document.createElement('a');
                link.download = 'jadwal-kbm-keseluruhan.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                label.textContent = originalText;
                downloadBtn.disabled = false;
            }).catch(err => {
                console.error("Gagal membuat gambar jadwal:", err);
                label.textContent = "Gagal Unduh";
                setTimeout(() => {
                    label.textContent = originalText;
                    downloadBtn.disabled = false;
                }, 3000);
            });
        });
        addTeacherBtn.addEventListener('click', () => {
            const newRowNumber = teacherTableBody.rows.length + 1;
            const newTeacherData = { no: newRowNumber, name: "Nama Guru Baru", major: "Bidang/Jurusan", hari: "Masukkan Hari", schedule: "Waktu Jadwal" };
            addTableRow(teacherTableBody, newTeacherData, createTeacherRow);
        });
        addModuleBtn.addEventListener('click', () => {
            const newRowNumber = moduleTableBody.rows.length + 1;
            const newModuleData = { no: newRowNumber, teacher: "Nama Guru baru", parent_subject: "Mapel Induk", code: "Kode-Baru", module: "Nama Modul Baru", sks: "0 SKS", downloadLink: "" };
            addTableRow(moduleTableBody, newModuleData, createModuleRow);
        });

        // --- INITIALIZATION ---
        teacherTableBody.innerHTML = '';
        defaultTeachers.forEach(teacher => addTableRow(teacherTableBody, teacher, createTeacherRow));
        
        moduleTableBody.innerHTML = ''; 
        defaultModules.forEach(mod => addTableRow(moduleTableBody, mod, createModuleRow));

        populateTeacherFilter();
        renderSchedule();
    });
    </script>
</body>
</html>
