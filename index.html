<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yayasan Markaz Yatim Duafa Qurani - Beranda</title>
    
    <!-- Script & Font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Times+New+Roman&display=swap" rel="stylesheet">
	<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css" />
	<script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"></script>
	<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.2/dist/browser-image-compression.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Bagian CSS untuk Styling -->
    <style>
        :root {
            --primary-color: #2c5e2e;
            --secondary-color: #ffc107;
            --light-gray: #f8f9fa;
            --dark-gray: #343a40;
            --success-color: #28a745;
            --error-color: #dc3545;
            --info-color: #0d6efd; 
            --info-color-hover: #0b5ed7;
			/* Variabel CSS dari jadwalsholat.html */
            --sky-day: linear-gradient(to top, #87CEEB 0%, #3a94c4 100%);
            --sky-night: linear-gradient(to top, #465270 0%, #191d2e 100%);
            --danger-color: #dc3545;
            --highlight-bg: #e6ffed;
            --highlight-border: #a3d9b1;
            --highlight-text: #28a745;
        }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            line-height: 1.7;
        }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; padding: 20px 0; }
        header { background-color: #ffffff; padding: 20px 0; border-bottom: 1px solid #e9ecef; }
        header .header-content { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 20px; }
        header .logo-container { display: flex; align-items: center; }
        header img.logo { height: 60px; margin-right: 15px; }
        header .title-container h1 { margin: 0; font-size: 1.8em; color: var(--primary-color); }
        header .title-container p { margin: 0; font-size: 0.9em; color: #6c757d; }
        #date-display { text-align: right; font-size: 0.9em; color: var(--dark-gray); line-height: 1.5; }
        #date-display .hijri-date { font-weight: 600; color: var(--primary-color); }
        .header-right-items { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
        
        .nav-wrapper { position: sticky; top: 0; z-index: 1001; background-color: var(--primary-color); }
        .nav-container-wrapper { position: relative; width: 90%; max-width: 1200px; margin: 0 auto; overflow: visible; }
        nav .nav-container { display: flex; align-items: center; flex-wrap: nowrap; overflow: visible; scrollbar-width: none; -ms-overflow-style: none; }
        nav .nav-container::-webkit-scrollbar { display: none; }
        nav a { color: #ffffff; padding: 15px 20px; text-decoration: none; font-weight: 500; transition: background-color: 0.3s; border-radius: 4px; white-space: nowrap; }
        nav a:hover, nav a.active { background-color: #1e4220; }
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background-color: rgba(44, 94, 46, 0.8); color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        .nav-arrow.visible { opacity: 1; pointer-events: auto; }
        #nav-arrow-left { left: -15px; }
        #nav-arrow-right { right: -15px; }
        @media (max-width: 768px) { 
		.fundraising-wrapper {
        flex-direction: column; /* Mengubah arah item menjadi vertikal */
        align-items: center;    /* Memusatkan kartu-kartu di tengah */
        overflow-x: visible;    /* Menonaktifkan scroll horizontal */
        gap: 25px;              /* Menambah jarak vertikal antar kartu */
    }

    .fundraising-card {
        flex: 0 0 90%;          /* Kartu tidak menyusut/melebar, dengan lebar 90% dari kontainer */
        max-width: 400px;       /* Mencegah kartu menjadi terlalu lebar di tablet */
    }
	.nav-arrow { background-color: rgba(44, 94, 46, 0.5); } }

/* Tambahkan selector ini ke CSS Anda */
#pengunjung-hari-ini {
    background-color: #fef9c3; /* Warna kuning muda */
    border: 1px solid #fde047;
}
#visitor-list {
    list-style-type: none;
    padding: 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}
#visitor-list li {
    background-color: var(--primary-color);
    color: white;
    padding: 5px 12px;
    border-radius: 15px;
    font-size: 0.9em;
    font-weight: 500;
}

#ujianOnlineNav {
    background-color: #ff69b4; /* Warna pink */
}

.santri-hide {
    display: none !important;
}


        #attendanceNav { background-color: var(--error-color); }
        #attendanceNav:hover, #attendanceNav.active { background-color: #c82333; }
        #sistemInformasiNav { background-color: var(--info-color); }
        #sistemInformasiNav:hover, #sistemInformasiNav.active { background-color: var(--info-color-hover); }
        #userProfile { display: flex; align-items: center; gap: 15px; color: var(--dark-gray); font-weight: bold; cursor: pointer; padding: 5px 10px; border-radius: 6px; transition: background-color: 0.3s; }
        #userProfile:hover { background-color: var(--light-gray); }
        #userProfileName { max-width: 150px; line-height: 1.2; text-align: left; word-break: break-word; }
        #navProfilePic { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 3px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .auth-button { color: #212529; border-radius: 5px; padding: 10px 20px; font-weight: bold; border: none; cursor: pointer; text-decoration: none; display: inline-block; text-align: center; transition: background-color: 0.3s; }
        #loginButton { background-color: var(--secondary-color); }
        #loginButton:hover { background-color: #e0a800; }
        #marquee-container { background-color: var(--secondary-color); color: var(--dark-gray); padding: 10px 0; overflow: hidden; white-space: nowrap; box-sizing: border-box; position: sticky; top: 56px; /* Adjusted height */  }
        #marquee-text-wrapper { display: inline-block; padding-left: 100%; animation: marquee 200s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        .hero { position: relative; color: #ffffff; text-align: center; overflow: hidden; height: 450px; display: flex; align-items: center; justify-content: center; width: 100%; }
        .slideshow-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 1.5s ease-in-out; transform: scale(1.05); animation: kenburns 30s infinite; }
        .slide.active { opacity: 1; }
        .hero-content { position: relative; z-index: 2; background-color: rgba(0, 0, 0, 0.5); padding: 20px 40px; border-radius: 8px; }
        @keyframes kenburns { 0% { transform: scale(1.05); } 100% { transform: scale(1.2); } }
        .hero h2 { font-size: 2.5em; md:font-size: 3em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.7); }
        .hero p { font-size: 1.1em; md:font-size: 1.2em; max-width: 700px; margin: 0 auto 20px auto; }
        .hero .cta-button { background-color: var(--success-color); color: #ffffff; padding: 15px 30px; text-decoration: none; border-radius: 5px; font-size: 1.1em; font-weight: bold; transition: background-color: 0.3s; cursor: pointer; }
        .hero .cta-button:hover { background-color: #218838; }
        .page-section { scroll-margin-top: 120px; }
        .page-section.hidden { display: none; }
        .section { background-color: #ffffff; padding: 30px; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .section h2 { font-size: 2em; color: var(--primary-color); border-bottom: 3px solid var(--secondary-color); padding-bottom: 10px; margin-bottom: 20px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden; transition: box-shadow 0.3s; display: flex; flex-direction: column; }
        .card:hover { box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        .card img { width: 100%; height: 200px; object-fit: cover; }
        .card-content { padding: 20px; flex-grow: 1; }
        .card-content h3 { margin-top: 0; }
        .card-content .meta { font-size: 0.8em; color: #6c757d; margin-bottom: 10px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; }
        .calendar-month { background-color: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); display: flex; flex-direction: column; }
        .calendar-grid .holiday { color: #dc2626; font-weight: 500; }
		.calendar-grid .awal1 { color: d1fae5; font-weight: 500; }
		.calendar-grid .awal2 { color: #c7d2fe; font-weight: 500; }
        .event-green { background-color: #d1fae5; }
		.event-lightgreen { background-color: #90EE90; }
        .event-lightblue { background-color: #dbeafe; }
        .event-darkblue { background-color: #c7d2fe; }
        .event-yellow { background-color: #fef9c3; }
        .event-orange { background-color: #ffedd5; }
		.event-purple { background-color: #DDA0DD; }
        .today { position: relative; color: #ffffff !important; font-weight: 700; z-index: 1; }
        .today::before { content: ''; position: absolute; top: 50%; left: 50%; width: 2.25rem; height: 2.25rem; background-color: #2563eb; border-radius: 50%; z-index: -1; transform: translate(-50%, -50%); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: translate(-50%, -50%) scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0.7); } 70% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 10px rgba(37, 99, 235, 0); } 100% { transform: translate(-50%, -50%) scale(0.95); box-shadow: 0 0 0 0 rgba(37, 99, 235, 0); } }
        footer { background-color: var(--dark-gray); color: var(--light-gray); padding: 40px 0; text-align: center; }
        footer p { margin: 5px 0; }
        footer a { color: var(--secondary-color); text-decoration: none; }
        .custom-form { max-width: 600px; margin: 40px auto; padding: 30px; background: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 1px solid #ced4da; border-radius: 5px; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 15px; background: var(--primary-color); color: #ffffff; border: none; border-radius: 5px; font-size: 1.1em; cursor: pointer; transition: background-color: 0.3s; }
        .submit-btn:hover { background: #1e4220; }
        .submit-btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        .password-container { position: relative; }
        .toggle-password { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; user-select: none; color: #6c757d; }
        .remember-me { display: flex; align-items: center; justify-content: space-between; font-size: 0.9em; }
        .remember-me label { margin: 0 0 0 8px; font-weight: normal; }
        .forgot-password { color: var(--primary-color); text-decoration: none; }
        .forgot-password:hover { text-decoration: underline; }
        .role-selector { display: flex; gap: 10px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; padding: 5px; }
        .role-selector label { flex: 1; text-align: center; padding: 10px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; }
        .role-selector input[type="radio"] { display: none; }
        .role-selector input[type="radio"]:checked + label { background-color: var(--primary-color); color: white; font-weight: bold; }
        .profile-picture-container { display: flex; flex-direction: column; align-items: center; gap: 15px; margin-bottom: 20px; }
        #profilePicturePreview { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 4px solid #e9ecef; }
        #profilePictureInput { display: none; }
        #uploadPictureLabel { background-color: var(--secondary-color); color: var(--dark-gray); padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); animation: fadeIn 0.3s; }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; animation: slideIn 0.4s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); } to { transform: translateY(0); } }
		#customConfirmModal,
        #alertModal {
            z-index: 9998; 
        }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; }
        .close-button:hover, .close-button:focus { color: black; text-decoration: none; cursor: pointer; }
        .download-btn { display: block; width: fit-content; margin: 10px auto 0 auto; padding: 10px 25px; background-color: var(--primary-color); color: white; text-decoration: none; border-radius: 5px; font-weight: bold; transition: background-color 0.3s; }
        .download-btn:hover { background-color: #1e4220; }
        .message-box { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 15px 25px; border-radius: 8px; color: white; font-weight: bold; z-index: 3000; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: top 0.5s ease-in-out; }
        .message-box.show { top: 20px; }
        .message-box.success { background-color: var(--success-color); }
        .message-box.error { background-color: var(--error-color); }
        .hidden { display: none !important; }
        
        /* GAYA UNTUK SISTEM INFORMASI (DIGABUNG) */
        .schedule-grid { display: grid; grid-template-columns: 90px repeat(6, 1fr); gap: 4px; }
        .time-slot { font-weight: 600; text-align: center; padding: 8px 4px; position: sticky; left: 0; z-index: 15; background-color: #f1f5f9; }
        .day-header { font-weight: 600; text-align: center; padding: 8px 4px; position: sticky; top: 0; /* <-- PERBAIKAN POSISI */ z-index: 10; background-color: #f1f5f9; }
        .schedule-grid > .day-header:first-child { left: 0; z-index: 20; }
        .schedule-cell { border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px; min-height: 120px; transition: all 0.3s ease-in-out; background-color: white; display: flex; flex-direction: column; }
        .subject { flex-grow: 1; }
        .highlight { background-color: #f0fdfa; border-color: #14b8a6; transform: scale(1.03); z-index: 10; position: relative; animation: glow-animation 2s ease-in-out infinite; }
        .dimmed { opacity: 0.3; filter: grayscale(80%); }
        @keyframes glow-animation { 0% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); } 50% { box-shadow: 0 0 20px 5px rgba(20, 184, 166, 0.8); } 100% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); } }
        .room-rbm { background-color: #fff7ed; border-color: #fb923c; border-style: dashed; }
        .room-rbm .subject { font-style: italic; color: #c2410c; }
        .room-madinah { background-color: rgba(59, 130, 246, 0.1); border-color: #60a5fa; }
        .room-mekah { background-color: rgba(132, 204, 22, 0.1); border-color: #a3e635; }
        .arrow-icon { transition: transform 0.3s ease-in-out; }
        .rotate-180 { transform: rotate(180deg); }
        .tab-btn, .semester-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active, .semester-btn.active { background-color: #0d9488; color: white; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .filter-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.75rem center; background-size: 1em; padding-right: 2.5rem; }
        #khs-container { font-family: 'Times New Roman', Times, serif; }
        #khs-display table td, #khs-display table th { padding: 2px 4px; }
        @media print { 
            @page { size: A4 landscape; margin: 1cm; } 
            body { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } 
            #filter-section, #schedule-actions, #teacher-data-container, #module-data-container, #santri-data-container, #krs-container, #khs-container, header, #tabs-container, #semester-tabs-container, #mainNav, #marquee-container, footer, .auth-section, #date-display { display: none !important; } 
            #main-content { padding: 0; margin: 0; } 
            #schedule-container { box-shadow: none; border: none; padding: 0; overflow: visible; max-height: none; } 
            .schedule-grid { font-size: 8pt; gap: 1px; border: 1px solid #ccc; } 
            .schedule-cell { min-height: auto; padding: 4px; border: 1px solid #eee; } 
            .highlight, .dimmed { transform: none; opacity: 1; filter: none; animation: none; box-shadow: none !important; } 
            .schedule-cell.highlight { border: 1px solid #14b8a6; background-color: #f0fdfa !important; } 
            .schedule-cell.dimmed { visibility: hidden !important; }
        }
        /* === PERBAIKAN TAMPILAN HEADER DI SELULER === */
@media (max-width: 768px) {
    header .header-content {
        flex-direction: column; /* Ubah dari baris menjadi kolom */
        justify-content: center; /* Pusatkan item di tengah */
        gap: 15px; /* Kurangi jarak antar elemen */
    }
    header .logo-container {
        flex-direction: column; /* Tumpuk logo dan judul secara vertikal */
        text-align: center; /* Ratakan teks judul ke tengah */
    }
    header img.logo {
        height: 50px; /* Perkecil sedikit logo */
        margin-right: 0; /* Hapus margin kanan */
        margin-bottom: 10px; /* Beri jarak bawah */
    }
    header .title-container h1 {
        font-size: 1.4em; /* Perkecil ukuran judul utama */
        line-height: 1.2;
    }
    header .title-container p {
        font-size: 0.8em; /* Perkecil ukuran sub-judul */
    }
    .header-right-items {
        flex-direction: column; /* Tumpuk tanggal dan profil secara vertikal */
        gap: 15px;
    }
    #date-display {
        text-align: center; /* Ratakan tanggal ke tengah */
    }
    #navProfilePic {
        width: 60px;  /* Perkecil foto profil */
        height: 60px; /* Perkecil foto profil */
    }
    #userProfile {
        justify-content: center; /* Pusatkan foto profil dan nama */
    }
	nav .nav-container {
        overflow-x: auto; /* Memungkinkan scroll horizontal */
		overflow-y: visible;
		flex-wrap: nowrap;
		padding-bottom: 8px;
        -webkit-overflow-scrolling: touch; /* Scroll lebih mulus di iOS */
        scrollbar-width: none; /* Sembunyikan scrollbar untuk Firefox */
        -ms-overflow-style: none;  /* Sembunyikan scrollbar untuk IE/Edge */
    }
    nav .nav-container::-webkit-scrollbar {
        display: none; /* Sembunyikan scrollbar untuk Chrome/Safari */
    }

    #schedule-container {
        font-size: 12px; 
    }
    /* Perkecil kolom waktu dan jarak antar sel */
    .schedule-grid {
        grid-template-columns: 60px repeat(6, 1fr); 
        gap: 2px;
    }
    /* Perkecil header hari dan waktu */
    .time-slot, .day-header {
        padding: 4px 2px;
        font-size: 10px;
    }
    /* Buat sel menjadi lebih ringkas */
    .schedule-cell {
        min-height: auto; /* Biarkan tinggi sel menyesuaikan konten */
        padding: 5px;
        border-radius: 4px;
    }

    .modal-content {
        padding: 20px; /* Kurangi padding pada layar kecil */
        margin: 10% auto; /* Beri sedikit jarak dari atas */
    }
    
    .modal-content h2 {
        font-size: 1.5em; /* Perkecil ukuran judul */
    }

    /* Atur ulang ukuran font di dalam sel agar proporsional */
    .schedule-cell .subject, .schedule-cell .subject a {
        font-size: 1em; /* 1em akan relatif terhadap 12px yang kita atur di atas */
        font-weight: 600; /* Sedikit tebalkan agar mudah dibaca */
    }
    .schedule-cell .group-display,
    .schedule-cell .teacher {
        font-size: 0.85em; /* Perkecil lagi font info grup dan guru */
        margin-top: 3px;
        line-height: 1.3;
    }
    /* Tumpuk info grup & ruang secara vertikal untuk hemat tempat */
    .schedule-cell .group-display span {
        display: block; 
        margin-left: 0 !important;
    }
    .schedule-cell .group-display .room {
        margin-left: 0 !important;
    }
	
	 /* Sembunyikan header tabel di mobile karena layout-nya diubah */
    #soal-preview-container thead,
    #guru-soal-container thead {
        display: none;
    }

    /* Ubah setiap baris menjadi flex container agar item bisa diatur ulang */
    #soal-preview-container tr,
    #guru-soal-container tr {
        display: flex;
        flex-wrap: wrap; /* Izinkan item pindah ke baris baru */
        gap: 0.75rem; /* Beri jarak antar item */
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 0.5rem;
    }

    #soal-preview-container td,
    #guru-soal-container td {
        padding: 0;
        border: none;
    }

    /* Atur agar Nomor dan Isi Soal memakan satu baris penuh */
    #soal-preview-container td:nth-child(1), /* Kolom Nomor */
    #guru-soal-container td:nth-child(1),
    #soal-preview-container td:nth-child(2), /* Kolom Isi Soal */
    #guru-soal-container td:nth-child(2) {
        flex-basis: 100%;
        width: 100%;
    }
    
    /* Buat Nomor Soal menjadi tebal */
    #soal-preview-container td:nth-child(1),
    #guru-soal-container td:nth-child(1) {
        font-weight: 600;
        margin-bottom: -0.5rem; /* Kurangi sedikit jarak ke soal */
    }

    /* Atur agar input Kunci Jawaban dan Poin berbagi tempat di baris kedua */
    #soal-preview-container td:nth-child(3), /* Kolom Kunci Jawaban */
    #guru-soal-container td:nth-child(3) {
        flex: 1 1 60%; /* Biarkan membesar, basis 60% */
    }

    #soal-preview-container td:nth-child(4), /* Kolom Poin */
    #guru-soal-container td:nth-child(4) {
        flex: 1 1 30%; /* Biarkan membesar, basis 30% */
    }
    /* Akhir dari blok CSS perbaikan */
	
}

.dropdown:hover .dropdown-content,
.dropdown:focus-within .dropdown-content {
    display: block;
}

/* === GAYA FORMULIR NEON UNTUK MUSYRIF/AH === */
.form-glow-kegiatan {
    border: 2px solid #2dd4bf; /* Neon Teal */
    box-shadow: 0 0 15px rgba(20, 184, 166, 0.6);
}

.form-glow-tahfidz {
    border: 2px solid #818cf8; /* Neon Indigo */
    box-shadow: 0 0 15px rgba(99, 102, 241, 0.6);
}

.form-glow-pelanggaran {
    border: 2px solid #fb7185; /* Neon Rose */
    box-shadow: 0 0 15px rgba(244, 63, 94, 0.6);
}

/* === TAMBAHKAN SEMUA GAYA DROPDOWN DI BAWAH INI === */
/* === GANTI SEMUA GAYA DROPDOWN SEBELUMNYA DENGAN BLOK INI === */

/* Wadah dropdown di dalam navigasi */
.dropdown {
    position: relative; /* Tetap relative untuk referensi awal */
    display: inline-block;
}

/* Tombol Dropdown */
.dropbtn {
    background-color: var(--info-color);
}

/* GAYA UNTUK TOMBOL YANG AKTIF (saat menu terbuka) */
.dropbtn.active {
    background-color: var(--info-color-hover);
    border-radius: 5px 5px 0 0;
}

/* Konten Dropdown (Submenu) */
.dropdown-content {
    display: none; /* Awalnya tetap disembunyikan */
    position: fixed; /* KUNCI #1: Diubah ke FIXED agar tidak terkurung */
    background-color: #f1f1f1;
    min-width: 200px; /* Atur lebar minimal submenu */
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 9999; /* KUNCI #2: Z-INDEX SUPER TINGGI untuk berada di paling atas */
    border-radius: 0 0 5px 5px;
    overflow: hidden;
}

/* Class untuk menampilkan submenu via JavaScript */
.dropdown-content-show {
    display: block;
}

.dropdown-content a {
    color: black;
    padding: 12px 16px;
    text-decoration: none;
    display: block;
    font-weight: normal;
}

.dropdown-content a:hover {
    background-color: #ddd;
}

/* Pastikan dropdown di dalam nav utama tidak merusak layout */
#mainNav .nav-container > .dropdown {
    display: flex;
    padding: 0;
}

.krs-btn-color {
    background-color: var(--primary-color) !important; /* Warna hijau tua */
}
.krs-btn-color:hover {
    background-color: #1e4220 !important;
}
.khs-btn-color {
    background-color: var(--info-color) !important; /* Warna biru info */
}
.khs-btn-color:hover {
    background-color: var(--info-color-hover) !important;
}

/* --- Tambahkan kode ini ke dalam tag <style> Anda --- */

/* Gaya untuk Kontainer Ujian */
#exam-container {
    font-family: 'Inter', sans-serif;
}

/* Gaya untuk setiap soal */
.question-block {
    margin-bottom: 2rem;
    padding: 1.5rem;
    border: 1px solid #e5e7eb;
    border-left: 5px solid var(--primary-color);
    border-radius: 8px;
}

/* Gaya untuk Pilihan Jawaban */
.answer-option {
    display: block;
    padding: 1rem;
    margin-bottom: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease-in-out;
}
.answer-option:hover {
    background-color: #f9fafb;
    border-color: var(--primary-color);
}
.answer-option input[type="radio"] {
    display: none;
}
.answer-option.selected {
    background-color: #e0f2fe; /* light-blue */
    border-color: #3b82f6; /* blue */
    font-weight: 600;
    color: #1e3a8a; /* dark-blue */
}

/* Gaya untuk hasil ujian */
#result-score.pass {
    color: #16a34a; /* green */
}
#result-score.fail {
    color: #dc2626; /* red */
}

#mainNav .nav-container > .dropdown {
    /* Aturan ini memastikan DIV dropdown tidak merusak alur flex */
    display: flex;
    padding: 0;
}

.materi-item label.recommended {
    font-weight: 600;
    color: #166534; /* Warna hijau tua */
}
.materi-item label.other {
    color: #6b7280; /* Warna abu-abu */
}

#add-materi-modal .modal-content {
    /* DITAMBAHKAN: Menggunakan Flexbox untuk menata elemen di dalamnya secara vertikal */
    display: flex;
    flex-direction: column;
    /* DITAMBAHKAN: Membatasi tinggi pop-up agar tidak keluar dari layar */
    max-height: 90vh; 
}

#add-materi-modal #materi-list-container {
    /* DITAMBAHKAN: Membuat area daftar ini fleksibel, bisa membesar/menyusut */
    /* dan scrollbar akan muncul di dalamnya tanpa menutupi elemen lain. */
    flex: 1;
    min-height: 0; /* Trik agar flexbox berfungsi baik di semua browser */
}

.materi-item label.prerequisite-failed {
    color: #b91c1c; /* Warna merah tua */
    cursor: not-allowed;
}

.materi-item label.prerequisite-failed .font-bold {
    text-decoration: line-through;
}

.nav-link-wrapper {
    position: relative;
    display: inline-block;
    padding-right: 15px; /* Beri sedikit ruang agar notifikasi tidak menempel */
}

.notification-dot {
    position: absolute;
    top: -8px;  /* Sesuaikan posisi vertikal */
    right: -5px; /* Sesuaikan posisi horizontal */
    width: 22px;
    height: 22px;
    background-color: #dc2626; /* Warna merah */
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    border: 2px solid white;
}

/* --- Tambahkan kode ini ke dalam tag <style> Anda --- */

#fullscreenWarningModal {
    /* DITAMBAHKAN: Atur z-index lebih tinggi dari halaman ujian (5000) agar muncul di atas */
    z-index: 9001;
	display: none; /* Ubah dari 'block' saat ditampilkan menjadi 'flex' */
    align-items: center;
    justify-content: center;
}

/* --- Tambahkan kode ini untuk membuat notifikasi meriah --- */

/* --- GANTI SEMUA CSS NOTIFIKASI LAMA DENGAN BLOK BARU INI --- */

/* Atur gaya dasar untuk area notifikasi */
#header-notification-area p {
    font-size: 0.85em;
    font-weight: bold;
    padding: 8px 15px; /* Sedikit diperbesar agar bingkai terlihat bagus */
    border-radius: 15px;
    margin-top: 5px;
    display: inline-block;
    
    /* DITAMBAHKAN: Posisi relatif untuk bingkai animasi */
    position: relative;
    z-index: 1; /* Pastikan teks di atas bingkai */
    
    /* Gradien warna teks (tetap sama) */
    background: linear-gradient(90deg, #ff8a00, #e52e71, #2980b9, #ff8a00);
    background-size: 200% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    
    /* Animasi teks (tetap sama) */
    animation: shimmer-effect 4s linear infinite;
}

/* DITAMBAHKAN: Pseudo-elemen untuk menciptakan bingkai neon turbulen */
#header-notification-area p::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    
    /* Membuat bentuk bingkai dengan padding transparan */
    border: 2px solid transparent;
    border-radius: 15px; /* Samakan dengan border-radius elemen utama */
    
    /* Gradien dua warna (biru dan pink) sebagai sumber garis turbulen */
    background: linear-gradient(45deg, #00c6ff, #f09) border-box;
    
    /* Trik untuk membuat background hanya muncul di area border */
    -webkit-mask: 
        linear-gradient(#fff 0 0) padding-box, 
        linear-gradient(#fff 0 0);
    -webkit-mask-composite: destination-out;
    mask-composite: exclude;
    
    /* Panggil animasi untuk gerakan turbulen */
    animation: turbulent-frame 2s linear infinite;
    
    z-index: -1; /* Letakkan bingkai di belakang teks */
}

/* Animasi 'shimmer-effect' untuk teks (tetap sama) */
@keyframes shimmer-effect {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
}

/* DITAMBAHKAN: Animasi 'turbulent-frame' untuk bingkai neon */
@keyframes turbulent-frame {
    0% { transform: rotate(0deg); }
    25% { transform: rotate(5deg) scale(1.02); }
    50% { transform: rotate(0deg); }
    75% { transform: rotate(-5deg) scale(1.02); }
    100% { transform: rotate(0deg); }
}

/* === GAYA UNTUK ANIMASI LOADING === */
#loading-overlay {
    position: fixed; /* Tetap di layar bahkan saat di-scroll */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(255, 255, 255, 0.7); /* Latar belakang putih semi-transparan */
    z-index: 10000; /* Muncul di atas segalanya */
    display: flex; /* Menggunakan flexbox untuk menengahkan */
    align-items: center;
    justify-content: center;
}

.loader {
    border: 8px solid #f3f3f3; /* Lingkaran abu-abu muda */
    border-top: 8px solid var(--primary-color); /* Warna hijau tema untuk bagian yang berputar */
    border-radius: 50%;
    width: 60px;
    height: 60px;
    animation: spin 1s linear infinite; /* Animasi berputar */
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Menambahkan aturan untuk kelas .hidden yang sudah ada */
#loading-overlay.hidden {
    display: none;
}
/* === GAYA UNTUK PENGGALANGAN DANA === */
.fundraising-wrapper {
    display: flex;
    gap: 20px;
    overflow-x: auto; /* Memungkinkan scroll horizontal */
    padding-bottom: 20px; /* Memberi ruang untuk scrollbar */
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) #e9ecef;
	padding: 10px;
}

.fundraising-wrapper::-webkit-scrollbar {
    height: 8px;
}
.fundraising-wrapper::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 4px;
}
.fundraising-wrapper::-webkit-scrollbar-thumb {
    background-color: var(--primary-color);
    border-radius: 4px;
}

.fundraising-card {
    display: block; /* Memastikan tag <a> berperilaku seperti block */
    background-color: white;
    border: 1px solid #e2e8f0; /* Border abu-abu lembut */
    border-radius: 12px;
    overflow: hidden;
    flex: 0 0 320px;
    transition: box-shadow 0.3s, transform 0.3s;
    cursor: pointer;
    /* Shadow yang lebih terlihat */
    box-shadow: 0 4px 12px rgba(255, 0, 0, 0.15);
}
.fundraising-card:hover {
    /* Shadow yang lebih kuat & efek terangkat saat disentuh */
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.2);
    transform: translateY(-4px);
}

.fundraising-card .image-container {
    position: relative;
    width: 100%;
    height: 180px;
}

.fundraising-card img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.deadline-badge {
    position: absolute;
    top: 10px;
    right: 10px;
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: 500;
}

.fundraising-card .card-body {
    padding: 15px;
}

.organizer-info {
    font-size: 0.9em;
    color: #6c757d;
    margin-bottom: 8px;
}

.fundraising-card h3 {
    font-size: 1.1em;
    font-weight: 700;
    margin: 0 0 15px 0;
    line-height: 1.4;
}

.progress-info {
    font-size: 0.9em;
    font-weight: 500;
    color: var(--dark-gray);
    margin-bottom: 8px;
}

.progress-info .amount {
    color: var(--primary-color);
    font-weight: 700;
}

.progress-bar-bg {
    width: 100%;
    height: 12px; /* Sedikit lebih tebal */
    background-color: #e9ecef;
    border-radius: 6px;
    overflow: hidden;
}

.progress-bar-fill {
	position: relative; 
    height: 100%;
    border-radius: 6px;
    transition: width 0.8s ease-in-out;
    /* Efek gradasi warna bergerak */
    background: linear-gradient(90deg, #2c5e2e, #4caf50, #8bc34a, #ffeb3b, #2c5e2e);
    background-size: 300% 100%;
    animation: color-shift 3s linear infinite;
}

/* Keyframes untuk animasi pergerakan warna */
@keyframes color-shift {
    0% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}

/* Efek percikan api di ujung progress bar */
.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 50%;
    right: -2px;
    width: 8px;
    height: 8px;
    background: green-600;
	border-radius: 50%;
	box-shadow: 0 0 10px 5px rgba(255, 165, 0, 0.7), 
				0 0 20px 10px rgba(255, 165, 0, 0.5);
    opacity: 0;
    animation: sparkle 0.2s ease-out infinite;
}

/* Keyframes untuk animasi percikan api */
@keyframes sparkle {
    0%, 100% {
        transform: translateY(-50%) scale(0.5);
        opacity: 0;
    }
    50% {
        transform: translateY(-50%) scale(1);
        opacity: 1;
    }
	80% {
		opacity: 0;
	}
}

.video-responsive {
    overflow: hidden;
    padding-bottom: 56.25%; /* Aspect Ratio 16:9 */
    position: relative;
    height: 0;
    margin-top: 20px;
    border-radius: 12px; /* Membuat sudutnya tumpul */
}

.video-responsive iframe {
    left: 0;
    top: 0;
    height: 100%;
    width: 100%;
    position: absolute;
}


 .jadwal-sholat-container { color: var(--text-dark, #333); text-align: center; max-width: 450px; margin: 20px auto; padding: 20px; background: var(--card-bg); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        #sky-container { position: relative; width: 100%; max-width: 320px; height: 185px; margin: 10px auto 0; overflow: hidden; background: var(--sky-day); transition: background 1s ease; }
        #sky-container.night { background: var(--sky-night); }
        #sky-path { position: absolute; width: 100%; height: 320px; border-radius: 50%; bottom: -160px; left: 0; border-top: 2px dashed rgba(255, 255, 255, 0.6); box-sizing: border-box; }
        .celestial-object-wrapper { position: absolute; bottom: 0; left: 50%; width: 0; height: 0; transform-origin: 0 0; transition: transform 1s linear; }
        .celestial-body { position: absolute; top: -20px; left: -20px; width: 40px; height: 40px; transform: translateY(-160px); font-size: 36px; line-height: 40px; }
        #timeline-labels { display: flex; justify-content: space-between; max-width: 340px; margin: 10px auto 25px; padding: 0 10px; transition: opacity 0.5s ease; }
        .label-item { display: flex; flex-direction: column; font-size: 11px; font-weight: 600; color: #777; }
        .label-item span:first-child { font-weight: normal; }
        #live-clock { font-size: 1.8em; font-weight: 700; color: var(--text-dark); margin-top: 10px; }
        #next-prayer-countdown { font-size: 1em; font-weight: 600; color: #555; margin-bottom: 10px; height: 1.5em; }
        #countdown-timer { font-size: 1.2em; color: var(--primary-color); }
        #tanggal-container button { background: none; border: 2px solid #ccc; border-radius: 50%; width: 35px; height: 35px; font-size: 1.2em; cursor: pointer; transition: all 0.2s ease; }
        .jadwal-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #eee; border-radius: 8px; transition: all 0.3s ease; border: 1px solid transparent; }
        .jadwal-item:last-child { border-bottom: none; }
        .prayer-details { display: flex; align-items: center; gap: 12px; text-align: left; }
        .notification-btn { background: none; border: none; cursor: pointer; font-size: 1.4em; padding: 0; line-height: 1; }
        .prayer-info .prayer-name { font-size: 1.1em; }
        .prayer-info .prayer-countdown { font-size: 0.8em; font-weight: 600; color: var(--highlight-text); display: none; }
        .jadwal-item .waktu { font-weight: 600; font-size: 1.1em; }
        .jadwal-item.highlight { background-color: var(--highlight-bg); border-color: var(--highlight-border); }
        .jadwal-item.highlight .prayer-countdown { display: block; }
        #test-adhan-btn { background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 8px; padding: 10px; margin-top: 20px; width: 100%; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        #test-adhan-btn:hover { background-color: #e0e0e0; }
        #test-adhan-btn.playing { background-color: var(--danger-color); border-color: var(--danger-color); color: white; }
        #adhan-popup-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        #adhan-popup { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2); max-width: 350px; width: 90%; }
        #adhan-popup h2 { margin-top: 0; font-size: 1.5em; }
        #adhan-popup p { font-size: 1.1em; margin-bottom: 25px; }
        #stop-adhan-btn { background-color: var(--danger-color); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; font-size: 1em; cursor: pointer; width: 100%; }
        #notif-prompt { background-color: #fffbe6; border: 1px solid #ffe58f; border-radius: 8px; padding: 15px; margin-top: 20px; display: none; position: relative; }
        #notif-prompt p { margin: 0 0 10px 0; }
        #notif-prompt button { background-color: var(--primary-color); color: white; border: none; padding: 8px 16px; border-radius: 5px; font-weight: 600; cursor: pointer; }
        #close-notif-prompt { position: absolute; top: 5px; right: 10px; font-size: 1.5em; cursor: pointer; color: #aaa; }
    #js-header-info {
    margin-bottom: 20px; /* Sedikit lebih kecil dari header utama */
}

/* Penyesuaian untuk lokasi dan tombol reset */
#jadwal-sholat #lokasi-container { 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    gap: 8px; /* Jarak antar elemen */
    margin-bottom: 10px; /* Ruang bawah */
}
#jadwal-sholat #lokasi { 
    font-size: 1.2em; 
    font-weight: 600; 
    color: var(--primary-color); 
    line-height: 1.2; /* Mengurangi tinggi baris */
}
#jadwal-sholat #reset-lokasi { 
    background: none; 
    border: none; 
    font-size: 1.2em; 
    cursor: pointer; 
    opacity: 0.6; 
    padding: 0; /* Pastikan tidak ada padding berlebih */
    width: auto; /* Biarkan lebar mengikuti konten */
    height: auto; /* Biarkan tinggi mengikuti konten */
    border-radius: 0; /* Hilangkan border-radius jika tidak diperlukan */
}

/* Penyesuaian untuk jam live */
#jadwal-sholat #live-clock {
    font-size: 1.8em;
    font-weight: 700;
    color: var(--text-dark);
    margin-top: 5px; /* Kurangi margin atas */
    margin-bottom: 5px; /* Kurangi margin bawah */
    line-height: 1.2;
}

/* Penyesuaian untuk countdown */
#jadwal-sholat #next-prayer-countdown {
    font-size: 1em;
    font-weight: 600;
    color: #555;
    margin-bottom: 15px; /* Sedikit ruang di bawah countdown */
    height: auto; /* Biarkan tinggi fleksibel */
    line-height: 1.3;
}
#jadwal-sholat #countdown-timer { 
    font-size: 1.2em; 
    color: var(--primary-color); 
}

/* Penyesuaian untuk kontainer tanggal */
#jadwal-sholat #tanggal-container { 
    display: flex; 
    justify-content: space-between; 
    align-items: center; 
    margin-bottom: 25px; /* Ruang di bawah kontainer tanggal */
}
#jadwal-sholat #tanggal-container button {
    border: 1px solid #ccc; /* Border lebih tipis dari 2px */
    width: 30px; /* Ukuran tombol lebih kecil */
    height: 30px;
    font-size: 1em; /* Ukuran font tombol lebih kecil */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}
#jadwal-sholat #tanggal-display {
    line-height: 1.3; /* Mengurangi jarak antar baris tanggal */
    text-align: center;
    flex-grow: 1; /* Agar tanggal mengambil ruang di tengah */
}
#jadwal-sholat #tanggal-display div {
    margin: 0; /* Hapus margin default antar div tanggal */
}

/* === GAYA UNTUK TOMBOL SHOLAT MENGAMBANG (KODE BARU) === */
#floating-prayer-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background-color: var(--primary-color);
    color: white;
    padding: 10px 15px;
    border-radius: 25px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
    font-size: 0.9em;
    font-weight: 500;
    transition: all 0.3s ease;
    opacity: 0;
    transform: translateY(20px);
    visibility: hidden; /* Mulai dengan tersembunyi */
}

#floating-prayer-btn.visible {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
}

#floating-prayer-btn:hover {
    background-color: #1e4220;
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
}

#floating-prayer-icon::before {
    content: 'ðŸ•Œ'; /* Ikon default */
    font-size: 1.2em;
}

#floating-prayer-btn.highlight #floating-prayer-icon::before {
    content: 'â°'; /* Ikon saat countdown aktif */
    animation: pulse-icon 1.5s infinite;
}

@keyframes pulse-icon {
    0% { transform: scale(1); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}
/* === AKHIR KODE BARU === */

#fullscreenWarningModal .modal-content h2 {
    font-size: 2.25rem; /* Diperbesar */
    line-height: 2.5rem; /* Menyesuaikan tinggi baris */
}
#fullscreenWarningModal .modal-content p {
    font-size: 1.25rem; /* Diperbesar */
    line-height: 1.75rem; /* Menyesuaikan tinggi baris */
}

/* === CSS BARU UNTUK HALAMAN PENGAWAS UJIAN === */
.santri-proctor-card {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid #e2e8f0;
    display: flex;
    flex-direction: column;
    /* Properti 'height' dihapus agar tinggi kartu fleksibel */
}

.santri-proctor-card .log-container {
    flex-grow: 1; 
    overflow-y: auto; 
    padding: 12px;
    font-size: 0.8rem;
    line-height: 1.5;
    max-height: 120px; /* DITAMBAHKAN: Batasi tinggi area log sekitar 5 baris */
}

.santri-proctor-card .header {
    padding: 12px;
    font-weight: bold;
    border-bottom: 1px solid #e2e8f0;
    background-color: #f8fafc;
}

.santri-proctor-card .log-container {
    flex-grow: 1; /* Membuat area log mengisi sisa ruang */
    overflow-y: auto; /* Membuat area ini bisa di-scroll */
    padding: 12px;
    font-size: 0.8rem; /* Ukuran font lebih kecil untuk log */
    line-height: 1.5;
}

/* === CSS BARU UNTUK EFEK GELOMBANG TEKS === */
.wave-char {
    display: inline-block; /* Memungkinkan transformasi pada setiap huruf */
    animation: wave-animation 1.6s ease-in-out infinite;
}

@keyframes wave-animation {
    0%, 100% {
        transform: translateY(0);
    }
    50% {
        transform: translateY(-15px); /* Seberapa tinggi huruf akan melompat */
    }
}

/* === CSS BARU UNTUK EFEK TITIK BERDENYUT === */
.pulsing-dot {
    display: inline-block;
    width: 8px; /* Ukuran titik */
    height: 8px;
    background-color: currentColor; /* Mengambil warna dari teks induk (text-gray-500) */
    border-radius: 50%;
    margin: 0 2px;
    animation: pulse-dot-animation 1.4s infinite ease-in-out both;
}

@keyframes pulse-dot-animation {
    0%, 80%, 100% {
        transform: scale(0);
    } 40% {
        transform: scale(1.0);
    }
}

.legend-grid {
    display: flex;
    flex-wrap: wrap;
    gap-x-16px; /* Jarak horizontal */
    gap-y-8px;  /* Jarak vertikal */
}
.legend-item {
    display: flex;
    align-items: center;
    gap: 8px; /* Jarak antara kotak dan teks */
}
.legend-color-box {
    width: 18px;
    height: 18px;
    border-radius: 4px;
    border: 1px solid rgba(0,0,0,0.1); /* Garis tipis */
    flex-shrink: 0; /* Mencegah kotak mengecil */
}
.legend-text {
    font-size: 13px;
    color: #374151; /* text-gray-700 */
}

@keyframes flash-red-glow {
    0%   { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
    70%  { box-shadow: 0 0 10px 15px rgba(220, 38, 38, 0); }
    100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
}
.flash-red-alert {
    /* Memberi border merah tebal DAN animasi kedip (glow) */
    border: 3px solid #dc2626 !important; 
    animation: flash-red-glow 1.5s 2; /* Mainkan animasi 2 kali (total 3 detik) */
}

/* === (BARU) CSS UNTUK PANDUAN RUBRIK === */
.rubrik-card {
    background-color: #fafdff; /* Sedikit kebiruan, lebih lembut dari putih bersih */
    border: 1px solid #cce5ff; /* Border biru muda */
}
.rubrik-card h4 {
    color: #004085; /* Biru tua */
}
.rubrik-list {
    list-style-type: none; /* Hilangkan bulat standar */
    padding-left: 0;
    space-y: 8px; /* Tailwind class, tapi ini untuk CSS */
}
.rubrik-list > li {
    margin-bottom: 12px;
}
.rubrik-list .sub-list {
    list-style-type: disc;
    padding-left: 20px;
    margin-top: 4px;
    color: #4a5568; /* text-gray-700 */
}
.rubrik-list .sub-list li {
    margin-bottom: 4px;
}
.rubrik-list .poin-badge {
    display: inline-block;
    background-color: #e2e8f0; /* bg-gray-200 */
    color: #2d3748; /* text-gray-800 */
    font-weight: 600;
    padding: 0px 6px;
    border-radius: 4px;
    font-size: 0.9em;
    min-width: 50px; /* Agar 'Poin' sejajar */
    text-align: right;
    margin-right: 8px;
}
.rubrik-example {
    font-size: 0.85rem;
    color: #1a202c; /* text-gray-900 */
    font-weight: 600;
    border-top: 1px dashed #b2cce6;
    padding-top: 10px;
    margin-top: 10px;
}

/* === (BARU) CSS UNTUK ANIMASI TIPS === */
@keyframes bobbing {
  0% { transform: translateY(0); }
  50% { transform: translateY(-10px); }
  100% { transform: translateY(0); }
}

#tips-container {
    position: fixed;
    bottom: 70px;
    left: 50px; /* Pindah ke kiri agar tidak tabrakan dengan tombol sholat */
    z-index: 40; /* Di bawah modal, tapi di atas konten */
    width: 280px;
    display: flex;
    align-items: flex-end;
}

#tips-santri {
    width: 80px;
    height: auto;
    animation: bobbing 3s ease-in-out infinite;
    z-index: 42;
}

#tips-bubble {
    position: relative;
    background: #f1f5f9; /* bg-slate-100 */
    border-radius: 10px;
    padding: 12px;
    margin-left: -15px;
    margin-bottom: 20px;
    width: 215px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    border: 1px solid #cbd5e1; /* border-slate-300 */
    z-index: 41;
    
    /* Logika Tampil/Sembunyi */
    opacity: 0;
    transform: translateY(20px);
    visibility: hidden;
    transition: all 0.4s ease-out;
}

#tips-bubble.visible {
    opacity: 1;
    transform: translateY(0);
    visibility: visible;
}

/* Ekor gelembung */
#tips-bubble::after {
    content: '';
    position: absolute;
    bottom: 15px;
    left: -10px;
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 10px solid #cbd5e1; /* Warna border */
}
#tips-bubble::before {
    content: '';
    position: absolute;
    bottom: 15px;
    left: -9px;
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 10px solid #f1f5f9; /* Warna background */
    z-index: 1;
}

#tips-content {
    font-size: 0.9rem;
    color: #334155; /* text-slate-700 */
    max-height: 100px; /* Batasi tinggi tip */
    overflow-y: auto;
}

/* Style untuk link di dalam bubble */
#tips-content a {
    color: #0d6efd; /* var(--info-color) */
    font-weight: 600;
    text-decoration: underline;
}

/* Interaktivitas: Transparan saat hover */
#tips-container:hover #tips-bubble {
    opacity: 0.2;
    transition: opacity 0.2s;
}

/* Interaktivitas: Pengecualian jika ada link */
#tips-container:hover #tips-bubble.has-link {
    opacity: 1.0;
    cursor: pointer;
}
.ql-editor.ql-blank::before {
    white-space: pre-wrap; /* Ini akan memaksa placeholder untuk ganti baris */
}

#exam-nav-grid-container {
    position: fixed; /* Mengambang di layar */
    top: 20%;
    right: 20px;
    width: 220px;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 5001; /* Di atas konten ujian, tapi di bawah modal */
    
    display: grid;
    /* (5 kolom, otomatis menyesuaikan) */
    grid-template-columns: repeat(auto-fill, minmax(35px, 1fr)); 
    gap: 6px;
    max-height: 60vh; /* Batasi tinggi agar bisa di-scroll jika soal banyak */
    overflow-y: auto;
}

.nav-box {
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid transparent;
}

.nav-box.unanswered {
    background-color: #e5e7eb; /* bg-gray-200 */
    color: #374151; /* text-gray-700 */
    border-color: #d1d5db; /* border-gray-300 */
}
.nav-box.unanswered:hover {
    background-color: #f3f4f6; /* bg-gray-100 */
}

.nav-box.answered {
    background-color: #10b981; /* bg-emerald-500 */
    color: white;
}
.nav-box.answered:hover {
    background-color: #059669; /* bg-emerald-600 */
}

/* === (BARU) CSS UNTUK TOMBOL BANTUAN UJIAN === */
.help-button-container {
    position: absolute;
    left: -60px; /* Posisikan di sebelah kiri luar kotak soal */
    top: 1.5rem;
    width: 40px;
    text-align: center;
}

.help-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.2s;
    position: relative; /* Untuk tooltip */
}
.help-btn:hover .help-tooltip {
    opacity: 1;
    visibility: visible;
}

.help-tooltip {
    position: absolute;
    bottom: 105%;
    left: 50%;
    transform: translateX(-50%);
    background-color: #333;
    color: white;
    padding: 5px 10px;
    border-radius: 4px;
    font-size: 0.8rem;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s;
}

.help-btn-available {
    background-color: #f59e0b; /* bg-amber-500 */
    color: white;
}
.help-btn-available:hover {
    background-color: #d97706; /* bg-amber-600 */
}

.help-btn-disabled {
    background-color: #d1d5db; /* bg-gray-300 */
    color: #6b7280; /* text-gray-500 */
    cursor: not-allowed;
}

/* (PENTING) Buat .question-block menjadi 'relative' */
.question-block {
    position: relative; /* Diperlukan agar tombol bantuan bisa diposisikan */
    margin-bottom: 2rem;
    padding: 1.5rem;
    padding-left: 2.5rem; /* Beri ruang di kiri untuk tombol bantuan */
    border: 1px solid #e5e7eb;
    border-left: 5px solid var(--primary-color);
    border-radius: 8px;
}

    </style>
</head>
<body>
<div id="fundraising-modal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-button">&times;</span>
        <h2 id="form-title" class="text-2xl font-bold mb-6">Buat Penggalangan Dana Baru</h2>
        <form id="form-fundraising">
			<input type="hidden" id="input-fund-id">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="form-group">
                    <label for="input-fund-title">Judul Penggalangan Dana</label>
                    <input type="text" id="input-fund-title" required>
                </div>
            </div>
            <div class="form-group">
                <label for="input-fund-goal">Total Dana Dibutuhkan (hanya angka)</label>
                <input type="number" id="input-fund-goal" required>
            </div>
            <div class="form-group">
                <label for="input-fund-deadline">Batas Waktu</label>
                <input type="date" id="input-fund-deadline" required>
            </div>
            <div class="form-group">
    <label>Gambar Utama</label>
    <div class="mt-2 p-4 border-2 border-dashed rounded-md text-center">
        <img id="fundraising-image-preview" src="https://placehold.co/400x200/e9ecef/6c757d?text=Pilih+Gambar" class="mx-auto mb-4 max-h-48 rounded cursor-pointer" title="Klik untuk pilih gambar">
        <input type="file" id="input-fund-image-file" class="hidden" accept="image/*">
        <label for="input-fund-image-file" class="cursor-pointer bg-gray-200 hover:bg-gray-300 font-bold py-2 px-4 rounded">
            Pilih File Gambar
        </label>
    </div>
</div>
            <div class="form-group">
                <label for="input-fund-desc">Deskripsi Lengkap (HTML didukung)</label>
                <textarea id="input-fund-desc" rows="8" class="w-full p-3 border rounded-md"></textarea>
            </div>
            <div class="flex gap-4 mt-8">
                <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg">Simpan & Publikasikan</button>
            </div>
        </form>
    </div>
</div>


    <div id="messageBox" class="message-box"></div>

    <header>
        <div class="container header-content">
            <div class="logo-container">
                <img src="Logo_yayasan.png" alt="Logo Yayasan" class="logo" onerror="this.onerror=null;this.src='https://placehold.co/60x60/2c5e2e/ffffff?text=Y';">
                <div class="title-container">
                    <h1>Yayasan Markaz Yatim Duafa Qurani</h1>
                    <p>Berdasarkan Al-Qur'an dan Sunnah Sesuai Pemahaman Salafush Shalih</p>
                </div>
            </div>
            <div class="header-right-items">
                <div class="text-right"> <div id="date-display"></div>
                    <div id="header-notification-area"></div>
                </div>
                <div class="auth-section">
                    <div id="userProfile" class="hidden">
                        <img id="navProfilePic" src="https://placehold.co/80x80/e9ecef/343a40?text=F" alt="Foto Profil">
                        <span id="userProfileName"></span>
                    </div>
                    <a href="#login" id="loginButton" class="auth-button">Login</a>
                </div>
            </div>
        </div>
    </header>

    <div class="nav-wrapper">
        <div class="nav-container-wrapper">
            <nav id="mainNav">
                <div class="nav-container">
                    <a href="#beranda" class="active">Beranda</a>
					<a href="#jadwal-sholat">Jadwal Sholat</a>
                    <a href="#lembaga">Lembaga</a>
                    <a href="#tentang">Tentang</a>
					<a href="digilib.html" style="background-color: #8B5CF6;">Digilib</a>
					<div id="sistemInformasiDropdown" class="dropdown hidden">
					<a href="#" id="sistemInformasiNav" class="dropbtn"><span class="nav-link-wrapper">Sistem Informasi &#9662;</span></a>
						<div class="dropdown-content">
						<a href="#roster-kbm" id="rosterKbmNav">Roster KBM</a>
						<a href="#krs" id="krsNav">KRS (Kartu Rencana Studi)</a>
						<a href="#khs" id="khsNav">KHS (Kartu Hasil Studi)</a>
						<a href="#hafalan" id="hafalanNav" class="hidden">Progres Hafalan</a>
						<a href="#slip-gaji" id="slipGajiNav">Slip Gaji</a>
						<a href="#laporan-keuangan" id="laporanKeuanganNav">Laporan Keuangan</a>
						<a href="#laporan" id="laporanNav">Laporan Tahfidz</a>
						<a href="#musyrif" id="musyrifNav">Halaman Musyrif</a>
						<a href="#musyrifah" id="musyrifahNav">Halaman Musyrifah</a>
						<a href="#input-soal" id="inputSoalNav">Input Soal Ujian</a>
						<a href="#halaman-guru" id="halamanGuruNav"><span class="nav-link-wrapper">Bank Soal Guru</span></a>
						<a href="#lihat-nilai" id="lihatNilaiNav">Lihat Nilai Santri</a>
						<a href="#halaman-ujian-admin" id="halamanUjianAdminNav" class="hidden" style="background-color: #F59E0B;">Buka Ujian Manual</a>
						<a href="#pengawas-ujian" id="pengawasUjianNav" class="hidden" style="background-color: #ef4444; color: white;">Pengawas Ujian</a>
						<a href="tabungan.html" id="tabunganNav" class="hidden" style="background-color: #0d6efd;">Tabungan</a>
						<a href="kasir.html" id="kasirNav" class="hidden" style="background-color: #0d6efd;">App Kasir</a>
						</div>
					</div>
					<a href="#absensi" id="attendanceNav" class="hidden">Absensi</a>
					<a href="tugas.html" id="tugasNav" class="hidden" style="background-color: #F59E0B;"><span class="nav-link-wrapper">Tugas</span></a>
					<a href="#ujian-online" id="ujianOnlineNav" class="hidden" style="background-color: #ff69b4;">Ujian Online</a>
					<a href="#penerimaan">Penerimaan</a>
                    <a href="#kegiatan">Kegiatan</a>
                    <a href="#legalitas">Legalitas</a>
                    <a href="#mitra">Mitra</a>
                </div>
            </nav>
            <div id="nav-arrow-left" class="nav-arrow"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></div>
            <div id="nav-arrow-right" class="nav-arrow"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></div>
        </div>
    </div>
    
	<!-- ======================================================= -->
<!-- === AWAL HALAMAN LAPORAN TAHFIDZ === -->
<!-- ======================================================= -->
<div id="laporan" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Laporan Harian Santri</h2>
    <p class="mb-6 text-gray-600">Pilih tanggal untuk melihat semua laporan yang masuk.</p>
    
    <div class="form-group bg-white p-4 rounded-lg shadow-sm" style="max-width: 350px;">
        <label for="laporanTanggal" class="text-base font-semibold">Pilih Tanggal Laporan</label>
        <input type="date" id="laporanTanggal" class="mt-2">
    </div>

    <div id="pelanggaranReportContainer" class="mt-8">
        </div>
    
    <div id="tahfidzReportContainer" class="mt-8">
        </div>
    
    <div id="kegiatanReportContainer" class="mt-8">
        </div>
	</div>
	<div id="hafalan" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Progres Hafalan Saya</h2>
    <p class="mb-6 text-gray-600">Grafik ini menampilkan progres muraja'ah Anda per juz. Warna batang menunjukkan kualitas (poin) dan tingkat pudar menunjukkan kapan terakhir kali Anda mengulang hafalan tersebut.</p>

    <div id="hafalan-chart-content" class="bg-white p-4 rounded-lg shadow" style="height: 400px;">
        <canvas id="hafalanChart" style="height: 400px;"></canvas>
    </div>

    <div id="hafalan-legend-container" class="mt-6 p-4 bg-gray-50 rounded-lg border">
        <h4 class="text-base font-bold mb-3 text-gray-800">Keterangan Grafik:</h4>
        
        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">Warna Batang (berdasarkan Poin Rata-rata):</p>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(59, 130, 246);"></span>
                    <span class="legend-text">Sangat Baik (9.0+)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74);"></span>
                    <span class="legend-text">Baik (7.1 - 8.9)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(234, 179, 8);"></span>
                    <span class="legend-text">Cukup (5.1 - 7.0)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(220, 38, 38);"></span>
                    <span class="legend-text">Kurang (&lt; 5.1)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(156, 163, 175);"></span>
                    <span class="legend-text">Poin 0</span>
                </div>
            </div>
        </div>

        <div>
            <p class="text-sm font-semibold mb-2">Tingkat Pudar (berdasarkan Waktu Muraja'ah Terakhir):</p>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 1.0;"></span>
                    <span class="legend-text">Baru Saja</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 0.6;"></span>
                    <span class="legend-text">Beberapa Bulan Lalu</span>
                </div>
                <div class="legend-item">
                <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 0.1; border: 1px solid #ddd;"></span>
                    <span class="legend-text">> 1 Tahun (Hilang)</span>
                </div>
            </div>
        </div>
    </div>

	
</div>
	
	<div id="tahfidz-chart-container" class="mt-12 pt-8 border-t hidden px-4">
    <h3 class="text-2xl font-bold text-gray-800 mb-4">Grafik Progres Tahfidz per Santri</h3>

    <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4 mb-4">
        <div class="flex-grow">
            <label for="chart-santri-select" class="block text-sm font-semibold">Pilih Santri</label>
            <select id="chart-santri-select" class="w-full p-2 mt-1 border rounded"></select>
        </div>
        <div>
            <label for="chart-start-date" class="block text-sm font-semibold">Tanggal Awal</label>
            <input type="date" id="chart-start-date" class="w-full p-2 mt-1 border rounded">
        </div>
        <div>
            <label for="chart-end-date" class="block text-sm font-semibold">Tanggal Akhir</label>
            <input type="date" id="chart-end-date" class="w-full p-2 mt-1 border rounded">
        </div>
        <button id="show-chart-btn" class="bg-blue-600 text-white py-2 px-4 rounded-md">Tampilkan Grafik</button>
    </div>

    <div class="mb-4 border-b border-gray-200">
        <nav class="flex space-x-4" aria-label="Tabs">
            <a href="#" id="tab-ziyadah" class="tab-grafik-tahfidz bg-gray-100 text-gray-700 px-3 py-2 font-medium text-sm rounded-t-lg">
                Grafik Setoran (Ziyadah)
            </a>
            <a href="#" id="tab-murajaah" class="tab-grafik-tahfidz bg-gray-100 text-gray-700 px-3 py-2 font-medium text-sm rounded-t-lg">
                Grafik Hafalan (Muraja'ah per Juz)
            </a>
        </nav>
    </div>
    <div id="ziyadah-chart-content" class="chart-content bg-white p-4 rounded-lg shadow">
        <canvas id="tahfidzChart" style="height: 400px;"></canvas>
    </div>
    <div id="murajaah-chart-content" class="chart-content bg-white p-4 rounded-lg shadow hidden" style="height: 400px;">
        <canvas id="murajaahChart" style="height: 400px;"></canvas>
    
    </div> <div id="murajaah-legend-container" class="mt-6 p-4 bg-gray-50 rounded-lg border">
        <h4 class="text-base font-bold mb-3 text-gray-800">Keterangan Grafik:</h4>
        
        <div class="mb-4">
            <p class="text-sm font-semibold mb-2">Warna Batang (berdasarkan Poin Rata-rata):</p>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(59, 130, 246);"></span>
                    <span class="legend-text">Sangat Baik (9.0+)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74);"></span>
                    <span class="legend-text">Baik (7.1 - 8.9)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(234, 179, 8);"></span>
                    <span class="legend-text">Cukup (5.1 - 7.0)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(220, 38, 38);"></span>
                    <span class="legend-text">Kurang (&lt; 5.1)</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(156, 163, 175);"></span>
                    <span class="legend-text">Poin 0</span>
                </div>
            </div>
        </div>

        <div>
            <p class="text-sm font-semibold mb-2">Tingkat Pudar (berdasarkan Waktu Muraja'ah Terakhir):</p>
            <div class="legend-grid">
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 1.0;"></span>
                    <span class="legend-text">Baru Saja</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 0.6;"></span>
                    <span class="legend-text">Beberapa Bulan Lalu</span>
                </div>
                <div class="legend-item">
                <span class="legend-color-box" style="background-color: rgb(22, 163, 74); opacity: 0.1; border: 1px solid #ddd;"></span>
                    <span class="legend-text">> 1 Tahun (Hilang)</span>
                </div>
            </div>
        </div>
    </div>
    </div>
	</div>


<!-- === AKHIR HALAMAN LAPORAN TAHFIDZ === -->

<div id="slip-gaji" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Slip Gaji Karyawan</h2>
    <p class="mb-8 text-gray-600">Silakan pilih periode bulan untuk melihat rincian gaji Anda.</p>

    <div id="slipGajiFilters" class="bg-gray-100 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4 mb-8">
        <div id="employeeSelectorContainer" class="form-group hidden flex-grow">
            <label for="employeeSelect" class="font-semibold">Pilih Karyawan</label>
            <select id="employeeSelect" class="filter-select w-full mt-1"></select>
        </div>
        
        <div class="form-group flex-grow" style="min-width: 150px;">
			<label for="monthSelectNew" class="font-semibold">Pilih Bulan</label>
			<select id="monthSelectNew" class="filter-select w-full mt-1"></select>
		</div>
		<div class="form-group" style="width: 120px;">
			<label for="yearSelect" class="font-semibold">Tahun</label>
			<select id="yearSelect" class="filter-select w-full mt-1"></select>
		</div>
        
        <div class="form-group">
            <button id="showSlipGajiBtn" class="bg-teal-600 text-white py-3 px-6 rounded-md hover:bg-teal-700 w-full md:w-auto">Tampilkan</button>
        </div>
    </div>

    <div id="slipGajiContainer" class="mt-8">
        <p class="p-8 text-center text-gray-500">Silakan pilih nama (jika tersedia) dan bulan, lalu klik "Tampilkan".</p>
    </div>
	<div id="downloadSlipContainer" class="mt-6 text-center hidden">
    <button id="downloadSlipBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg">
        Unduh Slip Gaji (PDF)
    </button>
	</div>
	
	<div id="total-gaji-karyawan-container" class="mt-8 mb-12 p-6 bg-blue-50 border-l-4 border-blue-400 rounded-lg shadow-md">
    <h3 class="text-xl font-semibold text-blue-800 mb-4">Laporan Total Gaji Karyawan</h3>
    <p class="text-blue-700 mb-6 text-sm">
        Pilih bulan untuk melihat rekapitulasi total gaji bersih (dari HistoryGaji) untuk semua karyawan.
    </p>
    <div class="flex flex-wrap items-end gap-4">
        <div class="form-group flex-grow" style="min-width: 150px;">
            <label for="totalGajiBulan" class="font-semibold">Bulan</label>
            <select id="totalGajiBulan" class="filter-select w-full mt-1"></select>
        </div>
        <div class="form-group" style="width: 120px;">
            <label for="totalGajiTahun" class="font-semibold">Tahun</label>
            <select id="totalGajiTahun" class="filter-select w-full mt-1"></select>
        </div>
        <div class="form-group">
            <button id="tampilkanTotalGajiBtn" class="bg-blue-600 text-white py-3 px-6 rounded-md hover:bg-blue-700 w-full md:w-auto font-bold">
                Tampilkan Laporan
            </button>
        </div>
    </div>

    <div id="total-gaji-report-container" class="mt-6">
        </div>
</div>
	
</div>
	
    <div id="marquee-container" class="hidden">
        <div id="marquee-text-wrapper">
            <span id="marquee-text"></span>
        </div>
    </div>

    <div id="beranda" class="page-section">
        <section class="hero">
            <div id="slideshow" class="slideshow-container"></div>
            <div class="hero-content">
                <h2>Membina Generasi Qur'ani, Memuliakan Yatim & Dhuafa</h2>
                <p>Menjadi bagian dari kebaikan dengan mendukung program pendidikan penghafal Al-Qur'an dan menyantuni mereka yang membutuhkan.</p>
                <a id="donasiBtn" class="cta-button">Donasi Sekarang</a>
            </div>
        </section>
        <main class="container">
            <section id="berita" class="section">
                <h2>Berita & Pengumuman Terbaru</h2>
                <div id="news-container" class="grid-container"></div>
				
            </section>
			
			<div id="create-fundraising-btn-container" class="hidden text-right mb-4">
    <button id="btn-create-fundraising" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md">
        Buat Penggalangan Dana
    </button>
</div>
			<section id="fundraising" class="section">
    <h2>Penggalangan Dana Mendesak</h2>
    <div id="fundraising-container" class="fundraising-wrapper">
        </div>
</section>
            <section id="kalenderPendidikanSection" class="section hidden">
                <h2>Kalender Pendidikan Madrasah 2025/2026</h2>
                <div id="dynamic-calendar-grid" class="calendar-grid"></div>
                <footer class="text-center mt-12 text-white-500 text-sm">
                    <p>Update terakhir kalender 22 Agustus 2025</p>
                </footer>
            </section>
<section id="pengunjung-hari-ini" class="section hidden">
    <h2>Pengguna Aktif Hari Ini</h2>
    <div id="visitor-list-container">
        <p>Memuat data...</p>
    </div>
</section>

        </main>
    </div>
	<div id="jadwal-sholat" class="page-section hidden">
        <div class="jadwal-sholat-container">
            <div id="js-header-info">
                <div id="lokasi-container">
                    <div id="lokasi">Mencari lokasi Anda...</div>
                    <button id="reset-lokasi" title="Reset Lokasi">ðŸ”„</button>
                </div>
                <div id="live-clock"></div>
                <div id="next-prayer-countdown"></div>
                <div id="tanggal-container">
                    <button id="prev-day">&lt;</button>
                    <div id="tanggal-display">
                        <div id="tanggal-masehi"></div>
                        <div id="tanggal-hijriah"></div>
                    </div>
                    <button id="next-day">&gt;</button>
                </div>
            </div>

            <div id="notif-prompt">
                <span id="close-notif-prompt">&times;</span>
                <p>Aktifkan notifikasi pengingat sholat?</p>
                <button id="enable-notif-btn">Aktifkan Notifikasi</button>
            </div>

            <div id="sky-container">
                <div id="sky-path"></div>
                <div id="celestial-object-wrapper" class="celestial-object-wrapper">
                    <div id="celestial-body" class="celestial-body"></div>
                </div>
            </div>
            <div id="timeline-labels"></div>
            <div id="jadwal-container"></div>
            <button id="test-adhan-btn">ðŸ”Š Tes Suara Adzan</button>
        </div>
    </div>
    
    <footer>
        </footer>

    <div id="adhan-popup-overlay">
        <div id="adhan-popup">
            <h2>Telah Masuk Waktu Sholat</h2>
            <p id="popup-prayer-name"></p>
            <button id="stop-adhan-btn">ðŸ”‡ Matikan Suara Adzan</button>
        </div>
    </div>
    <audio id="adhan-audio" preload="auto" src="azan.mp3"></audio>
    <div id="lembaga" class="page-section hidden container section"><h2>Lembaga di Bawah Naungan Kami</h2><div class="grid-container"><div class="card"><div class="card-content"><h3>Lembaga Pendidikan: Rumah Tahfidz Qur'an Markaz Qur'an Al-Maa'un</h3><p>Fokus pada pendidikan dan pembinaan generasi muda untuk menjadi penghafal Al-Qur'an yang berakhlak mulia.</p></div></div><div class="card"><div class="card-content"><h3>Lembaga Sosial: Rumah Anak Yatim Abu Darda</h3><p>Memberikan perlindungan, kasih sayang, dan pemenuhan kebutuhan hidup bagi anak-anak yatim dan dhuafa.</p></div></div></div></div>
    <div id="tentang" class="page-section hidden container section"><h2>Tentang Yayasan</h2><p><strong>Yayasan Markaz Yatim Duafa Qurani</strong> adalah organisasi nirlaba berlandaskan Al-Qur'an dan Sunnah dengan pemahaman Salafus Shalih.</p><h3>Visi & Misi</h3><p>Menjadi yayasan Islam yang unggul dan amanah dalam mencetak generasi Qur'ani serta menjadi pelopor dalam kesejahteraan sosial umat.</p></div>
    <div id="absensi" class="page-section hidden container section">
        <h2>Formulir Absensi</h2>
        <p>Silakan pilih peran Anda dan isi formulir di bawah ini.</p>
        <div class="role-selector">
            <input type="radio" id="roleGuru" name="role" value="guru" checked><label for="roleGuru">Guru</label>
            <input type="radio" id="roleStaf" name="role" value="staf"><label for="roleStaf">Staf</label>
            <input type="radio" id="roleRapat" name="role" value="rapat"><label for="roleRapat">Rapat</label>
        </div>
        <form id="attendanceFormGuru" class="custom-form">
            <div class="form-group"><label for="teacherNameDisplay">Nama Guru</label><input type="text" id="teacherNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="attendanceDateGuru">Tanggal</label><input type="date" id="attendanceDateGuru" required readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="className">Kelas</label><select id="className" class="w-full p-3 border border-gray-300 rounded-md" required><option value="">Pilih Kelas...</option></select></div>
            <div class="form-group"><label for="lateMinutesGuru">Menit Terlambat</label><input type="number" id="lateMinutesGuru" min="0" placeholder="Isi 0 jika tidak terlambat"></div>
            
            <!-- FITUR GURU PENGGANTI -->
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="isSubstituteTeacher" name="isSubstitute" style="width: auto; height: 1.2em;">
                    <label for="isSubstituteTeacher" style="margin: 0; font-weight: normal;">Saya Menggantikan Guru Lain</label>
                </div>
            </div>
            <!-- PERUBAHAN: Hanya ada satu dropdown untuk nama guru -->
            <div id="substituteTeacherSection" class="form-group hidden">
                <label for="substituteTeacherName">Guru yang Digantikan</label>
                <select id="substituteTeacherName" name="substituteFor">
                    <option value="">Pilih Guru...</option>
                </select>
            </div>
            <!-- AKHIR PERUBAHAN -->

            <div class="form-group"><label for="remarksGuru">Keterangan</label><textarea id="remarksGuru" rows="3"></textarea></div>
            <div id="student-attendance-container" class="form-group hidden mt-6 pt-6 border-t">
    <label class="font-bold mb-2">Absensi Santri</label>
    <div id="student-list-placeholder">
        <p class="text-gray-500">Pilih kelas untuk menampilkan daftar santri.</p>
    </div>
</div>
			<button type="submit" class="submit-btn">Kirim Absensi Guru</button>
        </form>
        <form id="attendanceFormStaf" class="custom-form hidden">
            <div class="form-group"><label for="stafNameDisplay">Nama Staf</label><input type="text" id="stafNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="attendanceDateStaf">Tanggal</label><input type="date" id="attendanceDateStaf" required readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="jabatanStaf">Jabatan</label><input type="text" id="jabatanStaf" readonly required style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="lateMinutesStaf">Menit Izin</label><input type="number" id="lateMinutesStaf" min="0" placeholder="Isi hanya jika Izin"></div>
            <div class="form-group"><label for="remarksStaf">Keterangan</label><textarea id="remarksStaf" rows="3"></textarea></div>
            <button type="submit" class="submit-btn">Kirim Absensi Staf</button>
        </form>
        <form id="attendanceFormRapat" class="custom-form hidden">
            <div class="form-group"><label for="rapatNameDisplay">Nama</label><input type="text" id="rapatNameDisplay" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="rapatDate">Tanggal</label><input type="date" id="rapatDate" readonly style="background-color: #e9ecef;"></div>
            <div class="form-group"><label for="rapatStartTime">Jam Mulai</label><input type="time" id="rapatStartTime" required></div>
            <div class="form-group"><label for="rapatEndTime">Jam Selesai</label><input type="time" id="rapatEndTime" required></div>
            <div class="form-group"><label for="rapatRemarks">Keterangan Rapat</label><textarea id="rapatRemarks" rows="3" required></textarea></div>
            <button type="submit" class="submit-btn">Kirim Absensi Rapat</button>
        </form>
		
			<div id="attendanceHistorySection" class="mt-12 pt-8 border-t-2 border-gray-200">
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Riwayat Absensi Anda (30 Hari Terakhir)</h2>
		<div id="historyContainer" class="overflow-x-auto bg-white rounded-lg shadow">
			<p class="p-6 text-center text-gray-500">Memuat riwayat absensi...</p>
		</div>
	</div>
		
    </div>
    

	
    <!-- KONTEN UNTUK SISTEM INFORMASI -->
    <div id="roster-kbm" class="page-section hidden">
        <div id="page-wrapper" class="relative min-h-screen">
            <main id="main-content" class="flex-1 p-4 md:p-6 lg:p-8">
                <header class="text-center mb-6">
                    <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Roster KBM Dinamis</h1>
                    <h2 class="text-xl md:text-2xl font-semibold text-teal-700">Markaz Qur'an Al-Maa'un</h2>
                </header>

                <div id="filter-section" class="bg-white p-3 rounded-xl shadow-md mb-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 items-center">
                        <select id="filter-group" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Kelompok</option>
                            <option value="KF">Kelas Fondasi</option>
                            <option value="KG">Kelas Gabungan</option>
                        </select>
                        <select id="filter-cluster" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md" disabled>
                            <option value="all">Semua Klaster</option>
                            <option value="LKS">Literasi & Kreatif Syariah</option>
                            <option value="STT">Sains & Teknologi Terapan</option>
                        </select>
                        <select id="filter-teacher" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Guru</option>
                        </select>
                        <select id="filter-room" class="filter-select w-full pl-3 pr-10 py-2 text-sm border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 rounded-md">
                            <option value="all">Semua Ruang</option>
                            <option value="Kelas Mekah">Kelas Mekah</option>
                            <option value="Kelas Madinah">Kelas Madinah</option>
                            <option value="RBM">RBM</option>
                        </select>
                        <button id="reset-filters" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition text-sm">Reset Filter</button>
                    </div>
                </div>

                <div id="semester-tabs-container" class="mb-2 flex space-x-2">
                    <button id="semester-ganjil-btn" class="semester-btn flex-1 p-2 rounded-md font-semibold active">Semester Ganjil</button>
                    <button id="semester-genap-btn" class="semester-btn flex-1 p-2 rounded-md font-semibold">Semester Genap</button>
                </div>

                <div id="ganjil-tabs">
                    <div id="tabs-container" class="mb-4 bg-slate-200 p-1 rounded-lg flex space-x-1">
                        <button id="tab-bulan1" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan I</button>
                        <button id="tab-bulan2" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan II</button>
                        <button id="tab-bulan3" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan III</button>
                        <button id="tab-bulan4" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan IV</button>
                    </div>
                </div>
                <div id="genap-tabs" class="hidden">
                     <div id="tabs-container-genap" class="mb-4 bg-slate-200 p-1 rounded-lg flex space-x-1">
                        <button id="tab-bulan5" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan V</button>
                        <button id="tab-bulan6" class="tab-btn flex-1 p-2 rounded-md font-semibold">Bulan VI</button>
                    </div>
                </div>

                <div id="schedule-container" class="bg-white p-2 rounded-xl shadow-lg overflow-auto max-h-[80vh]"></div>
                
                <div id="schedule-actions" class="flex justify-center gap-4 mt-6">
                    <button id="reset-schedule" class="flex items-center gap-2 bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg> Reset Jadwal</button>
                    <button id="print-schedule" class="flex items-center gap-2 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg> Cetak</button>
                    <button id="download-schedule-pdf" class="flex items-center gap-2 bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Unduh Jadwal (PDF)</button>
                </div>
                
                <div id="teacher-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Data Guru</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="teacher-table" class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Guru</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bidang / Jurusan</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hari</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jadwal (Slot Waktu)</th></tr></thead><tbody class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>
                <div id="module-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Perpustakaan Modul</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="module-table" class="min-w-full"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider" colspan="7">Guru & Modul</th></tr></thead><tbody class="bg-white"></tbody></table></div></div></div>
                <div id="santri-data-container" class="mt-8 bg-white rounded-xl shadow-lg"><div class="data-header flex justify-between items-center p-4 cursor-pointer"><h3 class="text-2xl font-bold text-teal-800">Data Santri</h3><svg class="w-6 h-6 text-teal-800 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></div><div class="data-content p-4 sm:p-6 border-t border-slate-200 hidden"><div class="overflow-x-auto"><table id="santri-table" class="min-w-full divide-y divide-slate-200"><thead class="bg-slate-100"><tr><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">No</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Santri</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jenis Kelamin</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelompok</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kelas</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jurusan</th><th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th></tr></thead><tbody id="santri-table-body" class="bg-white divide-y divide-slate-200"></tbody></table></div></div></div>

            </main>
            <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden"><div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white"><div class="mt-3 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100"><svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg></div><h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">Konfirmasi</h3><div class="mt-2 px-7 py-3"><p class="text-sm text-gray-500" id="modal-message">Apakah Anda yakin?</p></div><div class="items-center px-4 py-3"><button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">Ya, Lanjutkan</button><button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">Batal</button></div></div></div></div>
        </div>
    </div>
<div id="santri" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Informasi Santri</h2>
    <p class="mb-8 text-gray-600">Silakan pilih bulan untuk melihat Kartu Rencana Studi (KRS) atau Kartu Hasil Studi (KHS).</p>

    <div id="santri-selection-container" class="bg-gray-50 p-6 rounded-lg shadow-md mb-8 max-w-lg mx-auto hidden">
        <div class="space-y-2 mb-6">
            <div class="flex">
                <span class="w-28 font-semibold text-gray-700">Nama Santri</span>
                <span id="santri-selector-name" class="font-bold text-gray-900">: </span>
            </div>
            <div class="flex">
                <span class="w-28 font-semibold text-gray-700">Kelompok</span>
                <span id="santri-selector-group" class="font-bold text-gray-900">: </span>
            </div>
        </div>
        <div class="form-group">
            <label for="santri-month-selector" class="font-semibold text-gray-700">Pilih Bulan</label>
            <select id="santri-month-selector" class="filter-select w-full mt-1">
                </select>
        </div>
        <div class="form-group mt-6">
            <button id="show-report-btn" class="submit-btn w-full">Tampilkan</button>
        </div>
    </div>

    <div id="krs-container" class="mt-8 mb-8 p-4 sm:p-6 rounded-xl shadow-lg bg-gray-50 hidden">
        <div id="krs-display" class="mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8" style="width: 210mm;">
            <header class="text-center border-b-2 border-gray-200 pb-4 mb-6">
                <h1 class="text-2xl md:text-3xl font-bold text-gray-800">KARTU RENCANA STUDI (KRS)</h1>
                <h2 class="text-lg md:text-xl font-semibold text-gray-700 mt-1">Markaz Qur'an Al-Maa'un</h2>
                <p class="text-md text-gray-600">Semester Ganjil</p>
            </header>
            <section id="info-santri-krs" class="mb-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 text-sm text-gray-700">
                    <div class="flex"><span class="w-36 font-semibold">Nama Santri</span><span id="nama-santri-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Total SKS yang bisa diambil</span><span id="total-sks-ambil-krs">: 34 sks</span></div>
                    <div class="flex"><span class="w-36 font-semibold">Jurusan</span><span id="jurusan-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Kelas</span><span id="kelas-krs">: </span></div>
                    <div class="flex"><span class="w-36 font-semibold">Kelompok</span><span id="kelompok-krs">: </span></div>
                    <div class="flex"><span class="w-48 font-semibold">Materi untuk Bulan ke</span><span id="materi-bulan-krs">: </span></div>
                </div>
            </section>
            <section>
                <div class="overflow-x-auto">
                    <table id="tabel-krs" class="w-full text-sm text-left text-gray-600">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                            <tr>
                                <th scope="col" class="px-4 py-3">Hari</th>
                                <th scope="col" class="px-4 py-3">Waktu</th>
                                <th scope="col" class="px-4 py-3">Kode</th>
                                <th scope="col" class="px-4 py-3">Mata Pelajaran / Modul</th>
                                <th scope="col" class="px-4 py-3">Ruang</th>
                                <th scope="col" class="px-4 py-3 text-center">SKS</th>
                                <th scope="col" class="px-4 py-3">Guru</th>
                                <th scope="col" class="px-4 py-3">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="krs-table-body"></tbody>
                        <tfoot>
                            <tr class="font-semibold text-gray-900 bg-gray-100">
                                <td colspan="5" class="px-4 py-3 text-right">Total SKS yang Diambil</td>
                                <td id="total-sks-diambil" class="px-4 py-3 text-center">0</td>
                                <td colspan="2" class="px-4 py-3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </section>
        </div>
        <div class="mt-8 text-center flex justify-center items-center gap-4">
    <button id="back-to-santri-krs" title="Kembali" class="bg-gray-500 hover:bg-gray-600 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
    </button>
    <button id="refresh-krs-btn" title="Refresh" class="bg-sky-600 hover:bg-sky-700 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
        </svg>
    </button>
    <button id="add-krs-row" title="Tambah Materi" class="bg-teal-500 hover:bg-teal-600 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" />
        </svg>
    </button>
    <button id="save-krs-btn" title="Simpan KRS" class="bg-green-600 hover:bg-green-700 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V4zm3 1a1 1 0 00-1 1v1a1 1 0 102 0V6a1 1 0 00-1-1zM5 12a1 1 0 001 1h8a1 1 0 100-2H6a1 1 0 00-1 1z" />
        </svg>
    </button>
    <button id="download-krs-btn" title="Unduh PDF" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
        </svg>
    </button>
    <button id="close-krs-btn-bottom" title="Tutup" class="bg-red-500 hover:bg-red-600 text-white font-bold p-3 rounded-lg shadow-lg">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
        </svg>
    </button>
</div>
    </div>
    
    <div id="khs-container" class="mt-8 mb-8 p-4 sm:p-6 rounded-xl shadow-lg bg-gray-50 hidden">
        <div id="khs-display" class="mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8" style="width: 210mm;"></div>
        <div class="mt-8 text-center flex justify-center items-center gap-4">
            <button id="back-to-santri-khs" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 inline-flex items-center">
					<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
					<path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
					</svg>
				<span>Kembali</span>
			</button>
			<button id="download-khs-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 inline-flex items-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>Unduh PDF</span></button>
            <button id="close-khs-btn-bottom" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50">Tutup</button>
        </div>
    </div>
</div>
    <div id="penerimaan" class="page-section hidden container section"><h2>Informasi Penerimaan</h2><p>Informasi penerimaan santri baru akan diumumkan di sini.</p></div>
    <div id="kegiatan" class="page-section hidden container section"><h2>Galeri Kegiatan</h2><div id="gallery-container" class="grid-container"></div></div>
    <div id="legalitas" class="page-section hidden container section"><h2>Akreditas & Legalitas</h2><ul><li><strong>Akta Notaris:</strong> Nomor 12 Tgl 10 Feb 2022</li><li><strong>SK Kemenkumham:</strong> AHU-0004281.AH.01.04.Tahun 2022</li><li><strong>NPWP:</strong> 63.382.276.2-115.000</li></ul></div>
    <div id="mitra" class="page-section hidden container section"><h2>Mitra Kebaikan</h2><p>Kami bekerja sama dengan berbagai pihak, termasuk <strong>Yayasan Sahabat Yatim Indonesia</strong>.</p></div>
	
	
	<div id="laporan-keuangan" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Laporan Keuangan</h2>

    <div id="tutup-buku-gaji-container" class="mt-8 mb-12 p-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg shadow-md hidden">
        <h3 class="text-xl font-semibold text-yellow-800 mb-4">Admin: Tutup Buku Gaji Bulanan</h3>
        <p class="text-yellow-700 mb-6 text-sm">
            Gunakan fitur ini di **akhir bulan** setelah semua absensi, bonus, dan potongan diinput. 
            Proses ini akan menghitung gaji semua karyawan secara final dan menyimpannya ke riwayat (HistoryGaji). 
            Data gaji yang sudah dikunci tidak dapat diubah.
        </p>
        <div class="flex flex-wrap items-end gap-4">
            <div class="form-group flex-grow" style="min-width: 150px;">
                <label for="tutupBukuBulan" class="font-semibold">Bulan</label>
                <select id="tutupBukuBulan" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group" style="width: 120px;">
                <label for="tutupBukuTahun" class="font-semibold">Tahun</label>
                <select id="tutupBukuTahun" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group">
                <button id="kunciGajiBtn" class="bg-red-600 text-white py-3 px-6 rounded-md hover:bg-red-700 w-full md:w-auto font-bold">
                    Kunci & Simpan Gaji Bulan Ini
                </button>
            </div>
        </div>
    </div>
    <div id="keuangan-form-container" class="hidden mb-12">
        
<h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Input Transaksi Keuangan</h3>
<div class="bg-gray-50 p-6 rounded-lg">
    
    <div class="form-group max-w-sm">
    <label for="tanggalKeuangan">Pilih Tanggal Transaksi</label>
    <div class="flex items-center gap-2 mt-1">
        <input type="date" id="tanggalKeuangan" class="flex-grow">
        <button type="button" id="setTanggalDefaultBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-3 rounded-lg text-sm">Set</button>
    </div>
</div>

    <!-- Langkah 2: Tabel Input (Awalnya Tersembunyi) -->
    <div id="keuangan-input-table-container" class="hidden mt-6">
        <div class="overflow-x-auto">
            <table class="min-w-full border">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="px-4 py-2 border text-left">Keterangan</th>
                        <th class="px-4 py-2 border text-left w-48">Masuk (Rp)</th>
                        <th class="px-4 py-2 border text-left w-48">Keluar (Rp)</th>
                        <th class="px-4 py-2 border text-left w-64">Kelompok</th>
                        <th class="px-4 py-2 border w-16"></th>
                    </tr>
                </thead>
                <tbody id="keuangan-input-tbody">
                    <!-- Baris input akan ditambahkan oleh JavaScript di sini -->
                </tbody>
            </table>
        </div>
        <div class="flex justify-between items-center mt-4">
            <button type="button" id="addKeuanganRowBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm">+ Tambah Baris</button>
            <button type="button" id="saveKeuanganBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Simpan Semua</button>
        </div>
    </div>
</div>
<!-- === SAMPAI DI SINI === -->
    </div>
<div id="daily-transaction-container" class="mt-8"></div>
    <div>
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Lihat Laporan Bulanan</h3>
        <div class="bg-gray-100 p-4 rounded-lg shadow-sm flex flex-wrap items-end gap-4 mb-8">
            <div class="form-group flex-grow" style="min-width: 150px;">
                <label for="laporanBulan" class="font-semibold">Pilih Bulan</label>
                <select id="laporanBulan" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group" style="width: 120px;">
                <label for="laporanTahun" class="font-semibold">Tahun</label>
                <select id="laporanTahun" class="filter-select w-full mt-1"></select>
            </div>
            <div class="form-group">
                <button id="tampilkanLaporanKeuanganBtn" class="bg-teal-600 text-white py-3 px-6 rounded-md hover:bg-teal-700 w-full md:w-auto">Tampilkan</button>
            </div>
        </div>

        <div id="keuangan-report-container" class="mt-8">
            <p class="p-8 text-center text-gray-500">Silakan pilih bulan dan tahun, lalu klik "Tampilkan".</p>
        </div>
		

<div id="yearly-summary-container" class="mt-8">
    <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Ringkasan Tahunan</h3>

    <div class="flex justify-end gap-2 mb-4">
        <button id="shareYearlySummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Bagikan</button>
        <button id="downloadYearlySummaryBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Unduh</button>
    </div>

    <div id="printable-summary" class="p-4 bg-white rounded-lg border">
        <div id="group-totals-container" class="mb-6"></div>

        <div class="mb-4 flex justify-center gap-4 text-sm" id="chart-options">
            <label><input type="radio" name="chartType" value="income_expense" checked> Dana Masuk vs Keluar</label>
            <label><input type="radio" name="chartType" value="income_groups"> Kelompok Dana Masuk</label>
            <label><input type="radio" name="chartType" value="expense_groups"> Kelompok Dana Keluar</label>
        </div>

        <div id="keuangan-chart-container" style="height: 350px;">
            <canvas id="keuanganChart"></canvas>
        </div>
    </div>
</div>
    </div>

</div>
	<!-- ======================================================= -->
<!-- === AWAL HALAMAN MUSYRIF === -->
<!-- ======================================================= -->
<div id="musyrif" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-teal-800">Laporan Harian Musyrif</h2>
    <p class="mb-8 text-gray-600">Silakan isi formulir di bawah untuk mencatat aktivitas santri binaan.</p>

    <div class="bg-yellow-50 p-6 rounded-xl shadow-md mb-8 form-glow-kegiatan">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Laporan Kegiatan Harian Santri</h3>
        <form id="formKegiatanMusyrif" class="custom-form bg-yellow-50 p-0 shadow-none max-w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group"><select id="santriKegiatanMusyrif" required></select></div>
                <div class="form-group"><input type="date" id="tanggalKegiatanMusyrif" style="background-color: #e9ecef;"></div>
            </div>
            <div class="form-group">
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrif" value="Sudah dilaksanakan semua" checked class="mr-2"> Sudah dilaksanakan semua</label>
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrif" value="Ada yang tidak dikerjakan" class="mr-2"> Ada yang tidak dikerjakan</label>
                </div>
            </div>
            <div id="keteranganKegiatanMusyrifContainer" class="form-group hidden">
                <label for="keteranganKegiatanMusyrif">Masukkan yang tidak dikerjakan</label>
                <textarea id="keteranganKegiatanMusyrif" rows="3"></textarea>
                <div id="kegiatanMusyrifSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <button type="submit" class="submit-btn">Simpan Laporan Kegiatan</button>
        </form>
    </div>

    <div class="bg-blue-50 p-6 rounded-xl shadow-md mb-8 form-glow-tahfidz">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Laporan Nilai Tahfidz</h3>
        <form id="formTahfidzMusyrif" class="custom-form bg-blue-50 p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><select id="santriTahfidzMusyrif" required></select></div>
                 <div class="form-group"><input type="date" id="tanggalTahfidzMusyrif" style="background-color: #e9ecef;"></div>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 border p-4 rounded-md">
                <h4 class="md:col-span-2 font-semibold text-lg">Ziyadah (Pagi)</h4>
                <div class="form-group"><label>Surah</label><select id="ziyadahPSurahMusyrif"></select></div>
                <div class="form-group grid grid-cols-3 gap-2">
                    <div><label>Ayat Awal</label><input type="number" id="ziyadahPAyatAwalMusyrif"></div>
                    <div><label>Ayat Akhir</label><input type="number" id="ziyadahPAyatAkhirMusyrif"></div>
                    <div><label>Poin</label><input type="number" id="ziyadahPoinMusyrif" required></div>
                </div>
                <h4 class="md:col-span-2 font-semibold text-lg border-t pt-4">Ziyadah (Sore)</h4>
                <div class="form-group"><label>Surah</label><select id="ziyadahSSurahMusyrif"></select></div>
                <div class="form-group grid grid-cols-3 gap-2">
                    <div><label>Ayat Awal</label><input type="number" id="ziyadahSAyatAwalMusyrif"></div>
                    <div><label>Ayat Akhir</label><input type="number" id="ziyadahSAyatAkhirMusyrif"></div>
                    <div><label>Poin</label><input type="number" id="ziyadahSPoinMusyrif" required></div>
                </div>
                <h4 class="md:col-span-2 font-semibold text-lg border-t pt-4">Muraja'ah</h4>
                <div class="form-group md:col-span-2">
                    <label class="font-semibold">Mode Input Muraja'ah:</label>
                    <div id="murajaah-mode-selector-musyrif" class="flex gap-4 mt-2">
                        <label class="flex items-center"><input type="radio" name="murajaahModeMusyrif" value="surah" checked class="mr-2"> Berdasarkan Surah</label>
                        <label class="flex items-center"><input type="radio" name="murajaahModeMusyrif" value="juz" class="mr-2"> Berdasarkan Juz</label>
                        <div class="form-group"><label>Poin</label><input type="number" id="murajaahPoinMusyrif" required></div>
                    </div>
                </div>
                <div id="murajaah-juz-inputs-musyrif" class="md:col-span-2 hidden">
                    <label class="font-semibold mb-2 block">Pilih Juz yang dimuraja'ah (opsional, untuk mengisi otomatis):</label>
                    <div id="juz-checkbox-container-musyrif" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-10 gap-x-4 gap-y-2 p-4 border rounded-md bg-gray-50">
                    </div>
                </div>
                <div id="murajaah-surah-inputs-musyrifah" class="contents">
                    <div class="form-group"><label>Surah Awal</label><select id="murajaahSurahAwalMusyrif"></select></div>
                    <div class="form-group"><label>Ayat Awal</label><input type="number" id="murajaahAyatAwalMusyrif"></div>
                    <div class="form-group"><label>Surah Akhir</label><select id="murajaahSurahAkhirMusyrif"></select></div>
                    <div class="form-group"><label>Ayat Akhir</label><input type="number" id="murajaahAyatAkhirMusyrif"></div>
                </div>
            </div>
            <button type="submit" class="submit-btn">Simpan Nilai Tahfidz</button>
        </form>
    </div>

    <div class="bg-red-50 p-6 rounded-xl shadow-md mb-8 form-glow-pelanggaran">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Laporan Pelanggaran Santri</h3>
        <form id="formPelanggaranMusyrif" class="custom-form bg-red-50 p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><select id="santriPelanggaranMusyrif" required></select></div>
                 <div class="form-group"><input type="date" id="tanggalPelanggaranMusyrif" style="background-color: #e9ecef;"></div>
             </div>
             <div class="form-group">
                <label for="isiPelanggaranMusyrif">Masukkan Pelanggaran</label>
                <textarea id="isiPelanggaranMusyrif" rows="3" required></textarea>
                <div id="pelanggaranMusyrifSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
             </div>
             <div class="form-group">
                <label for="solusiPelanggaranMusyrif">Masukkan Solusi</label>
                <textarea id="solusiPelanggaranMusyrif" rows="3" required></textarea>
                <div id="solusiMusyrifSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
             </div>
            <button type="submit" class="submit-btn">Simpan Laporan Pelanggaran</button>
        </form>
    </div>

    <div id="dailyReportContainerMusyrif" class="mt-12 pt-8 border-t-2 border-gray-200">
         <h2 class="text-2xl font-semibold text-gray-700 mb-4">Laporan Masuk Hari Ini</h2>
         <div id="reportTableMusyrif" class="overflow-x-auto bg-white rounded-lg shadow">
             <p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>
         </div>
     </div>
</div>
<!-- === AKHIR HALAMAN MUSYRIF === -->


<!-- ======================================================= -->
<!-- === AWAL HALAMAN MUSYRIFAH === -->
<!-- ======================================================= -->
<div id="musyrifah" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-purple-800">Laporan Harian Musyrifah</h2>
    <p class="mb-8 text-gray-600">Silakan isi formulir di bawah untuk mencatat aktivitas santri binaan.</p>

    <div class="bg-yellow-50 p-6 rounded-xl shadow-md mb-8 form-glow-kegiatan" >
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">1. Laporan Kegiatan Harian Santri</h3>
        <form id="formKegiatanMusyrifah" class="custom-form bg-yellow-50 p-0 shadow-none max-w-full">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="form-group"><select id="santriKegiatanMusyrifah" required></select></div>
                <div class="form-group"><input type="date" id="tanggalKegiatanMusyrifah" style="background-color: #e9ecef;"></div>
            </div>
            <div class="form-group">
                <label>Status Pelaksanaan</label>
                <div class="flex gap-4">
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrifah" value="Sudah dilaksanakan semua" checked class="mr-2"> Sudah dilaksanakan semua</label>
                    <label class="flex items-center"><input type="radio" name="statusKegiatanMusyrifah" value="Ada yang tidak dikerjakan" class="mr-2"> Ada yang tidak dikerjakan</label>
                </div>
            </div>
            <div id="keteranganKegiatanMusyrifahContainer" class="form-group hidden">
                <label for="keteranganKegiatanMusyrifah">Masukkan yang tidak dikerjakan</label>
                <textarea id="keteranganKegiatanMusyrifah" rows="3"></textarea>
                <div id="kegiatanMusyrifahSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <button type="submit" class="submit-btn">Simpan Laporan Kegiatan</button>
        </form>
    </div>

    <div class="bg-blue-50 p-6 rounded-xl shadow-md mb-8 form-glow-tahfidz">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">2. Laporan Nilai Tahfidz</h3>
        <form id="formTahfidzMusyrifah" class="custom-form bg-blue-50 p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><select id="santriTahfidzMusyrifah" required></select></div>
                 <div class="form-group"><input type="date" id="tanggalTahfidzMusyrifah" style="background-color: #e9ecef;"></div>
             </div>
             <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 border p-4 rounded-md">
                <h4 class="md:col-span-2 font-semibold text-lg">Ziyadah (Pagi)</h4>
                <div class="form-group"><label>Surah</label><select id="ziyadahPSurahMusyrifah"></select></div>
                <div class="form-group grid grid-cols-3 gap-2">
                    <div><label>Ayat Awal</label><input type="number" id="ziyadahPAyatAwalMusyrifah"></div>
                    <div><label>Ayat Akhir</label><input type="number" id="ziyadahPAyatAkhirMusyrifah"></div>
                    <div><label>Poin</label><input type="number" id="ziyadahPoinMusyrifah" required></div>
                </div>
                <h4 class="md:col-span-2 font-semibold text-lg border-t pt-4">Ziyadah (Sore)</h4>
                <div class="form-group"><label>Surah</label><select id="ziyadahSSurahMusyrifah"></select></div>
                <div class="form-group grid grid-cols-3 gap-2">
                    <div><label>Ayat Awal</label><input type="number" id="ziyadahSAyatAwalMusyrifah"></div>
                    <div><label>Ayat Akhir</label><input type="number" id="ziyadahSAyatAkhirMusyrifah"></div>
                    <div><label>Poin</label><input type="number" id="ziyadahSPoinMusyrifah" required></div>
                </div>
                <h4 class="md:col-span-2 font-semibold text-lg border-t pt-4">Muraja'ah</h4>
                <div class="form-group md:col-span-2">
                    <label class="font-semibold">Mode Input Muraja'ah:</label>
                    <div id="murajaah-mode-selector-musyrifah" class="flex gap-4 mt-2">
                        <label class="flex items-center"><input type="radio" name="murajaahModeMusyrifah" value="surah" checked class="mr-2"> Berdasarkan Surah</label>
                        <label class="flex items-center"><input type="radio" name="murajaahModeMusyrifah" value="juz" class="mr-2"> Berdasarkan Juz</label>
                        <div class="form-group"><label>Poin</label><input type="number" id="murajaahPoinMusyrifah" required></div>
                    </div>
                </div>
                <div id="murajaah-juz-inputs-musyrifah" class="md:col-span-2 hidden">
                    <label class="font-semibold mb-2 block">Pilih Juz yang dimuraja'ah (opsional, untuk mengisi otomatis):</label>
                    <div id="juz-checkbox-container-musyrifah" class="grid grid-cols-5 sm:grid-cols-6 md:grid-cols-10 gap-x-4 gap-y-2 p-4 border rounded-md bg-gray-50">
                    </div>
                </div>
                <div id="murajaah-surah-inputs-musyrifah" class="contents">
                    <div class="form-group"><label>Surah Awal</label><select id="murajaahSurahAwalMusyrifah"></select></div>
                    <div class="form-group"><label>Ayat Awal</label><input type="number" id="murajaahAyatAwalMusyrifah"></div>
                    <div class="form-group"><label>Surah Akhir</label><select id="murajaahSurahAkhirMusyrifah"></select></div>
                    <div class="form-group"><label>Ayat Akhir</label><input type="number" id="murajaahAyatAkhirMusyrifah"></div>
                </div>
            </div>
            <button type="submit" class="submit-btn">Simpan Nilai Tahfidz</button>
        </form>
    </div>

    <div class="bg-red-50 p-6 rounded-xl shadow-md mb-8 form-glow-pelanggaran">
        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">3. Laporan Pelanggaran Santri</h3>
        <form id="formPelanggaranMusyrifah" class="custom-form bg-red-50 p-0 shadow-none max-w-full">
             <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                 <div class="form-group"><select id="santriPelanggaranMusyrifah" required></select></div>
                 <div class="form-group"><input type="date" id="tanggalPelanggaranMusyrifah" style="background-color: #e9ecef;"></div>
             </div>
             <div class="form-group">
                <label for="isiPelanggaranMusyrifah">Masukkan Pelanggaran</label>
                <textarea id="isiPelanggaranMusyrifah" rows="3" required></textarea>
                <div id="pelanggaranMusyrifahSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
             </div>
             <div class="form-group">
                <label for="solusiPelanggaranMusyrifah">Masukkan Solusi</label>
                <textarea id="solusiPelanggaranMusyrifah" rows="3" required></textarea>
                <div id="solusiMusyrifahSuggestions" class="mt-2 flex flex-wrap gap-2"></div>
             </div>
            <button type="submit" class="submit-btn">Simpan Laporan Pelanggaran</button>
        </form>
    </div>
    
    <div id="dailyReportContainerMusyrifah" class="mt-12 pt-8 border-t-2 border-gray-200">
         <h2 class="text-2xl font-semibold text-gray-700 mb-4">Laporan Masuk Hari Ini</h2>
         <div id="reportTableMusyrifah" class="overflow-x-auto bg-white rounded-lg shadow">
             <p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>
         </div>
     </div>
</div>

<!-- === AKHIR HALAMAN MUSYRIFAH === -->
    
    <!-- AREA TAMPILAN LAPORAN HARI INI -->
     

<div id="halaman-ujian-admin" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Buka Akses Ujian Manual</h2>
    <p class="mb-8 text-gray-600">Pilih jenis ujian, santri, dan satu materi ujian yang ingin diberi akses.</p>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="form-group bg-white p-4 rounded-lg shadow">
            <label for="admin-jenis-ujian" class="text-base font-semibold">1. Pilih Jenis Ujian</label>
            <select id="admin-jenis-ujian" class="filter-select w-full mt-2">
                <option value="Bulanan">Ujian Bulanan (Remedial/Susulan)</option>
                <option value="UTS">Ujian Tengah Semester</option>
                <option value="UAS">Ujian Akhir Semester</option>
            </select>
        </div>
        <div class="form-group bg-white p-4 rounded-lg shadow">
            <label for="admin-nama-ujian" class="text-base font-semibold">2. Beri Nama Ujian (Opsional)</label>
            <input type="text" id="admin-nama-ujian" class="w-full p-2 mt-2 border rounded" placeholder="Otomatis jika Ujian Bulanan...">
            <p id="admin-nama-ujian-help" class="text-xs text-gray-500 mt-1">Hanya diisi untuk UTS/UAS. Cth: "UTS Ganjil 2025"</p>
        </div>
    </div>
    
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-bold border-b pb-2 mb-2">3. Pilih Santri</h3>
			<div class="text-sm font-medium">
                <input type="checkbox" id="select-all-santri" class="align-middle">
                <label for="select-all-santri" class="align-middle cursor-pointer font-bold border-b pb-2 mb-2 ">Pilih Semua</label>
            </div>
            <div id="admin-santri-list-container" class="max-h-96 overflow-y-auto space-y-2">
                <p>Memuat daftar santri...</p>
            </div>
        </div>
        <div class="bg-white p-4 rounded-lg shadow">
            <h3 class="font-bold border-b pb-2 mb-2">4. Pilih 1 (SATU) Materi Ujian</h3>
            <div id="admin-materi-list-container" class="mt-2">
                <select id="admin-materi-select" class="filter-select w-full">
                    <option value="">Memuat materi...</option>
                </select>
            </div>
        </div>
    </div>
    
    <div class="mt-8 text-center">
        <button id="buka-ujian-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-10 rounded-lg shadow-lg">Buka Ujian</button>
    </div>
	
    <div class="mt-12 pt-8 border-t">
        <h2 class="text-2xl font-bold text-gray-800">Daftar Ujian yang Dibuka Manual</h2>
        <div id="admin-unlocked-exams-list" class="mt-4 bg-white p-4 rounded-lg shadow">
            <p class="text-gray-500">Memuat daftar...</p>
        </div>
        <div class="mt-4 text-right">
            <button id="tutup-ujian-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Tutup Ujian Terpilih</button>
        </div>
    </div>
</div>

<div id="pengawas-ujian" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Dasbor Pengawas Ujian</h2>
    <p class="mb-8 text-gray-600">Pantau aktivitas santri yang sedang melaksanakan ujian secara real-time.</p>

    <button id="proctor-stop-alarm-btn" class="hidden fixed bottom-10 right-10 z-[9999] bg-red-600 hover:bg-red-700 text-white font-bold py-4 px-6 rounded-lg shadow-lg flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072M12 12l.01.01M18.364 5.636a9 9 0 010 12.728M5.636 5.636a9 9 0 0112.728 0" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M18 18L6 6" />
        </svg>
        Matikan Alarm
    </button>
    <div id="proctor-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        </div>
</div>


<div id="ujian-online" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Jadwal Ujian Online</h2>
    <p class="mb-8 text-gray-600">Silakan pilih mata pelajaran di bawah ini untuk memulai ujian. Pastikan Anda sudah siap sebelum memulai.</p>
    
    <div id="ujian-schedule-container" class="bg-white p-2 rounded-xl shadow-lg overflow-auto max-h-[80vh]">
        </div>
</div>

<div id="input-soal" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Input Bank Soal Ujian</h2>
    <p class="mb-8 text-gray-600">Halaman ini untuk memasukkan bank soal. Soal yang sama bisa disimpan ke beberapa materi sekaligus (untuk UTS/UAS).</p>

    <div class="bg-white p-6 rounded-xl shadow-md">
        
        <div class="form-group max-w-md mb-6">
            <label for="input-jenis-ujian" class="text-base font-semibold">1. Pilih Jenis Ujian</label>
            <select id="input-jenis-ujian" class="filter-select w-full mt-2">
                <option value="Bulanan">Ujian Bulanan (Pilih 1 Materi)</option>
                <option value="UTS">Ujian Tengah Semester (Pilih 1+ Materi)</option>
                <option value="UAS">Ujian Akhir Semester (Pilih 1+ Materi)</option>
            </select>
        </div>

        <div class="form-group max-w-md mb-6">
            <label class="text-base font-semibold">2. Pilih Materi Ujian Tujuan</label>
            
            <div id="materi-select-container-bulanan" class="mt-2">
                <select id="materi-soal-select" class="filter-select w-full">
                    <option value="">Pilih Materi...</option>
                </select>
            </div>
            
            <div id="materi-select-container-multi" class="hidden mt-2 border rounded-md p-4 max-h-48 overflow-y-auto space-y-2">
                </div>
        </div>

        <div class="form-group mb-6">
            <label for="quill-editor-container" class="text-base font-semibold">3. Salin dan Tempel Soal dari MS. Word</label>
            <p class="text-sm text-gray-500 mb-2">Pastikan setiap soal diawali angka (cth: 1. Soal). Sistem akan otomatis mendeteksi soal PG dan Isian.</p>
            <div id="quill-editor-container" style="height: 350px;"></div>
        </div>

        <div class="form-group">
            <h3 class="text-base font-semibold mb-2">4. Pratinjau, Isi Kunci Jawaban, dan Simpan</h3>
            <div id="soal-preview-container" class="border rounded-lg overflow-hidden">
                <p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini setelah Anda mem-paste teks di atas.</p>
            </div>
        </div>
        
        <div class="mt-8 text-right">
            <button id="simpan-soal-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg hidden">
                Simpan Semua Soal
            </button>
        </div>
    </div>
</div>

<div id="halaman-guru" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Bank Soal Anda</h2>
    
    <div id="admin-soal-notification" class="hidden my-4 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 rounded-md"></div>
	<p class="mb-8 text-gray-600">Pilih materi untuk melihat, mengedit, dan melengkapi bank soal yang Anda ajar.</p>

    <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="form-group max-w-md mb-6">
            <label for="guru-materi-select" class="text-base font-semibold">1. Pilih Materi Ujian</label>
            <select id="guru-materi-select" class="filter-select w-full mt-2">
                <option value="all">Tampilkan Semua Materi</option>
            </select>
        </div>

        <div id="guru-editor-container-wrapper" class="form-group mb-6 hidden">
            <label for="quill-editor-guru-container" class="text-base font-semibold">2. Edit Soal</label>
            <p class="text-sm text-gray-500 mb-2">Soal akan dimuat di sini. Anda bisa mengedit, menambah, atau menghapus soal. (Termasuk paste gambar dari Word)</p>
            <div id="quill-editor-guru-container" style="height: 350px;"></div>
        </div>

        <div id="guru-preview-wrapper" class="form-group hidden">
            <h3 class="text-base font-semibold mb-2">3. Pratinjau & Kunci Jawaban</h3>
            <div id="soal-preview-guru-container" class="border rounded-lg overflow-hidden">
                <p class="p-8 text-center text-gray-400">Pilih materi untuk memuat pratinjau soal.</p>
            </div>
        </div>
        
        <div class="mt-8 text-right">
            <button id="update-soal-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg hidden">
                Simpan Perubahan
            </button>
        </div>
    </div>
</div>

<div id="lihat-nilai" class="page-section hidden container section">
    <h2 class="text-3xl font-bold text-gray-800">Rekap Nilai Ujian Santri</h2>
    <p class="mb-8 text-gray-600">Pilih salah satu materi yang Anda ajar untuk melihat rekapitulasi nilai seluruh santri.</p>

    <div class="bg-white p-6 rounded-xl shadow-md">
        <div class="form-group max-w-md mb-6">
            <label for="guru-nilai-materi-select" class="text-base font-semibold">Pilih Materi Ujian</label>
            <select id="guru-nilai-materi-select" class="filter-select w-full mt-2">
                <option value="">Memuat materi Anda...</option>
            </select>
        </div>
        
        <div id="guru-nilai-container" class="border rounded-lg overflow-hidden">
            <p class="p-8 text-center text-gray-400">Silakan pilih materi untuk menampilkan rekap nilai.</p>
        </div>
    </div>
</div>

<div id="exam-warning-modal" class="modal">
    <div class="modal-content text-center">
        <h2 class="text-2xl font-bold text-yellow-600 mb-4">Konfirmasi Memulai Ujian</h2>
        <p id="exam-warning-subject" class="text-gray-700 text-lg mb-2">Anda akan memulai ujian untuk mata pelajaran:</p>
        <p id="exam-subject-title" class="font-bold text-xl text-gray-800 mb-6"></p>
        <p class="text-gray-600 mb-6">Pastikan Anda berada di tempat yang kondusif. Halaman akan memasuki mode layar penuh dan waktu akan dihitung saat Anda menekan tombol "Mulai".</p>
        <div class="flex justify-center gap-4">
            <button id="start-exam-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">Mulai</button>
            <button id="cancel-exam-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">Batal</button>
        </div>
    </div>
</div>

<div id="exam-container" class="fixed top-0 left-0 w-full h-full bg-gray-100 z-[5000] p-8 overflow-y-auto hidden">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow-2xl">
        <div id="exam-header" class="border-b pb-4 mb-6">
            <h1 id="exam-title" class="text-3xl font-bold text-gray-800">Ujian Online</h1>
            <p id="exam-subtitle" class="text-lg text-gray-600"></p>
        </div>
        <div id="exam-questions">
            </div>
        <div id="exam-footer" class="mt-8 pt-4 border-t">
            <button id="submit-exam-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg text-xl">Selesai & Kirim Jawaban</button>
        </div>
    </div> <div id="exam-nav-grid-container">
        </div>
</div>

<div id="exam-result-modal" class="modal">
    <div class="modal-content text-center">
        <h2 id="result-title" class="text-3xl font-bold mb-4">Hasil Ujian Anda</h2>
        <p id="result-score" class="text-8xl font-bold my-8"></p>
        <p id="result-message" class="text-lg text-gray-700 mb-8"></p>
        <div id="result-actions">
            </div>
    </div>
</div>

<div id="fullscreenWarningModal" class="modal" style="background-color: rgba(0,0,0,0.85);">
    <div class="modal-content text-center">
        <h2 class="text-2xl font-bold text-red-600 mb-4">PERINGATAN!</h2>
        <p class="text-gray-700 text-lg mb-6">
            Anda terdeteksi keluar dari mode layar penuh. Harap kembali ke mode layar penuh untuk melanjutkan ujian.
        </p>
        <button id="reenterFullscreenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">
            Kembali ke Ujian
        </button>
    </div>
</div>

<div id="teacherPasswordModal" class="modal" style="background-color: rgba(0,0,0,0.85);">
    <div class="modal-content text-center">
        <h2 class="text-2xl font-bold text-yellow-500 mb-4">Akses Ujian Lanjutan</h2>
        <p class="text-gray-700 text-lg mb-6">
            Ujian ini sudah pernah dimulai. Untuk melanjutkan, silakan minta <strong>kata sandi 5 digit</strong> dari pengawas ujian.
        </p>
        <div class="my-4">
            <input type="text" inputmode="numeric" pattern="[0-9]*" id="teacherPasswordInput" class="text-center text-3xl tracking-[0.5em] w-64 p-2 border-2 rounded" maxlength="5" placeholder="_ _ _ _ _">
        </div>
        <div class="flex justify-center gap-4">
            <button id="submitTeacherPasswordBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">Lanjutkan Ujian</button>
            <button id="cancelTeacherPasswordBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">Batal</button>
        </div>
    </div>
</div>
	
    <div id="login" class="page-section hidden container"><form id="loginForm" class="custom-form"><h2 style="text-align: center;">Login Pengurus / Staf</h2><div class="form-group"><label for="username">Username</label><input type="text" id="username" name="username" autocomplete="username" required></div><div class="form-group password-container"><label for="password">Password</label><input type="password" id="password" name="password" required><span class="toggle-password"></span></div><div class="form-group remember-me"><div><input type="checkbox" id="remember" name="remember"><label for="remember">Ingat saya selama 30 hari</label></div><a href="#" id="forgotPasswordLink" class="forgot-password">Lupa Sandi?</a></div><button type="submit" class="submit-btn">Masuk</button></form></div>
    <div id="donasiModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Tata Cara Donasi</h2><p>Silakan transfer ke <strong>Bank BRI: 7040-0102-7168535</strong> a/n Markaz Yatim Duafa Qurani.</p><p style="text-align:center; margin-top:1rem;">Atau scan QRIS:</p><img src="qrisdonasi.png" alt="QRIS Donasi" style="width:250px;display:block;margin:15px auto;border-radius:8px;" onerror="this.onerror=null;this.src='https://placehold.co/250x250/cccccc/FFFFFF?text=QRIS+Error';"><a href="qrisdonasi.png" class="download-btn" download="qrisdonasi.png">Unduh QRIS</a><p>Konfirmasi ke <strong>085261804096</strong>.</p></div></div>
    <div id="profileModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Profil Saya</h2><form id="profileForm"><div class="profile-picture-container"><img id="profilePicturePreview" src="https://placehold.co/128x128/e9ecef/343a40?text=Foto" alt="Foto Profil"><input type="file" id="profilePictureInput" accept="image/*"><label for="profilePictureInput" id="uploadPictureLabel">Ganti Foto</label></div><div class="form-group"><label for="profileName">Nama Profil</label><input type="text" id="profileName" required></div><div class="form-group"><label for="profileDob">Tanggal Lahir</label><input type="date" id="profileDob"></div><div class="form-group"><label for="profileAddress">Alamat</label><textarea id="profileAddress" rows="3"></textarea></div><div class="form-group"><label for="profileJabatan">Jabatan</label><input type="text" id="profileJabatan"></div><div class="form-group"><label for="profileUsername">Username</label><input type="text" id="profileUsername" required readonly style="background-color:#e9ecef;cursor:not-allowed;"></div><div style="display:flex;gap:10px;margin-top:20px;"><button type="submit" class="submit-btn" style="flex:1;">Simpan</button><button type="button" id="changePasswordFromProfile" class="auth-button" style="flex:1;background-color:var(--secondary-color);">Ganti Sandi</button><button type="button" id="logoutFromProfile" class="auth-button" style="flex:1;background-color:var(--error-color);color:white;">Logout</button></div></form></div></div>
    <div id="changePasswordModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><h2>Ganti Kata Sandi</h2><form id="changePasswordForm"><div class="form-group password-container"><label for="currentPassword">Sandi Saat Ini</label><input type="password" id="currentPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="newPassword">Sandi Baru</label><input type="password" id="newPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="confirmNewPassword">Konfirmasi Sandi Baru</label><input type="password" id="confirmNewPassword" required><span class="toggle-password"></span></div><button type="submit" class="submit-btn">Simpan</button></form></div></div>
    <div id="forgotPasswordModal" class="modal"><div class="modal-content"><span class="close-button">&times;</span><div id="forgotPasswordStep1"><h2>Lupa Kata Sandi</h2><form id="forgotPasswordVerifyForm"><div class="form-group"><label for="forgotUsername">Username</label><input type="text" id="forgotUsername" required></div><div class="form-group"><label for="forgotDob">Tanggal Lahir</label><input type="date" id="forgotDob" required></div><button type="submit" class="submit-btn">Verifikasi</button></form></div><div id="forgotPasswordStep2" class="hidden"><h2>Atur Ulang Sandi</h2><form id="forgotPasswordResetForm"><div class="form-group password-container"><label for="forgotNewPassword">Sandi Baru</label><input type="password" id="forgotNewPassword" required><span class="toggle-password"></span></div><div class="form-group password-container"><label for="forgotConfirmPassword">Konfirmasi Sandi Baru</label><input type="password"id="forgotConfirmPassword" required><span class="toggle-password"></span></div><button type="submit" class="submit-btn">Simpan</button></form></div></div></div>
    <div id="announcementPopup" class="modal">
    <div class="modal-content text-center">
        <span id="closePopupBtn" class="close-button">&times;</span>
        <h2 class="text-2xl font-bold text-green-700 mb-4">Pemberitahuan Penting</h2>
        <img src="warning.png" alt="Pengumuman" class="mx-auto mb-4 rounded-lg" style="max-height: 200px;">
        <p class="text-gray-700 mb-6">
            Update Terbaru :
        </p>
		<p class="text-4xl font-bold text-red-700 mb-4">November 2025</h2>
		</p>
		<ul class="list-disc list-inside text-gray-700 text-left space-y-2 mb-6">
            <li>Roster KBM berubah untuk semester 2</li>
            <li>Tambahan absensi santri untuk tiap guru</li>
			<li>Panduan Pengisian Poin Nilai Ziyadah dan Muraja'ah</li>
            <li>Input Soal sudah mendukung gambar dan soal model isian</li>
            <li>Laporan keuangan lebih fresh dan lebih mudah di lihat</li>
            <li>Laporan Harian musyrif/ah lebih spesifik dan lebih mudah digunakan</li>
            <li>Laporan Tahfidz kini menampilkan Laporan Keseharian, Laporan Nilai, Laporan Pelanggaran</li>
            <li>Laporan Tahfidz kini juga menampilkan Grafik yang lebih mudah dibaca</li>
            <li>Slip gaji dibuat lebih spesifik (penambahan piutang ke yayasan)</li>
        </ul>
        <button id="understandPopupBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
            Saya Mengerti
        </button>
    </div>
</div>

<div id="add-materi-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Pilih Materi untuk Ditambahkan</h2>
        <div id="materi-list-container" class="max-h-80 overflow-y-auto border rounded-lg p-4 space-y-2 mb-6">
            <p class="text-gray-500">Memuat daftar materi...</p>
        </div>
        <div class="text-right">
                <button id="simpan-materi-btn" class="submit-btn" style="width: auto; padding: 10px 30px;">Input</button>
            </div>
    </div>
</div>

<div id="customConfirmModal" class="modal">
    <div class="modal-content text-center">
        <h2 id="confirmModalTitle" class="text-2xl font-bold text-yellow-600 mb-4">Konfirmasi Tindakan</h2>
        
        <img src="warning.png" alt="Peringatan" class="mx-auto mb-4 rounded-lg" style="max-height: 150px;">
        
        <p id="confirmModalMessage" class="text-gray-700 text-lg mb-8">Apakah Anda yakin ingin melanjutkan?</p>
        
        <div class="flex justify-center gap-4">
            <button id="confirmModalYesBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg">
                Ya
            </button>
            <button id="confirmModalNoBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg">
                Batal
            </button>
        </div>
    </div>
</div>

<div id="alertModal" class="modal" style="z-index: 9999;">
    <div class="modal-content text-center">
        <h2 id="alertModalTitle" class="text-2xl font-bold text-red-600 mb-4">Peringatan</h2>
        <img src="warning.png" alt="Peringatan" class="mx-auto mb-4 rounded-lg" style="max-height: 150px;">
        <p id="alertModalMessage" class="text-gray-700 text-lg mb-8">Ini adalah pesan peringatan.</p>
        <div class="flex justify-center gap-4">
            <button id="alertModalOkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">
                Mengerti
            </button>
        </div>
    </div>
</div>

<div id="loading-overlay" class="hidden">
    <div class="loader"></div>
</div>

<a href="#jadwal-sholat" id="floating-prayer-btn">
    <span id="floating-prayer-icon"></span>
    <span id="floating-prayer-text">Memuat jadwal...</span>
</a>

<button id="floatingRubrikBtn" class="hidden fixed bottom-4 left-4 z-[50] bg-blue-600 text-white py-3 px-4 rounded-full shadow-lg flex items-center gap-2 animate-pulse" title="Lihat Panduan Poin">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
    </svg>
    <span class="font-semibold">Panduan Poin</span>
</button>

<div id="rubrikModal" class="modal">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-button">&times;</span>
        <h2 class="text-2xl font-bold mb-6">Panduan Rubrik Penilaian Tahfidz</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="rubrik-card p-4 rounded-lg shadow-sm">
                <h4 class="text-lg font-bold mb-2">Panduan Poin Ziyadah (Baru)</h4>
                <p class="text-xs text-gray-500 mb-3">Total Poin = Kelancaran + Tajwid + Adab</p>
                <ul class="rubrik-list">
                    <li>
                        <strong>Kelancaran (Bobot 50%):</strong>
                        <ul class="sub-list">
                            <li><span class="poin-badge">5 Poin</span> Sangat lancar, tanpa henti.</li>
                            <li><span class="poin-badge">3 Poin</span> Cukup lancar, 1-2 kali berhenti.</li>
                            <li><span class="poin-badge">1 Poin</span> Terbata-bata.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Tajwid & Makhraj (Bobot 30%):</strong>
                        <ul class="sub-list">
                            <li><span class="poin-badge">3 Poin</span> Sangat baik.</li>
                            <li><span class="poin-badge">1 Poin</span> Banyak kesalahan.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Adab (Bobot 20%):</strong>
                        <ul class="sub-list">
                            <li><span class="poin-badge">2 Poin</span> Santri fokus dan beradab baik.</li>
                            <li><span class="poin-badge">1 Poin</span> Kurang fokus.</li>
                        </ul>
                    </li>
                    <li>
                        <p class="rubrik-example">Contoh: Lancar (5) + Tajwid Baik (3) + Adab Baik (2) = 10 Poin.</p>
                    </li>
                </ul>
            </div>

            <div class="rubrik-card p-4 rounded-lg shadow-sm">
                <h4 class="text-lg font-bold mb-2">Panduan Poin Muraja'ah (Ulang)</h4>
                <p class="text-xs text-gray-500 mb-3">Total Poin = Kelancaran + Minim Kesalahan</p>
                <ul class="rubrik-list">
                    <li>
                        <strong>Kelancaran (Bobot 60%):</strong>
                        <ul class="sub-list">
                            <li><span class="poin-badge">6 Poin</span> Sangat lancar (seperti membaca).</li>
                            <li><span class="poin-badge">3 Poin</span> Cukup lancar, ada keraguan.</li>
                            <li><span class="poin-badge">1 Poin</span> Banyak berhenti/lupa.</li>
                        </ul>
                    </li>
                    <li>
                        <strong>Minim Kesalahan (Bobot 40%):</strong>
                        <ul class="sub-list">
                            <li><span class="poin-badge">4 Poin</span> Tidak ada kesalahan fatal.</li>
                            <li><span class="poin-badge">1 Poin</span> Banyak kesalahan (tasmi').</li>
                        </ul>
                    </li>
                    <li>
                        <p class="rubrik-example">Contoh: Seperti membaca (6) + Tidak salah (4) = 10 Poin.</p>
                    </li>
                </ul>
            </div>
        </div>
        </div>
</div>

<div id="tips-container" class="hidden">
    <img id="tips-santri" src="tips.png" alt="Animasi Santri">
    
    <div id="tips-bubble">
        <div id="tips-content">
            Memuat tips...
        </div>
    </div>
</div>

	<footer><div class="container"><p>&copy; 2025 Yayasan Markaz Yatim Duafa Qurani. Semua Hak Cipta Dilindungi.</p><p>Jl. Protokol Desa Sei Kamah II, Sei Dadap, Asahan, Sumut | <a href="mailto:markazyatimduafaqurani@gmail.com">markazyatimduafaqurani@gmail.com</a> | 085261804096</p></div></footer>
	
	<script src="https://www.youtube.com/iframe_api"></script>
	
<script>

	// =======================================================
// === KODE KONTROL YOUTUBE (VERSI FINAL YANG SEBENARNYA) ===
// =======================================================
let player;
let videoSlideshowInterval;
const playlistId = 'PLCkk8QVJzkuQBH-p2kHcTTG_4gzibc93v';

let isYouTubeApiReady = false;
let isPlayerInitialized = false;
let playlistVideoIds = []; // Variabel untuk menyimpan semua ID video
let currentVideoIndex = -1; // Kita mulai dari -1 agar putaran pertama menjadi 0

// Fungsi untuk MEMULAI slideshow (perpindahan otomatis)
function startSlideshow() {
    stopSlideshow(); // Selalu hentikan timer lama untuk mencegah tumpuk
    videoSlideshowInterval = setInterval(() => {
        if (!player || playlistVideoIds.length === 0) return;

        // Pindah ke indeks video berikutnya, kembali ke 0 jika sudah di akhir
        currentVideoIndex = (currentVideoIndex + 1) % playlistVideoIds.length;
        const nextVideoId = playlistVideoIds[currentVideoIndex];
        
        // Menggunakan cueVideoById untuk HANYA MENYIAPKAN video, BUKAN memutarnya
        if (player && typeof player.cueVideoById === 'function') {
            player.cueVideoById(nextVideoId);
        }
    }, 8000); // Pindah video setiap 8 detik
}

// Fungsi untuk MENGHENTIKAN slideshow
function stopSlideshow() {
    clearInterval(videoSlideshowInterval);
}

// Fungsi ini dipanggil oleh YouTube API
window.onYouTubeIframeAPIReady = function() {
    isYouTubeApiReady = true;
    initializePlayer();
};

// Fungsi ini dipanggil saat pemutar video sudah benar-benar siap
function onPlayerReady(event) {
    // Ambil daftar semua ID video di dalam playlist
    playlistVideoIds = player.getPlaylist();
    // Dapatkan indeks video yang dimuat pertama kali (biasanya 0)
    currentVideoIndex = player.getPlaylistIndex();
    // Mulai slideshow untuk pertama kalinya
    startSlideshow();
}

// Fungsi ini dipanggil saat status video berubah
function onPlayerStateChange(event) {
    // Saat video baru disiapkan (CUED), perbarui judulnya
    if (event.data === YT.PlayerState.CUED) {
        const titleElement = document.getElementById('youtube-title');
        const videoData = player.getVideoData(); // Ambil data video saat ini
        if (titleElement && videoData && videoData.title) {
            titleElement.textContent = videoData.title; // Tampilkan judulnya
        }
    }

    // Jika video DIPUTAR atau DIJEDA oleh pengguna, hentikan slideshow
    if (event.data === YT.PlayerState.PLAYING || event.data === YT.PlayerState.PAUSED) {
        stopSlideshow();
    } 
    // Jika video yang ditonton SELESAI, mulai lagi slideshow
    else if (event.data === YT.PlayerState.ENDED) {
        startSlideshow();
    }
}

// Fungsi untuk membuat player
function initializePlayer() {
    if (isYouTubeApiReady && document.getElementById('youtube-player') && !isPlayerInitialized) {
        isPlayerInitialized = true;
        player = new YT.Player('youtube-player', {
            height: '100%',
            width: '100%',
            playerVars: {
                'playsinline': 1,
                'autoplay': 0, // Nilai ini HARUS 0
                'controls': 1,
                'listType': 'playlist',
                'list': playlistId
            },
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
	
	
	
	const loadingOverlay = document.getElementById('loading-overlay');
    const showLoading = () => loadingOverlay.classList.remove('hidden');
    const hideLoading = () => loadingOverlay.classList.add('hidden');
	
	let academicMonthRanges = [];
    let isSistemInformasiInitialized = false;
	let santriDataWithUsernames = null; // Cache untuk santri data termasuk usernames
    // --- BAGIAN 1: KONFIGURASI & DATA UTAMA ---
    const CONFIG = {
        
		SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxcwa24mmkgbdHUHQvjAnj_drADmr6Hb1EQyA6q4vK-vjdu-44F4U__19W4st54Skoqww/exec",
        CLOUDINARY_URL: "https://api.cloudinary.com/v1_1/deva5eknr/image/upload",
        CLOUDINARY_UPLOAD_PRESET: "markaz",
        ICONS: {
            eye: `<svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>`,
            eyeOff: `<svg class="eye-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>`
        }
		
    };
	
	// --- DATA JUZ AL-QUR'AN (MUSHAF MADINAH) ---
    const JUZ_DATA = [
        { juz: 1, start: { surah: "Al-Fatihah", ayat: 1 }, end: { surah: "Al-Baqarah", ayat: 141 } },
        { juz: 2, start: { surah: "Al-Baqarah", ayat: 142 }, end: { surah: "Al-Baqarah", ayat: 252 } },
        { juz: 3, start: { surah: "Al-Baqarah", ayat: 253 }, end: { surah: "Ali 'Imran", ayat: 92 } },
        { juz: 4, start: { surah: "Ali 'Imran", ayat: 93 }, end: { surah: "An-Nisa'", ayat: 23 } },
        { juz: 5, start: { surah: "An-Nisa'", ayat: 24 }, end: { surah: "An-Nisa'", ayat: 147 } },
        { juz: 6, start: { surah: "An-Nisa'", ayat: 148 }, end: { surah: "Al-Ma'idah", ayat: 81 } },
        { juz: 7, start: { surah: "Al-Ma'idah", ayat: 82 }, end: { surah: "Al-An'am", ayat: 110 } },
        { juz: 8, start: { surah: "Al-An'am", ayat: 111 }, end: { surah: "Al-A'raf", ayat: 87 } },
        { juz: 9, start: { surah: "Al-A'raf", ayat: 88 }, end: { surah: "Al-Anfal", ayat: 40 } },
        { juz: 10, start: { surah: "Al-Anfal", ayat: 41 }, end: { surah: "At-Tawbah", ayat: 92 } },
        { juz: 11, start: { surah: "At-Tawbah", ayat: 93 }, end: { surah: "Hud", ayat: 5 } },
        { juz: 12, start: { surah: "Hud", ayat: 6 }, end: { surah: "Yusuf", ayat: 52 } },
        { juz: 13, start: { surah: "Yusuf", ayat: 53 }, end: { surah: "Ibrahim", ayat: 52 } },
        { juz: 14, start: { surah: "Al-Hijr", ayat: 1 }, end: { surah: "An-Nahl", ayat: 128 } },
        { juz: 15, start: { surah: "Al-Isra'", ayat: 1 }, end: { surah: "Al-Kahf", ayat: 74 } },
        { juz: 16, start: { surah: "Al-Kahf", ayat: 75 }, end: { surah: "Taha", ayat: 135 } },
        { juz: 17, start: { surah: "Al-Anbiya'", ayat: 1 }, end: { surah: "Al-Hajj", ayat: 78 } },
        { juz: 18, start: { surah: "Al-Mu'minun", ayat: 1 }, end: { surah: "Al-Furqan", ayat: 20 } },
        { juz: 19, start: { surah: "Al-Furqan", ayat: 21 }, end: { surah: "An-Naml", ayat: 55 } },
        { juz: 20, start: { surah: "An-Naml", ayat: 56 }, end: { surah: "Al-'Ankabut", ayat: 45 } },
        { juz: 21, start: { surah: "Al-'Ankabut", ayat: 46 }, end: { surah: "Al-Ahzab", ayat: 30 } },
        { juz: 22, start: { surah: "Al-Ahzab", ayat: 31 }, end: { surah: "Yasin", ayat: 27 } },
        { juz: 23, start: { surah: "Yasin", ayat: 28 }, end: { surah: "Az-Zumar", ayat: 31 } },
        { juz: 24, start: { surah: "Az-Zumar", ayat: 32 }, end: { surah: "Fussilat", ayat: 46 } },
        { juz: 25, start: { surah: "Fussilat", ayat: 47 }, end: { surah: "Al-Jasiyah", ayat: 37 } },
        { juz: 26, start: { surah: "Al-Ahqaf", ayat: 1 }, end: { surah: "Az-Zariyat", ayat: 30 } },
        { juz: 27, start: { surah: "Az-Zariyat", ayat: 31 }, end: { surah: "Al-Hadid", ayat: 29 } },
        { juz: 28, start: { surah: "Al-Mujadilah", ayat: 1 }, end: { surah: "At-Tahrim", ayat: 12 } },
        { juz: 29, start: { surah: "Al-Mulk", ayat: 1 }, end: { surah: "Al-Mursalat", ayat: 50 } },
        { juz: 30, start: { surah: "An-Naba'", ayat: 1 }, end: { surah: "An-Nas", ayat: 6 } }
    ];
	
	const JUZ_DETAIL_DATA = {
  1: {
    totalAyat: 148,
    contents: [
      { surah: 1, nama: "Al-Fatihah", totalAyat: 7, start: 1, end: 7 },
      { surah: 2, nama: "Al-Baqarah", totalAyat: 286, start: 1, end: 141 }
    ]
  },
  2: {
    totalAyat: 111,
    contents: [
      { surah: 2, nama: "Al-Baqarah", totalAyat: 286, start: 142, end: 252 }
    ]
  },
  3: {
    totalAyat: 126,
    contents: [
      { surah: 2, nama: "Al-Baqarah", totalAyat: 286, start: 253, end: 286 },
      { surah: 3, nama: "Ali 'Imran", totalAyat: 200, start: 1, end: 92 }
    ]
  },
  4: {
    totalAyat: 131,
    contents: [
      { surah: 3, nama: "Ali 'Imran", totalAyat: 200, start: 93, end: 200 },
      { surah: 4, nama: "An-Nisa'", totalAyat: 176, start: 1, end: 23 }
    ]
  },
  5: {
    totalAyat: 124,
    contents: [
      { surah: 4, nama: "An-Nisa'", totalAyat: 176, start: 24, end: 147 }
    ]
  },
  6: {
    totalAyat: 110,
    contents: [
      { surah: 4, nama: "An-Nisa'", totalAyat: 176, start: 148, end: 176 },
      { surah: 5, nama: "Al-Ma'idah", totalAyat: 120, start: 1, end: 81 }
    ]
  },
  7: {
    totalAyat: 149,
    contents: [
      { surah: 5, nama: "Al-Ma'idah", totalAyat: 120, start: 82, end: 120 },
      { surah: 6, nama: "Al-An'am", totalAyat: 165, start: 1, end: 110 }
    ]
  },
  8: {
    totalAyat: 142,
    contents: [
      { surah: 6, nama: "Al-An'am", totalAyat: 165, start: 111, end: 165 },
      { surah: 7, nama: "Al-A'raf", totalAyat: 206, start: 1, end: 87 }
    ]
  },
  9: {
    totalAyat: 159,
    contents: [
      { surah: 7, nama: "Al-A'raf", totalAyat: 206, start: 88, end: 206 },
      { surah: 8, nama: "Al-Anfal", totalAyat: 75, start: 1, end: 40 }
    ]
  },
  10: {
    totalAyat: 127,
    contents: [
      { surah: 8, nama: "Al-Anfal", totalAyat: 75, start: 41, end: 75 },
      { surah: 9, nama: "At-Tawbah", totalAyat: 129, start: 1, end: 92 }
    ]
  },
  11: {
    totalAyat: 151,
    contents: [
      { surah: 9, nama: "At-Tawbah", totalAyat: 129, start: 93, end: 129 },
      { surah: 10, nama: "Yunus", totalAyat: 109, start: 1, end: 109 },
      { surah: 11, nama: "Hud", totalAyat: 123, start: 1, end: 5 }
    ]
  },
  12: {
    totalAyat: 170,
    contents: [
      { surah: 11, nama: "Hud", totalAyat: 123, start: 6, end: 123 },
      { surah: 12, nama: "Yusuf", totalAyat: 111, start: 1, end: 52 }
    ]
  },
  13: {
    totalAyat: 154,
    contents: [
      { surah: 12, nama: "Yusuf", totalAyat: 111, start: 53, end: 111 },
      { surah: 13, nama: "Ar-Ra'd", totalAyat: 43, start: 1, end: 43 },
      { surah: 14, nama: "Ibrahim", totalAyat: 52, start: 1, end: 52 }
    ]
  },
  14: {
    totalAyat: 227,
    contents: [
      { surah: 15, nama: "Al-Hijr", totalAyat: 99, start: 1, end: 99 },
      { surah: 16, nama: "An-Nahl", totalAyat: 128, start: 1, end: 128 }
    ]
  },
  15: {
    totalAyat: 185,
    contents: [
      { surah: 17, nama: "Al-Isra'", totalAyat: 111, start: 1, end: 111 },
      { surah: 18, nama: "Al-Kahf", totalAyat: 110, start: 1, end: 74 }
    ]
  },
  16: {
    totalAyat: 269,
    contents: [
      { surah: 18, nama: "Al-Kahf", totalAyat: 110, start: 75, end: 110 },
      { surah: 19, nama: "Maryam", totalAyat: 98, start: 1, end: 98 },
      { surah: 20, nama: "Taha", totalAyat: 135, start: 1, end: 135 }
    ]
  },
  17: {
    totalAyat: 190,
    contents: [
      { surah: 21, nama: "Al-Anbiya'", totalAyat: 112, start: 1, end: 112 },
      { surah: 22, nama: "Al-Hajj", totalAyat: 78, start: 1, end: 78 }
    ]
  },
  18: {
    totalAyat: 202,
    contents: [
      { surah: 23, nama: "Al-Mu'minun", totalAyat: 118, start: 1, end: 118 },
      { surah: 24, nama: "An-Nur", totalAyat: 64, start: 1, end: 64 },
      { surah: 25, nama: "Al-Furqan", totalAyat: 77, start: 1, end: 20 }
    ]
  },
  19: {
    totalAyat: 339,
    contents: [
      { surah: 25, nama: "Al-Furqan", totalAyat: 77, start: 21, end: 77 },
      { surah: 26, nama: "Asy-Syu'ara'", totalAyat: 227, start: 1, end: 227 },
      { surah: 27, nama: "An-Naml", totalAyat: 93, start: 1, end: 55 }
    ]
  },
  20: {
    totalAyat: 171,
    contents: [
      { surah: 27, nama: "An-Naml", totalAyat: 93, start: 56, end: 93 },
      { surah: 28, nama: "Al-Qasas", totalAyat: 88, start: 1, end: 88 },
      { surah: 29, nama: "Al-'Ankabut", totalAyat: 69, start: 1, end: 45 }
    ]
  },
  21: {
    totalAyat: 178,
    contents: [
      { surah: 29, nama: "Al-'Ankabut", totalAyat: 69, start: 46, end: 69 },
      { surah: 30, nama: "Ar-Rum", totalAyat: 60, start: 1, end: 60 },
      { surah: 31, nama: "Luqman", totalAyat: 34, start: 1, end: 34 },
      { surah: 32, nama: "As-Sajdah", totalAyat: 30, start: 1, end: 30 },
      { surah: 33, nama: "Al-Ahzab", totalAyat: 73, start: 1, end: 30 }
    ]
  },
  22: {
    totalAyat: 169,
    contents: [
      { surah: 33, nama: "Al-Ahzab", totalAyat: 73, start: 31, end: 73 },
      { surah: 34, nama: "Saba'", totalAyat: 54, start: 1, end: 54 },
      { surah: 35, nama: "Fatir", totalAyat: 45, start: 1, end: 45 },
      { surah: 36, nama: "Yasin", totalAyat: 83, start: 1, end: 27 }
    ]
  },
  23: {
    totalAyat: 357,
    contents: [
      { surah: 36, nama: "Yasin", totalAyat: 83, start: 28, end: 83 },
      { surah: 37, nama: "As-Saffat", totalAyat: 182, start: 1, end: 182 },
      { surah: 38, nama: "Sad", totalAyat: 88, start: 1, end: 88 },
      { surah: 39, nama: "Az-Zumar", totalAyat: 75, start: 1, end: 31 }
    ]
  },
  24: {
    totalAyat: 175,
    contents: [
      { surah: 39, nama: "Az-Zumar", totalAyat: 75, start: 32, end: 75 },
      { surah: 40, nama: "Ghafir", totalAyat: 85, start: 1, end: 85 },
      { surah: 41, nama: "Fussilat", totalAyat: 54, start: 1, end: 46 }
    ]
  },
  25: {
    totalAyat: 246,
    contents: [
      { surah: 41, nama: "Fussilat", totalAyat: 54, start: 47, end: 54 },
      { surah: 42, nama: "Asy-Syura", totalAyat: 53, start: 1, end: 53 },
      { surah: 43, nama: "Az-Zukhruf", totalAyat: 89, start: 1, end: 89 },
      { surah: 44, nama: "Ad-Dukhan", totalAyat: 59, start: 1, end: 59 },
      { surah: 45, nama: "Al-Jasiyah", totalAyat: 37, start: 1, end: 37 }
    ]
  },
  26: {
    totalAyat: 195,
    contents: [
      { surah: 46, nama: "Al-Ahqaf", totalAyat: 35, start: 1, end: 35 },
      { surah: 47, nama: "Muhammad", totalAyat: 38, start: 1, end: 38 },
      { surah: 48, nama: "Al-Fath", totalAyat: 29, start: 1, end: 29 },
      { surah: 49, nama: "Al-Hujurat", totalAyat: 18, start: 1, end: 18 },
      { surah: 50, nama: "Qaf", totalAyat: 45, start: 1, end: 45 },
      { surah: 51, nama: "Az-Zariyat", totalAyat: 60, start: 1, end: 30 }
    ]
  },
  27: {
    totalAyat: 399,
    contents: [
      { surah: 51, nama: "Az-Zariyat", totalAyat: 60, start: 31, end: 60 },
      { surah: 52, nama: "At-Tur", totalAyat: 49, start: 1, end: 49 },
      { surah: 53, nama: "An-Najm", totalAyat: 62, start: 1, end: 62 },
      { surah: 54, nama: "Al-Qamar", totalAyat: 55, start: 1, end: 55 },
      { surah: 55, nama: "Ar-Rahman", totalAyat: 78, start: 1, end: 78 },
      { surah: 56, nama: "Al-Waqi'ah", totalAyat: 96, start: 1, end: 96 },
      { surah: 57, nama: "Al-Hadid", totalAyat: 29, start: 1, end: 29 }
    ]
  },
  28: {
    totalAyat: 137,
    contents: [
      { surah: 58, nama: "Al-Mujadilah", totalAyat: 22, start: 1, end: 22 },
      { surah: 59, nama: "Al-Hasyr", totalAyat: 24, start: 1, end: 24 },
      { surah: 60, nama: "Al-Mumtahanah", totalAyat: 13, start: 1, end: 13 },
      { surah: 61, nama: "As-Saff", totalAyat: 14, start: 1, end: 14 },
      { surah: 62, nama: "Al-Jumu'ah", totalAyat: 11, start: 1, end: 11 },
      { surah: 63, nama: "Al-Munafiqun", totalAyat: 11, start: 1, end: 11 },
      { surah: 64, nama: "At-Taghabun", totalAyat: 18, start: 1, end: 18 },
      { surah: 65, nama: "At-Talaq", totalAyat: 12, start: 1, end: 12 },
      { surah: 66, nama: "At-Tahrim", totalAyat: 12, start: 1, end: 12 }
    ]
  },
  29: {
    totalAyat: 431,
    contents: [
      { surah: 67, nama: "Al-Mulk", totalAyat: 30, start: 1, end: 30 },
      { surah: 68, nama: "Al-Qalam", totalAyat: 52, start: 1, end: 52 },
      { surah: 69, nama: "Al-Haqqah", totalAyat: 52, start: 1, end: 52 },
      { surah: 70, nama: "Al-Ma'arij", totalAyat: 44, start: 1, end: 44 },
      { surah: 71, nama: "Nuh", totalAyat: 28, start: 1, end: 28 },
      { surah: 72, nama: "Al-Jinn", totalAyat: 28, start: 1, end: 28 },
      { surah: 73, nama: "Al-Muzzammil", totalAyat: 20, start: 1, end: 20 },
      { surah: 74, nama: "Al-Muddassir", totalAyat: 56, start: 1, end: 56 },
      { surah: 75, nama: "Al-Qiyamah", totalAyat: 40, start: 1, end: 40 },
      { surah: 76, nama: "Al-Insan", totalAyat: 31, start: 1, end: 31 },
      { surah: 77, nama: "Al-Mursalat", totalAyat: 50, start: 1, end: 50 }
    ]
  },
  30: {
    totalAyat: 564,
    contents: [
      { surah: 78, nama: "An-Naba'", totalAyat: 40, start: 1, end: 40 },
      { surah: 79, nama: "An-Nazi'at", totalAyat: 46, start: 1, end: 46 },
      { surah: 80, nama: "'Abasa", totalAyat: 42, start: 1, end: 42 },
      { surah: 81, nama: "At-Takwir", totalAyat: 29, start: 1, end: 29 },
      { surah: 82, nama: "Al-Infithar", totalAyat: 19, start: 1, end: 19 },
      { surah: 83, nama: "Al-Muthaffifin", totalAyat: 36, start: 1, end: 36 },
      { surah: 84, nama: "Al-Insyiqaq", totalAyat: 25, start: 1, end: 25 },
      { surah: 85, nama: "Al-Buruj", totalAyat: 22, start: 1, end: 22 },
      { surah: 86, nama: "Ath-Thariq", totalAyat: 17, start: 1, end: 17 },
      { surah: 87, nama: "Al-A'la", totalAyat: 19, start: 1, end: 19 },
      { surah: 88, nama: "Al-Ghasyiyah", totalAyat: 26, start: 1, end: 26 },
      { surah: 89, nama: "Al-Fajr", totalAyat: 30, start: 1, end: 30 },
      { surah: 90, nama: "Al-Balad", totalAyat: 20, start: 1, end: 20 },
      { surah: 91, nama: "Asy-Syams", totalAyat: 15, start: 1, end: 15 },
      { surah: 92, nama: "Al-Lail", totalAyat: 21, start: 1, end: 21 },
      { surah: 93, nama: "Adh-Dhuha", totalAyat: 11, start: 1, end: 11 },
      { surah: 94, nama: "Asy-Syarh", totalAyat: 8, start: 1, end: 8 },
      { surah: 95, nama: "At-Tin", totalAyat: 8, start: 1, end: 8 },
      { surah: 96, nama: "Al-'Alaq", totalAyat: 19, start: 1, end: 19 },
      { surah: 97, nama: "Al-Qadr", totalAyat: 5, start: 1, end: 5 },
      { surah: 98, nama: "Al-Bayyinah", totalAyat: 8, start: 1, end: 8 },
      { surah: 99, nama: "Az-Zalzalah", totalAyat: 8, start: 1, end: 8 },
      { surah: 100, nama: "Al-'Adiyat", totalAyat: 11, start: 1, end: 11 },
      { surah: 101, nama: "Al-Qari'ah", totalAyat: 11, start: 1, end: 11 },
      { surah: 102, nama: "At-Takatsur", totalAyat: 8, start: 1, end: 8 },
      { surah: 103, nama: "Al-'Ashr", totalAyat: 3, start: 1, end: 3 },
      { surah: 104, nama: "Al-Humazah", totalAyat: 9, start: 1, end: 9 },
      { surah: 105, nama: "Al-Fil", totalAyat: 5, start: 1, end: 5 },
      { surah: 106, nama: "Quraisy", totalAyat: 4, start: 1, end: 4 },
      { surah: 107, nama: "Al-Ma'un", totalAyat: 7, start: 1, end: 7 },
      { surah: 108, nama: "Al-Kautsar", totalAyat: 3, start: 1, end: 3 },
      { surah: 109, nama: "Al-Kafirun", totalAyat: 6, start: 1, end: 6 },
      { surah: 110, nama: "An-Nashr", totalAyat: 3, start: 1, end: 3 },
      { surah: 111, nama: "Al-Lahab", totalAyat: 5, start: 1, end: 5 },
      { surah: 112, nama: "Al-Ikhlas", totalAyat: 4, start: 1, end: 4 },
      { surah: 113, nama: "Al-Falaq", totalAyat: 5, start: 1, end: 5 },
      { surah: 114, nama: "An-Nas", totalAyat: 6, start: 1, end: 6 }
    ]
  }
};
	
			let selectedFundraisingFile = null; // Variabel untuk menyimpan file gambar yang dipilih
// === TAMBAHKAN BLOK KODE INI DI BAGIAN ATAS SCRIPT ANDA ===
    

    const ui = { messageBox: document.getElementById('messageBox'), donasiModal: document.getElementById("donasiModal"), donasiBtn: document.getElementById("donasiBtn"), loginButton: document.getElementById('loginButton'), userProfile: document.getElementById('userProfile'), userProfileName: document.getElementById('userProfileName'), navProfilePic: document.getElementById('navProfilePic'), attendanceNav: document.getElementById('attendanceNav'), sistemInformasiNav: document.getElementById('sistemInformasiNav'), kalenderPendidikan: document.getElementById('kalenderPendidikanSection'), marqueeContainer: document.getElementById('marquee-container'), marqueeText: document.getElementById('marquee-text'), dynamicCalendarGrid: document.getElementById('dynamic-calendar-grid'), slideshowContainer: document.getElementById('slideshow') };
    const namaBulanHijriah = ["Muharram", "Safar", "Rabi'ul Awal", "Rabi'ul Akhir", "Jumadil Awal", "Jumadil Akhir", "Rajab", "Sya'ban", "Ramadhan", "Syawwal", "Dzulqa'dah", "Dzulhijjah"];
	const ZONA_WAKTU_OFFSET_JAM = 7;
	let appState = {
        activeMonthKey: 'bulan1', // Kunci untuk mengakses data di appData.schedules
        filters: {
            group: 'all',
            cluster: 'all',
            teacher: 'all',
            room: 'all'
        },
        // Data yang sudah diproses akan disimpan di sini
       processedSchedules: {}
    };
	
	let userTips = [];
let tipInterval = null;
let currentTipIndex = 0;
	
	
    /**
     * Mengambil daftar santri lengkap dengan username mereka dari server.
     * Menggunakan sistem cache sederhana untuk menghindari permintaan berulang.
     * @returns {Promise<Array>} Array berisi objek data santri.
     */
    async function getSantriDataWithUsernames() {
        // Jika data sudah ada di cache, langsung kembalikan
        if (santriDataWithUsernames) {
            return santriDataWithUsernames;
        }
        
        // Jika belum ada, ambil dari server
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getSantriListWithUsernames' }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.status === 'success' && result.santri) {
                santriDataWithUsernames = result.santri; // Simpan hasil ke cache
                return santriDataWithUsernames;
            } else {
                throw new Error(result.message || 'Gagal mengambil daftar santri dari server.');
            }
        } catch (error) {
            console.error("Error fetching santri list with usernames:", error);
            // Lemparkan error agar bisa ditangani oleh fungsi yang memanggilnya
            throw error;
        }
    }
    // ==========================================================

// FUNGSI BARU UNTUK HALAMAN LIHAT NILAI
async function setupLihatNilaiPage() {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;

    const materiSelect = document.getElementById('guru-nilai-materi-select');
    const nilaiContainer = document.getElementById('guru-nilai-container');

    // 1. Ambil daftar materi yang diajar guru
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getSoalUntukGuru', namaGuru: session.userData.profileName }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        materiSelect.innerHTML = '<option value="">-- Pilih Materi --</option>';
        for (const kode in result.materi) {
            const subjectData = Object.values(appState.processedSchedules).flat().find(item => item.subject.startsWith(kode));
            const namaLengkapMateri = subjectData ? subjectData.subject : kode;
            const option = document.createElement('option');
            option.value = kode;
            option.textContent = namaLengkapMateri;
            materiSelect.appendChild(option);
        }
    } catch (error) {
        materiSelect.innerHTML = `<option value="">Gagal memuat materi</option>`;
        console.error(error);
    }

    // 2. Tambahkan event listener untuk menampilkan nilai saat materi dipilih
    materiSelect.addEventListener('change', async (e) => {
        const kodeMateri = e.target.value;
        if (!kodeMateri) {
            nilaiContainer.innerHTML = '<p class="p-8 text-center text-gray-400">Silakan pilih materi.</p>';
            return;
        }

        nilaiContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Mengambil data nilai...</p>';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getScoresBySubject', kodeMateri: kodeMateri }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            if (result.scores.length === 0) {
                nilaiContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Belum ada santri yang mengerjakan ujian ini.</p>';
                return;
            }

            // 3. Buat dan tampilkan tabel nilai
            // 3. Buat dan tampilkan tabel nilai
let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
        <tr>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Nama Santri</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Skor Ujian</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Poin Tugas</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Nilai KHS</th>
            <th class="px-4 py-2 text-center text-xs font-medium text-gray-500 uppercase">Jml. Coba</th>
        </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">`;

result.scores.forEach((item, index) => {
    // Lakukan perhitungan di frontend
    const skorUjian = parseFloat(item.skorAkhir) || 0;
    const poinTugas = 0.08 * (parseFloat(item.totalNilaiTugas) || 0);
    const nilaiKHS = Math.min(100, skorUjian + poinTugas);
	const poinTugasBulat = Math.ceil(poinTugas);
    const nilaiKHSBulat = Math.ceil(nilaiKHS);
	
    tableHTML += `
        <tr>
            <td class="px-4 py-3">${index + 1}</td>
            <td class="px-4 py-3 font-medium">${item.namaSantri}</td>
            <td class="px-4 py-3 text-center">${skorUjian}</td>
            <td class="px-4 py-3 text-center text-blue-600">+${poinTugasBulat}</td>
            <td class="px-4 py-3 text-center font-bold ${nilaiKHSBulat >= 75 ? 'text-green-600' : 'text-red-600'}">${nilaiKHSBulat}</td>
            <td class="px-4 py-3 text-center">${item.percobaan}</td>
        </tr>
    `;
});

tableHTML += `</tbody></table>`;
nilaiContainer.innerHTML = tableHTML;

        } catch (error) {
            nilaiContainer.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat nilai: ${error.message}</p>`;
        }
    });
}

// GANTI TOTAL FUNGSI LAMA DENGAN VERSI FINAL INI
async function renderFundraisingCards(session) {
    const section = document.getElementById('fundraising');
    const container = document.getElementById('fundraising-container');
    if (!container || !section) return;

    const isAdmin = session && session.loggedIn && ['mia', 'wawan', 'admin'].includes(session.username);

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getFundraisingCampaigns' }) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        const campaigns = result.data;
        if (campaigns.length === 0) {
            section.classList.add('hidden');
            return;
        }

        container.innerHTML = '';
        campaigns.forEach(item => {
            const itemDataString = JSON.stringify(item);
            const cardWrapper = document.createElement('div');
            cardWrapper.className = 'relative';

            let editButtonHtml = isAdmin ? `<button class="btn-edit-fundraising absolute top-2 left-2 bg-yellow-500 hover:bg-yellow-600 text-white text-xs font-bold py-1 px-3 rounded-full z-10" data-campaign='${itemDataString}'>Edit</button>` : '';

            const now = new Date();
            const deadline = new Date(item.Deadline);
            const daysLeft = Math.ceil((deadline - now) / (1000 * 60 * 60 * 24));
            const progressPercent = Math.min((item.DanaMasuk / item.DanaDibutuhkan) * 100, 100);
            let deadlineText = daysLeft > 0 ? `${daysLeft} hari lagi` : (daysLeft <= 0 ? 'Berakhir' : 'Selesai');

            cardWrapper.innerHTML = `
                ${editButtonHtml}
                <a href="donasi.html?id=${item.ID}" class="fundraising-card">
                    <div class="image-container"><img src="${item.GambarUtama}" alt="${item.Judul}"><div class="deadline-badge">${deadlineText}</div></div>
                    <div class="card-body">
                        <p class="organizer-info">${item.Pembuat}</p>
                        <h3>${item.Judul}</h3>
                        <p class="progress-info">Terkumpul <span class="amount">Rp${item.DanaMasuk.toLocaleString('id-ID')}</span> dari Rp${item.DanaDibutuhkan.toLocaleString('id-ID')}</p>
                        <div class="progress-bar-bg"><div class="progress-bar-fill" style="width: ${progressPercent}%;"></div></div>
                    </div>
                </a>`;
            container.appendChild(cardWrapper);
        });

        // --- LOGIKA TOMBOL EDIT DIPINDAHKAN KE SINI ---
        container.querySelectorAll('.btn-edit-fundraising').forEach(button => {
            button.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();

                const campaignData = JSON.parse(button.dataset.campaign);
                const modal = document.getElementById('fundraising-modal');

                modal.querySelector('#form-title').textContent = 'Edit Penggalangan Dana';
                modal.querySelector('#input-fund-id').value = campaignData.ID;
                modal.querySelector('#input-fund-title').value = campaignData.Judul;
                modal.querySelector('#input-fund-goal').value = campaignData.DanaDibutuhkan;
                modal.querySelector('#input-fund-deadline').value = new Date(campaignData.Deadline).toISOString().split('T')[0];
                modal.querySelector('#input-fund-image-file').value = '';
                modal.querySelector('#fundraising-image-preview').src = campaignData.GambarUtama;
                modal.querySelector('#input-fund-desc').value = campaignData.DeskripsiHTML;

                modal.style.display = 'block';
            });
        });

    } catch (error) {
        console.error("Gagal memuat data penggalangan dana:", error);
        section.classList.add('hidden');
    }
}

// TAMBAHKAN FUNGSI BARU INI DI DALAM <script>
// GANTI SELURUH FUNGSI INI
async function handleFundraisingSubmit(event) {
    event.preventDefault();
    showLoading();

    const session = getActiveSession();
    const campaignId = document.getElementById('input-fund-id').value;

    // Tentukan aksi: jika ada ID, maka 'update', jika tidak maka 'create'
    const action = campaignId ? 'updateFundraisingCampaign' : 'createFundraisingCampaign';

    const data = {
        action: action,
        ID: campaignId, // Akan kosong jika membuat baru
        Judul: document.getElementById('input-fund-title').value,
        Pembuat: session.userData.profileName,
        DanaDibutuhkan: document.getElementById('input-fund-goal').value,
        Deadline: document.getElementById('input-fund-deadline').value,
        
        DeskripsiHTML: document.getElementById('input-fund-desc').value,
        // Status hanya relevan saat membuat baru, di backend tidak akan diubah saat update
        Status: "Aktif" 
    };

    // Jika tidak ada file gambar baru yang dipilih saat edit, jangan kirim properti GambarUtama
    // Ini agar backend tidak menimpa gambar yang sudah ada dengan string kosong.
    if (action === 'updateFundraisingCampaign' && !selectedFundraisingFile) {
        delete data.GambarUtama;
    }

    // Logika upload gambar (jika ada file baru dipilih)
    if (selectedFundraisingFile) {
        try {
            const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280 };
            const compressedFile = await imageCompression(selectedFundraisingFile, options);

            const formData = new FormData();
            formData.append('file', compressedFile, selectedFundraisingFile.name);
            formData.append('upload_preset', 'markaz');

            const cloudinaryResponse = await fetch(CONFIG.CLOUDINARY_URL, { method: 'POST', body: formData });
            if (!cloudinaryResponse.ok) throw new Error('Gagal mengunggah gambar.');

            const cloudinaryData = await cloudinaryResponse.json();
            data.GambarUtama = cloudinaryData.secure_url;

        } catch (error) {
            showMessage(`Error pada gambar: ${error.message}`, 'error');
            hideLoading();
            return;
        }
    }

    // Kirim data ke backend
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        showMessage(result.message || `Penggalangan dana berhasil ${action === 'updateFundraisingCampaign' ? 'diperbarui' : 'dibuat'}!`, 'success');
        document.getElementById('fundraising-modal').style.display = 'none';
        document.getElementById('form-fundraising').reset();

        // Reset file input & pratinjau
        selectedFundraisingFile = null;
        document.getElementById('fundraising-image-preview').src = 'https://placehold.co/400x200/e9ecef/6c757d?text=Pilih+Gambar';

        renderFundraisingCards(session);
    } catch (error) {
        showMessage(`Gagal menyimpan: ${error.message}`, 'error');
    } finally {
        hideLoading();
    }
}
/**
 * FUNGSI PENCARIAN BARU (PENGGANTI getAcademicMonthForDate)
 * Mencari tanggal yang diberikan di dalam daftar rentang bulan akademik.
 * @param {string} referenceDateStr - Tanggal dalam format YYYY-MM-DD.
 * @returns {number} Nomor bulan yang aktif.
 */
// HAPUS FUNGSI LAMA, GUNAKAN HANYA YANG INI
function findAcademicMonthForDate(referenceDateStr) {
    // Pengecekan keamanan jika referenceDateStr kosong atau tidak valid
    if (!referenceDateStr || !referenceDateStr.includes('-')) {
        console.error("Tanggal referensi tidak valid:", referenceDateStr);
        return 0; // Kembalikan nilai default jika tanggal tidak valid
    }
    const refParts = referenceDateStr.split('-');
    const referenceDate = new Date(refParts[0], refParts[1] - 1, refParts[2]);
    
    // Pastikan academicMonthRanges sudah terisi
    if (academicMonthRanges.length === 0) {
        console.error("Error: Data rentang bulan akademik (academicMonthRanges) kosong.");
        return 0;
    }

    const foundRange = academicMonthRanges.find(range => 
        referenceDate >= range.start && referenceDate <= range.end
    );

    const currentMonth = foundRange ? foundRange.month : 0;
    console.log(`Pengecekan untuk tanggal: ${referenceDate.toDateString()}. Bulan akademik terdeteksi: Bulan ${currentMonth}`);
    return currentMonth;
}


    const appData = {
        heroImages: ["anakdidik.jpg", "anakdidik01.jpg", "anakdidik02.jpg", "anakdidik03.jpg", "anakdidik04.jpg"],
        news: [
		{ img: 'https://placehold.co/400x200/28a745/FFFFFF?text=Penerimaan+Santri', title: 'Penerimaan Santri Baru Telah Dibuka!', meta: '30 Juli 2025 | Pendidikan', desc: 'Pendaftaran santri baru untuk program Tahfidz di Markaz Qur\'an Al-Maa\'un telah resmi dibuka.' },
		{ img: 'https://placehold.co/400x200/17a2b8/FFFFFF?text=Santunan+Yatim', title: 'Santunan Rutin Anak Yatim', meta: '25 Juli 2025 | Sosial', desc: 'Kegiatan santunan bulanan untuk anak-anak yatim binaan Rumah Anak Yatim Abu Darda.' },
		{
            type: 'youtube_playlist', // Penanda khusus untuk playlist
            title: 'Kajian Umum Pilihan',
			meta: '25 Agustus 2025 | Kajian', desc: 'Ada 20 Video Kajian Pilihan yang bisa ditonton.',
            embedUrl: 'https://www.youtube.com/embed/vgB8YouGb_M?list=PLCkk8QVJzkuQBH-p2kHcTTG_4gzibc93v',
			
        }],
        gallery: [{ img: 'https://placehold.co/400x250/6f42c1/FFFFFF?text=Halaqah+Tahfidz', title: 'Halaqah Tahfidz Pagi', desc: 'Para santri sedang menyetorkan hafalan Al-Qur\'an kepada Musyrif.' }, { img: 'https://placehold.co/400x250/fd7e14/FFFFFF?text=Buka+Puasa+Bersama', title: 'Buka Puasa Bersama', desc: 'Kegiatan buka puasa bersama anak-anak yatim dan dhuafa di bulan Ramadhan.' }, { img: 'https://placehold.co/400x250/20c997/FFFFFF?text=Penyaluran+Bantuan', title: 'Penyaluran Bantuan', desc: 'Distribusi bantuan sembako dari para donatur kepada masyarakat sekitar.' }],
        fundraising: [
        {
            img: 'https://images.unsplash.com/photo-1593113646773-ae18c6422d75?q=80&w=2070&auto=format&fit=crop', // Ganti dengan URL gambar Anda
            deadline: '2025-12-31', // Format: YYYY-MM-DD
            organizer: 'Penghubung Kebaikan',
            title: 'Hadiahkan Suara: Donasi Alat Bantu Dengar',
            current: 27614492,
            goal: 50000000 
        },
        {
            img: 'https://images.unsplash.com/photo-1532629345422-7515f3d16bb6?q=80&w=2070&auto=format&fit=crop', // Ganti dengan URL gambar Anda
            deadline: '2025-09-25', // Format: YYYY-MM-DD
            organizer: 'Yana Sutisna',
            title: 'Diintai Gizi Buruk & Gagal Hati, Bantu Rafasha!',
            current: 25950330,
            goal: 40000000
        }
        // Anda bisa menambahkan item penggalangan dana lainnya di sini
    ],
	
	
	
	calendarEvents: [
            // --- Semester Ganjil 2025 ---
            { date: "2025-07-7", title: "Pengenalan Lingkungan Madrasah", color: "event-lightgreen", span: 3 }, 
			{ date: "2025-07-14", title: "Awal Materi Bulan I", color: "event-green" },
            //{ date: "2025-08-11", title: "Awal Ujian Bulanan I", color: "event-lightblue" },
            { date: "2025-08-17", title: "Hari Kemerdekaan RI", color: "holiday" },
            { date: "2025-08-18", title: "Libur Nasional", color: "holiday" },
            { date: "2025-08-19", title: "Awal Materi Bulan II", color: "event-green" },
            { date: "2025-09-05", title: "Maulid Nabi Muhammad ï·º", color: "holiday" },
            { date: "2025-09-15", title: "Awal Ujian UTS Ganjil", color: "event-lightblue", },
            { date: "2025-09-22", title: "Awal Materi Bulan III", color: "event-green" },
            //{ date: "2025-10-20", title: "Awal Ujian Bulanan III", color: "event-lightblue", },
            { date: "2025-10-20", title: "Awal Materi Bulan IV", color: "event-green" },
			{ date: "2025-11-17", title: "Pekan Santai (pemberian kisi-kisi)", color: "event-darkblue", span: 6 },
            { date: "2025-11-24", title: "Awal Ujian UAS Ganjil", color: "event-lightblue", },
            { date: "2025-12-01", title: "Penilaian Akhir Semester (PAS)", color: "event-darkblue", span: 6 },
			{ date: "2025-12-8", title: "Pekan Olahraga", color: "event-purple", span: 6},
            { date: "2025-12-13", title: "Penerimaan Rapor", color: "event-darkblue" },
			{ date: "2025-12-15", title: "Libur (Kegiatan Rumah Yatim)", color: "event-purple", span: 6},
            { date: "2025-12-22", title: "Libur Akhir Semester Ganjil (Pulang)", color: "event-orange", span: 6 },
            { date: "2025-12-29", title: "Awal Materi Bulan V", color: "event-green" },

            // --- Semester Genap 2026 ---
            { date: "2026-01-01", title: "Tahun Baru Masehi 2026", color: "holiday" },
            { date: "2026-01-26", title: "Isra Mi'raj Nabi Muhammad ï·º", color: "holiday" },
            //{ date: "2026-01-27", title: "Awal Ujian Bulanan V", color: "event-lightblue",  },
            //{ date: "2026-02-02", title: "Awal Materi Bulan VI", color: "event-green" },
			{ date: "2026-02-26", title: "Awal Puasa Ramadan 1447 H", color: "holiday" },
            { date: "2026-03-02", title: "Awal Ujian UTS Genap", color: "event-lightblue", },
            { date: "2026-03-09", title: "Awal Materi Bulan VI", color: "event-green" },
            { date: "2026-03-23", title: "Libur Ramadan & Idul Fitri", color: "event-yellow", span: 13 },
			{ date: "2026-03-28", title: "Hari Raya Idul Fitri 1447 H", color: "holiday", span: 2 },
            //{ date: "2026-04-20", title: "Awal Ujian Bulanan VII", color: "event-lightblue", },
            //{ date: "2026-04-27", title: "Awal Materi Bulan VIII", color: "event-green" },
            { date: "2026-05-01", title: "Hari Buruh Internasional", color: "holiday" },
            { date: "2026-05-18", title: "Awal Ujian UAS Genap", color: "event-lightblue", },
            { date: "2026-06-01", title: "Hari Lahir Pancasila", color: "holiday" },
            { date: "2026-06-01", title: "Penilaian Akhir Tahun (PAT)", color: "event-darkblue", span: 12 },
            { date: "2026-06-04", title: "Hari Raya Idul Adha 1447 H", color: "holiday" },
            { date: "2026-06-13", title: "Penerimaan Rapor", color: "event-darkblue" },
            { date: "2026-06-14", title: "Tahun Baru Islam 1448 H", color: "holiday" },
			{ date: "2026-06-15", title: "Pekan Olahraga", color: "event-purple", span: 6},
            { date: "2026-06-29", title: "Libur Akhir Tahun", color: "event-orange", span: 6 }
        ],
		santriMusyrif: ["Abdullah Ridho Selamet", "Ahmad Royyan", "Ahsin Lutfaka", "Ibrahim", "M. Alvin Ramadhan Lubis", "Rizki Fadilla", "Yasir Al-Fath"].sort(),
		santriMusyrifah: ["Aisyah Az-Zahra", "Aisyah Nur Fadilla", "Annisa Akbar Siregar", "Aprilia Alvani Rikay", "Aprilia Alvana Rikay", "Dedek Suci Ramadhani", "Dira Adiana Putri", "Hadzira Inayah Safa", "Intan Akbar Siregar", "Nur Alfia Fauzana", "Nur Halimah", "Putri Maharani Br. Tarigan", "Rahmah Azizah Lubis", "Rara Azahra", "Suci Agus Anggira", "Zaenab"].sort(),
        santri: [ { id: 1, nama: "Ahmad Royyan", gender: "Laki-Laki", grup: "KG LKS", kelas: "XII", jurusan: "Bisnis & Manajemen" }, { id: 2, nama: "M. Alvin Ramadhan Lubis", gender: "Laki-Laki", grup: "KF", kelas: "X", jurusan: "Non Jurusan" }, { id: 3, nama: "Abdullah Ridho Selamet", gender: "Laki-Laki", grup: "KG LKS", kelas: "X", jurusan: "Bisnis & Manajemen" }, { id: 4, nama: "Rizki Fadilah", gender: "Laki-Laki", grup: "KF", kelas: "VIII", jurusan: "Non Jurusan" }, { id: 5, nama: "Annisa Akbar Siregar", gender: "Perempuan", grup: "KG STT", kelas: "XII", jurusan: "Agribisnis (Pertanian & Peternakan)" }, { id: 6, nama: "Intan Akbar Siregar", gender: "Perempuan", grup: "KG STT", kelas: "IX", jurusan: "Sains & Teknologi" }, { id: 7, nama: "Aprilia Alvana Rikay", gender: "Perempuan", grup: "KG LKS", kelas: "X", jurusan: "Pendidikan Agama Islam" }, { id: 8, nama: "Aprilia Alvani Rikay", gender: "Perempuan", grup: "KG LKS", kelas: "X", jurusan: "Pendidikan Agama Islam" }, { id: 9, nama: "Rahmah Azizah Lubis", gender: "Perempuan", grup: "KG LKS", kelas: "XI", jurusan: "Tahfidz & Bahasa Arab" }, { id: 10, nama: "Aisyah Az-Zahra", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Tahfidz & Bahasa Arab" }, { id: 11, nama: "Nur Halimah", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Tahfidz & Bahasa Arab" }, { id: 12, nama: "Nur Alfia Fauzana", gender: "Perempuan", grup: "KG LKS", kelas: "VIII", jurusan: "Pendidikan Agama Islam" }, { id: 13, nama: "Putri Maharani Br. Tarigan", gender: "Perempuan", grup: "KF", kelas: "VIII", jurusan: "Non Jurusan" }, { id: 14, nama: "Dedek Suci Ramadhani", gender: "Perempuan", grup: "KF", kelas: "VII", jurusan: "Non Jurusan" }, { id: 15, nama: "Aisyah Nur Fadillah", gender: "Perempuan", grup: "KF", kelas: "VII", jurusan: "Non Jurusan" } ],
        teachers: [ 
            { no: 1, name: "Sulistiawan, S.Kom", username: "wawan", major: "Pelajaran Umum & Keterampilan", hari: "Semua hari & jam", schedule: "Guru Cadangan" }, 
            { no: 2, name: "Zhofri F. Majdi, S.Sos", username: "zhofri", major: "Diniyah", hari: "Kamis, Jumat, Sabtu", schedule: "Kamis (08-10), Jumat & Sabtu (Semua Jam)" }, 
            { no: 3, name: "M. Ryza Anshori, S.Pd", username: "ryza", major: "Diniyah", hari: "Jumat", schedule: "Semua Jam" }, 
            { no: 4, name: "Erwan SyahPutra, S.Pd", username: "erwan", major: "Diniyah", hari: "Selasa, Rabu, Sabtu", schedule: "Selasa (Semua Jam), Rabu & Sabtu (sampai 10.00)" }, 
            { no: 5, name: "Ariyanti R. Siregar, S.Kom", username: "yanti", major: "Pelajaran Umum", hari: "Senin, Rabu, Kamis", schedule: "12.45 - 14.15" }, 
            { no: 6, name: "Mia A. Lubis, S.Kom", username: "mia", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "10.00 - 12.15 (Guru Cadangan)" }, 
            { no: 7, name: "Mahadi Sentosa, S.Sos", username: "mahadi", major: "Diniyah", hari: "Sabtu", schedule: "13.00-14.30" }, 
            { no: 8, name: "Suprasojo, S.Pd.I., M.Pd.", username: "suprasojo", major: "Diniyah", hari: "Senin, Rabu", schedule: "8.00-11.30" }, 
            { no: 9, name: "Aria Atmaja", username: "aria", major: "Teknik Mekanik Elektronik", hari: "Rabu", schedule: "08:00-09:30" } 
        ],
        schedules: {
            bulan1: [
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & KPK/FPB", teacher: "Sulistiawan, S.Kom", downloadLink: "https://url-penyimpanan-anda.com/modul/MAT-101.pdf" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-101: Menyimak Efektif: Adab & Teknik", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1PAGwVSmVj3_JFW6mekxZGK7xZh54XlDH/view?usp=drive_link" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-201: Pengantar Thibbun Nabawi", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ZjmZkzVknCL8sNPz4nWwaARTN62AN1qG/view" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-101: Greetings & Introductions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1LYRMv43xr0ei9aHJ4Rm8VVGEZv2LMoJT/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-201: Riset Pasar & Analisis Kompetitor", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ibVSjYmLhxxAhmAm_EGJ-qowFDPy3aZ_/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-101: ABY Jilid 1A Unit 1-2 (Perkenalan & Keluarga)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1KNuZMEsYPEznGzEcyhTR5GDb5J3gUwM5/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "PANC-201: Implementasi nilai-nilai Pancasila Dalam Kehidupan", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1V0ZYiN9sYr5ZYXR3yfk5p80uLFNlbv9g/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-201: ABY Jilid 1B Unit 7-8 (Pendidikan & Pekerjaan)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/19dfcrahHUBSjFQx0bNvcGDxm2gJw35Tt/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-101: Pertolongan Pertama Pada Kecelakaan (P3K)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1X7OG1Z2rdwVPn4B8VqZM--wV7zDddOFw/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-101: Makna & Konsekuensi 2 Kalimat Syahadat", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/11yClAXt_5YcDrzyZ9-Ee4fJOSIwGQWcK/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-201: Gerak Lurus dan Gaya", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/170mKM_vLYEeO0tIUOP063-k1wMW1a1jD/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-201: Pengantar Ilmu Hadits (Definisi & Sejarah)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1b839aBuE0qPkPX5TISgiloV3qGljV2EF/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-101: Pengantar Mindset Wirausaha Muslim", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1OY6JWCfKPjxgKECTDUoWadrY_eoMMdCj/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-201: Pengenalan Alat-Alat Servis", teacher: "Aria Atmaja", downloadLink: "https://drive.google.com/file/d/1tgiZzRH8P-WWtoNdtRWkJW8qGDBcrU8b/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-101: Aku & Lingkungan Sekitarku", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1FlPhTpeWb9ARmQRa8g-dV74_tabkmwFI/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-201: Public Speaking 1: Struktur Pidato & Mengatasi Gugup", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/1HlMC_lIGb7L9rDr2MocXm3VCMP6uqyeg/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-201: Hobbies & Free Time", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/15-9a1S4ogBTjKjG6i2_268-tLqrquC4P/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-101: Hadits Arba'in 1 (Hafalan & Makna Hadits #1-5)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1pND30uoMlg5Dqyzm5C4_Yl27_H5LXHh9/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-101: Pengenalan Perangkat Keras & Lunak Komputer", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1JTJjRA_rWZ-62_W82aBKL23b2K0244bL/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-201: Studi Kitab Tauhid 1", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1WoluRi1U0edST8BBaqPkLNiEIZLCPwvt/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-201: Pengolah Kata (Word) Lanjutan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1KzWoTzH_VqgVjd-0Sc3z9Xmwz7Z19TSX/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-201: Masuk dan Berkembangnya Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1X0S3XBjJEdEkKCGAUjcDze8Kfh2MWjuG/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-101: Ciri Makhluk Hidup & Klasifikasi Sederhana", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1x-u8VWwCD2KJW16-wG0z_ZBrmbAb4Lpf/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-201: Sejarah Penulisan & Pengumpulan Al-Qur'an", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1b_WMo_1KKAWPXKzilPSKsFzNzUmdW4V8/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-101: Wudhu & Tayammum", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1ZLRZNGtttzsv0KQ7E9S2vezp3ma5vfwE/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-201: Tanda-tanda I'rab untuk Isim", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1WX-53Q4hY5gvzAVbKsEjLHKACWgKo1K1/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-101: Kondisi Dunia Sebelum Kenabian & Masa Kecil Nabi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1uULQr6lFC2YylJ4ZdcktlUXbgKEPzdp-/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-101: Pengantar Ilmu Balaghah", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1UyC0-W-l-Xfli8SSvpMcihgiuFc1zYS0/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-201: Tafsir & Tadabbur Surat Al-Maa'un & Al-Kafirun", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1uy5pOjhibrZbLUOUfRJHNKtqV4AT6obY/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-101: Adab Kepada Allah", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1bXBq9UzfDsnIxEnh1cMHZchqlEHB8etK/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-101: Tafsir & Tadabbur Surat Al-Fatihah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1XyXIN1bsnIKVeGX3_H9MkaGlgrB2dhCu/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-201: Membaca 3 (Membedakan Fakta & Opini dalam Teks)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/12D_Sk1hB2q5e3BdNX1-Iw8kIjTrm6UId/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-201: Peristiwa Boikot & Wafatnya Khadijah dan Abu Thalib", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1vJCQq48tCQNX_S5X8NF3DqTE9weOhGse/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-101: Pengenalan Kalimat (Jumlah Mufidah) & Jenis Kata", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "https://drive.google.com/file/d/1kbTKODSzvge5WUbkRA5wpf3SJl8WVXci/view?usp=drive_link" },
					
 { day: "Senin", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Selasa", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Rabu", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Kamis", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
 { day: "Jumat", time: "08:00-11:30", sks: 2, room: "Kelas SD", group: "SD", cluster: "", subject: "KELAS SD", teacher: "Reza Frananda", downloadLink: "" },
                ],
                bulan2: [
                    // DIUBAH: MAT-102 ditukar dengan KWU-102, kemudian KWU-102 ditukar dengan IND-102. Hasil akhirnya IND-102 di posisi ini.
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-102: Berbicara 1: Perkenalan Diri & Sapaan Santun", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/12C3tX82DIS6BqYBt2DdKlvCRKTgNzX8Y/view?usp=drive_link" },
                    { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-102: Pecahan & Desimal", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/14mAyOGGZXxbiC0OM9lUWFkY3xzkpDCD2/view?usp=drive_link" },
                    // DIUBAH: Hasil akhir dari pertukaran posisi KWU-102 ada di sini.
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "KWU-102: Dasar-dasar Produk Halal & Thayyib", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1RAq8tygsge8GoCBrhn21gnHbDnu4pbZy/view?usp=drive_link" },
                    { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-202: Adab kepada Orang Tua & Guru (Gabungan)", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/1k_P5RN0TS25K_3K3yc4yMNGsOj1qOtE2/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-102: Classroom Objects & Instructions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1q2btB5Fv1-ifXl9n7tOLT9bk1CmpsMYt/view?usp=drive_link" },
                    { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-202: Validasi Ide & Model Bisnis Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1rR-udDxso8F9x2pExZTfemJoiZQDknDn/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-102: ABY Jilid 1A: Unit 3-4 (Tempat Tinggal & Kehidupan Harian)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1_YO9Z4NlH6JjtycqQCZC7i26IZdS_K3M/view?usp=drive_link" },
                    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-202: Hifzhu Shihhah (Pola Hidup Sehat Rasulullah ï·º)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/10qcUn-Ycfqfw03SiS2F2zZg8TbGHu4_E/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-202: ABY Jilid 1B: Unit 9-10 (Berbelanja & Cuaca)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/14EF5H4lZaA-Kx4WHvIqL3_WxDNhtEj3F/view?usp=drive_link" },
                    { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-102: Manajemen Kesehatan Dasar & Penyakit Umum", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1ROzqQ6HtB3t4UwQLVuGGZBwE6uZO8_Zc/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-102: Studi Kitab Tauhid 1", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1qjYbEFYXgoJa5oBrE8-D3-8XcpML3qfc/view?usp=drive_link" },
                    { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-202: Sistem Gerak pada Manusia (Rangka & Sendi)", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/16GiZXYA0pLnivjI-AgZxa0cs1bm5onLt/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-202: Klasifikasi Hadits (Shahih, Hasan, Dha'if)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/15Wdnf8x9oqPhjhurjqJC8eEN5VlG51uY/view?usp=drive_link" },
                    // DIUBAH: MAT-102 sekarang di sini dengan guru baru.
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "MAT-102: Pecahan & Desimal", teacher: "Suprasojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/14mAyOGGZXxbiC0OM9lUWFkY3xzkpDCD2/view?usp=drive_link" },
                    { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-202: Praktik Menggunakan Alat Tangan & Solder", teacher: "Aria Atmaja", downloadLink: "https://drive.google.com/file/d/1g6ZMvLvlZz5ML1wFJla4tEsd8Thi6ixr/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-102: Kebutuhan Manusia & Ekonomi Dasar", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1X1TZ0rn3LEjpuGPitnEuwU3_4LVC307_/view?usp=drive_link" },
                    { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-202: Public Speaking 2: Teknik Vokal & Bahasa Tubuh", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "https://drive.google.com/file/d/15A_dulFxCo0C-KfJI8SwDUJ8JHC9chNp/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-202: Food & Drinks", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1tfAqtezxc2QjgaPf8DRrwEFKgsg6FRN9/view?usp=drive_link" },
                    { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-102: Hadits Arba'in 2 (Hafalan & Makna Hadits #6-10)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1XJ9TQok3F0kbpDwCI7tp3h16GqeSL6ST/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-102: Sistem Operasi & Manajemen File Dasar", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1Hvgbz7Feoo77Y9sN623wZBWTI0rGUBr0/view?usp=drive_link" },
                    { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-202: Studi Kitab Tauhid 2", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/17YsFPW2yfT7vAp0NJ_P15maejVzPqvJ-/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-202: Pengolah Angka (Excel) Lanjutan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1srJaLqp4ooThoEfI7wtsbFaykdgyu99e/view?usp=drive_link" },
                    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-202: Kerajaan-Kerajaan Islam di Nusantara", teacher: "Sulistiawan, S.Kom", downloadLink: "https://drive.google.com/file/d/1C46LEPWD7RqtMk9VCbSrmgrsfoacOmwx/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-102: Zat dan Wujudnya (Padat, Cair, Gas)", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "https://drive.google.com/file/d/1RNX57pp79q4_ng6jNbbL9noyIkSVh_za/view?usp=drive_link" },
                    { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-202: Pengantar Ulumul Qur'an (Makkiyah & Madaniyah)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1zjGj93zp0Q75e-R910X9rJD3vDwvJjRO/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-102: Shalat 1: Syarat & Rukun Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1N8ElP99WQz3mtS3Grci-OhJSaIYd7kXc/view?usp=drive_link" },
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-202: I'rab Isim Mutsanna & Jamak Mudzakkar Salim", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1QwWpcn3ulii4n4C50In2dlF6uPTBTODV/view?usp=drive_link" },
                    // DITAMBAHKAN: Materi baru Agribisnis di ruang RBM pada hari Jumat.
                    { day: "Jumat", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "AGR-201: Pengantar Agribisnis (Hidroponik)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-102: Masa Kenabian & Dakwah di Mekah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1ru17RARAr5mBS8fXP_tD_2HE3KH41ZeW/view?usp=drive_link" },
                    { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-102: Ilmu Ma'ani: Kalam Khabari & Insya'i", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "https://drive.google.com/file/d/1_sbsi-bfwpLPjzgR7G00yOCRj-4fZIIK/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-202: Tafsir & Tadabbur Surat Al-'Asr & Al-Humazah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/14DD1UeZQ-_1UojKNOZ6n_-8Z1BXQlMms/view?usp=drive_link" },
                    { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-102: Adab kepada Sesama & Lingkungan", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "https://drive.google.com/file/d/1j_-GAHn0VUbq3pjBHRvo2tajQUMcvIyM/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-102: Tafsir & Tadabbur Ayat Kursi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/18T2MoUIgArVl5bpl62IiX-lbMa4Xz5Wr/view?usp=drive_link" },
                    { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-202: Menulis 3: Membuat Ringkasan & Peta Konsep", teacher: "Mia A. Lubis, S.Kom", downloadLink: "https://drive.google.com/file/d/1EX9Suwx3tz13lBY6ZDl8WbBoh4d925zp/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-202: Peristiwa Isra' Mi'raj & Perintah Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "https://drive.google.com/file/d/1bWBklTc9RNC0TC-X2S_4paK5nyU_BrjA/view?usp=drive_link" },
                    { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-102: Jumlah Ismiyah (Kalimat Nominal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "https://drive.google.com/file/d/1A-2Xy_Z9VgG22wWRI9_dOPJuvVK12mOq/view?usp=drive_link" },
                ],
                bulan3: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-103: Aritmetika Sosial 1: Harga & Jual Beli", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-103: Aritmetika Sosial 1: Harga & Jual Beli", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-103: Membaca 1: Memahami Teks Informasi Sederhana", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-203: Isra' Mi'raj & Perintah Shalat", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-103: Alphabet, Numbers, & Telling Time", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-202: Analisis Kompetitor & SWOT Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-103: ABY Jilid 1A: Unit 5-6 (Makanan & Shalat)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-203: Makanan & Minuman Penyembuh Sesuai Wahyu", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-203: ABY Jilid 1B: Unit 11-12 (Manusia, Tempat & Hobi)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-103: Penanganan Luka & Pendarahan", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-103: Rukun Iman & Pembagian Tauhid", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-203: Sistem Pencernaan Manusia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-203: Pengantar Sanad & Matan Hadits", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-103: Menemukan Ide Bisnis dari Masalah Sekitar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-203: Praktik Menggunakan Alat Ukur & Perawatan Alat", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-103: Interaksi Sosial & Adab", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-203: Public Speaking 3: Praktik Pidato Singkat (Kultum)", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-203: Grammar 3: Present Continuous Tense", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-103: Hadits Arba'in 3 (Hafalan & Makna Hadits #11-15)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-103: Latihan Mengetik 10 Jari (Typing)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-203: Studi Kitab Tauhid 3", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-203: Aplikasi Presentasi (PowerPoint) - Dasar", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-203: Geografi Jazirah Arab", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-103: Suhu, Kalor, & Pemuaian", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-203: Pengantar Ilmu Tafsir (Definisi & Sejarah)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-103: Shalat 2: Sunnah & Pembatal Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-203: Penerapan Tanda Asli pada Isim Mufrad & Jamak Taksir", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-103: Hijrah ke Habasyah & Pemboikotan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-103: Ilmu Bayan: Seni Perumpamaan (Tasybih)", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-203: Tafsir & Tadabbur Surat At-Takatsur & Al-'Adiyat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-103: Adab Menuntut Ilmu", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-103: Tafsir & Tadabbur Surat Al-Ikhlas, Al-Falaq, An-Nas", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-203: Berbicara 3: Menyampaikan Pendapat dalam Diskusi", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-203: Bai'at 'Aqabah & Rencana Hijrah ke Madinah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-103: Jumlah Fi'liyah (Kalimat Verbal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },
 ],
                bulan4: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-104: Pengenalan Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-104: Pengenalan Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-104: Menulis 1: Menulis Paragraf Deskriptif", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-204: Hijrah ke Habasyah", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-104: My Family & My Friends", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-204: Analisis SWOT Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-104: Mufrodat 1: Kosakata Benda di Kelas & Rumah", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-204: Terapi Pengobatan Nabawi (Bekam & Ruqyah)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-204: Kitabah 2: Menulis Paragraf Sederhana & Imla' Lanjutan", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-104: Penanganan Kasus Umum & Simulasi P3K", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-104: Hadits Arba'in 4 (Hafalan & Makna Hadits #16-20)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-204: Usaha & Pesawat Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-204: Studi Sanad & Matan Sederhana", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-104: Menyusun Rencana Bisnis Sederhana", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-204: Praktik Menggunakan Alat Ukur & Perawatan Alat", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-104: Peta & Kompas", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-204: Public Speaking 4: Praktik Kultum di Depan Kelas", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-204: Asking & Giving Directions", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-104: Hadits Arba'in 4 (Hafalan & Makna Hadits #16-20)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-104: Latihan Mengetik 10 Jari (Typing)", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-204: Studi Kitab Tauhid 4", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-204: Desain Grafis Dasar 1 (dengan Canva)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-204: Geografi Jazirah Arab", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-104: Suhu, Kalor, & Pemuaian", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-204: Tafsir Ayat-ayat Pilihan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-104: Shalat 4: Dzikir & Doa Setelah Shalat", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-204: Isim-isim yang Manshub (Manshubat al-Asma')", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-104: Masa Remaja Nabi & Perjalanan Dagang", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-104: Ilmu Badi': Keindahan Lafaz (Jinas & Thibaq)", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-204: Tafsir & Tadabbur Surat Al-'Adiyat & Al-Qari'ah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-104: Adab Menuntut Ilmu", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-104: Tafsir & Tadabbur Surat Al-Ikhlas, Al-Falaq, An-Nas", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-204: Kaidah Bahasa 3: Imbuhan Dasar (me-, di-, ber-)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-204: Dakwah Terang-terangan & Reaksi Kafir Quraisy", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-104: Jumlah Fi'liyah (Kalimat Verbal)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },
 ],
                bulan5: [ 
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-105: Luas & Keliling Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-105: Luas & Keliling Bangun Datar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-105: Menulis 2: Menulis Surat Sederhana", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "AKH-205: Adab Berpakaian & Berhias", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-105: Daily Activities", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Senin", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-205: Pemasaran Digital Dasar", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ARB-105: Mufrodat 2: Anggota Tubuh & Pakaian", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-205: Studi Kasus Pengobatan Nabawi", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ARB-205: Muhadatsah 1: Praktik Percakapan Harian", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KTR-105: Dasar-dasar Menjahit & Kerajinan Tangan", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-105: Pembatal Keislaman", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Selasa", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IPA-205: Sistem Pernapasan Manusia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ULH-205: Takhrij Hadits Sederhana", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "KWU-105: Praktik Membuat Rencana Bisnis", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "TME-205: Proyek Elektronika Sederhana", teacher: "Aria Atmaja", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "IPS-105: Sejarah Lokal & Pahlawan", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "PAI-205: Manajemen Dakwah & Kepemimpinan", teacher: "SupraSojo, S.Pd.I., M.Pd.", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "ENG-205: Reading Comprehension 1", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Rabu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "HAD-105: Hadits Arba'in 5 (Hafalan & Makna Hadits #21-25)", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "TIK-105: Pengenalan Internet & Email", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "TAU-205: Studi Kitab Tauhid 5", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-205: Desain Grafis Dasar 2 (Praktik)", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPS-205: Sejarah Peradaban Islam Dunia", teacher: "Sulistiawan, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPA-105: Pengenalan Tata Surya", teacher: "Ariyanti R. Siregar, S.Kom", downloadLink: "" },
            { day: "Kamis", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ULQ-205: Studi Tematik Al-Qur'an", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-105: Zakat & Puasa", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-205: Isim-isim yang Majrur (Majrurat al-Asma')", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-105: Pernikahan Nabi & Peristiwa Penting", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-105: Praktik Analisis Balaghah", teacher: "M. Ryza Anshori, S.Pd", downloadLink: "" },
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "TAF-205: Tafsir & Tadabbur Surat Al-Qari'ah & Al-Zalzalah", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "AKH-105: Akhlak Terpuji (Mahmudah)", teacher: "Erwan SyahPutra, S.Pd", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-105: Tafsir & Tadabbur Juz 'Amma Pilihan", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "IND-205: Menulis Kreatif: Cerpen & Puisi", teacher: "Mia A. Lubis, S.Kom", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "Wajib", subject: "SIR-205: Hijrah ke Madinah & Pembangunan Masjid Nabawi", teacher: "Zhofri F. Majdi, S.Sos", downloadLink: "" },
            { day: "Sabtu", time: "13:00-14:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "NAH-105: Pengenalan Fi'il (Kata Kerja)", teacher: "Mahadi Sentosa, S.Sos", downloadLink: "" },

 ], bulan6: [], bulan7: [], bulan8: []
        }
    };
 
	
	
	const krsContainer = document.getElementById('krs-container');
    const krsDisplay = document.getElementById('krs-display');
    const closeKrsBtnBottom = document.getElementById('close-krs-btn-bottom');
    const downloadKrsBtn = document.getElementById('download-krs-btn');
    const krsTableBody = document.getElementById('krs-table-body');
    const addKrsRowBtn = document.getElementById('add-krs-row');
    const khsContainer = document.getElementById('khs-container');
    const khsDisplay = document.getElementById('khs-display');
    const downloadKhsBtn = document.getElementById('download-khs-btn');
    const closeKhsBtnBottom = document.getElementById('close-khs-btn-bottom');
	

// --- Tempelkan semua kode di bawah ini sebelum BAGIAN 2 ---
/**
 * FUNGSI BARU (sesuai ide Anda)
 * Membaca kalender dan membuat daftar objek rentang tanggal untuk setiap bulan akademik.
 * Dijalankan sekali saat aplikasi dimuat.
 */
function generateAcademicMonthRanges() {
    const monthStartEvents = appData.calendarEvents
        .filter(event => event.title.startsWith("Awal Materi Bulan"))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (monthStartEvents.length === 0) return;

    academicMonthRanges = monthStartEvents.map((event, index) => {
        const monthMatch = event.title.match(/Bulan (VIII|VII|VI|V|IV|III|II|I)/);
        if (!monthMatch) return null;

        const romanMap = { 'I': 1, 'II': 2, 'III': 3, 'IV': 4, 'V': 5, 'VI': 6, 'VII': 7, 'VIII': 8 };
        const monthNumber = romanMap[monthMatch[1]];

        // Tanggal mulai adalah tanggal acara itu sendiri
        const startDate = new Date(event.date + 'T00:00:00');

        let endDate;
        // Jika ada acara "Awal Materi" berikutnya, tanggal selesai adalah 1 hari sebelumnya
        if (index + 1 < monthStartEvents.length) {
    const nextStartDate = new Date(monthStartEvents[index + 1].date + 'T00:00:00');
    
    // BENAR: Buat salinan tanggal terlebih dahulu
    const tempDate = new Date(nextStartDate);
    // Ubah salinannya, bukan yang asli
    tempDate.setDate(tempDate.getDate() - 1); 
    // Gunakan salinan yang sudah diubah sebagai tanggal akhir
    endDate = tempDate; 
        } else {
            // Untuk bulan terakhir, kita set tanggal selesai jauh di masa depan
            endDate = new Date('2099-12-31T00:00:00');
        }

        return {
            month: monthNumber,
            start: startDate,
            end: endDate
        };
    }).filter(Boolean); // Menghapus entri null jika ada yang gagal di-parse

    // console.log("Rentang Bulan Akademik Berhasil Dibuat:", academicMonthRanges); // Untuk debugging
}

// =======================================================
// === VARIABEL DAN DATA UNTUK UJIAN ONLINE ===
// =======================================================
let currentExamData = {};
let currentQuestions = [];
let examAnswers = {};
let firstAttemptScore = null;
let currentAttemptHistory = null;
let isExamInProgress = false;
const alarmSound = new Audio('alarm.mp3');
alarmSound.loop = true;
alarmSound.volume = 1.0;

// =======================================================
// === FUNGSI-FUNGSI UNTUK UJIAN ONLINE ===
// =======================================================

// === VARIABEL DAN FUNGSI BARU UNTUK UJIAN ONLINE DINAMIS ===
let examInterval; // Variabel untuk menyimpan interval update
const subjectToMonthMap = {}; // Peta untuk mencari tahu materi ini ada di bulan ke berapa

/**
 * Helper untuk MENCARI rentang tanggal pekan ujian dari kalender yang sudah ada.
 * @param {number} monthNumber - Nomor bulan akademik (1 untuk Bulan I, dst.)
 * @returns {object} - Objek berisi tanggal mulai dan akhir pekan ujian.
 */
function getAcademicMonthInfo(monthNumber) {
    // DITAMBAHKAN: Array untuk mengubah angka menjadi Romawi
    const romanNumerals = ["", "I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
    const targetTitle = `Awal Ujian Bulanan ${romanNumerals[monthNumber]}`;

    // DIUBAH: Logika sekarang mencari event di dalam appData.calendarEvents
    const examEvent = appData.calendarEvents.find(event => event.title === targetTitle);

    // Jika event ujian untuk bulan tersebut tidak ditemukan, kembalikan tanggal yang tidak valid
    if (!examEvent) {
        return { examWeekStart: new Date('1970-01-01'), examWeekEnd: new Date('1970-01-01') };
    }

    // Ambil tanggal mulai dari event yang ditemukan
    const examWeekStart = new Date(examEvent.date + 'T00:00:00');
    
    // Asumsikan pekan ujian berlangsung selama 7 hari
    const examWeekEnd = new Date(examWeekStart);
    examWeekEnd.setDate(examWeekStart.getDate() + 7);
    examWeekEnd.setSeconds(examWeekEnd.getSeconds() - 1); // Berakhir di hari ke-7 jam 23:59:59

    return { examWeekStart, examWeekEnd };
}

/**
 * Helper untuk memeriksa apakah waktu saat ini berada dalam slot KBM.
 */
function isTimeInSlot(now, timeSlot) {
    if (!timeSlot.includes('-')) return false;
    const [start, end] = timeSlot.split('-');
    const [startHour, startMinute] = start.split(':').map(Number);
    const [endHour, endMinute] = end.split(':').map(Number);

    const startTime = new Date(now);
    startTime.setHours(startHour, startMinute, 0, 0);

    const endTime = new Date(now);
    endTime.setHours(endHour, endMinute, 0, 0);
    
    return now >= startTime && now <= endTime;
}

// DIUBAH TOTAL: Fungsi notifikasi sekarang bisa menangani event yang berlangsung beberapa hari
function checkAndDisplayHeaderNotifications() {
    const notificationArea = document.getElementById('header-notification-area');
    if (!notificationArea) return;

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const notificationsToShow = [];

    appData.calendarEvents.forEach(event => {
        const eventDate = new Date(event.date + 'T00:00:00');
        const span = event.span || 1; // Ambil durasi hari, default 1 jika tidak ada
        const endDate = new Date(eventDate);
        endDate.setDate(eventDate.getDate() + span - 1);

        // Hitung selisih hari ke TANGGAL MULAI acara
        const diffDays = Math.ceil((eventDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));

        let message = '';

        // DIUBAH: Logika baru untuk memeriksa rentang tanggal
        if (today >= eventDate && today <= endDate) {
            // Kondisi 1: Acara sedang berlangsung hari ini
            message = `Sedang berlangsung: ${event.title}`;
        } else if (diffDays > 0 && diffDays <= 2) {
            // Kondisi 2: Acara akan datang dalam 1-2 hari
            message = `${diffDays} hari lagi: ${event.title}`;
        }

        if (message) {
            notificationsToShow.push(message);
        }
    });

    notificationArea.innerHTML = '';

    if (notificationsToShow.length > 0) {
        notificationsToShow.forEach(msg => {
            const p = document.createElement('p');
            p.textContent = msg;
            notificationArea.appendChild(p);
        });
    }
}

/**
 * Fungsi baru untuk mengambil dan menampilkan notifikasi khusus admin.
 */
// GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU INI
async function fetchAndShowAdminNotification() {
    const notifContainer = document.getElementById('admin-soal-notification');
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'handleGetMissingKeysDetail' }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();

        if (result.status === 'success' && result.data.length > 0) {
            
            // 1. Urutkan data berdasarkan nama guru
            const sortedData = result.data.sort((a, b) => a.guru.localeCompare(b.guru));

            // 2. Kelompokkan materi berdasarkan nama guru
            const groupedByTeacher = sortedData.reduce((acc, item) => {
                const teacher = item.guru;
                if (!acc[teacher]) {
                    acc[teacher] = [];
                }
                acc[teacher].push(item);
                return acc;
            }, {});

            // 3. Buat daftar (list) HTML dari data yang sudah dikelompokkan
            let listItemsHTML = '';
            for (const teacher in groupedByTeacher) {
                listItemsHTML += `<p class="font-bold mt-3">${teacher}:</p>`;
                const materias = groupedByTeacher[teacher].map(item => 
                    `<li><span class="font-semibold">${item.kode}:</span> ${item.namaMateri}</li>`
                ).join('');
                listItemsHTML += `<ul class="list-disc list-inside ml-4 text-sm">${materias}</ul>`;
            }

            notifContainer.innerHTML = `
                <p class="font-bold">Pemberitahuan: Materi Berikut Belum Memiliki Kunci Jawaban Lengkap</p>
				<p class="font-bold"><i>(Pemberitahuan ini hanya bisa dilihat oleh Waka Kurikulum, TU dan admin)</i></p>
                <div class="mt-2">
                    ${listItemsHTML}
                </div>
            `;
            notifContainer.classList.remove('hidden');
        } else {
            notifContainer.classList.add('hidden');
        }
    } catch (error) {
        console.error("Gagal mengambil notifikasi admin:", error);
        notifContainer.classList.add('hidden');
    }
}


// === FUNGSI UTAMA UJIAN ONLINE (VERSI BARU YANG LENGKAP) ===
async function renderExamSchedule() {
    if (examInterval) clearInterval(examInterval);

    const container = document.getElementById('ujian-schedule-container');
    if (!container) return;
    
    container.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat KRS dan status ujian...</p>';
    const session = getActiveSession();
    if (!session || !session.loggedIn || !session.userData.jabatan || session.userData.jabatan.toLowerCase().trim() !== 'santri') {
        container.innerHTML = '<p class="p-8 text-center text-gray-500">Halaman ini hanya untuk santri.</p>';
        return;
    }
    const isAdmin = ['wawan', 'mia', 'admin'].includes(session.username);

    const krsInfoMap = new Map();
    let savedKrsSubjects = [], availableExams = [], nilaiUjian = {};
    let unlockedExamsData = []; 
    
    try {
        const [krsResponse, examsResponse, nilaiResponse, unlockedResponse] = await Promise.all([
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllKrsSubjectsForSantri', namaSantri: session.userData.profileName }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }}),
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAvailableExams' }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }}),
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getNilaiUjian', username: session.username }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }}),
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getUnlockedExams', username: session.username }), headers: { 'Content-Type': 'text/plain;charset=utf-8' }})
        ]);
        
        const krsResult = await krsResponse.json();
        if (krsResult.status === 'success') {
            savedKrsSubjects = krsResult.data;
            savedKrsSubjects.forEach(item => krsInfoMap.set(item.code, item)); 
        } else throw new Error(krsResult.message);

        const examsResult = await examsResponse.json();
        if (examsResult.status === 'success') availableExams = examsResult.availableExams; else throw new Error(examsResult.message);
        
        const nilaiResult = await nilaiResponse.json();
        if (nilaiResult.status === 'success') nilaiUjian = nilaiResult.nilai; else throw new Error(nilaiResult.message);
        
        const unlockedResult = await unlockedResponse.json();
        if (unlockedResult.status === 'success') unlockedExamsData = unlockedResult.unlockedExams; else throw new Error(unlockedResult.message);

    } catch (error) {
        container.innerHTML = `<p class="p-8 text-center text-red-500">${error.message}</p>`;
        return;
    }

    const days = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    
    const updateExamGrid = () => {
        const now = new Date();
        const groupedExams = new Map(); 

        // 1. Proses Ujian yang Dibuka Manual (UTS/UAS/Bulanan)
        unlockedExamsData.forEach(exam => {
            const krsData = krsInfoMap.get(exam.kodeMateri);
            if (!krsData) return; 

            // (PERBAIKAN BUG JUDUL) Kunci grup selalu 'nama' (cth: "UAS")
            const key = exam.nama; 
            
            if (!groupedExams.has(key)) {
                // (PERBAIKAN BUG JUDUL) Nama Tampilan adalah 'nama' dari backend
                const displayName = exam.nama;
                
                // (PERBAIKAN BUG JUDUL) 'jenis' diambil dari backend
                groupedExams.set(key, {
                    nama: displayName, 
                    jenis: exam.jenis,
                    materi: [krsData], // Selalu 1 materi
                    krsInfo: krsData,
                    isManuallyUnlocked: true,
                    isScheduled: false
                });
            }
        });

        // 2. (LOGIKA DIKEMBALIKAN) Proses Ujian Bulanan Terjadwal
        savedKrsSubjects.forEach(item => {
            const subjectCode = item.code;
            if (!availableExams.includes(subjectCode)) return;
            if (groupedExams.has(subjectCode)) return; 
            
            const academicMonth = subjectToMonthMap[subjectCode] || 0;
            if (!academicMonth) return;

            const { examWeekStart, examWeekEnd } = getAcademicMonthInfo(academicMonth);
            
            const utsEvent = appData.calendarEvents.find(e => e.title.includes("UTS") && e.span);
            const uasEvent = appData.calendarEvents.find(e => e.title.includes("UAS") && e.span);
            let examTypeOverride = 'Bulanan'; // Default
            
            if(utsEvent && now >= new Date(utsEvent.date) && now <= new Date(new Date(utsEvent.date).setDate(new Date(utsEvent.date).getDate() + utsEvent.span))) {
                examTypeOverride = 'UTS';
            } else if (uasEvent && now >= new Date(uasEvent.date) && now <= new Date(new Date(uasEvent.date).setDate(new Date(uasEvent.date).getDate() + uasEvent.span))) {
                examTypeOverride = 'UAS';
            }

            const isExamWindowActive = (now >= examWeekStart && now <= examWeekEnd) && days[now.getDay()] === item.day && isTimeInSlot(now, item.time);

            if (isExamWindowActive || (isAdmin && !isExamWindowActive)) {
                 groupedExams.set(subjectCode, {
                    nama: item.subject, 
                    jenis: examTypeOverride,
                    materi: [item],     
                    krsInfo: item,
                    isManuallyUnlocked: false,
                    isScheduled: true 
                });
            }
        });

        // 3. Render Kartu Ujian
        container.innerHTML = '';
        if (groupedExams.size === 0) {
            container.innerHTML = '<p class="p-8 text-center text-gray-500">Tidak ada ujian yang tersedia untuk Anda saat ini.</p>';
            return;
        }

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
        const activeCardsFragment = document.createDocumentFragment();
        const inactiveCardsFragment = document.createDocumentFragment();

        groupedExams.forEach((examGroup, key) => {
            const riwayat = nilaiUjian[examGroup.materi[0].code] || null;
            let statusText = 'Ujian belum tersedia';
            let statusColor = 'bg-gray-400';
            let isDisabled = true;
            let textColorClass = 'text-white';
            
            const isManuallyUnlocked = examGroup.isManuallyUnlocked;
            const isScheduledActive = examGroup.isScheduled;

            if (riwayat) {
                const nilaiToShow = riwayat.skorAkhir ?? riwayat.skor;
                if (nilaiToShow >= 75 && !isAdmin) {
                    statusText = `Lulus (Nilai Akhir: ${nilaiToShow})`;
                    statusColor = 'bg-green-600';
                    isDisabled = true;
                } else if (riwayat.percobaan >= 3 && !isAdmin) {
                    statusText = `Batas Coba Habis (Nilai: ${nilaiToShow})`;
                    statusColor = 'bg-gray-500';
                    isDisabled = true;
                } else if (isManuallyUnlocked || isScheduledActive || isAdmin) { 
                    statusText = `Mulai Remedial (Nilai: ${nilaiToShow})`; 
                    statusColor = 'bg-yellow-500 hover:bg-yellow-600';
                    isDisabled = false;
                } else { 
                    statusText = `Waktu Habis (Nilai: ${nilaiToShow})`;
                    statusColor = 'bg-gray-500';
                    isDisabled = true;
                }
            } else {
                if (isManuallyUnlocked || isScheduledActive || isAdmin) {
                    statusText = 'Mulai Ujian';
                    statusColor = 'bg-blue-600 hover:bg-blue-700';
                    isDisabled = false;
                } else {
                    statusText = 'Terlewat'; 
                    statusColor = 'bg-gray-500';
                    isDisabled = true;
                }
            }
            if (isAdmin) {
                isDisabled = false;
                statusColor = 'bg-purple-600 hover:bg-purple-700';
            }

            // --- (PERBAIKAN BUG JUDUL) ---
            let displayTitle = '';
            let subTitle = '';
            
            if (examGroup.jenis === 'Bulanan') {
                // Jika Bulanan (baik manual atau terjadwal)
                displayTitle = `Ujian Bulanan: ${examGroup.nama}`;
                subTitle = `<p class="text-sm text-slate-600 mt-2">Pengajar: ${examGroup.krsInfo.teacher}</p>`;
            } else {
                // Jika UTS atau UAS
                displayTitle = examGroup.nama; // Cth: "UAS Ganjil 2025"
                subTitle = `<p class="text-sm text-slate-600 mt-2">Materi: ${examGroup.materi[0].name}</p>`;
            }
            // --- AKHIR PERBAIKAN ---

            const jadwalInfoHtml = examGroup.isScheduled
                ? `<p class="text-xs italic mt-1">Jadwal: ${examGroup.krsInfo.day}, ${examGroup.krsInfo.time}</p>`
                : `<p class="text-xs italic mt-1 text-green-600 font-bold">Akses Dibuka Manual (24 Jam)</p>`;

            const card = document.createElement('div');
            card.className = 'schedule-cell p-4 border rounded-lg flex flex-col';
            card.innerHTML = `
                <div class="subject flex-grow font-bold text-teal-900">${displayTitle}</div>
                ${subTitle}
                ${jadwalInfoHtml}
                <button class="start-exam-trigger w-full mt-4 py-2 px-4 rounded-md font-semibold ${statusColor} ${textColorClass} ${isDisabled ? 'cursor-not-allowed' : ''}" 
                        data-nama-ujian="${displayTitle}" 
                        data-jenis-ujian="${examGroup.jenis}"
                        data-materi-list='${JSON.stringify(examGroup.materi.map(m => m.code))}'
                        ${isDisabled ? 'disabled' : ''}>
                    ${statusText}
                </button>
            `;

            if (isDisabled) {
                inactiveCardsFragment.appendChild(card);
            } else {
                activeCardsFragment.appendChild(card);
            }
        });

        grid.appendChild(activeCardsFragment);
        grid.appendChild(inactiveCardsFragment);
        container.appendChild(grid);
    };

    updateExamGrid();
    examInterval = setInterval(updateExamGrid, 30000);
}

// === FUNGSI-FUNGSI PENDUKUNG UJIAN ONLINE ===
function setupExamListeners() {
    // Listener untuk tombol "Mulai Ujian"
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('start-exam-trigger')) {
            const namaUjian = e.target.dataset.namaUjian;
            const jenisUjian = e.target.dataset.jenisUjian;
            const materiList = JSON.parse(e.target.dataset.materiList);
            
            currentExamData = { 
                title: namaUjian, 
                jenis: jenisUjian, 
                materiList: materiList 
            };
            
            document.getElementById('exam-subject-title').textContent = namaUjian;
            document.getElementById('exam-warning-modal').style.display = 'block';
        }
        
        // --- (BARU) EVENT LISTENER UNTUK TOMBOL BANTUAN ---
        if (e.target.classList.contains('help-btn')) {
            handleHelpClick(e.target);
        }
        // --- AKHIR BLOK BARU ---
    });

    // Listener untuk tombol "Batal" di modal peringatan
    document.getElementById('cancel-exam-btn').addEventListener('click', () => {
        document.getElementById('exam-warning-modal').style.display = 'none';
    });

    // Listener untuk tombol "Mulai" di modal peringatn
    document.getElementById('start-exam-btn').addEventListener('click', () => {
        document.getElementById('exam-warning-modal').style.display = 'none';
        
        if (alarmSound.paused) {
            alarmSound.play().then(() => {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }).catch(e => console.warn("Gagal unlock audio"));
        }

        enterFullscreen(document.documentElement);
        startExam();
    });

    // Listener untuk tombol "Selesai & Kirim Jawaban"
    document.getElementById('submit-exam-btn').addEventListener('click', () => {
        if (Object.keys(examAnswers).length < currentQuestions.length) {
            showCustomAlert('Harap jawab semua pertanyaan sebelum mengirim.');
            return;
        }
        // (PERBAIKAN) Ganti 'confirm' dengan modal kustom
        showCustomConfirm('Konfirmasi Selesai Ujian', 'Apakah Anda yakin ingin mengirim jawaban Anda?', 'Ya, Kirim', 'Batal')
            .then(confirmed => {
                if (confirmed) {
                    exitFullscreen();
                    calculateAndShowResult();
                }
            });
    });
}

async function handleHelpClick(btn) {
    const type = btn.dataset.type;
    const index = parseInt(btn.dataset.index);
    const questionKey = btn.dataset.questionKey;
    const cacheKey = (currentExamData.jenis === 'Bulanan') ? currentExamData.materiList[0] : currentExamData.title;

    // Cek 1: Apakah bantuan sudah dipakai di soal ini?
    if (helpUsedOnQuestion[questionKey]) {
        showMessage('Bantuan untuk soal ini sudah dipakai.', 'error');
        return;
    }

    // Cek 2: Apakah limit global sudah habis?
    if (type === 'PG' && helpPgUsedCount >= HELP_PG_LIMIT) {
        showMessage(`Bantuan 50/50 sudah habis (Maks 3x).`, 'error');
        return;
    }
    if (type === 'Isian' && helpIsianUsedCount >= HELP_ISIAN_LIMIT) {
        showMessage(`Bantuan petunjuk sudah habis (Maks 2x).`, 'error');
        return;
    }

    // Tampilkan pop-up konfirmasi
    const confirmed = await showCustomConfirm(
        'Gunakan Bantuan?',
        'Jika jawaban Anda benar, poin yang didapat hanya 50% dari poin soal ini. Yakin ingin melanjutkan?',
        'Ya, Gunakan Bantuan',
        'Batal'
    );

    if (!confirmed) return;

    // Konfirmasi berhasil, terapkan bantuan
    helpUsedOnQuestion[questionKey] = true; // Tandai soal ini sudah pakai bantuan
    btn.classList.add('help-btn-disabled'); // Nonaktifkan tombol ini
    btn.classList.remove('help-btn-available');
    
    let logDetail = '';

    if (type === 'PG') {
        helpPgUsedCount++;
        applyPgHelp(index);
        logDetail = `Santri menggunakan bantuan 50/50 (ke-${helpPgUsedCount}/${HELP_PG_LIMIT}) untuk soal no. ${index + 1}`;
        if (helpPgUsedCount >= HELP_PG_LIMIT) updateAllHelpButtons('PG');
        
    } else if (type === 'Isian') {
        helpIsianUsedCount++;
        applyIsianHelp(index, questionKey); // Kirim questionKey
        logDetail = `Santri menggunakan petunjuk (ke-${helpIsianUsedCount}/${HELP_ISIAN_LIMIT}) untuk soal no. ${index + 1}`;
        if (helpIsianUsedCount >= HELP_ISIAN_LIMIT) updateAllHelpButtons('Isian');
    }

    // Simpan status bantuan ke backend agar tidak bisa di-reset
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'saveTemporaryAnswer',
            username: getActiveSession().username,
            kodeMateri: cacheKey,
            kunciSoal: `HELP_USED_${questionKey}`, // Kunci khusus
            jawaban: 'true'
        }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        keepalive: true
    });
    
    // Kirim log ke pengawas
    logAction('BANTUAN', logDetail);
}

/**
 * 2. Menerapkan bantuan 50/50 (PG)
 */
function applyPgHelp(index) {
    const questionBlock = document.getElementById(`q${index}_block`);
    if (!questionBlock) return;
    
    const options = questionBlock.querySelectorAll('.answer-option');
    const correctAnswerValue = currentQuestions[index].a; // Ambil teks jawaban benar
    
    let wrongOptions = [];
    options.forEach(opt => {
        const input = opt.querySelector('input[type="radio"]');
        if (input.value !== correctAnswerValue) {
            wrongOptions.push(opt);
        }
    });

    // Acak dan sembunyikan 2 opsi yang salah
    wrongOptions.sort(() => Math.random() - 0.5);
    if (wrongOptions[0]) wrongOptions[0].style.display = 'none';
    if (wrongOptions[1]) wrongOptions[1].style.display = 'none';
}

/**
 * 3. Menerapkan bantuan petunjuk 2 huruf (Isian)
 */
function applyIsianHelp(index, questionKey) {
    const questionBlock = document.getElementById(`q${index}_block`);
    if (!questionBlock) return;

    const textarea = questionBlock.querySelector('textarea');
    const kunciJawabanString = currentQuestions[index].a || "";

    // Ambil kunci jawaban pertama yang valid
    const kunciList = kunciJawabanString.toLowerCase()
                              .split(/[/|()]/)
                              .map(s => s.trim())
                              .filter(Boolean);
    
    const firstHint = kunciList[0] ? kunciList[0].substring(0, 2) : '??';

    textarea.value = firstHint; // Tampilkan petunjuk
    
    // (PENTING) Simulasikan event 'input' agar jawaban tersimpan
    textarea.dispatchEvent(new Event('input', { bubbles: true }));
    // (PENTING) Update juga kotak navigasi
    updateNavBoxStatus(index, true); 
}

/**
 * 4. Menonaktifkan semua tombol bantuan jika limit global tercapai
 */
function updateAllHelpButtons(type) {
    const buttons = document.querySelectorAll(`.help-btn[data-type="${type}"]`);
    buttons.forEach(btn => {
        btn.classList.add('help-btn-disabled');
        btn.classList.remove('help-btn-available');
        // Jangan nonaktifkan yang sudah dipakai
        const questionKey = btn.dataset.questionKey;
        if (!helpUsedOnQuestion[questionKey]) {
             btn.querySelector('.help-tooltip').textContent = 'Bantuan Habis';
        }
    });
}

/**
 * 5. Fungsi untuk memulihkan status bantuan saat ujian dilanjutkan
 */
function restoreHelpState(tempAnswers, questions) {
    // Reset hitungan global
    helpPgUsedCount = 0;
    helpIsianUsedCount = 0;
    helpUsedOnQuestion = {};

    for (const key in tempAnswers) {
        if (key.startsWith('HELP_USED_')) {
            const qKey = key.replace('HELP_USED_', '');
            helpUsedOnQuestion[qKey] = true; // Tandai soal ini sudah pakai bantuan
            
            // Cari tipe soal untuk menghitung limit global
            const q = questions.find(q => q.q === qKey);
            if (q) {
                if (q.j === 'PG') helpPgUsedCount++;
                if (q.j === 'Isian') helpIsianUsedCount++;
            }
        }
    }
    // Nonaktifkan semua tombol jika limit global tercapai
    if (helpPgUsedCount >= HELP_PG_LIMIT) updateAllHelpButtons('PG');
    if (helpIsianUsedCount >= HELP_ISIAN_LIMIT) updateAllHelpButtons('Isian');
}


function setupResultModalListeners() {
    document.getElementById('result-actions').addEventListener('click', function(e) {
        if (e.target.id === 'result-done-btn' || e.target.id === 'result-later-btn') {
            closeResultModal();
        } else if (e.target.id === 'result-remedial-btn') {
            startRemedial();
        }
    });
}

// === (BARU) FUNGSI-FUNGSI HELPER UNTUK NAVIGASI UJIAN ===

/**
 * Membuat kotak-kotak navigasi di sisi kanan
 * @param {Array} questions - Array 'currentQuestions'
 * @param {Object} answers - Objek 'examAnswers' (untuk memulihkan status)
 */
function renderExamNavGrid(questions, answers) {
    const container = document.getElementById('exam-nav-grid-container');
    if (!container) return;
    
    container.innerHTML = ''; // Kosongkan
    
    questions.forEach((q, index) => {
        const box = document.createElement('a'); // Gunakan tag <a> agar bisa di-scroll
        box.id = `nav-box-${index}`;
        box.className = 'nav-box';
        box.textContent = index + 1;
        box.href = `#q${index}_block`; // Link ke blok soal

        // Cek apakah sudah dijawab
        const questionText = q.q;
        const savedAnswer = answers[questionText] || "";
        const isAnswered = (savedAnswer !== "");
        
        box.classList.add(isAnswered ? 'answered' : 'unanswered');
        
        // Buat agar scroll-nya mulus
        box.onclick = (e) => {
            e.preventDefault();
            const targetBlock = document.getElementById(`q${index}_block`);
            if (targetBlock) {
                targetBlock.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        };
        
        container.appendChild(box);
    });
}

/**
 * Mengubah warna kotak navigasi
 * @param {number} index - Nomor soal (mulai dari 0)
 * @param {boolean} isAnswered - Apakah sudah dijawab atau belum
 */
function updateNavBoxStatus(index, isAnswered) {
    const box = document.getElementById(`nav-box-${index}`);
    if (!box) return;
    
    if (isAnswered) {
        box.classList.remove('unanswered');
        box.classList.add('answered');
    } else {
        box.classList.remove('answered');
        box.classList.add('unanswered');
    }
}
// --- (AKHIR FUNGSI HELPER BARU) ---

async function startExam() {
    isExamInProgress = true;
	showLoading();
    const examContainer = document.getElementById('exam-container');
    const questionsContainer = document.getElementById('exam-questions');
    
    // (PERBAIKAN) Judul diambil dari data global
    document.getElementById('exam-subtitle').textContent = currentExamData.title; 
 
    let temporaryAnswers = {};
    const session = getActiveSession();

    // (PERBAIKAN) Kunci cache adalah NAMA UJIAN (cth: "UAS Ganjil 2025")
    const cacheKey = currentExamData.title;

    // Langkah 1: Cek progres tersimpan
    try {
        const tempAnswersResponse = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'getTemporaryAnswers',
                username: session.username,
                kodeMateri: cacheKey // Menggunakan kunci cache baru
            }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const tempAnswersResult = await tempAnswersResponse.json();
        if (tempAnswersResult.status === 'success' && tempAnswersResult.answers) {
            temporaryAnswers = tempAnswersResult.answers;
        }
    } catch (e) {
        console.warn("Gagal mengambil jawaban sementara, memulai sesi baru:", e);
    }

    // Fungsi inti yang akan menjalankan ujian
    const startTheExamProcess = async () => {
        examContainer.classList.remove('hidden');
        
        const loadingHTML = `... (Loading HTML Anda tetap sama) ...`;
        questionsContainer.innerHTML = loadingHTML;

        try {
            // (PERBAIKAN) Mengirim 1 kode materi
            let dataForSoal = { action: 'getBankSoal', kodeMateri: currentExamData.materiList[0] };

            const [soalResponse, nilaiResponse] = await Promise.all([
                fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(dataForSoal), 
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                }),
                fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getNilaiUjian', username: session.username }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                })
            ]);

            const soalResult = await soalResponse.json();
            const nilaiResult = await nilaiResponse.json();
            if (soalResult.status !== 'success') throw new Error(soalResult.message);
            if (nilaiResult.status !== 'success') throw new Error(nilaiResult.message);
            
            currentQuestions = soalResult.questions;
            currentAttemptHistory = nilaiResult.nilai[currentExamData.materiList[0]] || null;
            
            if (currentQuestions.length === 0) {
                throw new Error("Tidak ada soal yang ditemukan untuk materi ini.");
            }

            examAnswers = temporaryAnswers; 
            if(Object.keys(examAnswers).length > 0) {
                showMessage('Progres sebelumnya berhasil dipulihkan.', 'success');
            }
        } catch (error) {
            questionsContainer.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat soal: ${error.message}</p>`;
            isExamInProgress = false; 
            return;
        }
        
        questionsContainer.innerHTML = '';
        restoreHelpState(examAnswers, currentQuestions);
        renderExamNavGrid(currentQuestions, examAnswers);

        // Render soal (PG dan Isian)
        currentQuestions.forEach((q, index) => {
            const questionId = `q${index}`;
            const questionKey = q.q; 
            let answerInputHtml = ''; 
            
            let helpButtonHtml = '';
            const isHelpUsed = helpUsedOnQuestion[questionKey] === true;
            let helpState = isHelpUsed ? 'disabled' : 'available';
            let helpTooltip = 'Butuh Bantuan?';
            
            if (!isHelpUsed) { 
                if (q.j === 'PG' && helpPgUsedCount >= HELP_PG_LIMIT) {
                    helpState = 'disabled';
                    helpTooltip = 'Bantuan 50/50 Habis';
                }
                if (q.j === 'Isian' && helpIsianUsedCount >= HELP_ISIAN_LIMIT) {
                    helpState = 'disabled';
                    helpTooltip = 'Bantuan Petunjuk Habis';
                }
            }
            helpButtonHtml = `
                <div class="help-button-container">
                    <button class="help-btn help-btn-${helpState}" 
                            data-type="${q.j}" 
                            data-index="${index}" 
                            data-question-key="${questionKey}"
                            ${isHelpUsed ? 'disabled' : ''}>
                        ðŸ’¡
                        <span class="help-tooltip">${helpTooltip}</span>
                    </button>
                </div>
            `;

            if (q.j === 'PG') {
                const shuffledOptions = [...q.o].sort(() => Math.random() - 0.5);
                shuffledOptions.forEach((option, i) => {
                    const optionId = `q${index}_opt${i}`;
                    answerInputHtml += `<label for="${optionId}" class="answer-option"><input type="radio" name="${questionId}" id="${optionId}" value="${option}"><span>${String.fromCharCode(65 + i)}. ${option}</span></label>`;
                });
            } else {
                answerInputHtml = `<textarea class="answer-isian w-full p-3 border rounded-md" rows="4" placeholder="Ketik jawaban Anda di sini..."></textarea>`;
            }
            questionsContainer.innerHTML += `
                <div class="question-block" id="${questionId}_block">
                    ${helpButtonHtml} 
                    <div class="flex justify-between items-start">
                        <p class="text-lg font-semibold mb-4 flex-1">${index + 1}. ${q.q}</p>
                        <span class="text-sm font-bold text-gray-500 ml-4">${q.p || 4} Poin</span>
                    </div>
                    <div class="answer-options">${answerInputHtml}</div> 
                </div>
            `;
            
            const savedAnswerForThisQuestion = examAnswers[questionKey];
            if (savedAnswerForThisQuestion) {
                if (q.j === 'PG') {
                    const radioToCheck = document.querySelector(`input[name="q${index}"][value="${savedAnswerForThisQuestion}"]`);
                    if (radioToCheck) { radioToCheck.checked = true; document.querySelector(`label[for="${radioToCheck.id}"]`).classList.add('selected'); }
                } else {
                    const textarea = document.querySelector(`#${questionId}_block textarea`);
                    if (textarea) textarea.value = savedAnswerForThisQuestion;
                }
            }
            
            if (isHelpUsed && q.j === 'PG') {
                applyPgHelp(index);
            }
        });
        
        // (Listener auto-save)
        currentQuestions.forEach((q, index) => {
            const questionBlock = document.getElementById(`q${index}_block`);
            if (!questionBlock) return;
            const questionTextKey = q.q; 
            if (q.j === 'PG') {
                const radioButtons = questionBlock.querySelectorAll('input[type="radio"]');
                radioButtons.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        examAnswers[questionTextKey] = e.target.value; 
                        logAction('JAWAB_SOAL', `Menjawab soal no. ${index + 1}`);
                        updateNavBoxStatus(index, true); 
                        fetch(CONFIG.SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'saveTemporaryAnswer',
                                username: session.username,
                                kodeMateri: cacheKey, 
                                kunciSoal: questionTextKey, 
                                jawaban: e.target.value
                            }),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            keepalive: true
                        });
                        document.querySelectorAll(`label[for^="q${index}_opt"]`).forEach(label => label.classList.remove('selected'));
                        document.querySelector(`label[for="${e.target.id}"]`).classList.add('selected');
                    });
                });
            } else {
                const textarea = questionBlock.querySelector('textarea');
                if (textarea) {
                    textarea.addEventListener('input', (e) => { 
                        examAnswers[questionTextKey] = e.target.value; 
                        logAction('JAWAB_SOAL', `Mengetik jawaban soal no. ${index + 1} (Isian)`);
                        updateNavBoxStatus(index, e.target.value.trim() !== '');
                        fetch(CONFIG.SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify({
                                action: 'saveTemporaryAnswer',
                                username: session.username,
                                kodeMateri: cacheKey, 
                                kunciSoal: questionTextKey, 
                                jawaban: e.target.value
                            }),
                            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                            keepalive: true
                        });
                    });
                }
            }
        });
    };

    // (Logika kata sandi - tetap sama)
    if (Object.keys(temporaryAnswers).length > 0) {
        const password = String(Math.floor(10000 + Math.random() * 90000));
        logAction('AKSES_LANJUTAN', `Santri mencoba melanjutkan ujian. Kata sandi: ${password}`);
        
        const modal = document.getElementById('teacherPasswordModal');
        const input = document.getElementById('teacherPasswordInput');
        const submitBtn = document.getElementById('submitTeacherPasswordBtn');
        const cancelBtn = document.getElementById('cancelTeacherPasswordBtn');
        input.value = '';
		hideLoading(); 
        modal.style.display = 'block';

        const submitHandler = () => {
            if (input.value === password) {
                modal.style.display = 'none';
                logAction('AKSES_DIBERIKAN', `Kata sandi benar.`);
                startTheExamProcess(); 
                cleanupListeners(); 
            } else {
                logAction('AKSES_DITOLAK', `Santri salah memasukkan kata sandi.`);
                showMessage('Kata sandi salah. Silakan minta lagi dari pengawas.', 'error');
            }
        };
        const cancelHandler = () => {
            modal.style.display = 'none';
            isExamInProgress = false; 
            cleanupListeners(); 
        };
        const cleanupListeners = () => {
            submitBtn.removeEventListener('click', submitHandler);
            cancelBtn.removeEventListener('click', cancelHandler);
        };
        submitBtn.addEventListener('click', submitHandler);
        cancelBtn.addEventListener('click', cancelHandler);
        
    } else {
		hideLoading(); 
        logAction('UJIAN_DIMULAI', currentExamData.title);
        startTheExamProcess();
    }
}


/**
 * FUNGSI BARU: Menghitung Levenshtein Distance (mengukur typo)
 * @param {string} a - String pertama (jawaban santri)
 * @param {string} b - String kedua (kunci jawaban)
 * @returns {number} - Jumlah "jarak" atau typo
 */
function getLevenshteinDistance(a, b) {
    if (a.length === 0) return b.length;
    if (b.length === 0) return a.length;
    const matrix = [];
    for (let i = 0; i <= b.length; i++) matrix[i] = [i];
    for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
    for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
            const cost = a[j - 1] === b[i - 1] ? 0 : 1;
            matrix[i][j] = Math.min(
                matrix[i - 1][j] + 1,      // penghapusan
                matrix[i][j - 1] + 1,      // penyisipan
                matrix[i - 1][j - 1] + cost // penggantian
            );
        }
    }
    return matrix[b.length][a.length];
}

function calculateAndShowResult() {
    
    document.getElementById('exam-nav-grid-container').innerHTML = '';
    alarmSound.pause();
    alarmSound.currentTime = 0;

    const isForceSubmit = false; 
    let totalPoinSantri = 0;
    let totalPoinMaksimal = 0;

    currentQuestions.forEach((q, index) => {
        const poinSoal = q.p || 4; 
        totalPoinMaksimal += poinSoal;

        // --- (PERBAIKAN LOGIKA PENALTI) ---
        const questionKey = q.q;
        const jawabanSantri = examAnswers[questionKey] || ""; 
        const kunciJawabanString = q.a || "";
        const wasHelpUsed = helpUsedOnQuestion[questionKey] === true; // Cek apakah bantuan dipakai
        let poinDidapat = 0;
        // ---

        if (q.j === 'PG') { 
            if (jawabanSantri.toLowerCase().trim() === kunciJawabanString.toLowerCase().trim()) {
                poinDidapat = poinSoal; // Jawaban benar
            }
        } else { 
            const jawabanSantriNorm = jawabanSantri.toLowerCase().trim();
            const kunciList = kunciJawabanString.toLowerCase()
                                      .split(/[/|()]/)
                                      .map(s => s.trim())
                                      .filter(Boolean);
            let foundPerfectMatch = false;
            let foundTypoMatch = false;
            if (kunciList.includes(jawabanSantriNorm)) {
                foundPerfectMatch = true;
            }
            if (!foundPerfectMatch) {
                for (const kunci of kunciList) {
                    if (kunci.length > 3) { 
                        const distance = getLevenshteinDistance(jawabanSantriNorm, kunci);
                        const toleransiTypo = (kunci.length > 8) ? 2 : 1;
                        if (distance <= toleransiTypo) {
                            foundTypoMatch = true;
                            break; 
                        }
                    }
                }
            }
            
            if (foundPerfectMatch) {
                poinDidapat = poinSoal; // Benar 100%
            } else if (foundTypoMatch) {
                poinDidapat = (poinSoal * 0.75); // Benar 75% (typo)
            }
        }

        // --- (PERBAIKAN LOGIKA PENALTI) ---
        // Jika bantuan dipakai DAN jawabannya benar (poin > 0),
        // potong poinnya jadi 50%
        if (wasHelpUsed && poinDidapat > 0) {
            poinDidapat = (poinSoal * 0.5); 
        }
        totalPoinSantri += poinDidapat;
        // --- AKHIR PERBAIKAN ---
    });

    // (Sisa fungsi ini sama persis seperti sebelumnya)
    const score = totalPoinMaksimal > 0 ? Math.round((totalPoinSantri / totalPoinMaksimal) * 100) : 0;
    let finalScore;
    const previousAttempts = currentAttemptHistory ? currentAttemptHistory.percobaan : 0;
    const firstScore = currentAttemptHistory ? currentAttemptHistory.skor : score;
    const isRemedial = previousAttempts === 1;
    if (previousAttempts > 0) {
        const highestPreviousScore = currentAttemptHistory.skorAkhir || currentAttemptHistory.skor || 0;
        let remedialScore = score; 
        if (remedialScore > 80) { remedialScore = 80; }
		finalScore = Math.max(highestPreviousScore, remedialScore);
    } else {
        finalScore = score;
    }
    if(isForceSubmit) {
        logAction('UJIAN_DIAKHIRI_PAKSA', `Pelanggaran ke-${fullscreenExitCount}`);
    } else {
        logAction('UJIAN_SELESAI', `Skor Akhir: ${finalScore}`);
    }
    const resultScoreEl = document.getElementById('result-score');
    const resultMessageEl = document.getElementById('result-message');
    const resultActionsEl = document.getElementById('result-actions');
    const session = getActiveSession();
    const isGabungan = (currentExamData.jenis === 'UTS' || currentExamData.jenis === 'UAS');
    if (!isGabungan) {
        const dataToSave = {
            action: 'simpanNilaiUjian',
            username: session.username,
            namaSantri: session.userData.profileName,
            kodeMateri: currentExamData.materiList[0], 
            judulMateri: currentExamData.title,
            skor: firstScore,      
            skorAkhir: finalScore  
        };
        fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(dataToSave),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        }).then(res => res.json()).then(result => {
            if (result.status !== 'success') { console.error("Gagal menyimpan nilai:", result.message); }
        }).catch(err => console.error("Error saat menyimpan nilai:", err));
    } else {
        console.log("Ujian Gabungan Selesai (Tidak disimpan ke 'nilai' secara individu):", finalScore);
    }
    resultScoreEl.textContent = finalScore;
    if (finalScore >= 80) {
        resultScoreEl.className = 'text-8xl font-bold my-8 pass';
        resultMessageEl.textContent = 'Selamat, nilai Anda sangat baik! Nilai akhir Anda akan dicatat di KHS.';
        resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
    } else if (finalScore >= 75 && finalScore <= 79) {
        resultScoreEl.className = 'text-8xl font-bold my-8 pass';
        if (isRemedial) {
             resultMessageEl.textContent = `Selamat, Anda lulus! Nilai akhir Anda (${finalScore}) akan dicatat di KHS.`;
             resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
        } else {
            resultMessageEl.textContent = `Anda sudah lulus (KKM 75), namun Anda bisa mencoba 1x lagi untuk memperbaiki nilai (maksimal 80).`;
            resultActionsEl.innerHTML = `<button id="result-remedial-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">Ujian Ulang</button>
                                         <button id="result-later-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg mt-2">Cukup</button>`;
        }
    } else { 
        resultScoreEl.className = 'text-8xl font-bold my-8 fail';
        if (previousAttempts >= 2) {
            resultMessageEl.textContent = `Anda telah menyelesaikan remedial. Nilai akhir Anda (${finalScore}) akan dicatat di KHS.`;
            resultActionsEl.innerHTML = `<button id="result-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg">Selesai</button>`;
        } else {
            resultMessageEl.textContent = 'Anda belum mencapai nilai minimum. Anda diberi kesempatan untuk 1x remedial.';
            resultActionsEl.innerHTML = `<button id="result-remedial-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-lg">Mulai Remedial</button>
                                         <button id="result-later-btn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg mt-2">Nanti Saja</button>`;
        }
    }
    document.getElementById('exam-container').classList.add('hidden');
    document.getElementById('exam-result-modal').style.display = 'block';
	isExamInProgress = false;
}

function closeResultModal() {
    document.getElementById('exam-result-modal').style.display = 'none';
    firstAttemptScore = null;
	window.location.hash = '#ujian-online';
    renderExamSchedule(); // Muat ulang jadwal untuk update status tombol
}

function startRemedial() {
    document.getElementById('exam-result-modal').style.display = 'none';
    enterFullscreen(document.documentElement);
    startExam();
}

function enterFullscreen(element) {
    if (element.requestFullscreen) { element.requestFullscreen(); } 
    else if (element.mozRequestFullScreen) { element.mozRequestFullScreen(); } 
    else if (element.webkitRequestFullscreen) { element.webkitRequestFullscreen(); } 
    else if (element.msRequestFullscreen) { element.msRequestFullscreen(); }
}

function exitFullscreen() {
    if (document.exitFullscreen) { document.exitFullscreen(); } 
    else if (document.mozCancelFullScreen) { document.mozCancelFullScreen(); } 
    else if (document.webkitExitFullscreen) { document.webkitExitFullscreen(); }
}

function playAlarm() {
    // Cek lagi untuk memastikan alarm hanya berbunyi saat ujian berlangsung
    if (isExamInProgress) {
        
        // (PERBAIKAN BUG 2) Mainkan audio yang sudah di-"prime"
        alarmSound.play().catch(error => {
            console.error("Gagal memutar audio:", error);
        });
        
        // (PERBAIKAN BUG 3) Tampilkan modal peringatan, jangan paksa fullscreen
        const warningModal = document.getElementById('fullscreenWarningModal');
        warningModal.style.display = 'flex'; 
        // (DIHAPUS) Baris 'enterFullscreen(warningModal);' dihapus karena menyebabkan error.
    }
}

/**
 * Fungsi baru untuk admin keluar paksa dari mode ujian.
 */
function forceExitExamByAdmin() {
    console.log("Shortcut admin terdeteksi. Menghentikan ujian.");
    isExamInProgress = false; // Hentikan status ujian untuk mencegah peringatan lain
    exitFullscreen(); // Keluar dari mode fullscreen
    alarmSound.pause(); // Matikan alarm jika berbunyi
    alarmSound.currentTime = 0;
    
    // Sembunyikan semua elemen terkait ujian
    document.getElementById('exam-container').classList.add('hidden');
    document.getElementById('fullscreenWarningModal').style.display = 'none';

    showMessage('Ujian dihentikan paksa oleh Admin.', 'success');
    
    // Arahkan kembali ke halaman daftar ujian
    window.location.hash = '#ujian-online';
    renderExamSchedule();
}

function setupExamSecurityListeners() {
    document.addEventListener('fullscreenchange', () => {
        if (document.fullscreenElement) {
            // Pengguna KEMBALI ke fullscreen
            alarmSound.pause();
            alarmSound.currentTime = 0;
            document.getElementById('fullscreenWarningModal').style.display = 'none';
            
            // --- (BARU) KIRIM LOG INI KE PENGAWAS ---
            logAction('AKSES_KEMBALI', 'Santri kembali ke mode layar penuh.');
            // --- AKHIR KODE BARU ---

        } else if (isExamInProgress) {
            // Pengguna KELUAR dari fullscreen
			logAction('PELANGGARAN', 'Keluar dari mode layar penuh.');
            playAlarm();
        }
    });

    document.addEventListener('visibilitychange', () => {
        if (document.hidden && isExamInProgress) {
		logAction('PELANGGARAN', 'Pindah tab atau aplikasi lain.');
            playAlarm();
        }
    });

    document.getElementById('reenterFullscreenBtn').addEventListener('click', () => {
        enterFullscreen(document.documentElement);
    });

    // --- BLOK BARU DITAMBAHKAN DI SINI ---
    // Listener untuk mendeteksi shortcut admin
    document.addEventListener('keydown', function(e) {
        const session = getActiveSession();
        

        // Cek jika ujian sedang berlangsung DAN user adalah admin
        if (isExamInProgress) {
            // Cek kombinasi tombol: CTRL + SHIFT + ALT + X
            if (e.ctrlKey && e.shiftKey && e.altKey && e.key.toLowerCase() === 'x') {
                e.preventDefault(); // Mencegah aksi default browser
                forceExitExamByAdmin();
            }
        }
    });
    // --- AKHIR BLOK BARU ---
}

function timeAgo(date) {
        if (!date) return "N/A";
        const now = new Date();
        const past = new Date(date);
        const seconds = Math.floor((now - past) / 1000);
        
        let interval = seconds / 31536000;
        if (interval > 1) return Math.floor(interval) + " tahun lalu";
        interval = seconds / 2592000;
        if (interval > 1) return Math.floor(interval) + " bulan lalu";
        interval = seconds / 86400;
        if (interval > 1) return Math.floor(interval) + " hari lalu";
        interval = seconds / 3600;
        if (interval > 1) return Math.floor(interval) + " jam lalu";
        interval = seconds / 60;
        if (interval > 1) return Math.floor(interval) + " menit lalu";
        return "Baru saja";
    }

let tahfidzChartInstance = null;
let murajaahChartInstance = null;
let hafalanChartInstance = null;
let quillEditor = null; // <-- (BARU) TAMBAHKAN VARIABEL INI
let quillEditorGuru = null;
// --- (BARU) VARIABEL UNTUK FITUR BANTUAN UJIAN ---
let helpPgUsedCount = 0;
let helpIsianUsedCount = 0;
const HELP_PG_LIMIT = 3;
const HELP_ISIAN_LIMIT = 2;
let helpUsedOnQuestion = {}; // Melacak soal mana yg sudah pakai bantuan
// --- AKHIR BLOK BARU ---


async function renderTahfidzChart(santriName, startDate, endDate) {
    const container = document.getElementById('ziyadah-chart-content');
    container.innerHTML = '<canvas id="tahfidzChart" style="height: 400px;"></canvas>';
    const ctx = document.getElementById('tahfidzChart').getContext('2d');

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getSantriTahfidzDetail', santriName, startDate, endDate })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        // --- (PERBAIKAN BUG DI SINI) ---
        // Filter lama (salah): const ziyadahData = result.data.filter(item => item.details && !item.details.includes('Muraja\'ah'));
        // Filter baru (benar): Kita memfilter berdasarkan 'label'
        const ziyadahData = result.data.filter(item => !item.label.startsWith('Murajaah'));
        // --- (AKHIR PERBAIKAN) ---

        const labels = ziyadahData.map(item => item.label); // Label sekarang hanya tanggal
        const points = ziyadahData.map(item => item.points); // Poin sekarang adalah rata-rata P/S

        if (tahfidzChartInstance) {
            tahfidzChartInstance.destroy();
        }

        tahfidzChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    type: 'line',
                    label: 'Poin',
                    data: points,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.5)',
                    yAxisID: 'y_poin',
                }, {
                    type: 'bar',
                    label: 'Setoran',
                    data: points,
                    backgroundColor: 'rgba(44, 94, 46, 0.7)',
                    yAxisID: 'y_poin',
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const item = ziyadahData[context.dataIndex];
                                const poin = item.points ? item.points.toFixed(1) : '0';
                                
                                let label = `Poin (Rata-rata): ${poin}`;
                                
                                // (Logika tooltip ini sudah benar)
                                if (item.details && item.details.length > 0) {
                                    const detailsList = item.details.split(' | ').join('\n');
                                    label += `\n\nSetoran:\n${detailsList}`;
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y_poin: { beginAtZero: true, position: 'left', title: { display: true, text: 'Poin' } }
                }
            }
        });
    } catch (error) {
        console.error("Gagal membuat grafik Ziyadah:", error);
    }
}

function calculateDecayColor(latestPoin, lastDateStr) {
    let R, G, B;

    // 1. Tentukan Warna Dasar berdasarkan Poin (latestPoin)
    if (latestPoin >= 9)      { R = 59; G = 130; B = 246; } // Biru
    else if (latestPoin > 7)  { R = 22; G = 163; B = 74;  } // Hijau
    else if (latestPoin > 5)  { R = 234; G = 179; B = 8;   } // Kuning
    else if (latestPoin > 0)  { R = 220; G = 38; B = 38;   } // Merah
    else                      { R = 156; G = 163; B = 175; } // Abu-abu (jika poin 0)

    // 2. Tentukan Opacity berdasarkan Tanggal (lastDateStr)
    let opacity = 1.0; // Default: solid

    if (lastDateStr) {
        const today = new Date();
        const lastDate = new Date(lastDateStr);
        const diffTime = Math.abs(today - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        // (PERUBAHAN REQ 2 & 3) Logika pudar per 3 bulan (90 hari)
        if (diffDays <= 90) {         // 0-3 Bulan (Fresh)
            opacity = 1.0;
        } else if (diffDays <= 180) { // 3-6 Bulan
            opacity = 0.75;
        } else if (diffDays <= 270) { // 6-9 Bulan
            opacity = 0.5;
        } else if (diffDays <= 365) { // 9-12 Bulan
            opacity = 0.25;
        } else {                      // > 1 Tahun
            opacity = 0.1;
        }
    }
    
    return `rgba(${R}, ${G}, ${B}, ${opacity})`;
}


/**
 * FUNGSI YANG DIPERBAIKI (V4.1): Merender Grafik Muraja'ah
 * 1. (FIX) Menerapkan Ide 1 (Grafik Simpel)
 * 2. (FIX) Menerapkan Ide 2 (Warna Memudar + Warna Poin)
 */
async function renderMurajaahJuzChart(santriName) {
    const container = document.getElementById('murajaah-chart-content');
    container.innerHTML = '<canvas id="murajaahChart" style="height: 400px;"></canvas>';
    const ctx = document.getElementById('murajaahChart').getContext('2d');

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getMurajaahJuzReport', santriName: santriName })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        const filteredReport = result.report.filter(item => item.percent > 0); 

        if (filteredReport.length === 0) {
            container.innerHTML = '<p class="p-8 text-center text-gray-500">Belum ada progres muraja\'ah yang tercatat untuk santri ini.</p>';
            if (murajaahChartInstance) {
                murajaahChartInstance.destroy();
            }
            return;
        }

        const labels = filteredReport.map(item => `Juz ${item.juz}`);
        const percentages = filteredReport.map(item => item.percent);
        
        const barColors = filteredReport.map(item => 
            calculateDecayColor(item.avgPoin, item.tanggalSetoranTerakhir)
        );
        const now = new Date();
        const barGlows = filteredReport.map(item => {
            if (!item.tanggalSetoranTerakhir) return 0;
            const diffDays = (now - new Date(item.tanggalSetoranTerakhir)) / (1000 * 60 * 60 * 24);
            return (diffDays <= 90) ? 10 : 0;
        });

        if (murajaahChartInstance) {
            murajaahChartInstance.destroy();
        }

        murajaahChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels, 
                datasets: [{
                    label: 'Persentase Selesai',
                    data: percentages, 
                    backgroundColor: barColors,
                    borderColor: barColors.map(color => color.replace(/, [0-9.]+\)/, ', 1)')),
                    borderWidth: 1,
                    shadowColor: barColors, 
                    shadowBlur: barGlows,   
                    shadowOffsetX: 0,
                    shadowOffsetY: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        // --- (PERBAIKAN TOOLTIP DI SINI) ---
                        callbacks: {
                            label: function(context) {
                                const item = filteredReport[context.dataIndex];
                                const avgPoin = item.avgPoin ? item.avgPoin.toFixed(1) : '0';
                                
                                // Request 1: Berapa kali dimurajaah
                                const reviewCountText = `Dimuraja'ah: ${item.reviewCount || 0} kali`;
                                
                                // Request 2: Sudah berapa lama
                                let dateText = 'Belum tersetor';
                                if (item.tanggalSetoranTerakhir) {
                                    // Panggil helper timeAgo
                                    dateText = `Terakhir: ${timeAgo(item.tanggalSetoranTerakhir)}`;
                                }
                                
                                // Kembalikan sebagai array agar tampil jadi beberapa baris
                                return [
                                    `Status: ${item.percent}% | Poin: ${avgPoin}`,
                                    reviewCountText,
                                    dateText
                                ];
                            }
                        }
                        // --- (AKHIR PERBAIKAN TOOLTIP) ---
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: value => value + '%' }
                    },
                    x: { 
                        ticks: { 
                            autoSkip: false, 
                            maxRotation: 90, 
                            minRotation: 45 
                        } 
                    }
                }
            }
        });

    } catch (error) {
        console.error("Gagal membuat grafik Muraja'ah:", error);
        container.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat grafik: ${error.message}</p>`;
    }
}

async function renderSantriHafalanChart(santriName) {
    const container = document.getElementById('hafalan-chart-content'); 
    if (!container) { console.error("Gagal menemukan kontainer #hafalan-chart-content"); return; }
    
    container.innerHTML = '<canvas id="hafalanChart" style="height: 400px;"></canvas>';
    const ctx = document.getElementById('hafalanChart').getContext('2d');

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getMurajaahJuzReport', santriName: santriName })
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        const filteredReport = result.report.filter(item => item.percent > 0); 

        if (filteredReport.length === 0) {
            container.innerHTML = '<p class="p-8 text-center text-gray-500">Belum ada progres muraja\'ah yang tercatat untuk Anda.</p>';
            if (hafalanChartInstance) { 
                hafalanChartInstance.destroy();
            }
            return;
        }

        const labels = filteredReport.map(item => `Juz ${item.juz}`);
        const percentages = filteredReport.map(item => item.percent);
        
        const barColors = filteredReport.map(item => 
            calculateDecayColor(item.avgPoin, item.tanggalSetoranTerakhir)
        );
        const now = new Date();
        const barGlows = filteredReport.map(item => {
            if (!item.tanggalSetoranTerakhir) return 0;
            const diffDays = (now - new Date(item.tanggalSetoranTerakhir)) / (1000 * 60 * 60 * 24);
            return (diffDays <= 90) ? 10 : 0;
        });

        if (hafalanChartInstance) { 
            hafalanChartInstance.destroy();
        }
        
        hafalanChartInstance = new Chart(ctx, { 
            type: 'bar',
            data: {
                labels: labels, 
                datasets: [{
                    label: 'Persentase Selesai',
                    data: percentages, 
                    backgroundColor: barColors,
                    borderColor: barColors.map(color => color.replace(/, [0-9.]+\)/, ', 1)')),
                    borderWidth: 1,
                    shadowColor: barColors, 
                    shadowBlur: barGlows,   
                    shadowOffsetX: 0,
                    shadowOffsetY: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        // --- (PERBAIKAN TOOLTIP DI SINI) ---
                        callbacks: {
                            label: function(context) {
                                const item = filteredReport[context.dataIndex];
                                const avgPoin = item.avgPoin ? item.avgPoin.toFixed(1) : '0';
                                
                                // Request 1: Berapa kali dimurajaah
                                const reviewCountText = `Dimuraja'ah: ${item.reviewCount || 0} kali`;
                                
                                // Request 2: Sudah berapa lama
                                let dateText = 'Belum tersetor';
                                if (item.tanggalSetoranTerakhir) {
                                    // Panggil helper timeAgo
                                    dateText = `Terakhir: ${timeAgo(item.tanggalSetoranTerakhir)}`;
                                }
                                
                                // Kembalikan sebagai array agar tampil jadi beberapa baris
                                return [
                                    `Status: ${item.percent}% | Poin: ${avgPoin}`,
                                    reviewCountText,
                                    dateText
                                ];
                            }
                        }
                        // --- (AKHIR PERBAIKAN TOOLTIP) ---
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: { callback: value => value + '%' }
                    },
                    x: { 
                        ticks: { 
                            autoSkip: false, 
                            maxRotation: 90, 
                            minRotation: 45 
                        } 
                    }
                }
            }
        });

    } catch (error) {
        console.error("Gagal membuat grafik Hafalan santri:", error);
        container.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat grafik: ${error.message}</p>`;
    }
}

/**
 * Fungsi untuk membuat atau menghapus titik notifikasi di navigasi.
 */
function updateNavNotifications(count) {
    const navLinks = ['#sistemInformasiNav .nav-link-wrapper', '#halamanGuruNav .nav-link-wrapper'];

    navLinks.forEach(selector => {
        const wrapper = document.querySelector(selector);
        if (!wrapper) return;

        // Hapus notifikasi lama jika ada
        const oldDot = wrapper.querySelector('.notification-dot');
        if (oldDot) oldDot.remove();

        // Tambahkan notifikasi baru jika count > 0
        if (count > 0) {
            const dot = document.createElement('span');
            dot.className = 'notification-dot';
            dot.textContent = count;
            wrapper.appendChild(dot);
        }
    });
}

/**
 * Fungsi untuk mengambil data notifikasi dari server dan menampilkannya.
 */
async function fetchAndShowTeacherNotifications() {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getMissingKeysCountForGuru', namaGuru: session.userData.profileName }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if (result.status === 'success') {
            updateNavNotifications(result.count);
        }
    } catch(error) {
        console.error("Gagal mengambil notifikasi:", error);
    }
}

// =======================================================
// === FUNGSI-FUNGSI BARU UNTUK HALAMAN PENGAWAS UJIAN ===
// =======================================================
let proctorInterval = null; // Variabel untuk menyimpan interval refresh
let seenViolationTimestamps = new Set(); // Pindahkan Set ke scope global

/**
 * (DIPERBARUI V2) Fungsi setup Halaman Pengawas Ujian
 * - Menambah tombol stop manual
 * - Alarm berhenti otomatis saat santri kembali
 */
function setupPengawasUjianPage() {
    if (proctorInterval) clearInterval(proctorInterval);

    const proctorGridContainer = document.getElementById('proctor-grid-container');
    const alarmAudio = document.getElementById('proctor-alarm-sound');
    const stopAlarmBtn = document.getElementById('proctor-stop-alarm-btn'); 

    seenViolationTimestamps.clear(); 
    let isAudioUnlocked = false;

    const stopProctorAlarm = () => {
        if (!alarmAudio) return;
        alarmAudio.pause();
        alarmAudio.currentTime = 0;
        stopAlarmBtn.classList.add('hidden'); 
    };

    const playProctorAlarm = () => {
        if (!alarmAudio) return;
        
        stopAlarmBtn.classList.remove('hidden'); 
        alarmAudio.volume = 1.0;
        alarmAudio.currentTime = 0;
        const playPromise = alarmAudio.play();
        
        if (playPromise !== undefined) {
            playPromise.then(_ => {
                isAudioUnlocked = true;
            }).catch(error => {
                console.warn("Audio alarm gagal diputar:", error);
                if (!isAudioUnlocked) {
                    showMessage('Audio alarm diblokir. Klik halaman untuk mengaktifkan.', 'error');
                    document.body.addEventListener('click', () => {
                        alarmAudio.play();
                        isAudioUnlocked = true;
                    }, { once: true });
                }
            });
        }
    };

    stopAlarmBtn.addEventListener('click', stopProctorAlarm);

    const refreshProctorView = async () => {
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                // --- (PERBAIKAN 1: BUG CACHE) ---
                body: JSON.stringify({ 
                    action: 'getSantriActivityLogs',
                    cacheBuster: new Date().getTime() // Ini membuat request selalu unik
                }),
                // --- AKHIR PERBAIKAN ---
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            const allLogs = result.data;

            const logsBySantri = allLogs.reduce((acc, log) => {
                if (!acc[log.Username]) {
                    acc[log.Username] = {
                        profileName: log.ProfileName,
                        logs: []
                    };
                }
                acc[log.Username].logs.push(log);
                return acc;
            }, {});

            let activeSantriUsernames = [];
            for (const username in logsBySantri) {
                const userLogs = logsBySantri[username].logs;
                const lastLog = userLogs.sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp))[0];
                if (lastLog) {
                    const lastActionTime = new Date(lastLog.Timestamp);
                    if ((new Date() - lastActionTime) < (1 * 60 * 60 * 1000)) { 
                        activeSantriUsernames.push(username);
                    }
                }
            }

            document.querySelectorAll('.santri-proctor-card').forEach(card => {
                const username = card.id.replace('proctor-card-', '');
                if (!activeSantriUsernames.includes(username)) {
                    card.remove();
                }
            });

            if (activeSantriUsernames.length === 0) {
                proctorGridContainer.innerHTML = '<p class="col-span-full text-center text-gray-500">Tidak ada santri yang sedang ujian saat ini.</p>';
            }

            activeSantriUsernames.sort((a, b) => logsBySantri[a].profileName.localeCompare(logsBySantri[b].profileName));

            activeSantriUsernames.forEach(username => {
                const santriData = logsBySantri[username];
                
                let santriCard = document.getElementById(`proctor-card-${username}`);
                if (!santriCard) {
                    santriCard = document.createElement('div');
                    santriCard.className = 'santri-proctor-card';
                    santriCard.id = `proctor-card-${username}`;
                    proctorGridContainer.appendChild(santriCard);
                }

                const sortedLogs = santriData.logs.sort((a,b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                let logHTML = '';
                let hasNewViolation = false;
                let hasReturned = false; 

                sortedLogs.forEach(log => {
                    const time = new Date(log.Timestamp).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const timestamp = new Date(log.Timestamp).getTime();
                    let color = 'text-gray-700';
                    
                    const isViolation = log.ActionType.includes('PELANGGARAN');
                    const isReturn = log.ActionType.includes('AKSES_KEMBALI'); 

                    if (isViolation) {
                        color = 'text-red-600 font-bold';
                        if (!seenViolationTimestamps.has(timestamp)) {
                            hasNewViolation = true;
                            seenViolationTimestamps.add(timestamp);
                            playProctorAlarm(); 
                        }
                    } else if (isReturn) { 
                        color = 'text-green-600 font-bold'; 
                        if (!seenViolationTimestamps.has(timestamp)) {
                            hasReturned = true;
                            seenViolationTimestamps.add(timestamp);
                            stopProctorAlarm(); 
                        }
                    }
                    
                    logHTML += `<p class="${color}"><span class="text-gray-400 mr-2">${time}</span>${log.ActionDetail}</p>`;
                });

                santriCard.innerHTML = `
                    <div class="header">${santriData.profileName}</div>
                    <div class="log-container">${logHTML}</div>
                `;
                
                if (hasNewViolation) {
                    santriCard.classList.add('flash-red-alert');
                    setTimeout(() => santriCard.classList.remove('flash-red-alert'), 3000);
                }

                if (hasReturned) {
                    santriCard.classList.remove('flash-red-alert');
                }
            });

            const placeholder = proctorGridContainer.querySelector('p');
            if (placeholder && activeSantriUsernames.length > 0) {
                placeholder.remove();
            }

        } catch (error) {
            proctorGridContainer.innerHTML = `<p class="col-span-full text-center text-red-500">${error.message}</p>`;
        }
    };
    
    refreshProctorView();
    
    // --- (PERBAIKAN 2: REALTIME) ---
    // Mengganti 7000ms (7 detik) menjadi 3000ms (3 detik)
    proctorInterval = setInterval(refreshProctorView, 3000);
    // --- AKHIR PERBAIKAN ---
}

// Fungsi untuk membersihkan interval saat pindah halaman
function cleanupPengawasUjianPage() {
    if (proctorInterval) {
        clearInterval(proctorInterval);
        proctorInterval = null;
    }
}

// =======================================================
// === FUNGSI-FUNGSI UNTUK INPUT SOAL ===
// =======================================================
// BARU: Fungsi untuk menangani unggah gambar di editor Quill
function imageUploadHandler(quillInstance) {
    const toolbar = quillInstance.getModule('toolbar');
    toolbar.addHandler('image', () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            if (/^image\//.test(file.type)) {
                showLoading();
                try {
                    // Kompresi gambar sebelum diunggah
                    const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280 };
                    const compressedFile = await imageCompression(file, options);

                    const formData = new FormData();
                    formData.append('file', compressedFile, file.name);
                    formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET);

                    const response = await fetch(CONFIG.CLOUDINARY_URL, { method: 'POST', body: formData });
                    if (!response.ok) throw new Error('Gagal mengunggah gambar.');

                    const data = await response.json();
                    const imageUrl = data.secure_url;

                    // Masukkan URL gambar ke dalam editor
                    const range = quillInstance.getSelection(true);
                    quillInstance.insertEmbed(range.index, 'image', imageUrl);
                    quillInstance.setSelection(range.index + 1);

                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading();
                }
            } else {
                showMessage('Hanya file gambar yang diizinkan.', 'error');
            }
        };
    });
}

/**
 * Menangani unggah gambar kustom untuk editor Quill.
 * Mengompres gambar, mengunggah ke Cloudinary, dan memasukkan URL.
 */
function imageUploadHandler(quillInstance) {
    const toolbar = quillInstance.getModule('toolbar');
    toolbar.addHandler('image', () => {
        const input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.click();

        input.onchange = async () => {
            const file = input.files[0];
            if (/^image\//.test(file.type)) {
                showLoading(); // Tampilkan loading
                try {
                    // 1. Kompresi gambar sebelum diunggah
                    const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280 };
                    const compressedFile = await imageCompression(file, options);

                    // 2. Siapkan data untuk Cloudinary
                    const formData = new FormData();
                    formData.append('file', compressedFile, file.name);
                    formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET);

                    // 3. Unggah ke Cloudinary
                    const response = await fetch(CONFIG.CLOUDINARY_URL, { 
                        method: 'POST', 
                        body: formData 
                    });
                    
                    if (!response.ok) throw new Error('Gagal mengunggah gambar ke Cloudinary.');

                    const data = await response.json();
                    const imageUrl = data.secure_url; // Dapatkan URL yang aman (https)

                    // 4. Masukkan URL gambar ke dalam editor
                    const range = quillInstance.getSelection(true);
                    quillInstance.insertEmbed(range.index, 'image', imageUrl);
                    quillInstance.setSelection(range.index + 1);

                } catch (error) {
                    showMessage(`Error: ${error.message}`, 'error');
                } finally {
                    hideLoading(); // Sembunyikan loading
                }
            } else {
                showMessage('Hanya file gambar yang diizinkan.', 'error');
            }
        };
    });
}

async function uploadPastedImage(base64Data) {
    showLoading(); // Tampilkan loading
    try {
        // 1. Ubah data Base64 kembali menjadi file (blob)
        const blob = await (await fetch(base64Data)).blob();
        
        // 2. Kompres file
        const options = { maxSizeMB: 0.5, maxWidthOrHeight: 1280 };
        const compressedFile = await imageCompression(blob, options);
        
        // 3. Siapkan untuk upload ke Cloudinary
        const formData = new FormData();
        formData.append('file', compressedFile, 'pasted-image.png');
        formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET); // Pastikan preset ini ada

        // 4. Upload ke Cloudinary
        const response = await fetch(CONFIG.CLOUDINARY_URL, { 
            method: 'POST', 
            body: formData 
        });
        
        if (!response.ok) throw new Error('Gagal mengunggah gambar yang di-paste.');
        
        const data = await response.json();
        return data.secure_url; // Kembalikan URL yang aman
    } catch (error) {
        showMessage(`Error (Paste): ${error.message}`, 'error');
        return null;
    } finally {
        hideLoading(); // Sembunyikan loading
    }
}

function setupInputSoalPage() {
    const materiSelectBulanan = document.getElementById('materi-soal-select');
    const jenisUjianSelect = document.getElementById('input-jenis-ujian');
    const previewContainer = document.getElementById('soal-preview-container');
    const simpanBtn = document.getElementById('simpan-soal-btn');

    quillEditor = new Quill('#quill-editor-container', {
        theme: 'snow',
        modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], ['link', 'image', 'formula'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] },
        placeholder: 'Tempel (paste) soal dari MS. Word di sini...\n\nFORMAT YANG DITERIMA:\n\n1. Soal Pilihan Ganda\n   a. Opsi A\n   b. Opsi B\n   c. Opsi D\n   Kunci Jawaban : B (atau tebalkan opsi B)\n\n2. Soal Isian\n   Pertanyaan soal isian...\n   Kunci Jawaban : Jawaban Benar (Sinonim bisa pakai | atau /)\n   Contoh Kunci: Oksigen (O2) / Oxygen'
    });
    
    imageUploadHandler(quillEditor); 
    quillEditor.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
        if (node.tagName === 'IMG' && node.src && node.src.startsWith('data:image/')) {
            const range = quillEditor.getSelection(true) || { index: 0 };
            quillEditor.insertEmbed(range.index, 'image', 'https://placehold.co/100x100/e9ecef/6c757d?text=Uploading...');
            uploadPastedImage(node.src)
                .then(url => {
                    if (url) {
                        quillEditor.deleteText(range.index, 1);
                        quillEditor.insertEmbed(range.index, 'image', url);
                        quillEditor.setSelection(range.index + 1);
                    } else {
                        quillEditor.deleteText(range.index, 1);
                    }
                    const isChecked = document.getElementById('auto-fill-keys-checkbox') ? document.getElementById('auto-fill-keys-checkbox').checked : true;
                    renderSoalPreview(quillEditor.root.innerHTML, isChecked);
                });
        }
        return delta; 
    });

    if (materiSelectBulanan && materiSelectBulanan.options.length <= 1) {
        const uniqueSubjects = {};
        Object.values(appState.processedSchedules).flat().forEach(item => {
            if (item.subject && item.subject.includes(':')) {
                const code = item.subject.split(':')[0].trim();
                if (!uniqueSubjects[code]) {
                    uniqueSubjects[code] = item.subject;
                }
            }
        });
        materiSelectBulanan.innerHTML = '<option value="">Pilih Materi...</option>';
        const sortedSubjects = Object.entries(uniqueSubjects).sort((a,b) => a[1].localeCompare(b[1]));
        sortedSubjects.forEach(([code, subject]) => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = subject;
            materiSelectBulanan.appendChild(option);
        });
    }
    jenisUjianSelect.addEventListener('change', (e) => { /* Tidak ada aksi UI */ });

    let typingTimer;
    quillEditor.on('text-change', () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            const isAutoFillChecked = document.getElementById('auto-fill-keys-checkbox') 
                ? document.getElementById('auto-fill-keys-checkbox').checked 
                : true;
            renderSoalPreview(quillEditor.root.innerHTML, isAutoFillChecked);
        }, 300);
    });
    previewContainer.addEventListener('change', (event) => {
        if (event.target.id === 'auto-fill-keys-checkbox') {
            renderSoalPreview(quillEditor.root.innerHTML, event.target.checked);
        }
    });

    /**
     * (PERBAIKAN POIN OTOMATIS ADA DI FUNGSI INI)
     */
    function renderSoalPreview(fullHtml, isAutoFillChecked) {
        const autoFillKeys = isAutoFillChecked;
        const soalArray = fullHtml.split(/(?=<p[^>]*>(?:Soal\s+)?\s*\d+[.)])/i).map(s => s.trim()).filter(Boolean);

        if (soalArray.length === 0) {
            document.getElementById('soal-preview-container').innerHTML = `<p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini.</p>`;
            document.getElementById('simpan-soal-btn').classList.add('hidden');
            return;
        }
        
        // --- (PERBAIKAN BUG POIN OTOMATIS) ---
        const poinPerSoal = Math.round((100 / soalArray.length) * 100) / 100;
        // --- AKHIR PERBAIKAN ---

        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Isi Soal</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-48">
                            <div class="flex items-center">
                                <span>Kunci Jawaban</span>
                                <input type="checkbox" id="auto-fill-keys-checkbox" class="ml-2 h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" title="Otomatis deteksi kunci jawaban" ${autoFillKeys ? 'checked' : ''}>
                            </div>
                        </th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Poin</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

        // (Regex deteksi dan pembersihan sudah benar)
        const keyTextRegex = /<p[^>]*>Kunci Jawaban\s*:\s*(.*?)<\/p>|Kunci Jawaban\s*:\s*(.*?)(?=<br>|$)/i;
        const boldRegex = /<(strong|b)[^>]*>\s*([A-D])[.)\s]/i;
        const boldReplaceRegex = /<(strong|b)[^>]*>(\s*[A-D][.)\s])/i;
        const numberRegex = /(<p[^>]*>)(?:Soal\s+)?\s*\d+[.)]\s*/i; 
        const allOptionsRegex = /<p[^>]*>\s*[a-d][.)].*?<\/p>/gi;

        soalArray.forEach((soalHtml, index) => {
            let kunciJawaban = '';
            let isPG = false; 

            if (autoFillKeys) {
                const keyMatch = soalHtml.match(keyTextRegex);
                if (keyMatch) {
                    let keyText = (keyMatch[1] || keyMatch[2] || '').trim().replace(/<[^>]+>/g, '').trim();
                    const pgMatch = keyText.match(/^([A-D])([.)\s]*)?$/i); 
                    if (pgMatch) {
                        kunciJawaban = pgMatch[1].toUpperCase();
                        isPG = true; 
                    } else {
                        kunciJawaban = keyText;
                    }
                }
                if (!kunciJawaban) {
                    const boldMatch = soalHtml.match(boldRegex);
                    if (boldMatch) {
                        kunciJawaban = boldMatch[2].toUpperCase();
                        isPG = true; 
                    }
                }
            }
            let cleanedSoalHtml = soalHtml.replace(keyTextRegex, ''); 
            if (isPG) {
                cleanedSoalHtml = cleanedSoalHtml.replace(boldReplaceRegex, '$2');
            } else if (kunciJawaban !== '') {
                cleanedSoalHtml = cleanedSoalHtml.replace(allOptionsRegex, '');
            }
            cleanedSoalHtml = cleanedSoalHtml.replace(numberRegex, '$1'); 

            tableHTML += `
                <tr class="soal-row">
                    <td class="px-4 py-3 align-top">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${cleanedSoalHtml}</td>
                    <td class="px-4 py-3 align-top">
                        <input type="text" class="kunci-jawaban-input w-full p-2 border rounded-md" value="${kunciJawaban}" placeholder="${autoFillKeys ? 'Otomatis...' : 'Isi manual...'}">
                    </td>
                    <td class="px-4 py-3 align-top">
                        <input type="number" step="0.01" class="poin-soal-input w-full p-2 border rounded-md" value="${poinPerSoal}">
                    </td>
                </tr>
            `;
        });
        tableHTML += `</tbody></table>`;
        document.getElementById('soal-preview-container').innerHTML = tableHTML;
        document.getElementById('simpan-soal-btn').classList.remove('hidden');
    }

    if (simpanBtn) {
        simpanBtn.addEventListener('click', handleSimpanSoal);
    }
}

// GANTI FUNGSI INI SECARA KESELURUHAN
async function handleSimpanSoal() {
    const materiKode = document.getElementById('materi-soal-select').value;
    
    // (BARU) Ambil nilai dari dropdown Jenis Ujian
    const jenisUjian = document.getElementById('input-jenis-ujian').value;

    if (!materiKode) {
        showMessage('Silakan pilih materi tujuan terlebih dahulu.', 'error');
        return;
    }
    
    if (!quillEditor) { 
        showMessage('Editor belum dimuat. Silakan muat ulang halaman.', 'error');
        return;
    }

    const fullHtmlFromEditor = quillEditor.root.innerHTML;
    
    const keyTextRegex = /<p[^>]*>Kunci Jawaban\s*:\s*(.*?)<\/p>|Kunci Jawaban\s*:\s*(.*?)(?=<br>|$)/i;
    const boldRegex = /<(strong|b)[^>]*>\s*([A-D])[.)\s]/i;
    const boldReplaceRegex = /<(strong|b)[^>]*>(\s*[A-D][.)\s])/i;
    const numberRegex = /(<p[^>]*>)(?:Soal\s+)?\s*\d+[.)]\s*/i; 
    const allOptionsRegex = /<p[^>]*>\s*[a-d][.)].*?<\/p>/gi;

    // Parse ulang soal dari editor
    const soalHtmlArray = fullHtmlFromEditor.split(/(?=<p[^>]*>(?:Soal\s+)?\s*\d+[.)])/i)
        .map(s => s.trim())
        .filter(Boolean);
        
    const cleanedSoalHtmlArray = soalHtmlArray.map(soalHtml => {
        const isPG = boldRegex.test(soalHtml);
        const isIsian = keyTextRegex.test(soalHtml);
        let cleanedSoalHtml = soalHtml.replace(keyTextRegex, ''); 
        if (isPG) {
            cleanedSoalHtml = cleanedSoalHtml.replace(boldReplaceRegex, '$2');
        } else if (isIsian) {
            cleanedSoalHtml = cleanedSoalHtml.replace(allOptionsRegex, '');
        }
        cleanedSoalHtml = cleanedSoalHtml.replace(numberRegex, '$1'); 
        return cleanedSoalHtml;
    });

    const rows = document.querySelectorAll('#soal-preview-container .soal-row');
    
    if(cleanedSoalHtmlArray.length !== rows.length) {
        showMessage(`Error: Jumlah soal di editor (${cleanedSoalHtmlArray.length}) tidak cocok dengan pratinjau (${rows.length}). Coba refresh.`, 'error');
        return;
    }

    const dataSoal = [];
    rows.forEach((row, index) => {
        dataSoal.push({
            kodeMateri: materiKode,
            jenisUjian: jenisUjian, // (BARU) Masukkan jenis ujian ke setiap soal
            nomorSoal: index + 1,
            isiSoal: cleanedSoalHtmlArray[index], 
            kunciJawaban: row.querySelector('.kunci-jawaban-input').value.toUpperCase() || '',
            poin: parseFloat(row.querySelector('.poin-soal-input').value) || 4,
            mediaLink: ''
        });
    });
    
    const teacherName = Object.values(appState.processedSchedules).flat().find(item => item.subject.startsWith(materiKode))?.teacher;
    const teacherData = appData.teachers.find(t => t.name === teacherName);
    const teacherUsername = teacherData ? teacherData.username : '';

    if (!confirm(`Anda akan menyimpan ${dataSoal.length} soal (${jenisUjian}) untuk materi ${materiKode}. Lanjutkan?`)) return;

    const simpanBtn = document.getElementById('simpan-soal-btn');
    simpanBtn.disabled = true;
    simpanBtn.textContent = 'Memproses Gambar... (0%)';
    showLoading();

    const base64Regex = /<img src="(data:image\/[^"]+)"/g;
    let totalImages = 0;
    let imagesProcessed = 0;

    const uploadPromises = dataSoal.map(async (soal) => {
        let isiSoal = soal.isiSoal;
        const matches = [...isiSoal.matchAll(base64Regex)]; 
        if (matches.length > 0) {
            totalImages += matches.length;
            for (const match of matches) {
                const base64Data = match[1]; 
                try {
                    const cloudinaryUrl = await uploadPastedImage(base64Data); 
                    if (cloudinaryUrl) {
                        isiSoal = isiSoal.replace(base64Data, cloudinaryUrl);
                    }
                    imagesProcessed++;
                    simpanBtn.textContent = `Memproses Gambar... (${Math.round((imagesProcessed/totalImages)*100)}%)`;
                } catch (e) {
                    console.error("Gagal upload 1 gambar:", e);
                }
            }
        }
        soal.isiSoal = isiSoal; 
        return soal; 
    });

    const processedDataSoal = await Promise.all(uploadPromises);
    hideLoading();
    
    // Konfirmasi terakhir setelah upload gambar selesai
    if (!confirm('Semua gambar berhasil diproses. Simpan ke database sekarang?')) {
        simpanBtn.disabled = false;
        simpanBtn.textContent = 'Simpan Semua Soal';
        return;
    }

    simpanBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ 
            action: 'simpanBankSoal', 
            soalData: { 
                soal: processedDataSoal, // Data sudah mengandung 'jenisUjian'
                usernameGuru: teacherUsername 
            } 
        }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            quillEditor.setContents([]); 
            document.getElementById('soal-preview-container').innerHTML = `<p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini.</p>`;
            simpanBtn.classList.add('hidden');
            document.getElementById('materi-soal-select').value = '';
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        simpanBtn.disabled = false;
        simpanBtn.textContent = 'Simpan Semua Soal';
    });
}

// =======================================================
// === FUNGSI-FUNGSI UNTUK HALAMAN GURU ===
// =======================================================
let soalGuruData = []; // Untuk menyimpan data soal yang diambil

// GANTI FUNGSI INI SECARA KESELURUHAN
async function setupHalamanGuru() {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;
	
    if (['mia', 'wawan', 'admin', 'zhofri'].includes(session.username)) {
        fetchAndShowAdminNotification();
    }
	
    const guruMateriSelect = document.getElementById('guru-materi-select');
    const editorWrapper = document.getElementById('guru-editor-container-wrapper');
    const previewWrapper = document.getElementById('guru-preview-wrapper');
    const previewContainer = document.getElementById('soal-preview-guru-container');
    const updateBtn = document.getElementById('update-soal-btn');
    
    // Inisialisasi editor baru jika belum ada
    if (!quillEditorGuru) {
        quillEditorGuru = new Quill('#quill-editor-guru-container', {
            theme: 'snow',
            modules: { toolbar: [[{ 'header': [1, 2, 3, false] }], ['bold', 'italic', 'underline', 'strike'], ['link', 'image', 'formula'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['clean']] },
            placeholder: 'Soal dari materi yang Anda pilih akan dimuat di sini...'
        });
        
        // Pasang handler paste gambar (Sama seperti halaman input)
        quillEditorGuru.clipboard.addMatcher(Node.ELEMENT_NODE, (node, delta) => {
            if (node.tagName === 'IMG' && node.src && node.src.startsWith('data:image/')) {
                const range = quillEditorGuru.getSelection(true) || { index: 0 };
                quillEditorGuru.insertEmbed(range.index, 'image', 'https://placehold.co/100x100/e9ecef/6c757d?text=Uploading...');
                uploadPastedImage(node.src)
                    .then(url => {
                        if (url) {
                            quillEditorGuru.deleteText(range.index, 1);
                            quillEditorGuru.insertEmbed(range.index, 'image', url);
                            quillEditorGuru.setSelection(range.index + 1);
                        } else {
                            quillEditorGuru.deleteText(range.index, 1);
                        }
                        renderSoalPreviewGuru(quillEditorGuru.root.innerHTML, true);
                    });
            }
            return delta; 
        });

        // Pasang handler tombol gambar toolbar
        imageUploadHandler(quillEditorGuru);
        
        // Pasang listener perubahan teks untuk update pratinjau otomatis
        let typingTimer;
        quillEditorGuru.on('text-change', () => {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                renderSoalPreviewGuru(quillEditorGuru.root.innerHTML, true);
            }, 500);
        });
    }
    
    previewContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat data soal...</p>';
    
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getSoalUntukGuru', namaGuru: session.userData.profileName }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        soalGuruData = result.soal;
        const materiGuruDariServer = result.materi;

        guruMateriSelect.innerHTML = '<option value="all">-- Pilih Materi --</option>';
        for (const kode in materiGuruDariServer) {
            const subjectData = Object.values(appState.processedSchedules).flat().find(item => item.subject.startsWith(kode));
            const namaLengkapMateri = subjectData ? subjectData.subject : kode;
            const option = document.createElement('option');
            option.value = kode;
            option.textContent = namaLengkapMateri;
            guruMateriSelect.appendChild(option);
        }
        
        previewContainer.innerHTML = '<p class="p-8 text-center text-gray-400">Silakan pilih materi untuk diedit.</p>';

    } catch (error) {
        previewContainer.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat data: ${error.message}</p>`;
    }

    guruMateriSelect.addEventListener('change', (e) => {
        renderSoalUntukGuru(e.target.value);
    });
    
    // Hapus listener lama sebelum menambah yang baru (untuk menghindari duplikasi)
    updateBtn.replaceWith(updateBtn.cloneNode(true));
    document.getElementById('update-soal-btn').addEventListener('click', handleUpdateSoal);

    /**
     * Helper: Rekonstruksi soal ke editor
     */
    function renderSoalUntukGuru(filterKodeMateri) {
        if (filterKodeMateri === 'all' || !filterKodeMateri) {
            editorWrapper.classList.add('hidden');
            previewWrapper.classList.add('hidden');
            document.getElementById('update-soal-btn').classList.add('hidden');
            quillEditorGuru.setContents([]);
            previewContainer.innerHTML = '<p class="p-8 text-center text-gray-400">Silakan pilih materi untuk diedit.</p>';
            return;
        }

        const filteredSoal = soalGuruData.filter(s => s.kodemateri === filterKodeMateri);
        
        if (filteredSoal.length === 0) {
            quillEditorGuru.setContents([]);
            previewContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Belum ada soal untuk materi ini. Anda bisa menambahkannya dari halaman "Input Bank Soal".</p>';
            editorWrapper.classList.remove('hidden');
            previewWrapper.classList.remove('hidden');
            document.getElementById('update-soal-btn').classList.remove('hidden');
            return;
        }

        // Rekonstruksi HTML dari data soal
        let reconstructedHtml = '';
        filteredSoal
            .sort((a, b) => a.nomorsoal - b.nomorsoal)
            .forEach((soal) => {
                let isiSoal = soal.isisoal;
                
                // --- (PERBAIKAN UTAMA DI SINI) ---
                // Sisipkan nomor soal jika belum ada
                // Cek apakah paragraf pertama sudah punya angka
                if (!/^\s*<p[^>]*>\s*\d+[.)]/i.test(isiSoal)) {
                    // Jika tidak ada, sisipkan nomor di awal tag <p> pertama
                    isiSoal = isiSoal.replace(/<p([^>]*)>/i, `<p$1>${soal.nomorsoal}. `);
                }
                // --- AKHIR PERBAIKAN ---

                reconstructedHtml += isiSoal; 
                
                // Tambahkan Kunci Jawaban dengan format yang bisa dibaca parser
                if (soal.kuncijawaban) {
                    // Cek apakah kunci jawaban PG (A-D) atau Isian
                    const isPGKey = /^([A-D])$/i.test(soal.kuncijawaban.trim());
                    if (isPGKey) {
                        // Jika PG, kita coba tebalkan opsi di dalam teks soal (opsional, agak rumit di reverse)
                        // Atau kita cukup tulis eksplisit:
                        reconstructedHtml += `<p>Kunci Jawaban : ${soal.kuncijawaban}</p>`;
                    } else {
                        // Jika Isian
                        reconstructedHtml += `<p>Kunci Jawaban : ${soal.kuncijawaban}</p>`;
                    }
                }
                
                reconstructedHtml += `<p><br></p>`; // Spasi antar soal
            });

        quillEditorGuru.root.innerHTML = reconstructedHtml;
        
        // Panggil pratinjau
        renderSoalPreviewGuru(reconstructedHtml, true);
        
        editorWrapper.classList.remove('hidden');
        previewWrapper.classList.remove('hidden');
        document.getElementById('update-soal-btn').classList.remove('hidden');
    }

    /**
     * Helper: Pratinjau untuk Halaman Guru (Sama persis dengan halaman input)
     */
    function renderSoalPreviewGuru(fullHtml, isAutoFillChecked) {
        const autoFillKeys = isAutoFillChecked;
        const soalArray = fullHtml.split(/(?=<p[^>]*>(?:Soal\s+)?\s*\d+[.)])/i).map(s => s.trim()).filter(Boolean);

        if (soalArray.length === 0) {
            previewContainer.innerHTML = `<p class="p-8 text-center text-gray-400">Pratinjau soal akan muncul di sini.</p>`;
            // Jangan sembunyikan tombol simpan di sini agar user tetap bisa menghapus semua soal jika mau
            return;
        }
        
        const poinPerSoal = Math.round((100 / soalArray.length) * 100) / 100;
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Isi Soal</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-48">Kunci Jawaban</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Poin</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">`;

        const keyTextRegex = /<p[^>]*>Kunci Jawaban\s*:\s*(.*?)<\/p>|Kunci Jawaban\s*:\s*(.*?)(?=<br>|$)/i;
        const boldRegex = /<(strong|b)[^>]*>\s*([A-D])[.)\s]/i;
        const boldReplaceRegex = /<(strong|b)[^>]*>(\s*[A-D][.)\s])/i;
        const numberRegex = /(<p[^>]*>)(?:Soal\s+)?\s*\d+[.)]\s*/i; 
        const allOptionsRegex = /<p[^>]*>\s*[a-d][.)].*?<\/p>/gi;

        soalArray.forEach((soalHtml, index) => {
            let kunciJawaban = '';
            let poin = 4;
            let isPG = false; 

            if (autoFillKeys) {
                const keyMatch = soalHtml.match(keyTextRegex);
                if (keyMatch) {
                    let keyText = (keyMatch[1] || keyMatch[2] || '').trim().replace(/<[^>]+>/g, '').trim();
                    const pgMatch = keyText.match(/^([A-D])([.)\s]*)?$/i); 
                    if (pgMatch) {
                        kunciJawaban = pgMatch[1].toUpperCase();
                        isPG = true; 
                    } else {
                        kunciJawaban = keyText;
                    }
                }
                if (!kunciJawaban) {
                    const boldMatch = soalHtml.match(boldRegex);
                    if (boldMatch) {
                        kunciJawaban = boldMatch[2].toUpperCase();
                        isPG = true; 
                    }
                }
            }
            
            let cleanedSoalHtml = soalHtml.replace(keyTextRegex, ''); 
            if (isPG) {
                cleanedSoalHtml = cleanedSoalHtml.replace(boldReplaceRegex, '$2');
            } else if (kunciJawaban !== '') {
                cleanedSoalHtml = cleanedSoalHtml.replace(allOptionsRegex, '');
            }
            cleanedSoalHtml = cleanedSoalHtml.replace(numberRegex, '$1'); 

            tableHTML += `
                <tr class="soal-row-guru">
                    <td class="px-4 py-3 align-top">${index + 1}</td>
                    <td class="px-4 py-3 text-sm text-gray-800">${cleanedSoalHtml}</td>
                    <td class="px-4 py-3 align-top">
                        <input type="text" class="kunci-jawaban-input w-full p-2 border rounded-md" value="${kunciJawaban}" placeholder="Otomatis...">
                    </td>
                    <td class="px-4 py-3 align-top">
                        <input type="number" step="0.01" class="poin-soal-input w-full p-2 border rounded-md" value="${poinPerSoal}">
                    </td>
                </tr>
            `;
        });
        tableHTML += `</tbody></table>`;
        previewContainer.innerHTML = tableHTML;
    }
}

function renderSoalUntukGuru(filterKodeMateri) {
    const soalContainer = document.getElementById('guru-soal-container');
    const updateBtn = document.getElementById('update-soal-btn');
    
    const filteredSoal = filterKodeMateri === 'all' 
        ? soalGuruData 
        : soalGuruData.filter(s => s.kodemateri === filterKodeMateri);

    if (filteredSoal.length === 0) {
        soalContainer.innerHTML = `<p class="p-8 text-center text-gray-400">Tidak ada soal untuk materi ini.</p>`;
        updateBtn.classList.add('hidden');
        return;
    }

    let tableHTML = `<table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">No</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Isi Soal</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-48">Kunci Jawaban</th>
                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase w-24">Poin</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">`;

    filteredSoal.forEach((soal, index) => {
        tableHTML += `
            <tr class="soal-row-guru" data-kode-materi="${soal.kodemateri}" data-nomor-soal="${soal.nomorsoal}">
                <td class="px-4 py-3 align-top">${index + 1}</td>
                <td class="px-4 py-3 text-sm text-gray-800">
                    <textarea class="w-full p-2 border rounded-md" style="resize: vertical;">${soal.isisoal}</textarea>
                </td>
                <td class="px-4 py-3 align-top">
                    <input type="text" class="kunci-jawaban-input w-full p-2 border rounded-md uppercase" maxlength="1" value="${soal.kuncijawaban || ''}" placeholder="Cth: A">
                </td>
                <td class="px-4 py-3 align-top">
                    <input type="number" class="poin-soal-input w-full p-2 border rounded-md" value="${soal.poin || 0}">
                </td>
            </tr>
        `;
    });

    tableHTML += `</tbody></table>`;
    soalContainer.innerHTML = tableHTML;
    updateBtn.classList.remove('hidden');

    // --- KODE BARU DITAMBAHKAN DI SINI ---
    // Menerapkan auto-resize ke semua textarea yang baru dibuat
    soalContainer.querySelectorAll('textarea').forEach(textarea => {
        // Panggil fungsi sekali saat pertama kali ditampilkan
        autoResizeTextarea(textarea);
        // Tambahkan event listener agar textarea menyesuaikan diri saat guru mengedit soal
        textarea.addEventListener('input', () => autoResizeTextarea(textarea));
    });
    // --- AKHIR DARI KODE BARU ---
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto'; // Reset tinggi untuk mendapatkan scrollHeight yang benar
    textarea.style.height = textarea.scrollHeight + 'px'; // Atur tinggi sesuai dengan konten
}

async function handleUpdateSoal() {
    const materiKode = document.getElementById('guru-materi-select').value;
    if (!materiKode || materiKode === 'all') {
        showMessage('Silakan pilih satu materi spesifik untuk disimpan.', 'error');
        return;
    }
    
    if (!quillEditorGuru) { 
        showMessage('Editor guru belum dimuat. Silakan muat ulang halaman.', 'error');
        return;
    }

    const fullHtmlFromEditor = quillEditorGuru.root.innerHTML;
    
    // (DEFINISI REGEX - Penting agar tidak error 'boldRegex is not defined')
    const keyTextRegex = /<p[^>]*>Kunci Jawaban\s*:\s*(.*?)<\/p>|Kunci Jawaban\s*:\s*(.*?)(?=<br>|$)/i;
    const boldRegex = /<(strong|b)[^>]*>\s*([A-D])[.)\s]/i;
    const boldReplaceRegex = /<(strong|b)[^>]*>(\s*[A-D][.)\s])/i;
    const numberRegex = /(<p[^>]*>)(?:Soal\s+)?\s*\d+[.)]\s*/i; 
    const allOptionsRegex = /<p[^>]*>\s*[a-d][.)].*?<\/p>/gi;

    // Parse ulang soal dari editor
    const soalHtmlArray = fullHtmlFromEditor.split(/(?=<p[^>]*>(?:Soal\s+)?\s*\d+[.)])/i)
        .map(s => s.trim())
        .filter(Boolean);
        
    const cleanedSoalHtmlArray = soalHtmlArray.map(soalHtml => {
        const isPG = boldRegex.test(soalHtml);
        const isIsian = keyTextRegex.test(soalHtml);
        let cleanedSoalHtml = soalHtml.replace(keyTextRegex, ''); 
        if (isPG) {
            cleanedSoalHtml = cleanedSoalHtml.replace(boldReplaceRegex, '$2');
        } else if (isIsian) {
            cleanedSoalHtml = cleanedSoalHtml.replace(allOptionsRegex, '');
        }
        cleanedSoalHtml = cleanedSoalHtml.replace(numberRegex, '$1'); 
        return cleanedSoalHtml;
    });

    const rows = document.querySelectorAll('#soal-preview-guru-container .soal-row-guru');
    
    if(cleanedSoalHtmlArray.length !== rows.length) {
        showMessage(`Error: Jumlah soal di editor (${cleanedSoalHtmlArray.length}) tidak cocok dengan pratinjau (${rows.length}). Coba refresh.`, 'error');
        return;
    }

    const dataSoal = [];
    rows.forEach((row, index) => {
        dataSoal.push({
            kodeMateri: materiKode,
            nomorSoal: index + 1,
            isiSoal: cleanedSoalHtmlArray[index], 
            kunciJawaban: row.querySelector('.kunci-jawaban-input').value.toUpperCase() || '',
            poin: parseFloat(row.querySelector('.poin-soal-input').value) || 4,
            mediaLink: ''
        });
    });
    
    const session = getActiveSession();
    const teacherUsername = session ? session.username : '';

    if (!confirm(`Anda akan MENIMPA seluruh bank soal untuk materi ${materiKode} dengan ${dataSoal.length} soal yang ada di editor ini. Lanjutkan?`)) return;

    const simpanBtn = document.getElementById('update-soal-btn');
    simpanBtn.disabled = true;
    simpanBtn.textContent = 'Memproses Gambar... (0%)';
    showLoading();

    // (Logika upload gambar yang sama dengan halaman input)
    const base64Regex = /<img src="(data:image\/[^"]+)"/g;
    let totalImages = 0;
    let imagesProcessed = 0;

    const uploadPromises = dataSoal.map(async (soal) => {
        let isiSoal = soal.isiSoal;
        const matches = [...isiSoal.matchAll(base64Regex)]; 
        if (matches.length > 0) {
            totalImages += matches.length;
            for (const match of matches) {
                const base64Data = match[1]; 
                try {
                    const cloudinaryUrl = await uploadPastedImage(base64Data); 
                    if (cloudinaryUrl) {
                        isiSoal = isiSoal.replace(base64Data, cloudinaryUrl);
                    }
                    imagesProcessed++;
                    simpanBtn.textContent = `Memproses Gambar... (${Math.round((imagesProcessed/totalImages)*100)}%)`;
                } catch (e) {
                    console.error("Gagal upload 1 gambar:", e);
                }
            }
        }
        soal.isiSoal = isiSoal; 
        return soal; 
    });

    const processedDataSoal = await Promise.all(uploadPromises);
    hideLoading();

    simpanBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ 
            action: 'simpanBankSoal', 
            soalData: { 
                soal: processedDataSoal, 
                usernameGuru: teacherUsername 
            } 
        }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            // Muat ulang data soal guru setelah menyimpan agar tampilan sinkron
            setupHalamanGuru();
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        simpanBtn.disabled = false;
        simpanBtn.textContent = 'Simpan Perubahan';
    });
}

    // --- BAGIAN 2: DEFINISI SEMUA FUNGSI ---
    // FUNGSI BANTUAN UNTUK MENGAMBIL TANGGAL HARI INI
function getClientDateString() {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    return `${day}/${month}/${year}`;
}
	
    function showMessage(message, type = 'error') { ui.messageBox.textContent = message; ui.messageBox.className = `message-box ${type} show`; setTimeout(() => { ui.messageBox.classList.remove('show'); }, 3500); }
    function getActiveSession() { return JSON.parse(localStorage.getItem('userSession') || sessionStorage.getItem('userSession') || 'null'); }
/**
 * Fungsi baru untuk mengirim log aktivitas ke backend.
 */
function logAction(actionType, actionDetail) {
    // Hanya kirim log jika yang login adalah santri dan ujian sedang berlangsung
    const session = getActiveSession();
    if (session && session.userData.jabatan === 'santri' && isExamInProgress) {
        const data = {
            action: 'logUserActivity',
            username: session.username,
            profileName: session.userData.profileName,
            actionType: actionType,
            actionDetail: actionDetail
        };

        // Kirim data ke backend tanpa menunggu respons (kirim dan lupakan)
        fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            keepalive: true // Penting agar log tetap terkirim meski tab ditutup
        });
    }
}	
	const handleBackToSantriList = () => {
    // Sembunyikan semua kontainer yang mungkin terbuka
    
    document.getElementById('santri').classList.add('hidden');

    // Pindah hash ke halaman roster KBM
    window.location.hash = '#roster-kbm?scroll=santri';

    // Beri jeda sesaat agar halaman roster sempat ditampilkan sebelum scroll
    setTimeout(() => {
        const santriContainer = document.getElementById('santri-data-container');
        if (santriContainer) {
            // Gulir halaman ke bagian tabel Data Santri
            santriContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Jika tabelnya sedang tertutup (hidden), klik headernya untuk membuka
            const dataContent = santriContainer.querySelector('.data-content');
            if (dataContent && dataContent.classList.contains('hidden')) {
                santriContainer.querySelector('.data-header').click();
            }
        }
    }, 200);
};
	
function showAnnouncementPopup() {
    const popup = document.getElementById('announcementPopup');
    const closeBtn = document.getElementById('closePopupBtn');
    const understandBtn = document.getElementById('understandPopupBtn');

    const closePopup = () => {
        popup.style.display = 'none';
    };

    // Langsung tampilkan popup
    popup.style.display = 'block';

    // Pasang event listener untuk tombol tutup
    closeBtn.onclick = closePopup;
    understandBtn.onclick = closePopup;
}

// FUNGSI BARU UNTUK MENAMPILKAN TRANSAKSI HARIAN
function renderDailyTransactions(allMonthData, selectedDate) {
    const container = document.getElementById('daily-transaction-container');

    // Normalisasi tanggal yang dipilih (menghilangkan masalah zona waktu)
    const targetDate = new Date(selectedDate + 'T00:00:00');
    const targetDateString = targetDate.toLocaleDateString('id-ID');

    const dailyData = allMonthData.filter(row => {
        // Normalisasi tanggal dari data sheet
        const transactionDate = new Date(row[0]);
        const transactionDateString = transactionDate.toLocaleDateString('id-ID');
        return transactionDateString === targetDateString;
    });

    let runningTotal = 0; // Inisialisasi saldo berjalan
    const rowsHTML = dailyData.map(row => {
        const isIncome = row[1] === 'Uang Masuk';
        const amount = parseFloat(row[4]) || 0;
        runningTotal += isIncome ? amount : -amount;

        return `
            <tr class="hover:bg-gray-50">
                <td class="px-2 py-2 border">${new Date(row[0]).toLocaleDateString('id-ID')}</td>
                <td class="px-2 py-2 border">${row[3]}</td>
                <td class="px-2 py-2 border text-right">${isIncome ? amount.toLocaleString('id-ID') : '-'}</td>
                <td class="px-2 py-2 border text-right">${!isIncome ? amount.toLocaleString('id-ID') : '-'}</td>
                <td class="px-2 py-2 border text-right font-semibold">${runningTotal.toLocaleString('id-ID')}</td>
                <td class="px-2 py-2 border">${row[2]}</td>
                <td class="px-2 py-2 border text-center"><button class="text-red-500 hover:text-red-700" onclick="handleDeleteTransaction('${new Date(row[0]).getTime()}')">Hapus</button></td>
            </tr>
        `;
    }).join('');

    const displayDate = targetDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    container.innerHTML = `
        <h3 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">Rincian Transaksi Tanggal ${displayDate}</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-sm mt-2 mb-4 border-collapse">
                <thead class="bg-gray-100"><tr>
                    <th class="px-2 py-2 border text-left">Tanggal</th><th class="px-2 py-2 border text-left">Keterangan</th>
                    <th class="px-2 py-2 border text-right">Masuk</th><th class="px-2 py-2 border text-right">Keluar</th>
                    <th class="px-2 py-2 border text-right">Total</th><th class="px-2 py-2 border text-left">Kelompok</th>
                    <th class="px-2 py-2 border">Aksi</th>
                </tr></thead>
                <tbody>${rowsHTML || `<tr><td colspan="7" class="p-4 text-center border">Tidak ada transaksi pada tanggal ini.</td></tr>`}</tbody>
            </table>
        </div>`;
}

// FUNGSI BARU UNTUK MENGHAPUS TRANSAKSI
function handleDeleteTransaction(timestamp) {
    if (!confirm('Apakah Anda yakin ingin menghapus transaksi ini?')) return;

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'deleteTransaction', timestamp: timestamp }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            document.getElementById('tampilkanLaporanKeuanganBtn').click(); // Refresh laporan
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menghapus: ${error.message}`, 'error'));
}

// FUNGSI BARU UNTUK MENGUNDUH/MEMBAGIKAN GAMBAR
function downloadOrShareSummary(action = 'download') {
    const summaryNode = document.getElementById('printable-summary');
    html2canvas(summaryNode, { scale: 2 }).then(canvas => {
        canvas.toBlob(function(blob) {
            const fileName = `Ringkasan Keuangan Tahunan - ${document.getElementById('laporanTahun').value}.png`;
            if (action === 'download') {
                const link = document.createElement('a');
                link.download = fileName;
                link.href = URL.createObjectURL(blob);
                link.click();
            } else if (action === 'share' && navigator.share) {
                navigator.share({
                    files: [new File([blob], fileName, { type: 'image/png' })],
                    title: 'Ringkasan Keuangan Tahunan',
                }).catch(err => console.error("Error sharing:", err));
            }
        });
    });
}



// =======================================================
// === FUNGSI-FUNGSI BARU UNTUK LAPORAN KEUANGAN ===
// =======================================================

function setupKeuanganEventListeners() {
    document.getElementById('tampilkanLaporanKeuanganBtn')?.addEventListener('click', () => {
        const bulan = document.getElementById('laporanBulan').value;
        const tahun = document.getElementById('laporanTahun').value;
        fetchAndRenderKeuanganReport(tahun, bulan);
    });

    document.getElementById('kunciGajiBtn')?.addEventListener('click', async () => {
    const bulan = document.getElementById('tutupBukuBulan').value;
    const tahun = document.getElementById('tutupBukuTahun').value;
    const periode = `${tahun}-${bulan}`;
    const btn = document.getElementById('kunciGajiBtn');

    // Konfirmasi lokal pertama (tetap ada)
    if (!confirm(`Anda akan "Menutup Buku" dan menyimpan data gaji permanen untuk bulan ${periode}.\n\nDATA YANG SUDAH DISIMPAN TIDAK BISA DIUBAH (kecuali ditimpa).\n\nLanjutkan?`)) {
        return;
    }

    // Panggil fungsi baru (Langkah 1)
    runKunciGajiProcess(periode, btn);
});
    document.getElementById('addKeuanganRowBtn')?.addEventListener('click', addKeuanganInputRow);
    document.getElementById('saveKeuanganBtn')?.addEventListener('click', handleSaveKeuangan);

	document.getElementById('setTanggalDefaultBtn')?.addEventListener('click', handleSetDefaultDate);


    // Listener untuk pilihan grafik
    document.querySelectorAll('input[name="chartType"]').forEach(radio => {
        radio.addEventListener('change', () => {
            const tahun = document.getElementById('laporanTahun').value;
            // Panggil lagi fungsi fetch data tahunan untuk menggambar ulang grafik
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getYearlyFinancialData', year: parseInt(tahun) }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            }).then(res=>res.json()).then(result => {
                if (result.status === 'success') {
                    renderKeuanganChartAndTotals(result.data, tahun);
                }
            });
        });
    });

    // Listener untuk tombol unduh dan bagikan
    document.getElementById('downloadYearlySummaryBtn')?.addEventListener('click', () => downloadOrShareSummary('download'));
    document.getElementById('shareYearlySummaryBtn')?.addEventListener('click', () => downloadOrShareSummary('share'));
	
}

async function runKunciGajiProcess(periode, btn) {
    btn.disabled = true;
    btn.textContent = 'MEMERIKSA DATA LAMA...';
    showLoading();

    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'kunciGajiBulanan', 
                periode: periode,
                requesterUsername: getActiveSession().username,
                forceOverwrite: false // Kirim 'false' untuk memeriksa dulu
            }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();

        if (result.status === 'success') {
            // Jika tidak ada duplikat, langsung sukses
            hideLoading();
            showMessage(result.message, 'success');
            btn.disabled = false;
            btn.textContent = 'Kunci & Simpan Gaji Bulan Ini';
        } else if (result.status === 'confirm_overwrite') {
            // Jika ada duplikat, panggil modal kustom
            hideLoading();
            
            // --- INI BAGIAN YANG BERUBAH ---
            const userConfirmed = await showCustomConfirm(
                'Konfirmasi Penimpaan Data',
                result.message, // Pesan dari backend
                'Ya, Timpa Data', // Teks tombol "Ya"
                'Batal'           // Teks tombol "Batal"
            );
            // --- AKHIR PERUBAHAN ---

            if (userConfirmed) {
                // Jika user setuju, panggil fungsi 'force'
                forceKunciGaji(periode, btn);
            } else {
                showMessage('Tindakan dibatalkan.', 'error');
                btn.disabled = false;
                btn.textContent = 'Kunci & Simpan Gaji Bulan Ini';
            }
        } else {
            // Error lain
            throw new Error(result.message);
        }
    } catch (error) {
        hideLoading();
        showMessage(`Gagal: ${error.message}`, 'error');
        btn.disabled = false;
        btn.textContent = 'Kunci & Simpan Gaji Bulan Ini';
    }
}

// --- (BARU) FUNGSI LANGKAH 2: MENIMPA DATA (JIKA DIKONFIRMASI) ---
function forceKunciGaji(periode, btn) {
    btn.disabled = true;
    btn.textContent = 'MENIMPA DATA...';
    showLoading();

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ 
            action: 'kunciGajiBulanan', 
            periode: periode,
            requesterUsername: getActiveSession().username,
            forceOverwrite: true // Kirim 'true' untuk menimpa data
        }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menimpa: ${error.message}`, 'error'))
    .finally(() => {
        hideLoading();
        btn.disabled = false;
        btn.textContent = 'Kunci & Simpan Gaji Bulan Ini';
    });
}

function showCustomConfirm(title, message, yesText = 'Ya', noText = 'Batal') {
    return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const titleEl = document.getElementById('confirmModalTitle');
        const messageEl = document.getElementById('confirmModalMessage');
        const yesBtn = document.getElementById('confirmModalYesBtn');
        const noBtn = document.getElementById('confirmModalNoBtn');

        // Isi konten modal
        titleEl.textContent = title;
        messageEl.textContent = message;
        yesBtn.textContent = yesText;
        noBtn.textContent = noText;

        // Tampilkan modal
        modal.style.display = 'block';

        // Buat fungsi handler agar bisa dihapus nanti
        const yesHandler = () => {
            modal.style.display = 'none';
            cleanup();
            resolve(true);
        };
        
        const noHandler = () => {
            modal.style.display = 'none';
            cleanup();
            resolve(false);
        };
        
        // Hapus listener lama (jika ada) dan pasang yang baru
        const cleanup = () => {
            yesBtn.removeEventListener('click', yesHandler);
            noBtn.removeEventListener('click', noHandler);
        };

        // Hapus dulu sebelum menambah, untuk jaga-jaga
        yesBtn.removeEventListener('click', yesHandler);
        noBtn.removeEventListener('click', noHandler);

        yesBtn.addEventListener('click', yesHandler);
        noBtn.addEventListener('click', noHandler);
    });
}

// --- (BARU) FUNGSI UNTUK MENAMPILKAN ALERT KUSTOM ---
function showCustomAlert(message, title = "Peringatan") {
    const modal = document.getElementById('alertModal');
    document.getElementById('alertModalTitle').textContent = title;
    document.getElementById('alertModalMessage').textContent = message;
    modal.style.display = 'block';

    const okBtn = document.getElementById('alertModalOkBtn');
    
    const okHandler = () => {
        modal.style.display = 'none';
        okBtn.removeEventListener('click', okHandler);
    };
    
    // Hapus listener lama (jika ada) dan pasang yang baru
    okBtn.removeEventListener('click', okHandler);
    okBtn.addEventListener('click', okHandler);
}

function updateKelompokKeuangan() {
    const jenis = document.querySelector('input[name="jenisTransaksi"]:checked').value;
    const selectKelompok = document.getElementById('kelompokKeuangan');
    selectKelompok.innerHTML = ''; // Kosongkan pilihan

    const kelompokMasuk = ["Infak Langsung", "Infak Bulanan", "Kotak Infak", "SPP", "Jual Sembako", "Keuntungan Usaha"];
    const kelompokKeluar = ["Kebutuhan Anak Yatim", "Kebutuhan Rumah", "Buku/ATK", "Kesehatan dan Pengobatan", "Kebutuhan Rumah Tahfidz", "Transport", "Gaji dan Tunjangan", "Pengembangan Usaha"];
    const options = (jenis === 'Uang Masuk') ? kelompokMasuk : kelompokKeluar;

    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectKelompok.appendChild(option);
    });
}

function handleKeuanganSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Menyimpan...';

    const data = {
        action: 'submitKeuangan',
        tanggal: document.getElementById('tanggalKeuangan').value,
        jenis: document.querySelector('input[name="jenisTransaksi"]:checked').value,
        jumlah: document.getElementById('jumlahKeuangan').value,
        kelompok: document.getElementById('kelompokKeuangan').value,
        keterangan: document.getElementById('keteranganKeuangan').value
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            form.reset();
            updateKelompokKeuangan(); // Reset dropdown ke default
            // Otomatis refresh laporan jika melihat bulan yang sama
            const bulan = (new Date(data.tanggal).getMonth() + 1).toString().padStart(2, '0');
            const tahun = new Date(data.tanggal).getFullYear().toString();
            if (document.getElementById('laporanBulan').value == bulan && document.getElementById('laporanTahun').value == tahun) {
                fetchAndRenderKeuanganReport(tahun, bulan);
            }
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Simpan Transaksi';
    });
}
// === TAMBAHKAN FUNGSI YANG HILANG INI ===
const createTable = (title, data, headers) => {
    let rows = data.map(row => `
        <tr>
            <td class="px-4 py-2 border">${new Date(row[headers.date]).toLocaleDateString('id-ID')}</td>
            <td class="px-4 py-2 border">${row[headers.group]}</td>
            <td class="px-4 py-2 border">${row[headers.desc]}</td>
            <td class="px-4 py-2 border text-right">${(parseFloat(row[headers.amount]) || 0).toLocaleString('id-ID')}</td>
        </tr>
    `).join('');
    return `
        <h4 class="font-bold text-lg ${title.includes('Masuk') ? 'text-green-600' : 'text-red-600'}">${title}</h4>
        <table class="w-full text-sm mt-2 mb-4 border-collapse">
            <thead><tr class="bg-gray-100">
                <th class="px-4 py-2 border text-left">Tanggal</th><th class="px-4 py-2 border text-left">Kelompok</th>
                <th class="px-4 py-2 border text-left">Keterangan</th><th class="px-4 py-2 border text-right">Jumlah</th>
            </tr></thead>
            <tbody>${rows || `<tr><td colspan="4" class="p-4 text-center border">Tidak ada data.</td></tr>`}</tbody>
        </table>`;
};
// GANTI FUNGSI LAMA DENGAN VERSI BARU INI
function fetchAndRenderKeuanganReport(tahun, bulan) {
    const reportContainer = document.getElementById('keuangan-report-container');
    reportContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat laporan bulanan...</p>';
    document.getElementById('yearly-summary-container').classList.add('hidden');
    document.getElementById('daily-transaction-container').innerHTML = ''; // Kosongkan rincian harian

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getLaporanKeuangan', year: parseInt(tahun), month: parseInt(bulan) }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status !== 'success') throw new Error(result.message);

        const l = result.laporan;
        const formatRp = num => `Rp ${num.toLocaleString('id-ID')}`;

        // 1. Gabungkan dana masuk dan keluar jadi satu array
const combinedData = [
        ...l.danaMasuk.map(row => ({ 
            date: new Date(row[0]), 
            kelompok: row[2], // 
            desc: row[3], 
            amount: parseFloat(row[4]) || 0, 
            type: 'masuk' 
        })),
        ...l.danaKeluar.map(row => ({ 
            date: new Date(row[0]), 
            kelompok: row[2], // 
            desc: row[3], 
            amount: parseFloat(row[4]) || 0, 
            type: 'keluar' 
        }))
    ];

// 2. Urutkan array gabungan berdasarkan tanggal (dari yang paling lama ke baru)
combinedData.sort((a, b) => a.date - b.date);

// 3. Buat baris-baris (rows) HTML untuk tabel baru
let rowsHTML = combinedData.map(item => {
    const dateStr = item.date.toLocaleDateString('id-ID', { day: '2-digit', month: '2-digit', year: 'numeric' });
    const amount = item.amount.toLocaleString('id-ID');
    let amountHTML;

    if (item.type === 'masuk') {
        // Terapkan font hijau jika 'masuk'
        amountHTML = `<td class="px-4 py-2 border text-right font-semibold text-green-600">+ Rp ${amount}</td>`;
    } else {
        // Terapkan font merah jika 'keluar'
        amountHTML = `<td class="px-4 py-2 border text-right font-semibold text-red-600">- Rp ${amount}</td>`;
    }

    return `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-2 border whitespace-nowrap">${dateStr}</td>
                <td class="px-4 py-2 border">${item.kelompok}</td> 
				<td class="px-4 py-2 border">${item.desc}</td>
                ${amountHTML}
        </tr>
    `;
}).join('');

if (combinedData.length === 0) {
    rowsHTML = '<tr><td colspan="3" class="p-4 text-center border">Tidak ada data transaksi.</td></tr>';
}

// 4. Buat HTML tabel tunggal
const singleTableHTML = `
    <h4 class="font-bold text-xl text-gray-700 mb-4">Rincian Transaksi Bulanan</h4>
    <div class="overflow-x-auto">
        <table class="w-full text-sm mt-2 mb-4 border-collapse">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 border text-left">Tanggal</th>
                        <th class="px-4 py-2 border text-left">Kelompok</th> 
						<th class="px-4 py-2 border text-left">Keterangan</th>
                        <th class="px-4 py-2 border text-right">Jumlah</th>
                </tr>
            </thead>
            <tbody>
                ${rowsHTML}
            </tbody>
        </table>
    </div>
`;

// 5. Buat reportHTML baru dengan tabel tunggal
const reportHTML = `
    <div>
        ${singleTableHTML}
    </div>
    <div class="mt-8 p-4 bg-gray-50 rounded-lg border">
                <h4 class="font-bold text-xl mb-4 text-center">Ringkasan Keuangan</h4>
                <div class="space-y-3">
                    <div class="flex justify-between text-gray-700"><span>Saldo Kas Bulan Lalu</span> <span>${formatRp(l.saldoBulanLalu)}</span></div>
                    <div class="flex justify-between text-green-600"><span>Total Dana Masuk Bulan Ini</span> <span>${formatRp(l.totalMasuk)}</span></div>
                    <div class="flex justify-between text-red-600"><span>Total Dana Keluar Bulan Ini</span> <span>-${formatRp(l.totalKeluar)}</span></div>
                    <div class="flex justify-between font-bold border-t pt-2"><span>Selisih Bulan Ini</span> <span>${formatRp(l.selisihBulanIni)}</span></div>
                    <div class="flex justify-between font-bold text-xl text-blue-600 border-t-2 pt-2 mt-2"><span>Sisa Saldo Kas Akhir Bulan Ini</span> <span>${formatRp(l.saldoAkhirBulanIni)}</span></div>
                </div>
            </div>`;
        reportContainer.innerHTML = reportHTML;

        const selectedDate = document.getElementById('tanggalKeuangan').value;
        const allMonthData = l.danaMasuk.concat(l.danaKeluar);
        renderDailyTransactions(allMonthData, selectedDate);

        return fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getYearlyFinancialData', year: parseInt(tahun) }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
    })
    .then(res => res.json())
    .then(result => {
        if (result.status !== 'success') throw new Error(result.message);
        document.getElementById('yearly-summary-container').classList.remove('hidden');
        renderKeuanganChartAndTotals(result.data, tahun);
    })
    .catch(error => {
        reportContainer.innerHTML = `<p class="p-8 text-center text-red-600 bg-red-50 rounded-lg">Gagal memuat laporan: ${error.message}</p>`;
    });
}

let keuanganChartInstance = null;
function renderKeuanganChartAndTotals(yearlyData, year) {
    const groupTotalsContainer = document.getElementById('group-totals-container');
    const chartType = document.querySelector('input[name="chartType"]:checked').value;
    const ctx = document.getElementById('keuanganChart').getContext('2d');

    // Proses data tahunan
    const monthlyTotals = Array(12).fill(0).map(() => ({ masuk: 0, keluar: 0 }));
    const incomeGroups = {};
    const expenseGroups = {};

    yearlyData.forEach(row => {
        const date = new Date(row[0]);
        const month = date.getMonth(); // 0-11
        const jenis = row[1];
        const kelompok = row[2];
        const jumlah = parseFloat(row[4]) || 0;

        if (jenis === 'Uang Masuk') {
            monthlyTotals[month].masuk += jumlah;
            incomeGroups[kelompok] = (incomeGroups[kelompok] || 0) + jumlah;
        } else if (jenis === 'Uang Keluar') {
            monthlyTotals[month].keluar += jumlah;
            expenseGroups[kelompok] = (expenseGroups[kelompok] || 0) + jumlah;
        }
    });

    // Tampilkan total per kelompok
let totalsHTML = '<h4 class="font-bold mb-2">Total per Kelompok Tahun ' + year + '</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">';

// Blok Dana Masuk
let incomeHTML = '<div class="space-y-1">';
let totalMasuk = 0; // Inisialisasi total masuk
for(const key in incomeGroups) {
    totalMasuk += incomeGroups[key]; // Tambahkan ke total
    // Tambahkan border putus-putus (border-b border-dashed) dan padding (py-1)
    incomeHTML += `<div class="grid grid-cols-2 gap-x-2 border-b border-dashed border-gray-300 py-1">
                     <span>${key}</span>
                     <span class="text-right font-medium">${incomeGroups[key].toLocaleString('id-ID')}</span>
                   </div>`;
}
// Tambahkan baris total di akhir
incomeHTML += `<div class="grid grid-cols-2 gap-x-2 border-t-2 border-gray-400 pt-2 mt-2">
                 <span class="font-bold">Total Dana Masuk</span>
                 <span class="text-right font-bold">${totalMasuk.toLocaleString('id-ID')}</span>
               </div>`;
incomeHTML += '</div>';
totalsHTML += `<div><span class="font-semibold block border-b pb-1 mb-2">Dana Masuk</span>${incomeHTML}</div>`;

// Blok Dana Keluar
let expenseHTML = '<div class="space-y-1">';
let totalKeluar = 0; // Inisialisasi total keluar
for(const key in expenseGroups) {
    totalKeluar += expenseGroups[key]; // Tambahkan ke total
    // Tambahkan border putus-putus (border-b border-dashed) dan padding (py-1)
    expenseHTML += `<div class="grid grid-cols-2 gap-x-2 border-b border-dashed border-gray-300 py-1">
                      <span>${key}</span>
                      <span class="text-right font-medium">${expenseGroups[key].toLocaleString('id-ID')}</span>
                    </div>`;
}
// Tambahkan baris total di akhir
expenseHTML += `<div class="grid grid-cols-2 gap-x-2 border-t-2 border-gray-400 pt-2 mt-2">
                  <span class="font-bold">Total Dana Keluar</span>
                  <span class="text-right font-bold">${totalKeluar.toLocaleString('id-ID')}</span>
                </div>`;
expenseHTML += '</div>';
totalsHTML += `<div><span class="font-semibold block border-b pb-1 mb-2">Dana Keluar</span>${expenseHTML}</div>`;

totalsHTML += '</div>'; // Penutup grid utama
groupTotalsContainer.innerHTML = totalsHTML;

    // Atur data untuk grafik
    let chartConfig;
    const monthLabels = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];

    if (chartType === 'income_expense') {
        chartConfig = {
            type: 'bar',
            data: {
                labels: monthLabels,
                datasets: [
                    { label: 'Dana Masuk', data: monthlyTotals.map(m => m.masuk), backgroundColor: 'rgba(75, 192, 192, 0.6)' },
                    { label: 'Dana Keluar', data: monthlyTotals.map(m => m.keluar), backgroundColor: 'rgba(255, 99, 132, 0.6)' }
                ]
            }
        };
    } else if (chartType === 'income_groups') {
        chartConfig = {
            type: 'doughnut',
            data: {
                labels: Object.keys(incomeGroups),
                datasets: [{ data: Object.values(incomeGroups) }]
            }
        };
    } else { // expense_groups
        chartConfig = {
            type: 'doughnut',
            data: {
                labels: Object.keys(expenseGroups),
                datasets: [{ data: Object.values(expenseGroups) }]
            }
        };
    }

    chartConfig.options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } };

    if (keuanganChartInstance) keuanganChartInstance.destroy();
    keuanganChartInstance = new Chart(ctx, chartConfig);
}



function renderTotalGajiTable(reportData, grandTotal) {
    const container = document.getElementById('total-gaji-report-container');
    const formatRp = num => (num || 0).toLocaleString('id-ID');

    if (!reportData || reportData.length === 0) {
        container.innerHTML = '<p class="p-4 text-center text-gray-500">Tidak ada data gaji yang ditemukan di HistoryGaji untuk periode ini.</p>';
        return;
    }

    let rowsHTML = reportData
        .sort((a, b) => a.Nama.localeCompare(b.Nama)) // Urutkan berdasarkan nama
        .map((item, index) => `
        <tr class="hover:bg-gray-50">
            <td class="px-4 py-2 border text-center">${index + 1}</td>
            <td class="px-4 py-2 border">${item.Nama}</td>
            <td class="px-4 py-2 border text-right">Rp ${formatRp(item.GajiBersih)}</td>
        </tr>
    `).join('');

    const tableHTML = `
        <div class="overflow-x-auto">
            <table class="w-full text-sm mt-2 border-collapse">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-2 border text-center w-16">No</th>
                        <th class="px-4 py-2 border text-left">Nama Karyawan</th>
                        <th class="px-4 py-2 border text-right">Total Gaji (Bersih)</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHTML}
                </tbody>
                <tfoot class="bg-gray-200 font-bold">
                    <tr>
                        <td colspan="2" class="px-4 py-3 border text-right">TOTAL KESELURUHAN</td>
                        <td class="px-4 py-3 border text-right">Rp ${formatRp(grandTotal)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    `;
    container.innerHTML = tableHTML;
}

// === TAMBAHKAN SEMUA FUNGSI BARU DI BAWAH INI ===

// Baca tanggal terakhir dari localStorage, atau gunakan tanggal hari ini jika tidak ada
let lastKeuanganDate = localStorage.getItem('lastKeuanganDate') || new Date().toISOString().slice(0, 10);

// === GANTI SELURUH FUNGSI INI ===
function addKeuanganInputRow() {
    const tbody = document.getElementById('keuangan-input-tbody');
    const newRow = document.createElement('tr');
    newRow.className = 'keuangan-input-row';
    // Hapus atribut oninput dari HTML
    newRow.innerHTML = `
        <td class="border p-1"><input type="text" class="w-full p-2 border-gray-300 rounded" placeholder="Keterangan transaksi..."></td>
        <td class="border p-1"><input type="number" step="500" class="w-full p-2 border-gray-300 rounded" placeholder="0"></td>
        <td class="border p-1"><input type="number" step="500" class="w-full p-2 border-gray-300 rounded" placeholder="0"></td>
        <td class="border p-1"><select class="w-full p-2 border-gray-300 rounded bg-white"></select></td>
        <td class="border p-1 text-center"><button class="text-red-500 hover:text-red-700 font-bold">X</button></td>
    `;
    tbody.appendChild(newRow);

    // Pasang event listener menggunakan JavaScript
    const masukInput = newRow.querySelector('td:nth-child(2) input');
    const keluarInput = newRow.querySelector('td:nth-child(3) input');

    masukInput.addEventListener('input', () => handleAmountInput(masukInput, 'masuk'));
    keluarInput.addEventListener('input', () => handleAmountInput(keluarInput, 'keluar'));

    updateKelompokForRow(newRow); // Isi dropdown untuk baris baru

    newRow.querySelector('button').addEventListener('click', () => newRow.remove());
}

function handleAmountInput(inputElement, type) {
    const row = inputElement.closest('tr');
    const masukInput = row.querySelector('td:nth-child(2) input');
    const keluarInput = row.querySelector('td:nth-child(3) input');

    if (type === 'masuk' && inputElement.value > 0) {
        keluarInput.value = '';
    } else if (type === 'keluar' && inputElement.value > 0) {
        masukInput.value = '';
    }
    updateKelompokForRow(row);
}

function updateKelompokForRow(row) {
    const masukValue = row.querySelector('td:nth-child(2) input').value;
    const keluarValue = row.querySelector('td:nth-child(3) input').value;
    const selectEl = row.querySelector('select');
    selectEl.innerHTML = '';

    const kelompokMasuk = ["Infak Langsung", "Infak Bulanan", "Kotak Infak", "SPP", "Jual Sembako", "Keuntungan Usaha"];
    const kelompokKeluar = ["Kebutuhan Anak Yatim", "Kebutuhan Rumah", "Buku/ATK", "Kesehatan dan Pengobatan", "Kebutuhan Rumah Tahfidz", "Transport", "Gaji dan Tunjangan", "Pengembangan Usaha"];

    let options = [];
    if (keluarValue > 0) {
    options = kelompokKeluar;
} else { 
    options = kelompokMasuk;
}

    options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        selectEl.appendChild(option);
    });
}

function handleSaveKeuangan() {
    const tanggal = document.getElementById('tanggalKeuangan').value;
    const rows = document.querySelectorAll('.keuangan-input-row');
    const transactions = [];

    rows.forEach(row => {
        const keterangan = row.querySelector('td:nth-child(1) input').value.trim();
        const masuk = parseFloat(row.querySelector('td:nth-child(2) input').value) || 0;
        const keluar = parseFloat(row.querySelector('td:nth-child(3) input').value) || 0;
        const kelompok = row.querySelector('select').value;

        if (keterangan && (masuk > 0 || keluar > 0)) {
            transactions.push({
                tanggal: tanggal,
                jenis: masuk > 0 ? 'Uang Masuk' : 'Uang Keluar',
                jumlah: masuk > 0 ? masuk : keluar,
                kelompok: kelompok,
                keterangan: keterangan
            });
        }
    });

    if (transactions.length === 0) {
        showMessage('Tidak ada data valid untuk disimpan.', 'error');
        return;
    }

    const saveBtn = document.getElementById('saveKeuanganBtn');
    saveBtn.disabled = true;
    saveBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'submitKeuanganBatch', transactions: transactions }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
            lastKeuanganDate = tanggal; // Simpan tanggal terakhir
            document.getElementById('keuangan-input-tbody').innerHTML = ''; // Kosongkan tabel
            addKeuanganInputRow(); // Tambah satu baris baru
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan Semua';
    });
}
// === SAMPAI DI SINI ===

// === TAMBAHKAN FUNGSI BARU INI ===
function handleSetDefaultDate() {
    const tanggalInput = document.getElementById('tanggalKeuangan');
    if (!tanggalInput.value) {
        showMessage('Silakan pilih tanggal terlebih dahulu.', 'error');
        return;
    }
    lastKeuanganDate = tanggalInput.value;
    localStorage.setItem('lastKeuanganDate', lastKeuanganDate); // Simpan ke localStorage
    showMessage(`Tanggal default diatur ke ${new Date(lastKeuanganDate + 'T00:00:00').toLocaleDateString('id-ID')}`, 'success');

    document.getElementById('tampilkanLaporanKeuanganBtn').click();
}

// FUNGSI BARU UNTUK MENGUNDUH SLIP GAJI SEBAGAI PDF
function downloadSlipPDF() {
    const slipNode = document.getElementById('slipGajiContent'); // Kita akan tambahkan ID ini nanti
    if (!slipNode) return;

    const namaKaryawan = slipNode.dataset.nama;
    const periode = slipNode.dataset.periode;
    const fileName = `Slip Gaji - ${namaKaryawan} - ${periode}.pdf`;

    html2canvas(slipNode, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'portrait',
            unit: 'mm',
            format: 'a5'
        });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(fileName);
    });
}

let isJadwalSholatInitialized = false; // Penanda agar tidak diinisialisasi berulang kali

    function initializeJadwalSholat() {
        if (isJadwalSholatInitialized) return; // Jika sudah, hentikan

        const js_el = {
            lokasi: document.querySelector('#jadwal-sholat #lokasi'),
            resetLokasiBtn: document.querySelector('#jadwal-sholat #reset-lokasi'),
            liveClock: document.querySelector('#jadwal-sholat #live-clock'),
            nextPrayerCountdown: document.querySelector('#jadwal-sholat #next-prayer-countdown'),
            tglMasehi: document.querySelector('#jadwal-sholat #tanggal-masehi'),
            tglHijriah: document.querySelector('#jadwal-sholat #tanggal-hijriah'),
            prevDayBtn: document.querySelector('#jadwal-sholat #prev-day'),
            nextDayBtn: document.querySelector('#jadwal-sholat #next-day'),
            skyContainer: document.querySelector('#jadwal-sholat #sky-container'),
            celestialWrapper: document.querySelector('#jadwal-sholat #celestial-object-wrapper'),
            celestialBody: document.querySelector('#jadwal-sholat #celestial-body'),
            timelineLabels: document.querySelector('#jadwal-sholat #timeline-labels'),
            jadwalContainer: document.querySelector('#jadwal-sholat #jadwal-container'),
            adhanAudio: document.querySelector('#adhan-audio'),
            notifPrompt: document.querySelector('#jadwal-sholat #notif-prompt'),
            enableNotifBtn: document.querySelector('#jadwal-sholat #enable-notif-btn'),
            closeNotifPrompt: document.querySelector('#jadwal-sholat #close-notif-prompt'),
            testAdhanBtn: document.querySelector('#jadwal-sholat #test-adhan-btn'),
            adhanPopupOverlay: document.querySelector('#adhan-popup-overlay'),
            popupPrayerName: document.querySelector('#adhan-popup-overlay #popup-prayer-name'),
            stopAdhanBtn: document.querySelector('#adhan-popup-overlay #stop-adhan-btn'),
        };

        let js_currentDate = new Date();
        let js_prayerDataCache = {};
        let js_mainInterval;
        let js_lastMinute = -1;
        let js_todayPrayerTimes = {};
        let js_scheduledTimers = [];
        let js_isAudioUnlocked = false;
        let js_hijriInfo = { today: null, tomorrow: null };

        // ... (Tempel semua fungsi JavaScript dari jadwalsholat.html di sini, pastikan untuk menggunakan variabel js_el) ...
        // Contoh: const timeToMinutes = (...) menjadi const js_timeToMinutes = (...)
        // Namun, agar lebih sederhana, kita akan langsung menempelnya dan memastikan selectornya benar
        const NOTIF_MODES = ['bell', 'adhan', 'vibrate'];
        const NOTIF_ICONS = { bell: 'ðŸ””', adhan: 'ðŸ”Š', vibrate: 'ðŸ”•' };
        const MOON_PHASES = [
    'ðŸŒ‘', 'ðŸŒ‘', 'ðŸŒ˜', 'ðŸŒ˜', 'ðŸŒ˜', 'ðŸŒ—', 'ðŸŒ—', 'ðŸŒ–', 'ðŸŒ–', 'ðŸŒ–', 
    'ðŸŒ–', 'ðŸŒ•', 'ðŸŒ•', 'ðŸŒ•', 'ðŸŒ•', 'ðŸŒ”', 'ðŸŒ”', 'ðŸŒ”', 'ðŸŒ”', 'ðŸŒ“', 
    'ðŸŒ“', 'ðŸŒ’', 'ðŸŒ’', 'ðŸŒ’', 'ðŸŒ’', 'ðŸŒ‘', 'ðŸŒ‘', 'ðŸŒ‘', 'ðŸŒ‘', 'ðŸŒ‘'
];
        
        const timeToMinutes = (timeStr) => { if (!timeStr) return 0; const [h, m] = timeStr.split(':'); return parseInt(h) * 60 + parseInt(m); };
        const minutesToTime = (totalMinutes) => { const hours = Math.floor(totalMinutes / 60) % 24; const minutes = Math.round(totalMinutes % 60); return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`; };
        const formatLocationName = (address) => [address.village || address.suburb || address.city_district, address.city || address.town, address.state].filter(Boolean).join(', ');
        const getNotifPrefs = () => JSON.parse(localStorage.getItem('prayerNotifPrefs')) || {};
        const saveNotifPrefs = (prefs) => localStorage.setItem('prayerNotifPrefs', JSON.stringify(prefs));

        async function fetchAllData(date, coords) {
            const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
            if (js_prayerDataCache[dateString]) {
                updateUI(js_prayerDataCache[dateString]);
                return;
            }
            const { latitude, longitude } = coords;
            let locationName = `Lat: ${latitude.toFixed(2)}, Long: ${longitude.toFixed(2)}`;
            try {
                const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                if (geoResponse.ok) {
                    const geoData = await geoResponse.json();
                    locationName = formatLocationName(geoData.address);
                }
            } catch (error) { console.error("Gagal mengambil nama lokasi:", error); }
            try {
                const nextDate = new Date(date);
                nextDate.setDate(date.getDate() + 1);
                const [prayerResponse, nextDayPrayerResponse] = await Promise.all([
    fetch(`https://api.aladhan.com/v1/calendar/${date.getFullYear()}/${date.getMonth() + 1}?latitude=${latitude}&longitude=${longitude}&method=20`),
    fetch(`https://api.aladhan.com/v1/calendar/${nextDate.getFullYear()}/${nextDate.getMonth() + 1}?latitude=${latitude}&longitude=${longitude}&method=20`)
]);
                const prayerCalendar = await prayerResponse.json();
                const nextDayPrayerCalendar = await nextDayPrayerResponse.json();
                const dailyData = prayerCalendar.data[date.getDate() - 1];
                dailyData.timings.NextFajr = nextDayPrayerCalendar.data[0].timings.Fajr;
                const fullData = { locationName, timings: dailyData.timings, date: dailyData.date, coords };
                js_prayerDataCache[dateString] = fullData;
                updateUI(fullData);
            } catch (error) {
                js_el.lokasi.textContent = "Gagal mengambil jadwal sholat.";
                console.error(error);
            }
        }
        function updateUI(data) {
            js_el.lokasi.textContent = data.locationName;
            js_el.tglMasehi.textContent = data.date.readable;
            const today = new Date();
const dateBeingDisplayed = new Date(js_currentDate);
today.setHours(0, 0, 0, 0);
dateBeingDisplayed.setHours(0, 0, 0, 0);

let dateForHijriCalc = new Date(dateBeingDisplayed);
// 1. Tambahkan offset 7 jam untuk mengompensasi konversi ke UTC
dateForHijriCalc.setHours(dateForHijriCalc.getHours() + ZONA_WAKTU_OFFSET_JAM);

// 2. Terapkan logika Maghrib hanya jika melihat tanggal hari ini
if (dateBeingDisplayed.getTime() === today.getTime()) {
    const maghribTime = timeToMinutes(data.timings.Maghrib);
    const nowInMinutes = new Date().getHours() * 60 + new Date().getMinutes();
    if (nowInMinutes >= maghribTime) {
        dateForHijriCalc.setDate(dateForHijriCalc.getDate() + 1);
    }
}

// 3. Gunakan formatter yang sama persis dengan di header
const formatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic-umalqura-nu-latn', {
    day: 'numeric', month: 'numeric', year: 'numeric', timeZone: 'UTC'
});
const parts = formatter.formatToParts(dateForHijriCalc);
const day = parts.find(p => p.type === 'day').value;
const monthIndex = parts.find(p => p.type === 'month').value - 1;
const year = parts.find(p => p.type === 'year').value;
const monthName = namaBulanHijriah[monthIndex];

js_el.tglHijriah.textContent = `${day} ${monthName} ${year} H`;
            js_todayPrayerTimes = { "Subuh": data.timings.Fajr, "Terbit": data.timings.Sunrise, "Dzuhur": data.timings.Dhuhr, "Ashar": data.timings.Asr, "Maghrib": data.timings.Maghrib, "Isya": data.timings.Isha, "NextFajr": data.timings.NextFajr };
            js_el.jadwalContainer.innerHTML = '';
            const prefs = getNotifPrefs();
            for (const name of ["Subuh", "Terbit", "Dzuhur", "Ashar", "Maghrib", "Isya"]) {
                const time = js_todayPrayerTimes[name];
                const currentPref = prefs[name] || 'bell';
                const scheduleItem = document.createElement('div');
                scheduleItem.className = 'jadwal-item';
                scheduleItem.id = `jadwal-${name}`;
                scheduleItem.innerHTML = `<div class="prayer-details"><button class="notification-btn" data-prayer="${name}">${NOTIF_ICONS[currentPref]}</button><div class="prayer-info"><span class="prayer-name">${name}</span><span class="prayer-countdown"></span></div></div><span class="waktu">${time.substring(0, 5)}</span>`;
                js_el.jadwalContainer.appendChild(scheduleItem);
            }
            js_el.jadwalContainer.querySelectorAll('.notification-btn').forEach(btn => btn.addEventListener('click', handleNotifBtnClick));
            scheduleAllNotifications(js_todayPrayerTimes);
            if (js_mainInterval) clearInterval(js_mainInterval);
            js_mainInterval = setInterval(tick, 1000);
            tick(true);
        }
        function updateSkyAnimation(data) {
            const now = new Date();
            const nowInMinutes = now.getHours() * 60 + now.getMinutes();
            const timings = data.timings;
            const shuruq = timeToMinutes(timings.Sunrise);
            const maghrib = timeToMinutes(timings.Maghrib);
            const isDay = nowInMinutes >= shuruq && nowInMinutes < maghrib;
            js_el.skyContainer.classList.toggle('night', !isDay);
            if (isDay) {
                js_el.celestialBody.textContent = 'â˜€ï¸';
            } else {
                const hijriDay = parseInt(data.date.hijri.day);
            // Logika baru: Hitung indeks fase berdasarkan proporsi hari dalam sebulan (asumsi 30 hari)
            const phaseIndex = Math.floor(((hijriDay - 1) / 29.5) * MOON_PHASES.length);
            js_el.celestialBody.textContent = MOON_PHASES[phaseIndex] || 'ðŸŒ‘';
        }
            js_el.timelineLabels.innerHTML = '';
            let timelineDef;
            if (isDay) {
                timelineDef = { "Subuh": timings.Fajr, "Terbit": timings.Sunrise, "Dzuhur": timings.Dhuhr, "Ashar": timings.Asr, "Maghrib": timings.Maghrib };
            } else {
                const nightDuration = (timeToMinutes(timings.NextFajr) + 24 * 60) - maghrib;
                const lastThirdTime = minutesToTime(maghrib + (nightDuration * 2 / 3));
                timelineDef = { "Maghrib": timings.Maghrib, "Isya": timings.Isha, "1/3 Malam": lastThirdTime, "Subuh": timings.Fajr };
            }
            for (const [name, time] of Object.entries(timelineDef)) {
                const labelItem = document.createElement('div');
                labelItem.className = 'label-item';
                labelItem.innerHTML = `<span>${name}</span><span>${time.substring(0, 5)}</span>`;
                js_el.timelineLabels.appendChild(labelItem);
            }
            let rotationAngle;
            if (isDay) {
                const progress = Math.max(0, Math.min(1, (nowInMinutes - shuruq) / (maghrib - shuruq)));
                rotationAngle = (progress * 180) - 90;
            } else {
                let totalNight, elapsed;
                if (nowInMinutes < shuruq) {
                    const prevMaghrib = maghrib - (24 * 60);
                    totalNight = shuruq - prevMaghrib;
                    elapsed = nowInMinutes - prevMaghrib;
                } else {
                    const nextShuruq = shuruq + (24 * 60);
                    totalNight = nextShuruq - maghrib;
                    elapsed = nowInMinutes - maghrib;
                }
                const progress = Math.max(0, Math.min(1, elapsed / totalNight));
                rotationAngle = (progress * 180) - 90;
            }
            js_el.celestialWrapper.style.transform = `rotate(${rotationAngle}deg)`;
        }
        function updateCountdownAndHighlights() {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const prayerSchedule = [
                { name: "Subuh", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Subuh) * 60000) },
                { name: "Terbit", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Terbit) * 60000) },
                { name: "Dzuhur", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Dzuhur) * 60000) },
                { name: "Ashar", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Ashar) * 60000) },
                { name: "Maghrib", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Maghrib) * 60000) },
                { name: "Isya", time: new Date(today.getTime() + timeToMinutes(js_todayPrayerTimes.Isya) * 60000) },
                { name: "NextFajr", time: new Date(today.getTime() + (timeToMinutes(js_todayPrayerTimes.NextFajr) + 24 * 60) * 60000) }
            ];
            let nextPrayer = prayerSchedule.find(p => p.time > now);
            let currentPrayer = [...prayerSchedule].reverse().find(p => p.time <= now);
            js_el.jadwalContainer.querySelectorAll('.jadwal-item').forEach(item => {
                item.classList.remove('highlight');
                const countdownEl = item.querySelector('.prayer-countdown');
                if(countdownEl) countdownEl.style.display = 'none';
            });
            if (nextPrayer) {
                const msRemaining = nextPrayer.time - now;
                const totalSeconds = Math.floor(msRemaining / 1000);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const nextPrayerName = nextPrayer.name === 'NextFajr' ? 'Subuh' : nextPrayer.name;
                js_el.nextPrayerCountdown.innerHTML = `Menuju ${nextPrayerName}: <span id="countdown-timer">${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}</span>`;
                const minutesRemaining = Math.floor(totalSeconds / 60);
                if (minutesRemaining < 30) {
                    const itemToHighlight = js_el.jadwalContainer.querySelector(`#jadwal-${nextPrayerName}`);
                    if (itemToHighlight) {
                        itemToHighlight.classList.add('highlight');
                        const countdownEl = itemToHighlight.querySelector('.prayer-countdown');
                        if (countdownEl) {
                            countdownEl.textContent = `dalam ${minutesRemaining + 1} menit`;
                            countdownEl.style.display = 'block';
                        }
                    }
                } else if (currentPrayer) {
                    const currentPrayerName = currentPrayer.name === 'NextFajr' ? 'Subuh' : currentPrayer.name;
                    const itemToHighlight = js_el.jadwalContainer.querySelector(`#jadwal-${currentPrayerName}`);
                    if (itemToHighlight) {
                        itemToHighlight.classList.add('highlight');
                        const countdownEl = itemToHighlight.querySelector('.prayer-countdown');
                        if (countdownEl) {
                           countdownEl.textContent = `Menuju ${nextPrayerName} ${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                           countdownEl.style.display = 'block';
                        }
                    }
                }
            } else {
                js_el.nextPrayerCountdown.innerHTML = "Waktu sholat hari ini telah selesai.";
            }
        }
		
		// FUNGSI BARU UNTUK UPDATE TOMBOL MENGAMBANG
        function updateFloatingPrayerButton() {
            const btn = document.getElementById('floating-prayer-btn');
            const btnText = document.getElementById('floating-prayer-text');
            if (!btn || !btnText) return;

            // Cari item jadwal yang sedang di-highlight (berwarna hijau)
            const highlightedItem = document.querySelector('.jadwal-item.highlight');

            if (highlightedItem) {
                const prayerNameEl = highlightedItem.querySelector('.prayer-name');
                const countdownEl = highlightedItem.querySelector('.prayer-countdown');
                
                if (prayerNameEl) {
                    const prayerName = prayerNameEl.textContent;
                    // Cek apakah countdown (misal: "dalam 15 menit") sedang tampil
                    if (countdownEl && countdownEl.style.display !== 'none') {
                        btn.classList.add('highlight');
                        btnText.textContent = `${prayerName} ${countdownEl.textContent}`;
                    } else {
                        // Jika tidak, tampilkan nama sholat yang sedang berlangsung
                        btn.classList.remove('highlight');
                        btnText.textContent = `Waktu ${prayerName} sedang berlangsung`;
                    }
                    btn.classList.add('visible'); // Tampilkan tombol
                }
            } else {
                btn.classList.remove('visible'); // Sembunyikan tombol jika tidak ada jadwal highlight
            }
        }
		
		
        function tick(forceSkyUpdate = false) {
            const now = new Date();
            js_el.liveClock.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            if (Object.keys(js_todayPrayerTimes).length > 0) {
                updateCountdownAndHighlights();
				updateFloatingPrayerButton();
            }
            if (now.getMinutes() !== js_lastMinute || forceSkyUpdate) {
                const dateString = `${js_currentDate.getDate()}-${js_currentDate.getMonth() + 1}-${js_currentDate.getFullYear()}`;
                if (js_prayerDataCache[dateString]) { updateSkyAnimation(js_prayerDataCache[dateString]); }
                js_lastMinute = now.getMinutes();
            }
        }
        function unlockAudio() {
            if (js_isAudioUnlocked) return;
            js_el.adhanAudio.play().then(() => {
                js_el.adhanAudio.pause();
                js_el.adhanAudio.currentTime = 0;
                js_isAudioUnlocked = true;
                console.log("Konteks audio berhasil diaktifkan.");
            }).catch(e => console.warn("Gagal membuka kunci audio, diperlukan interaksi pengguna.", e));
        }
        function handleNotifBtnClick(event) {
            unlockAudio();
            const btn = event.currentTarget;
            const prayerName = btn.dataset.prayer;
            if (Notification.permission === 'default') { Notification.requestPermission().then(permission => { if (permission === 'granted') { scheduleAllNotifications(js_todayPrayerTimes); } }); }
            const prefs = getNotifPrefs();
            const currentPref = prefs[prayerName] || 'bell';
            const currentIndex = NOTIF_MODES.indexOf(currentPref);
            const nextIndex = (currentIndex + 1) % NOTIF_MODES.length;
            const nextPref = NOTIF_MODES[nextIndex];
            prefs[prayerName] = nextPref;
            saveNotifPrefs(prefs);
            btn.textContent = NOTIF_ICONS[nextPref];
            scheduleAllNotifications(js_todayPrayerTimes);
        }
        function scheduleAllNotifications(timings) {
            js_scheduledTimers.forEach(timerId => clearTimeout(timerId));
            js_scheduledTimers = [];
            if (Notification.permission !== 'granted') return;
            const prefs = getNotifPrefs();
            const now = new Date();
            for (const name of ["Subuh", "Dzuhur", "Ashar", "Maghrib", "Isya"]) {
                const prayerTimeStr = timings[name];
                if (!prayerTimeStr) continue;
                const prayerDate = new Date();
                const [h, m] = prayerTimeStr.split(':');
                prayerDate.setHours(h, m, 0, 0);
                if (prayerDate > now) {
                    const timeToNotif = prayerDate.getTime() - now.getTime();
                    const pref = prefs[name] || 'bell';
                    const timerId = setTimeout(() => { triggerNotification(name, pref); }, timeToNotif);
                    js_scheduledTimers.push(timerId);
                }
            }
        }
        function triggerNotification(prayerName, preference) {
            const title = `Waktu Sholat ${prayerName} Telah Tiba`;
            const options = { body: `Saatnya menunaikan sholat.`, icon: 'https://cdn-icons-png.flaticon.com/512/3039/3039017.png', tag: `prayer-time-${prayerName}` };
            if (preference === 'adhan') {
                js_el.popupPrayerName.textContent = prayerName;
                js_el.adhanPopupOverlay.style.display = 'flex';
                js_el.adhanAudio.currentTime = 0;
                js_el.adhanAudio.play().catch(e => {
                    console.error("Gagal memutar Adzan:", e);
                    new Notification(title, { body: 'Gagal memutar suara, saatnya sholat.', icon: options.icon });
                });
            } else {
                if (preference === 'vibrate') {
                    options.body = 'Pengingat getar untuk sholat.';
                    options.vibrate = [200, 100, 200];
                }
                new Notification(title, options);
            }
        }
        function requestAndSaveLocation() {
            js_el.lokasi.textContent = "Meminta izin lokasi...";
            navigator.geolocation.getCurrentPosition(
                position => {
                    const coords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    localStorage.setItem('userLocation', JSON.stringify(coords));
                    fetchAllData(js_currentDate, coords);
                },
                error => { js_el.lokasi.textContent = "Izin lokasi ditolak."; console.error(error); },
                { enableHighAccuracy: false, timeout: 10000 }
            );
        }
        function checkNotificationPermission() {
            if ('Notification' in window) {
                const isDismissed = sessionStorage.getItem('notifPromptDismissed');
                if (Notification.permission === 'default' && !isDismissed) {
                    js_el.notifPrompt.style.display = 'block';
                }
            }
        }
        
        const savedLocation = localStorage.getItem('userLocation');
        if (savedLocation) {
            fetchAllData(js_currentDate, JSON.parse(savedLocation));
        } else {
            requestAndSaveLocation();
        }
        
        checkNotificationPermission();

        js_el.enableNotifBtn.addEventListener('click', () => {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') { scheduleAllNotifications(js_todayPrayerTimes); }
                js_el.notifPrompt.style.display = 'none';
                sessionStorage.setItem('notifPromptDismissed', 'true');
            });
        });
        js_el.closeNotifPrompt.addEventListener('click', () => {
            js_el.notifPrompt.style.display = 'none';
            sessionStorage.setItem('notifPromptDismissed', 'true');
        });
        js_el.testAdhanBtn.addEventListener('click', () => {
            unlockAudio();
            if (js_el.adhanAudio.paused) {
                js_el.adhanAudio.currentTime = 0;
                js_el.adhanAudio.play().catch(e => alert("Gagal memutar audio. Pastikan tidak di-mute."));
            } else {
                js_el.adhanAudio.pause();
            }
        });
        js_el.stopAdhanBtn.addEventListener('click', () => {
            js_el.adhanAudio.pause();
            js_el.adhanAudio.currentTime = 0;
            js_el.adhanPopupOverlay.style.display = 'none';
        });
        js_el.adhanAudio.addEventListener('play', () => {
            js_el.testAdhanBtn.innerHTML = 'ðŸ”‡ Matikan Suara Adzan';
            js_el.testAdhanBtn.classList.add('playing');
        });
        js_el.adhanAudio.addEventListener('pause', () => {
            js_el.testAdhanBtn.innerHTML = 'ðŸ”Š Tes Suara Adzan';
            js_el.testAdhanBtn.classList.remove('playing');
        });
        js_el.adhanAudio.addEventListener('ended', () => {
            js_el.testAdhanBtn.innerHTML = 'ðŸ”Š Tes Suara Adzan';
            js_el.testAdhanBtn.classList.remove('playing');
            js_el.adhanPopupOverlay.style.display = 'none';
        });
        js_el.prevDayBtn.addEventListener('click', () => {
            js_currentDate.setDate(js_currentDate.getDate() - 1);
            const coords = JSON.parse(localStorage.getItem('userLocation'));
            if(coords) fetchAllData(js_currentDate, coords);
        });
        js_el.nextDayBtn.addEventListener('click', () => {
            js_currentDate.setDate(js_currentDate.getDate() + 1);
            const coords = JSON.parse(localStorage.getItem('userLocation'));
            if(coords) fetchAllData(js_currentDate, coords);
        });
        js_el.resetLokasiBtn.addEventListener('click', () => {
            localStorage.removeItem('userLocation');
            js_prayerDataCache = {};
            js_el.jadwalContainer.innerHTML = '';
            js_el.timelineLabels.innerHTML = '';
            if (js_mainInterval) clearInterval(js_mainInterval);
            requestAndSaveLocation();
        });

        isJadwalSholatInitialized = true; // Tandai sudah diinisialisasi
    }

// // GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU INI
function showPage(hash) {
	
	cleanupPengawasUjianPage();
    // (BARU) Ambil referensi ke tombol mengambang
    const floatingBtn = document.getElementById('floatingRubrikBtn');

    // Selalu sembunyikan semua bagian dulu
    document.querySelectorAll('.page-section').forEach(sec => sec.classList.add('hidden'));
	document.getElementById('tahfidz-chart-container').classList.add('hidden');
    // (BARU) Sembunyikan tombol mengambang secara default
    if (floatingBtn) floatingBtn.classList.add('hidden');
	
	const targetHash = (hash === '' || hash === '#') ? '#beranda' : hash;
	
	if (targetHash === '#jadwal-sholat') {
            const section = document.querySelector(hash);
            if (section) {
                section.classList.remove('hidden');
            }
            return;
        }
    else if (targetHash === '#lihat-nilai') {
            setupLihatNilaiPage();
        }
    // (Sisa logika KHS/KRS Anda tetap sama)
    if (hash === '#krs' || hash === '#khs') {
		if (!isSistemInformasiInitialized) {
			initializeSistemInformasi();
		}
        const santriSection = document.getElementById('santri');
        if (santriSection) {
            santriSection.classList.remove('hidden');
            const session = getActiveSession();
            if (session && session.userData && (session.userData.jabatan || '').trim().toLowerCase() === 'santri') {
                const loggedInSantriName = session.userData.profileName;
				const santriData = appData.santri.find(s => s.nama === loggedInSantriName);
				const kelompokSantri = santriData ? santriData.grup : 'Data tidak ditemukan';

				document.getElementById('santri-selection-container').classList.remove('hidden');
				document.getElementById('santri-selector-name').textContent = `: ${loggedInSantriName}`;
				document.getElementById('santri-selector-group').textContent = `: ${kelompokSantri}`;

				const monthSelector = document.getElementById('santri-month-selector');
				if (monthSelector.options.length === 0) {
					const months = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
					months.forEach((month, index) => {
						const option = document.createElement('option');
						option.value = index + 1;
						option.textContent = month;
						monthSelector.appendChild(option);
					});
				}
				
				const showReportBtn = document.getElementById('show-report-btn');
				showReportBtn.classList.remove('krs-btn-color', 'khs-btn-color');
				if (hash === '#krs') {
					showReportBtn.textContent = 'Tampilkan KRS';
					showReportBtn.dataset.reportType = 'krs';
					showReportBtn.classList.add('krs-btn-color');
				} else {
					showReportBtn.textContent = 'Tampilkan KHS';
					showReportBtn.dataset.reportType = 'khs';
					showReportBtn.classList.add('khs-btn-color');
				}
                
                document.getElementById('krs-container').classList.add('hidden');
                document.getElementById('khs-container').classList.add('hidden');
            }
        }
        return;
    }

    // =======================================================
    // === LOGIKA STANDAR UNTUK SEMUA HALAMAN LAINNYA ===
    // =======================================================
    
    const sectionToShow = document.querySelector(targetHash);

    if (sectionToShow) {
        sectionToShow.classList.remove('hidden');
        if (targetHash === '#roster-kbm' && !isSistemInformasiInitialized) {
            initializeSistemInformasi();
        } else if (targetHash === '#absensi') {
            const session = getActiveSession();
            const name = (session && session.userData) ? session.userData.profileName : "Anda harus login";
            const jabatan = (session && session.userData) ? session.userData.jabatan || '' : "Anda harus login";
            document.getElementById('teacherNameDisplay').value = name;
            document.getElementById('stafNameDisplay').value = name;
            document.getElementById('rapatNameDisplay').value = name;
            document.getElementById('jabatanStaf').value = jabatan;
            populateTeacherClasses(session, document.getElementById('attendanceDateGuru').value);
            if (session && session.loggedIn) {
                fetchAndRenderAttendanceHistory(session.userData.profileName);
            }
        } else if (targetHash === '#musyrif') {
            // --- AWAL PERBAIKAN ---
            const session = getActiveSession();
            const username = session ? session.username : '';
            const jabatan = (session && session.userData) ? session.userData.jabatan : '';
			if (floatingBtn) floatingBtn.classList.remove('hidden');
            // Logika pengecekan disamakan dengan logika di menu nav
            if (session && session.loggedIn && (jabatan === 'Musyrif' || ['wawan', 'admin'].includes(username))) {
                populateSantriDropdowns('musyrif');
				buatDropdownSurah('ziyadahPSurahMusyrif');
				buatDropdownSurah('ziyadahSSurahMusyrif');
				buatDropdownSurah('murajaahSurahAwalMusyrif');
				buatDropdownSurah('murajaahSurahAkhirMusyrif');
                setupMusyrifEventListeners('musyrif');
                fetchAndRenderDailyReports('musyrif');
                document.querySelectorAll('#musyrif input[type="date"]').forEach(input => input.value = new Date().toISOString().slice(0, 10));
            }
            // --- AKHIR PERBAIKAN ---
        } else if (targetHash === '#musyrifah') {
            // --- AWAL PERBAIKAN ---
            const session = getActiveSession();
            const username = session ? session.username : '';
            const jabatan = (session && session.userData) ? session.userData.jabatan : '';
			if (floatingBtn) floatingBtn.classList.remove('hidden');
            // Logika pengecekan disamakan dengan logika di menu nav
            if (session && session.loggedIn && (jabatan === 'Musyrifah' || ['wawan', 'admin'].includes(username))) {
                populateSantriDropdowns('musyrifah');
				buatDropdownSurah('ziyadahPSurahMusyrifah');
				buatDropdownSurah('ziyadahSSurahMusyrifah');
				buatDropdownSurah('murajaahSurahAwalMusyrifah');
				buatDropdownSurah('murajaahSurahAkhirMusyrifah');
                setupMusyrifEventListeners('musyrifah');
                fetchAndRenderDailyReports('musyrifah');
                document.querySelectorAll('#musyrifah input[type="date"]').forEach(input => input.value = new Date().toISOString().slice(0, 10));
            }
            // --- AKHIR PERBAIKAN ---
        } else if (targetHash === '#laporan') {
			const session = getActiveSession();
			const userJabatan = (session && session.userData) ? (session.userData.jabatan || '').toLowerCase().trim() : '';
			const allowedJabatan = ['waka kurikulum', 'kepala rumah tahfidz quran', 'kepala rumah anak yatim', 'admin', 'wawan'];

			if (session && session.loggedIn) {
				const datePicker = document.getElementById('laporanTanggal');
				if (!datePicker.dataset.listenerAttached) {
					datePicker.addEventListener('change', (e) => {
    fetchAndRenderAllDailyReports(e.target.value); // Panggil fungsi yang baru
});
					datePicker.dataset.listenerAttached = 'true';
				}
				datePicker.value = new Date().toISOString().slice(0, 10);
				fetchAndRenderAllDailyReports(datePicker.value);

				if (allowedJabatan.includes(userJabatan) || session.username === 'wawan' || session.username === 'admin') {
					document.getElementById('tahfidz-chart-container').classList.remove('hidden');
					const santriList = [...new Set([...appData.santriMusyrif, ...appData.santriMusyrifah])].sort();
					const santriSelect = document.getElementById('chart-santri-select');
					santriSelect.innerHTML = '<option value="">-- Pilih Santri --</option>';
					santriList.forEach(name => {
						santriSelect.innerHTML += `<option value="${name}">${name}</option>`;
					});
					const endDateInput = document.getElementById('chart-end-date');
					const startDateInput = document.getElementById('chart-start-date');
					const today = new Date();
					endDateInput.value = today.toISOString().slice(0, 10);
					today.setDate(today.getDate() - 30);
					startDateInput.value = today.toISOString().slice(0, 10);
					document.getElementById('show-chart-btn').onclick = async () => {
    const santriName = santriSelect.value;
    if (!santriName) {
        alert("Silakan pilih nama santri.");
        return;
    }

    const btn = document.getElementById('show-chart-btn');
    btn.disabled = true;
    btn.textContent = 'Memuat...';

    // Tampilkan pesan loading di kedua kontainer
    // (Kita tampilkan di keduanya, karena kita tidak tahu tab mana yang aktif)
    document.getElementById('ziyadah-chart-content').innerHTML = '<p class="p-8 text-center text-gray-500">Memuat grafik...</p>';
    document.getElementById('murajaah-chart-content').innerHTML = '<p class="p-8 text-center text-gray-500">Memuat grafik...</p>';

    try {
        // Panggil KEDUA fungsi render
        await renderTahfidzChart(santriName, startDateInput.value, endDateInput.value);
        await renderMurajaahJuzChart(santriName);
    } catch (error) {
        showMessage('Gagal memuat grafik: ' + error.message, 'error');
        // Jika gagal, bersihkan pesan loading
        document.getElementById('ziyadah-chart-content').innerHTML = '';
        document.getElementById('murajaah-chart-content').innerHTML = '';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Tampilkan Grafik';
    }
};

// === AWAL KODE BARU: EVENT LISTENER TABS ===
const tabZiyadah = document.getElementById('tab-ziyadah');
const tabMurajaah = document.getElementById('tab-murajaah');
const contentZiyadah = document.getElementById('ziyadah-chart-content');
const contentMurajaah = document.getElementById('murajaah-chart-content');

// Atur tab Ziyadah sebagai default
tabZiyadah.classList.add('bg-white', 'text-teal-600', 'font-bold');
tabZiyadah.classList.remove('bg-gray-100', 'text-gray-700');

tabZiyadah.addEventListener('click', (e) => {
    e.preventDefault();
    contentZiyadah.classList.remove('hidden');
    contentMurajaah.classList.add('hidden');
    tabZiyadah.classList.add('bg-white', 'text-teal-600', 'font-bold');
    tabZiyadah.classList.remove('bg-gray-100', 'text-gray-700');
    tabMurajaah.classList.add('bg-gray-100', 'text-gray-700');
    tabMurajaah.classList.remove('bg-white', 'text-teal-600', 'font-bold');
});

tabMurajaah.addEventListener('click', (e) => {
    e.preventDefault();
    contentZiyadah.classList.add('hidden');
    contentMurajaah.classList.remove('hidden');
    tabMurajaah.classList.add('bg-white', 'text-teal-600', 'font-bold');
    tabMurajaah.classList.remove('bg-gray-100', 'text-gray-700');
    tabZiyadah.classList.add('bg-gray-100', 'text-gray-700');
    tabZiyadah.classList.remove('bg-white', 'text-teal-600', 'font-bold');
});
				}
			}
			} else if (targetHash === '#hafalan') {
        const session = getActiveSession();
        // Pastikan itu santri, lalu panggil fungsi render baru
        if (session && session.loggedIn && (session.userData.jabatan || '').trim().toLowerCase() === 'santri') {
            const santriName = session.userData.profileName;
            // Panggil fungsi render baru yang akan kita buat
            renderSantriHafalanChart(santriName);
        }
        } else if (targetHash === '#slip-gaji') {
    const session = getActiveSession();
    if (session && session.loggedIn) {
        const userJabatan = session.userData.jabatan || '';
        
        // --- (PERUBAHAN DI SINI) ---
        // Menambahkan pengecekan 'isBendahara'
        const isBendahara = (userJabatan.toLowerCase().trim() === 'bendahara');
        // (DIPERBARUI) Menyatukan daftar admin slip gaji
        const isAdminGaji = (session.username === 'aria' || session.username === 'wawan' || session.username === 'admin' || session.username === 'yeni' || isBendahara);
        // --- AKHIR PERUBAHAN ---

        const employeeSelector = document.getElementById('employeeSelectorContainer');
        
        populateMonthYearDropdowns(document.getElementById('monthSelectNew'), document.getElementById('yearSelect'));

        // (DIPERBARUI) Menggunakan 'isAdminGaji'
        if (isAdminGaji) {
            employeeSelector.classList.remove('hidden');
            populateEmployeeDropdown();
        } else {
            employeeSelector.classList.add('hidden');
        }
        
        const showBtn = document.getElementById('showSlipGajiBtn');
        if (!showBtn.dataset.listenerAttached) {
            showBtn.addEventListener('click', fetchAndRenderSlipGaji);
            showBtn.dataset.listenerAttached = 'true';
        }
        
        document.getElementById('tampilkanTotalGajiBtn')?.addEventListener('click', () => {
            const bulan = document.getElementById('totalGajiBulan').value;
            const tahun = document.getElementById('totalGajiTahun').value;
            const periode = `${tahun}-${bulan}`;
            const reportContainer = document.getElementById('total-gaji-report-container');
            const btn = document.getElementById('tampilkanTotalGajiBtn');

            reportContainer.innerHTML = '<p class="p-4 text-center text-gray-500">Memuat laporan total gaji...</p>';
            btn.disabled = true;
            btn.textContent = 'Memuat...';

            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'getPayrollReport', 
                    periode: periode,
                    requesterUsername: getActiveSession().username // (BARU) Tambahkan ini
                }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    renderTotalGajiTable(result.report, result.grandTotal);
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                reportContainer.innerHTML = `<p class="p-4 text-center text-red-500">Gagal memuat: ${error.message}</p>`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'Tampilkan Laporan';
            });
        });
        
    }
} else if (targetHash === '#laporan-keuangan') {
            const session = getActiveSession();
            const allowedUsers = ['mia', 'wawan', 'aria', 'yeni', 'billy', 'admin'];
            if (session && session.loggedIn && allowedUsers.includes(session.username)) {
                // setupKeuanganEventListeners();
                const bulanSelect = document.getElementById('laporanBulan');
                const tahunSelect = document.getElementById('laporanTahun');
                if (bulanSelect.options.length === 0) {
                    populateMonthYearDropdowns(bulanSelect, tahunSelect);
                }
                const formContainer = document.getElementById('keuangan-form-container');
                const tableContainer = document.getElementById('keuangan-input-table-container');
                const tanggalInput = document.getElementById('tanggalKeuangan');
                formContainer.classList.remove('hidden');
                tanggalInput.value = lastKeuanganDate;
                if (session.username === 'mia' || session.username === 'wawan' || session.username === 'admin') {
                    tableContainer.classList.remove('hidden');
                    if (document.getElementById('keuangan-input-tbody').children.length === 0) {
                        addKeuanganInputRow();
                    }
                } else {
                    tableContainer.classList.add('hidden');
                }
                if (!tanggalInput.dataset.listenerAttached) {
                    tanggalInput.addEventListener('change', () => {
                        if (session.username === 'mia') {
                            tableContainer.classList.remove('hidden');
                            if (document.getElementById('keuangan-input-tbody').children.length === 0) {
                                addKeuanganInputRow();
                            }
                        }
                        document.getElementById('tampilkanLaporanKeuanganBtn').click();
                    });
                    tanggalInput.dataset.listenerAttached = 'true';
                }
                setupKeuanganEventListeners();
                document.getElementById('tampilkanLaporanKeuanganBtn').click();
            }
        }
		else if (targetHash === '#halaman-guru') {
			setupHalamanGuru();
		} else if (targetHash === '#halaman-ujian-admin') {
					setupHalamanUjianAdmin();
				}
				 else if (targetHash === '#pengawas-ujian') {
            setupPengawasUjianPage();
        }
		} else if (targetHash === '#ujian-online') {
            const section = document.querySelector(targetHash);
            if (section) {
                section.classList.remove('hidden');
                // Panggil fungsi untuk memuat ulang jadwal ujian
                renderExamSchedule(); 
            }
    } else {
        document.getElementById('beranda').classList.remove('hidden');
    }
}

// DITAMBAHKAN: Fungsi baru untuk menampilkan daftar ujian yang dibuka
async function renderUnlockedExamsList() {
    const container = document.getElementById('admin-unlocked-exams-list');
    container.innerHTML = `<p class="text-gray-500">Memuat daftar...</p>`;
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAllUnlockedExams' }) });
        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        if (result.data.length === 0) {
            container.innerHTML = `<p class="text-gray-500">Tidak ada ujian yang sedang dibuka secara manual.</p>`;
            return;
        }

        // Kelompokkan data berdasarkan santri
        const groupedBySantri = result.data.reduce((acc, item) => {
            const santriName = appData.santri.find(s => (s.username || s.nama.toLowerCase().replace(/\s/g, '')) === item.usernameSantri)?.nama || item.usernameSantri;
            if (!acc[santriName]) {
                acc[santriName] = [];
            }
            acc[santriName].push(item);
            return acc;
        }, {});
        
        container.innerHTML = '';
        for (const santriName in groupedBySantri) {
            let materiHtml = groupedBySantri[santriName].map(item => `
                <div class="ml-6"><input type="checkbox" value="${item.rowNum}" class="mr-2 unlocked-exam-cb"><label>${item.kodeMateri}</label></div>
            `).join('');
            container.innerHTML += `
                <div class="py-2 border-b">
                    <p class="font-bold">${santriName}:</p>
                    ${materiHtml}
                </div>
            `;
        }

    } catch(error) {
        container.innerHTML = `<p class="text-red-500">${error.message}</p>`;
    }
}

// DIUBAH TOTAL: Fungsi setup utama untuk halaman admin
async function setupHalamanUjianAdmin() {
    const santriContainer = document.getElementById('admin-santri-list-container');
    const materiSelect = document.getElementById('admin-materi-select'); // (DIUBAH)
    const bukaUjianBtn = document.getElementById('buka-ujian-btn');
    const tutupUjianBtn = document.getElementById('tutup-ujian-btn');

    const jenisUjianSelect = document.getElementById('admin-jenis-ujian');
    const namaUjianInput = document.getElementById('admin-nama-ujian');
    const namaUjianHelp = document.getElementById('admin-nama-ujian-help');

    jenisUjianSelect.addEventListener('change', () => {
        if (jenisUjianSelect.value === 'Bulanan') {
            namaUjianInput.value = '';
            namaUjianInput.placeholder = 'Otomatis (sama dengan nama materi)';
            namaUjianInput.disabled = true;
            namaUjianHelp.classList.add('hidden');
        } else {
            namaUjianInput.value = '';
            namaUjianInput.placeholder = 'Ketik nama ujian...';
            namaUjianInput.disabled = false;
            namaUjianHelp.classList.remove('hidden');
        }
    });
    jenisUjianSelect.dispatchEvent(new Event('change'));

    // Populate Santri & Materi
    santriContainer.innerHTML = '<p>Memuat daftar santri...</p>';
    materiSelect.innerHTML = '<option value="">Memuat materi ujian...</option>';
    
    try {
        const [santriResponse, examsResponse] = await Promise.all([
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getSantriListWithUsernames' }) }),
            fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'getAvailableExams' }) })
        ]);
        const santriResult = await santriResponse.json();
        if(santriResult.status !== 'success') throw new Error(santriResult.message);
        santriContainer.innerHTML = '';
        santriResult.santri.sort((a, b) => a.profileName.localeCompare(b.profileName)).forEach(s => {
            santriContainer.innerHTML += `<div><input type="checkbox" id="santri_${s.username}" value="${s.username}" class="mr-2"><label for="santri_${s.username}">${s.profileName}</label></div>`;
        });

        const examsResult = await examsResponse.json();
        if(examsResult.status !== 'success') throw new Error(examsResult.message);
        materiSelect.innerHTML = '<option value="">Pilih 1 Materi...</option>'; // (DIUBAH)
        
        const uniqueSubjects = new Map();
        Object.values(appState.processedSchedules).flat().forEach(item => {
            if (item.subject && item.subject.includes(':')) {
                const code = item.subject.split(':')[0].trim();
                if (examsResult.availableExams.includes(code) && !uniqueSubjects.has(code)) {
                    uniqueSubjects.set(code, item.subject);
                }
            }
        });
        Array.from(uniqueSubjects.entries()).sort((a, b) => a[1].localeCompare(b[1])).forEach(([code, subject]) => {
            materiSelect.innerHTML += `<option value="${code}">${subject}</option>`; // (DIUBAH)
        });
    } catch(error) {
        santriContainer.innerHTML = `<p class="text-red-500">${error.message}</p>`;
        materiSelect.innerHTML = `<option value="">${error.message}</option>`;
    }
	
	const selectAllSantriCheckbox = document.getElementById('select-all-santri');
    if (selectAllSantriCheckbox) {
        selectAllSantriCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            const santriCheckboxes = document.querySelectorAll('#admin-santri-list-container input[type="checkbox"]');
            santriCheckboxes.forEach(cb => {
                cb.checked = isChecked;
            });
        });
    }
	
    // (DIPERBARUI) Event listener untuk tombol "Buka Ujian"
    bukaUjianBtn.onclick = async () => {
        const selectedSantri = Array.from(santriContainer.querySelectorAll('input:checked')).map(cb => cb.value);
        const selectedMateri = materiSelect.value; // (DIUBAH)
        
        const jenisUjian = jenisUjianSelect.value;
        const namaUjian = (jenisUjian === 'Bulanan' || namaUjianInput.value.trim() === '') 
            ? selectedMateri // Jika bulanan, Nama Ujian = Kode Materi
            : namaUjianInput.value;

        if (selectedSantri.length === 0 || !selectedMateri) {
            showMessage('Pilih minimal satu santri dan satu materi ujian.', 'error');
            return;
        }
        
        bukaUjianBtn.disabled = true;
        bukaUjianBtn.textContent = 'Memproses...';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ 
                    action: 'unlockExamsForSantri', 
                    santriUsernames: selectedSantri, 
                    subjectCodes: [selectedMateri], // (DIUBAH) Kirim sebagai array 1 item
                    jenisUjian: jenisUjian,
                    namaUjian: namaUjian
                }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if(result.status !== 'success') throw new Error(result.message);
            showMessage(result.message, 'success');
            renderUnlockedExamsList();
        } catch(error) {
            showMessage(`Gagal: ${error.message}`, 'error');
        } finally {
            bukaUjianBtn.disabled = false;
            bukaUjianBtn.textContent = 'Buka Ujian';
        }
    };

    // (Sisa fungsi ini, renderUnlockedExamsList dan tutupUjianBtn.onclick, tetap sama)
    tutupUjianBtn.onclick = async () => {
        const selectedExams = Array.from(document.querySelectorAll('.unlocked-exam-cb:checked')).map(cb => parseInt(cb.value));
        if (selectedExams.length === 0) {
            showMessage('Pilih minimal satu ujian yang ingin ditutup.', 'error');
            return;
        }
        tutupUjianBtn.disabled = true;
        tutupUjianBtn.textContent = 'Menutup...';
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'closeManualExams', rowsToDelete: selectedExams }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if(result.status !== 'success') throw new Error(result.message);
            showMessage(result.message, 'success');
            renderUnlockedExamsList();
        } catch(error) {
            showMessage(`Gagal: ${error.message}`, 'error');
        } finally {
            tutupUjianBtn.disabled = false;
            tutupUjianBtn.textContent = 'Tutup Ujian Terpilih';
        }
    };
    renderUnlockedExamsList();
}

    // GANTI SELURUH FUNGSI showLoggedInView ANDA DENGAN VERSI DI BAWAH INI

function showLoggedInView(userData) {
    ui.loginButton.classList.add('hidden');
    ui.attendanceNav.classList.remove('hidden');
    ui.sistemInformasiNav.classList.remove('hidden');
    ui.kalenderPendidikan.classList.remove('hidden');
    if (userData && userData.profileName) {
        ui.userProfileName.textContent = userData.profileName;
        ui.navProfilePic.src = userData.profilePicture || 'https://placehold.co/80x80/e9ecef/343a40?text=F';
        ui.navProfilePic.onerror = () => { ui.navProfilePic.src = 'https://placehold.co/80x80/e9ecef/343a40?text=E'; };
    } else {
        ui.userProfileName.textContent = `Hi, Pengguna`;
        ui.navProfilePic.src = 'https://placehold.co/80x80/e9ecef/343a40?text=F';
    }
    ui.userProfile.classList.remove('hidden');
    
    const session = getActiveSession();
    if (session && session.loggedIn) {
        const username = session.username;
        const jabatan = session.userData.jabatan || ''; 
		const adminPelanggaran = ['wawan', 'aria', 'admin'];
        const isPengasuh = (jabatan.toLowerCase().includes('pengasuh'));
        if (adminPelanggaran.includes(username) || isPengasuh) {
            fetchPelanggaranNotifications();
        }
		const allowedUsernames = ['wawan', 'mia', 'reza', 'yeni', 'admin'];
        const isSantri = (jabatan || '').trim().toLowerCase() === 'santri';
        const isKepalaOrWaka = jabatan === 'Kepala Rumah Anak Yatim' || jabatan === 'Kepala Rumah Tahfidz' || jabatan === 'Waka Kurikulum';
        const isMusyrif = jabatan === 'Musyrif' || ['wawan', 'admin'].includes(username);
		const isMusyrifah = jabatan === 'Musyrifah' || ['wawan', 'admin'].includes(username);
        const financeUsers = ['mia', 'wawan', 'aria', 'yeni', 'admin'];
        const karyawanUsers = ['wawan', 'admin', 'aria', 'yeni', 'mia', 'zhofri', 'erwan', 'mahadi', 'zaidun', 'yanti', 'ryza', 'reza', 'uswah', 'erma'];
		fetchAndStartTips(jabatan);
        const isBendahara = (jabatan.toLowerCase().trim() === 'bendahara');
        const isGuru = (jabatan || '').trim().toLowerCase() === 'guru' || appData.teachers.some(t => t.name === session.userData.profileName);
        const canAccessBankSoal = isGuru || userData.username === 'mia' || userData.username === 'wawan' || userData.username === 'admin';
        const isAdminUjian = ['wawan', 'mia', 'admin'].includes(username);
		const canSupervise = isGuru || ['wawan', 'mia', 'aria', 'zhofri', 'admin'].includes(username);
		
		const lihatNilaiNav = document.getElementById('lihatNilaiNav');
        if (lihatNilaiNav) {
            const isWaka = jabatan === 'Waka Kurikulum';
            const allowedUsernamesNilai = ['wawan', 'mia', 'aria', 'admin'];
            const canAccessNilai = isGuru || isWaka || allowedUsernamesNilai.includes(username);
            lihatNilaiNav.classList.toggle('hidden', !canAccessNilai);
        }
		
		if (isGuru) {
            fetchAndShowTeacherNotifications();
            fetchGradingNotifications(); 
        }

        document.getElementById('attendanceNav').classList.toggle('hidden', isSantri);
        document.getElementById('ujianOnlineNav').classList.toggle('hidden', !isSantri);
        const tabunganNav = document.getElementById('tabunganNav');
        if (tabunganNav) {
            const canSeeTabungan = allowedUsernames.includes(username) || jabatan === 'santri';
            tabunganNav.classList.toggle('hidden', !canSeeTabungan);
        }
		const kasirNav = document.getElementById('kasirNav');
        if (kasirNav) {
            const canSeeKasir = allowedUsernames.includes(username) || jabatan === 'santri' || ['wawan', 'admin'].includes(username) ;
            kasirNav.classList.toggle('hidden', !canSeeKasir);
        }
        
        const canAccessSlipGaji = karyawanUsers.includes(username) || isBendahara;
        const canAccessKeuangan = financeUsers.includes(username) || isBendahara;

        const showDropdown = isSantri || isKepalaOrWaka || isMusyrif || isMusyrifah || canAccessKeuangan || canAccessSlipGaji || isAdminUjian;
        document.getElementById('sistemInformasiDropdown').classList.toggle('hidden', !showDropdown);
        
        const halamanUjianAdminNav = document.getElementById('halamanUjianAdminNav');
        if(halamanUjianAdminNav) {
            halamanUjianAdminNav.classList.toggle('hidden', !isAdminUjian);
        }
		const pengawasUjianNav = document.getElementById('pengawasUjianNav');
		if (pengawasUjianNav) {
			pengawasUjianNav.classList.toggle('hidden', !canSupervise);
		}
        
        document.getElementById('krsNav').classList.toggle('hidden', !isSantri);
        document.getElementById('khsNav').classList.toggle('hidden', !isSantri);
        
        // --- (PERUBAHAN DI SINI) ---
        document.getElementById('hafalanNav').classList.toggle('hidden', !isSantri);
        // --- AKHIR PERUBAHAN ---

        document.getElementById('slipGajiNav').classList.toggle('hidden', !canAccessSlipGaji);
        document.getElementById('laporanKeuanganNav').classList.toggle('hidden', !canAccessKeuangan);
		
		if (canAccessKeuangan) {
            const tutupBukuContainer = document.getElementById('tutup-buku-gaji-container');
            if(tutupBukuContainer) tutupBukuContainer.classList.remove('hidden');
            populateMonthYearDropdowns(
                document.getElementById('tutupBukuBulan'), 
                document.getElementById('tutupBukuTahun')
            ); 
            populateMonthYearDropdowns(
                document.getElementById('totalGajiBulan'), 
                document.getElementById('totalGajiTahun')
            );
        }
		
        document.getElementById('laporanNav').classList.toggle('hidden', !isKepalaOrWaka);
        document.getElementById('musyrifNav').classList.toggle('hidden', !isMusyrif);
        document.getElementById('musyrifahNav').classList.toggle('hidden', !isMusyrifah);
        document.getElementById('halamanGuruNav').classList.toggle('hidden', !canAccessBankSoal);
        document.getElementById('inputSoalNav').classList.toggle('hidden', !isAdminUjian);
		
		const createFundraisingContainer = document.getElementById('create-fundraising-btn-container');
        if (createFundraisingContainer) {
            const canCreate = ['mia', 'wawan', 'admin'].includes(username);
            createFundraisingContainer.classList.toggle('hidden', !canCreate);
        }
		
        const tugasNav = document.getElementById('tugasNav');
        if (tugasNav) {
            const canAccessTugas = isSantri || isGuru || ['wawan', 'mia', 'aria', 'admin'].includes(username);
            tugasNav.classList.toggle('hidden', !canAccessTugas);

            if (isSantri) {
                fetchTugasNotifications();
            }
        }
    }
    
    if (window.location.hash === '#login') { window.location.hash = '#beranda'; }
}

    function showLoggedOutView() {
        ui.loginButton.classList.remove('hidden');
        ui.userProfile.classList.add('hidden');
        ui.attendanceNav.classList.add('hidden');
        ui.sistemInformasiNav.classList.add('hidden');
        ui.kalenderPendidikan.classList.add('hidden');
        document.getElementById('pengunjung-hari-ini')?.classList.add('hidden'); // Sembunyikan saat logout
		document.getElementById('musyrifNav').classList.add('hidden');
		document.getElementById('musyrifahNav').classList.add('hidden');
		document.getElementById('laporanNav').classList.add('hidden');
		document.getElementById('slipGajiNav').classList.add('hidden');
		document.getElementById('laporanKeuanganNav').classList.add('hidden');
		document.getElementById('sistemInformasiDropdown').classList.add('hidden');
		if (tipInterval) clearInterval(tipInterval);
    tipInterval = null;
    userTips = [];
    document.getElementById('tips-container').classList.add('hidden');
        localStorage.removeItem('userSession');
        sessionStorage.removeItem('userSession');
        const protectedHashes = ['#absensi', '#profile', '#sistem-informasi'];
        if (protectedHashes.includes(window.location.hash)) { window.location.hash = '#beranda'; }
    }
	
	
	
    function logUserVisit() {
        const session = getActiveSession();
        if (session && session.loggedIn) {
            const data = {
                action: 'logVisit',
                username: session.username,
				dateString: getClientDateString()
            };
            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(result => {
                if(result.status !== 'success') {
                    console.error("Gagal mencatat kunjungan:", result.message);
                }
            })
            .catch(error => console.error('Error saat mencatat kunjungan:', error));
        }
    }

    function fetchDailyVisitors() {
        const data = { action: 'getTodaysVisitors', dateString: getClientDateString() };
        const visitorSection = document.getElementById('pengunjung-hari-ini');
        const visitorContainer = document.getElementById('visitor-list-container');
        if (!visitorSection || !visitorContainer) return;

        fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify(data),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        })
        .then(res => res.json())
        .then(result => {
            // Selalu tampilkan section setelah fetch berhasil
            visitorSection.classList.remove('hidden'); 
            if (result.status === 'success' && result.visitors.length > 0) {
                let listHtml = '<ul id="visitor-list">';
                result.visitors.forEach(visitorName => {
                    listHtml += `<li>${visitorName}</li>`;
                });
                listHtml += '</ul>';
                visitorContainer.innerHTML = listHtml;
            } else {
                // Tampilkan pesan jika tidak ada pengunjung
                visitorContainer.innerHTML = '<p>Belum ada pengguna yang aktif hari ini.</p>';
            }
        })
        .catch(error => {
            console.error('Gagal mengambil data pengunjung:', error);
            // Tampilkan section dan pesan error jika fetch gagal
            visitorSection.classList.remove('hidden'); 
            visitorContainer.innerHTML = '<p>Gagal memuat data pengunjung.</p>';
        });
    }

// KOMENTAR: Fungsi baru untuk menangani tombol "Tampilkan" KRS/KHS
// === GANTI FUNGSI LAMA DENGAN FUNGSI BARU YANG LENGKAP INI ===
function setupSantriSelectorListeners() {
    const showReportBtn = document.getElementById('show-report-btn');
    if (!showReportBtn) return;

    // Tambahkan event listener ke tombol "Tampilkan"
    showReportBtn.addEventListener('click', async () => { // Jadikan fungsi ini async
		showLoading();
        const reportType = showReportBtn.dataset.reportType;
        const selectedMonth = document.getElementById('santri-month-selector').value;

        // Klik tab bulan yang sesuai secara programatik untuk memastikan data roster benar
        const tabToClick = document.getElementById(`tab-bulan${selectedMonth}`);
        if (tabToClick) {
            tabToClick.click();
        } else {
            showMessage('Bulan yang dipilih tidak valid.', 'error');
			hideLoading();
            return;
        }

        try {
            // Ambil nama santri dari elemen display di form pilihan
            const santriName = document.getElementById('santri-selector-name').textContent.replace(': ', '').trim();

            // Panggil fungsi baru untuk mendapatkan daftar santri dengan USERNAME ASLI
            const allSantriWithUsernames = await getSantriDataWithUsernames();
            
            // Cari data lengkap santri yang dipilih berdasarkan nama
            const santriDataForReport = allSantriWithUsernames.find(s => s.profileName === santriName);

            // Jika karena suatu alasan data santri tidak ditemukan, tampilkan error
            if (!santriDataForReport) {
                showMessage(`Data pengguna untuk santri "${santriName}" tidak ditemukan di sistem.`, 'error');
                return;
            }

            // Sekarang kita memiliki objek santriDataForReport yang berisi profileName dan username yang BENAR
            
            // Panggil fungsi yang sesuai dengan data santri yang telah ditemukan
            if (reportType === 'krs') {
                // Fungsi KRS tidak butuh username, tapi tidak masalah mengirim data lengkap
                handleKrsClick(null, santriDataForReport);
            } else {
                // Fungsi KHS akan menerima OBJEK dengan USERNAME YANG BENAR
                handleKhsClick(null, santriDataForReport);
            }

            // Sembunyikan kembali kontainer pilihan setelah selesai
            document.getElementById('santri-selection-container').classList.add('hidden');
        } catch (error) {
            // Tangani jika terjadi error saat mengambil data santri
            showMessage(`Terjadi kesalahan saat memproses data: ${error.message}`, 'error');
        } finally {
            // DITAMBAHKAN: Selalu sembunyikan loading di akhir, baik berhasil maupun gagal
            hideLoading();
        }
    });
}
// =================================================================


    // GANTI FUNGSI LAMA DENGAN VERSI BARU INI
function renderNewsCards() {
    const container = document.getElementById('news-container');
    if (!container) return;

    container.innerHTML = appData.news.map(item => {
        // Cek jika item adalah playlist YouTube
        if (item.type === 'youtube_playlist') {
    return `
        <div class="card">
            <div class="video-responsive">
                <div id="youtube-player"></div> 
            </div>
            
            <p id="youtube-title" class="text-sm text-center font-semibold mt-2 text-gray-700 p-2">Memuat judul...</p>
            
            <div class="card-content">
                <h3>${item.title}</h3>
                <p class="meta">${item.meta}</p>
                <p>${item.desc}</p>
            </div>
        </div>
    `;
} else {
            // Jika tidak (berita biasa), buat HTML untuk kartu berita seperti biasa
            return `
                <div class="card">
                    <img src="${item.img}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x200/cccccc/FFFFFF?text=Error';">
                    <div class="card-content">
                        <h3>${item.title}</h3>
                        <p class="meta">${item.meta}</p>
                        <p>${item.desc}</p>
                    </div>
                </div>
            `;
        }
    }).join('');
}
    function renderGalleryCards() { const container = document.getElementById('gallery-container'); if (container) container.innerHTML = appData.gallery.map(item => `<div class="card"><img src="${item.img}" alt="${item.title}" onerror="this.onerror=null;this.src='https://placehold.co/400x250/cccccc/FFFFFF?text=Error';"><div class="card-content"><h3>${item.title}</h3><p>${item.desc}</p></div></div>`).join(''); }
    function fetchMarqueeText() { const session = getActiveSession(); const isLoggedIn = !!(session && session.loggedIn); const data = { action: 'getMarqueeText', isLoggedIn: isLoggedIn }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.ok ? res.json() : Promise.reject(res)).then(result => { if (result.status === 'success' && result.text && result.text.trim() !== '') { const textContent = ` ${result.text} â€¢â€¢â€¢ `; ui.marqueeText.textContent = textContent.repeat(10); ui.marqueeContainer.classList.remove('hidden'); } else { ui.marqueeContainer.classList.add('hidden'); } }).catch(error => { console.error('Error fetching marquee text:', error); ui.marqueeContainer.classList.add('hidden'); }); }
    
    function renderDynamicCalendar(startYear, startMonth, numMonths) {
        if (!ui.dynamicCalendarGrid) return;
        ui.dynamicCalendarGrid.innerHTML = '';
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        let currentYear = startYear; let currentMonth = startMonth - 1;
        for (let i = 0; i < numMonths; i++) {
            const monthDate = new Date(currentYear, currentMonth, 1);
            const monthName = monthNames[monthDate.getMonth()];
            const year = monthDate.getFullYear();
            const firstDay = monthDate.getDay();
            const daysInMonth = new Date(year, monthDate.getMonth() + 1, 0).getDate();
            let monthHtml = `<div class="calendar-month"><h3 class="font-bold text-lg text-center mb-4 text-gray-700">${monthName} ${year}</h3><div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-500 font-semibold mb-2"><div class="holiday">Mgg</div><div>Sen</div><div>Sel</div><div>Rab</div><div>Kam</div><div>Jum</div><div>Sab</div></div><div class="grid grid-cols-7 gap-1 text-center text-sm">`;
            for (let j = 0; j < firstDay; j++) { monthHtml += `<div></div>`; }
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(monthDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let dayClasses = 'py-1 relative';
                if (new Date(dateStr).getDay() === 0) dayClasses += ' holiday';
                if (dateStr === todayStr) dayClasses += ' today';
                appData.calendarEvents.forEach(event => { const eventStartDate = new Date(event.date); const eventEndDate = new Date(eventStartDate); if (event.span) { eventEndDate.setDate(eventStartDate.getDate() + event.span - 1); } const currentDate = new Date(dateStr); if (currentDate >= eventStartDate && currentDate <= eventEndDate) { dayClasses += ` rounded-md ${event.color}`; } });
                monthHtml += `<div class="${dayClasses}" data-date="${dateStr}">${day}</div>`;
            }
            monthHtml += `</div><div class="mt-auto pt-3 border-t text-xs space-y-2">`;
            const monthEvents = appData.calendarEvents.filter(e => new Date(e.date).getMonth() === monthDate.getMonth() && new Date(e.date).getFullYear() === year);
            const uniqueEvents = [...new Map(monthEvents.map(item => [item.title, item])).values()];
            uniqueEvents.forEach(event => {
                const startDate = new Date(event.date); let legendText;
                if (event.span && event.span > 1) { const endDate = new Date(startDate); endDate.setDate(startDate.getDate() + event.span - 1); if(startDate.getMonth() !== endDate.getMonth()) { legendText = `${startDate.getDate()} ${monthNames[startDate.getMonth()]} - ${endDate.getDate()} ${monthNames[endDate.getMonth()]}: ${event.title}`; } else { legendText = `${startDate.getDate()}-${endDate.getDate()}: ${event.title}`; } } else { legendText = `${startDate.getDate()}: ${event.title}`; }
                if (event.color === 'holiday') { monthHtml += `<div class="flex items-center"><span class="holiday">${legendText}</span></div>`; } else if (event.color) { monthHtml += `<div class="flex items-center"><span class="w-3 h-3 rounded-sm mr-2 ${event.color}"></span><span>${legendText}</span></div>`; } else { monthHtml += `<div class="flex items-center"><span>${legendText}</span></div>`; }
            });
            monthHtml += `</div></div>`;
            ui.dynamicCalendarGrid.innerHTML += monthHtml;
            currentMonth++; if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        }
    }

    function setupSlideshow() {
        if (!ui.slideshowContainer) return;
        appData.heroImages.forEach((img, index) => {
            const slide = document.createElement('div');
            slide.className = 'slide';
            slide.style.backgroundImage = `url('${img}')`;
            if (index === 0) slide.classList.add('active');
            ui.slideshowContainer.appendChild(slide);
        });
        let currentSlide = 0;
        const slides = ui.slideshowContainer.querySelectorAll('.slide');
        setInterval(() => {
            slides[currentSlide].classList.remove('active');
            currentSlide = (currentSlide + 1) % slides.length;
            slides[currentSlide].classList.add('active');
        }, 5000);
    }
    
    function populateTeacherClasses(session, selectedDateStr, targetTeacherName = null) {
    const selectedDate = new Date(selectedDateStr + 'T00:00:00'); 
    const dayIndex = selectedDate.getDay();
    const daysInIndonesian = ["Minggu", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
    const currentDayName = daysInIndonesian[dayIndex];
    const classNameSelect = document.getElementById('className');
    
    classNameSelect.innerHTML = '<option value="">Memuat kelas...</option>';
    
    // --- PERUBAHAN DIMULAI DI SINI ---
    
    // 1. Panggil fungsi baru untuk mendapatkan bulan akademik saat ini
    const currentAcademicMonth = findAcademicMonthForDate(selectedDateStr);
    if (currentAcademicMonth === 0) {
         classNameSelect.innerHTML = '<option value="">Kalender akademik belum dimulai</option>';
         return;
    }

    const teacherName = targetTeacherName || (session && session.userData ? session.userData.profileName : null);
    
    if (teacherName && appData.schedules) {
        let taughtClasses = new Set();
        
        const schedulesToScan = Array.isArray(appData.schedules) 
            ? appData.schedules 
            : Object.values(appData.schedules).flat();

        schedulesToScan.forEach(scheduleItem => {
            // 2. Tambahkan kondisi filter untuk mencocokkan bulan akademik
            if (
                scheduleItem.teacher === teacherName && 
                scheduleItem.day === currentDayName &&
                String(scheduleItem.bulan) === String(currentAcademicMonth) //
            ) {
                taughtClasses.add(scheduleItem.subject);
            }
        });

        classNameSelect.innerHTML = '';
        if (taughtClasses.size > 0) {
            classNameSelect.innerHTML = '<option value="">Pilih Kelas...</option>';
            // Ditambahkan .sort() agar daftar kelas urut abjad dan rapi
            Array.from(taughtClasses).sort().forEach(subject => {
                const option = document.createElement('option');
                option.value = subject;
                option.textContent = subject;
                classNameSelect.appendChild(option);
            });
        } else {
            classNameSelect.innerHTML = '<option value="">Tidak ada jadwal mengajar pada tanggal ini</option>';
        }
    } else {
        classNameSelect.innerHTML = '<option value="">Silakan login terlebih dahulu</option>';
    }
}

    function populateSubstituteTeachers() {
    const selectElement = document.getElementById('substituteTeacherName');
    if (!selectElement) return;

    const session = getActiveSession();
    const currentTeacherName = (session && session.userData) ? session.userData.profileName : '';
    selectElement.innerHTML = '<option value="">Pilih Guru...</option>'; 

    try {
        // --- AWAL LOGIKA BARU ---
        
        // 1. Dapatkan data jadwal untuk bulan akademik saat ini
        // appState.activeMonthKey sudah diatur saat inisialisasi oleh setDefaultActiveTab()
        const activeSchedule = appState.processedSchedules[appState.activeMonthKey];

        if (!activeSchedule || activeSchedule.length === 0) {
            // Jika roster bulan ini kosong, lempar error agar ditangani fallback
            throw new Error("Jadwal roster untuk bulan ini tidak ditemukan.");
        }

        // 2. Ambil semua nama guru unik dari roster bulan ini
        const activeTeachers = activeSchedule
            .map(item => item.teacher) // Ambil semua nama guru
            .filter(Boolean); // Hapus entri yang kosong (misal: "Istirahat")
        
        const uniqueTeacherNames = [...new Set(activeTeachers)].sort(); // Ambil nama unik dan urutkan

        // 3. Isi dropdown dengan guru yang aktif di roster
        uniqueTeacherNames.forEach(teacherName => {
            // Jangan masukkan diri sendiri ke daftar yang bisa digantikan
            if (teacherName !== currentTeacherName) {
                const option = document.createElement('option');
                option.value = teacherName;
                option.textContent = teacherName;
                selectElement.appendChild(option);
            }
        });
        // --- AKHIR LOGIKA BARU ---

    } catch (error) {
        // Fallback: Jika terjadi error (misal roster gagal dimuat),
        // gunakan data statis 'appData.teachers' agar form tetap berfungsi.
        console.warn("Gagal memuat guru dari roster, menggunakan daftar statis:", error.message);
        
        appData.teachers.forEach(teacher => {
            if (teacher.name !== currentTeacherName) {
                const option = document.createElement('option');
                option.value = teacher.name;
                option.textContent = teacher.name;
                selectElement.appendChild(option);
            }
        });
    }
}
    
function handleLoginSubmit(event) {
    event.preventDefault();
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = "Memeriksa...";
    submitBtn.disabled = true;

    const data = {
        action: 'login',
        username: form.username.value,
        password: form.password.value
    };
	
	showLoading(); // 
	
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.ok ? res.json() : Promise.reject(res))
    .then(result => {
        if (result.status === "success" && result.userData) {
            showMessage("Login berhasil!", 'success');
            const sessionData = { loggedIn: true, username: result.userData.username, userData: result.userData };
            if (document.getElementById('remember').checked) {
                localStorage.setItem('userSession', JSON.stringify(sessionData));
            } else {
                sessionStorage.setItem('userSession', JSON.stringify(sessionData));
            }

            // LANGSUNG JALANKAN FUNGSI YANG DIPERLUKAN, BUKAN initializeApp()
            showLoggedInView(result.userData);
            logUserVisit();
            fetchDailyVisitors();
            fetchMarqueeText(); // Panggil juga ini agar teks berjalan update

        } else {
            showMessage(result.message || "Username atau password salah.", 'error');
        }
    })
    .catch(error => {
        console.error('Login Error:', error);
        showMessage(`Gagal terhubung.`, 'error');
    })
    .finally(() => {
        submitBtn.textContent = "Masuk";
        submitBtn.disabled = false;
		hideLoading(); 
    });
}
    function handleLogout() { document.getElementById('profileModal').style.display = 'none'; showLoggedOutView(); fetchMarqueeText(); showMessage("Anda telah berhasil logout.", "success"); }
    function openProfileModal() { const session = getActiveSession(); if (session && session.userData) { const ud = session.userData; document.getElementById('profileName').value = ud.profileName || ''; document.getElementById('profileDob').value = ud.dob || ''; document.getElementById('profileAddress').value = ud.address || ''; document.getElementById('profileJabatan').value = ud.jabatan || ''; document.getElementById('profileJabatan').readOnly = true; document.getElementById('profileUsername').value = ud.username || ''; const preview = document.getElementById('profilePicturePreview'); preview.src = ud.profilePicture || 'https://placehold.co/128x128/e9ecef/343a40?text=F'; preview.onerror = () => { preview.src = 'https://placehold.co/128x128/e9ecef/343a40?text=E'; }; document.getElementById('profileModal').style.display = 'block'; } else { showMessage('Data profil tidak ditemukan.', 'error'); } }
    async function handleProfileSubmit(event) { event.preventDefault(); const submitBtn = event.target.querySelector('button[type="submit"]'); const file = document.getElementById('profilePictureInput').files[0]; const sendProfileDataToSheet = (imageUrl) => { submitBtn.textContent = "Menyimpan..."; const session = getActiveSession(); const data = { action: 'updateProfile', username: session.username, profileName: profileName.value, dob: profileDob.value, address: profileAddress.value, jabatan: profileJabatan.value, profilePicture: imageUrl }; if (!imageUrl) { delete data.profilePicture; } fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if(result.status === 'success' && result.updatedData) { showMessage('Profil berhasil diperbarui!', 'success'); session.userData = result.updatedData; if (localStorage.getItem('userSession')) { localStorage.setItem('userSession', JSON.stringify(session)); } else { sessionStorage.setItem('userSession', JSON.stringify(session)); } showLoggedInView(result.updatedData); document.getElementById('profileModal').style.display = 'none'; } else { showMessage(result.message || 'Gagal update.', 'error'); } }).catch(error => { console.error('Profile Update Error:', error); showMessage('Koneksi error.', 'error'); }).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }; submitBtn.disabled = true; if (file) { if (typeof imageCompression !== 'function') { showMessage('Library kompresi error.', 'error'); submitBtn.disabled = false; return; } const options = { maxSizeMB: 0.29, maxWidthOrHeight: 1024, useWebWorker: true, onProgress: (p) => { submitBtn.textContent = `Mengompres... ${Math.round(p)}%`; }, }; try { const compressedFile = await imageCompression(file, options); submitBtn.textContent = "Mengunggah..."; const formData = new FormData(); formData.append('file', compressedFile, file.name); formData.append('upload_preset', CONFIG.CLOUDINARY_UPLOAD_PRESET); const cloudinaryResponse = await fetch(CONFIG.CLOUDINARY_URL, { method: 'POST', body: formData }); if (!cloudinaryResponse.ok) { throw new Error(`Upload error: ${cloudinaryResponse.status}`); } const cloudinaryData = await cloudinaryResponse.json(); if (cloudinaryData.secure_url) { sendProfileDataToSheet(cloudinaryData.secure_url); } else { throw new Error('URL Cloudinary tidak ditemukan.'); } } catch (error) { console.error('Image Upload Error:', error); showMessage(`Error unggah foto: ${error.message}`, 'error'); submitBtn.textContent = "Simpan"; submitBtn.disabled = false; } } else { sendProfileDataToSheet(null); } }
    function handleChangePasswordSubmit(event) { event.preventDefault(); const newPassword = document.getElementById('newPassword').value; if (newPassword.length < 6) { showMessage('Password minimal 6 karakter.', 'error'); return; } if (newPassword !== document.getElementById('confirmNewPassword').value) { showMessage('Konfirmasi password tidak cocok.', 'error'); return; } const session = getActiveSession(); if (!session || !session.loggedIn) { showMessage('Sesi tidak valid.', 'error'); return; } const data = { action: 'changePassword', username: session.username, currentPassword: document.getElementById('currentPassword').value, newPassword: newPassword }; const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Menyimpan..."; submitBtn.disabled = true; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { showMessage('Password berhasil diubah.', 'success'); document.getElementById('changePasswordModal').style.display = "none"; event.target.reset(); } else { showMessage(result.message || 'Gagal ubah password.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }
    function handleForgotVerifySubmit(event) { event.preventDefault(); const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Memeriksa..."; submitBtn.disabled = true; const data = { action: 'verifyUser', username: document.getElementById('forgotUsername').value, dob: document.getElementById('forgotDob').value }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { window.verifiedUsername = data.username; document.getElementById('forgotPasswordStep1').classList.add('hidden'); document.getElementById('forgotPasswordStep2').classList.remove('hidden'); } else { showMessage(result.message || 'Verifikasi gagal.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Verifikasi"; submitBtn.disabled = false; }); }
    function handleForgotResetSubmit(event) { event.preventDefault(); const newPassword = document.getElementById('forgotNewPassword').value; if (newPassword.length < 6) { showMessage('Password baru minimal 6 karakter.', 'error'); return; } if (newPassword !== document.getElementById('forgotConfirmPassword').value) { showMessage('Konfirmasi password tidak cocok.', 'error'); return; } const submitBtn = event.target.querySelector('button[type="submit"]'); submitBtn.textContent = "Menyimpan..."; submitBtn.disabled = true; const data = { action: 'resetPassword', username: window.verifiedUsername, newPassword: newPassword }; fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.json()).then(result => { if (result.status === "success") { showMessage('Password berhasil direset! Silakan login.', 'success'); document.getElementById('forgotPasswordModal').style.display = 'none'; event.target.reset(); document.getElementById('forgotPasswordStep2').classList.add('hidden'); document.getElementById('forgotPasswordStep1').classList.remove('hidden'); } else { showMessage(result.message || 'Gagal reset password.', 'error'); } }).catch(error => console.error('Error:', error)).finally(() => { submitBtn.textContent = "Simpan"; submitBtn.disabled = false; }); }
    function handleAttendanceSubmit(event, role) {
    event.preventDefault();
    const session = getActiveSession();
    if (!session || !session.loggedIn) {
        showMessage('Anda harus login.', 'error');
        window.location.hash = '#login';
        return;
    }
    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.textContent = "Mengirim...";
    submitBtn.disabled = true;
    let data;

    if (role === 'guru') {
        // --- DEKLARASI VARIABEL YANG HILANG (DITAMBAHKAN) ---
        const isSubstitute = form.querySelector('#isSubstituteTeacher').checked;
        const substituteFor = form.querySelector('#substituteTeacherName').value;
        const className = form.querySelector('#className').value;
        const remarksInput = form.querySelector('#remarksGuru');
        const lateMinutesInput = form.querySelector('#lateMinutesGuru');

        // --- VALIDASI REQUIRED FIELDS ---
        if (lateMinutesInput.value === '') {
            showMessage('Kolom "Menit Terlambat" harus diisi. Isi dengan angka 0 jika tidak terlambat.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Kirim Absensi Guru';
            return;
        }
        
        // Validasi tambahan untuk guru pengganti (DITAMBAHKAN)
        if (isSubstitute && (!substituteFor || !className)) {
            showMessage('Silakan pilih guru dan kelas yang Anda gantikan.', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = `Kirim Absensi Guru`;
            return;
        }

        // --- KUMPULKAN DATA ABSENSI SANTRI ---
        const studentAttendanceData = [];
// Dapatkan semua baris santri
const studentRows = document.querySelectorAll('.student-attendance-row');
for (const row of studentRows) {
    // Ambil nama santri dari atribut data-student-name
    const studentName = row.dataset.studentName;
    // Cari checkbox yang tercentang DALAM baris ini
    const checkedCheckbox = row.querySelector('.attendance-checkbox:checked');

    if (!checkedCheckbox) {
        showMessage(`Harap isi status kehadiran untuk santri: ${studentName}.`, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Kirim Absensi Guru';
        return; // Hentikan proses jika ada santri yang belum diabsen
    }

    studentAttendanceData.push({
        nama: studentName,
        status: checkedCheckbox.value
    });
}

        // --- SIAPKAN DATA LENGKAP UNTUK DIKIRIM ---
        let finalRemarks = remarksInput.value;
if (isSubstitute) {
    const substituteRemark = `[Menggantikan ${substituteFor}]`;
    finalRemarks = substituteRemark + (finalRemarks ? `\n${finalRemarks}` : '');
}
        
        data = { 
            action: 'submitAttendance', 
            role: 'guru', 
            teacherName: session.userData.profileName, 
            attendanceDate: form.querySelector('#attendanceDateGuru').value, 
            className: className, 
            lateMinutes: lateMinutesInput.value || '0', 
            remarks: finalRemarks, 
            substituteFor: isSubstitute ? substituteFor : '',
            studentAttendance: studentAttendanceData // Data absensi santri
        };

    } else if (role === 'staf') {
        data = { action: 'submitAttendance', role: 'staf', stafName: session.userData.profileName, attendanceDate: form.querySelector('#attendanceDateStaf').value, jabatan: form.querySelector('#jabatanStaf').value, lateMinutes: form.querySelector('#lateMinutesStaf').value || '0', remarks: form.querySelector('#remarksStaf').value };
    } else {
        data = { action: 'submitAttendance', role: 'rapat', name: session.userData.profileName, date: form.querySelector('#rapatDate').value, startTime: form.querySelector('#rapatStartTime').value, endTime: form.querySelector('#rapatEndTime').value, remarks: form.querySelector('#rapatRemarks').value };
    }
    
    fetch(CONFIG.SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), headers: { 'Content-Type': 'text/plain;charset=utf-8' } }).then(res => res.ok ? res.json() : Promise.reject(res)).then(result => {
		if (result.status === "success") {
            showMessage(result.message || 'Absensi berhasil direkam!', 'success');
            const session = getActiveSession();
            const currentName = session.userData.profileName;
            const currentJabatan = session.userData.jabatan;

            form.reset(); // Reset seluruh isian form
            
            // Mengatur ulang tampilan setelah reset
            setTodayDate();
            fetchAndRenderAttendanceHistory(currentName);
            document.getElementById('student-attendance-container').classList.add('hidden'); // Sembunyikan lagi daftar santri
            document.getElementById('substituteTeacherSection').classList.add('hidden'); // Sembunyikan bagian guru pengganti

            // Isi kembali field yang read-only
            if (role === 'guru') {
                form.querySelector('#teacherNameDisplay').value = currentName;
            } else if (role === 'staf') {
                form.querySelector('#stafNameDisplay').value = currentName;
                form.querySelector('#jabatanStaf').value = currentJabatan;
            } else if (role === 'rapat') {
                form.querySelector('#rapatNameDisplay').value = currentName;
            }
        } else if (result.status === "duplicate") {
            showMessage(result.message, 'error');
        } else {
            throw new Error(result.message);
        }
	}).catch(error => {
        console.error('Attendance Error:', error);
        showMessage('Gagal terhubung ke server.', 'error');
    }).finally(() => {
        submitBtn.textContent = `Kirim Absensi ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        submitBtn.disabled = false;
    });
}

// =======================================================
// === FUNGSI-FUNGSI BARU UNTUK FITUR SLIP GAJI ===
// =======================================================

// --- AWAL KODE PENGGANTI ---
function populateMonthYearDropdowns(monthSelect, yearSelect) {
    monthSelect.innerHTML = '';
    yearSelect.innerHTML = '';

    const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
    monthNames.forEach((month, index) => {
        const option = document.createElement('option');
        option.value = (index + 1).toString().padStart(2, '0');
        option.textContent = month;
        monthSelect.appendChild(option);
    });

    const currentYear = new Date().getFullYear();
    // Loop sekarang dimulai dari tahun 2026 hingga 2050
    for (let y = 2025; y <= 2050; y++) { 
        const option = document.createElement('option');
        option.value = y;
        option.textContent = y;
        yearSelect.appendChild(option);
    }

    // >Mengatur nilai default ke bulan dan tahun saat ini
    monthSelect.value = (new Date().getMonth() + 1).toString().padStart(2, '0');
    yearSelect.value = currentYear;
}
// --- AKHIR KODE PENGGANTI ---

function populateEmployeeDropdown() {
    const employeeSelect = document.getElementById('employeeSelect');
    employeeSelect.innerHTML = '<option value="">Memuat karyawan...</option>';
    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getEmployeeList' }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            employeeSelect.innerHTML = '<option value="">Pilih Karyawan...</option>';
            result.employees.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                employeeSelect.appendChild(option);
            });
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        employeeSelect.innerHTML = `<option value="">${error.message}</option>`;
    });
}

// GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU INI
function fetchAndRenderSlipGaji() {
    const slipContainer = document.getElementById('slipGajiContainer');
    const downloadContainer = document.getElementById('downloadSlipContainer');
    downloadContainer.classList.add('hidden'); 

    const session = getActiveSession();
    const userJabatan = (session && session.userData) ? session.userData.jabatan : '';
    
    // --- (PERUBAHAN DI SINI) ---
    // Menambahkan pengecekan 'isBendahara'
    const isBendahara = (userJabatan.toLowerCase().trim() === 'bendahara');
    const isAdminGaji = (session.username === 'aria' || session.username === 'wawan' || session.username === 'admin' || session.username === 'yeni' || isBendahara);
    // --- AKHIR PERUBAHAN ---

    // (DIPERBARUI) Menggunakan 'isAdminGaji'
    const targetProfileName = isAdminGaji ? document.getElementById('employeeSelect').value : session.userData.profileName;
    const selectedMonth = document.getElementById('monthSelectNew').value;
    const selectedYear = document.getElementById('yearSelect').value;
    const targetMonth = `${selectedYear}-${selectedMonth}`;

    if (isAdminGaji && !targetProfileName) {
        showMessage('Silakan pilih nama karyawan terlebih dahulu.', 'error');
        return;
    }

    slipContainer.innerHTML = '<p class="p-8 text-center text-gray-500">Mencari riwayat slip gaji...</p>';

    const data = {
        action: 'getSlipGaji',
        targetProfileName: targetProfileName,
        targetMonth: targetMonth,
        requesterUsername: session.username,
        requesterJabatan: userJabatan
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'error' || result.status === 'pending') {
            let colorClass = result.status === 'error' ? 'text-red-600 bg-red-50' : 'text-blue-600 bg-blue-50';
            slipContainer.innerHTML = `<p class="p-8 text-center ${colorClass} rounded-lg">${result.message}</p>`;
            return;
        }

        const s = result.slip;
        const formatRp = num => (num || 0).toLocaleString('id-ID');

        // (Sisa fungsi ini tetap sama persis seperti di file Anda)
        let pendapatanHTML = '';
        if (s.pendapatan.gajiPokokRinci && Object.keys(s.pendapatan.gajiPokokRinci).length > 0) {
        for (const jabatan in s.pendapatan.gajiPokokRinci) {
            pendapatanHTML += `<div class="flex justify-between"><span>Gaji Pokok (${jabatan})</span> <span>${formatRp(s.pendapatan.gajiPokokRinci[jabatan])}</span></div>`;
        }
    } else if (s.pendapatan.gajiPokok > 0) {
        pendapatanHTML += `<div class="flex justify-between"><span>Gaji Pokok</span> <span>${formatRp(s.pendapatan.gajiPokok)}</span></div>`;
    }
        if (s.pendapatan.honorMengajar > 0) pendapatanHTML += `<div class="flex justify-between"><span>Honor Mengajar</span> <span>${formatRp(s.pendapatan.honorMengajar)}</span></div>`;
        if (s.pendapatan.tunjanganMakan > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan Makan</span> <span>${formatRp(s.pendapatan.tunjanganMakan)}</span></div>`;
        if (s.pendapatan.tunjanganBPJS > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan BPJamsostek</span> <span>${formatRp(s.pendapatan.tunjanganBPJS)}</span></div>`;
        if (s.pendapatan.tunjanganFasilitas > 0) pendapatanHTML += `<div class="flex justify-between"><span>Tunjangan Fasilitas</span> <span>${formatRp(s.pendapatan.tunjanganFasilitas)}</span></div>`;
        if (s.pendapatan.lembur > 0) pendapatanHTML += `<div class="flex justify-between"><span>Lembur</span> <span>${formatRp(s.pendapatan.lembur)}</span></div>`;
        if (s.pendapatan.bonusLain > 0) pendapatanHTML += `<div class="flex justify-between"><span>Bonus Lain</span> <span>${formatRp(s.pendapatan.bonusLain)}</span></div>`;
        if (s.pendapatan.bonusRapat > 0) pendapatanHTML += `<div class="flex justify-between"><span>Bonus Rapat</span> <span>${formatRp(s.pendapatan.bonusRapat)}</span></div>`;
        const totalPendapatan = Object.values(s.pendapatan).reduce((a, b) => a + (typeof b === 'number' ? b : 0), 0);

        let potonganHTML = '';
        if (s.potongan.potonganMakan > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Makan</span> <span>${formatRp(s.potongan.potonganMakan)}</span></div>`;
        if (s.potongan.potonganBPJS > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan BPJamsostek</span> <span>${formatRp(s.potongan.potonganBPJS)}</span></div>`;
        if (s.potongan.potonganFasilitas > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Fasilitas</span> <span>${formatRp(s.potongan.potonganFasilitas)}</span></div>`;
        if (s.potongan.potonganAbsen > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Absen</span> <span>${formatRp(s.potongan.potonganAbsen)}</span></div>`;
        if (s.potongan.potonganTerlambat > 0) potonganHTML += `<div class="flex justify-between"><span>Potongan Terlambat</span> <span>${formatRp(s.potongan.potonganTerlambat)}</span></div>`;
        if (s.potongan.hutang > 0) potonganHTML += `<div class="flex justify-between"><span>Hutang</span> <span>${formatRp(s.potongan.hutang)}</span></div>`;
        if (s.potongan.denda > 0) potonganHTML += `<div class="flex justify-between"><span>Denda</span> <span>${formatRp(s.potongan.denda)}</span></div>`;
        const totalPotongan = Object.values(s.potongan).reduce((a, b) => a + b, 0);

        let kehadiranHTML = '';
    if (s.kehadiran.infoGuru) kehadiranHTML += `<li>Total Mengajar: ${s.kehadiran.infoGuru}</li>`;
    if (s.kehadiran.infoStaf) kehadiranHTML += `<li>Kehadiran Staf: ${s.kehadiran.infoStaf}</li>`;

    let catatanKeterlambatanHTML = '';
    if (s.kehadiran.totalSesiTerlambat > 0) {
        catatanKeterlambatanHTML = `
        <div class="text-xs text-gray-500 mt-6 border-t pt-2">
            <b>Catatan Potongan Keterlambatan:</b>
            <ul>
                <li>Anda terlambat di <b>${s.kehadiran.totalSesiTerlambat} sesi</b> mengajar dari total ${s.kehadiran.totalMengajar} sesi bulan ini.</li>
                <li>Total akumulasi keterlambatan Anda adalah <b>${s.kehadiran.totalMenitTerlambat} menit</b>.</li>
                <li>Aturan: Potongan Rp 8.000 untuk keterlambatan >= 10 menit, ditambah Rp 5.000 untuk setiap kelipatan 5 menit berikutnya per sesi.</li>
            </ul>
        </div>`;
    }

        const gajiBersih = totalPendapatan - totalPotongan;

        const slipHTML = `
            <div id="slipGajiContent" data-nama="${s.nama}" data-periode="${s.periode}">
                <div class="bg-white p-6 rounded-lg shadow-lg border">
                    <div class="text-center border-b pb-4 mb-4">
                        <h3 class="text-2xl font-bold">SLIP GAJI</h3>
                        <p class="text-gray-600">Periode: ${new Date(s.periode + '-02').toLocaleString('id-ID', {month:'long', year:'numeric'})}</p>
                    </div>
                    <div class="grid grid-cols-2 gap-4 text-sm mb-6">
                        <div><span class="font-semibold">Nama:</span> ${s.nama}</div>
                        <div><span class="font-semibold">Jabatan:</span> ${s.jabatan}</div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h4 class="font-bold text-lg text-green-600 border-b mb-2 pb-1">Pendapatan</h4>
                            <div class="space-y-2">${pendapatanHTML || '<div class="flex justify-between"><span>-</span> <span>0</span></div>'}</div>
                            <div class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total Pendapatan</span> <span>${formatRp(totalPendapatan)}</span></div>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-red-600 border-b mb-2 pb-1">Potongan</h4>
                            <div class="space-y-2">${potonganHTML || '<div class="flex justify-between"><span>-</span> <span>0</span></div>'}</div>
                            <div class="flex justify-between font-bold border-t pt-2 mt-2"><span>Total Potongan</span> <span>${formatRp(totalPotongan)}</span></div>
                        </div>
                    </div>
                    <div class="border-t mt-6 pt-4">
                       <div class="flex justify-between font-bold text-xl">
                            <span>GAJI BERSIH</span>
                            <span>Rp ${formatRp(gajiBersih)}</span>
                       </div>
                    </div>
                    
                    ${kehadiranHTML ? `<div class="text-xs text-gray-500 mt-6 border-t pt-2"><b>Rincian Kehadiran:</b><ul>${kehadiranHTML}</ul></div>` : ''}
                    ${catatanKeterlambatanHTML} 
                    ${s.piutang && s.piutang.persentase > 0 ? `
                    <div class="mt-6 pt-4 border-t-2 border-dashed border-red-300">
                        <h4 class="font-bold text-lg text-red-700 mb-2">Informasi Piutang Yayasan</h4>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span>Gaji Bersih (Utuh)</span> 
                                <span>${formatRp(gajiBersih)}</span>
                            </div>
                            <div class="flex justify-between text-red-600">
                                <span>Pinjaman ${s.piutang.persentase}% (Bulan ${s.piutang.jumlahBulan})</span> 
                                <span>- ${formatRp(s.piutang.jumlahBulanIni)}</span>
                            </div>
                            <div class="flex justify-between font-bold text-base border-t pt-2 mt-2">
                                <span>GAJI DITERIMA (TUNAI)</span> 
                                <span>${formatRp(gajiBersih - s.piutang.jumlahBulanIni)}</span>
                            </div>
                        </div>
                        <div class="mt-4 text-xs text-gray-500">
                            Total akumulasi piutang Anda (termasuk bulan ini) adalah <b>${formatRp(s.piutang.totalAkumulasi)}</b> selama <b>${s.piutang.jumlahBulan} bulan</b>.
                        </div>
                    </div>
                ` : ''}
                </div>
            </div>`;
        slipContainer.innerHTML = slipHTML;
        downloadContainer.classList.remove('hidden');
        document.getElementById('downloadSlipBtn').onclick = downloadSlipPDF;
        
    })
    .catch(error => {
        slipContainer.innerHTML = `<p class="p-8 text-center text-red-600 bg-red-50 rounded-lg">Gagal memuat slip gaji: ${error.message}</p>`;
    });
}

/**
 * FUNGSI BARU: Menghitung jumlah hari libur (selain Minggu) dalam bulan tertentu.
 * @param {number} year - Tahun yang akan diperiksa (misal: 2025).
 * @param {number} month - Bulan yang akan diperiksa (1 untuk Januari, 12 untuk Desember).
 * @returns {number} - Jumlah hari libur pada bulan tersebut.
 */
function getHolidaysInMonth(year, month) {
    let holidayCount = 0;
    const targetMonth = month - 1; // Bulan di JavaScript dimulai dari 0 (0=Jan, 11=Des)

    // Iterasi melalui semua event di kalender pendidikan
    appData.calendarEvents.forEach(event => {
        // Hanya proses event yang ditandai sebagai 'holiday'
        if (event.color === 'holiday') {
            const startDate = new Date(event.date + 'T00:00:00'); // Atur waktu ke awal hari untuk konsistensi
            const span = event.span || 1; // Jika ada properti span (libur beberapa hari)

            // Loop sebanyak durasi libur (span)
            for (let i = 0; i < span; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                // Cek apakah tanggal ini:
                // 1. Sesuai dengan tahun dan bulan yang ditargetkan.
                // 2. BUKAN hari Minggu (getDay() 0 adalah Minggu).
                if (
                    currentDate.getFullYear() === year &&
                    currentDate.getMonth() === targetMonth &&
                    currentDate.getDay() !== 0 
                ) {
                    holidayCount++;
                }
            }
        }
    });
    
    console.log(`Ditemukan ${holidayCount} hari libur di bulan ${month}/${year}`);
    return holidayCount;
}	
	// >FUNGSI BARU UNTUK MENGAMBIL DAN MENAMPILKAN RIWAYAT
function fetchAndRenderAttendanceHistory(profileName) {
    const historyContainer = document.getElementById('historyContainer');
    if (!historyContainer) return;

    historyContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Memuat riwayat absensi...</p>';

    const data = {
        action: 'getAttendanceHistory',
        profileName: profileName // PERBAIKAN: Pastikan kunci dan nilainya menggunakan profileName
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            if (result.history.length > 0) {
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Peran</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Informasi</th>' +
                                '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>' +
                                '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                result.history.forEach(item => {
				// // Buat objek Date, tambahkan 'T00:00:00' agar tidak salah zona waktu
    const dateObj = new Date(item.tanggal + 'T00:00:00');
    // Tentukan opsi format
    const options = { weekday: 'long', day: '2-digit', month: '2-digit' };
    // Buat string tanggal yang baru
    const formattedDate = dateObj.toLocaleDateString('id-ID', options);
                    tableHTML += `<tr>
                                    <td class="px-6 py-4 text-sm font-medium text-gray-900">${formattedDate}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.peran}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${item.informasi}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">${item.keterangan}</td>
                                  </tr>`;
                });

                tableHTML += '</tbody></table>';
                historyContainer.innerHTML = tableHTML;
            } else {
                historyContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Tidak ada riwayat absensi dalam 30 hari terakhir.</p>';
            }
        } else {
            throw new Error(result.message || 'Gagal mengambil data.');
        }
    })
    .catch(error => {
        console.error('Error fetching attendance history:', error);
        historyContainer.innerHTML = `<p class="p-6 text-center text-red-500">Terjadi kesalahan: ${error.message}</p>`;
    });
}

    function updateActiveLink() {
    // 1. Ambil hash dari URL, contoh: #roster-kbm?scroll=santri
    const fullHash = window.location.hash || '#beranda';

    // 2. Pisahkan nama halaman dari parameternya
    const [pageHash, params] = fullHash.split('?');
    
    // 3. Tampilkan halaman yang benar (misal: #roster-kbm)
    showPage(pageHash);

	 // 4. Jalankan aksi tambahan JIKA ada parameter (misal: scroll=santri)
    if (params && params.includes('scroll=santri')) {
        // Beri jeda sangat singkat agar halaman PASTI sudah tampil
        setTimeout(() => {
            const santriContainer = document.getElementById('santri-data-container');
            if (santriContainer) {
                // Gulir ke tabel data santri
                santriContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });

                // Buka accordion jika tertutup
                const dataContent = santriContainer.querySelector('.data-content');
                if (dataContent && dataContent.classList.contains('hidden')) {
                    santriContainer.querySelector('.data-header').click();
                }
            }
        }, 100); // 100ms sudah lebih dari cukup
    }
	
	if (params && params.includes('scroll=fundraising')) {
        setTimeout(() => {
            const fundraisingSection = document.getElementById('fundraising');
            if (fundraisingSection) {
                fundraisingSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }, 100); // Beri jeda agar halaman sempat tampil
    }
	
    // Reset semua link
    document.querySelectorAll('#mainNav a').forEach(a => a.classList.remove('active'));

    // BARIS BARU YANG SUDAH DIPERBAIKI
const subMenuHashes = ['#roster-kbm', '#krs', '#khs', '#santri', '#slip-gaji', '#laporan-keuangan', '#laporan', '#musyrif', '#musyrifah'];

    if (subMenuHashes.includes(pageHash) || pageHash === '#sistem-informasi') {
        const mainBtn = document.getElementById('sistemInformasiNav');
        if (mainBtn) mainBtn.classList.add('active');
    } else {
        // DAN PERBAIKAN DI SINI: Menggunakan `pageHash`, bukan `hash`
        const activeLink = document.querySelector(`#mainNav a[href="${pageHash}"]`);
        if (activeLink) activeLink.classList.add('active');
    }
}
    
    function updateDateTime() {
        const WAKTU_MAGHRIB = 18.5; // 18:30
        
        const tanggalMasehiAsli = new Date();
        const optionsMasehi = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', timeZone: 'Asia/Jakarta' };
        const dateStringMasehi = tanggalMasehiAsli.toLocaleDateString('id-ID', optionsMasehi);
        let dateForHijri = new Date();
        dateForHijri.setHours(dateForHijri.getHours() + ZONA_WAKTU_OFFSET_JAM);
        const jamLokal = tanggalMasehiAsli.getHours() + (tanggalMasehiAsli.getMinutes() / 60);
        if (jamLokal >= WAKTU_MAGHRIB) {
            dateForHijri.setDate(dateForHijri.getDate() + 1);
        }
        
        const optionsHijriNumeric = { calendar: 'islamic-umalqura', day: 'numeric', month: 'numeric', year: 'numeric', timeZone: 'UTC' };
        const formatter = new Intl.DateTimeFormat('id-ID-u-ca-islamic-umalqura-nu-latn', optionsHijriNumeric);
        const parts = formatter.formatToParts(dateForHijri);
        const day = parts.find(p => p.type === 'day').value;
        const monthIndex = parts.find(p => p.type === 'month').value - 1;
        const year = parts.find(p => p.type === 'year').value;
        const dateStringHijri = `${day} ${namaBulanHijriah[monthIndex]} ${year} H`;
        document.getElementById('date-display').innerHTML = `${dateStringMasehi}<br><span class="hijri-date">${dateStringHijri}</span>`;
    }

    function setTodayDate() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        const formattedToday = `${year}-${month}-${day}`;
        document.getElementById('attendanceDateGuru').value = formattedToday;
        document.getElementById('attendanceDateStaf').value = formattedToday;
        document.getElementById('rapatDate').value = formattedToday;
    }
    // =======================================================
// === FUNGSI-FUNGSI BARU UNTUK FITUR MUSYRIF/AH ===
// =======================================================

function populateSantriDropdowns(role) {
    const santriList = (role === 'musyrif') ? appData.santriMusyrif : appData.santriMusyrifah;
    const pageSelector = `#${role}`;
    const selects = document.querySelectorAll(`${pageSelector} select`);
    
    selects.forEach(select => {
        select.innerHTML = '<option value="">Pilih Nama Santri...</option>'; // Opsi default
        santriList.forEach(santriName => {
            const option = document.createElement('option');
            option.value = santriName;
            option.textContent = santriName;
            select.appendChild(option);
        });
    });
}

const daftarSurah = [
    "Al-Fatihah", "Al-Baqarah", "Ali 'Imran", "An-Nisa'", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus",
    "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra'", "Al-Kahf", "Maryam", "Taha",
    "Al-Anbiya'", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Asy-Syu'ara'", "An-Naml", "Al-Qasas", "Al-'Ankabut", "Ar-Rum",
    "Luqman", "As-Sajdah", "Al-Ahzab", "Saba'", "Fatir", "Yasin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir",
    "Fussilat", "Asy-Syura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jasiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf",
    "Az-Zariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadilah", "Al-Hasyr", "Al-Mumtahanah",
    "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij",
    "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddassir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba'", "An-Nazi'at", "'Abasa",
    "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Insyiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghasyiyah", "Al-Fajr", "Al-Balad",
    "Asy-Syams", "Al-Lail", "Ad-Duha", "Asy-Syarh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat",
    "Al-Qari'ah", "At-Takasur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraisy", "Al-Ma'un", "Al-Kausar", "Al-Kafirun", "An-Nasr",
    "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"
];

function buatDropdownSurah(elementId) {
    const select = document.getElementById(elementId);
    if (select) {
        select.innerHTML = '<option value="">Pilih Surah...</option>';
        daftarSurah.forEach((surah, index) => {
            select.innerHTML += `<option value="${surah}">${index + 1}. ${surah}</option>`;
        });
    }
}

// FUNGSI BARU UNTUK MEMBUAT CHECKBOX JUZ
function initializeJuzCheckboxes(role) {
    const container = document.getElementById(`juz-checkbox-container-${role}`);
    if (!container) return;
    container.innerHTML = ''; // Kosongkan dulu
    for (let i = 1; i <= 30; i++) {
        container.innerHTML += `
            <label class="flex items-center cursor-pointer text-sm">
                <input type="checkbox" value="${i}" class="mr-2 juz-checkbox-${role}"> Juz ${i}
            </label>
        `;
    }
    // Tambahkan event listener ke container setelah semua checkbox dibuat
    container.addEventListener('change', () => updateMurajaahFromJuz(role));
}

// FUNGSI BARU UNTUK MENGUPDATE INPUT SURAH DARI PILIHAN JUZ
function updateMurajaahFromJuz(role) {
    const checkedBoxes = document.querySelectorAll(`.juz-checkbox-${role}:checked`);
    const surahAwalSelect = document.getElementById(`murajaahSurahAwal${role.charAt(0).toUpperCase() + role.slice(1)}`);
    const ayatAwalInput = document.getElementById(`murajaahAyatAwal${role.charAt(0).toUpperCase() + role.slice(1)}`);
    const surahAkhirSelect = document.getElementById(`murajaahSurahAkhir${role.charAt(0).toUpperCase() + role.slice(1)}`);
    const ayatAkhirInput = document.getElementById(`murajaahAyatAkhir${role.charAt(0).toUpperCase() + role.slice(1)}`);

    if (checkedBoxes.length === 0) {
        // Jika tidak ada juz yang dipilih, kosongkan input
        surahAwalSelect.value = "";
        ayatAwalInput.value = "";
        surahAkhirSelect.value = "";
        ayatAkhirInput.value = "";
        return;
    }

    const selectedJuzNumbers = Array.from(checkedBoxes).map(cb => parseInt(cb.value));
    const minJuz = Math.min(...selectedJuzNumbers);
    const maxJuz = Math.max(...selectedJuzNumbers);

    const startData = JUZ_DATA.find(j => j.juz === minJuz);
    const endData = JUZ_DATA.find(j => j.juz === maxJuz);

    if (startData && endData) {
        surahAwalSelect.value = startData.start.surah;
        ayatAwalInput.value = startData.start.ayat;
        surahAkhirSelect.value = endData.end.surah;
        ayatAkhirInput.value = endData.end.ayat;
    }
}

// FUNGSI BARU UNTUK MENGATUR TOGGLE JUZ/SURAH
// FUNGSI UNTUK MENGATUR TOGGLE JUZ/SURAH (VERSI FINAL)
function setupMurajaahToggle(role) {
    const modeSelector = document.getElementById(`murajaah-mode-selector-${role}`);
    if (!modeSelector) return; // Pengaman jika elemen tidak ada
    
    // PERBAIKAN: Kita hanya perlu referensi ke kontainer Juz
    const juzInputsContainer = document.getElementById(`murajaah-juz-inputs-${role}`);

    modeSelector.addEventListener('change', (e) => {
        if (e.target.value === 'juz') {
            // Tampilkan pilihan Juz
            juzInputsContainer.classList.remove('hidden');
            // Panggil fungsi untuk mengisi nilai berdasarkan Juz yang mungkin sudah dipilih
            updateMurajaahFromJuz(role); 
        } else { // Mode 'surah'
            // Sembunyikan pilihan Juz
            juzInputsContainer.classList.add('hidden');
            // Hapus centang pada semua checkbox juz
            document.querySelectorAll(`.juz-checkbox-${role}:checked`).forEach(cb => cb.checked = false);
            // Panggil fungsi ini lagi untuk mengosongkan input surah/ayat
            updateMurajaahFromJuz(role); 
        }
    });
}

// FUNGSI UTAMA YANG TELAH DIPERBAIKI
function setupMusyrifEventListeners(role) {
    // 1. Panggil semua fungsi setup baru di awal
    initializeJuzCheckboxes(role);
    setupMurajaahToggle(role);

    // 2. Deklarasikan variabel yang dibutuhkan
    const pageSelector = `#${role}`;
    const roleCapitalized = role.charAt(0).toUpperCase() + role.slice(1);
    const formKegiatan = document.querySelector(`${pageSelector} #formKegiatan${roleCapitalized}`);
    const formTahfidz = document.querySelector(`${pageSelector} #formTahfidz${roleCapitalized}`);
    const formPelanggaran = document.querySelector(`${pageSelector} #formPelanggaran${roleCapitalized}`);
    
    // --- (BARU) DAFTAR SARAN ---
    const saranKegiatan = ['Tidak Piket', 'Tidak Solat/terlambat', 'tidak dzikir', 'susah bangun tidur', 'tidak mandi', 'tidak sikat gigi', 'melanggar adab'];
    const saranPelanggaran = ['Mendzolimi teman (bully)', 'Mengoshob/Mencuri', 'tidak menghormati Musyrif/ah', 'Berbohong', 'Melakukan perbuatan Bid\'ah', 'Berkata Buruk/Mengumpat', 'mengakses konten terlarang di laptop', 'keluar area tanpa izin pengasuh', 'Jajan berlebihan', 'merokok', 'membuka aurat saat diluar asrama', 'memutar musik', 'interaksi dengan lawan jenis (berzina)', 'melakukan maksiat lainnya'];
    const saranSolusi = ['Peringatan Lisan (menasehati 4 mata)', 'diberikan tugas tambahan', 'ganti rugi', 'penyitaan/pemusnahan barang', 'skorsing', 'hukuman fisik ringan'];

    // --- (BARU) PANGGIL FUNGSI PEMBUAT CHIP ---
    createSuggestionChips(`kegiatan${roleCapitalized}Suggestions`, saranKegiatan, `keteranganKegiatan${roleCapitalized}`);
    createSuggestionChips(`pelanggaran${roleCapitalized}Suggestions`, saranPelanggaran, `isiPelanggaran${roleCapitalized}`);
    createSuggestionChips(`solusi${roleCapitalized}Suggestions`, saranSolusi, `solusiPelanggaran${roleCapitalized}`);
    
    // 3. Pasang event listener untuk radio button kegiatan
    const statusRadios = document.querySelectorAll(`input[name="statusKegiatan${roleCapitalized}"]`);
    const keteranganContainer = document.getElementById(`keteranganKegiatan${roleCapitalized}Container`);
    statusRadios.forEach(radio => {
        radio.addEventListener('change', function() {
            keteranganContainer.classList.toggle('hidden', this.value !== 'Ada yang tidak dikerjakan');
        });
    });

    // 4. Pasang event listener untuk form submit
    if (formKegiatan) formKegiatan.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'KegiatanHarian'));
    if (formTahfidz) formTahfidz.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'NilaiTahfidz'));
    if (formPelanggaran) formPelanggaran.addEventListener('submit', (e) => handleMusyrifFormSubmit(e, role, 'Pelanggaran'));

    // 5. Inisialisasi tampilan awal
    updateMurajaahFromJuz(role);
}

// GANTI SELURUH ISI FUNGSI INI
function handleMusyrifFormSubmit(event, role, sheetName) {
    event.preventDefault();
    const session = getActiveSession();
    if (!session || !session.loggedIn) {
        showMessage('Sesi Anda telah berakhir, silakan login kembali.', 'error');
        return;
    }

    const form = event.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const santriSelect = form.querySelector('select');

    if (!santriSelect.value) {
        showMessage('Silakan pilih nama santri terlebih dahulu.', 'error');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Mengirim...';

    // --- (BARU) Pemetaan dari sheetName ke action backend ---
    // Ini memperbaiki bug di mana frontend mengirim 'submitNilaiTahfidz'
    // padahal backend mengharapkan 'submitTahfidz'.
    const actionMap = {
        'KegiatanHarian': 'submitKegiatan',
        'NilaiTahfidz': 'submitTahfidz',
        'Pelanggaran': 'submitPelanggaran'
    };
    // --- AKHIR BLOK BARU ---

    let data = {
        action: actionMap[sheetName], // (PERBAIKAN) Menggunakan action name yang benar
        musyrif: session.userData.profileName,
        tanggal: form.querySelector('input[type="date"]').value,
        namaSantri: santriSelect.value,
    };

    const roleCapitalized = role.charAt(0).toUpperCase() + role.slice(1);

    if (sheetName === 'KegiatanHarian') {
        data.status = form.querySelector(`input[name="statusKegiatan${roleCapitalized}"]:checked`).value;
        data.keterangan = form.querySelector(`#keteranganKegiatan${roleCapitalized}`).value || '-';
    } else if (sheetName === 'NilaiTahfidz') {
        const zPAwal = document.getElementById(`ziyadahPAyatAwal${roleCapitalized}`).value;
        const zPAkhir = document.getElementById(`ziyadahPAyatAkhir${roleCapitalized}`).value;
        const zSAwal = document.getElementById(`ziyadahSAyatAwal${roleCapitalized}`).value;
        const zSAkhir = document.getElementById(`ziyadahSAyatAkhir${roleCapitalized}`).value;
        const mSAwal = document.getElementById(`murajaahSurahAwal${roleCapitalized}`).value;
        const mAAwal = document.getElementById(`murajaahAyatAwal${roleCapitalized}`).value;
        const mSAkhir = document.getElementById(`murajaahSurahAkhir${roleCapitalized}`).value;
        const mAAkhir = document.getElementById(`murajaahAyatAkhir${roleCapitalized}`).value;
        data.ziyadahPoin = document.getElementById(`ziyadahPoin${roleCapitalized}`).value || '0';
        data.ziyadahPText = zPAwal ? `${document.getElementById(`ziyadahPSurah${roleCapitalized}`).value}: ${zPAwal}-${zPAkhir}` : '-';
        data.ziyadahSPoin = document.getElementById(`ziyadahSPoin${roleCapitalized}`).value || '0';
        data.ziyadahSText = zSAwal ? `${document.getElementById(`ziyadahSSurah${roleCapitalized}`).value}: ${zSAwal}-${zSAkhir}` : '-';
        data.murajaahPoin = document.getElementById(`murajaahPoin${roleCapitalized}`).value || '0';
        data.murajaahText = mSAwal ? `${mSAwal}: ${mAAwal} - ${mSAkhir}: ${mAAkhir}` : '-';
    } else if (sheetName === 'Pelanggaran') {
        data.pelanggaran = document.getElementById(`isiPelanggaran${roleCapitalized}`).value;
        data.solusi = document.getElementById(`solusiPelanggaran${roleCapitalized}`).value;
    }

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(`Laporan ${sheetName} berhasil disimpan!`, 'success');
            form.reset();
			form.querySelector('input[type="date"]').value = new Date().toISOString().slice(0, 10);
            if(sheetName === 'KegiatanHarian') {
                form.querySelector('input[value="Sudah dilaksanakan semua"]').checked = true;
                document.getElementById(`keteranganKegiatan${roleCapitalized}Container`).classList.add('hidden');
            }
            fetchAndRenderDailyReports(role);
        } else if (result.status === 'duplicate') {
             showMessage(result.message, 'error');
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        showMessage(`Gagal menyimpan: ${error.message}`, 'error');
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = `Simpan Laporan ${sheetName}`;
    });
}

function fetchAndRenderDailyReports(role) {
    const session = getActiveSession();
    if (!session || !session.loggedIn) return;

    const reportContainer = document.getElementById(`reportTable${role.charAt(0).toUpperCase() + role.slice(1)}`);
    reportContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Memuat laporan hari ini...</p>';

    const data = {
        action: 'getDailyReports',
        profileName: session.userData.profileName,
        dateString: getClientDateString()
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            if (result.reports.length > 0) {
                let tableHTML = '<table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nama Santri</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Jenis Laporan</th>' +
                                '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detail</th>' +
                                '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';
                
                result.reports.forEach(item => {
                    let detail = '';
                    if (item.type === 'Kegiatan') {
                        detail = `<b>Status:</b> ${item.status}. ${item.status === 'Ada yang tidak dikerjakan' ? `<b>Ket:</b> ${item.keterangan}` : ''}`;
                    } else if (item.type === 'Tahfidz') {
                        detail = `Ziyadah(P): <b>${item.ziyadahP}</b>, Ziyadah(S): <b>${item.ziyadahS}</b>, Muraja'ah: <b>${item.murajaah}</b>`;
                    } else if (item.type === 'Pelanggaran') {
                        detail = `<b>Pelanggaran:</b> ${item.pelanggaran}. <b>Solusi:</b> ${item.solusi}`;
                    }
                    
                    tableHTML += `<tr>
                                    <td class="px-4 py-4 font-medium text-gray-900">${item.namaSantri}</td>
                                    <td class="px-4 py-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${item.type === 'Pelanggaran' ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}">${item.type}</span></td>
                                    <td class="px-4 py-4 text-sm text-gray-600">${detail}</td>
                                  </tr>`;
                });

                tableHTML += '</tbody></table>';
                reportContainer.innerHTML = tableHTML;
            } else {
                reportContainer.innerHTML = '<p class="p-6 text-center text-gray-500">Belum ada laporan yang masuk hari ini.</p>';
            }
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        reportContainer.innerHTML = `<p class="p-6 text-center text-red-500">Gagal memuat laporan: ${error.message}</p>`;
    });
}

// --- (BARU) FUNGSI UNTUK MEMBUAT CHIP SARAN ---
function createSuggestionChips(containerId, suggestions, textareaId) {
    const container = document.getElementById(containerId);
    const textarea = document.getElementById(textareaId);
    if (!container || !textarea) return;

    container.innerHTML = ''; // Kosongkan
    suggestions.forEach(suggestion => {
        const chip = document.createElement('button');
        chip.type = 'button'; // Mencegah form submit
        chip.className = 'suggestion-chip px-3 py-1 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-gray-300';
        chip.textContent = suggestion;
        chip.onclick = () => {
            if (textarea.value.trim() === '') {
                textarea.value = suggestion;
            } else {
                // Cek agar tidak menambahkan koma jika sudah ada
                if (textarea.value.endsWith(',') || textarea.value.endsWith(', ')) {
                    textarea.value += ` ${suggestion}`;
                } else {
                    textarea.value += `, ${suggestion}`;
                }
            }
        };
        container.appendChild(chip);
    });
}

// --- (BARU) FUNGSI UNTUK MENGAMBIL NOTIFIKASI PELANGGARAN ---
async function fetchPelanggaranNotifications() {
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getUnresolvedPelanggaran' })
        });
        const result = await response.json();
        
        if (result.status === 'success' && result.count > 0) {
            // Tampilkan notifikasi pada menu "Sistem Informasi" dan "Laporan Harian"
            const wrappers = [
                document.querySelector('#sistemInformasiNav .nav-link-wrapper'),
                document.querySelector('#laporanNav .nav-link-wrapper') // Jika #laporanNav punya wrapper
            ];

            wrappers.forEach(wrapper => {
                if (wrapper) {
                    const oldDot = wrapper.querySelector('.notification-dot');
                    if (oldDot) oldDot.remove();
                    
                    const dot = document.createElement('span');
                    dot.className = 'notification-dot';
                    dot.textContent = result.count;
                    wrapper.appendChild(dot);
                }
            });
        }
    } catch (error) {
        console.error("Gagal mengambil notifikasi pelanggaran:", error);
    }
}

async function fetchAndStartTips(jabatan) {
  // Hentikan interval lama jika ada
  if (tipInterval) clearInterval(tipInterval);

  try {
    const response = await fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({ action: 'getTips', jabatan: jabatan }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    });
    const result = await response.json();

    if (result.status === 'success' && result.tips.length > 0) {
        userTips = result.tips; // Simpan tips
        currentTipIndex = 0; // Mulai dari awal

        // Tampilkan container animasi
        document.getElementById('tips-container').classList.remove('hidden');

        // Panggil rotasi pertama kali, lalu set interval
        rotateTips(); // Tampilkan tip pertama
        // Interval = 10 detik (tampil) + 4 detik (sembunyi) = 14 detik
        tipInterval = setInterval(rotateTips, 14000); 
    }
  } catch (error) {
    console.error("Gagal mengambil tips:", error);
  }
}

/**
 * FUNGSI BARU: Menampilkan satu tip dan menjadwalkan untuk sembunyi
 */
function rotateTips() {
    if (userTips.length === 0) return;

    const bubble = document.getElementById('tips-bubble');
    const content = document.getElementById('tips-content');
    if (!bubble || !content) return;

    // Ambil tip berikutnya
    const tipHtml = userTips[currentTipIndex];
    content.innerHTML = tipHtml;

    // Cek apakah tip ini mengandung link
    const containsLink = /<a|http/i.test(tipHtml);
    bubble.classList.toggle('has-link', containsLink);

    // Tampilkan bubble
    bubble.classList.add('visible');

    // Jadwalkan untuk sembunyi setelah 10 detik
    setTimeout(() => {
        bubble.classList.remove('visible');
    }, 10000); // Durasi tampil 10 detik

    // Pindah ke indeks tip berikutnya
    currentTipIndex = (currentTipIndex + 1) % userTips.length;
}


// FUNGSI BARU UNTUK HALAMAN LAPORAN TAHFIDZ
function renderReportTable(container, title, data, headers, allowedUsers = []) {
    const session = getActiveSession();
    const isAdmin = session && allowedUsers.includes(session.username);

    container.innerHTML = ''; // Kosongkan kontainer
    let tableHTML = `<h3 class="text-2xl font-semibold text-gray-700 mb-4">${title}</h3>`;
    
    if (!data || data.length === 0) {
        tableHTML += '<div class="overflow-x-auto bg-white rounded-lg shadow"><p class="p-6 text-center text-gray-500">Tidak ada data.</p></div>';
        container.innerHTML = tableHTML;
        return;
    }

    tableHTML += '<div class="overflow-x-auto bg-white rounded-lg shadow"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>';
    
    // Buat header tabel
    headers.forEach(header => {
        tableHTML += `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">${header.label}</th>`;
    });
    if (isAdmin) {
        tableHTML += `<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Aksi</th>`;
    }
    tableHTML += '</tr></thead><tbody class="bg-white divide-y divide-gray-200">';

    // Isi baris tabel
    data.forEach(item => {
        tableHTML += `<tr>`;
        headers.forEach(header => {
            tableHTML += `<td class="px-4 py-4 text-sm text-gray-600">${item[header.key] || '-'}</td>`;
        });
        
        // Tambahkan tombol "Selesai" jika admin dan statusnya "Baru"
        if (isAdmin) {
            const isBaru = (item.status === 'Baru' || item.status === '');
            tableHTML += `<td class="px-4 py-4 text-sm">`;
            if (isBaru) {
                tableHTML += `<button class="masalah-selesai-btn px-3 py-1 bg-blue-500 text-white rounded text-xs hover:bg-blue-600" data-timestamp="${item.timestampRaw}">Tandai Selesai</button>`;
            } else {
                tableHTML += `<span class="px-3 py-1 bg-gray-200 text-gray-600 rounded text-xs">Selesai</span>`;
            }
            tableHTML += `</td>`;
        }
        tableHTML += `</tr>`;
    });

    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
}

/**
 * FUNGSI DIPERBARUI: Mengambil dan merender SEMUA laporan harian.
 * (Sebelumnya: fetchAndRenderTahfidzReport)
 */
function fetchAndRenderAllDailyReports(dateString) {
    const tahfidzContainer = document.getElementById('tahfidzReportContainer');
    const kegiatanContainer = document.getElementById('kegiatanReportContainer');
    const pelanggaranContainer = document.getElementById('pelanggaranReportContainer');
    
    // Tampilkan pesan loading di semua kontainer
    const loadingHTML = '<p class="p-6 text-center text-gray-500">Memuat laporan...</p>';
    tahfidzContainer.innerHTML = loadingHTML;
    kegiatanContainer.innerHTML = loadingHTML;
    pelanggaranContainer.innerHTML = loadingHTML;

    // Ubah format YYYY-MM-DD dari date picker ke DD/MM/YYYY
    const parts = dateString.split('-');
    const formattedDateForScript = `${parts[2]}/${parts[1]}/${parts[0]}`;

    const data = {
        action: 'getAllDailyReportsByDate', // Memanggil fungsi backend yang baru
        dateString: formattedDateForScript
    };

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify(data),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            const reports = result.reports;
            
            // 1. Render Laporan Tahfidz
            renderReportTable(
                tahfidzContainer,
                'Laporan Nilai Tahfidz',
                reports.tahfidz,
                [
                    { label: 'Nama Santri', key: 'namaSantri' },
                    { label: 'Musyrif/ah', key: 'musyrif' },
                    { label: 'Ziyadah (P)', key: 'ziyadahPText' },
                    { label: 'Poin (P)', key: 'ziyadahP' },
                    { label: 'Ziyadah (S)', key: 'ziyadahSText' },
                    { label: 'Poin (S)', key: 'ziyadahS' },
                    { label: 'Muraja\'ah', key: 'murajaahText' },
                    { label: 'Poin (M)', key: 'murajaah' }
                ]
            );

            // 2. Render Laporan Kegiatan
            renderReportTable(
                kegiatanContainer,
                'Laporan Kegiatan Harian',
                reports.kegiatan,
                [
                    { label: 'Nama Santri', key: 'namaSantri' },
                    { label: 'Musyrif/ah', key: 'musyrif' },
                    { label: 'Status', key: 'status' },
                    { label: 'Keterangan', key: 'keterangan' }
                ]
            );

            // 3. Render Laporan Pelanggaran (dengan user admin)
            renderReportTable(
                pelanggaranContainer,
                'Laporan Pelanggaran',
                reports.pelanggaran,
                [
                    { label: 'Nama Santri', key: 'namaSantri' },
                    { label: 'Musyrif/ah', key: 'musyrif' },
                    { label: 'Pelanggaran', key: 'pelanggaran' },
                    { label: 'Solusi', key: 'solusi' },
                    { label: 'Status', key: 'status' }
                ],
                ['wawan', 'aria', 'admin'] // Daftar user yang bisa melihat tombol "Selesai"
            );
            
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => {
        const errorHTML = `<p class="p-6 text-center text-red-500">Gagal memuat laporan: ${error.message}</p>`;
        tahfidzContainer.innerHTML = errorHTML;
        kegiatanContainer.innerHTML = errorHTML;
        pelanggaranContainer.innerHTML = errorHTML;
    });
}


const handleKrsClick = async (event, userData = null) => {
        // Logika ini untuk klik dari tabel Data Santri di halaman Roster
        if (event) {
            const santriRow = event.target.closest('tr');
            // Ambil semua data santri dari baris yang di-klik
            const clickedSantriData = {
                profileName: santriRow.dataset.santriName,
                grup: santriRow.dataset.santriGroup,
                kelas: santriRow.dataset.santriKelas,
                jurusan: santriRow.dataset.santriJurusan
            };

            const session = getActiveSession();
            const isAdmin = session && ['wawan', 'mia', 'admin'].includes(session.username);

            // === LOGIKA BARU UNTUK ADMIN ===
            if (isAdmin) {
                // 1. Sembunyikan halaman roster dan tampilkan halaman santri
                document.getElementById('roster-kbm').classList.add('hidden');
                document.getElementById('santri').classList.remove('hidden');

                // 2. Tampilkan dan isi form pilihan bulan
                const selectionContainer = document.getElementById('santri-selection-container');
                selectionContainer.classList.remove('hidden');
                document.getElementById('santri-selector-name').textContent = `: ${clickedSantriData.profileName}`;
                document.getElementById('santri-selector-group').textContent = `: ${clickedSantriData.grup}`;

                // 3. Pastikan dropdown bulan sudah terisi
                const monthSelector = document.getElementById('santri-month-selector');
                if (monthSelector.options.length === 0) {
                    const months = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
                    months.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index + 1;
                        option.textContent = month;
                        monthSelector.appendChild(option);
                    });
                }

                // 4. Atur tombol "Tampilkan" untuk KRS
                const showReportBtn = document.getElementById('show-report-btn');
                showReportBtn.textContent = 'Tampilkan KRS';
                showReportBtn.dataset.reportType = 'krs';
                showReportBtn.classList.remove('khs-btn-color');
                showReportBtn.classList.add('krs-btn-color');

                // 5. Pastikan kontainer hasil (KRS/KHS) disembunyikan
                document.getElementById('krs-container').classList.add('hidden');
                document.getElementById('khs-container').classList.add('hidden');
                
                // 6. Hentikan eksekusi fungsi di sini untuk admin
                return;
            }
            // Jika bukan admin, teruskan userData untuk pemrosesan normal
            userData = clickedSantriData;
        }

        // === LOGIKA LAMA (Untuk santri yang melihat KRS-nya sendiri) ===
        if (!userData) {
            console.error("Tidak ada data pengguna untuk menampilkan KRS.");
            return;
        }

        const loggedInSantriName = userData.profileName;
        const santriData = appData.santri.find(s => s.nama === loggedInSantriName);
        if (!santriData) {
            alert(`Data untuk santri "${loggedInSantriName}" tidak ditemukan.`);
            return;
        }
        
        // ... (Sisa dari fungsi handleKrsClick yang sudah ada tetap sama) ...
        document.getElementById('nama-santri-krs').textContent = `: ${santriData.nama}`;
        document.getElementById('jurusan-krs').textContent = `: ${santriData.jurusan || santriData.jurusan}`;
        document.getElementById('kelas-krs').textContent = `: ${santriData.kelas || santriData.kelas}`;
        document.getElementById('kelompok-krs').textContent = `: ${santriData.grup || santriData.grup}`;
        const activeTab = document.querySelector('.tab-btn.active');
        const bulan = activeTab.textContent.replace('Bulan ', '');
        document.getElementById('materi-bulan-krs').textContent = `: ${bulan}`;

        krsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4">Memuat data KRS dari server...</td></tr>`;
        krsContainer.classList.remove('hidden');
        khsContainer.classList.add('hidden');
        if(!event) { // Hanya scroll jika bukan dari klik admin
            krsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'getKrsData', namaSantri: loggedInSantriName, bulan: bulan }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            const savedKrsData = result.data;
            krsTableBody.innerHTML = ''; 
            if (savedKrsData.length > 0) {
                savedKrsData
                    .sort((a, b) => { 
                        const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
                        return days.indexOf(a.Hari) - days.indexOf(b.Hari) || a.Waktu.localeCompare(b.Waktu);
                    })
                    .forEach((item, index) => {
                        const tr = document.createElement('tr');
                        tr.className = index % 2 === 0 ? 'bg-white border-b' : 'bg-gray-50 border-b';
                        tr.innerHTML = `
                            <td class="px-4 py-2">${item.Hari}</td>
                            <td class="px-4 py-2">${item.Waktu}</td>
                            <td class="px-4 py-2">${item.KodeMateri}</td>
                            <td class="px-4 py-2">${item.NamaMateri}</td>
                            <td class="px-4 py-2">${item.Ruang}</td>
                            <td class="px-4 py-2 text-center">${item.SKS}</td>
                            <td class="px-4 py-2">${item.Guru}</td>
                            <td class="px-4 py-2 text-center">
                                <button class="delete-krs-row text-red-500 hover:text-red-700">Hapus</button>
                            </td>`;
                        krsTableBody.appendChild(tr);
                    });
            } else {
                 krsTableBody.innerHTML = `<tr><td colspan="8" class="text-center px-4 py-3 text-gray-500">Belum ada materi yang diambil. Klik 'Tambah Materi' untuk memulai.</td></tr>`;
            }
            updateKrsTotalSks();
        } catch (error) {
            krsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
        }
    };
async function fetchTugasNotifications() {
    try {
        const session = getActiveSession();
        
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getTugasNotifications',
                username: session.username,
                namaSantri: session.userData.profileName
                // Parameter 'bulan' sudah dihapus
            })
        });
        const result = await response.json();
        if (result.status === 'success' && result.count > 0) {
            const wrapper = document.querySelector('#tugasNav .nav-link-wrapper');
            if (wrapper) {
                const oldDot = wrapper.querySelector('.notification-dot');
                if (oldDot) oldDot.remove();
                
                const dot = document.createElement('span');
                dot.className = 'notification-dot';
                dot.textContent = result.count;
                wrapper.appendChild(dot);
            }
        }
    } catch (error) {
        console.error("Gagal mengambil notifikasi tugas:", error);
    }
}

// --- TAMBAHKAN FUNGSI BARU INI UNTUK NOTIFIKASI GURU ---
async function fetchGradingNotifications() {
    try {
        const session = getActiveSession();
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ 
                action: 'getGradingNotifications',
                profileName: session.userData.profileName
            })
        });
        const result = await response.json();
        if (result.status === 'success' && result.count > 0) {
            const wrapper = document.querySelector('#tugasNav .nav-link-wrapper');
            if (wrapper) {
                const oldDot = wrapper.querySelector('.notification-dot');
                if (oldDot) oldDot.remove(); // Hapus dot lama jika ada

                const dot = document.createElement('span');
                dot.className = 'notification-dot';
                dot.textContent = result.count;
                wrapper.appendChild(dot);
            }
        }
    } catch (error) {
        console.error("Gagal mengambil notifikasi grading:", error);
    }
}

// GANTI SELURUH FUNGSI LAMA DENGAN VERSI BARU YANG LENGKAP INI
async function handleKhsClick(event, userData = null) {
        // Logika ini untuk klik dari tabel Data Santri di halaman Roster
        if (event) {
            const santriRow = event.target.closest('tr');
            const clickedSantriData = {
                profileName: santriRow.dataset.santriName,
                grup: santriRow.dataset.santriGroup,
                kelas: santriRow.dataset.santriKelas,
                jurusan: santriRow.dataset.santriJurusan,
                username: (santriRow.dataset.santriName || '').toLowerCase().replace(/\s/g, '')
            };

            const session = getActiveSession();
            const isAdmin = session && ['wawan', 'mia', 'admin'].includes(session.username);

            // === LOGIKA BARU UNTUK ADMIN ===
            if (isAdmin) {
                document.getElementById('roster-kbm').classList.add('hidden');
                document.getElementById('santri').classList.remove('hidden');

                const selectionContainer = document.getElementById('santri-selection-container');
                selectionContainer.classList.remove('hidden');
                document.getElementById('santri-selector-name').textContent = `: ${clickedSantriData.profileName}`;
                document.getElementById('santri-selector-group').textContent = `: ${clickedSantriData.grup}`;

                const monthSelector = document.getElementById('santri-month-selector');
                if (monthSelector.options.length === 0) {
                    const months = ["I", "II", "III", "IV", "V", "VI", "VII", "VIII"];
                    months.forEach((month, index) => {
                        const option = document.createElement('option');
                        option.value = index + 1;
                        option.textContent = month;
                        monthSelector.appendChild(option);
                    });
                }
                
                const showReportBtn = document.getElementById('show-report-btn');
                showReportBtn.textContent = 'Tampilkan KHS';
                showReportBtn.dataset.reportType = 'khs';
                showReportBtn.classList.remove('krs-btn-color');
                showReportBtn.classList.add('khs-btn-color');

                document.getElementById('krs-container').classList.add('hidden');
                document.getElementById('khs-container').classList.add('hidden');
                return;
            }
            userData = clickedSantriData;
        }

        // === LOGIKA LAMA (Untuk santri yang melihat KHS-nya sendiri) ===
        if (!userData || !userData.username) {
            console.error("Tidak ada data pengguna (terutama username) untuk menampilkan KHS.");
            return;
        }

        const loggedInSantriName = userData.profileName;
        const santriData = appData.santri.find(s => s.nama === loggedInSantriName);
        if (!santriData) {
            alert(`Data untuk santri "${loggedInSantriName}" tidak ditemukan.`);
            return;
        }
        
        const khsDisplay = document.getElementById('khs-display');
        khsDisplay.innerHTML = '<p class="p-8 text-center text-gray-500">Memuat data KHS dari KRS & Riwayat Nilai...</p>';
        khsContainer.classList.remove('hidden');
        krsContainer.classList.add('hidden');
        if(!event) { // Hanya scroll jika bukan dari klik admin
            khsContainer.scrollIntoView({ behavior: 'smooth' });
        }
        
        const activeTab = document.querySelector('.tab-btn.active');
        const bulan = activeTab.id.replace('tab-bulan', '');
        const bulanRomawi = activeTab.textContent.replace('Bulan ', '');
        
        try {
            const [krsResponse, nilaiResponse] = await Promise.all([
                fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getKrsData', namaSantri: loggedInSantriName, bulan: bulan }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                }),
                fetch(CONFIG.SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getKHSData', username: userData.username, bulan: bulan }),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' }
                })
            ]);

            const krsResult = await krsResponse.json();
            const nilaiResult = await nilaiResponse.json();

            if (krsResult.status !== 'success' || nilaiResult.status !== 'success') {
                throw new Error(krsResult.message || nilaiResult.message);
            }

            const krsForThisMonth = krsResult.data;
            const allGrades = nilaiResult.nilai;

            if (krsForThisMonth.length === 0) {
                khsDisplay.innerHTML = `<p class="p-8 text-center text-gray-500">Tidak ada materi KRS yang terdaftar untuk Bulan ${bulanRomawi}.</p>`;
                return;
            }
            
            // ... (Sisa dari fungsi handleKhsClick yang sudah ada tetap sama) ...
            const khsData = krsForThisMonth.map((item, index) => {
                const nilai = allGrades[item.KodeMateri] !== undefined ? allGrades[item.KodeMateri] : 0;
                let huruf = 'E', bobot = 0.00;
                if (nilai >= 98) { huruf = 'A+'; bobot = 4.00; }
                else if (nilai >= 94) { huruf = 'A'; bobot = 3.75; }
                else if (nilai >= 90) { huruf = 'A-'; bobot = 3.50; }
                else if (nilai >= 88) { huruf = 'B+'; bobot = 3.25; }
                else if (nilai >= 84) { huruf = 'B'; bobot = 3.00; }
                else if (nilai >= 80) { huruf = 'B-'; bobot = 2.75; }
                else if (nilai >= 76) { huruf = 'C+'; bobot = 2.50; }
                else if (nilai >= 72) { huruf = 'C'; bobot = 2.00; }
                else if (nilai >= 65) { huruf = 'D'; bobot = 1.00; }
                
                return {
                    no: index + 1,
                    kode: item.KodeMateri,
                    materi: item.NamaMateri,
                    sks: item.SKS,
                    huruf: huruf,
                    bobot: bobot,
                    nilai: parseFloat(nilai).toFixed(2)
                };
            });

            let tableRows = '', totalSks = 0, totalNilaiBobot = 0;
            khsData.forEach(item => {
                tableRows += `<tr><td class="border border-black text-center">${item.no}</td><td class="border border-black">${item.kode}</td><td class="border border-black">${item.materi}</td><td class="border border-black text-center">${item.sks}</td><td class="border border-black text-center">${item.huruf}</td><td class="border border-black text-center">${item.bobot.toFixed(2)}</td><td class="border border-black text-center">${item.nilai}</td></tr>`;
                totalSks += parseInt(item.sks) || 0;
                totalNilaiBobot += (parseInt(item.sks) || 0) * item.bobot;
            });
            const ip = totalSks > 0 ? (totalNilaiBobot / totalSks).toFixed(2) : "0.00";
            
            const finalHtml = `
                <header class="flex items-center justify-between border-b-2 border-black pb-2">
                    <div class="flex items-center">
                        <img src="Logo_yayasan.png" alt="Logo Institusi" class="h-16 w-16 mr-4" onerror="this.style.display='none';">
                        <div>
                            <h1 class="text-xl font-bold">MARKAZ QUR'AN AL-MAA'UN</h1>
                            <p class="text-xs">Lembaga Pendidikan Islam Terpadu</p>
                        </div>
                    </div>
                </header>
                <div class="text-center my-4">
                    <h3 class="text-xl font-bold underline">KARTU HASIL STUDI (KHS)</h3>
                </div>
                <section id="info-santri-khs" class="grid grid-cols-2 gap-x-8 text-sm mb-4">
                    <div>
                        <div class="flex"><span class="w-32">NAMA</span><span>: ${santriData.nama}</span></div>
                        <div class="flex"><span class="w-32">Kelas / Jurusan</span><span>: ${santriData.kelas} / ${santriData.jurusan}</span></div>
                    </div>
                    <div>
                        <div class="flex"><span class="w-28">Semester / Bulan</span><span>: Ganjil / ${bulanRomawi}</span></div>
                        <div class="flex"><span class="w-28">Klaster</span><span>: ${santriData.grup}</span></div>
                    </div>
                </section>
                <section>
                    <table id="tabel-nilai" class="w-full text-sm border-collapse border border-black">
                        <thead class="bg-gray-200">
                            <tr>
                                <th class="border border-black">NO</th>
                                <th class="border border-black">KODE</th>
                                <th class="border border-black text-left">MATERI</th>
                                <th class="border border-black">SKS</th>
                                <th class="border border-black">Huruf</th>
                                <th class="border border-black">Bobot</th>
                                <th class="border border-black">Nilai</th>
                            </tr>
                        </thead>
                        <tbody>${tableRows}</tbody>
                        <tfoot>
                            <tr class="font-bold bg-gray-100">
                                <td colspan="3" class="border border-black text-right pr-2">Jumlah SKS</td>
                                <td class="border border-black text-center">${totalSks}</td>
                                <td colspan="3" class="border border-black"></td>
                            </tr>
                            <tr class="font-bold bg-gray-100">
                                <td colspan="5" class="border border-black text-right pr-2">IP Bulanan</td>
                                <td class="border border-black text-center">${ip}</td>
                                <td class="border border-black"></td>
                            </tr>
                        </tfoot>
                    </table>
                </section>
                <footer class="flex justify-between items-start mt-6 text-xs" style="background-color: white; color: black;">
                    <div>
                        <p>1 lembar untuk Santri</p>
                        <p>1 lembar untuk bid. kurikulum</p>
                        <p>1 lembar untuk Arsip</p>
                    </div>
                    <div class="text-center">
                        <p>Sei Kamah II, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}</p>
                        <p>Mudir,</p>
                        <div style="height: 48px;"></div>
                        <p class="font-bold underline">Aria Atmaja</p>
                    </div>
                </footer>
            `;
            khsDisplay.innerHTML = finalHtml;
        } catch(error) {
            khsDisplay.innerHTML = `<p class="p-8 text-center text-red-500">Gagal memuat KHS: ${error.message}</p>`;
        }
    }
	
	const updateKrsTotalSks = () => {
        const totalSksElement = document.getElementById('total-sks-diambil');
        // DIUBAH: Variabel addMateriBtn sekarang dideklarasikan dengan benar di sini.
        const addMateriBtn = document.getElementById('add-krs-row');
        let totalSks = 0;
        const sksCells = krsTableBody.querySelectorAll('tr td:nth-child(6)');
        sksCells.forEach(cell => { totalSks += parseInt(cell.textContent, 10) || 0; });
        totalSksElement.textContent = totalSks;

        // Logika untuk menonaktifkan tombol jika SKS >= 34
        if (totalSks >= 34) {
            addMateriBtn.disabled = true;
            addMateriBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            addMateriBtn.disabled = false;
            addMateriBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    };

/**
 * Fungsi baru untuk mengambil data roster dari Google Sheet.
 * Mengembalikan data jika berhasil, atau null jika gagal.
 */
async function fetchRosterDataFromServer() {
    try {
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getRosterData' }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });
        const result = await response.json();
        
        // Cek jika status sukses DAN ada data yang dikembalikan
        if (result.status === 'success' && result.data && result.data.length > 0) {
            console.log("Berhasil mengambil data roster terbaru dari server.");
            return result.data; // Kembalikan data yang berhasil diunduh
        } else {
            // Jika fetch berhasil tapi tidak ada data, log pesan peringatan
            console.warn("Server tidak mengembalikan data roster. Akan menggunakan data dummy.");
            return null; // Kembalikan null karena tidak ada data
        }
    } catch (error) {
        console.error("KRITIS: Gagal mengambil data jadwal dari server!", error);
        return null; // Kembalikan null jika terjadi error koneksi
    }
}
	
    // --- (Fungsi-fungsi SI KBM di sini) ---
function initializeSistemInformasi() {
    console.log("Menginisialisasi Sistem Informasi KBM...");

    // =================================================================
    // *** PENYEDERHANAAN: 2. MENGELOLA STATE APLIKASI ***
    // =================================================================
    
    const session = getActiveSession();
    // PERUBAHAN: Membuat pengecekan jabatan 'Santri' tidak sensitif terhadap huruf besar/kecil dan spasi, sama seperti pada perbaikan menu sebelumnya.
    const isSantri = session && session.userData && (session.userData.jabatan || '').trim().toLowerCase() === 'santri';

    if (isSantri) {
        document.getElementById('teacher-data-container').classList.add('hidden');
        document.getElementById('module-data-container').classList.add('hidden');
        document.getElementById('santri-data-container').classList.add('hidden');
    }
	
    // --- DOM ELEMENTS ---
    const scheduleContainer = document.getElementById('schedule-container');
    const filterGroup = document.getElementById('filter-group');
    const filterCluster = document.getElementById('filter-cluster');
    const filterTeacher = document.getElementById('filter-teacher');
    const filterRoom = document.getElementById('filter-room');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const teacherTableBody = document.querySelector('#teacher-table tbody');
    const moduleTableBody = document.querySelector('#module-table tbody');
    const santriTableBody = document.getElementById('santri-table-body');
    const modal = document.getElementById('confirmation-modal');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalMessage = document.getElementById('modal-message');
    
// DITAMBAHKAN: Event listener untuk tombol refresh KRS
        document.getElementById('refresh-krs-btn')?.addEventListener('click', () => {
            const santriNameElement = document.getElementById('nama-santri-krs');
            // Cek apakah ada nama santri yang sedang ditampilkan
            if (santriNameElement && santriNameElement.textContent.length > 2) {
                const santriName = santriNameElement.textContent.replace(': ', '').trim();
                
                // Beri pesan loading kepada pengguna
                krsTableBody.innerHTML = `<tr><td colspan="8" class="text-center p-4 text-gray-500">Memuat ulang data KRS...</td></tr>`;
                
                // Panggil kembali fungsi utama untuk mengambil dan menampilkan data KRS terbaru
                handleKrsClick(null, { profileName: santriName });
                showMessage('Data KRS berhasil dimuat ulang.', 'success');
            } else {
                showMessage('Tidak dapat merefresh, data santri tidak ditemukan.', 'error');
            }
        });

    // --- UTILITY & HELPER FUNCTIONS ---
    const getGroupNameFromCode = (code) => {
        if (!code || !code.includes('-') || code.split('-')[1].length !== 3) {
            return "Modul Lain-lain";
        }
        const numStr = code.split('-')[1];
        const bagian = numStr.charAt(0);
        const sesi = numStr.charAt(2);
        const sesiMap = { '1': 'Sesi Pertama', '2': 'Sesi Kedua', '3': 'Sesi Ketiga', '4': 'Sesi Keempat', '5': 'Sesi Kelima', '6': 'Sesi Keenam' };
        const sesiText = sesiMap[sesi] || `Sesi ke-${sesi}`;
        return `Materi Bagian ${bagian} - ${sesiText}`;
    };

    const showConfirmation = (message) => {
        return new Promise((resolve) => {
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
            const confirmHandler = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(true);
            };
            const cancelHandler = () => {
                modal.classList.add('hidden');
                cleanup();
                resolve(false);
            };
            const cleanup = () => {
                modalConfirmBtn.removeEventListener('click', confirmHandler);
                modalCancelBtn.removeEventListener('click', cancelHandler);
            };
            modalConfirmBtn.addEventListener('click', confirmHandler);
            modalCancelBtn.addEventListener('click', cancelHandler);
        });
    };
    
    const processAndFillScheduleData = (originalData) => {
        let processedData = originalData.filter(item => item.time !== "11:30-12:15");
        processedData = JSON.parse(JSON.stringify(processedData)); 
        
        const timeSlots = ["08:00-09:30", "10:00-11:30", "13:00-14:30"];
        const days = ["Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];

        days.forEach(day => {
            rooms.forEach(room => {
                processedData.push({
                    day: day, time: "11:30-12:15", sks: 1, room: room, group: "Istirahat", cluster: "", 
                    subject: "Istirahat Qailullah", teacher: "", downloadLink: ""
                });
            });

            timeSlots.forEach(time => {
                if (day === "Jumat" && time === "13:00-14:30") return;

                const slotEntries = processedData.filter(item => item.day === day && item.time === time);
                const hasLKS = slotEntries.some(item => item.group === 'KG' && item.cluster === 'LKS');
                const hasSTT = slotEntries.some(item => item.group === 'KG' && item.cluster === 'STT');

                if (hasLKS && !hasSTT) {
                    processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KG", cluster: "STT", 
                        subject: "Tugas Mandiri KG (STT)", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                } else if (hasSTT && !hasLKS) {
                     processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KG", cluster: "LKS", 
                        subject: "Tugas Mandiri KG (LKS)", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                }

                const kfInMainRooms = slotEntries.some(item => item.group === 'KF' && (item.room === 'Kelas Mekah' || item.room === 'Kelas Madinah'));
                const rbmIsOccupied = slotEntries.some(item => item.room === 'RBM');

                if (!kfInMainRooms && !rbmIsOccupied) { 
                    processedData.push({
                        day: day, time: time, sks: 2, room: "RBM", group: "KF", cluster: "", 
                        subject: "Tugas Mandiri KF", teacher: "Sulistiawan, S.Kom", downloadLink: ""
                    });
                }
            });
        });
        return processedData;
    };

    // --- RENDER FUNCTIONS ---
    const renderSchedule = () => {
        scheduleContainer.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'schedule-grid';
        const days = ["", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
        const timeSlots = ["08:00-09:30", "10:00-11:30", "13:00-14:30"];
        const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];

        days.forEach(day => {
            const dayHeader = document.createElement('div');
            dayHeader.className = 'day-header text-slate-600 bg-slate-100';
            dayHeader.textContent = day;
            grid.appendChild(dayHeader);
        });

        timeSlots.forEach(time => {
            const timeHeader = document.createElement('div');
            timeHeader.className = 'time-slot text-teal-700 bg-slate-100 flex items-center justify-center';
            timeHeader.textContent = time;
            grid.appendChild(timeHeader);

            days.slice(1).forEach(day => {
                const cellContainer = document.createElement('div');
                cellContainer.className = 'p-1 bg-slate-100 rounded-lg space-y-1 flex flex-col justify-around';
                const dayTimeData = currentScheduleData.filter(item => item.day === day && item.time === time);

                rooms.forEach(room => {
                    const item = dayTimeData.find(d => d.room === room);
                    const cell = document.createElement('div');
                    cell.className = 'schedule-cell';

                    if (item) {
                        cell.dataset.group = item.group;
                        cell.dataset.teacher = item.teacher;
                        cell.dataset.room = item.room;
                        cell.dataset.cluster = item.cluster;

                        if (item.room === 'RBM') cell.classList.add('room-rbm');
                        if (item.room === 'Kelas Madinah') cell.classList.add('room-madinah');
                        if (item.room === 'Kelas Mekah') cell.classList.add('room-mekah');

                        let displayGroup = item.group;
                        if (item.group === 'KG' && item.cluster) {
                            displayGroup = `KG (${item.cluster})`;
                        }
                        
                        let subjectHtml = `<div class="font-bold text-sm text-teal-900">ðŸ“˜ ${item.subject || 'Kosong'}</div>`;
                        if (item.downloadLink && !isSantri) {
                            subjectHtml = `<a href="${item.downloadLink}" target="_blank" rel="noopener noreferrer" class="font-bold text-sm text-teal-900 hover:text-teal-600 hover:underline">ðŸ“˜ ${item.subject || 'Kosong'}</a>`;
                        }

                        cell.innerHTML = `
                            <div class="subject flex-grow">${subjectHtml}</div>
                            <div class="mt-2">
                                <div class="group-display font-semibold text-xs text-slate-600">
                                    <span>ðŸ§‘â€ðŸ¤â€ðŸ§‘ ${displayGroup}</span>
                                    <span class="room ml-2 ${item.room === 'RBM' ? 'text-orange-700' : 'text-sky-700'}">ðŸ“ ${item.room}</span>
                                </div>
                                <div class="teacher font-semibold text-xs text-teal-600 mt-1">ðŸ‘¤ ${item.teacher || ''}</div>
                            </div>`;
                    }
                    cellContainer.appendChild(cell);
                });
                grid.appendChild(cellContainer);
            });
        });
        scheduleContainer.appendChild(grid);
        applyFilters();
    };

    const renderModuleTable = () => {
        const allScheduleEntries = Object.values(appData.schedules).flat();
        const parentSubjectMap = { 'MAT': 'Matematika', 'IND': 'Bahasa Indonesia', 'THI': 'Thibbun Nabawi', 'ENG': 'Bahasa Inggris', 'KWU': 'Kewirausahaan', 'ARB': 'Bahasa Arab', 'KES': 'Kesehatan', 'KTR': 'Keterampilan', 'TAU': 'Tauhid', 'IPA': 'IPA Terpadu', 'ULH': 'Ulumul Hadits', 'TME': 'Teknik Mekanik Elektronik', 'IPS': 'IPS Terpadu', 'PANC': 'Pancasila', 'HAD': 'Hadits', 'TIK': 'Teknologi Informasi', 'ULQ': 'Ulumul Quran', 'FIQ': 'Fiqih', 'NAH': 'Nahwu', 'SIR': 'Sirah Nabawiyah', 'BAL': 'Balaghah', 'TAF': 'Tafsir', 'AKH': 'Akhlak' };
        const uniqueModules = {};

        allScheduleEntries.forEach(item => {
            if (item.subject && item.subject.includes(':') && !uniqueModules[item.subject]) {
                uniqueModules[item.subject] = { teacher: item.teacher || "N/A", link: item.downloadLink || "", sks: item.sks };
            }
        });

        const defaultModules = Object.keys(uniqueModules).map((subject, index) => {
            const itemData = uniqueModules[subject];
            const [code, ...nameParts] = subject.split(':');
            const moduleName = nameParts.join(':').trim();
            const prefix = code.trim().split('-')[0];
            return { no: index + 1, teacher: itemData.teacher, parent_subject: parentSubjectMap[prefix] || 'Lainnya', code: code.trim(), module: moduleName, sks: itemData.sks, downloadLink: itemData.link };
        });
        
        moduleTableBody.innerHTML = '';
        const modulesByTeacher = defaultModules.reduce((acc, module) => {
            const teacherName = module.teacher || "Tanpa Guru";
            if (!acc[teacherName]) { acc[teacherName] = []; }
            acc[teacherName].push(module);
            return acc;
        }, {});

        Object.keys(modulesByTeacher).sort().forEach(teacherName => {
            const modules = modulesByTeacher[teacherName];
            const teacherRow = document.createElement('tr');
            teacherRow.className = 'bg-slate-50 hover:bg-slate-100 cursor-pointer border-b border-slate-200';
            teacherRow.innerHTML = `<td class="px-6 py-4 font-bold text-teal-700" colspan="7"><div class="flex items-center justify-between"><div class="flex items-center gap-3"><svg class="w-5 h-5 transition-transform duration-300 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg><span>${teacherName}</span></div><span class="bg-teal-100 text-teal-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded-full">${modules.length} Modul</span></div></td>`;
            moduleTableBody.appendChild(teacherRow);

            const detailsRow = document.createElement('tr');
            detailsRow.className = 'hidden';
            const detailsCell = document.createElement('td');
            detailsCell.colSpan = 7;
            detailsCell.className = "p-0";
            const modulesContainer = document.createElement('div');
            modulesContainer.className = "bg-white";

            const groupsWithinTeacher = modules.sort((a, b) => a.code.localeCompare(b.code)).reduce((acc, mod) => {
                const groupName = getGroupNameFromCode(mod.code);
                if (!acc[groupName]) { acc[groupName] = []; }
                acc[groupName].push(mod);
                return acc;
            }, {});

            Object.keys(groupsWithinTeacher).sort((a, b) => parseInt(a.match(/\d+/)[0]) - parseInt(b.match(/\d+/)[0])).forEach(groupName => {
                const groupHeader = document.createElement('div');
                groupHeader.className = 'flex items-center justify-between px-4 py-3 text-base font-bold text-teal-800 bg-teal-50 border-t border-b border-teal-100 cursor-pointer hover:bg-teal-200 transition';
                groupHeader.innerHTML = `<span>${groupName}</span><svg class="w-5 h-5 transition-transform duration-300 arrow-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.21 14.77a.75.75 0 0 1 .02-1.06L11.168 10 7.23 6.29a.75.75 0 1 1 1.04-1.08l4.5 4.25a.75.75 0 0 1 0 1.08l-4.5 4.25a.75.75 0 0 1-1.06-.02Z" clip-rule="evenodd" /></svg>`;
                modulesContainer.appendChild(groupHeader);
                
                const singleGroupContainer = document.createElement('div');
                singleGroupContainer.className = 'divide-y divide-slate-100 hidden';
                
                groupsWithinTeacher[groupName].forEach(mod => {
                    const moduleItem = document.createElement('div');
                    moduleItem.className = 'grid grid-cols-7 gap-4 p-4 items-center text-sm hover:bg-slate-50 transition';
                    moduleItem.innerHTML = `<div class="px-2 text-slate-500 font-medium">${mod.no}</div><div class="col-span-1 px-2 text-slate-800 font-semibold">${mod.parent_subject}</div><div class="col-span-1 px-2 text-slate-600">${mod.code}</div><div class="col-span-2 px-2 text-slate-800">${mod.module}</div><div class="px-2 text-slate-600">${mod.sks ? mod.sks + ' SKS' : 'N/A'}</div><div class="px-2 text-right">${mod.downloadLink ? `<a href="${mod.downloadLink}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 bg-green-100 text-green-800 text-xs font-semibold px-2.5 py-1 rounded-full hover:bg-green-200 transition"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" /><path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" /></svg>Unduh</a>` : `<span class="inline-flex items-center gap-2 bg-slate-100 text-slate-500 text-xs font-semibold px-2.5 py-1 rounded-full cursor-not-allowed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4"><path fill-rule="evenodd" d="M10 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16ZM8.28 7.22a.75.75 0 0 0-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 1 0 1.06 1.06L10 11.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L11.06 10l1.72-1.72a.75.75 0 0 0-1.06-1.06L10 8.94 8.28 7.22Z" clip-rule="evenodd" /></svg>Kosong</span>`}</div>`;
                    singleGroupContainer.appendChild(moduleItem);
                });
                modulesContainer.appendChild(singleGroupContainer);
                groupHeader.addEventListener('click', () => {
                    singleGroupContainer.classList.toggle('hidden');
                    groupHeader.querySelector('.arrow-icon').classList.toggle('rotate-90');
                });
            });
            detailsCell.appendChild(modulesContainer);
            detailsRow.appendChild(detailsCell);
            moduleTableBody.appendChild(detailsRow);
            teacherRow.addEventListener('click', () => {
                detailsRow.classList.toggle('hidden');
                teacherRow.querySelector('.arrow-icon').classList.toggle('rotate-90');
            });
        });
    };

    const renderTeacherTable = () => {
        teacherTableBody.innerHTML = '';
        appData.teachers.forEach(teacher => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500">${teacher.no}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-900">${teacher.name}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.major}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.hari}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${teacher.schedule}</td>`;
            teacherTableBody.appendChild(row);
        });
    };

    const renderSantriTable = () => {
        santriTableBody.innerHTML = '';
        appData.santri.forEach(santri => {
            const row = document.createElement('tr');
            row.dataset.santriId = santri.id;
            row.dataset.santriName = santri.nama;
            row.dataset.santriGroup = santri.grup;
            row.dataset.santriKelas = santri.kelas;
            row.dataset.santriJurusan = santri.jurusan;
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.id}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${santri.nama}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.gender}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.grup}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.kelas}</td><td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${santri.jurusan}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2"><button class="krs-btn text-indigo-600 hover:text-indigo-900">Lihat KRS</button><button class="khs-btn text-green-600 hover:text-green-900">Lihat KHS</button></td>`;
            santriTableBody.appendChild(row);
        });
    };

    const applyFilters = () => {
        const { group, cluster, teacher, room } = appState.filters;

        filterCluster.disabled = (group !== 'KG');
        if (group !== 'KG' && appState.filters.cluster !== 'all') {
            appState.filters.cluster = 'all';
            filterCluster.value = 'all';
        }

        document.querySelectorAll('.schedule-cell').forEach(cell => {
            const cellData = cell.dataset;
            if (!cellData.group) {
                cell.classList.remove('highlight', 'dimmed');
                return;
            }
            let isMatch = true;
            if (group !== 'all' && cellData.group !== group) isMatch = false;
            if (cluster !== 'all' && cellData.cluster !== cluster && !(cellData.cluster === 'Wajib' && group === 'KG')) isMatch = false;
            if (teacher !== 'all' && cellData.teacher !== teacher) isMatch = false;
            if (room !== 'all' && cellData.room !== room) isMatch = false;

            if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
                cell.classList.remove('highlight', 'dimmed');
            } else if (isMatch) {
                cell.classList.add('highlight');
                cell.classList.remove('dimmed');
            } else {
                cell.classList.remove('highlight');
                cell.classList.add('dimmed');
            }
        });
    };
    
    const getFilteredScheduleData = () => {
        const { group, cluster, teacher, room } = appState.filters;
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];

        if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
            return currentScheduleData.filter(item => item.group && item.group !== 'Istirahat' && item.subject && item.subject.trim() !== '');
        }

        return currentScheduleData.filter(item => {
            if (!item.group || item.group === 'Istirahat' || !item.subject || item.subject.trim() === '') return false;
            const groupMatch = (group === 'all') || (item.group === group);
            const clusterMatch = (cluster === 'all') || (item.cluster === cluster) || (item.group === 'KG' && item.cluster === 'Wajib');
            const teacherMatch = (teacher === 'all') || (item.teacher === teacher);
            const roomMatch = (room === 'all') || (item.room === room);
            return (group === 'KG') ? (groupMatch && clusterMatch && teacherMatch && roomMatch) : (groupMatch && teacherMatch && roomMatch);
        });
    };

    const populateTeacherFilter = () => {
        const currentScheduleData = appState.processedSchedules[appState.activeMonthKey];
        const teachers = [...new Set(currentScheduleData.map(item => item.teacher).filter(Boolean))].sort();
        filterTeacher.innerHTML = '<option value="all">Semua Guru</option>';
        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher;
            option.textContent = teacher;
            filterTeacher.appendChild(option);
        });
    };

    // --- KRS & KHS LOGIC ---
    

    // --- EVENT LISTENERS & HANDLERS ---
    function setupEventListeners() {
        // Filter listeners
        filterGroup.addEventListener('change', (e) => { appState.filters.group = e.target.value; applyFilters(); });
        filterCluster.addEventListener('change', (e) => { appState.filters.cluster = e.target.value; applyFilters(); });
        filterTeacher.addEventListener('change', (e) => { appState.filters.teacher = e.target.value; applyFilters(); });
        filterRoom.addEventListener('change', (e) => { appState.filters.room = e.target.value; applyFilters(); });
        
        resetFiltersBtn.addEventListener('click', () => {
            appState.filters = { group: 'all', cluster: 'all', teacher: 'all', room: 'all' };
            filterGroup.value = 'all';
            filterCluster.value = 'all';
            filterTeacher.value = 'all';
            filterRoom.value = 'all';
            applyFilters();
        });

        // Tab listeners
        document.querySelectorAll('.tab-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const monthKey = `bulan${e.target.id.replace('tab-bulan', '')}`;
                appState.activeMonthKey = monthKey;
                
                document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');

                renderSchedule();
                populateTeacherFilter();
                krsContainer.classList.add('hidden');
                khsContainer.classList.add('hidden');
            });
        });

        document.querySelectorAll('.semester-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                document.querySelectorAll('.semester-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                if (e.target.id === 'semester-ganjil-btn') {
                    document.getElementById('ganjil-tabs').classList.remove('hidden');
                    document.getElementById('genap-tabs').classList.add('hidden');
                    document.getElementById('tab-bulan1').click();
                } else {
                    document.getElementById('ganjil-tabs').classList.add('hidden');
                    document.getElementById('genap-tabs').classList.remove('hidden');
                    document.getElementById('tab-bulan5').click();
                }
            });
        });
        
        // Accordion listeners
        document.querySelectorAll('.data-header').forEach(header => {
            header.addEventListener('click', () => {
                header.nextElementSibling.classList.toggle('hidden');
                header.querySelector('.arrow-icon').classList.toggle('rotate-180');
            });
        });

        // Event Delegation for dynamic buttons
        santriTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('krs-btn')) handleKrsClick(event);
            if (event.target.classList.contains('khs-btn')) handleKhsClick(event);
        });
        krsTableBody.addEventListener('click', (event) => {
            if (event.target.classList.contains('delete-krs-row')) {
                event.target.closest('tr').remove();
                updateKrsTotalSks();
            }
        });
        krsTableBody.addEventListener('input', (event) => {
            if (event.target.tagName === 'TD') updateKrsTotalSks();
        });

        // Other action buttons
        document.getElementById('reset-schedule').addEventListener('click', async () => {
            if (await showConfirmation('Yakin ingin reset jadwal?')) {
                document.getElementById('tab-bulan1').click();
            }
        });
        document.getElementById('print-schedule').addEventListener('click', () => {
            const style = document.createElement('style');
            style.innerHTML = `@media print { .schedule-cell.dimmed { visibility: hidden !important; } }`;
            document.head.appendChild(style);
            window.print();
            setTimeout(() => { document.head.removeChild(style); }, 500);
        });
        document.getElementById('download-schedule-pdf').addEventListener('click', function() {
            // Ambil library jsPDF dan autoTable dari window
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'landscape', // Gunakan orientasi landscape agar tabel lebih lebar
                unit: 'mm',
                format: [210, 330]
            });

            // Ambil data jadwal yang sudah difilter oleh pengguna
            const filteredData = getFilteredScheduleData();

            // Ubah format data agar sesuai dengan format yang dibutuhkan oleh autoTable
            const tableBody = filteredData.map(item => [
                item.day,
                item.time,
                item.subject,
                item.group + (item.cluster ? ` (${item.cluster})` : ''),
                item.room,
                item.teacher
            ]);

            // Ambil judul dari tab bulan yang sedang aktif
            // 1. Ambil nomor bulan yang aktif dari variabel state aplikasi (lebih andal)
            const activeMonthNumber = appState.activeMonthKey.replace('bulan', '');
            // 2. Cari elemen tombol tab berdasarkan ID-nya
            const activeTab = document.getElementById(`tab-bulan${activeMonthNumber}`);
            
            // 3. Tambahkan pengecekan untuk keamanan, jika tab tidak ditemukan
            if (!activeTab) {
                alert("Error: Tidak dapat menemukan tab bulan yang aktif. Silakan muat ulang halaman.");
                return; // Hentikan fungsi jika terjadi error
            }
			const semesterName = activeMonthNumber <= 4 ? 'Semester Ganjil' : 'Semester Genap';
            
            const title = `Jadwal KBM - ${activeTab.textContent.trim()} (${semesterName})`;
            const fileName = `Jadwal_KBM_${activeTab.textContent.trim().replace(' ', '_')}_(${semesterName.replace(' ', '_')}).pdf`;

            // Tambahkan judul ke PDF
            doc.setFontSize(16);
            doc.text(title, 14, 15);

            // Buat tabel di dalam PDF
            doc.autoTable({
                head: [['Hari', 'Waktu', 'Mata Pelajaran / Modul', 'Kelompok', 'Ruang', 'Guru']],
                body: tableBody,
                startY: 20, // Posisi awal tabel di bawah judul
                theme: 'grid',
                headStyles: {
                    fillColor: [44, 94, 46] // Warna hijau tua (sesuai tema)
                },
                styles: {
                    fontSize: 8,
                    cellPadding: 2,
                }
            });

            // Simpan file PDF
            doc.save(fileName);
        });
		
		// FUNGSI BARU: Untuk menangani klik tombol "Input" dari dalam modal

        closeKrsBtnBottom.addEventListener('click', () => krsContainer.classList.add('hidden'));
        closeKhsBtnBottom.addEventListener('click', () => khsContainer.classList.add('hidden'));
        downloadKrsBtn.addEventListener('click', () => {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [210, 330]
            });
            const margin = 15;
            let y = 10;

            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(12);
            pdf.text('KARTU RENCANA STUDI (KRS)', 105, y, { align: 'center' });
            y += 6;
            pdf.setFontSize(10);
            pdf.text("Markaz Qur'an Al-Maa'un", 105, y, { align: 'center' });
            y += 4;
            pdf.setFont('helvetica', 'normal');
            pdf.setFontSize(9);
            pdf.text('Semester Ganjil', 105, y, { align: 'center' });
            y += 8;

            pdf.setFontSize(8);
            const info = {
                left: [
                    { label: 'Nama Santri', value: document.getElementById('nama-santri-krs').textContent.substring(1).trim() },
                    { label: 'Jurusan', value: document.getElementById('jurusan-krs').textContent.substring(1).trim() },
                    { label: 'Kelompok', value: document.getElementById('kelompok-krs').textContent.substring(1).trim() }
                ],
                right: [
                    { label: 'Total SKS yang bisa diambil', value: document.getElementById('total-sks-ambil-krs').textContent.substring(1).trim() },
                    { label: 'Kelas', value: document.getElementById('kelas-krs').textContent.substring(1).trim() },
                    { label: 'Materi untuk Bulan ke', value: document.getElementById('materi-bulan-krs').textContent.substring(1).trim() }
                ]
            };
            
            const leftLabelX = margin;
            const leftColonX = leftLabelX + 45;
            const leftValueX = leftColonX + 2;
            const rightLabelX = 110;
            const rightColonX = rightLabelX + 45;
            const rightValueX = rightColonX + 2;
            const lineHeight = 5;

            const maxRows = Math.max(info.left.length, info.right.length);

            for (let i = 0; i < maxRows; i++) {
                if (info.left[i]) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(info.left[i].label, leftLabelX, y);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(':', leftColonX, y);
                    pdf.text(info.left[i].value, leftValueX, y, { maxWidth: rightLabelX - leftValueX - 5 });
                }
                if (info.right[i]) {
                    pdf.setFont('helvetica', 'bold');
                    pdf.text(info.right[i].label, rightLabelX, y);
                    pdf.setFont('helvetica', 'normal');
                    pdf.text(':', rightColonX, y);
                    pdf.text(info.right[i].value, rightValueX, y);
                }
                y += lineHeight;
            }
            
            pdf.autoTable({
                html: '#tabel-krs',
                startY: y,
                theme: 'grid',
                styles: {
                    font: 'helvetica',
                    fontSize: 8,
                    cellPadding: 1,
                    valign: 'middle'
                },
                headStyles: {
                    fillColor: [243, 244, 246],
                    textColor: [31, 41, 55],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                },
                footStyles: {
                    fillColor: [243, 244, 246],
                    textColor: [31, 41, 55],
                    fontStyle: 'bold',
                    fontSize: 8.5,
                    halign: 'right'
                },
                columnStyles: {
                    5: { halign: 'center' } 
                },
                didParseCell: function (data) {
                    if (data.row.section === 'foot') {
                        data.cell.styles.halign = 'right';
                        if(data.column.index === 0) {
                            data.cell.text = data.cell.text[0].replace(/:/g, '');
                        }
                    }
                },
                columns: [
                    { header: 'Hari', dataKey: 0 },
                    { header: 'Waktu', dataKey: 1 },
                    { header: 'Kode', dataKey: 2 },
                    { header: 'Mata Pelajaran / Modul', dataKey: 3 },
                    { header: 'Ruang', dataKey: 4 },
                    { header: 'SKS', dataKey: 5 },
                    { header: 'Guru', dataKey: 6 },
                ]
            });

            pdf.save(`KRS_${document.getElementById('nama-santri-krs').textContent.substring(1).trim()}.pdf`);
        });
        // PERUBAHAN: Mengganti metode unduh KHS dari .html() menjadi .autoTable()
        // GANTI SELURUH BLOK KODE LAMA DENGAN VERSI FINAL INI
        downloadKhsBtn.addEventListener('click', () => {
            const khsContainerNode = document.getElementById('khs-container');
            const infoSantriNode = khsContainerNode.querySelector('#info-santri-khs');
            const tableNode = khsContainerNode.querySelector('#tabel-nilai');

            // 1. Pengecekan Awal: Pastikan semua elemen yang dibutuhkan sudah ada
            if (!infoSantriNode || !tableNode || infoSantriNode.innerHTML.trim() === '') {
                showMessage('Tampilkan KHS terlebih dahulu sebelum mengunduh.', 'error');
                return;
            }

            // 2. Mengumpulkan semua data dinamis dari halaman
            const santriInfo = {
                nama: infoSantriNode.querySelector('div:nth-child(1) .flex:nth-child(1) span:last-child').textContent.trim(),
                kelasJurusan: infoSantriNode.querySelector('div:nth-child(1) .flex:nth-child(2) span:last-child').textContent.trim(),
                semesterBulan: infoSantriNode.querySelector('div:nth-child(2) .flex:nth-child(1) span:last-child').textContent.trim(),
                klaster: infoSantriNode.querySelector('div:nth-child(2) .flex:nth-child(2) span:last-child').textContent.trim()
            };

            const tableRows = tableNode.querySelectorAll('tbody tr');
            const tableBodyData = [];
            let totalSks = 0;
            let totalNilaiBobot = 0;

            tableRows.forEach(tr => {
                const cells = tr.querySelectorAll('td');
                // Adaptasi: Membaca dari sel berdasarkan urutan, bukan data-label
                const rowData = [
                    cells[0].textContent, // NO
                    cells[1].textContent, // KODE
                    cells[2].textContent, // MATERI
                    cells[3].textContent, // SKS
                    cells[4].textContent, // Huruf
                    cells[5].textContent, // Bobot
                    cells[6].textContent  // Nilai
                ];
                tableBodyData.push(rowData);

                const sks = parseFloat(rowData[3]);
                const bobot = parseFloat(rowData[5]);
                if (!isNaN(sks) && !isNaN(bobot)) {
                    totalSks += sks;
                    totalNilaiBobot += sks * bobot;
                }
            });

            const ip = totalSks > 0 ? (totalNilaiBobot / totalSks).toFixed(2) : "0.00";
            const fileName = `KHS - ${santriInfo.nama}.pdf`;
            
            // 3. Menyiapkan PDF dengan pustaka jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: [210, 330] // Ukuran kertas F4
            });

            // 4. Inti Logika dari Kode Anda (dijadikan fungsi untuk bisa dipanggil 2x)
            const drawKHS = (yOffset) => {
                // Menggambar Header
                doc.setFont('Times', 'bold');
                doc.setFontSize(11);
                doc.text("MARKAZ QUR'AN AL-MAA'UN", 105, yOffset + 9, { align: 'center' });
                doc.setFont('Times', 'normal');
                doc.setFontSize(7);
                doc.text("Lembaga Pendidikan Islam Terpadu", 105, yOffset + 12.5, { align: 'center' });
                doc.setLineWidth(0.5);
                doc.line(20, yOffset + 15, 190, yOffset + 15);

                doc.setFont('Times', 'bold');
                doc.setFontSize(10);
                doc.text("KARTU HASIL STUDI (KHS)", 105, yOffset + 20, { align: 'center' });
                doc.setLineWidth(0.2);
                doc.line(84, yOffset + 21, 126, yOffset + 21);

                // Menggambar Info Santri (menggunakan data dinamis yang sudah dikumpulkan)
                doc.setFont('Times', 'normal');
                doc.setFontSize(8.5);
                doc.text("NAMA", 20, yOffset + 26);
                doc.text(`: ${santriInfo.nama}`, 50, yOffset + 26);
                doc.text("Kelas / Jurusan", 20, yOffset + 30);
                doc.text(`: ${santriInfo.kelasJurusan}`, 50, yOffset + 30);
                doc.text("Semester / Bulan", 115, yOffset + 26);
                doc.text(`: ${santriInfo.semesterBulan}`, 140, yOffset + 26);
                doc.text("Klaster", 115, yOffset + 30);
                doc.text(`: ${santriInfo.klaster}`, 140, yOffset + 30);

                // Menyiapkan Body Tabel (termasuk baris kalkulasi)
                const finalTableBody = [...tableBodyData]; // Salin data asli
                finalTableBody.push([{ content: 'Jumlah SKS', colSpan: 3, styles: { fontStyle: 'bold', halign: 'right' } }, { content: totalSks, styles: { halign: 'center', fontStyle: 'bold' } }, { content: '', colSpan: 3 }]);
                finalTableBody.push([{ content: 'IP Bulanan', colSpan: 5, styles: { fontStyle: 'bold', halign: 'right' } }, { content: ip, styles: { halign: 'center', fontStyle: 'bold' } }, { content: '' }]);

                // Menggambar Tabel Nilai
                doc.autoTable({
                    startY: yOffset + 34,
                    head: [['NO', 'KODE', 'MATERI', 'SKS', 'Huruf', 'Bobot', 'Nilai']],
                    body: finalTableBody,
                    theme: 'grid',
                    styles: { 
                        fontSize: 7, 
                        cellPadding: 1.0,
                        lineColor: [44, 62, 80],
                        lineWidth: 0.1,
                    },
                    headStyles: { fillColor: [220, 220, 220], textColor: 0, fontStyle: 'bold', halign: 'center' },
                    columnStyles: {
                        0: { halign: 'center', cellWidth: 8 },
                        1: { halign: 'left', cellWidth: 19 },
                        2: { cellWidth: 83 },
                        3: { halign: 'center', cellWidth: 10 },
                        4: { halign: 'center', cellWidth: 12 },
                        5: { halign: 'center', cellWidth: 15 },
                        6: { halign: 'center', cellWidth: 15 },
                    },
                    margin: { left: 20, right: 20 }
                });

                // Menggambar Footer
                let finalY = doc.autoTable.previous.finalY;
                doc.setFontSize(7.5);
                doc.text(`SKS Maksimal yang bisa diambil Bulan depan: 34`, 20, finalY + 4);
                doc.text("1 lembar untuk Santri", 20, finalY + 7);
                doc.text("1 lembar untuk bid. kurikulum", 20, finalY + 10);
                doc.text("1 lembar untuk Arsip", 20, finalY + 13);
                doc.setFontSize(8.5);
                doc.text(`Sei Kamah II, ${new Date().toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`, 190, finalY + 7, { align: 'right' });
                doc.text("Mudir,", 190, finalY + 11, { align: 'right' });
                doc.setFont('Times', 'bold');
                doc.text("Aria Atmaja", 190, finalY + 22, { align: 'right' });
            };

            // 5. Eksekusi Fungsi Penggambaran dan Simpan PDF
            const pageHeight = doc.internal.pageSize.getHeight();
            drawKHS(4); // Gambar KHS pertama di bagian atas halaman
            drawKHS(pageHeight / 2); // Gambar KHS kedua di bagian tengah halaman

            doc.save(fileName);
        });
    }

	const setDefaultActiveTab = () => {
    // Helper untuk mendapatkan tanggal hari ini dalam format YYYY-MM-DD
    const getTodayString = () => new Date().toISOString().slice(0, 10);

    // Menggunakan fungsi yang sudah ada untuk mencari bulan akademik saat ini
    const currentMonthNumber = findAcademicMonthForDate(getTodayString());

    // Jika bulan aktif tidak ditemukan (misal, di luar tahun ajaran), default ke bulan 1
    const targetMonth = currentMonthNumber > 0 ? currentMonthNumber : 1;

    // Nonaktifkan semua tab terlebih dahulu untuk membersihkan
    document.querySelectorAll('.tab-btn').forEach(tab => tab.classList.remove('active'));

    // Cari tombol tab yang sesuai dengan bulan saat ini
    const targetTab = document.getElementById(`tab-bulan${targetMonth}`);

    if (targetTab) {
        // Aktifkan tab yang benar
        targetTab.classList.add('active');
        // PENTING: Perbarui juga state aplikasi agar data yang ditampilkan sesuai
        appState.activeMonthKey = `bulan${targetMonth}`;
    }
};

    // --- INITIALIZATION ---
    function initializeApp() {
        // Proses semua data jadwal sekali saat aplikasi dimuat
        

        // Render semua bagian aplikasi
        renderSantriTable();
        renderTeacherTable();
        renderModuleTable();
		setDefaultActiveTab(); // Menentukan tab aktif berdasarkan tanggal hari ini
        renderSchedule(); // Render jadwal awal (Bulan 1)
        populateTeacherFilter();
        
        // Pasang semua event listener
        setupEventListeners();
    }

    initializeApp();
   
    // Tandai bahwa inisialisasi sudah selesai
    isSistemInformasiInitialized = true;
}

// DITAMBAHKAN: Fungsi baru untuk menangani penyimpanan data KRS
function handleSaveKrs() {
    const saveBtn = document.getElementById('save-krs-btn');
    const tableRows = document.querySelectorAll('#krs-table-body tr');
    
    // Validasi jika tidak ada materi yang diambil
    if (tableRows.length === 0 || !tableRows[0].querySelector('td')) {
        showMessage('Tidak ada data KRS untuk disimpan.', 'error');
        return;
    }

    const krsData = [];
    tableRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        // Pastikan baris memiliki sel yang cukup sebelum diproses
        if (cells.length >= 7) {
            krsData.push({
                hari: cells[0].textContent,
                waktu: cells[1].textContent,
                kodeMateri: cells[2].textContent,
                namaMateri: cells[3].textContent,
                ruang: cells[4].textContent,
                sks: parseInt(cells[5].textContent, 10),
                guru: cells[6].textContent
            });
        }
    });

    const namaSantri = document.getElementById('nama-santri-krs').textContent.replace(': ', '');
    const bulan = document.getElementById('materi-bulan-krs').textContent.replace(': ', '');

    saveBtn.disabled = true;
    saveBtn.textContent = 'Menyimpan...';

    fetch(CONFIG.SCRIPT_URL, {
        method: 'POST',
        body: JSON.stringify({
            action: 'saveOrUpdateKrs', // Menggunakan action baru
            namaSantri: namaSantri,
            bulan: bulan,
            krsData: krsData 
        }),
        headers: { 'Content-Type': 'text/plain;charset=utf-8' }
    })
    .then(res => res.json())
    .then(result => {
        if (result.status === 'success') {
            showMessage(result.message, 'success');
        } else {
            throw new Error(result.message);
        }
    })
    .catch(error => showMessage(`Gagal menyimpan: ${error.message}`, 'error'))
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Simpan KRS';
    });
}
function handleInputMateriFromModal() {
    const selectedCheckboxes = document.querySelectorAll('#materi-list-container input[type="checkbox"]:checked');
    const modal = document.getElementById('add-materi-modal');

    let currentSks = 0;
    krsTableBody.querySelectorAll('tr td:nth-child(6)').forEach(cell => {
        currentSks += parseInt(cell.textContent, 10) || 0;
    });

    let newSks = 0;
    const itemsToAdd = [];
    selectedCheckboxes.forEach(cb => {
        const item = JSON.parse(cb.dataset.subject);
        newSks += item.sks;
        itemsToAdd.push(item);
    });

    if (currentSks + newSks > 34) {
        showMessage(`Gagal, total SKS akan menjadi ${currentSks + newSks}. Batas maksimal adalah 34 SKS.`, 'error');
        return;
    }

    // Cek jika baris pertama adalah placeholder "Belum ada materi"
    const firstRowIsPlaceholder = krsTableBody.querySelector('td[colspan="8"]');
    if (firstRowIsPlaceholder) {
        krsTableBody.innerHTML = ''; // Kosongkan tabel sebelum menambah baris baru
    }

    itemsToAdd.forEach(item => {
        const tr = document.createElement('tr');
        const code = item.subject.split(':')[0].trim();
        const namaMateri = item.subject.substring(code.length + 1).trim();
        const index = krsTableBody.rows.length; // Dapatkan indeks baris saat ini
        
        tr.className = index % 2 === 0 ? 'bg-white border-b' : 'bg-gray-50 border-b';
        tr.innerHTML = `
            <td class="px-4 py-2">${item.day}</td>
            <td class="px-4 py-2">${item.time}</td>
            <td class="px-4 py-2">${code}</td>
            <td class="px-4 py-2">${namaMateri}</td>
            <td class="px-4 py-2">${item.room}</td>
            <td class="px-4 py-2 text-center">${item.sks}</td>
            <td class="px-4 py-2">${item.teacher}</td>
            <td class="px-4 py-2 text-center"><button class="delete-krs-row text-red-500 hover:text-red-700">Hapus</button></td>
        `;
        krsTableBody.appendChild(tr);
    });

    updateKrsTotalSks();
    modal.style.display = 'none';
}

Â  Â  // --- BAGIAN 3: EVENT LISTENERS & INISIALISASI ---

Â  Â  function setupMainEventListeners() {
// Listener untuk membuka modal rubrik
    document.getElementById('floatingRubrikBtn')?.addEventListener('click', () => {
        document.getElementById('rubrikModal').style.display = 'block';
    });
    
    // Listener untuk menutup modal rubrik (menggunakan event delegation)
    const rubrikModal = document.getElementById('rubrikModal');
    if (rubrikModal) {
        rubrikModal.querySelector('.close-button')?.addEventListener('click', () => {
            rubrikModal.style.display = 'none';
        });
    }


Â  Â  Â  Â  if (ui.donasiBtn) ui.donasiBtn.onclick = () => document.getElementById('donasiModal').style.display = "block";
    
    document.body.addEventListener('click', function(event) {
	if (event.target.classList.contains('masalah-selesai-btn')) {
            const btn = event.target;
            const timestamp = btn.dataset.timestamp;

            if (!timestamp) {
                showMessage('Error: Timestamp tidak ditemukan.', 'error');
                return;
            }
            
            if (!confirm('Apakah Anda yakin ingin menandai masalah ini sebagai "Selesai"?')) {
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Menyimpan...';

            fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'markPelanggaranSelesai',
                    timestampString: timestamp
                }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            })
            .then(res => res.json())
            .then(result => {
                if (result.status === 'success') {
                    showMessage('Masalah ditandai selesai.', 'success');
                    // Ganti tombol menjadi status "Selesai" tanpa refresh halaman
                    btn.textContent = 'Selesai';
                    btn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    btn.classList.add('bg-gray-200', 'text-gray-600');
                    btn.disabled = true;
                    // Refresh notifikasi
                    fetchPelanggaranNotifications();
                } else {
                    throw new Error(result.message);
                }
            })
            .catch(error => {
                showMessage(`Gagal: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'Tandai Selesai';
            });
        }
        // Cek jika tombol kembali KRS/KHS diklik
        if (event.target.closest('#back-to-santri-krs') || event.target.closest('#back-to-santri-khs')) {
            handleBackToSantriList();
            return;
        }

        // Cek jika tombol edit penggalangan dana yang diklik
        const editButton = event.target.closest('.btn-edit-fundraising');
        
    });

// Tambahkan ini di dalam blok <script>

const classSelect = document.getElementById('className');
const studentContainer = document.getElementById('student-attendance-container');
const studentPlaceholder = document.getElementById('student-list-placeholder');

classSelect.addEventListener('change', async function() {
    // Value dari dropdown adalah nama materi lengkap, contoh: "MAT-101: Operasi Bilangan..."
    const selectedClass = this.value; 

    if (!selectedClass) {
        studentContainer.classList.add('hidden');
        studentPlaceholder.innerHTML = '<p class="text-gray-500">Pilih kelas untuk menampilkan daftar santri.</p>';
        return;
    }

    // --- PERUBAHAN UTAMA DI SINI ---
    // 1. Ekstrak KODE MATERI dari string nama lengkap
    const kodeMateri = selectedClass.split(':')[0].trim();
    // --- AKHIR PERUBAHAN UTAMA ---

    studentContainer.classList.remove('hidden');
    studentPlaceholder.innerHTML = '<p class="text-gray-500">Memuat daftar santri...</p>';

    try {
        // Memanggil fungsi Apps Script dengan 'kodeMateri'
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({
                action: 'getStudentsByClass',
                kodeMateri: kodeMateri // Kirim KODE-nya saja
            })
        });
        const result = await response.json();

        // (Sisa kode untuk menampilkan daftar santri tetap sama...)
        if (result.status === 'success' && result.students.length > 0) {
    let studentHTML = '<table class="w-full text-sm"><tbody>';
    result.students.forEach((studentName, index) => {
        const rowId = `student_row_${index}`;
        // Grup nama untuk memastikan hanya satu checkbox per santri yang bisa dipilih
        const checkboxGroupName = `status_${studentName.replace(/\s+/g, '_')}`;

        studentHTML += `
            <tr class="border-b student-attendance-row" id="${rowId}" data-student-name="${studentName}">
                <td class="py-3 pr-4 align-middle">${studentName}</td>
                <td class="py-3 text-right whitespace-nowrap align-middle">
                    <div class="flex justify-end items-start space-x-5">

                        <div class="flex flex-col items-center">
                            <label for="hadir_${index}" class="text-xs mb-1 cursor-pointer">Hadir</label>
                            <input type="checkbox" id="hadir_${index}" name="${checkboxGroupName}" value="Hadir" class="attendance-checkbox h-4 w-4 text-green-600 border-gray-300 rounded focus:ring-green-500 cursor-pointer">
                        </div>

                        <div class="flex flex-col items-center">
                            <label for="izin_${index}" class="text-xs mb-1 cursor-pointer">Izin</label>
                            <input type="checkbox" id="izin_${index}" name="${checkboxGroupName}" value="Izin" class="attendance-checkbox h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                        </div>

                        <div class="flex flex-col items-center">
                            <label for="sakit_${index}" class="text-xs mb-1 cursor-pointer">Sakit</label>
                            <input type="checkbox" id="sakit_${index}" name="${checkboxGroupName}" value="Sakit" class="attendance-checkbox h-4 w-4 text-yellow-600 border-gray-300 rounded focus:ring-yellow-500 cursor-pointer">
                        </div>

                        <div class="flex flex-col items-center">
                            <label for="alfa_${index}" class="text-xs mb-1 cursor-pointer">Alfa</label>
                            <input type="checkbox" id="alfa_${index}" name="${checkboxGroupName}" value="Tanpa Keterangan" class="attendance-checkbox h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500 cursor-pointer">
                        </div>

                    </div>
                </td>
            </tr>
        `;
    });
    studentHTML += '</tbody></table>';
    studentPlaceholder.innerHTML = studentHTML;

    // --- LOGIKA BARU UNTUK SINGLE CHECKBOX ---
    // Gunakan event delegation pada container
    studentPlaceholder.addEventListener('change', function(event) {
        // Pastikan yang berubah adalah checkbox absensi
        if (event.target.classList.contains('attendance-checkbox')) {
            const checkbox = event.target;
            // Dapatkan baris (tr) tempat checkbox ini berada
            const currentRow = checkbox.closest('.student-attendance-row');
            if (!currentRow) return;

            // Dapatkan semua checkbox dalam baris yang sama
            const checkboxesInRow = currentRow.querySelectorAll('.attendance-checkbox');

            // Jika checkbox saat ini dicentang
            if (checkbox.checked) {
                // Hapus centang pada checkbox lain di baris yang sama
                checkboxesInRow.forEach(cb => {
                    if (cb !== checkbox) {
                        cb.checked = false;
                    }
                });
            }
        }
    });
        } else if (result.status === 'success' && result.students.length === 0) {
             studentPlaceholder.innerHTML = '<p class="text-orange-500">Tidak ada santri yang mengambil materi ini di KRS.</p>';
         } else {
            studentPlaceholder.innerHTML = `<p class="text-red-500">Gagal memuat data santri: ${result.message || 'Error tidak diketahui'}</p>`;
        }

    } catch (error) {
        studentPlaceholder.innerHTML = `<p class="text-red-500">Gagal memuat data santri: ${error.message}</p>`;
    }
});

		if (ui.userProfile) ui.userProfile.onclick = () => openProfileModal();
		
		document.getElementById('simpan-materi-btn')?.addEventListener('click', handleInputMateriFromModal);
		document.getElementById('save-krs-btn')?.addEventListener('click', handleSaveKrs);
Â  Â  Â  Â  document.querySelectorAll('.close-button').forEach(btn => { btn.onclick = () => { btn.closest('.modal').style.display = 'none'; }; });
Â  Â  Â  Â  window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.style.display = "none"; } }
Â  Â  Â  Â  window.addEventListener('hashchange', updateActiveLink);
Â  Â  Â  Â  document.querySelectorAll('.toggle-password').forEach(toggle => { toggle.innerHTML = CONFIG.ICONS.eye; toggle.addEventListener('click', function () { const input = this.parentElement.querySelector('input'); if (input.type === 'password') { input.type = 'text'; this.innerHTML = CONFIG.ICONS.eyeOff; } else { input.type = 'password'; this.innerHTML = CONFIG.ICONS.eye; } }); });
Â  Â  Â  Â  document.getElementById('loginForm')?.addEventListener('submit', handleLoginSubmit);
Â  Â  Â  Â  document.getElementById('profileForm')?.addEventListener('submit', handleProfileSubmit);
Â  Â  Â  Â  document.getElementById('changePasswordForm')?.addEventListener('submit', handleChangePasswordSubmit);
Â  Â  Â  Â  document.getElementById('forgotPasswordVerifyForm')?.addEventListener('submit', handleForgotVerifySubmit);
Â  Â  Â  Â  document.getElementById('forgotPasswordResetForm')?.addEventListener('submit', handleForgotResetSubmit);
Â  Â  Â  Â  document.getElementById('attendanceFormGuru')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'guru'));
Â  Â  Â  Â  document.getElementById('attendanceFormStaf')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'staf'));
Â  Â  Â  Â  document.getElementById('attendanceFormRapat')?.addEventListener('submit', (e) => handleAttendanceSubmit(e, 'rapat'));
Â  Â  Â  Â  document.getElementById('logoutFromProfile')?.addEventListener('click', handleLogout);
Â  Â  Â  Â  document.getElementById('changePasswordFromProfile')?.addEventListener('click', () => { document.getElementById('profileModal').style.display = 'none'; document.getElementById('changePasswordModal').style.display = 'block'; document.getElementById('changePasswordForm').reset(); });
Â  Â  Â  Â  document.getElementById('forgotPasswordLink')?.addEventListener('click', (e) => { e.preventDefault(); document.getElementById('forgotPasswordModal').style.display = 'block'; });
Â  Â  Â  Â  document.querySelectorAll('input[name="role"]').forEach(radio => { radio.addEventListener('change', function() { document.getElementById('attendanceFormGuru').classList.toggle('hidden', this.value !== 'guru'); document.getElementById('attendanceFormStaf').classList.toggle('hidden', this.value !== 'staf'); document.getElementById('attendanceFormRapat').classList.toggle('hidden', this.value !== 'rapat'); }); });
Â  Â  Â  Â  document.getElementById('isSubstituteTeacher')?.addEventListener('change', function() {
Â  Â  Â  Â  Â  Â  document.getElementById('substituteTeacherSection').classList.toggle('hidden', !this.checked);
Â  Â  Â  Â  Â  Â  if (!this.checked) {
Â  Â  Â  Â  Â  Â  Â  Â  populateTeacherClasses(getActiveSession(), document.getElementById('attendanceDateGuru').value);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedTeacher = document.getElementById('substituteTeacherName').value;
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedTeacher) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  populateTeacherClasses(null, document.getElementById('attendanceDateGuru').value, selectedTeacher);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('attendanceDateGuru')?.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  const isSubstitute = document.getElementById('isSubstituteTeacher').checked;
Â  Â  Â  Â  Â  Â  const selectedTeacher = document.getElementById('substituteTeacherName').value;
Â  Â  Â  Â  Â  Â  if (isSubstitute && selectedTeacher) {
Â  Â  Â  Â  Â  Â  Â  Â  populateTeacherClasses(null, e.target.value, selectedTeacher);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  populateTeacherClasses(getActiveSession(), e.target.value);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â  document.getElementById('substituteTeacherName')?.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  const selectedTeacher = e.target.value;
Â  Â  Â  Â  Â  Â  const selectedDate = document.getElementById('attendanceDateGuru').value;
Â  Â  Â  Â  Â  Â  populateTeacherClasses(null, selectedDate, selectedTeacher);
Â  Â  Â  Â  });

		const fundImageInput = document.getElementById('input-fund-image-file');
    const fundImagePreview = document.getElementById('fundraising-image-preview');

    if (fundImageInput && fundImagePreview) {
        // Buat agar gambar pratinjau juga bisa diklik untuk memilih file
        fundImagePreview.addEventListener('click', () => fundImageInput.click());

        fundImageInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                selectedFundraisingFile = file; // Simpan file ke variabel
                const reader = new FileReader();
                reader.onload = (e) => {
                    fundImagePreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

		const fundraisingModal = document.getElementById('fundraising-modal');
    const createFundraisingBtn = document.getElementById('btn-create-fundraising');
    const fundraisingForm = document.getElementById('form-fundraising');

    if (createFundraisingBtn) {
        createFundraisingBtn.onclick = () => {
            fundraisingModal.style.display = 'block';
        };
    }

    if (fundraisingForm) {
        fundraisingForm.addEventListener('submit', handleFundraisingSubmit);
    }
		// DIUBAH TOTAL: Event listener untuk tombol 'Tambah Materi'
// GANTI SELURUH BLOK FUNGSI LAMA DENGAN VERSI FINAL YANG SUDAH DIPERBAIKI INI

addKrsRowBtn.addEventListener('click', async () => {
    const modal = document.getElementById('add-materi-modal');
    const container = document.getElementById('materi-list-container');
    const inputBtn = modal.querySelector('#simpan-materi-btn');

    // DITAMBAHKAN: Pengecekan apakah pengguna saat ini adalah admin
    const session = getActiveSession();
    const isAdminOverride = session && ['wawan', 'mia', 'admin'].includes(session.username);

    inputBtn.disabled = false;
    inputBtn.textContent = 'Input';
    container.innerHTML = '<p class="text-gray-500">Memeriksa riwayat nilai dan prasyarat...</p>';
    modal.style.display = "block";

    const santriNameBeingViewed = document.getElementById('nama-santri-krs').textContent.replace(': ', '');
    const highestPassedLevel = {};

    try {
        const allSantriWithUsernames = await getSantriDataWithUsernames();
        const santriBeingViewedData = allSantriWithUsernames.find(s => s.profileName === santriNameBeingViewed);

        if (!santriBeingViewedData || !santriBeingViewedData.username) {
            throw new Error(`Username untuk santri ${santriNameBeingViewed} tidak ditemukan.`);
        }
        
        const response = await fetch(CONFIG.SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ action: 'getAllKHSData', username: santriBeingViewedData.username }),
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }
        });

        const result = await response.json();
        if (result.status !== 'success') throw new Error(result.message);

        for (const code in result.nilai) {
            const score = result.nilai[code];
            if (score >= 70) {
                const prefix = code.slice(0, -1);
                const level = parseInt(code.slice(-1), 10);
                if (!isNaN(level)) {
                    if (!highestPassedLevel[prefix] || level > highestPassedLevel[prefix]) {
                        highestPassedLevel[prefix] = level;
                    }
                }
            }
        }
    } catch (error) {
        container.innerHTML = `<p class="p-4 text-center text-red-500">Gagal memproses prasyarat: ${error.message}</p>`;
        return;
    }
    
    const santriData = appData.santri.find(s => s.nama === santriNameBeingViewed);
    const groupInfoParts = (santriData.grup || '').split(' ');
    const santriGroup = groupInfoParts[0] || '';
    const santriCluster = groupInfoParts[1] || '';

    const currentlySavedCodes = Array.from(krsTableBody.querySelectorAll('tr'))
        .map(tr => tr.querySelector('td:nth-child(3)')?.textContent)
        .filter(Boolean);

    const activeTab = document.querySelector('.tab-btn.active');
    const monthKey = `bulan${activeTab.id.replace('tab-bulan', '')}`;
    const scheduleForActiveMonth = appState.processedSchedules[monthKey] || [];
    const uniqueSubjects = new Map();
    scheduleForActiveMonth.forEach(item => {
        if (item.subject && item.subject.includes(':')) {
            const code = item.subject.split(':')[0].trim();
            if (!uniqueSubjects.has(code)) {
                uniqueSubjects.set(code, item);
            }
        }
    });

    const availableSubjects = Array.from(uniqueSubjects.values())
        .filter(item => !currentlySavedCodes.includes(item.subject.split(':')[0].trim()));

    container.innerHTML = '';
    if (availableSubjects.length === 0) {
        container.innerHTML = '<p class="p-4 text-center text-gray-500">Semua materi yang tersedia sudah diambil.</p>';
    }

    availableSubjects
        .sort((a, b) => a.subject.localeCompare(b.subject))
        .forEach(item => {
            const code = item.subject.split(':')[0].trim();
            const prefix = code.slice(0, -1);
            const level = parseInt(code.slice(-1), 10);
            const checkboxId = `materi-${code}`;
            const maxPassed = highestPassedLevel[prefix] || 0;
            
            // --- AWAL DARI LOGIKA YANG DIUBAH ---
            let isUnlocked, isDisabled, labelClass;

            if (isAdminOverride) {
                // Untuk admin, semua materi dianggap bisa dipilih (unlocked) dan aktif (enabled)
                isUnlocked = true;
                isDisabled = false;
                // Admin tetap bisa melihat mana materi yang direkomendasikan
                if (item.group === santriGroup || (item.group === 'KG' && (item.cluster === santriCluster || item.cluster === 'Wajib'))) {
                    labelClass = 'recommended';
                } else {
                    labelClass = 'other';
                }
            } else {
                // Logika asli yang berjalan untuk santri biasa
                isUnlocked = level <= maxPassed + 1;
                isDisabled = !isUnlocked;
                
                if (isDisabled) {
                    labelClass = 'prerequisite-failed';
                } else if (item.group === santriGroup || (item.group === 'KG' && (item.cluster === santriCluster || item.cluster === 'Wajib'))) {
                    labelClass = 'recommended';
                } else {
                    labelClass = 'other';
                }
            }
            // --- AKHIR DARI LOGIKA YANG DIUBAH ---

            const div = document.createElement('div');
            div.className = 'flex items-start p-2 rounded-md hover:bg-gray-100 materi-item border-b';
            const input = document.createElement('input');
            input.id = checkboxId;
            input.type = 'checkbox';
            input.value = code;
            input.className = 'h-4 w-4 rounded border-gray-300 text-teal-600 focus:ring-teal-500 mt-1';
            input.disabled = isDisabled; // Atur status disabled berdasarkan logika di atas
            input.dataset.subject = JSON.stringify(item);
            const label = document.createElement('label');
            label.htmlFor = checkboxId;
            label.className = `ml-3 text-sm flex-1 ${labelClass}`;
            if (!isDisabled) label.classList.add('cursor-pointer');
            label.innerHTML = `<div class="font-bold">${item.subject}</div><div class="text-xs text-gray-500">${item.day}, ${item.time} | ${item.room} | ${item.sks} SKS</div>`;
            div.appendChild(input);
            div.appendChild(label);
            container.appendChild(div);
        });

    modal.querySelector('.close-button').onclick = () => {
        modal.style.display = "none";
    };
});
		
Â  Â  }

Â  Â  async function initializeApp() {
Â  Â  Â  Â  updateDateTime();
Â  Â  Â  Â  setTodayDate();
		
		generateAcademicMonthRanges();
		initializeJadwalSholat(); 
		
		checkAndDisplayHeaderNotifications();
        setInterval(checkAndDisplayHeaderNotifications, 60 * 60 * 1000); // Cek setiap 1 jam

Â  Â  Â  Â Â // 1. Panggil fungsi baru untuk mencoba mengambil data dari server
    const fetchedSchedules = await fetchRosterDataFromServer();

    // 2. Tentukan data mana yang akan digunakan
    if (fetchedSchedules) {
        // Jika unduhan berhasil, timpa data dummy dengan data baru dari server
        appData.schedules = fetchedSchedules;
    } else {
        // Jika unduhan gagal, gunakan data dummy yang sudah ada di file
        console.log("Menggunakan data dummy untuk menampilkan jadwal.");
    }
    
    // 3. Olah data yang sudah final (baik itu dari server atau dummy) ke dalam appState
    appState.processedSchedules = {};
    for (let i = 1; i <= 8; i++) {
        const monthKey = `bulan${i}`;
        
        // LOGIKA BARU: Cek apakah data berbentuk array (dari server) atau objek (dummy)
        if (Array.isArray(appData.schedules)) {
             // Jika dari server, filter berdasarkan properti 'bulan'
             appState.processedSchedules[monthKey] = appData.schedules.filter(item => String(item.bulan) === String(i));
        } else {
             // Jika dummy, ambil langsung dari properti objek
             appState.processedSchedules[monthKey] = appData.schedules[monthKey] || [];
        }
    }
    // ====================================================================
	if (appData.schedules && typeof appData.schedules === 'object') {
        Object.keys(appData.schedules).forEach(monthKey => {
            const monthNumber = monthKey.replace('bulan', '');
            if (Array.isArray(appData.schedules[monthKey])) {
                appData.schedules[monthKey].forEach(item => {
                    item.bulan = monthNumber; // Menambahkan properti bulan ke setiap jadwal
                });
            }
        });
    }
Â  Â  Â  Â  const session = getActiveSession();
Â  Â  Â  Â  if (session && session.loggedIn) {
Â  Â  Â  Â  Â  Â  showLoggedInView(session.userData);
Â  Â  Â  Â  Â  Â  logUserVisit();
Â  Â  Â  Â  Â  Â  fetchDailyVisitors();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showLoggedOutView();
Â  Â  Â  Â  }
Â  Â  Â  Â Â const currentHash = window.location.hash || '#beranda';
    if (currentHash === '#beranda') {
        showAnnouncementPopup();
    }
Â  Â  Â  Â  updateActiveLink();
Â  Â  Â  Â  setupMainEventListeners();
		setupAdvancedDropdown(); 
Â  Â  Â  Â  renderNewsCards();
Â  Â  Â  Â  renderGalleryCards();
		renderFundraisingCards(session);
Â  Â  Â  Â  fetchMarqueeText();
Â  Â  Â  Â  renderDynamicCalendar(2025, 7, 12);
Â  Â  Â  Â  setupSlideshow();
Â  Â  Â  Â  populateSubstituteTeachers();
		setupSantriSelectorListeners();
		renderExamSchedule();
    setupExamListeners();
	setupResultModalListeners();
	setupExamSecurityListeners();
	setupInputSoalPage();
	initializePlayer(); 
Â  Â  }

// HAPUS FUNGSI LAMA setupDropdownMobile() DAN GANTI DENGAN INI
function setupAdvancedDropdown() {
    const dropbtn = document.querySelector('#sistemInformasiDropdown .dropbtn');
    const dropdownContent = document.querySelector('#sistemInformasiDropdown .dropdown-content');
    
    // Jika elemen tidak ditemukan, hentikan fungsi
    if (!dropbtn || !dropdownContent) return;

    const originalParent = dropdownContent.parentElement; // Simpan "rumah" asli dari submenu

    // Fungsi untuk menutup menu
    const closeMenu = () => {
        if (dropdownContent.classList.contains('dropdown-content-show')) {
            dropdownContent.classList.remove('dropdown-content-show');
            dropbtn.classList.remove('active');
            // Kembalikan submenu ke "rumah" aslinya setelah animasi selesai
            setTimeout(() => {
                originalParent.appendChild(dropdownContent);
                // Hapus style posisi agar tidak bentrok nanti
                dropdownContent.style.left = '';
                dropdownContent.style.top = '';
                dropdownContent.style.width = '';
            }, 150);
        }
    };

    // Saat tombol "Sistem Informasi" di-klik
    dropbtn.addEventListener('click', function(event) {
        event.preventDefault();
        event.stopPropagation(); // Mencegah klik menyebar ke window

        const isMenuOpen = dropdownContent.classList.contains('dropdown-content-show');

        if (isMenuOpen) {
            closeMenu();
        } else {
            // "Bebaskan" submenu dengan memindahkannya ke <body>
            document.body.appendChild(dropdownContent);

            // Hitung posisi tombol di layar
            const btnRect = dropbtn.getBoundingClientRect();

            // Atur posisi submenu tepat di bawah tombol
            dropdownContent.style.left = `${btnRect.left}px`;
            dropdownContent.style.top = `${btnRect.bottom}px`;
            // Samakan lebar submenu dengan tombolnya agar rapi
            dropdownContent.style.width = `${btnRect.width}px`;

            // Tampilkan submenu
            dropdownContent.classList.add('dropdown-content-show');
            dropbtn.classList.add('active');
        }
    });

    // Tambahkan event listener untuk menutup menu jika mengklik di tempat lain
    window.addEventListener('click', closeMenu);
	
	
}
    


Â  Â  // --- MULAI APLIKASI ---
Â  Â  initializeApp();
});
</script>
</body>
</html>
