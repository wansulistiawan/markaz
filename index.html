<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster KBM Interaktif - RTQ Markaz Qur'an Al-Maa'un</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom Styles -->
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
        }

        /* Grid Layout for Schedule */
        .schedule-grid {
            display: grid;
            grid-template-columns: 90px repeat(6, 1fr);
            gap: 4px;
        }

        .time-slot, .day-header {
            font-weight: 600;
            text-align: center;
            padding: 8px 4px;
        }

        .schedule-cell {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px;
            min-height: 120px;
            transition: all 0.3s ease-in-out;
            background-color: white;
            display: flex;
            flex-direction: column;
        }

        /* Highlighting and Effects */
        .highlight {
            background-color: #f0fdfa; /* teal-50 */
            border-color: #14b8a6; /* teal-500 */
            transform: scale(1.03);
            z-index: 10;
            position: relative;
            animation: glow-animation 2s ease-in-out infinite;
        }

        .dimmed {
            opacity: 0.3;
            filter: grayscale(80%);
        }

        @keyframes glow-animation {
            0% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); }
            50% { box-shadow: 0 0 20px 5px rgba(20, 184, 166, 0.8); }
            100% { box-shadow: 0 0 5px rgba(20, 184, 166, 0.5); }
        }

        /* Room Specific Styles */
        .room-rbm {
            background-color: #fff7ed; /* orange-50 */
            border-color: #fb923c;   /* orange-400 */
            border-style: dashed;
        }
        .room-rbm .subject {
            font-style: italic;
            color: #c2410c; /* orange-700 */
        }
        .room-madinah {
            background-color: rgba(59, 130, 246, 0.1); /* blue-500 with 10% opacity */
            border-color: #60a5fa; /* blue-400 */
        }
        .room-mekah {
            background-color: rgba(132, 204, 22, 0.1); /* lime-500 with 10% opacity */
            border-color: #a3e635; /* lime-400 */
        }

        .subject {
            flex-grow: 1;
        }

        /* Custom Select Arrow */
        .filter-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1em;
            padding-right: 2.5rem;
        }

        /* Editable Cell Styles */
        .editable-cell {
            background-color: #f0fdfa;
            padding: 8px 12px;
            border-radius: 4px;
            transition: background-color 0.2s;
            cursor: text;
        }
        .editable-cell:focus {
            background-color: #ccfbf1;
            outline: 2px solid #14b8a6;
        }

        /* Floating Action Buttons (FAB) */
        #floating-action-buttons {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #floating-action-buttons button {
            position: relative;
            display: flex;
            align-items: center;
        }
        .fab-label {
            position: absolute;
            right: 100%;
            margin-right: 16px;
            background-color: #1f2937; /* bg-gray-800 */
            color: white;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            opacity: 0;
            transform: translateX(10px);
            pointer-events: none;
            transition: all 0.2s ease-in-out;
        }
        #floating-action-buttons button:hover .fab-label {
            opacity: 1;
            transform: translateX(0);
        }

        /* Print Styles */
        @media print {
            @page {
                size: landscape;
                margin: 1cm;
            }
            body {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            header, .sticky.top-0, #floating-action-buttons, #teacher-data-container, #module-data-container {
                display: none !important;
            }
            #schedule-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                box-shadow: none;
                border: none;
                padding: 0;
                overflow: visible;
            }
            .schedule-grid {
                font-size: 8pt;
                gap: 1px;
                border: 1px solid #ccc;
            }
            .schedule-cell {
                min-height: auto;
                padding: 4px;
                border: 1px solid #eee;
            }
            .schedule-cell .room, .schedule-cell .teacher {
                font-size: 12pt;
            }
            .highlight, .dimmed {
                transform: none;
                opacity: 1;
                filter: none;
                animation: none;
            }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-6">
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-teal-800">Roster KBM Dinamis</h1>
            <h2 class="text-3xl md:text-4xl font-bold text-teal-800">Markaz Qur'an Al-Maa'un</h2>
            <p class="text-slate-600 mt-2">Semester Ganjil</p>
        </header>

        <!-- Filter Section -->
        <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg mb-6 sticky top-0 z-20">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                <div>
                    <label for="filter-group" class="block text-sm font-medium text-slate-700">Kelompok</label>
                    <select id="filter-group" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Kelompok</option>
                        <option value="KF">Kelas Fondasi</option>
                        <option value="KG">Kelas Gabungan</option>
                    </select>
                </div>
                <div>
                    <label for="filter-cluster" class="block text-sm font-medium text-slate-700">Klaster (Kelas Gabungan)</label>
                    <select id="filter-cluster" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md" disabled>
                        <option value="all">Semua Klaster</option>
                        <option value="LKS">Literasi & Kreatif Syariah</option>
                        <option value="STT">Sains & Teknologi Terapan</option>
                    </select>
                </div>
                <div>
                    <label for="filter-teacher" class="block text-sm font-medium text-slate-700">Guru</label>
                    <select id="filter-teacher" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Guru</option>
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <div>
                    <label for="filter-room" class="block text-sm font-medium text-slate-700">Ruang</label>
                    <select id="filter-room" class="filter-select mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-teal-500 focus:border-teal-500 sm:text-sm rounded-md">
                        <option value="all">Semua Ruang</option>
                        <option value="Kelas Mekah">Kelas Mekah</option>
                        <option value="Kelas Madinah">Kelas Madinah</option>
                        <option value="RBM">RBM</option>
                    </select>
                </div>
                <div>
                    <button id="reset-filters" class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition">
                        Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Schedule Container -->
        <div id="schedule-container" class="overflow-x-auto bg-white p-2 rounded-xl shadow-lg">
            <!-- Schedule grid will be rendered here by JS -->
        </div>
        
        <!-- Teacher Data Table -->
        <div id="teacher-data-container" class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-800">Data Guru</h3>
                <button id="add-teacher-row" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tambah Guru
                </button>
            </div>
            <div class="overflow-x-auto">
                <table id="teacher-table" class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Nama Guru</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Bidang / Jurusan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Hari</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jadwal (Slot Waktu)</th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        <!-- Teacher rows will be rendered here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Module Data Table -->
        <div id="module-data-container" class="mt-8 bg-white p-4 sm:p-6 rounded-xl shadow-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-2xl font-bold text-teal-800">Data Modul</h3>
                <button id="add-module-row" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500 transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                    Tambah Modul
                </button>
            </div>
            <div class="overflow-x-auto">
                <table id="module-table" class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider w-16">No</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Jurusan</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Mapel Induk</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Kode Modul</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Modul</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">SKS</th>
                            <th scope="col" class="relative px-6 py-3 w-20"><span class="sr-only">Aksi</span></th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-slate-200">
                        <!-- Module rows will be rendered here by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div id="floating-action-buttons">
        <button id="reset-schedule" title="Reset Jadwal ke Awal" class="bg-red-600 text-white rounded-full p-3 shadow-lg hover:bg-red-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Reset Jadwal</span>
        </button>
        <button id="print-schedule" title="Cetak Jadwal" class="bg-blue-600 text-white rounded-full p-3 shadow-lg hover:bg-blue-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v4h6v-4z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Cetak</span>
        </button>
        <button id="download-jpg" title="Unduh sebagai JPG" class="bg-green-600 text-white rounded-full p-3 shadow-lg hover:bg-green-700">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
            <span class="fab-label">Unduh Jadwal</span>
        </button>
    </div>

    <!-- Custom Modal for Confirmation -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modal-title">Konfirmasi</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500" id="modal-message">Apakah Anda yakin?</p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="modal-confirm-btn" class="px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-auto shadow-sm hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500">
                        Ya, Lanjutkan
                    </button>
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-auto ml-2 shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-300">
                        Batal
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- DATA ---
        const initialScheduleData = [
            // Senin
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & Pecahan", teacher: "Sulistiawan, S.Kom" },
            { day: "Senin", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "MAT-101: Operasi Bilangan Bulat & Pecahan", teacher: "Sulistiawan, S.Kom" },
	    { day: "Senin", time: "08:00-09:30", sks: 2, room: "RBM", group: "kelompok", cluster: "klaster", subject: "Tugas : Kosong", teacher: "Kosong" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "IND-101: Membaca Pemahaman Teks", teacher: "Mia A. Lubis, S.Kom" },
            { day: "Senin", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "THI-201: Pengantar Thibbun Nabawi", teacher: "Sulistiawan, S.Kom" },
	    { day: "Senin", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Tugas : MAT-101", teacher: "Sulistiawan, S.Kom" },
            { day: "Senin", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Senin", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Senin", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "LKS", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },		
            { day: "Senin", time: "12:45-14:15", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "Wajib", subject: "ENG-101: Daily Vocabulary & Simple Greetings", teacher: "Ariyanti R. Siregar, S.Kom" },
            { day: "Senin", time: "12:45-14:15", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "KWU-201: Riset Pasar & Analisis Kompetitor", teacher: "Sulistiawan, S.Kom" },
            { day: "Senin", time: "12:45-14:15", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Tugas: MAT-101", teacher: "Sulistiawan, S.Kom" },
            
            // Selasa
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAU-101: Makna & Konsekuensi 2 Kalimat Syahadat", teacher: "Erwansyah Putra, S.Pd" },
            { day: "Selasa", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "KES-201: Pengantar Anatomi & Fisiologi", teacher: "Sulistiawan, S.Kom" },
	    { day: "Selasa", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Tugas: PAI-201", teacher: "Kosong" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "AKH-101: Adab Kepada Allah", teacher: "Erwansyah Putra, S.Pd" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "FIS-201: Hukum Newton tentang Gerak & Gaya ", teacher: "Sulistiawan, S.Kom" },
            { day: "Selasa", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Tugas: KWU-201", teacher: "" },
            { day: "Selasa", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Selasa", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KF", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Selasa", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "STT", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Selasa", time: "12:45-14:15", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "Ara-201 : Percakapan 4: (Kesehatan & Menjenguk Orang Sakit) ", teacher: "Erwansyah Putra, S.Pd" },
            { day: "Selasa", time: "12:45-14:15", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "IPA-101: Ciri Makhluk Hidup & Klasifikasi Sederhana", teacher: "Ariyanti R. Siregar, S.Kom" },
            { day: "Selasa", time: "12:45-14:15", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "" },
            
            // Rabu
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "ULH-201: Pengantar Ilmu Hadits (Definisi & Sejarah)", teacher: "Erwansyah Putra, S.Pd" },
            { day: "Rabu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "KWU-101: Pengantar Mindset Wirausaha Muslim", teacher: "Sulistiawan, S.Kom" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "IPS-101: Peta, Kondisi Geografis, & Interaksi Manusia-Ruang", teacher: "Mia A. Lubis, S.Kom" },
            { day: "Rabu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "PANC-201: Implementasi nilai-nilai Pancasila Dalam Kehidupan", teacher: "Sulistiawan, S.Kom" },
            { day: "Rabu", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Rabu", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "Wajib", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Rabu", time: "12:45-14:15", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ENG-201: Reading & Understanding Procedure Texts", teacher: "Ariyanti R. Siregar, S.Kom" },
            { day: "Rabu", time: "12:45-14:15", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "HAD-101: Hadits Arba'in 1 (Hafalan & Makna Hadits #1-5", teacher: "Zhofri F. Majdi, S.Sos" },
            
            // Kamis
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "TIK-101: Pengenalan Hardware, Software, & Internet Sehat", teacher: "Sulistiawan, S.Kom" },
            { day: "Kamis", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "TAU-201: Studi Kitab Tauhid 1", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG (LKS)", cluster: "LKS", subject: "TIK-201: Desain Grafis Dakwah (Prinsip Dasar & Canva)", teacher: "Mia A. Lubis, S.Kom" },
            { day: "Kamis", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG (STT)", cluster: "STT", subject: "KIM-201: Larutan Elektrolit & Non-Elektrolit", teacher: "Sulistiawan, S.Kom" },
	    { day: "Kamis", time: "10:00-11:30", sks: 2, room: "RBM", group: "KF", cluster: "Wajib", subject: "MAT-101", teacher: "Sulistiawan, S.Kom" },
            { day: "Kamis", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Kamis", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "STT", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Kamis", time: "12:45-14:15", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "STT", subject: "BIO-201: Sistem Gerak pada Manusia (Sendi & Otot)", teacher: "Ariyanti R. Siregar, S.Kom" },
            { day: "Kamis", time: "12:45-14:15", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "ULQ-201: Sejarah Penulisan & Pengumpulan Al-Qur'an", teacher: "Sulistiawan, S.Kom" },
            
            // Jumat
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "FIQ-101: Wudhu & Tayammum", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-201: Tanda-tanda I'rab untuk Isim", teacher: "M. Ryza Anshori, S.Pd" },
            { day: "Jumat", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SIR-101: Kondisi Dunia Sebelum Kenabian & Masa Kecil Nabi", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "BAL-203: Ilmu Bayan: Isti'arah & Kinayah", teacher: "M. Ryza Anshori, S.Pd" },
            { day: "Jumat", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "" },
            
            // Sabtu
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "TAF-201: Tafsir & Tadabbur Surat Al-Maa'un & Al-Kafirun", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "Kelas Madinah", group: "KF", cluster: "", subject: "ARA-101: Perkenalan Diri & Keluarga", teacher: "Erwansyah Putra, S.Pd" },
            { day: "Sabtu", time: "08:00-09:30", sks: 2, room: "RBM", group: "KG", cluster: "LKS", subject: "Materi", teacher: "" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Mekah", group: "KG", cluster: "LKS", subject: "SIR-201: Peristiwa Boikot & Wafatnya Khadijah dan Abu Thalib", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "Materi", teacher: "Mia A. Lubis, S.Kom" },
            { day: "Sabtu", time: "10:00-11:30", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "" },
            { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "Kelas Mekah", group: "KF", cluster: "", subject: "ISTIRAHAT TIDUR SIANG", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Sabtu", time: "11:30-12:15", sks: 1, room: "RBM", group: "KG", cluster: "STT", subject: "ISTIRAHAT TIDUR SIANG", teacher: "" },
            { day: "Sabtu", time: "12:45-14:15", sks: 2, room: "Kelas Mekah", group: "KF", cluster: "", subject: "SHO-201: ", teacher: "Zhofri F. Majdi, S.Sos" },
            { day: "Sabtu", time: "12:45-14:15", sks: 2, room: "Kelas Madinah", group: "KG", cluster: "LKS", subject: "NAH-101: Pengenalan Kalimat (Jumlah Mufidah) & Jenis Kata", teacher: "Mahadi Sentosa, S.Sos" },
            { day: "Sabtu", time: "12:45-14:15", sks: 2, room: "RBM", group: "KG", cluster: "STT", subject: "Materi", teacher: "" },
        ];
        
        const defaultTeachers = [
            { no: 1, name: "Sulistiawan, S.Kom", major: "Pelajaran Umum & Keterampilan", hari: "Semua hari & jam", schedule: "Guru Cadangan" },
            { no: 2, name: "Zhofri F. Majdi, S.Sos", major: "Diniyah", hari: "Kamis, Jumat, Sabtu", schedule: "Kamis (08-10), Jumat & Sabtu (Semua Jam)" },
            { no: 3, name: "M. Ryza Anshori, S.Pd", major: "Diniyah", hari: "Jumat", schedule: "Semua Jam" },
            { no: 4, name: "Erwansyah Putra, S.Pd", major: "Diniyah", hari: "Selasa, Rabu, Sabtu", schedule: "Selasa (Semua Jam), Rabu & Sabtu (sampai 10.00)" },
            { no: 5, name: "Ariyanti R. Siregar, S.Kom", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "12.45 - 14.15" },
            { no: 6, name: "Mia A. Lubis, S.Kom", major: "Pelajaran Umum", hari: "Semua Hari", schedule: "10.00 - 12.15 (Guru Cadangan)" },
        ];

        const defaultModules = [
            { no: 1, major: "Jurusan Wajib", parent_subject: "Matematika", code: "Mat-101", module: "Operasi Bilangan Bulat & Pecahan", sks: "8 SKS" }
        ];

        // --- GLOBAL STATE ---
        let scheduleData = JSON.parse(localStorage.getItem('mySchedule')) || initialScheduleData;

        // --- DOM ELEMENTS ---
        const scheduleContainer = document.getElementById('schedule-container');
        const filterGroup = document.getElementById('filter-group');
        const filterCluster = document.getElementById('filter-cluster');
        const filterTeacher = document.getElementById('filter-teacher');
        const filterRoom = document.getElementById('filter-room');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const teacherTableBody = document.querySelector('#teacher-table tbody');
        const addTeacherBtn = document.getElementById('add-teacher-row');
        const moduleTableBody = document.querySelector('#module-table tbody');
        const addModuleBtn = document.getElementById('add-module-row');
        const modal = document.getElementById('confirmation-modal');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalMessage = document.getElementById('modal-message');

        // --- UTILITY & HELPER FUNCTIONS ---

        /**
         * Custom confirmation modal to avoid using browser's blocking `confirm()`
         * @param {string} message - The message to display in the modal.
         * @returns {Promise<boolean>} - A promise that resolves to true if confirmed, false otherwise.
         */
        const showConfirmation = (message) => {
            return new Promise((resolve) => {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');

                const confirmHandler = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(true);
                };

                const cancelHandler = () => {
                    modal.classList.add('hidden');
                    cleanup();
                    resolve(false);
                };

                const cleanup = () => {
                    modalConfirmBtn.removeEventListener('click', confirmHandler);
                    modalCancelBtn.removeEventListener('click', cancelHandler);
                };

                modalConfirmBtn.addEventListener('click', confirmHandler);
                modalCancelBtn.addEventListener('click', cancelHandler);
            });
        };
        
        /**
         * Saves the current schedule data to localStorage.
         */
        const saveSchedule = () => {
            localStorage.setItem('mySchedule', JSON.stringify(scheduleData));
        };

        /**
         * Creates an editable table cell (<td>) with a contenteditable <div> inside.
         * @param {string} content - The initial text content of the cell.
         * @returns {HTMLTableCellElement} The created table cell element.
         */
        const createEditableCell = (content) => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap';
            const div = document.createElement('div');
            div.className = 'text-sm text-slate-900 editable-cell';
            div.setAttribute('contenteditable', 'true');
            div.textContent = content;
            cell.appendChild(div);
            return cell;
        };

        // --- SCHEDULE RENDER & FILTER LOGIC ---
        
        /**
         * Populates the teacher filter dropdown with unique names from the schedule data.
         */
        const populateTeacherFilter = () => {
            const teachers = [...new Set(scheduleData.map(item => item.teacher).filter(Boolean))];
            teachers.sort();
            filterTeacher.innerHTML = '<option value="all">Semua Guru</option>'; // Reset
            teachers.forEach(teacher => {
                const option = document.createElement('option');
                option.value = teacher;
                option.textContent = teacher;
                filterTeacher.appendChild(option);
            });
        };
        
        /**
         * Renders the entire schedule grid based on the current scheduleData.
         */
        const renderSchedule = () => {
            scheduleContainer.innerHTML = '';
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            const days = ["", "Senin", "Selasa", "Rabu", "Kamis", "Jumat", "Sabtu"];
            const timeSlots = ["08:00-09:30", "10:00-11:30", "11:30-12:15", "12:45-14:15"];
            const rooms = ["Kelas Mekah", "Kelas Madinah", "RBM"];

            days.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header text-slate-600 bg-slate-200 rounded-t-lg';
                dayHeader.textContent = day;
                grid.appendChild(dayHeader);
            });

            timeSlots.forEach(time => {
                const timeHeader = document.createElement('div');
                timeHeader.className = 'time-slot text-teal-700 bg-slate-200 flex items-center justify-center rounded-l-lg';
                timeHeader.textContent = time;
                grid.appendChild(timeHeader);

                days.slice(1).forEach(day => {
                    const cellContainer = document.createElement('div');
                    cellContainer.className = 'p-1 bg-slate-100 rounded-lg space-y-1 flex flex-col justify-around';
                    
                    const dayTimeData = scheduleData.filter(item => item.day === day && item.time === time);
                    
                    if (day === 'Jumat' && time === '11:30-12:15') {
                        const item = dayTimeData.find(d => d.subject.includes('Jumat Bersih'));
                        if (item) {
                            const cell = document.createElement('div');
                            cell.className = 'schedule-cell items-center justify-center bg-slate-200 col-span-3'; // Spanning handled by parent grid
                            cell.dataset.group = item.group;
                            cell.dataset.cluster = item.cluster;
                            cell.innerHTML = `<div class="font-semibold text-slate-600">${item.subject}</div>`;
                            cellContainer.appendChild(cell);
                            cellContainer.style.gridColumn = 'span 3'; // This correctly spans the container
                        }
                    } else {
                        rooms.forEach(room => {
                            const item = dayTimeData.find(d => d.room === room);
                            const cell = document.createElement('div');
                            cell.className = 'schedule-cell';
                            if (item) {
                                cell.dataset.group = item.group;
                                cell.dataset.teacher = item.teacher;
                                cell.dataset.room = item.room;
                                cell.dataset.cluster = item.cluster;
                                if (item.room === 'RBM') cell.classList.add('room-rbm');
                                if (item.room === 'Kelas Madinah') cell.classList.add('room-madinah');
                                if (item.room === 'Kelas Mekah') cell.classList.add('room-mekah');
                                
                                let displayGroup = item.group;
                                if (item.group === 'KG' && item.cluster) {
                                    displayGroup = `KG (${item.cluster})`;
                                }

                                cell.innerHTML = `
                                    <div class="subject font-bold text-sm text-teal-900" contenteditable="true">📘${item.subject}</div>
     
        <div class="group-display font-semibold text-xs text-slate-600">
            🧑‍🤝‍🧑${displayGroup}
        </div>
 
				            <div class="sks-display font-bold text-xs text-teal-500 text-right"> ${item.sks} SKS
       				 </div>
                                    <div class="teacher font-semibold text-xs text-teal-600 mt-2" contenteditable="true">👤${item.teacher || ''}</div>
                                    <div class="room text-xs font-semibold ${item.room === 'RBM' ? 'text-orange-700' : 'text-sky-700'} mt-1">📍 ${item.room}</div>
                                `;
                            }
                            cellContainer.appendChild(cell);
                        });
                    }
                    grid.appendChild(cellContainer);
                });
            });
            scheduleContainer.appendChild(grid);
            applyFilters();
        };

        /**
         * Applies filters to the schedule grid, highlighting matching cells and dimming others.
         */
        const applyFilters = () => {
            const group = filterGroup.value;
            let cluster = filterCluster.value;
            const teacher = filterTeacher.value;
            const room = filterRoom.value;

            filterCluster.disabled = (group !== 'KG');
            if (group !== 'KG') {
                filterCluster.value = 'all';
                cluster = 'all';
            }
            
            document.querySelectorAll('.schedule-cell').forEach(cell => {
                const cellData = cell.dataset;
                if (!cellData.group) {
                    cell.classList.remove('highlight', 'dimmed');
                    return;
                }

                let isMatch = true;
                if (group !== 'all' && cellData.group !== group) isMatch = false;
                if (cluster !== 'all' && cellData.cluster !== cluster && cellData.cluster !== 'Wajib') isMatch = false;
                if (teacher !== 'all' && cellData.teacher !== teacher) isMatch = false;
                if (room !== 'all' && cellData.room !== room) isMatch = false;

                if (group === 'all' && cluster === 'all' && teacher === 'all' && room === 'all') {
                    cell.classList.remove('highlight', 'dimmed');
                } else if (isMatch) {
                    cell.classList.add('highlight');
                    cell.classList.remove('dimmed');
                } else {
                    cell.classList.remove('highlight');
                    cell.classList.add('dimmed');
                }
            });
        };
        
        // --- DATA TABLE LOGIC (TEACHERS & MODULES) ---
        
        /**
         * Generic function to handle adding a new row to a table.
         * @param {HTMLTableSectionElement} tableBody - The tbody element of the table.
         * @param {Object} data - The data for the new row.
         * @param {Function} createRowFn - The function to create the specific row structure.
         */
        const addTableRow = (tableBody, data, createRowFn) => {
            const row = createRowFn(data);
            tableBody.appendChild(row);
        };

        /**
         * Generic function to update row numbers in a table.
         * @param {HTMLTableSectionElement} tableBody - The tbody element of the table.
         */
        const updateRowNumbers = (tableBody) => {
            const rows = tableBody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                row.cells[0].textContent = index + 1;
            });
        };
        
        /**
         * Creates a delete button for a table row.
         * @param {HTMLTableRowElement} row - The row to be deleted.
         * @param {HTMLTableSectionElement} tableBody - The tbody to update numbers in.
         * @returns {HTMLTableCellElement} The cell containing the delete button.
         */
        const createDeleteButton = (row, tableBody) => {
            const cell = document.createElement('td');
            cell.className = 'px-6 py-4 whitespace-nowrap text-center text-sm font-medium';
            const button = document.createElement('button');
            button.className = 'text-red-600 hover:text-red-900';
            button.innerHTML = 'Hapus';
            button.onclick = async () => {
                const confirmed = await showConfirmation('Apakah Anda yakin ingin menghapus baris ini?');
                if (confirmed) {
                    row.remove();
                    updateRowNumbers(tableBody);
                }
            };
            cell.appendChild(button);
            return cell;
        };

        // Teacher Table Specific Functions
        const createTeacherRow = (teacherData) => {
            const row = document.createElement('tr');
            const noCell = document.createElement('td');
            noCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500';
            noCell.textContent = teacherData.no;
            row.appendChild(noCell);
            row.appendChild(createEditableCell(teacherData.name));
            row.appendChild(createEditableCell(teacherData.major));
            row.appendChild(createEditableCell(teacherData.hari));
            row.appendChild(createEditableCell(teacherData.schedule));
            row.appendChild(createDeleteButton(row, teacherTableBody));
            return row;
        };

        // Module Table Specific Functions
        const createModuleRow = (moduleData) => {
            const row = document.createElement('tr');
            const noCell = document.createElement('td');
            noCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-500';
            noCell.textContent = moduleData.no;
            row.appendChild(noCell);
            row.appendChild(createEditableCell(moduleData.major));
            row.appendChild(createEditableCell(moduleData.parent_subject));
            row.appendChild(createEditableCell(moduleData.code));
            row.appendChild(createEditableCell(moduleData.module));
            row.appendChild(createEditableCell(moduleData.sks));
            row.appendChild(createDeleteButton(row, moduleTableBody));
            return row;
        };

        // --- EVENT LISTENERS ---

        // Filter listeners
        filterGroup.addEventListener('change', applyFilters);
        filterCluster.addEventListener('change', applyFilters);
        filterTeacher.addEventListener('change', applyFilters);
        filterRoom.addEventListener('change', applyFilters);
        resetFiltersBtn.addEventListener('click', () => {
            filterGroup.value = 'all';
            filterCluster.value = 'all';
            filterTeacher.value = 'all';
            filterRoom.value = 'all';
            applyFilters();
        });

        // Floating Action Button Listeners
        document.getElementById('reset-schedule').addEventListener('click', async () => {
            const confirmed = await showConfirmation('Apakah Anda yakin ingin mengembalikan jadwal ke data semula? Semua perubahan akan hilang.');
            if (confirmed) {
                localStorage.removeItem('mySchedule');
                scheduleData = initialScheduleData; // Reset in-memory data
                renderSchedule(); // Re-render with initial data
                populateTeacherFilter(); // Repopulate filters
            }
        });

        document.getElementById('print-schedule').addEventListener('click', () => window.print());

        document.getElementById('download-jpg').addEventListener('click', function() {
            const downloadBtn = this;
            const label = downloadBtn.querySelector('.fab-label');
            const originalText = label.textContent;

            label.textContent = 'Mengunduh...';
            downloadBtn.disabled = true;

            html2canvas(scheduleContainer, { scale: 2, useCORS: true }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'jadwal-kbm.jpg';
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
                
                label.textContent = originalText;
                downloadBtn.disabled = false;
            }).catch(err => {
                console.error("Error generating JPG:", err);
                label.textContent = "Gagal Unduh";
                setTimeout(() => {
                    label.textContent = originalText;
                    downloadBtn.disabled = false;
                }, 3000);
            });
        });

        // Data Table Listeners
        addTeacherBtn.addEventListener('click', () => {
            const newRowNumber = teacherTableBody.rows.length + 1;
            const newTeacherData = {
                no: newRowNumber, name: "Nama Guru Baru", major: "Bidang/Jurusan",
                hari: "Masukkan Hari", schedule: "Waktu Jadwal"
            };
            addTableRow(teacherTableBody, newTeacherData, createTeacherRow);
        });

        addModuleBtn.addEventListener('click', () => {
            const newRowNumber = moduleTableBody.rows.length + 1;
            const newModuleData = {
                no: newRowNumber, major: "Jurusan Baru", parent_subject: "Mapel Induk",
                code: "Kode-Baru", module: "Nama Modul Baru", sks: "0 SKS"
            };
            addTableRow(moduleTableBody, newModuleData, createModuleRow);
        });

        // --- INITIALIZATION ---
        
        // Populate tables with default data
        teacherTableBody.innerHTML = ''; // Clear existing rows before populating
        defaultTeachers.forEach(teacher => addTableRow(teacherTableBody, teacher, createTeacherRow));
        
        moduleTableBody.innerHTML = ''; // Clear existing rows
        defaultModules.forEach(mod => addTableRow(moduleTableBody, mod, createModuleRow));

        // Initial render of the schedule
        populateTeacherFilter();
        renderSchedule();
    });
    </script>
</body>
</html>
