<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Kasir (ZBar.wasm)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #333; }
        .container { max-width: 1200px; }
        .sidebar { background-color: #1f2937; transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 50; }
        .sidebar.open { transform: translateX(0); }
        @media (min-width: 768px) { .sidebar { transform: translateX(0); position: relative; } }
        .sidebar a { color: #d1d5db; }
        .sidebar a:hover { background-color: #374151; }
        .active-link { background-color: #4b5563; color: #ffffff; }
        .card { background-color: #ffffff; border-radius: 0.75rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background-color: #3b82f6; color: #ffffff; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: #ffffff; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-success { background-color: #22c55e; color: #ffffff; }
        .btn-success:hover { background-color: #16a34a; }
        .table-header { background-color: #f3f4f6; }
        input, select, textarea { border: 1px solid #d1d5db; }
        #barcode-scanner-video { width: 100%; height: auto; border-radius: 8px; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col md:flex-row min-h-screen">
    
    <header class="bg-gray-800 text-white p-4 flex justify-between items-center md:hidden">
        <div class="text-xl font-bold">Sistem Kasir</div>
        <button id="menu-toggle" class="focus:outline-none">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <aside id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 p-4 text-gray-300 flex flex-col items-center md:relative md:flex md:transform-none">
        <div class="text-2xl font-bold text-white mb-8 hidden md:block">Sistem Kasir</div>
        <nav class="flex flex-col w-full space-y-2">
            <a href="#" class="p-3 rounded-md transition-colors active-link" onclick="showSection('manajemen')">Manajemen</a>
            <a href="#" class="p-3 rounded-md transition-colors" onclick="showSection('transaksi')">Transaksi Penjualan</a>
            <a href="#" class="p-3 rounded-md transition-colors" onclick="showSection('laporan')">Laporan</a>
        </nav>
    </aside>

    <main class="flex-1 p-4 sm:p-8">
        <section id="manajemen" class="active-section">
            <h2 class="text-2xl sm:text-3xl font-bold mb-6">Manajemen</h2>
            <div class="card p-4 sm:p-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4 sm:gap-0">
                    <h3 class="text-lg sm:text-xl font-semibold">Daftar Barang & Jasa</h3>
                    <button id="addProductBtn" class="btn-primary w-full sm:w-auto py-2 px-4 rounded-full text-sm font-semibold">+ Tambah Barang</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm rounded-lg overflow-hidden">
                        <thead class="table-header">
                            <tr>
                                <th class="py-2 px-4 text-left font-medium">Foto</th>
                                <th class="py-2 px-4 text-left font-medium">Nama Barang</th>
                                <th class="py-2 px-4 text-left font-medium">Kode</th>
                                <th class="py-2 px-4 text-left font-medium">Harga Jual</th>
                                <th class="py-2 px-4 text-left font-medium">Stok</th>
                                <th class="py-2 px-4 text-left font-medium">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="productList" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </section>
        </main>
    
    <div id="productModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-semibold" id="formTitle">Tambah Barang</h3>
            <form id="productForm" class="space-y-4 mt-4">
                <input type="hidden" id="productId">
                <input type="text" id="itemName" placeholder="Nama Barang" required class="w-full rounded-md p-2">
                <div class="relative">
                    <input type="text" id="itemCode" placeholder="Kode (Bisa scan barcode)" class="w-full rounded-md p-2 pr-10">
                    <button type="button" onclick="startBarcodeScan()" class="absolute inset-y-0 right-0 flex items-center pr-3 focus:outline-none">
                        <svg class="h-5 w-5 text-gray-400 hover:text-gray-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M1.5 3.75a.75.75 0 0 1 .75-.75h1.5a.75.75 0 0 1 0 1.5H3v.75a.75.75 0 0 1-1.5 0v-.75Zm1.5 15H2.25a.75.75 0 0 1 0-1.5h.75v-.75a.75.75 0 0 1 1.5 0v1.5Zm18-1.5h.75a.75.75 0 0 1 0 1.5h-1.5v.75a.75.75 0 0 1-1.5 0v-1.5Zm.75-15h-1.5a.75.75 0 0 1 0-1.5H21v-.75a.75.75 0 0 1 1.5 0v1.5ZM6 6h1.5v12H6V6Zm3 0h1.5v12H9V6Zm3-1.5h1.5v15H12V4.5Zm3 1.5h1.5v12H15V6Z"/></svg>
                    </button>
                </div>
                <input type="number" id="itemSellPrice" placeholder="Harga Jual" required class="w-full rounded-md p-2">
                <input type="number" id="itemStock" placeholder="Stok" required class="w-full rounded-md p-2">
                <button type="submit" class="btn-success w-full py-2 px-4 rounded-md font-semibold">Simpan</button>
                <button type="button" class="btn-secondary w-full py-2 px-4 rounded-md mt-2 font-semibold" onclick="hideAddProductForm()">Batal</button>
            </form>
        </div>
    </div>

    <div id="barcodeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-10 mx-auto p-5 border w-11/12 md:w-96 shadow-lg rounded-md bg-white">
            <h3 class="text-xl font-semibold">Scan Barcode</h3>
            <div class="mt-4">
                <video id="barcode-scanner-video" playsinline></video>
                <p id="scanResult" class="mt-2 text-center font-medium text-gray-600">Arahkan kamera ke barcode...</p>
            </div>
            <button onclick="stopBarcodeScan()" class="btn-secondary w-full py-2 px-4 rounded-md mt-4">Tutup</button>
        </div>
    </div>

<script type="module">
    import * as ZBar from 'https://cdn.jsdelivr.net/npm/@undecaf/zbar-wasm@0.9.15/dist/index.js';

    // =======================================================
    //                 STATE & KONFIGURASI
    // =======================================================
    const CONFIG = {
        SCRIPT_URL: "https://script.google.com/macros/s/AKfycbyNVr58Xay5aYGHT8Eu2xbXW5jXW9zjx5hwLc4SJGeqL-hmnhvVNY0KU-2DeRoglOgB/exec"
    };
    let scanner = null; // Menyimpan instance scanner ZBar
    let videoStream = null; // Menyimpan stream video dari kamera

    // =======================================================
    //                FUNGSI-FUNGSI UTAMA
    // =======================================================
    const showMessage = (message, isError = false) => {
        const messageBox = document.createElement('div');
        messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white font-semibold ${isError ? 'bg-red-500' : 'bg-green-500'} z-50`;
        messageBox.textContent = message;
        document.body.appendChild(messageBox);
        setTimeout(() => { messageBox.remove(); }, 3000);
    };

    const fetchProducts = async () => {
        try {
            const response = await fetch(`${CONFIG.SCRIPT_URL}?action=read`);
            const result = await response.json();
            if (result.status === 'success') {
                renderProducts(result.data);
            } else {
                showMessage('Gagal memuat produk.', true);
            }
        } catch (error) {
            showMessage('Kesalahan jaringan saat memuat.', true);
        }
    };

    const renderProducts = (products) => {
        const productList = document.getElementById('productList');
        productList.innerHTML = '';
        if (!products || products.length === 0) {
            productList.innerHTML = '<tr><td colspan="6" class="text-center py-4">Tidak ada data barang.</td></tr>';
            return;
        }
        products.forEach(product => {
            const row = document.createElement('tr');
            row.className = 'hover:bg-gray-50';
            row.innerHTML = `
                <td class="py-2 px-4"><img src="${product.photo || 'https://placehold.co/40'}" alt="Foto" class="w-10 h-10 object-cover rounded"></td>
                <td class="py-2 px-4">${product.name}</td>
                <td class="py-2 px-4">${product.code || 'N/A'}</td>
                <td class="py-2 px-4">Rp${parseFloat(product.sellPrice || 0).toLocaleString('id-ID')}</td>
                <td class="py-2 px-4">${product.stock}</td>
                <td class="py-2 px-4 space-x-2">
                    <button class="text-blue-500" onclick="editProduct('${product.id}')">Edit</button>
                    <button class="text-red-500" onclick="deleteProduct('${product.id}')">Hapus</button>
                </td>
            `;
            productList.appendChild(row);
        });
    };

    // =======================================================
    //         FUNGSI SCANNER BARCODE DENGAN ZBAR
    // =======================================================
    window.startBarcodeScan = async () => {
        document.getElementById('barcodeModal').classList.remove('hidden');
        const videoElement = document.getElementById('barcode-scanner-video');
        const scanResultElement = document.getElementById('scanResult');

        try {
            scanResultElement.textContent = 'Meminta izin kamera...';
            // 1. Dapatkan stream video dari kamera
            videoStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment' } // Prioritaskan kamera belakang
            });
            
            videoElement.srcObject = videoStream;
            videoElement.play();
            
            scanResultElement.textContent = 'Mendeteksi barcode...';
            
            // 2. Inisialisasi ZBar Scanner
            scanner = await ZBarScanner.create();
            
            // 3. Mulai memindai dari stream video
            await scanner.scan(videoStream, (symbol, value) => {
                console.log("Barcode terdeteksi:", symbol, value);
                
                // Set nilai ke input field
                document.getElementById('itemCode').value = value;
                
                showMessage(`Barcode ditemukan: ${value}`);
                
                // Hentikan pemindaian setelah berhasil
                stopBarcodeScan();
            });

        } catch (err) {
            console.error("Error saat memulai scanner:", err);
            scanResultElement.textContent = `Error: ${err.message}`;
            showMessage('Gagal memulai kamera. Pastikan izin diberikan.', true);
            stopBarcodeScan(); // Pastikan untuk membersihkan jika gagal
        }
    };

    window.stopBarcodeScan = () => {
        // Hentikan proses scan dari ZBar
        if (scanner) {
            scanner.stop();
            scanner = null;
        }
        // Hentikan stream video dari kamera
        if (videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        document.getElementById('barcodeModal').classList.add('hidden');
    };

    // =======================================================
    //                 FUNGSI FORM PRODUK
    // =======================================================
    window.showAddProductForm = () => {
        document.getElementById('productForm').reset();
        document.getElementById('productId').value = '';
        document.getElementById('formTitle').textContent = 'Tambah Barang';
        document.getElementById('productModal').classList.remove('hidden');
    };
    
    window.hideAddProductForm = () => {
        document.getElementById('productModal').classList.add('hidden');
    };
    
    document.getElementById('productForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const productId = document.getElementById('productId').value;
        const productData = {
            name: document.getElementById('itemName').value,
            code: document.getElementById('itemCode').value,
            sellPrice: parseFloat(document.getElementById('itemSellPrice').value),
            stock: parseInt(document.getElementById('itemStock').value),
            // Tambahkan field lain jika ada di backend Anda
        };

        const action = productId ? 'update' : 'create';
        const payload = { ...productData, action, id: productId };

        try {
            const response = await fetch(CONFIG.SCRIPT_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const result = await response.json();
            if (result.status === 'success') {
                showMessage(`Produk berhasil di${productId ? 'perbarui' : 'tambahkan'}!`);
                fetchProducts();
                hideAddProductForm();
            } else {
                showMessage('Gagal menyimpan produk.', true);
            }
        } catch (error) {
            showMessage('Kesalahan jaringan saat menyimpan.', true);
        }
    });
    
    // Inisialisasi event listener dan ambil data awal
    document.getElementById('addProductBtn').addEventListener('click', showAddProductForm);
    fetchProducts();

</script>
</body>
</html>
