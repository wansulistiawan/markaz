<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Rider - Final</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        #map { height: 75vh; z-index: 10; background-color: #4a5568; }
        .map-locked { cursor: not-allowed !important; }
        .adding-waypoint { cursor: crosshair !important; }
        .hidden { display: none; }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; border-radius: 8px; }
        .user-popup { display: flex; align-items: center; gap: 10px; }
        .user-popup img { border-radius: 50%; width: 40px; height: 40px; }
        .user-popup button { background-color: #10B981; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        .leaflet-routing-container { background-color: rgba(45, 55, 72, 0.9); color: #e2e8f0; border: 1px solid #4A5568; border-radius: 8px; }
        .leaflet-routing-alt, .leaflet-routing-alt h2, .leaflet-routing-summary { background-color: #4a5568 !important; color: #e2e8f0 !important; }
        .leaflet-routing-instruction:hover { background-color: #718096 !important; }
        .leaflet-bar a, .leaflet-bar a:hover { background-color: #4a5568; color: #e2e8f0; border-bottom: 1px solid #2d3748; }

        #pin-settings-modal input:checked + label { outline: 3px solid #6EE7B7; transform: scale(1.1); }
        #navigation-controls { transition: transform 0.3s ease-in-out; transform: translateY(200%); }
        #navigation-controls.visible { transform: translateY(0); }

        .fab-container { position: absolute; bottom: 1rem; right: 1rem; z-index: 400; display: flex; flex-direction: column; gap: 0.75rem; }
        .fab { width: 56px; height: 56px; background-color: #4A5568; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: 1px solid #718096; }
        .fab:hover { background-color: #718096; }
        .fab.active { background-color: #10B981; border-color: #6EE7B7; }

        #suggestions-container { position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background-color: #2d3748; border: 1px solid #4A5568; border-radius: 0 0 0.5rem 0.5rem; z-index: 1000; }
        .suggestion-item { padding: 0.75rem; cursor: pointer; color: #e2e8f0; }
        .suggestion-item:hover { background-color: #4A5568; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 max-w-6xl">
        <header class="flex justify-between items-center mb-4 flex-wrap gap-4">
            <div><h1 class="text-2xl md:text-3xl font-bold text-emerald-400">Pelacak Rider Waktu Nyata</h1><p id="subtitle" class="text-gray-400">Klik peta atau cari untuk pratinjau rute.</p></div>
            <div id="auth-container" class="flex items-center gap-4">
                <button id="settings-btn" class="hidden bg-gray-600 hover:bg-gray-700 p-3 rounded-full" title="Ubah Warna Pin Anda"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path></svg></button>
                <div id="user-info" class="hidden items-center gap-3 text-right"><div><p id="user-name" class="font-semibold"></p><button id="logout-btn" class="text-sm text-red-400 hover:underline">Keluar</button></div><img id="user-pic" class="w-12 h-12 rounded-full border-2 border-emerald-400"></div>
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 488 512"><path d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-72.2 64.5C305.1 102.8 277.6 88 248 88c-86.5 0-155.2 67.8-155.2 151.3s68.7 151.3 155.2 151.3c92.8 0 132-61.1 135-95.2H248v-73.8h238.2c2.6 13.2 4.2 27.8 4.2 43.8z"></path></svg> Masuk</button>
            </div>
        </header>

        <div class="relative w-full max-w-lg mx-auto my-4">
             <form id="search-form" onsubmit="event.preventDefault();"><div class="relative"><input type="text" id="search-input" placeholder="Cari alamat atau nama tempat..." class="w-full bg-gray-700 text-white rounded-lg py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500" autocomplete="off"><button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button></div></form>
             <div id="suggestions-container" class="hidden"></div>
        </div>

        <main>
            <div id="map-container" class="rounded-2xl shadow-2xl overflow-hidden border-2 border-gray-700 relative">
                <div id="map"></div>
                <div id="navigation-controls" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[401] flex gap-2 sm:gap-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
                    <button id="set-destination-btn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-lg">Tetapkan Tujuan</button>
                    <button id="add-waypoint-btn" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg">Tambah Persinggahan</button>
                    <button id="start-nav-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">Mulai Navigasi</button>
                    <button id="stop-nav-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-5 rounded-lg">Hentikan Navigasi</button>
                    <button id="cancel-route-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg">Batal</button>
                </div>
                <div id="fab-group" class="fab-container hidden">
                    <button id="share-location-fab" class="fab" title="Bagikan Lokasi Anda"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg></button>
                    <button id="recenter-fab" class="fab" title="Pusatkan ke Lokasi Saya"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                </div>
            </div>
        </main>
        <footer><div id="status" class="mt-4 p-3 bg-gray-800 rounded-lg text-center">Memuat peta...</div></footer>
    </div>

    <div id="pin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-md"><h2 class="text-2xl font-bold mb-6 text-emerald-400">Ubah Warna Pin Anda</h2><div class="mb-6"><h3 class="font-semibold mb-3 text-gray-300">Pilih Warna</h3><div id="color-options" class="flex gap-3 flex-wrap justify-center"></div></div><div class="flex justify-end gap-4"><button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Batal</button><button id="save-settings-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Simpan</button></div></div></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA9fthcIZ_VQXMUL6lPd-165NIFNb09JOA", authDomain: "aplikasi-touring.firebaseapp.com", projectId: "aplikasi-touring", storageBucket: "aplikasi-touring.appspot.com", messagingSenderId: "310021643774", appId: "1:310021643774:web:4943db8f567e66aef174af", measurementId: "G-ZRCCNLC8WB" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, myMarker, userCoords = null, routingControl = null, destinationMarker = null;
        let isSharingPublicly = false;
        let publicRidersUnsubscribe = null;
        const publicMarkers = {};
        let currentUserSettings = { pinColor: '#3498db' };
        let currentRouteState = 'IDLE';
        let isAddingWaypoint = false;

        const DOM = {
            map: document.getElementById('map'), subtitle: document.getElementById('subtitle'), status: document.getElementById('status'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'), userName: document.getElementById('user-name'), userPic: document.getElementById('user-pic'),
            settingsBtn: document.getElementById('settings-btn'), modal: document.getElementById('pin-settings-modal'),
            searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'),
            suggestionsContainer: document.getElementById('suggestions-container'),
            navControls: document.getElementById('navigation-controls'),
            setDestinationBtn: document.getElementById('set-destination-btn'),
            addWaypointBtn: document.getElementById('add-waypoint-btn'),
            startNavBtn: document.getElementById('start-nav-btn'),
            stopNavBtn: document.getElementById('stop-nav-btn'),
            cancelRouteBtn: document.getElementById('cancel-route-btn'),
            fabGroup: document.getElementById('fab-group'),
            shareLocationFab: document.getElementById('share-location-fab'),
            recenterFab: document.getElementById('recenter-fab'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'), 
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            colorOptions: document.getElementById('color-options'),
        };
        
        function createProfilePinIcon(color, imageUrl) {
            const uniqueId = `clip-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const iconHtml = `
                <svg width="64" height="64" viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <clipPath id="${uniqueId}">
                            <circle cx="16" cy="11" r="9" />
                        </clipPath>
                    </defs>
                    <path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path>
                    <circle cx="16" cy="11" r="9" fill="#2d3748" stroke="${color}" stroke-width="1.5" />
                    <image href="${imageUrl}" x="7" y="2" height="18" width="18" clip-path="url(#${uniqueId})" />
                </svg>`;
            return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 64], iconAnchor: [32, 64], popupAnchor: [0, -64] });
        }
        
        function createFlagIcon(color) {
            const iconHtml = `<svg width="64" height="64" viewBox="0 0 32 32"><path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path><path fill="white" d="M14.23 6.02l.46 2.06h6.09l-.46-2.06H14.23zM13 3h9v2h-9V3zm1.69 5.02L13 18H5v-2h6.27l.45-2.02H5V12h6.72l.45-2.02H5V8.02h9.69z"></path></svg>`;
            return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 64], iconAnchor: [32, 64], popupAnchor: [0, -64] });
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function fetchSuggestions(query) {
            if (query.length < 3) {
                DOM.suggestionsContainer.innerHTML = '';
                DOM.suggestionsContainer.classList.add('hidden');
                return;
            }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const data = await res.json();
                displaySuggestions(data);
            } catch (error) {
                console.error('Gagal mengambil saran:', error);
            }
        }
        
        function displaySuggestions(suggestions) {
            DOM.suggestionsContainer.innerHTML = '';
            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = s.display_name;
                    item.onclick = () => {
                        DOM.searchInput.value = s.display_name;
                        DOM.suggestionsContainer.classList.add('hidden');
                        window.showRouteTo([s.lat, s.lon], s.display_name);
                    };
                    DOM.suggestionsContainer.appendChild(item);
                });
                DOM.suggestionsContainer.classList.remove('hidden');
            } else {
                DOM.suggestionsContainer.classList.add('hidden');
            }
        }

        function initMap() {
            if (map) return;
            map = L.map('map').setView([-2.5489, 118.0149], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
            map.on('click', (e) => {
                if (isAddingWaypoint) {
                    addWaypointToRoute(e.latlng);
                    return;
                }
                if (currentRouteState === 'IDLE' && auth.currentUser && userCoords) {
                    const dest = [e.latlng.lat, e.latlng.lng];
                    window.showRouteTo(dest, 'Titik Dipilih');
                }
            });
            DOM.status.textContent = "Peta dimuat. Silakan masuk untuk memulai.";
        }

        function startLocationWatch() {
            if (!navigator.geolocation) {
                DOM.status.textContent = 'Geolocation tidak didukung oleh browser ini.';
                return;
            }
            DOM.status.textContent = "Mencari lokasi Anda...";
            navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true });
        }
        
        function handleLocationError(error) {
            let message = 'Gagal mendapatkan lokasi. ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += "Anda menolak permintaan izin lokasi."; break;
                case error.POSITION_UNAVAILABLE:
                    message += "Informasi lokasi tidak tersedia."; break;
                case error.TIMEOUT:
                    message += "Permintaan lokasi timeout."; break;
                default:
                    message += "Terjadi kesalahan tidak dikenal."; break;
            }
            DOM.status.textContent = message + " Peta tetap dapat digunakan untuk pencarian.";
        }
        
        function setRouteState(newState) {
            currentRouteState = newState;
            updateNavControlsUI();
        }

        function updateNavControlsUI() {
            const isVisible = (currentRouteState !== 'IDLE');
            DOM.navControls.classList.toggle('visible', isVisible);
            
            [DOM.setDestinationBtn, DOM.addWaypointBtn, DOM.startNavBtn, DOM.stopNavBtn, DOM.cancelRouteBtn].forEach(btn => btn.classList.add('hidden'));

            if (currentRouteState === 'PREVIEW') {
                DOM.setDestinationBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                DOM.subtitle.textContent = 'Seret pin tujuan untuk mengubah rute.';
                DOM.map.classList.remove('map-locked', 'adding-waypoint');
            } else if (currentRouteState === 'SET' || currentRouteState === 'NAVIGATING') {
                DOM.addWaypointBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                if (currentRouteState === 'SET') {
                    DOM.startNavBtn.classList.remove('hidden');
                    DOM.status.textContent = 'Tujuan ditetapkan. Siap memulai atau tambah persinggahan.';
                } else { // NAVIGATING
                    DOM.stopNavBtn.classList.remove('hidden');
                    DOM.status.textContent = 'Mode navigasi aktif. Peta akan mengikuti Anda.';
                }
                DOM.subtitle.textContent = 'Rute telah ditetapkan.';
                DOM.map.classList.add('map-locked');
            } else { // IDLE
                DOM.status.textContent = userCoords ? `Akurasi: ${Math.round(userCoords.accuracy)}m` : 'Mencari lokasi...';
                DOM.subtitle.textContent = 'Klik peta atau cari untuk pratinjau rute.';
                DOM.map.classList.remove('map-locked', 'adding-waypoint');
            }
        }
        
        DOM.setDestinationBtn.addEventListener('click', () => {
            if (currentRouteState !== 'PREVIEW') return;
            destinationMarker.dragging.disable();
            setRouteState('SET');
        });

        DOM.addWaypointBtn.addEventListener('click', () => {
            isAddingWaypoint = true;
            DOM.map.classList.add('adding-waypoint');
            DOM.status.textContent = 'Klik di peta untuk menambah titik persinggahan.';
        });

        function addWaypointToRoute(latlng) {
            if (!routingControl) return;
            const waypoints = routingControl.getWaypoints();
            const newWaypoint = L.Routing.waypoint(latlng);
            waypoints.splice(waypoints.length - 1, 0, newWaypoint);
            routingControl.setWaypoints(waypoints);
            
            isAddingWaypoint = false;
            DOM.map.classList.remove('adding-waypoint');
            DOM.status.textContent = 'Persinggahan ditambahkan.';
        }

        DOM.startNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'SET') return;
            setRouteState('NAVIGATING');
            if(userCoords) map.setView(userCoords, 18, {animate: true});
        });

        DOM.stopNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'NAVIGATING') return;
            setRouteState('SET');
        });

        DOM.cancelRouteBtn.addEventListener('click', () => {
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            routingControl = null; destinationMarker = null; isAddingWaypoint = false;
            setRouteState('IDLE');
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                DOM.userInfo.classList.remove('hidden'); DOM.userInfo.classList.add('flex'); DOM.loginBtn.classList.add('hidden');
                DOM.userName.textContent = user.displayName; DOM.userPic.src = user.photoURL;
                DOM.settingsBtn.classList.remove('hidden');
                DOM.fabGroup.classList.remove('hidden');
                
                startLocationWatch(); 
                listenToPublicRiders();
            } else {
                DOM.userInfo.classList.add('hidden'); DOM.loginBtn.classList.remove('hidden');
                DOM.settingsBtn.classList.add('hidden'); DOM.fabGroup.classList.add('hidden');
                DOM.status.textContent = 'Silakan masuk untuk memulai.';
                if (myMarker) { map.removeLayer(myMarker); myMarker = null; }
                DOM.cancelRouteBtn.click();
                if (publicRidersUnsubscribe) publicRidersUnsubscribe(); 
                Object.values(publicMarkers).forEach(marker => map.removeLayer(marker));
            }
        });

        DOM.loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
        DOM.logoutBtn.addEventListener('click', async () => { if (auth.currentUser) await removeLocationFromFirestore(auth.currentUser.uid); signOut(auth); });
        
        function updateLocation(position) {
            userCoords = [position.coords.latitude, position.coords.longitude];
            userCoords.accuracy = position.coords.accuracy;
            if (currentRouteState === 'IDLE') DOM.status.textContent = `Akurasi: ${Math.round(userCoords.accuracy)}m`;
            
            if (!myMarker && auth.currentUser) {
                myMarker = L.marker(userCoords, { icon: createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL) }).addTo(map).bindPopup('<b>Ini Lokasi Anda!</b>');
                map.setView(userCoords, 16);
            } else if (myMarker) { myMarker.setLatLng(userCoords); }
            
            if (currentRouteState === 'NAVIGATING') { map.setView(userCoords, 18, {animate: true, pan: {duration: 1}}); }
            if (isSharingPublicly && auth.currentUser) updateLocationInFirestore(auth.currentUser);
        }

        DOM.recenterFab.addEventListener('click', () => {
            if (userCoords) { map.setView(userCoords, 16, {animate: true}); } 
            else { DOM.status.textContent = 'Lokasi Anda belum ditemukan.'; }
        });

        DOM.shareLocationFab.addEventListener('click', () => {
            isSharingPublicly = !isSharingPublicly;
            DOM.shareLocationFab.classList.toggle('active', isSharingPublicly);
            if (!auth.currentUser) return;
            if (isSharingPublicly) {
                if (userCoords) { updateLocationInFirestore(auth.currentUser); } 
                else { DOM.status.textContent = 'Tunggu lokasi ditemukan.'; isSharingPublicly = false; DOM.shareLocationFab.classList.remove('active'); }
            } else { removeLocationFromFirestore(auth.currentUser.uid); }
        });
        
        async function updateLocationInFirestore(user) {
            if (!userCoords) return;
            const statusText = isSharingPublicly ? 'Lokasi Anda sekarang publik.' : 'Lokasi Anda tidak lagi publik.';
            DOM.status.textContent = statusText;
            await setDoc(doc(db, 'public_riders', user.uid), {
                name: user.displayName, photoURL: user.photoURL, lat: userCoords[0], lng: userCoords[1],
                lastUpdate: new Date(), pinColor: currentUserSettings.pinColor
            }, { merge: true });
        }
        
        async function removeLocationFromFirestore(uid) { 
            await deleteDoc(doc(db, "public_riders", uid)); 
            DOM.status.textContent = 'Lokasi Anda tidak lagi publik.';
        }

        function listenToPublicRiders() {
            publicRidersUnsubscribe = onSnapshot(collection(db, 'public_riders'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const riderData = change.doc.data(); const riderId = change.doc.id;
                    if (riderId === auth.currentUser?.uid) {
                        currentUserSettings.pinColor = riderData.pinColor || '#3498db';
                        if (myMarker) myMarker.setIcon(createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL));
                        return;
                    }
                    if (change.type === "added" || change.type === "modified") {
                        if (publicMarkers[riderId]) map.removeLayer(publicMarkers[riderId]);
                        const riderCoords = [riderData.lat, riderData.lng];
                        const icon = createProfilePinIcon(riderData.pinColor || '#34495e', riderData.photoURL);
                        const popupContent = `<div class="user-popup"><img src="${riderData.photoURL}" alt="foto"><div><strong>${riderData.name}</strong><br><button onclick="window.showRouteTo([${riderCoords}], '${riderData.name.replace(/'/g, "\\'")}')">Rute ke Sini</button></div></div>`;
                        publicMarkers[riderId] = L.marker(riderCoords, { icon: icon }).addTo(map).bindPopup(popupContent);
                    } else if (change.type === "removed") { if (publicMarkers[riderId]) { map.removeLayer(publicMarkers[riderId]); delete publicMarkers[riderId]; } }
                });
            });
        }
        
        window.showRouteTo = (destinationCoords, destinationName = 'Tujuan') => {
            if (currentRouteState !== 'IDLE') { DOM.status.textContent = 'Batalkan rute saat ini untuk membuat rute baru.'; return; }
            if (!userCoords) { alert("Lokasi Anda belum ditemukan."); return; }
            
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);

            destinationMarker = L.marker(destinationCoords, { icon: createFlagIcon('#e74c3c'), draggable: true }).addTo(map).bindPopup(`<b>${destinationName}</b>`).openPopup();
            
            destinationMarker.on('dragend', function(event) {
                if (currentRouteState !== 'PREVIEW') return;
                const newCoords = event.target.getLatLng();
                window.showRouteTo([newCoords.lat, newCoords.lng], 'Tujuan Baru');
            });

            routingControl = L.Routing.control({
                waypoints: [ L.latLng(userCoords), L.latLng(destinationCoords) ],
                routeWhileDragging: false,
                lineOptions: { styles: [{color: '#6EE7B7', weight: 5}] },
                createMarker: () => null
            }).on('routesfound', function(e) {
                const summary = e.routes[0].summary;
                const totalDistance = (summary.totalDistance / 1000).toFixed(1);
                const totalTime = Math.round(summary.totalTime / 60);
                const hours = Math.floor(totalTime / 60);
                const minutes = totalTime % 60;
                let timeString = '';
                if(hours > 0) timeString += `${hours} jam `;
                if(minutes > 0) timeString += `${minutes} menit`;
                
                DOM.status.textContent = `Estimasi Rute: ${timeString} (${totalDistance} km)`;
            }).addTo(map);

            setRouteState('PREVIEW');
        }

        DOM.searchInput.addEventListener('input', debounce(e => fetchSuggestions(e.target.value), 300));
        document.addEventListener('click', (e) => {
            if (!DOM.searchForm.contains(e.target)) {
                DOM.suggestionsContainer.classList.add('hidden');
            }
        });

        function setupModal() {
            DOM.colorOptions.innerHTML = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#ffffff'].map(c => `<div><input type="radio" name="color" value="${c}" id="c-${c}" class="sr-only"><label for="c-${c}" class="block w-8 h-8 rounded-full cursor-pointer border-2 border-gray-500" style="background-color:${c};"></label></div>`).join('');
        }
        
        DOM.settingsBtn.addEventListener('click', () => {
            document.querySelector(`input[name="color"][value="${currentUserSettings.pinColor}"]`).checked = true;
            DOM.modal.classList.remove('hidden');
        });

        DOM.saveSettingsBtn.addEventListener('click', async () => {
            currentUserSettings.pinColor = document.querySelector('input[name="color"]:checked').value;
            if (auth.currentUser) await updateLocationInFirestore(auth.currentUser);
            DOM.modal.classList.add('hidden');
        });

        DOM.cancelSettingsBtn.addEventListener('click', () => DOM.modal.classList.add('hidden'));
        
        document.addEventListener('DOMContentLoaded', initMap);
        setupModal();

    </script>
</body>
</html>

