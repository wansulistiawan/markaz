<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Rider - Turing Kelompok</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100dvh; width: 100vw; z-index: 10; background-color: #4a5568; }
        .map-locked { cursor: not-allowed !important; }
        .adding-waypoint, .creating-alert, .adding-checkpoint { cursor: crosshair !important; }
        .hidden { display: none; }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; border-radius: 8px; }
        .user-popup { display: flex; align-items: center; gap: 10px; }
        .user-popup img { border-radius: 50%; width: 40px; height: 40px; }
        .user-popup button, .alert-popup button { background-color: #10B981; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .alert-popup-content button { background-color: #4A5568; color: white; padding: 8px 12px; border-radius: 6px; margin: 4px; border: 1px solid #718096; }
        .alert-popup-content button:hover { background-color: #718096; }
        .alert-marker-icon { font-size: 2.5rem; text-shadow: 0 0 5px black; }

        .leaflet-routing-container { background-color: rgba(45, 55, 72, 0.9); color: #e2e8f0; border: 1px solid #4A5568; border-radius: 8px; }
        .leaflet-routing-alt, .leaflet-routing-alt h2, .leaflet-routing-summary { background-color: #4a5568 !important; color: #e2e8f0 !important; }
        .leaflet-routing-instruction:hover { background-color: #718096 !important; }
        .leaflet-bar a, .leaflet-bar a:hover { background-color: #4a5568; color: #e2e8f0; border-bottom: 1px solid #2d3748; }

        .modal-input:checked + label { outline: 3px solid #6EE7B7; transform: scale(1.1); }
        #navigation-controls { transition: transform 0.3s ease-in-out; transform: translateY(200%); }
        #navigation-controls.visible { transform: translateY(0); }

        .fab { width: 52px; height: 52px; background-color: #4A5568; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: 1px solid #718096; }
        .fab:hover { background-color: #718096; }
        .fab.active { background-color: #10B981; border-color: #6EE7B7; }

        #suggestions-container { position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background-color: #2d3748; border: 1px solid #4A5568; border-radius: 0.5rem; z-index: 1000; }
        .suggestion-item { padding: 0.75rem; cursor: pointer; color: #e2e8f0; }
        .suggestion-item:hover { background-color: #4A5568; }

        .role-select { background-color: #4A5568; border: 1px solid #718096; color: white; border-radius: 6px; padding: 4px 8px; }

        .checkpoint-marker-icon { background-color: #f59e0b; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black; text-align: center; font-weight: bold; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }

        #group-info-bar { transition: opacity 0.3s ease-in-out; }
		
		.leaflet-routing-container {
    /* Ukuran baru: Jauh lebih kecil */
    max-height: 35vh; /* Hanya 35% tinggi layar */
    width: 320px;     /* Lebar tetap agar konsisten */
    max-width: 85vw;  /* Maksimal 85% lebar layar di ponsel sempit */

    /* Posisi: Selalu di atas dan tidak mengganggu tombol lain */
    position: absolute;
    top: 80px;      /* Jarak dari atas layar */
    left: 1rem;     /* Jarak dari kiri layar (16px) */
    right: auto;    /* Abaikan posisi kanan */
    z-index: 800;   /* Z-index sangat tinggi agar selalu di atas */
    
    /* Tampilan & Fungsionalitas (tetap sama) */
    overflow-y: auto;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    background-color: rgba(45, 55, 72, 0.9);
    border-radius: 8px;
}
    /* Mengatur kontainer di dalamnya agar ikut bisa di-scroll */
    .leaflet-routing-alternatives-container {
        max-height: none;
    }
		
    </style>
</head>
<body class="bg-gray-900 text-white antialiased overflow-hidden">

    <div id="audio-container"></div>

    <div id="map-container" class="w-screen h-dvh relative">
        <div id="map"></div>
		
		<div id="ptt-notification" class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 z-[1200] p-3 bg-indigo-600 text-white rounded-lg shadow-lg cursor-pointer hover:bg-indigo-700 transition-all">
    <p id="ptt-notification-text" class="text-sm font-semibold">Pesan suara dari Wawan</p>
    <p class="text-xs">Ketuk untuk memutar</p>
</div>
		
		
        <!-- Floating UI Elements -->
        <div id="fab-top-left" class="absolute top-4 left-4 z-[400] flex flex-col gap-3">
    <button id="search-fab" class="fab bg-amber-500 hover:bg-amber-600" title="Cari Rute">
    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
</button>
    <button id="gmaps-fab" class="fab bg-blue-500 hover:bg-blue-600" title="Buka dari Link Google Maps">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
    </button>
</div>

        <div id="group-info-bar" class="absolute top-4 left-1/2 -translate-x-1/2 z-[400] bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg hidden">
            <h2 class="text-base sm:text-lg font-bold text-amber-400" id="group-info-name">Nama Grup</h2>
            <p class="text-xs sm:text-sm text-gray-300 text-center" id="group-info-count">0 Anggota</p>
        </div>
		
		<div id="nav-info-panel" class="hidden absolute top-4 left-1/2 -translate-x-1/2 z-[401] bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg text-center w-64">
            <h3 id="nav-info-destination" class="text-base font-bold text-emerald-400 truncate">Nama Tujuan</h3>
            <p class="text-sm text-gray-200">
                <span id="nav-info-distance">-- km</span> - <span id="nav-info-time">-- min</span>
            </p>
        </div>
		
        <div id="fab-top-right" class="absolute top-4 right-4 z-[400] hidden">
             <div class="relative">
                <img id="profile-fab" class="w-12 h-12 rounded-full border-2 border-emerald-400 cursor-pointer shadow-lg" src="https://placehold.co/100x100/2d3748/e2e8f0?text=:)">
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-lg shadow-xl py-1">
                    <a href="#" id="settings-menu-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Ubah Warna Pin</a>
                    <a href="#" id="logout-menu-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Keluar</a>
                </div>
            </div>
        </div>
        
        <div id="fab-bottom-left" class="absolute bottom-20 sm:bottom-4 left-4 z-[400] hidden flex flex-col-reverse items-center gap-3">
    <button id="group-fab" class="fab" title="Manajemen Grup">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" />
</svg>
    </button>
    
    <div id="nav-menu-container" class="relative flex flex-col items-center gap-3 hidden">
        <div id="nav-submenu" class="flex flex-col items-start gap-2 hidden p-2 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-xl">
    <button id="add-checkpoint-btn" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-indigo-500 hover:bg-indigo-600 text-white font-semibold">
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0zM15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
        <span class="text-sm">Checkpoint</span>
    </button>
    <button id="add-waypoint-btn" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-teal-500 hover:bg-teal-600 text-white font-semibold">
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
        <span class="text-sm">Singgah</span>
    </button>
    <button id="stop-nav-btn" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-600 text-black font-semibold">
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path d="M12 8v4l3 3" /></svg>
        <span class="text-sm">Hentikan</span>
    </button>
    <button id="cancel-route-btn" class="w-full flex items-center gap-3 px-3 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold">
        <svg class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        <span class="text-sm">Batal</span>
    </button>
</div>
        <button id="nav-menu-fab" class="fab" title="Opsi Navigasi">
            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
        </button>
    </div>
</div>

        <div id="fab-bottom-right" class="absolute bottom-20 sm:bottom-4 right-4 z-[400] fab-container hidden flex flex-col gap-3">
    <button id="reload-fab" class="fab sm:hidden" title="Muat Ulang Halaman">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" />
</svg>
</button>
    
    <button id="share-location-fab" class="fab" title="Bagikan Lokasi Anda">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
    </button>
    <button id="recenter-fab" class="fab" title="Pusatkan ke Lokasi Saya">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
    </button>
</div>
        
        <div id="navigation-controls" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[401] flex flex-wrap justify-center gap-2 sm:gap-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
    <button id="set-destination-btn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold text-sm sm:text-base py-2 px-3 sm:px-5 rounded-lg">Tetapkan Tujuan</button>
    <button id="start-nav-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold text-sm sm:text-base py-2 px-3 sm:px-5 rounded-lg">Mulai Navigasi</button>
    <button id="cancel-main-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold text-sm sm:text-base py-2 px-3 sm:px-5 rounded-lg">Batal</button>
</div>
        
        <div id="status-bar" class="absolute bottom-0 w-full z-[400] p-4 pointer-events-none">
            <div id="status" class="max-w-xl mx-auto p-3 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-lg text-center pointer-events-auto">Memuat peta...</div>
        </div>

        <div id="login-container" class="w-full h-full flex items-center justify-center absolute top-0 left-0 z-[500]">
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-3 text-lg">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 488 512"><path d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-72.2 64.5C305.1 102.8 277.6 88 248 88c-86.5 0-155.2 67.8-155.2 151.3s68.7 151.3 155.2 151.3c92.8 0 132-61.1 135-95.2H248v-73.8h238.2c2.6 13.2 4.2 27.8 4.2 43.8z"></path></svg> 
                Masuk dengan Google
            </button>
        </div>
		
		<div id="ptt-container" class="hidden absolute right-4 top-1/2 -translate-y-1/2 z-[1300]">
        <button id="ptt-btn" class="w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center shadow-lg transition-all duration-200 ease-out active:scale-90">
            <svg id="ptt-icon-mic" class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/></svg>
            <svg id="ptt-icon-stop" class="w-8 h-8 text-white hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10h6" /></svg>
        </button>
		<div id="ptt-container" class="hidden absolute right-4 top-1/2 -translate-y-1/2 z-[1400] flex flex-col items-center gap-3">
    <button id="join-voice-btn" class="px-3 py-2 bg-green-600 text-white text-xs font-bold rounded-full shadow-lg">Gabung Suara</button>
    
    <button id="ptt-btn" class="w-16 h-16 ...">
        </button>
</div>
    </div>
		
    </div>

    <!-- Modals -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-[1000] p-4 pt-8 sm:pt-16">
    <div class="relative w-full max-w-lg">
        <form id="search-form" onsubmit="event.preventDefault();">
            <div class="relative">
                <input type="text" id="search-input" placeholder="Cari alamat atau nama tempat..." class="w-full bg-gray-700 text-white rounded-lg py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500" autocomplete="off">
                <button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-gray-400">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </button>
            </div>
        </form>
        <div id="suggestions-container" class="mt-1"></div>

        <button id="close-search-btn" class="absolute -top-1 -right-1 w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-white hover:bg-red-500 transition-colors" title="Tutup Pencarian">
           <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
</div>

    <div id="pin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-md"><h2 class="text-2xl font-bold mb-6 text-emerald-400">Ubah Warna Pin Anda</h2><div class="mb-6"><h3 class="font-semibold mb-3 text-gray-300">Pilih Warna</h3><div id="color-options" class="flex gap-3 flex-wrap justify-center"></div></div><div class="flex justify-end gap-4"><button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Batal</button><button id="save-settings-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Simpan</button></div></div></div>
    
    <div id="group-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-4 sm:p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-emerald-400">Manajemen Grup Turing</h2>
            
            <div id="group-view" class="hidden">
                <div class="mb-4">
                    <h3 class="font-semibold text-lg">Grup Saat Ini: <span id="group-name" class="text-amber-400"></span></h3>
                    <p class="text-sm text-gray-400">ID Grup: <span id="group-id" class="font-mono"></span></p>
                </div>
                <div class="mb-4 border-t border-gray-700 pt-4 overflow-y-auto" style="max-height: 40vh;">
                    <h4 class="font-semibold mb-2">Anggota Grup (<span id="group-member-count">0</span>):</h4>
                    <div id="group-members-list" class="space-y-2"></div>
                </div>
                <button id="leave-group-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">Keluar Grup</button>
            </div>

            <div id="no-group-view">
                <div class="mb-4 border-b border-gray-700 pb-4">
                    <h3 class="font-semibold text-lg mb-2">Buat Grup Baru</h3>
                    <div class="flex gap-2"><input type="text" id="create-group-name" placeholder="Nama Grup Turing" class="flex-grow bg-gray-700 text-white rounded-lg py-2 px-3"><button id="create-group-btn" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Buat</button></div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-2">Gabung Grup</h3>
                    <div class="flex gap-2"><input type="text" id="join-group-id" placeholder="Masukkan ID Grup (4 Angka)" class="flex-grow bg-gray-700 text-white rounded-lg py-2 px-3"><button id="join-group-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Gabung</button></div>
                </div>
            </div>

            <button id="close-group-modal-btn" class="mt-6 text-gray-400 hover:text-white self-center">Tutup</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, writeBatch, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
	import { getDatabase, ref, push, onChildAdded, off, serverTimestamp as rtdbServerTimestamp, query as rtdbQuery, orderByChild, startAt } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-database.js";
	
    const firebaseConfig = { apiKey: "AIzaSyA9fthcIZ_VQXMUL6lPd-165NIFNb09JOA", authDomain: "aplikasi-touring.firebaseapp.com", databaseURL: "https://aplikasi-touring-default-rtdb.asia-southeast1.firebasedatabase.app", projectId: "aplikasi-touring", storageBucket: "aplikasi-touring.appspot.com", messagingSenderId: "310021643774", appId: "1:310021643774:web:4943db8f567e66aef174af", measurementId: "G-ZRCCNLC8WB" };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
	const rtdb = getDatabase(app); 

    let map, myMarker, userCoords = null, routingControl = null, destinationMarker = null;
    let isSharingPublicly = false;
    let publicRidersUnsubscribe = null;
    const publicMarkers = {};
    const alertMarkers = {};
    const checkpointMarkers = {};
    let currentUserSettings = { pinColor: '#3498db' };
    let currentRouteState = 'IDLE';
    let isAddingWaypoint = false;
    let isAddingCheckpoint = false;
    let currentGroupId = null;
    let currentGroupData = null;
    let groupUnsubscribe = null;
    let userUnsubscribe = null;
    let groupAlertsUnsubscribe = null;
    let groupCheckpointsUnsubscribe = null;
	let voiceMessageListenerRef = null;
	let allUsersData = {};
	let audioUnlocked = false;

    const DOM = {
    mapContainer: document.getElementById('map-container'),
    status: document.getElementById('status'),
    loginBtn: document.getElementById('login-btn'),
    loginContainer: document.getElementById('login-container'),
    logoutMenuBtn: document.getElementById('logout-menu-btn'),
    profileFab: document.getElementById('profile-fab'),
    profileFabContainer: document.getElementById('fab-top-right'),
    profileDropdown: document.getElementById('profile-dropdown'),
    settingsMenuBtn: document.getElementById('settings-menu-btn'), modal: document.getElementById('pin-settings-modal'),
    groupFab: document.getElementById('group-fab'), groupModal: document.getElementById('group-modal'),
    groupView: document.getElementById('group-view'), noGroupView: document.getElementById('no-group-view'),
    groupInfoBar: document.getElementById('group-info-bar'),
    groupInfoName: document.getElementById('group-info-name'),
    groupInfoCount: document.getElementById('group-info-count'),
    groupName: document.getElementById('group-name'), groupId: document.getElementById('group-id'),
    groupMemberCount: document.getElementById('group-member-count'),
    groupMembersList: document.getElementById('group-members-list'),
    createGroupName: document.getElementById('create-group-name'), createGroupBtn: document.getElementById('create-group-btn'),
    joinGroupId: document.getElementById('join-group-id'), joinGroupBtn: document.getElementById('join-group-btn'),
    leaveGroupBtn: document.getElementById('leave-group-btn'), closeGroupModalBtn: document.getElementById('close-group-modal-btn'),
    searchFab: document.getElementById('search-fab'), searchModal: document.getElementById('search-modal'),
    searchInput: document.getElementById('search-input'), 
    searchForm: document.getElementById('search-form'),
    suggestionsContainer: document.getElementById('suggestions-container'),
    navControls: document.getElementById('navigation-controls'),
    setDestinationBtn: document.getElementById('set-destination-btn'),
    addCheckpointBtn: document.getElementById('add-checkpoint-btn'),
    addWaypointBtn: document.getElementById('add-waypoint-btn'),
    startNavBtn: document.getElementById('start-nav-btn'),
    stopNavBtn: document.getElementById('stop-nav-btn'),
    cancelRouteBtn: document.getElementById('cancel-route-btn'),
    fabBottomLeft: document.getElementById('fab-bottom-left'),
    fabBottomRight: document.getElementById('fab-bottom-right'),
    shareLocationFab: document.getElementById('share-location-fab'),
    gmapsFab: document.getElementById('gmaps-fab'),
    recenterFab: document.getElementById('recenter-fab'),
	reloadFab: document.getElementById('reload-fab'),
    cancelSettingsBtn: document.getElementById('cancel-settings-btn'), 
    saveSettingsBtn: document.getElementById('save-settings-btn'),
    colorOptions: document.getElementById('color-options'),
    
    // BARIS-BARIS PTT YANG PERLU DITAMBAHKAN
    pttContainer: document.getElementById('ptt-container'),
    pttBtn: document.getElementById('ptt-btn'),
    pttIconMic: document.getElementById('ptt-icon-mic'),
    pttIconStop: document.getElementById('ptt-icon-stop'),
	closeSearchBtn: document.getElementById('close-search-btn'),
	navMenuContainer: document.getElementById('nav-menu-container'),
    navMenuFab: document.getElementById('nav-menu-fab'),
    navSubmenu: document.getElementById('nav-submenu'),
	cancelMainBtn: document.getElementById('cancel-main-btn'),
	navInfoPanel: document.getElementById('nav-info-panel'),
    navInfoDestination: document.getElementById('nav-info-destination'),
    navInfoDistance: document.getElementById('nav-info-distance'),
    navInfoTime: document.getElementById('nav-info-time'),
	pttNotification: document.getElementById('ptt-notification'),
    pttNotificationText: document.getElementById('ptt-notification-text'),
	joinVoiceBtn: document.getElementById('join-voice-btn'),
};

    const roles = {
        amir: 'ðŸ‘‘', penunjuk_jalan: 'ðŸ§­', guard: 'ðŸ›¡ï¸', sweeper: 'ðŸ§¹', logistik: 'ðŸ› ï¸', member: 'ðŸ‘¤'
    };

    const alertTypes = {
        razia: { icon: 'ðŸ‘®', text: 'Ada Razia Polisi' }, kecelakaan: { icon: 'ðŸ’¥', text: 'Ada Kecelakaan' },
        macet: { icon: 'ðŸš—', text: 'Lalu Lintas Macet' }, pawai: { icon: 'ðŸŽ‰', text: 'Ada Pawai/Keramaian' },
        bencana: { icon: 'ðŸŒ‹', text: 'Ada Bencana Alam' }, jalan_rusak: { icon: 'ðŸš§', text: 'Ada Jalan Rusak' }
    };
	
	const blobToBase64 = (blob) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(blob);
        reader.onloadend = () => {
            resolve(reader.result);
        };
        reader.onerror = (error) => {
            reject(error);
        };
    });
};

// Fungsi utilitas untuk mengubah Base64 kembali menjadi Blob (file audio)
const base64ToBlob = (base64) => {
    const byteCharacters = atob(base64.split(',')[1]);
    const byteNumbers = new Array(byteCharacters.length);
    for (let i = 0; i < byteCharacters.length; i++) {
        byteNumbers[i] = byteCharacters.charCodeAt(i);
    }
    const byteArray = new Uint8Array(byteNumbers);
    return new Blob([byteArray], { type: 'audio/webm' });
};

// Fungsi utama untuk "mendengarkan" pesan suara baru
const listenForVoiceMessages = (groupId) => {
    // Reset status saat berganti grup
    audioUnlocked = false;
    DOM.joinVoiceBtn.classList.remove('hidden');

    const joinTime = Date.now();
    const voiceMessagesRef = ref(rtdb, `groups/${groupId}/voice_messages`);
    const messagesQuery = rtdbQuery(voiceMessagesRef, orderByChild('timestamp'), startAt(joinTime));
    let notificationTimeout;

    onChildAdded(messagesQuery, (snapshot) => {
        const payload = snapshot.val();
        if (!payload || payload.senderId === auth.currentUser.uid) return;

        // Jika audio sudah "dibuka kuncinya", langsung putar
        if (audioUnlocked) {
            const audioBlob = base64ToBlob(payload.audioData);
            const audioUrl = URL.createObjectURL(audioBlob);
            const audio = new Audio(audioUrl);
            audio.play();
        } else { // Jika belum, tampilkan notifikasi seperti biasa
            DOM.pttNotificationText.textContent = `Pesan suara dari ${payload.senderName}`;
            DOM.pttNotification.classList.remove('hidden');

            const playSound = () => {
                const audioBlob = base64ToBlob(payload.audioData);
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                DOM.pttNotification.classList.add('hidden');
                DOM.pttNotification.removeEventListener('click', playSound);
            };

            DOM.pttNotification.addEventListener('click', playSound);
            clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                DOM.pttNotification.classList.add('hidden');
                DOM.pttNotification.removeEventListener('click', playSound);
            }, 7000);
        }
    });
    console.log(`Mendengarkan pesan suara baru di grup ${groupId}...`);
};
    
    function createProfilePinIcon(color, imageUrl, role) {
        const uniqueId = `pattern-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        const roleEmoji = roles[role] || '';
        const iconHtml = `
            <svg width="64" height="70" viewBox="0 0 32 38" xmlns="http://www.w3.org/2000/svg" style="overflow: visible;">
                <defs>
                    <pattern id="${uniqueId}" patternContentUnits="objectBoundingBox" width="1" height="1">
                        <image href="${imageUrl}" x="0" y="0" height="1" width="1" preserveAspectRatio="xMidYMid slice"/>
                    </pattern>
                </defs>
                <g transform="translate(0, 6)">
                    <path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path>
                    <circle cx="16" cy="11" r="9" fill="url(#${uniqueId})" stroke="${color}" stroke-width="1.5" />
                </g>
                <text x="16" y="8" font-size="14" text-anchor="middle" stroke="black" stroke-width="0.5px" paint-order="stroke" fill="white">${roleEmoji}</text>
            </svg>`;
        return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 70], iconAnchor: [32, 70], popupAnchor: [0, -70] });
    }
    
    function createFlagIcon(color) {
        const iconHtml = `<svg width="64" height="64" viewBox="0 0 32 32"><path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path><path fill="white" d="M14.23 6.02l.46 2.06h6.09l-.46-2.06H14.23zM13 3h9v2h-9V3zm1.69 5.02L13 18H5v-2h6.27l.45-2.02H5V12h6.72l.45-2.02H5V8.02h9.69z"></path></svg>`;
        return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 64], iconAnchor: [32, 64], popupAnchor: [0, -64] });
    }

    function createCheckpointIcon(number) {
        return L.divIcon({
            className: 'checkpoint-marker-icon',
            html: `<span>${number}</span>`,
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    async function fetchSuggestions(query) {
    if (query.length < 3) {
        DOM.suggestionsContainer.innerHTML = '';
        DOM.suggestionsContainer.classList.add('hidden');
        return;
    }
    
    // Kunci API Anda sudah dimasukkan di sini
    const apiKey = '7ce7547ff4c941f9a0aef61c5e384890'; 
    const apiUrl = `https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(query)}&key=${apiKey}&limit=5&countrycode=id`;

    try {
        const res = await fetch(apiUrl);
        const data = await res.json();
        // Sekarang kita kirim data.results ke fungsi display
        displaySuggestions(data.results);
    } catch (error) {
        console.error('Gagal mengambil saran dari OpenCage:', error);
        DOM.status.textContent = "Gagal mengambil saran lokasi. Periksa koneksi Anda.";
    }
}
    
    function displaySuggestions(suggestions) {
    DOM.suggestionsContainer.innerHTML = '';
    if (suggestions && suggestions.length > 0) {
        suggestions.forEach(s => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            // OpenCage menggunakan 'formatted' untuk nama lengkap
            item.textContent = s.formatted;
            
            item.onclick = () => {
                DOM.searchInput.value = s.formatted;
                DOM.suggestionsContainer.classList.add('hidden');
                DOM.searchModal.classList.add('hidden');
                
                // OpenCage menyimpan koordinat di dalam 'geometry'
                const coords = [s.geometry.lat, s.geometry.lng];
                window.showRouteTo(coords, s.formatted);
            };
            DOM.suggestionsContainer.appendChild(item);
        });
        DOM.suggestionsContainer.classList.remove('hidden');
    } else {
        DOM.suggestionsContainer.classList.add('hidden');
    }
}

    function initMap() {
        if (map) return;
        map = L.map('map', { zoomControl: false }).setView([-2.5489, 118.0149], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
        L.control.zoom({ position: 'bottomright' }).addTo(map);
        map.on('click', (e) => {
            if (isAddingWaypoint) { addWaypointToRoute(e.latlng); return; }
            if (isAddingCheckpoint) { showCheckpointPrompt(e.latlng); return; }
            const userRole = currentGroupData?.members?.[auth.currentUser?.uid]?.role;
            if (currentRouteState === 'NAVIGATING' && currentGroupId && ['amir', 'penunjuk_jalan', 'guard', 'sweeper', 'logistik'].includes(userRole)) {
                showUIAlertSelection(e.latlng);
                return;
            }
            if (currentRouteState === 'IDLE' && auth.currentUser && userCoords) {
        const dest = [e.latlng.lat, e.latlng.lng];
        // Selalu gunakan nama default saat pertama kali membuat rute
        window.showRouteTo(dest, 'Titik Dipilih');
    }
        });
        DOM.status.textContent = "Peta dimuat. Silakan masuk untuk memulai.";
    }

    function startLocationWatch() {
        if (!navigator.geolocation) {
            DOM.status.textContent = 'Geolocation tidak didukung oleh browser ini.';
            return;
        }
        DOM.status.textContent = "Mencari lokasi Anda...";
        navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true });
    }
    
    function handleLocationError(error) {
        let message = 'Gagal mendapatkan lokasi. ';
        switch(error.code) {
            case error.PERMISSION_DENIED: message += "Anda menolak permintaan izin lokasi."; break;
            case error.POSITION_UNAVAILABLE: message += "Informasi lokasi tidak tersedia."; break;
            case error.TIMEOUT: message += "Permintaan lokasi timeout."; break;
            default: message += "Terjadi kesalahan tidak dikenal."; break;
        }
        DOM.status.textContent = message + " Peta tetap dapat digunakan untuk pencarian.";
    }
    
    function setRouteState(newState) {
        currentRouteState = newState;
        updateNavControlsUI();
    }

    function updateNavControlsUI() {
    DOM.navControls.classList.remove('visible');
    DOM.navMenuContainer.classList.add('hidden');
    DOM.navSubmenu.classList.add('hidden');
    [DOM.setDestinationBtn, DOM.startNavBtn, DOM.cancelMainBtn].forEach(btn => btn.classList.add('hidden'));
    DOM.navInfoPanel.classList.add('hidden'); // Sembunyikan panel info di awal

    const userRole = currentGroupData?.members?.[auth.currentUser?.uid]?.role;
    const isOfficer = ['amir', 'penunjuk_jalan', 'guard', 'sweeper', 'logistik'].includes(userRole);

    if (currentRouteState === 'PREVIEW') {
        DOM.navControls.classList.add('visible');
        DOM.setDestinationBtn.classList.remove('hidden');
        DOM.cancelMainBtn.classList.remove('hidden');
        DOM.status.textContent = 'Geser pin untuk mengubah tujuan, atau tetapkan rute.';
        DOM.mapContainer.classList.remove('map-locked');

    } else if (currentRouteState === 'SET') {
        DOM.navControls.classList.add('visible');
        DOM.startNavBtn.classList.remove('hidden');
        DOM.cancelMainBtn.classList.remove('hidden');
        DOM.status.textContent = 'Tujuan ditetapkan. Siap memulai navigasi.';
        DOM.mapContainer.classList.add('map-locked');

    } else if (currentRouteState === 'NAVIGATING') {
        DOM.navControls.classList.remove('visible');
        DOM.navMenuContainer.classList.remove('hidden');
        DOM.navInfoPanel.classList.remove('hidden'); // TAMPILKAN PANEL INFO DI SINI

        [DOM.addWaypointBtn, DOM.stopNavBtn, DOM.cancelRouteBtn].forEach(btn => btn.classList.remove('hidden'));
        if (isOfficer) {
            DOM.addCheckpointBtn.classList.remove('hidden');
        } else {
            DOM.addCheckpointBtn.classList.add('hidden');
        }
        
        DOM.status.textContent = 'Mode navigasi aktif.';
        DOM.mapContainer.classList.add('map-locked');
        
    } else { // IDLE
        DOM.status.textContent = userCoords ? `Akurasi: ${Math.round(userCoords.accuracy)}m` : 'Mencari lokasi...';
        DOM.mapContainer.classList.remove('map-locked');
    }
}
    
	
	
    function addWaypointToRoute(latlng) {
        if (!routingControl) return;
        const waypoints = routingControl.getWaypoints();
        const newWaypoint = L.Routing.waypoint(latlng);
        waypoints.splice(waypoints.length - 1, 0, newWaypoint);
        routingControl.setWaypoints(waypoints);
        
        isAddingWaypoint = false;
        DOM.mapContainer.classList.remove('adding-waypoint');
        DOM.status.textContent = 'Persinggahan ditambahkan.';
    }

    function showCheckpointPrompt(latlng) {
        const description = prompt("Masukkan keterangan untuk checkpoint ini (misal: 'Titik Kumpul 1', 'Makan Siang', dll):");
        if (description) {
            createCheckpoint(latlng, description);
        }
        isAddingCheckpoint = false;
        DOM.mapContainer.classList.remove('adding-checkpoint');
        DOM.status.textContent = 'Mode navigasi aktif.';
    }
	
	// Fungsi untuk Amir mematikan/menyalakan visibilitas anggota
async function toggleMemberVisibility(uid) {
    if (!allUsersData[uid]) return;
    const currentStatus = allUsersData[uid].isSharing;
    const userRef = doc(db, 'users', uid);
    await updateDoc(userRef, { isSharing: !currentStatus });
}

// Fungsi untuk Amir memindahkan jabatannya
async function promoteToAmir(newAmirId) {
    const oldAmirId = auth.currentUser.uid;
    if (newAmirId === oldAmirId) return;

    const groupRef = doc(db, 'groups', currentGroupId);
    const batch = writeBatch(db);

    // 1. Turunkan jabatan Amir lama menjadi member
    batch.update(groupRef, { [`members.${oldAmirId}.role`]: 'member' });
    // 2. Naikkan jabatan anggota baru menjadi Amir
    batch.update(groupRef, { [`members.${newAmirId}.role`]: 'amir' });
    // 3. Perbarui penanda Amir utama di grup
    batch.update(groupRef, { amir: newAmirId });

    await batch.commit();
    alert('Jabatan Amir telah dipindahkan.');
}
	

    async function createCheckpoint(latlng, description) {
        const user = auth.currentUser;
        if (!user || !currentGroupId) return;
        const checkpointRef = doc(collection(db, 'groups', currentGroupId, 'checkpoints'));
        await setDoc(checkpointRef, {
            description: description,
            lat: latlng.lat,
            lng: latlng.lng,
            creatorId: user.uid,
            creatorName: user.displayName,
            createdAt: serverTimestamp()
        });
        DOM.status.textContent = 'Checkpoint ditambahkan!';
    }

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            DOM.loginContainer.classList.add('hidden');
            DOM.profileFabContainer.classList.remove('hidden');
            DOM.profileFab.src = user.photoURL;
            DOM.fabBottomLeft.classList.remove('hidden');
            DOM.fabBottomRight.classList.remove('hidden');
            
            const userRef = doc(db, 'users', user.uid);
            await setDoc(userRef, {
                name: user.displayName,
                photoURL: user.photoURL,
            }, { merge: true });
            
            startLocationWatch();  
            listenToUserDoc(user.uid);
            listenToPublicRiders();
        } else {
            DOM.loginContainer.classList.remove('hidden');
            DOM.profileFabContainer.classList.add('hidden');
            DOM.fabBottomLeft.classList.add('hidden');
            DOM.fabBottomRight.classList.add('hidden');
            DOM.status.textContent = 'Silakan masuk untuk memulai.';
            if (myMarker) { map.removeLayer(myMarker); myMarker = null; }
            if (routingControl) DOM.cancelRouteBtn.click();
            if (publicRidersUnsubscribe) publicRidersUnsubscribe();
            if (userUnsubscribe) userUnsubscribe();
            if (groupUnsubscribe) groupUnsubscribe();
            if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
            if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
            Object.values(publicMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(alertMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
            currentGroupId = null; currentGroupData = null;
            DOM.groupInfoBar.classList.add('hidden');
        }
    });

    function updateLocation(position) {
        userCoords = [position.coords.latitude, position.coords.longitude];
        userCoords.accuracy = position.coords.accuracy;
        if (currentRouteState === 'IDLE') DOM.status.textContent = `Akurasi: ${Math.round(userCoords.accuracy)}m`;
        
        if (!myMarker && auth.currentUser) {
            const myRole = currentGroupData?.members?.[auth.currentUser.uid]?.role;
            myMarker = L.marker(userCoords, { icon: createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL, myRole) }).addTo(map).bindPopup('<b>Ini Lokasi Anda!</b>');
            if (currentRouteState === 'IDLE') map.setView(userCoords, 16);
        } else if (myMarker) { myMarker.setLatLng(userCoords); }
        
         if (currentRouteState === 'NAVIGATING') { 
            map.setView(userCoords, 18, {animate: true, pan: {duration: 1}}); 
            
            // BLOK BARU UNTUK RUTE LIVE
            if (routingControl) {
                const waypoints = routingControl.getWaypoints();
                // Perbarui titik awal rute dengan lokasi Anda saat ini
                waypoints[0].latLng = L.latLng(userCoords);
                routingControl.setWaypoints(waypoints);
            }
        }
        if (isSharingPublicly && auth.currentUser) updateLocationInFirestore(auth.currentUser);
    }
    
    async function updateLocationInFirestore(user) {
        if (!userCoords) return;
        
        const userRef = doc(db, 'users', user.uid);
        await updateDoc(userRef, {
            lat: userCoords[0],
            lng: userCoords[1],
            lastUpdate: new Date(),
        });
    }
    
    async function removeLocationFromFirestore(uid) { 
        const userRef = doc(db, 'users', uid);
        await updateDoc(userRef, { isSharing: false });
    }

    function listenToUserDoc(uid) {
        if (userUnsubscribe) userUnsubscribe();
        userUnsubscribe = onSnapshot(doc(db, "users", uid), (doc) => {
            if (!doc.exists()) return;
            const userData = doc.data();
            if (userData?.groupId && userData.groupId !== currentGroupId) {
                joinGroup(userData.groupId, true);
            } else if (!userData?.groupId && currentGroupId) {
                leaveGroup(true);
            }
            currentUserSettings.pinColor = userData?.pinColor || '#3498db';

            isSharingPublicly = userData?.isSharing || false;
            if(DOM.shareLocationFab) {
                DOM.shareLocationFab.classList.toggle('active', isSharingPublicly);
            }

            if(myMarker && auth.currentUser){
                const myRole = currentGroupData?.members?.[auth.currentUser.uid]?.role;
                myMarker.setIcon(createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL, myRole));
            }
        });
    }

    function listenToPublicRiders() {
    if (publicRidersUnsubscribe) publicRidersUnsubscribe();
    
    const q = query(collection(db, 'users'));
    publicRidersUnsubscribe = onSnapshot(q, (snapshot) => {
        const currentVisibleMarkers = new Set();
        
        allUsersData = {};
        snapshot.forEach(doc => {
            allUsersData[doc.id] = doc.data();
        });

        Object.entries(allUsersData).forEach(([riderId, riderData]) => {
            const isMySelf = riderId === auth.currentUser?.uid;
            const isInMyGroup = riderData.isSharing && currentGroupId && riderData.groupId === currentGroupId;
            const isPublicAndUngrouped = riderData.isSharing && !riderData.groupId;
            const shouldShow = isInMyGroup || isPublicAndUngrouped;

            if (shouldShow && !isMySelf && riderData.lat && riderData.lng) {
                currentVisibleMarkers.add(riderId);
                const riderCoords = [riderData.lat, riderData.lng];
                const role = currentGroupData?.members?.[riderId]?.role;
                const icon = createProfilePinIcon(riderData.pinColor || '#34495e', riderData.photoURL, role);
                
                if (publicMarkers[riderId]) {
                    publicMarkers[riderId].setLatLng(riderCoords);
                    publicMarkers[riderId].setIcon(icon);
                } else {
                    const popupContent = `<div class="user-popup"><img src="${riderData.photoURL}" alt="foto"><div><strong>${riderData.name}</strong><br><button onclick="window.showRouteTo([${riderCoords}], '${riderData.name.replace(/'/g, "\\'")}')">Rute ke Sini</button></div></div>`;
                    publicMarkers[riderId] = L.marker(riderCoords, { icon: icon }).addTo(map).bindPopup(popupContent);
                }
            }
        });

        Object.keys(publicMarkers).forEach(markerId => {
            if (!currentVisibleMarkers.has(markerId)) {
                if (publicMarkers[markerId]) {
                    map.removeLayer(publicMarkers[markerId]);
                    delete publicMarkers[markerId];
                }
            }
        });

        // BARIS PENTING INI DIKEMBALIKAN DI POSISI YANG BENAR
        if (currentGroupId) {
            updateGroupMembersUI(currentGroupData);
        }
    });
}
    
    window.showRouteTo = (destinationCoords, destinationName = 'Tujuan') => {
    if (currentRouteState !== 'IDLE') { 
        DOM.status.textContent = 'Batalkan rute saat ini untuk membuat rute baru.'; 
        return; 
    }
    if (!userCoords) { 
        alert("Lokasi Anda belum ditemukan."); 
        return; 
    }
    
    // Simpan nama tujuan saat ini di variabel global
    window.currentDestinationName = destinationName;

    if (routingControl) map.removeControl(routingControl);
    if (destinationMarker) map.removeLayer(destinationMarker);

    destinationMarker = L.marker(destinationCoords, { icon: createFlagIcon('#e74c3c'), draggable: true })
        .addTo(map)
        .bindPopup(`<b>${destinationName}</b>`)
        .openPopup();
    
    // INI BAGIAN YANG DIPERBAIKI SECARA PERMANEN
    destinationMarker.on('dragend', function(event) {
        // Fungsi ini sekarang hanya bertugas memperbarui waypoints, tidak lebih.
        if (routingControl && currentRouteState === 'PREVIEW') {
            const newCoords = event.target.getLatLng();
            routingControl.setWaypoints([
                L.latLng(userCoords), // Titik awal tetap
                newCoords // Titik tujuan baru
            ]);
        }
    });

    routingControl = L.Routing.control({
        waypoints: [ L.latLng(userCoords), L.latLng(destinationCoords) ],
        routeWhileDragging: false, // Penting agar tidak konflik dengan logika drag kita
        lineOptions: { styles: [{color: '#6EE7B7', weight: 5}] },
        createMarker: () => null
    }).addTo(map);

    const updateRouteSummary = (summary) => {
        const totalDistance = (summary.totalDistance / 1000).toFixed(1);
        const totalTime = Math.round(summary.totalTime / 60);
        const hours = Math.floor(totalTime / 60);
        const minutes = totalTime % 60;
        let timeString = '';
        if(hours > 0) timeString += `${hours} jam `;
        if(minutes > 0) timeString += `${minutes} menit`;
        
        DOM.navInfoDestination.textContent = window.currentDestinationName; // Ambil dari variabel global
        DOM.navInfoDistance.textContent = `${totalDistance} km`;
        DOM.navInfoTime.textContent = timeString;
    };

    routingControl.on('routesfound', function(e) {
        updateRouteSummary(e.routes[0].summary);
    });

    setRouteState('PREVIEW');
}

    function setupModal() {
        DOM.colorOptions.innerHTML = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#ffffff'].map(c => `<div><input type="radio" name="color" value="${c}" id="c-${c}" class="sr-only modal-input"><label for="c-${c}" class="block w-8 h-8 rounded-full cursor-pointer border-2 border-gray-500" style="background-color:${c};"></label></div>`).join('');
    }
    
	async function handleGoogleMapsLink() {
    const url = prompt("Silakan paste link Google Maps di sini:");
    if (!url) return; // Batal jika pengguna tidak memasukkan apa-apa

    // Fungsi internal untuk mengekstrak koordinat dari URL yang SUDAH PASTI PANJANG
    const extractCoords = (finalUrl) => {
        const regex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
        const match = finalUrl.match(regex);

        if (match && match[1] && match[2]) {
            const lat = parseFloat(match[1]);
            const lng = parseFloat(match[2]);
            window.showRouteTo([lat, lng], 'Lokasi dari Google Maps');
            DOM.status.textContent = "Rute berhasil dibuat dari link.";
        } else {
            // Notifikasi error ini sekarang hanya muncul jika link panjangnya pun tidak valid
            alert("Link tidak valid atau tidak mengandung koordinat setelah diurai.");
            DOM.status.textContent = "Gagal memproses link.";
        }
    };

    // --- LOGIKA BARU YANG LEBIH CERDAS ---
    // 1. Coba cari koordinat di URL yang ditempelkan
    const directMatch = url.match(/@(-?\d+\.\d+),(-?\d+\.\d+)/);

    if (directMatch) {
        // 2. JIKA KETEMU: Berarti ini link panjang, langsung proses.
        console.log("Link panjang terdeteksi, memproses langsung...");
        extractCoords(url);
    } else {
        // 3. JIKA TIDAK KETEMU: Anggap ini link pendek, kirim ke API unshorten.me
        console.log("Link pendek terdeteksi, mencoba mengurai...");
        DOM.status.textContent = 'Mengurai link pendek, mohon tunggu...';
        try {
            const response = await fetch(`https://unshorten.me/json/${url}`);
            if (!response.ok) {
                throw new Error('Gagal menghubungi layanan pengurai link.');
            }
            const data = await response.json();
            
            if (data.success && data.resolved_url) {
                // Setelah dapat link panjangnya, baru kita proses
                extractCoords(data.resolved_url);
            } else {
                throw new Error(data.error || 'Gagal mengurai link pendek.');
            }
        } catch (error) {
            console.error(error);
            alert(`Terjadi masalah saat mengurai link: ${error.message}`);
            DOM.status.textContent = "Gagal memproses link.";
        }
    }
}
	
    async function joinGroup(groupId, silent = false) {
    const user = auth.currentUser;
    if (!user) return;
    
    const groupRef = doc(db, "groups", groupId);
    const groupSnap = await getDoc(groupRef);

    if (!groupSnap.exists()) {
        if (!silent) alert("Grup tidak ditemukan!");
        return;
    }
    
    const groupData = groupSnap.data();
    const userRef = doc(db, "users", user.uid);
    
    // PERUBAHAN DIMULAI DI SINI
    const batch = writeBatch(db);

    // 1. Paksa isSharing menjadi true di dokumen pengguna
    batch.update(userRef, { groupId: groupId, isSharing: true });
    
    // 2. Tambahkan pengguna ke grup jika belum ada
    if (!groupData.members || !groupData.members[user.uid]) {
        const newMember = { name: user.displayName, photoURL: user.photoURL, role: 'member' };
        batch.update(groupRef, { [`members.${user.uid}`]: newMember });
    }
    
    // Jalankan kedua operasi sekaligus
    await batch.commit();
    // AKHIR PERUBAHAN
    
    currentGroupId = groupId;
    if (!silent) DOM.groupModal.classList.add('hidden');

    if (groupUnsubscribe) groupUnsubscribe();
    groupUnsubscribe = onSnapshot(groupRef, (doc) => {
        currentGroupData = doc.data();
        updateGroupMembersUI(currentGroupData);
        if (myMarker && auth.currentUser) {
            const myRole = currentGroupData?.members?.[auth.currentUser.uid]?.role;
            myMarker.setIcon(createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL, myRole));
        }
    });
    listenToGroupAlerts(groupId);
    listenToCheckpoints(groupId);
    listenForVoiceMessages(groupId);
}

    async function leaveGroup(silent = false) {
        const user = auth.currentUser;
        if (!user || !currentGroupId) return;
		
		if (isLocked) {
        unlockTalk();
    }

        const batch = writeBatch(db);
        const userRef = doc(db, 'users', user.uid);
        batch.update(userRef, { groupId: null, isSharing: false });

        const groupRef = doc(db, 'groups', currentGroupId);
        const members = { ...currentGroupData.members };
        delete members[user.uid];
        
        if (Object.keys(members).length === 0) {
            batch.delete(groupRef);
        } else {
            // Jika yang keluar adalah Amir, cari penggantinya
        if(currentGroupData.amir === user.uid) {
            let newAmirId = null;
            // Urutan prioritas jabatan
            const priorityRoles = ['penunjuk_jalan', 'guard', 'sweeper', 'logistik'];
            
            for (const role of priorityRoles) {
                // Cari anggota dengan peran prioritas
                const candidateId = Object.keys(members).find(id => members[id].role === role);
                if (candidateId) {
                    newAmirId = candidateId;
                    break; // Berhenti jika sudah menemukan
                }
            }

            // Jika tidak ada yang punya peran khusus, ambil anggota pertama
            if (!newAmirId) {
                newAmirId = Object.keys(members)[0];
            }
            
            // Pindahkan jabatan Amir
            members[newAmirId].role = 'amir';
            batch.update(groupRef, { members: members, amir: newAmirId });

        } else {
            // Jika yang keluar bukan Amir, cukup update daftar anggota
            batch.update(groupRef, { members: members });
        }
    }

        await batch.commit();

        if (!silent) alert("Anda telah keluar dari grup.");
        currentGroupId = null;
        currentGroupData = null;
        if (groupUnsubscribe) groupUnsubscribe();
        if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
        if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
		 if (voiceMessageListenerRef) {
        off(voiceMessageListenerRef); // 'off' adalah perintah untuk berhenti mendengarkan
        voiceMessageListenerRef = null;
        console.log("Berhenti mendengarkan pesan suara.");
    }
        updateGroupMembersUI(null);
        Object.values(alertMarkers).forEach(marker => map.removeLayer(marker));
        Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
    }
    
    function updateGroupMembersUI(groupData) {
    if (groupData && groupData.members) {
        DOM.groupInfoBar.classList.remove('hidden');
        DOM.groupView.classList.remove('hidden');
        DOM.noGroupView.classList.add('hidden');
        DOM.groupName.textContent = groupData.name;
        DOM.groupInfoName.textContent = groupData.name;
        DOM.groupId.textContent = currentGroupId;
        const memberCount = Object.keys(groupData.members).length;
        DOM.groupMemberCount.textContent = memberCount;
        DOM.groupInfoCount.textContent = `${memberCount} Anggota`;
        DOM.groupMembersList.innerHTML = '';
        DOM.pttContainer.classList.remove('hidden');
        
        DOM.shareLocationFab.disabled = true;
        DOM.shareLocationFab.classList.add('opacity-50', 'cursor-not-allowed');
        DOM.shareLocationFab.classList.remove('active');
        
        const user = auth.currentUser;
        const amIAmir = user && user.uid === groupData.amir;

        Object.entries(groupData.members).forEach(([uid, member]) => {
            const memberEl = document.createElement('div');
            memberEl.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg';
            
            const memberIsSharing = allUsersData[uid]?.isSharing ?? false;
            let controlsHtml = '';

            if (amIAmir && uid !== user.uid) {
                // === BAGIAN YANG DIPERBAIKI: Menggabungkan semua kontrol untuk Amir ===

                // 1. Buat Dropdown Jabatan (seperti sebelumnya)
                let roleDropdownHtml = `<select onchange="window.updateMemberRole('${uid}', this.value)" class="role-select">`;
                roleDropdownHtml += Object.keys(roles)
                    .filter(r => r !== 'amir') // Amir tidak bisa di-set dari dropdown
                    .map(r => `<option value="${r}" ${member.role === r ? 'selected' : ''}>${r.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>`)
                    .join('');
                roleDropdownHtml += `</select>`;

                // 2. Buat Tombol Visibilitas (Ikon Mata)
                const eyeIcon = memberIsSharing 
                    ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`
                    : `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" /></svg>`;
                const visibilityButtonHtml = `<button onclick="window.toggleMemberVisibility('${uid}')" class="p-1 hover:bg-gray-600 rounded-full">${eyeIcon}</button>`;
                
                // 3. Buat Tombol "Jadikan Amir"
                const promoteButtonHtml = `<button onclick="window.promoteToAmir('${uid}')" class="text-xs bg-emerald-600 hover:bg-emerald-700 rounded px-2 py-1">Jadikan Amir</button>`;
                
                // Gabungkan semuanya menjadi satu
                controlsHtml = visibilityButtonHtml + roleDropdownHtml + promoteButtonHtml;

            } else { // Jika BUKAN Amir atau ini adalah DIRI SAYA SENDIRI
                controlsHtml = `<span class="px-2 py-1 text-sm rounded-full bg-gray-600">${roles[member.role]} ${member.role.replace(/_/g, ' ')}</span>`;
            }

            memberEl.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${member.photoURL}" class="w-8 h-8 rounded-full">
                    <span>${member.name} ${uid === user.uid ? '(Anda)' : ''}</span>
                </div>
                <div class="flex items-center gap-2">${controlsHtml}</div>
            `;
            DOM.groupMembersList.appendChild(memberEl);
        });
    } else {
        DOM.groupInfoBar.classList.add('hidden');
        DOM.groupView.classList.add('hidden');
        DOM.noGroupView.classList.remove('hidden');
        DOM.pttContainer.classList.add('hidden');
        DOM.shareLocationFab.disabled = false;
        DOM.shareLocationFab.classList.remove('opacity-50', 'cursor-not-allowed');
    }
}

window.toggleMemberVisibility = toggleMemberVisibility;
window.promoteToAmir = promoteToAmir;
window.updateMemberRole = updateMemberRole;

    async function updateMemberRole(uid, newRole) {
        if (!currentGroupId) return;
        const groupRef = doc(db, 'groups', currentGroupId);
        await updateDoc(groupRef, { [`members.${uid}.role`]: newRole });
    }

    function showUIAlertSelection(latlng) {
        let content = '<div class="alert-popup-content text-center"><strong>Tandai Kejadian:</strong><br>';
        Object.entries(alertTypes).forEach(([key, value]) => {
            content += `<button onclick="window.createAlert('${key}', ${latlng.lat}, ${latlng.lng})">${value.icon} ${value.text}</button>`;
        });
        content += '</div>';
        L.popup().setLatLng(latlng).setContent(content).openOn(map);
    }

    window.createAlert = async (type, lat, lng) => {
        map.closePopup();
        const user = auth.currentUser;
        if (!user || !currentGroupId) return;
        const alertRef = doc(collection(db, 'groups', currentGroupId, 'alerts'));
        await setDoc(alertRef, {
            type: type, lat: lat, lng: lng,
            creatorId: user.uid, creatorName: user.displayName, createdAt: new Date()
        });
    }

    function listenToGroupAlerts(groupId) {
        if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
        const alertsRef = collection(db, 'groups', groupId, 'alerts');
        groupAlertsUnsubscribe = onSnapshot(alertsRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const alertId = change.doc.id;
                const alertData = change.doc.data();
                if (change.type === 'removed') {
                    if (alertMarkers[alertId]) { map.removeLayer(alertMarkers[alertId]); delete alertMarkers[alertId]; } return;
                }
                if (alertMarkers[alertId]) map.removeLayer(alertMarkers[alertId]);
                const alertIcon = L.divIcon({ className: 'alert-marker-icon', html: alertTypes[alertData.type].icon, iconSize: [40, 40], iconAnchor: [20, 20] });
                let popupContent = `<strong>${alertTypes[alertData.type].text}</strong><br><small>Oleh: ${alertData.creatorName}</small>`;
                if (auth.currentUser?.uid === currentGroupData?.amir) {
                    popupContent += `<br><button class="mt-2" onclick="window.deleteAlert('${alertId}')">Hapus</button>`;
                }
                alertMarkers[alertId] = L.marker([alertData.lat, alertData.lng], { icon: alertIcon }).addTo(map).bindPopup(popupContent);
            });
        });
    }

    window.deleteAlert = async (alertId) => {
        if (!currentGroupId) return;
        await deleteDoc(doc(db, 'groups', currentGroupId, 'alerts', alertId));
        map.closePopup();
    }

    function listenToCheckpoints(groupId) {
        if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
        const checkpointsRef = query(collection(db, 'groups', groupId, 'checkpoints'), orderBy('createdAt'));
        groupCheckpointsUnsubscribe = onSnapshot(checkpointsRef, (snapshot) => {
            Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
            let count = 1;
            snapshot.forEach((doc) => {
                const cpId = doc.id;
                const cpData = doc.data();
                const icon = createCheckpointIcon(count++);
                let popupContent = `<strong>Checkpoint: ${cpData.description}</strong><br><small>Oleh: ${cpData.creatorName}</small>`;
                if (auth.currentUser?.uid === currentGroupData?.amir) {
                    popupContent += `<br><button class="mt-2" onclick="window.deleteCheckpoint('${cpId}')">Hapus</button>`;
                }
                checkpointMarkers[cpId] = L.marker([cpData.lat, cpData.lng], { icon }).addTo(map).bindPopup(popupContent);
            });
        });
    }
    
    window.deleteCheckpoint = async (checkpointId) => {
        if (!currentGroupId) return;
        await deleteDoc(doc(db, 'groups', currentGroupId, 'checkpoints', checkpointId));
        map.closePopup();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        setupModal();
		
		// ==================================================
//          KODE LOGIKA PUSH-TO-TALK (VERSI BARU)
// ==================================================
let isTalking = false;
let isLocked = false;
let initialX = 0;
let isDragging = false;

// Variabel untuk menyimpan rekaman
let mediaRecorder;
let audioChunks = [];

// === FUNGSI LEVEL BAWAH (Perekaman) ===
const startRecording = async () => {
    // (Fungsi ini sudah benar, tidak perlu diubah)
    audioChunks = [];
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.addEventListener("dataavailable", event => {
            audioChunks.push(event.data);
        });
        mediaRecorder.addEventListener("stop", async () => {
            const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            if (audioBlob.size < 1000) return;
            try {
                const base64Audio = await blobToBase64(audioBlob);
                const payload = {
                    senderId: auth.currentUser.uid,
                    senderName: auth.currentUser.displayName,
                    audioData: base64Audio,
                    timestamp: Date.now()
                };
                const voiceMessagesRef = ref(rtdb, `groups/${currentGroupId}/voice_messages`);
                await push(voiceMessagesRef, payload);
            } catch (error) {
                console.error("Gagal mengirim pesan suara:", error);
            }
        });
        mediaRecorder.start();
        console.log("Merekam suara...");
    } catch (err) {
        console.error("Error mengakses mikrofon:", err);
        isTalking = false;
        DOM.pttBtn.classList.remove('bg-red-600', 'scale-110');
    }
};

const stopRecording = () => {
    // (Fungsi ini sudah benar, tidak perlu diubah)
    if (mediaRecorder && mediaRecorder.state === "recording") {
        mediaRecorder.stop();
        console.log("Perekaman dihentikan.");
    }
};

// === FUNGSI LEVEL ATAS (Aksi Pengguna) ===
const startTalking = () => {
    if (isTalking) return;
    isTalking = true;
    DOM.pttBtn.classList.add('bg-red-600', 'scale-110');
    startRecording();
};

const stopTalking = () => {
    if (!isTalking || isLocked) return;
    isTalking = false;
    DOM.pttBtn.classList.remove('bg-red-600', 'scale-110');
    stopRecording();
};

const lockTalk = () => {
    if (isLocked) return; // Jangan kunci jika sudah terkunci
    isLocked = true;
    DOM.pttIconMic.classList.add('hidden');
    DOM.pttIconStop.classList.remove('hidden');
    // Jika belum bicara, mulai bicara. Jika sudah, biarkan saja.
    if (!isTalking) {
        startTalking();
    }
};

const unlockTalk = () => {
    if (!isLocked) return; // Jangan buka kunci jika tidak terkunci
    isLocked = false;
    isTalking = false; // Paksa status berhenti
    DOM.pttIconMic.classList.remove('hidden');
    DOM.pttIconStop.classList.add('hidden');
    DOM.pttBtn.classList.remove('bg-red-600', 'scale-110');
    stopRecording();
};

// === EVENT LISTENERS (YANG DIPERBAIKI) ===
const handlePressStart = (e) => {
    // Jika PTT sedang terkunci, satu-satunya aksi yang diizinkan adalah 'click' untuk membuka,
    // jadi kita abaikan 'touchstart' atau 'mousedown' untuk memulai rekaman baru.
    if (isLocked) {
        return;
    }
    
    e.preventDefault();
    isDragging = false;
    initialX = e.touches ? e.touches[0].clientX : e.clientX;
    DOM.pttBtn.style.transition = 'none';

    // Langsung mulai bicara saat tombol disentuh/ditekan
    startTalking();

    const handlePressMove = (moveEvent) => {
        const currentX = moveEvent.touches ? moveEvent.touches[0].clientX : moveEvent.clientX;
        const deltaX = initialX - currentX;
        
        if (deltaX > 0) {
            const dragDistance = Math.max(-60, -deltaX);
            DOM.pttBtn.style.transform = `translateX(${dragDistance}px)`;
        }

        if (deltaX > 40 && !isLocked) {
            isDragging = true;
            lockTalk();
            cleanupListeners(); // Langsung bersihkan listener setelah lock
        }
    };

    const handlePressEnd = () => {
        // Jika jari dilepas dan tidak ada gestur drag, itu artinya mode "Tekan & Tahan" selesai
        if (!isDragging) {
            stopTalking();
        }
        cleanupListeners();
    };

    const cleanupListeners = () => {
        DOM.pttBtn.style.transition = 'transform 0.2s ease-out';
        DOM.pttBtn.style.transform = 'translateX(0px)';
        window.removeEventListener('mousemove', handlePressMove);
        window.removeEventListener('touchmove', handlePressMove);
        window.removeEventListener('mouseup', handlePressEnd);
        window.removeEventListener('touchend', handlePressEnd);
    };

    window.addEventListener('mousemove', handlePressMove);
    window.addEventListener('touchmove', handlePressMove);
    window.addEventListener('mouseup', handlePressEnd);
    window.addEventListener('touchend', handlePressEnd);
};

DOM.joinVoiceBtn.addEventListener('click', () => {
    // Trik: Memutar suara kosong yang sangat singkat untuk "membuka kunci"
    const silentSound = new Audio("data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=");
    silentSound.play();

    audioUnlocked = true;
    DOM.joinVoiceBtn.classList.add('hidden'); // Sembunyikan tombol setelah diklik
    DOM.status.textContent = "Suara grup telah diaktifkan.";
});

// --- Menghubungkan Aksi ke Fungsi ---
DOM.pttBtn.addEventListener('mousedown', handlePressStart);
DOM.pttBtn.addEventListener('touchstart', handlePressStart, { passive: false });

DOM.pttBtn.addEventListener('click', () => {
    // Event 'click' sekarang hanya punya satu tugas: membuka kunci jika terkunci.
    if (isLocked) {
        unlockTalk();
    }
});

DOM.pttBtn.addEventListener('contextmenu', e => e.preventDefault());
		
		DOM.closeSearchBtn.addEventListener('click', () => {
        DOM.searchModal.classList.add('hidden');
    });
		
		DOM.navMenuFab.addEventListener('click', () => {
        DOM.navSubmenu.classList.toggle('hidden');
    });
        DOM.shareLocationFab.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;
            const newSharingStatus = !isSharingPublicly;
            const userRef = doc(db, 'users', user.uid);
            await updateDoc(userRef, { isSharing: newSharingStatus });
            DOM.status.textContent = newSharingStatus ? 'Berbagi lokasi diaktifkan.' : 'Berbagi lokasi dihentikan.';
        });
        
        DOM.searchForm.addEventListener('submit', () => {
            const firstSuggestion = DOM.suggestionsContainer.querySelector('.suggestion-item');
            if (firstSuggestion) {
                firstSuggestion.click();
            }
        });
        DOM.gmapsFab.addEventListener('click', handleGoogleMapsLink);
		
		DOM.reloadFab.addEventListener('click', () => {
        // Tampilkan notifikasi sebelum reload
        DOM.status.textContent = "Memuat ulang halaman...";
        // Beri jeda sedikit agar notifikasi terlihat, lalu reload
        setTimeout(() => {
            window.location.reload();
        }, 300);
    });
		
        DOM.loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
        DOM.logoutMenuBtn.addEventListener('click', async () => { 
            if (auth.currentUser) await removeLocationFromFirestore(auth.currentUser.uid); 
            signOut(auth); 
        });

        DOM.recenterFab.addEventListener('click', () => {
            if (userCoords) { 
                map.setView(userCoords, 16, { animate: true }); 
            } else { 
                DOM.status.textContent = 'Lokasi Anda belum ditemukan.'; 
            }
        });
        
        DOM.searchInput.addEventListener('input', debounce(e => fetchSuggestions(e.target.value), 300));
        
        document.addEventListener('click', (e) => {
            if (DOM.searchModal && !DOM.searchModal.contains(e.target) && e.target !== DOM.searchFab && !DOM.searchFab.contains(e.target)) {
                DOM.searchModal.classList.add('hidden');
            }
            if (DOM.profileDropdown && !DOM.profileDropdown.parentElement.contains(e.target)) {
                DOM.profileDropdown.classList.add('hidden');
            }
        });
        
        DOM.searchFab.addEventListener('click', () => DOM.searchModal.classList.toggle('hidden'));
        DOM.profileFab.addEventListener('click', () => DOM.profileDropdown.classList.toggle('hidden'));

        DOM.settingsMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            const colorInput = document.querySelector(`input[name="color"][value="${currentUserSettings.pinColor}"]`);
            if (colorInput) colorInput.checked = true;
            DOM.modal.classList.remove('hidden');
            DOM.profileDropdown.classList.add('hidden');
        });

        DOM.saveSettingsBtn.addEventListener('click', async () => {
            const checkedColor = document.querySelector('input[name="color"]:checked');
            if (checkedColor) {
                currentUserSettings.pinColor = checkedColor.value;
                if (auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { pinColor: currentUserSettings.pinColor });
            }
            DOM.modal.classList.add('hidden');
        });

        DOM.cancelSettingsBtn.addEventListener('click', () => DOM.modal.classList.add('hidden'));

        DOM.groupFab.addEventListener('click', () => DOM.groupModal.classList.remove('hidden'));
        DOM.closeGroupModalBtn.addEventListener('click', () => DOM.groupModal.classList.add('hidden'));

        DOM.createGroupBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            const groupName = DOM.createGroupName.value.trim();
            if (!user || !groupName) return;

            DOM.createGroupBtn.disabled = true;
            DOM.createGroupBtn.textContent = "Membuat...";

            let newGroupId = null;
            let groupExists = true;
            while(groupExists) {
                newGroupId = Math.floor(1000 + Math.random() * 9000).toString();
                const tempGroupRef = doc(db, 'groups', newGroupId);
                const docSnap = await getDoc(tempGroupRef);
                if (!docSnap.exists()) {
                    groupExists = false;
                }
            }
            
            const groupRef = doc(db, 'groups', newGroupId);
            const newGroup = {
                name: groupName, amir: user.uid, createdAt: new Date(),
                members: {
                    [user.uid]: { name: user.displayName, photoURL: user.photoURL, role: 'amir' }
                }
            };
            await setDoc(groupRef, newGroup);
            await updateDoc(doc(db, "users", user.uid), { groupId: groupRef.id });

            DOM.createGroupName.value = '';
            DOM.createGroupBtn.disabled = false;
            DOM.createGroupBtn.textContent = "Buat";
        });

        DOM.joinGroupBtn.addEventListener('click', async () => {
            const groupId = DOM.joinGroupId.value.trim();
            if (!groupId) return;
            joinGroup(groupId);
            DOM.joinGroupId.value = '';
        });

        DOM.leaveGroupBtn.addEventListener('click', () => leaveGroup());

        DOM.setDestinationBtn.addEventListener('click', () => {
            if (currentRouteState !== 'PREVIEW') return;
            destinationMarker.dragging.disable();
            setRouteState('SET');
        });

        DOM.addWaypointBtn.addEventListener('click', () => {
            isAddingWaypoint = true;
            DOM.mapContainer.classList.add('adding-waypoint');
            DOM.status.textContent = 'Klik di peta untuk menambah titik persinggahan.';
        });

        DOM.addCheckpointBtn.addEventListener('click', () => {
            isAddingCheckpoint = true;
            DOM.mapContainer.classList.add('adding-checkpoint');
            DOM.status.textContent = 'Klik di peta untuk menambah checkpoint.';
        });

        DOM.startNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'SET') return;
            const newName = prompt("Masukkan nama untuk tujuan ini:", window.currentDestinationName || "Tujuan");
    
    // Hanya lanjutkan jika pengguna tidak mengklik Batal
    if (newName) {
        // Perbarui nama tujuan secara global dan di panel info
        window.currentDestinationName = newName;
        DOM.navInfoDestination.textContent = newName;

        // Lanjutkan untuk memulai navigasi
        setRouteState('NAVIGATING');
        if(userCoords) map.setView(userCoords, 18, {animate: true});
    }
        });

        DOM.stopNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'NAVIGATING') return;
            setRouteState('SET');
        });

        DOM.cancelRouteBtn.addEventListener('click', () => {
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            routingControl = null; destinationMarker = null; isAddingWaypoint = false; isAddingCheckpoint = false;
            setRouteState('IDLE');
        });
		DOM.cancelMainBtn.addEventListener('click', () => {
        if (routingControl) map.removeControl(routingControl);
        if (destinationMarker) map.removeLayer(destinationMarker);
        routingControl = null; destinationMarker = null; isAddingWaypoint = false; isAddingCheckpoint = false;
        setRouteState('IDLE');
    });
    });
</script>
</body>
</html>


