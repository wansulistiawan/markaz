<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Rider</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        #map { height: 65vh; z-index: 10; background-color: #4a5568; }
        body { font-family: 'Inter', sans-serif; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; border-radius: 8px; }
        .leaflet-popup-content-wrapper .user-popup img { border-radius: 50%; width: 40px; height: 40px; margin-right: 10px;}
        .leaflet-popup-content-wrapper .user-popup { display: flex; align-items: center; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 max-w-5xl">
        <!-- Header & Kontrol Pengguna -->
        <header class="flex justify-between items-center mb-4 flex-wrap">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-emerald-400">Rider Real-Time Tracker</h1>
                <p class="text-gray-400">Login untuk membagikan lokasimu.</p>
            </div>
            <div id="auth-container" class="flex items-center gap-4 mt-4 md:mt-0">
                <div id="user-info" class="hidden items-center gap-3 text-right">
                    <div>
                        <p id="user-name" class="font-semibold"></p>
                        <button id="logout-btn" class="text-sm text-red-400 hover:underline">Logout</button>
                    </div>
                    <img id="user-pic" class="w-12 h-12 rounded-full border-2 border-emerald-400">
                </div>
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center gap-2 shadow-lg">
                    <svg class="w-5 h-5" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-72.2 64.5C305.1 102.8 277.6 88 248 88c-86.5 0-155.2 67.8-155.2 151.3s68.7 151.3 155.2 151.3c92.8 0 132-61.1 135-95.2H248v-73.8h238.2c2.6 13.2 4.2 27.8 4.2 43.8z"></path></svg>
                    Login dengan Google
                </button>
            </div>
        </header>

        <!-- Kontrol Peta -->
        <div id="map-controls" class="hidden my-4 flex justify-center items-center gap-4 flex-wrap">
            <button id="recenter-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 flex items-center gap-2">
                Pusatkan Lokasi
            </button>
            <label class="relative inline-flex items-center cursor-pointer">
              <input type="checkbox" id="share-public-toggle" class="sr-only peer">
              <div class="w-14 h-7 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-emerald-600"></div>
              <span class="ml-3 text-sm font-medium text-gray-300">Tampilkan Lokasi ke Publik</span>
            </label>
        </div>

        <main>
            <div id="map-container" class="rounded-2xl shadow-2xl overflow-hidden border-2 border-gray-700">
                <div id="map"></div>
            </div>
        </main>
        
        <footer>
            <div id="status" class="mt-4 p-3 bg-gray-800 rounded-lg text-center transition-all duration-300">
                Silakan login untuk memulai.
            </div>
        </footer>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
		

        // ===================================================================================
        // === TEMPELKAN KONFIGURASI FIREBASE ANDA DI SINI ===
        // ===================================================================================
        const firebaseConfig = {
  apiKey: "AIzaSyA9fthcIZ_VQXMUL6lPd-165NIFNb09JOA",
  authDomain: "aplikasi-touring.firebaseapp.com",
  projectId: "aplikasi-touring",
  storageBucket: "aplikasi-touring.firebasestorage.app",
  messagingSenderId: "310021643774",
  appId: "1:310021643774:web:4943db8f567e66aef174af",
  measurementId: "G-ZRCCNLC8WB"
};
        // ===================================================================================

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Variabel Global
        let map, myMarker, userCoords = null;
        let isSharingPublicly = false;
        let publicRidersUnsubscribe = null;
        const publicMarkers = {};

        // Elemen DOM
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const userNameEl = document.getElementById('user-name');
        const userPicEl = document.getElementById('user-pic');
        const mapControls = document.getElementById('map-controls');
        const statusEl = document.getElementById('status');
        const recenterBtn = document.getElementById('recenter-btn');
        const shareToggle = document.getElementById('share-public-toggle');

        // Inisialisasi Peta
        function initMap() {
            map = L.map('map').setView([-6.2088, 106.8456], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; OpenStreetMap'
            }).addTo(map);
        }

        // Logika Otentikasi
        onAuthStateChanged(auth, user => {
            if (user) {
                // Pengguna Login
                userNameEl.textContent = user.displayName;
                userPicEl.src = user.photoURL;
                loginBtn.classList.add('hidden');
                userInfo.classList.remove('hidden');
                userInfo.classList.add('flex');
                mapControls.classList.remove('hidden');
                statusEl.textContent = 'Mencari lokasi Anda...';
                startLocationWatch();
                listenToPublicRiders();
            } else {
                // Pengguna Logout
                loginBtn.classList.remove('hidden');
                userInfo.classList.add('hidden');
                mapControls.classList.add('hidden');
                statusEl.textContent = 'Silakan login untuk memulai.';
                if (myMarker) map.removeLayer(myMarker);
                if (publicRidersUnsubscribe) publicRidersUnsubscribe();
                Object.values(publicMarkers).forEach(marker => map.removeLayer(marker));
            }
        });

        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("Login Gagal:", error));
        });

        logoutBtn.addEventListener('click', () => {
            if (auth.currentUser) {
                removeLocationFromFirestore(auth.currentUser.uid);
            }
            signOut(auth);
        });
        
        // Logika Lokasi & Peta
        function startLocationWatch() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true });
            } else {
                statusEl.textContent = 'Geolocation tidak didukung oleh browser ini.';
            }
        }

        function updateLocation(position) {
            const { latitude, longitude } = position.coords;
            userCoords = [latitude, longitude];
            statusEl.textContent = `Lokasi diperbarui. Akurasi: ${position.coords.accuracy.toFixed(0)} meter.`;
            statusEl.style.backgroundColor = '#10B981';

            if (!myMarker) {
                myMarker = L.marker(userCoords).addTo(map).bindPopup('<b>Ini Anda!</b>');
                map.setView(userCoords, 16);
            } else {
                myMarker.setLatLng(userCoords);
            }
            
            if (isSharingPublicly && auth.currentUser) {
                updateLocationInFirestore(auth.currentUser, userCoords);
            }
        }

        function handleLocationError(error) {
            statusEl.textContent = `Gagal mendapatkan lokasi: ${error.message}`;
            statusEl.style.backgroundColor = '#EF4444';
        }

        recenterBtn.addEventListener('click', () => {
            if (userCoords) map.setView(userCoords, 16);
        });

        // Logika Berbagi Lokasi & Firestore
        shareToggle.addEventListener('change', () => {
            isSharingPublicly = shareToggle.checked;
            const currentUser = auth.currentUser;
            if (!currentUser) return;

            if (isSharingPublicly) {
                if (userCoords) {
                    updateLocationInFirestore(currentUser, userCoords);
                    statusEl.textContent = 'Lokasi Anda sekarang publik.';
                } else {
                    statusEl.textContent = 'Tunggu lokasi ditemukan sebelum berbagi.';
                    shareToggle.checked = false;
                    isSharingPublicly = false;
                }
            } else {
                removeLocationFromFirestore(currentUser.uid);
                statusEl.textContent = 'Lokasi Anda tidak lagi publik.';
            }
        });
        
        async function updateLocationInFirestore(user, coords) {
            const riderRef = doc(db, 'public_riders', user.uid);
            await setDoc(riderRef, {
                name: user.displayName,
                photoURL: user.photoURL,
                lat: coords[0],
                lng: coords[1],
                lastUpdate: new Date()
            });
        }
        
        async function removeLocationFromFirestore(uid) {
            await deleteDoc(doc(db, "public_riders", uid));
        }

        function listenToPublicRiders() {
            const ridersCol = collection(db, 'public_riders');
            publicRidersUnsubscribe = onSnapshot(ridersCol, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const riderData = change.doc.data();
                    const riderId = change.doc.id;

                    // Jangan tampilkan pin publik untuk diri sendiri
                    if (riderId === auth.currentUser?.uid) return;

                    if (change.type === "added" || change.type === "modified") {
                        const riderCoords = [riderData.lat, riderData.lng];
                        if (publicMarkers[riderId]) {
                            // Update marker yang ada
                            publicMarkers[riderId].setLatLng(riderCoords);
                        } else {
                            // Buat marker baru
                            const popupContent = `<div class="user-popup"><img src="${riderData.photoURL}" alt="foto profil"><strong>${riderData.name}</strong></div>`;
                            publicMarkers[riderId] = L.marker(riderCoords).addTo(map).bindPopup(popupContent);
                        }
                    } else if (change.type === "removed") {
                        if (publicMarkers[riderId]) {
                            map.removeLayer(publicMarkers[riderId]);
                            delete publicMarkers[riderId];
                        }
                    }
                });
            });
        }

        // Mulai aplikasi
        initMap();
    </script>
</body>
</html>

