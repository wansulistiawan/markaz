<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Rider - Turing Kelompok</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 10; background-color: #4a5568; }
        .map-locked { cursor: not-allowed !important; }
        .adding-waypoint, .creating-alert, .adding-checkpoint { cursor: crosshair !important; }
        .hidden { display: none; }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; border-radius: 8px; }
        .user-popup { display: flex; align-items: center; gap: 10px; }
        .user-popup img { border-radius: 50%; width: 40px; height: 40px; }
        .user-popup button, .alert-popup button { background-color: #10B981; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .alert-popup-content button { background-color: #4A5568; color: white; padding: 8px 12px; border-radius: 6px; margin: 4px; border: 1px solid #718096; }
        .alert-popup-content button:hover { background-color: #718096; }
        .alert-marker-icon { font-size: 2.5rem; text-shadow: 0 0 5px black; }

        .leaflet-routing-container { background-color: rgba(45, 55, 72, 0.9); color: #e2e8f0; border: 1px solid #4A5568; border-radius: 8px; }
        .leaflet-routing-alt, .leaflet-routing-alt h2, .leaflet-routing-summary { background-color: #4a5568 !important; color: #e2e8f0 !important; }
        .leaflet-routing-instruction:hover { background-color: #718096 !important; }
        .leaflet-bar a, .leaflet-bar a:hover { background-color: #4a5568; color: #e2e8f0; border-bottom: 1px solid #2d3748; }

        .modal-input:checked + label { outline: 3px solid #6EE7B7; transform: scale(1.1); }
        #navigation-controls { transition: transform 0.3s ease-in-out; transform: translateY(200%); }
        #navigation-controls.visible { transform: translateY(0); }

        .fab { width: 56px; height: 56px; background-color: #4A5568; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: background-color 0.2s; border: 1px solid #718096; }
        .fab:hover { background-color: #718096; }
        .fab.active { background-color: #10B981; border-color: #6EE7B7; }

        #suggestions-container { position: absolute; width: 100%; max-height: 200px; overflow-y: auto; background-color: #2d3748; border: 1px solid #4A5568; border-radius: 0.5rem; z-index: 1000; }
        .suggestion-item { padding: 0.75rem; cursor: pointer; color: #e2e8f0; }
        .suggestion-item:hover { background-color: #4A5568; }

        .role-select { background-color: #4A5568; border: 1px solid #718096; color: white; border-radius: 6px; padding: 4px 8px; }

        .checkpoint-marker-icon { background-color: #f59e0b; color: white; width: 2.5rem; height: 2.5rem; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px black; text-align: center; font-weight: bold; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased overflow-hidden">

    <div id="map-container" class="w-screen h-screen relative">
        <div id="map"></div>

        <!-- Floating UI Elements -->
        <div id="fab-top-left" class="absolute top-4 left-4 z-[400]">
            <button id="search-fab" class="fab bg-amber-500 hover:bg-amber-600" title="Cari Rute">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13V7m0 13a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m5-7l5.447 2.724A1 1 0 0121 5.618v10.764a1 1 0 01-1.447.894L15 17m0-13v13m0 0a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2a2 2 0 00-2 2"></path></svg>
            </button>
        </div>

        <div id="fab-top-right" class="absolute top-4 right-4 z-[400] hidden">
             <div class="relative">
                <img id="profile-fab" class="w-14 h-14 rounded-full border-2 border-emerald-400 cursor-pointer shadow-lg" src="https://placehold.co/100x100/2d3748/e2e8f0?text=:)">
                <div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-700 rounded-lg shadow-xl py-1">
                    <a href="#" id="settings-menu-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Ubah Warna Pin</a>
                    <a href="#" id="logout-menu-btn" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">Keluar</a>
                </div>
            </div>
        </div>
        
        <div id="fab-bottom-left" class="absolute bottom-4 left-4 z-[400] hidden">
            <button id="group-fab" class="fab" title="Manajemen Grup">
                <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a3.002 3.002 0 01-2.702 0M12 15a3 3 0 100-6 3 3 0 000 6z"></path></svg>
            </button>
        </div>

        <div id="fab-bottom-right" class="absolute bottom-4 right-4 z-[400] fab-container hidden">
            <button id="share-location-fab" class="fab" title="Bagikan Lokasi Anda">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6.002l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.368a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path></svg>
            </button>
            <button id="recenter-fab" class="fab" title="Pusatkan ke Lokasi Saya">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>
        
        <div id="navigation-controls" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-[401] flex gap-2 sm:gap-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
            <button id="set-destination-btn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-lg">Tetapkan Tujuan</button>
            <button id="add-checkpoint-btn" class="hidden bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-5 rounded-lg">Tambah Checkpoint</button>
            <button id="add-waypoint-btn" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-5 rounded-lg">Tambah Persinggahan</button>
            <button id="start-nav-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">Mulai Navigasi</button>
            <button id="stop-nav-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-5 rounded-lg">Hentikan Navigasi</button>
            <button id="cancel-route-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg">Batal</button>
        </div>
        
        <div id="status-bar" class="absolute bottom-0 w-full z-[400] p-4 pointer-events-none">
            <div id="status" class="max-w-xl mx-auto p-3 bg-gray-800 bg-opacity-80 backdrop-blur-sm rounded-lg text-center pointer-events-auto">Memuat peta...</div>
        </div>

        <button id="login-btn" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center gap-3 z-[500] text-lg">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 488 512"><path d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-72.2 64.5C305.1 102.8 277.6 88 248 88c-86.5 0-155.2 67.8-155.2 151.3s68.7 151.3 155.2 151.3c92.8 0 132-61.1 135-95.2H248v-73.8h238.2c2.6 13.2 4.2 27.8 4.2 43.8z"></path></svg> 
            Masuk dengan Google
        </button>
    </div>

    <!-- Modals -->
    <div id="search-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-start justify-center z-50 p-4 pt-16">
        <div class="relative w-full max-w-lg">
             <form id="search-form" onsubmit="event.preventDefault();"><div class="relative"><input type="text" id="search-input" placeholder="Cari alamat atau nama tempat..." class="w-full bg-gray-700 text-white rounded-lg py-3 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500" autocomplete="off"><button type="submit" class="absolute right-3 top-1/2 -translate-y-1/2 p-1 text-gray-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button></div></form>
             <div id="suggestions-container" class="mt-1"></div>
        </div>
    </div>

    <div id="pin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-md"><h2 class="text-2xl font-bold mb-6 text-emerald-400">Ubah Warna Pin Anda</h2><div class="mb-6"><h3 class="font-semibold mb-3 text-gray-300">Pilih Warna</h3><div id="color-options" class="flex gap-3 flex-wrap justify-center"></div></div><div class="flex justify-end gap-4"><button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Batal</button><button id="save-settings-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Simpan</button></div></div></div>
    
    <div id="group-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-lg p-6 w-full max-w-lg max-h-[90vh] flex flex-col">
            <h2 class="text-2xl font-bold mb-4 text-emerald-400">Manajemen Grup Turing</h2>
            
            <div id="group-view" class="hidden">
                <div class="mb-4">
                    <h3 class="font-semibold text-lg">Grup Saat Ini: <span id="group-name" class="text-amber-400"></span></h3>
                    <p class="text-sm text-gray-400">ID Grup: <span id="group-id" class="font-mono"></span></p>
                </div>
                <div class="mb-4 border-t border-gray-700 pt-4 overflow-y-auto" style="max-height: 40vh;">
                    <h4 class="font-semibold mb-2">Anggota Grup (<span id="group-member-count">0</span>):</h4>
                    <div id="group-members-list" class="space-y-2"></div>
                </div>
                <button id="leave-group-btn" class="w-full bg-red-600 hover:bg-red-700 font-bold py-2 px-4 rounded-lg">Keluar Grup</button>
            </div>

            <div id="no-group-view">
                <div class="mb-4 border-b border-gray-700 pb-4">
                    <h3 class="font-semibold text-lg mb-2">Buat Grup Baru</h3>
                    <div class="flex gap-2"><input type="text" id="create-group-name" placeholder="Nama Grup Turing" class="flex-grow bg-gray-700 text-white rounded-lg py-2 px-3"><button id="create-group-btn" class="bg-blue-600 hover:bg-blue-700 font-bold py-2 px-4 rounded-lg">Buat</button></div>
                </div>
                <div>
                    <h3 class="font-semibold text-lg mb-2">Gabung Grup</h3>
                    <div class="flex gap-2"><input type="text" id="join-group-id" placeholder="Masukkan ID Grup" class="flex-grow bg-gray-700 text-white rounded-lg py-2 px-3"><button id="join-group-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Gabung</button></div>
                </div>
            </div>

            <button id="close-group-modal-btn" class="mt-6 text-gray-400 hover:text-white self-center">Tutup</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc, writeBatch, updateDoc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA9fthcIZ_VQXMUL6lPd-165NIFNb09JOA", authDomain: "aplikasi-touring.firebaseapp.com", projectId: "aplikasi-touring", storageBucket: "aplikasi-touring.appspot.com", messagingSenderId: "310021643774", appId: "1:310021643774:web:4943db8f567e66aef174af", measurementId: "G-ZRCCNLC8WB" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, myMarker, userCoords = null, routingControl = null, destinationMarker = null;
        let isSharingPublicly = false;
        let publicRidersUnsubscribe = null;
        const publicMarkers = {};
        const alertMarkers = {};
        const checkpointMarkers = {};
        let currentUserSettings = { pinColor: '#3498db' };
        let currentRouteState = 'IDLE';
        let isAddingWaypoint = false;
        let isAddingCheckpoint = false;
        let currentGroupId = null;
        let currentGroupData = null;
        let groupUnsubscribe = null;
        let userUnsubscribe = null;
        let groupAlertsUnsubscribe = null;
        let groupCheckpointsUnsubscribe = null;

        const DOM = {
            mapContainer: document.getElementById('map-container'),
            status: document.getElementById('status'),
            loginBtn: document.getElementById('login-btn'),
            logoutMenuBtn: document.getElementById('logout-menu-btn'),
            profileFab: document.getElementById('profile-fab'),
            profileFabContainer: document.getElementById('fab-top-right'),
            profileDropdown: document.getElementById('profile-dropdown'),
            settingsMenuBtn: document.getElementById('settings-menu-btn'), modal: document.getElementById('pin-settings-modal'),
            groupFab: document.getElementById('group-fab'), groupModal: document.getElementById('group-modal'),
            groupView: document.getElementById('group-view'), noGroupView: document.getElementById('no-group-view'),
            groupName: document.getElementById('group-name'), groupId: document.getElementById('group-id'),
            groupMemberCount: document.getElementById('group-member-count'),
            groupMembersList: document.getElementById('group-members-list'),
            createGroupName: document.getElementById('create-group-name'), createGroupBtn: document.getElementById('create-group-btn'),
            joinGroupId: document.getElementById('join-group-id'), joinGroupBtn: document.getElementById('join-group-btn'),
            leaveGroupBtn: document.getElementById('leave-group-btn'), closeGroupModalBtn: document.getElementById('close-group-modal-btn'),
            searchFab: document.getElementById('search-fab'), searchModal: document.getElementById('search-modal'),
            searchInput: document.getElementById('search-input'), suggestionsContainer: document.getElementById('suggestions-container'),
            navControls: document.getElementById('navigation-controls'),
            setDestinationBtn: document.getElementById('set-destination-btn'),
            addCheckpointBtn: document.getElementById('add-checkpoint-btn'),
            addWaypointBtn: document.getElementById('add-waypoint-btn'),
            startNavBtn: document.getElementById('start-nav-btn'),
            stopNavBtn: document.getElementById('stop-nav-btn'),
            cancelRouteBtn: document.getElementById('cancel-route-btn'),
            fabBottomRight: document.getElementById('fab-bottom-right'),
            shareLocationFab: document.getElementById('share-location-fab'),
            recenterFab: document.getElementById('recenter-fab'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'), 
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            colorOptions: document.getElementById('color-options'),
        };

        const roles = {
            amir: '‚≠ê', penunjuk_jalan: 'üß≠', guard: 'üõ°Ô∏è', sweeper: 'üßπ', logistik: 'üõ†Ô∏è', member: 'üë§'
        };

        const alertTypes = {
            razia: { icon: 'üëÆ', text: 'Ada Razia Polisi' }, kecelakaan: { icon: 'üí•', text: 'Ada Kecelakaan' },
            macet: { icon: 'üöó', text: 'Lalu Lintas Macet' }, pawai: { icon: 'üéâ', text: 'Ada Pawai/Keramaian' },
            bencana: { icon: 'üåã', text: 'Ada Bencana Alam' }, jalan_rusak: { icon: 'üöß', text: 'Ada Jalan Rusak' }
        };
        
        function createProfilePinIcon(color, imageUrl, role = 'member') {
            const uniqueId = `clip-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const roleEmoji = roles[role] || roles['member'];
            const iconHtml = `
                <svg width="64" height="70" viewBox="0 0 32 38" xmlns="http://www.w3.org/2000/svg" style="transform: translateY(-6px);">
                    <defs>
                        <clipPath id="${uniqueId}"><circle cx="16" cy="11" r="9" /></clipPath>
                    </defs>
                    <g transform="translate(0, 6)">
                        <path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path>
                        <circle cx="16" cy="11" r="9" fill="#2d3748" stroke="${color}" stroke-width="1.5" />
                        <image href="${imageUrl}" x="7" y="2" height="18" width="18" clip-path="url(#${uniqueId})" />
                    </g>
                    <circle cx="16" cy="6" r="7" fill="#1a202c" stroke="${color}" stroke-width="1.5"/>
                    <text x="16" y="8.5" font-size="9" text-anchor="middle" fill="white">${roleEmoji}</text>
                </svg>`;
            return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 70], iconAnchor: [32, 70], popupAnchor: [0, -70] });
        }
        
        function createFlagIcon(color) {
            const iconHtml = `<svg width="64" height="64" viewBox="0 0 32 32"><path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path><path fill="white" d="M14.23 6.02l.46 2.06h6.09l-.46-2.06H14.23zM13 3h9v2h-9V3zm1.69 5.02L13 18H5v-2h6.27l.45-2.02H5V12h6.72l.45-2.02H5V8.02h9.69z"></path></svg>`;
            return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 64], iconAnchor: [32, 64], popupAnchor: [0, -64] });
        }

        function createCheckpointIcon(number) {
            return L.divIcon({
                className: 'checkpoint-marker-icon',
                html: `<span>${number}</span>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        async function fetchSuggestions(query) {
            if (query.length < 3) {
                DOM.suggestionsContainer.innerHTML = '';
                DOM.suggestionsContainer.classList.add('hidden');
                return;
            }
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const data = await res.json();
                displaySuggestions(data);
            } catch (error) {
                console.error('Gagal mengambil saran:', error);
            }
        }
        
        function displaySuggestions(suggestions) {
            DOM.suggestionsContainer.innerHTML = '';
            if (suggestions && suggestions.length > 0) {
                suggestions.forEach(s => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = s.display_name;
                    item.onclick = () => {
                        DOM.searchInput.value = s.display_name;
                        DOM.suggestionsContainer.classList.add('hidden');
                        DOM.searchModal.classList.add('hidden');
                        window.showRouteTo([s.lat, s.lon], s.display_name);
                    };
                    DOM.suggestionsContainer.appendChild(item);
                });
                DOM.suggestionsContainer.classList.remove('hidden');
            } else {
                DOM.suggestionsContainer.classList.add('hidden');
            }
        }

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false }).setView([-2.5489, 118.0149], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
            L.control.zoom({ position: 'bottomright' }).addTo(map);
            map.on('click', (e) => {
                if (isAddingWaypoint) { addWaypointToRoute(e.latlng); return; }
                if (isAddingCheckpoint) { showCheckpointPrompt(e.latlng); return; }
                const userRole = currentGroupData?.members?.[auth.currentUser?.uid]?.role;
                if (currentRouteState === 'NAVIGATING' && currentGroupId && ['amir', 'penunjuk_jalan', 'guard', 'sweeper', 'logistik'].includes(userRole)) {
                    showUIAlertSelection(e.latlng);
                    return;
                }
                if (currentRouteState === 'IDLE' && auth.currentUser && userCoords) {
                    const dest = [e.latlng.lat, e.latlng.lng];
                    window.showRouteTo(dest, 'Titik Dipilih');
                }
            });
            DOM.status.textContent = "Peta dimuat. Silakan masuk untuk memulai.";
        }

        function startLocationWatch() {
            if (!navigator.geolocation) {
                DOM.status.textContent = 'Geolocation tidak didukung oleh browser ini.';
                return;
            }
            DOM.status.textContent = "Mencari lokasi Anda...";
            navigator.geolocation.watchPosition(updateLocation, handleLocationError, { enableHighAccuracy: true });
        }
        
        function handleLocationError(error) {
            let message = 'Gagal mendapatkan lokasi. ';
            switch(error.code) {
                case error.PERMISSION_DENIED: message += "Anda menolak permintaan izin lokasi."; break;
                case error.POSITION_UNAVAILABLE: message += "Informasi lokasi tidak tersedia."; break;
                case error.TIMEOUT: message += "Permintaan lokasi timeout."; break;
                default: message += "Terjadi kesalahan tidak dikenal."; break;
            }
            DOM.status.textContent = message + " Peta tetap dapat digunakan untuk pencarian.";
        }
        
        function setRouteState(newState) {
            currentRouteState = newState;
            updateNavControlsUI();
        }

        function updateNavControlsUI() {
            const isVisible = (currentRouteState !== 'IDLE');
            DOM.navControls.classList.toggle('visible', isVisible);
            
            [DOM.setDestinationBtn, DOM.addWaypointBtn, DOM.addCheckpointBtn, DOM.startNavBtn, DOM.stopNavBtn, DOM.cancelRouteBtn].forEach(btn => btn.classList.add('hidden'));
            
            const userRole = currentGroupData?.members?.[auth.currentUser?.uid]?.role;
            const isOfficer = ['amir', 'penunjuk_jalan', 'guard', 'sweeper', 'logistik'].includes(userRole);

            if (currentRouteState === 'PREVIEW') {
                DOM.setDestinationBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                DOM.subtitle.textContent = 'Seret pin tujuan untuk mengubah rute.';
                DOM.map.classList.remove('map-locked', 'adding-waypoint', 'adding-checkpoint');
            } else if (currentRouteState === 'SET' || currentRouteState === 'NAVIGATING') {
                DOM.addWaypointBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                if (isOfficer) DOM.addCheckpointBtn.classList.remove('hidden');
                if (currentRouteState === 'SET') {
                    DOM.startNavBtn.classList.remove('hidden');
                    DOM.status.textContent = 'Tujuan ditetapkan. Siap memulai atau tambah persinggahan.';
                } else {
                    DOM.stopNavBtn.classList.remove('hidden');
                    DOM.status.textContent = 'Mode navigasi aktif. Peta akan mengikuti Anda.';
                }
                DOM.subtitle.textContent = 'Rute telah ditetapkan.';
                DOM.map.classList.add('map-locked');
            } else {
                DOM.status.textContent = userCoords ? `Akurasi: ${Math.round(userCoords.accuracy)}m` : 'Mencari lokasi...';
                DOM.subtitle.textContent = 'Klik peta atau cari untuk pratinjau rute.';
                DOM.map.classList.remove('map-locked', 'adding-waypoint', 'adding-checkpoint');
            }
        }
        
        DOM.setDestinationBtn.addEventListener('click', () => {
            if (currentRouteState !== 'PREVIEW') return;
            destinationMarker.dragging.disable();
            setRouteState('SET');
        });

        DOM.addWaypointBtn.addEventListener('click', () => {
            isAddingWaypoint = true;
            DOM.map.classList.add('adding-waypoint');
            DOM.status.textContent = 'Klik di peta untuk menambah titik persinggahan.';
        });

        function addWaypointToRoute(latlng) {
            if (!routingControl) return;
            const waypoints = routingControl.getWaypoints();
            const newWaypoint = L.Routing.waypoint(latlng);
            waypoints.splice(waypoints.length - 1, 0, newWaypoint);
            routingControl.setWaypoints(waypoints);
            
            isAddingWaypoint = false;
            DOM.map.classList.remove('adding-waypoint');
            DOM.status.textContent = 'Persinggahan ditambahkan.';
        }

        DOM.addCheckpointBtn.addEventListener('click', () => {
            isAddingCheckpoint = true;
            DOM.map.classList.add('adding-checkpoint');
            DOM.status.textContent = 'Klik di peta untuk menambah checkpoint.';
        });

        function showCheckpointPrompt(latlng) {
            const description = prompt("Masukkan keterangan untuk checkpoint ini (misal: 'Titik Kumpul 1', 'Makan Siang', dll):");
            if (description) {
                createCheckpoint(latlng, description);
            }
            isAddingCheckpoint = false;
            DOM.map.classList.remove('adding-checkpoint');
            DOM.status.textContent = 'Mode navigasi aktif.';
        }

        async function createCheckpoint(latlng, description) {
            const user = auth.currentUser;
            if (!user || !currentGroupId) return;
            const checkpointRef = doc(collection(db, 'groups', currentGroupId, 'checkpoints'));
            await setDoc(checkpointRef, {
                description: description,
                lat: latlng.lat,
                lng: latlng.lng,
                creatorId: user.uid,
                creatorName: user.displayName,
                createdAt: serverTimestamp()
            });
            DOM.status.textContent = 'Checkpoint ditambahkan!';
        }

        DOM.startNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'SET') return;
            setRouteState('NAVIGATING');
            if(userCoords) map.setView(userCoords, 18, {animate: true});
        });

        DOM.stopNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'NAVIGATING') return;
            setRouteState('SET');
        });

        DOM.cancelRouteBtn.addEventListener('click', () => {
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            routingControl = null; destinationMarker = null; isAddingWaypoint = false; isAddingCheckpoint = false;
            setRouteState('IDLE');
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                DOM.loginBtn.classList.add('hidden');
                DOM.profileFabContainer.classList.remove('hidden');
                DOM.profileFab.src = user.photoURL;
                DOM.fabBottomLeft.classList.remove('hidden');
                DOM.fabBottomRight.classList.remove('hidden');
                
                startLocationWatch(); 
                listenToUserDoc(user.uid);
            } else {
                DOM.loginBtn.classList.remove('hidden');
                DOM.profileFabContainer.classList.add('hidden');
                DOM.fabBottomLeft.classList.add('hidden');
                DOM.fabBottomRight.classList.add('hidden');
                DOM.status.textContent = 'Silakan masuk untuk memulai.';
                if (myMarker) { map.removeLayer(myMarker); myMarker = null; }
                DOM.cancelRouteBtn.click();
                if (publicRidersUnsubscribe) publicRidersUnsubscribe();
                if (userUnsubscribe) userUnsubscribe();
                if (groupUnsubscribe) groupUnsubscribe();
                if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
                if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
                Object.values(publicMarkers).forEach(marker => map.removeLayer(marker));
                Object.values(alertMarkers).forEach(marker => map.removeLayer(marker));
                Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
                currentGroupId = null; currentGroupData = null;
            }
        });

        DOM.loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()));
        DOM.logoutMenuBtn.addEventListener('click', async () => { if (auth.currentUser) await removeLocationFromFirestore(auth.currentUser.uid); signOut(auth); });
        
        function updateLocation(position) {
            userCoords = [position.coords.latitude, position.coords.longitude];
            userCoords.accuracy = position.coords.accuracy;
            if (currentRouteState === 'IDLE') DOM.status.textContent = `Akurasi: ${Math.round(userCoords.accuracy)}m`;
            
            if (!myMarker && auth.currentUser) {
                const myRole = currentGroupData?.members?.[auth.currentUser.uid]?.role;
                myMarker = L.marker(userCoords, { icon: createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL, myRole) }).addTo(map).bindPopup('<b>Ini Lokasi Anda!</b>');
                if (currentRouteState === 'IDLE') map.setView(userCoords, 16);
            } else if (myMarker) { myMarker.setLatLng(userCoords); }
            
            if (currentRouteState === 'NAVIGATING') { map.setView(userCoords, 18, {animate: true, pan: {duration: 1}}); }
            if (isSharingPublicly && auth.currentUser) updateLocationInFirestore(auth.currentUser);
        }

        DOM.recenterFab.addEventListener('click', () => {
            if (userCoords) { map.setView(userCoords, 16, {animate: true}); } 
            else { DOM.status.textContent = 'Lokasi Anda belum ditemukan.'; }
        });

        DOM.shareLocationFab.addEventListener('click', () => {
            isSharingPublicly = !isSharingPublicly;
            DOM.shareLocationFab.classList.toggle('active', isSharingPublicly);
            if (!auth.currentUser) return;
            if (isSharingPublicly) {
                if (userCoords) { updateLocationInFirestore(auth.currentUser); } 
                else { DOM.status.textContent = 'Tunggu lokasi ditemukan.'; isSharingPublicly = false; DOM.shareLocationFab.classList.remove('active'); }
            } else { removeLocationFromFirestore(auth.currentUser.uid); }
        });
        
        async function updateLocationInFirestore(user) {
            if (!userCoords) return;
            const statusText = isSharingPublicly ? 'Lokasi Anda sekarang publik.' : 'Lokasi Anda tidak lagi publik.';
            if (currentRouteState === 'IDLE') DOM.status.textContent = statusText;
            
            const userRef = doc(db, 'users', user.uid);
            await setDoc(userRef, {
                name: user.displayName, photoURL: user.photoURL, lat: userCoords[0], lng: userCoords[1],
                lastUpdate: new Date(), pinColor: currentUserSettings.pinColor, isSharing: isSharingPublicly, groupId: currentGroupId
            }, { merge: true });
        }
        
        async function removeLocationFromFirestore(uid) { 
            const userRef = doc(db, 'users', uid);
            await updateDoc(userRef, { isSharing: false });
            DOM.status.textContent = 'Lokasi Anda tidak lagi publik.';
        }

        function listenToUserDoc(uid) {
            if (userUnsubscribe) userUnsubscribe();
            userUnsubscribe = onSnapshot(doc(db, "users", uid), (doc) => {
                const userData = doc.data();
                if (userData?.groupId && userData.groupId !== currentGroupId) {
                    joinGroup(userData.groupId, true);
                } else if (!userData?.groupId && currentGroupId) {
                    leaveGroup(true);
                }
                currentUserSettings.pinColor = userData?.pinColor || '#3498db';
                if(myMarker && auth.currentUser){
                    const myRole = currentGroupData?.members?.[auth.currentUser.uid]?.role;
                    myMarker.setIcon(createProfilePinIcon(currentUserSettings.pinColor, auth.currentUser.photoURL, myRole));
                }
            });
        }

        function listenToPublicRiders() {
            if (publicRidersUnsubscribe) publicRidersUnsubscribe();
            const q = query(collection(db, 'users'));
            publicRidersUnsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const riderData = change.doc.data(); const riderId = change.doc.id;
                    const isMySelf = riderId === auth.currentUser?.uid;
                    const isSharing = riderData.isSharing;
                    const belongsToMyGroup = currentGroupId && riderData.groupId === currentGroupId;
                    const shouldShow = isSharing && (!currentGroupId || belongsToMyGroup);
                    
                    if (change.type === "removed" || !shouldShow) {
                        if (publicMarkers[riderId]) { map.removeLayer(publicMarkers[riderId]); delete publicMarkers[riderId]; }
                        return;
                    }

                    if (!isMySelf) {
                        if (publicMarkers[riderId]) map.removeLayer(publicMarkers[riderId]);
                        const riderCoords = [riderData.lat, riderData.lng];
                        const role = currentGroupData?.members?.[riderId]?.role || 'member';
                        const icon = createProfilePinIcon(riderData.pinColor || '#34495e', riderData.photoURL, role);
                        const popupContent = `<div class="user-popup"><img src="${riderData.photoURL}" alt="foto"><div><strong>${riderData.name}</strong><br><button onclick="window.showRouteTo([${riderCoords}], '${riderData.name.replace(/'/g, "\\'")}')">Rute ke Sini</button></div></div>`;
                        publicMarkers[riderId] = L.marker(riderCoords, { icon: icon }).addTo(map).bindPopup(popupContent);
                    }
                });
            });
        }
        
        window.showRouteTo = (destinationCoords, destinationName = 'Tujuan') => {
            if (currentRouteState !== 'IDLE') { DOM.status.textContent = 'Batalkan rute saat ini untuk membuat rute baru.'; return; }
            if (!userCoords) { alert("Lokasi Anda belum ditemukan."); return; }
            
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);

            destinationMarker = L.marker(destinationCoords, { icon: createFlagIcon('#e74c3c'), draggable: true }).addTo(map).bindPopup(`<b>${destinationName}</b>`).openPopup();
            
            destinationMarker.on('dragend', function(event) {
                if (currentRouteState !== 'PREVIEW') return;
                const newCoords = event.target.getLatLng();
                window.showRouteTo([newCoords.lat, newCoords.lng], 'Tujuan Baru');
            });

            routingControl = L.Routing.control({
                waypoints: [ L.latLng(userCoords), L.latLng(destinationCoords) ],
                routeWhileDragging: false,
                lineOptions: { styles: [{color: '#6EE7B7', weight: 5}] },
                createMarker: () => null
            }).on('routesfound', function(e) {
                const summary = e.routes[0].summary;
                const totalDistance = (summary.totalDistance / 1000).toFixed(1);
                const totalTime = Math.round(summary.totalTime / 60);
                const hours = Math.floor(totalTime / 60);
                const minutes = totalTime % 60;
                let timeString = '';
                if(hours > 0) timeString += `${hours} jam `;
                if(minutes > 0) timeString += `${minutes} menit`;
                
                DOM.status.textContent = `Estimasi Rute: ${timeString} (${totalDistance} km)`;
            }).addTo(map);

            setRouteState('PREVIEW');
        }

        DOM.searchInput.addEventListener('input', debounce(e => fetchSuggestions(e.target.value), 300));
        document.addEventListener('click', (e) => {
            if (!DOM.searchModal.contains(e.target) && e.target !== DOM.searchFab && !DOM.searchFab.contains(e.target)) {
                DOM.searchModal.classList.add('hidden');
            }
            if (!DOM.profileDropdown.parentElement.contains(e.target)) {
                DOM.profileDropdown.classList.add('hidden');
            }
        });
        
        DOM.searchFab.addEventListener('click', () => DOM.searchModal.classList.toggle('hidden'));
        DOM.profileFab.addEventListener('click', () => DOM.profileDropdown.classList.toggle('hidden'));

        function setupModal() {
            DOM.colorOptions.innerHTML = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#ffffff'].map(c => `<div><input type="radio" name="color" value="${c}" id="c-${c}" class="sr-only modal-input"><label for="c-${c}" class="block w-8 h-8 rounded-full cursor-pointer border-2 border-gray-500" style="background-color:${c};"></label></div>`).join('');
        }
        
        DOM.settingsMenuBtn.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelector(`input[name="color"][value="${currentUserSettings.pinColor}"]`).checked = true;
            DOM.modal.classList.remove('hidden');
            DOM.profileDropdown.classList.add('hidden');
        });

        DOM.saveSettingsBtn.addEventListener('click', async () => {
            currentUserSettings.pinColor = document.querySelector('input[name="color"]:checked').value;
            if (auth.currentUser) await updateDoc(doc(db, "users", auth.currentUser.uid), { pinColor: currentUserSettings.pinColor });
            DOM.modal.classList.add('hidden');
        });

        DOM.cancelSettingsBtn.addEventListener('click', () => DOM.modal.classList.add('hidden'));

        DOM.groupFab.addEventListener('click', () => DOM.groupModal.classList.remove('hidden'));
        DOM.closeGroupModalBtn.addEventListener('click', () => DOM.groupModal.classList.add('hidden'));

        DOM.createGroupBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            const groupName = DOM.createGroupName.value.trim();
            if (!user || !groupName) return;

            const groupRef = doc(collection(db, 'groups'));
            const newGroup = {
                name: groupName, amir: user.uid, createdAt: new Date(),
                members: {
                    [user.uid]: { name: user.displayName, photoURL: user.photoURL, role: 'amir' }
                }
            };
            await setDoc(groupRef, newGroup);
            await updateDoc(doc(db, "users", user.uid), { groupId: groupRef.id });
            DOM.createGroupName.value = '';
        });

        DOM.joinGroupBtn.addEventListener('click', async () => {
            const groupId = DOM.joinGroupId.value.trim();
            if (!groupId) return;
            joinGroup(groupId);
            DOM.joinGroupId.value = '';
        });

        async function joinGroup(groupId, silent = false) {
            const user = auth.currentUser;
            if (!user) return;
            
            const groupRef = doc(db, "groups", groupId);
            const groupSnap = await getDoc(groupRef);

            if (!groupSnap.exists()) {
                if (!silent) alert("Grup tidak ditemukan!");
                return;
            }

            const newMember = { name: user.displayName, photoURL: user.photoURL, role: 'member' };
            await updateDoc(groupRef, { [`members.${user.uid}`]: newMember });
            await updateDoc(doc(db, "users", user.uid), { groupId: groupId });
            
            currentGroupId = groupId;
            if (!silent) DOM.groupModal.classList.add('hidden');

            if (groupUnsubscribe) groupUnsubscribe();
            groupUnsubscribe = onSnapshot(groupRef, (doc) => {
                currentGroupData = doc.data();
                updateGroupMembersUI(currentGroupData);
            });
            listenToGroupAlerts(groupId);
            listenToCheckpoints(groupId);
        }

        DOM.leaveGroupBtn.addEventListener('click', () => leaveGroup());

        async function leaveGroup(silent = false) {
            const user = auth.currentUser;
            if (!user || !currentGroupId) return;

            const batch = writeBatch(db);
            const userRef = doc(db, 'users', user.uid);
            batch.update(userRef, { groupId: null });

            const groupRef = doc(db, 'groups', currentGroupId);
            const members = { ...currentGroupData.members };
            delete members[user.uid];
            
            if (Object.keys(members).length === 0) {
                batch.delete(groupRef);
            } else {
                if(currentGroupData.amir === user.uid && Object.keys(members).length > 0) {
                    const newAmirId = Object.keys(members)[0];
                    members[newAmirId].role = 'amir';
                    batch.update(groupRef, { members: members, amir: newAmirId });
                } else {
                    batch.update(groupRef, { members: members });
                }
            }

            await batch.commit();

            if (!silent) alert("Anda telah keluar dari grup.");
            currentGroupId = null;
            currentGroupData = null;
            if (groupUnsubscribe) groupUnsubscribe();
            if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
            if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
            updateGroupMembersUI(null);
            Object.values(alertMarkers).forEach(marker => map.removeLayer(marker));
            Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
        }

        function updateGroupMembersUI(groupData) {
            if (groupData && groupData.members) {
                DOM.groupView.classList.remove('hidden');
                DOM.noGroupView.classList.add('hidden');
                DOM.groupName.textContent = groupData.name;
                DOM.groupId.textContent = currentGroupId;
                const memberCount = Object.keys(groupData.members).length;
                DOM.groupMemberCount.textContent = memberCount;
                DOM.groupMembersList.innerHTML = '';
                
                const user = auth.currentUser;
                const amIAmir = user && user.uid === groupData.amir;

                Object.entries(groupData.members).forEach(([uid, member]) => {
                    const memberEl = document.createElement('div');
                    memberEl.className = 'flex items-center justify-between bg-gray-700 p-2 rounded-lg';
                    memberEl.innerHTML = `
                        <div class="flex items-center gap-3">
                            <img src="${member.photoURL}" class="w-8 h-8 rounded-full">
                            <span>${member.name} ${uid === user.uid ? '(Anda)' : ''}</span>
                        </div>
                        <div id="role-control-${uid}"></div>
                    `;
                    DOM.groupMembersList.appendChild(memberEl);

                    const roleControlContainer = document.getElementById(`role-control-${uid}`);
                    if (amIAmir && uid !== user.uid) {
                        const select = document.createElement('select');
                        select.className = 'role-select';
                        select.innerHTML = Object.keys(roles).filter(r => r !== 'amir').map(r => `<option value="${r}" ${member.role === r ? 'selected' : ''}>${r.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</option>`).join('');
                        select.onchange = (e) => updateMemberRole(uid, e.target.value);
                        roleControlContainer.appendChild(select);
                    } else {
                        roleControlContainer.innerHTML = `<span class="px-2 py-1 text-sm rounded-full bg-gray-600">${roles[member.role]} ${member.role.replace(/_/g, ' ')}</span>`;
                    }
                });
            } else {
                DOM.groupView.classList.add('hidden');
                DOM.noGroupView.classList.remove('hidden');
            }
        }

        async function updateMemberRole(uid, newRole) {
            if (!currentGroupId) return;
            const groupRef = doc(db, 'groups', currentGroupId);
            await updateDoc(groupRef, { [`members.${uid}.role`]: newRole });
        }

        function showUIAlertSelection(latlng) {
            let content = '<div class="alert-popup-content text-center"><strong>Tandai Kejadian:</strong><br>';
            Object.entries(alertTypes).forEach(([key, value]) => {
                content += `<button onclick="window.createAlert('${key}', ${latlng.lat}, ${latlng.lng})">${value.icon} ${value.text}</button>`;
            });
            content += '</div>';
            L.popup().setLatLng(latlng).setContent(content).openOn(map);
        }

        window.createAlert = async (type, lat, lng) => {
            map.closePopup();
            const user = auth.currentUser;
            if (!user || !currentGroupId) return;
            const alertRef = doc(collection(db, 'groups', currentGroupId, 'alerts'));
            await setDoc(alertRef, {
                type: type, lat: lat, lng: lng,
                creatorId: user.uid, creatorName: user.displayName, createdAt: new Date()
            });
        }

        function listenToGroupAlerts(groupId) {
            if (groupAlertsUnsubscribe) groupAlertsUnsubscribe();
            const alertsRef = collection(db, 'groups', groupId, 'alerts');
            groupAlertsUnsubscribe = onSnapshot(alertsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const alertId = change.doc.id;
                    const alertData = change.doc.data();
                    if (change.type === 'removed') {
                        if (alertMarkers[alertId]) { map.removeLayer(alertMarkers[alertId]); delete alertMarkers[alertId]; } return;
                    }
                    if (alertMarkers[alertId]) map.removeLayer(alertMarkers[alertId]);
                    const alertIcon = L.divIcon({ className: 'alert-marker-icon', html: alertTypes[alertData.type].icon, iconSize: [40, 40], iconAnchor: [20, 20] });
                    let popupContent = `<strong>${alertTypes[alertData.type].text}</strong><br><small>Oleh: ${alertData.creatorName}</small>`;
                    if (auth.currentUser?.uid === currentGroupData?.amir) {
                        popupContent += `<br><button class="mt-2" onclick="window.deleteAlert('${alertId}')">Hapus</button>`;
                    }
                    alertMarkers[alertId] = L.marker([alertData.lat, alertData.lng], { icon: alertIcon }).addTo(map).bindPopup(popupContent);
                });
            });
        }

        window.deleteAlert = async (alertId) => {
            if (!currentGroupId) return;
            await deleteDoc(doc(db, 'groups', currentGroupId, 'alerts', alertId));
            map.closePopup();
        }

        function listenToCheckpoints(groupId) {
            if (groupCheckpointsUnsubscribe) groupCheckpointsUnsubscribe();
            const checkpointsRef = query(collection(db, 'groups', groupId, 'checkpoints'), orderBy('createdAt'));
            groupCheckpointsUnsubscribe = onSnapshot(checkpointsRef, (snapshot) => {
                Object.values(checkpointMarkers).forEach(marker => map.removeLayer(marker));
                let count = 1;
                snapshot.forEach((doc) => {
                    const cpId = doc.id;
                    const cpData = doc.data();
                    const icon = createCheckpointIcon(count++);
                    let popupContent = `<strong>Checkpoint: ${cpData.description}</strong><br><small>Oleh: ${cpData.creatorName}</small>`;
                    if (auth.currentUser?.uid === currentGroupData?.amir) {
                         popupContent += `<br><button class="mt-2" onclick="window.deleteCheckpoint('${cpId}')">Hapus</button>`;
                    }
                    checkpointMarkers[cpId] = L.marker([cpData.lat, cpData.lng], { icon }).addTo(map).bindPopup(popupContent);
                });
            });
        }
        
        window.deleteCheckpoint = async (checkpointId) => {
             if (!currentGroupId) return;
            await deleteDoc(doc(db, 'groups', currentGroupId, 'checkpoints', checkpointId));
            map.closePopup();
        }
        
        document.addEventListener('DOMContentLoaded', initMap);
        setupModal();
    </script>
</body>
</html>

