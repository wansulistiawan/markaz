<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pelacak Rider - Mode Navigasi</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        #map { height: 70vh; z-index: 10; background-color: #4a5568; }
        .map-locked { cursor: not-allowed; }
        body { font-family: 'Inter', sans-serif; }
        .hidden { display: none; }
        
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #2d3748; color: #e2e8f0; border-radius: 8px; }
        .user-popup { display: flex; align-items: center; gap: 10px; }
        .user-popup img { border-radius: 50%; width: 40px; height: 40px; }
        .user-popup button { background-color: #10B981; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer; }

        #pin-settings-modal input:checked + label { outline: 3px solid #6EE7B7; transform: scale(1.1); }

        #navigation-controls {
            transition: transform 0.3s ease-in-out;
            transform: translateY(200%);
        }
        #navigation-controls.visible {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div class="container mx-auto p-4 max-w-6xl">
        <header class="flex justify-between items-center mb-4 flex-wrap gap-4">
            <div><h1 class="text-2xl md:text-3xl font-bold text-emerald-400">Rider Real-Time Tracker</h1><p id="subtitle" class="text-gray-400">Klik peta atau cari untuk pratinjau rute.</p></div>
            <div id="auth-container" class="flex items-center gap-4">
                <button id="settings-btn" class="hidden bg-gray-600 hover:bg-gray-700 p-3 rounded-full" title="Ubah Pin Anda"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button>
                <div id="user-info" class="hidden items-center gap-3 text-right"><div><p id="user-name" class="font-semibold"></p><button id="logout-btn" class="text-sm text-red-400 hover:underline">Logout</button></div><img id="user-pic" class="w-12 h-12 rounded-full border-2 border-emerald-400"></div>
                <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 488 512"><path d="M488 261.8C488 403.3 381.5 504 248 504 110.8 504 0 393.2 0 256S110.8 8 248 8c66.8 0 126 23.4 172.9 61.9l-72.2 64.5C305.1 102.8 277.6 88 248 88c-86.5 0-155.2 67.8-155.2 151.3s68.7 151.3 155.2 151.3c92.8 0 132-61.1 135-95.2H248v-73.8h238.2c2.6 13.2 4.2 27.8 4.2 43.8z"></path></svg> Login</button>
            </div>
        </header>

        <div id="controls-bar" class="my-4 flex flex-col md:flex-row justify-center items-center gap-4 flex-wrap">
             <form id="search-form" class="flex-grow max-w-lg w-full"><div class="relative"><input type="text" id="search-input" placeholder="Cari alamat atau nama tempat..." class="w-full bg-gray-700 text-white rounded-lg py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-emerald-500"><button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 p-1 bg-emerald-600 rounded-full hover:bg-emerald-700"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></button></div></form>
             <button id="recenter-btn" class="hidden bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg> Pusatkan Lokasi</button>
             <label id="share-control" class="hidden relative items-center cursor-pointer"><input type="checkbox" id="share-public-toggle" class="sr-only peer"><div class="w-14 h-7 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-emerald-600"></div><span class="ml-3 font-medium text-gray-300">Bagikan Lokasi</span></label>
        </div>

        <main>
            <div id="map-container" class="rounded-2xl shadow-2xl overflow-hidden border-2 border-gray-700 relative">
                <div id="map"></div>
                <div id="navigation-controls" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex gap-4 bg-gray-800 bg-opacity-80 backdrop-blur-sm p-3 rounded-xl shadow-lg">
                    <button id="set-destination-btn" class="hidden bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-5 rounded-lg">Tetapkan Tujuan</button>
                    <button id="start-nav-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">Mulai Navigasi</button>
                    <button id="stop-nav-btn" class="hidden bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-2 px-5 rounded-lg">Hentikan Navigasi</button>
                    <button id="cancel-route-btn" class="hidden bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-lg">Batal</button>
                </div>
            </div>
        </main>
        <footer><div id="status" class="mt-4 p-3 bg-gray-800 rounded-lg text-center">Silakan login untuk memulai.</div></footer>
    </div>

    <div id="pin-settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-2xl max-h-full overflow-y-auto"><h2 class="text-2xl font-bold mb-4 text-emerald-400">Kustomisasi Pin Anda</h2><div class="mb-6"><h3 class="font-semibold mb-3 text-gray-300">Pilih Warna</h3><div id="color-options" class="flex gap-3 flex-wrap"></div></div><div class="mb-6"><h3 class="font-semibold mb-3 text-gray-300">Pilih Ikon</h3><div id="icon-options" class="flex gap-3 flex-wrap justify-center"></div></div><div class="flex justify-end gap-4"><button id="cancel-settings-btn" class="bg-gray-600 hover:bg-gray-700 font-bold py-2 px-4 rounded-lg">Batal</button><button id="save-settings-btn" class="bg-emerald-600 hover:bg-emerald-700 font-bold py-2 px-4 rounded-lg">Simpan</button></div></div></div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyA9fthcIZ_VQXMUL6lPd-165NIFNb09JOA", authDomain: "aplikasi-touring.firebaseapp.com", projectId: "aplikasi-touring", storageBucket: "aplikasi-touring.appspot.com", messagingSenderId: "310021643774", appId: "1:310021643774:web:4943db8f567e66aef174af", measurementId: "G-ZRCCNLC8WB" };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let map, myMarker, userCoords = null, routingControl = null, destinationMarker = null;
        let isSharingPublicly = false;
        let publicRidersUnsubscribe = null;
        const publicMarkers = {};
        let currentUserSettings = { pinColor: '#3498db', pinIcon: 'motorcycle' };
        let currentRouteState = 'IDLE'; // IDLE, PREVIEW, SET, NAVIGATING
        let previewRouteInfo = null;

        const DOM = {
            map: document.getElementById('map'), subtitle: document.getElementById('subtitle'), status: document.getElementById('status'),
            loginBtn: document.getElementById('login-btn'), logoutBtn: document.getElementById('logout-btn'),
            userInfo: document.getElementById('user-info'), userName: document.getElementById('user-name'), userPic: document.getElementById('user-pic'),
            shareControl: document.getElementById('share-control'), shareToggle: document.getElementById('share-public-toggle'),
            settingsBtn: document.getElementById('settings-btn'), modal: document.getElementById('pin-settings-modal'),
            recenterBtn: document.getElementById('recenter-btn'),
            cancelSettingsBtn: document.getElementById('cancel-settings-btn'), saveSettingsBtn: document.getElementById('save-settings-btn'),
            colorOptions: document.getElementById('color-options'), iconOptions: document.getElementById('icon-options'),
            searchForm: document.getElementById('search-form'), searchInput: document.getElementById('search-input'),
            navControls: document.getElementById('navigation-controls'),
            setDestinationBtn: document.getElementById('set-destination-btn'),
            startNavBtn: document.getElementById('start-nav-btn'),
            stopNavBtn: document.getElementById('stop-nav-btn'),
            cancelRouteBtn: document.getElementById('cancel-route-btn'),
        };

        const availableIcons = {
            motorcycle: '<path d="M15.5 13.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zm-10 0a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM17 6.5a1 1 0 00-1-1h-2.28a1 1 0 00-.97.72L12 9.5h3.5a1 1 0 001-1v-2zM4.72 5.5H7.5a1 1 0 011 1v2a1 1 0 01-1-1H4a1 1 0 01-1-1v-1.28a1 1 0 01.72-.97L4.72 5.5zM12.5 3a1 1 0 00-1-1h-3a1 1 0 00-1 1v1.5H6a2 2 0 00-2 2V11a2 2 0 002 2h1.5a4.5 4.5 0 109 0H18a2 2 0 002-2V6.5a2 2 0 00-2-2h-1.5V3z"></path>',
            scooter: '<path fill-rule="evenodd" d="M13 12a1 1 0 100-2H8.414l1.293-1.293a1 1 0 10-1.414-1.414L6 9.586V12h7zm5 0a1 1 0 100-2h-1a1 1 0 100 2h1zM6.5 15.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm7.5 0a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM4 5a1 1 0 011-1h1a1 1 0 011 1v1h1a1 1 0 100-2H7a3 3 0 00-3 3v2.586l-1.293-1.293a1 1 0 00-1.414 1.414L3.586 11H3a1 1 0 100 2h.586l2.707 2.707a1 1 0 001.414 0L10 14.414V14a1 1 0 10-2 0v1.5a1.5 1.5 0 002.555 1.28L15 15.172V15a1 1 0 10-2 0v2a1 1 0 102 0v-2.172a2 2 0 00-.586-1.414l-1.707-1.707A1 1 0 0012 11V6a1 1 0 011-1h2a1 1 0 110 2h-1v5a1 1 0 102 0V6a3 3 0 00-3-3h-2a3 3 0 00-3 3v5.414l-1-1V5z" clip-rule="evenodd" />',
            bicycle: '<path fill-rule="evenodd" d="M9.5 15.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm-2-11a1 1 0 100 2h2a1 1 0 100-2h-2zM15 14a1 1 0 01-1-1v-1.162l-1.624.812a1 1 0 01-1.23-.36l-1.02-1.785a1 1 0 01.36-1.23L12.11 7H11a1 1 0 110-2h3a1 1 0 011 1v5.382l1.624-.812a1 1 0 011.23.36l1.02 1.785a1 1 0 01-.36 1.23L17.89 13H18a1 1 0 110 2h-3zm-9.5 1.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" clip-rule="evenodd" />',
            motocross: '<path d="M13.5 15.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm-7-1.5a1.5 1.5 0 100-3 1.5 1.5 0 000 3zm11-6.5l-2.09-.7a1 1 0 00-1.18.27l-1.44 1.44a1 1 0 01-1.41 0l-1.32-1.32a1 1 0 00-1.41 0L8.2 8.65a1 1 0 01-1.41 0L6.07 7.94a1 1 0 00-1.18-.27L2.8 8.42a1 1 0 00-.8 1.9l1.4.47.05.01a1 1 0 00.95-.53l.8-1.6a1 1 0 011.78.1l.6 1.2a1 1 0 001.78-.1l1.32-1.32a1 1 0 011.41 0l1.44 1.44a1 1 0 001.41 0l.96-.96a1 1 0 00.27-1.18zM15 3a1 1 0 100 2h3a1 1 0 100-2h-3z"></path>',
            person: '<path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>',
            car: '<path fill-rule="evenodd" d="M18 8a2 2 0 00-2-2H4a2 2 0 00-2 2v4a2 2 0 002 2h.5a1 1 0 011-1h8a1 1 0 011 1H16a2 2 0 002-2V8zm-2 2H4V8h12v2zM5 14a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>',
            truck: '<path d="M17.293 4.293A1 1 0 0118 5v10a1 1 0 01-1 1h-1a1 1 0 01-1-1v-1H5v1a1 1 0 01-1 1H3a1 1 0 01-1-1V5a1 1 0 011-1h1.293a1 1 0 01.948.684l1.21 3.026A1 1 0 007 9h4a1 1 0 00.948-.684l1.21-3.026A1 1 0 0114.101 4H16v-.707a1 1 0 01.293-.707zM5 12h10V9H5v3z"></path>',
            suv: '<path fill-rule="evenodd" d="M17 5a3 3 0 013 3v4a1 1 0 01-1 1h-1a1 1 0 01-1-1v-1h- şirket3a1 1 0 110-2h4V8a1 1 0 00-1-1h-1a1 1 0 100 2h1v1H6V8a1 1 0 00-1-1H4a1 1 0 100 2h1v1H3a1 1 0 110-2h1V8a3 3 0 013-3h8zM5 14a1 1 0 100 2h10a1 1 0 100-2H5z" clip-rule="evenodd" />',
            bus: '<path fill-rule="evenodd" d="M18.25 4.5a.75.75 0 00-1.5 0V6h-12V4.5a.75.75 0 00-1.5 0V6a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-1V4.5zM4 10a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zm1 5a1 1 0 100-2 1 1 0 000 2zm10 0a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />',
            flag: '<path fill-rule="evenodd" d="M3 3a1 1 0 000 2v11a1 1 0 100 2h14a1 1 0 100-2V7a1 1 0 00-1-1H4V5a1 1 0 00-1-1H3zm3 3a1 1 0 011-1h8a1 1 0 110 2H7a1 1 0 01-1-1z" clip-rule="evenodd"></path>',
            star: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293z" clip-rule="evenodd"></path>',
            wrench: '<path fill-rule="evenodd" d="M11.49 3.17a1 1 0 00-1.415 0l-7.29 7.29a1 1 0 000 1.414l5.656 5.657a1 1 0 001.415 0l7.29-7.29a1 1 0 000-1.414l-5.656-5.657zM12.904 4.585l4.242 4.243-7.29 7.29-4.242-4.243 7.29-7.29zM12.903 8.414a1.5 1.5 0 112.122-2.122 1.5 1.5 0 01-2.122 2.122zM7.12 14.122l2.122-2.122 2.12 2.122-2.12 2.12-2.122-2.12z" clip-rule="evenodd" />',
            aid: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>',
            coffee: '<path d="M10 3a1 1 0 011 1v1h2a1 1 0 011 1v2a1 1 0 01-1 1h-2.586l.293.293a1 1 0 010 1.414l-4 4A1 1 0 015 13.414V12a1 1 0 011-1h1V5a1 1 0 011-1h2a1 1 0 011 1v.586l.293-.293A1 1 0 0112 5.586V5a2 2 0 00-2-2H8a2 2 0 00-2 2v6a2 2 0 002 2h2.586l4.707 4.707a1 1 0 001.414-1.414L10 12.586V11a1 1 0 011-1h2a2 2 0 002-2V6a2 2 0 00-2-2h-1V4a1 1 0 01-1-1z" />',
            food: '<path fill-rule="evenodd" d="M8.25 4.5a.75.75 0 000 1.5h3.5a.75.75 0 000-1.5h-3.5zM4.5 8.25a.75.75 0 01.75-.75h10a.75.75 0 010 1.5h-10a.75.75 0 01-.75-.75zM4 12a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1z" clip-rule="evenodd" />',
            tent: '<path fill-rule="evenodd" d="M10 2a1 1 0 00-1 1v1.28a1 1 0 01-.553.894L2.447 8.118A1 1 0 002 9v7a1 1 0 001 1h14a1 1 0 001-1V9a1 1 0 00-.447-.882l-6-2.944a1 1 0 01-.553-.894V3a1 1 0 00-1-1h-2zm-1 3.414l5 2.458V15H6V7.872l4-1.958V5.414zM11 13a1 1 0 11-2 0 1 1 0 012 0z" clip-rule="evenodd" />',
            run: '<path fill-rule="evenodd" d="M10 4a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zm-.5 4.207a1 1 0 00-1.414 1.414l2.5 2.5a1 1 0 001.414 0l4.5-4.5a1 1 0 00-1.414-1.414L11 10.086l-1.5-1.5zM10.5 15a1.5 1.5 0 10-3 0v1a1.5 1.5 0 103 0v-1z" clip-rule="evenodd" />',
            question: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-1 1v1a1 1 0 102 0V8a1 1 0 00-1-1zm1 5a1 1 0 10-2 0v.01a1 1 0 102 0V12z" clip-rule="evenodd" />',
            alert: '<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />',
            shopping: '<path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.97 1.228H15.42a1 1 0 00.97-1.228l-1.38-5.52a1 1 0 00-.97-1.222H4.42a1 1 0 00-.97 1.222L3.75 4H2a1 1 0 00-1-1H.99a1 1 0 00-1 1v.01A1 1 0 001 4h1.01l1.38 5.52a2.997 2.997 0 002.91 2.48h8.4a2.997 2.997 0 002.91-2.48L19.22 5.44A2 2 0 0017.27 3H4.88l-.26-1.04A2 2 0 002.72 1H3z"></path><path d="M7 15a2 2 0 100 4 2 2 0 000-4zM15 15a2 2 0 100 4 2 2 0 000-4z"></path>',
        };

        function createCustomIcon(color, iconName) {
            const iconPath = availableIcons[iconName] || availableIcons.person;
            const iconHtml = `<svg width="64" height="64" viewBox="0 0 32 32"><path fill="${color}" stroke="#1a202c" stroke-width="1.5" d="M16 31.547c0 0 10-13.235 10-20.547a10 10 0 10-20 0c0 7.312 10 20.547 10 20.547z"></path><svg x="6" y="5" width="20" height="20" viewBox="0 0 20 20" fill="white">${iconPath}</svg></svg>`;
            return L.divIcon({ html: iconHtml, className: 'custom-div-icon', iconSize: [64, 64], iconAnchor: [32, 64], popupAnchor: [0, -64] });
        }
        
        function initMap() {
            map = L.map('map').setView([-6.2088, 106.8456], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
            map.on('click', (e) => {
                if (currentRouteState !== 'IDLE' || !auth.currentUser || !userCoords) return;
                const dest = [e.latlng.lat, e.latlng.lng];
                window.showRouteTo(dest, 'Titik Dipilih');
            });
        }
        
        function setRouteState(newState) {
            currentRouteState = newState;
            updateNavControlsUI();
        }

        function updateNavControlsUI() {
            const isVisible = (currentRouteState !== 'IDLE');
            DOM.navControls.classList.toggle('visible', isVisible);
            
            [DOM.setDestinationBtn, DOM.startNavBtn, DOM.stopNavBtn, DOM.cancelRouteBtn].forEach(btn => btn.classList.add('hidden'));

            if (currentRouteState === 'PREVIEW') {
                DOM.setDestinationBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                DOM.status.textContent = 'Rute pratinjau. Tetapkan tujuan untuk melanjutkan.';
                DOM.subtitle.textContent = 'Sebuah rute sedang ditampilkan...';
                DOM.map.classList.add('map-locked');
            } else if (currentRouteState === 'SET') {
                DOM.startNavBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                DOM.status.textContent = 'Tujuan ditetapkan. Siap untuk memulai navigasi.';
                DOM.subtitle.textContent = 'Tujuan telah ditetapkan.';
            } else if (currentRouteState === 'NAVIGATING') {
                DOM.stopNavBtn.classList.remove('hidden');
                DOM.cancelRouteBtn.classList.remove('hidden');
                DOM.status.textContent = 'Mode navigasi aktif. Peta akan mengikuti Anda.';
                DOM.subtitle.textContent = 'Dalam mode navigasi...';
            } else { // IDLE
                DOM.status.textContent = userCoords ? `Akurasi: ${Math.round(userCoords.accuracy)}m` : 'Mencari lokasi...';
                DOM.subtitle.textContent = 'Klik peta atau cari untuk pratinjau rute.';
                DOM.map.classList.remove('map-locked');
            }
        }
        
        DOM.setDestinationBtn.addEventListener('click', () => {
            if (currentRouteState !== 'PREVIEW' || !previewRouteInfo) return;
            setRouteState('SET');
        });

        DOM.startNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'SET') return;
            setRouteState('NAVIGATING');
            if(userCoords) map.setView(userCoords, 18, {animate: true});
        });
        
        DOM.stopNavBtn.addEventListener('click', () => {
            if (currentRouteState !== 'NAVIGATING') return;
            setRouteState('SET');
        });

        DOM.cancelRouteBtn.addEventListener('click', () => {
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            routingControl = null; destinationMarker = null; previewRouteInfo = null;
            setRouteState('IDLE');
        });

        onAuthStateChanged(auth, user => {
            if (user) {
                DOM.userInfo.classList.remove('hidden'); DOM.userInfo.classList.add('flex'); DOM.loginBtn.classList.add('hidden');
                DOM.userName.textContent = user.displayName; DOM.userPic.src = user.photoURL;
                DOM.shareControl.classList.remove('hidden'); DOM.shareControl.classList.add('inline-flex'); DOM.settingsBtn.classList.remove('hidden'); DOM.recenterBtn.classList.remove('hidden');
                DOM.status.textContent = 'Mencari lokasi Anda...';
                startLocationWatch(); listenToPublicRiders();
            } else {
                DOM.userInfo.classList.add('hidden'); DOM.loginBtn.classList.remove('hidden'); DOM.shareControl.classList.add('hidden'); DOM.settingsBtn.classList.add('hidden'); DOM.recenterBtn.classList.add('hidden');
                DOM.status.textContent = 'Silakan login untuk memulai.';
                if (myMarker) map.removeLayer(myMarker);
                DOM.cancelRouteBtn.click();
                if (publicRidersUnsubscribe) publicRidersUnsubscribe(); Object.values(publicMarkers).forEach(marker => map.removeLayer(marker));
            }
        });

        DOM.loginBtn.addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()).catch(err => console.error(err)));
        DOM.logoutBtn.addEventListener('click', async () => { if (auth.currentUser) await removeLocationFromFirestore(auth.currentUser.uid); signOut(auth); });
        
        function startLocationWatch() { if (navigator.geolocation) { navigator.geolocation.watchPosition(updateLocation, (err) => DOM.status.textContent = `Error Lokasi: ${err.message}`, { enableHighAccuracy: true }); } }
        
        function updateLocation(position) {
            userCoords = [position.coords.latitude, position.coords.longitude];
            userCoords.accuracy = position.coords.accuracy;

            if (currentRouteState === 'IDLE') DOM.status.textContent = `Akurasi: ${Math.round(userCoords.accuracy)}m`;
            
            if (!myMarker) {
                myMarker = L.marker(userCoords, { icon: createCustomIcon(currentUserSettings.pinColor, currentUserSettings.pinIcon) }).addTo(map).bindPopup('<b>Ini Anda!</b>');
                map.setView(userCoords, 16);
            } else { myMarker.setLatLng(userCoords); }
            
            if (currentRouteState === 'NAVIGATING') {
                map.setView(userCoords, 18, {animate: true, pan: {duration: 1}});
            }

            if (isSharingPublicly && auth.currentUser) updateLocationInFirestore(auth.currentUser);
        }

        DOM.recenterBtn.addEventListener('click', () => {
            if (userCoords) { map.setView(userCoords, 16, {animate: true}); } 
            else { DOM.status.textContent = 'Lokasi Anda belum ditemukan untuk dipusatkan.'; }
        });

        DOM.shareToggle.addEventListener('change', () => {
            isSharingPublicly = DOM.shareToggle.checked; if (!auth.currentUser) return;
            if (isSharingPublicly) {
                if (userCoords) { updateLocationInFirestore(auth.currentUser); DOM.status.textContent = 'Lokasi Anda sekarang publik.'; } 
                else { DOM.status.textContent = 'Tunggu lokasi ditemukan.'; DOM.shareToggle.checked = isSharingPublicly = false; }
            } else { removeLocationFromFirestore(auth.currentUser.uid); DOM.status.textContent = 'Lokasi Anda tidak lagi publik.'; }
        });

        async function updateLocationInFirestore(user) {
            if (!userCoords) return;
            await setDoc(doc(db, 'public_riders', user.uid), {
                name: user.displayName, photoURL: user.photoURL, lat: userCoords[0], lng: userCoords[1],
                lastUpdate: new Date(), pinColor: currentUserSettings.pinColor, pinIcon: currentUserSettings.pinIcon
            }, { merge: true });
        }
        
        async function removeLocationFromFirestore(uid) { await deleteDoc(doc(db, "public_riders", uid)); }

        function listenToPublicRiders() {
            publicRidersUnsubscribe = onSnapshot(collection(db, 'public_riders'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const riderData = change.doc.data(); const riderId = change.doc.id;
                    if (riderId === auth.currentUser?.uid) {
                        currentUserSettings.pinColor = riderData.pinColor || '#3498db';
                        currentUserSettings.pinIcon = riderData.pinIcon || 'motorcycle';
                        if (myMarker) myMarker.setIcon(createCustomIcon(currentUserSettings.pinColor, currentUserSettings.pinIcon));
                        return;
                    }
                    if (change.type === "added" || change.type === "modified") {
                        if (publicMarkers[riderId]) map.removeLayer(publicMarkers[riderId]);
                        const riderCoords = [riderData.lat, riderData.lng];
                        const icon = createCustomIcon(riderData.pinColor || '#34495e', riderData.pinIcon || 'person');
                        const popupContent = `<div class="user-popup"><img src="${riderData.photoURL}" alt="foto"><div><strong>${riderData.name}</strong><br><button onclick="window.showRouteTo([${riderCoords}], '${riderData.name.replace(/'/g, "\\'")}')">Rute ke Sini</button></div></div>`;
                        publicMarkers[riderId] = L.marker(riderCoords, { icon: icon }).addTo(map).bindPopup(popupContent);
                    } else if (change.type === "removed") { if (publicMarkers[riderId]) { map.removeLayer(publicMarkers[riderId]); delete publicMarkers[riderId]; } }
                });
            });
        }
        
        window.showRouteTo = (destinationCoords, destinationName = 'Tujuan') => {
            if (currentRouteState !== 'IDLE') { DOM.status.textContent = 'Batalkan rute saat ini untuk membuat rute baru.'; return; }
            if (!userCoords) { alert("Lokasi Anda belum ditemukan."); return; }
            if (routingControl) map.removeControl(routingControl);
            if (destinationMarker) map.removeLayer(destinationMarker);
            
            previewRouteInfo = { coords: destinationCoords, name: destinationName };
            destinationMarker = L.marker(destinationCoords, { icon: createCustomIcon('#e74c3c', 'flag')}).addTo(map).bindPopup(`<b>${destinationName}</b>`).openPopup();
            routingControl = L.Routing.control({
                waypoints: [ L.latLng(userCoords), L.latLng(destinationCoords) ], routeWhileDragging: false,
                lineOptions: { styles: [{color: '#6EE7B7', weight: 5}] }, createMarker: () => null
            }).addTo(map);

            setRouteState('PREVIEW');
        }

        DOM.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault(); 
            if (currentRouteState !== 'IDLE') { DOM.status.textContent = 'Batalkan rute saat ini untuk mencari rute baru.'; return; }
            const query = DOM.searchInput.value; if (!query) return;
            DOM.status.textContent = `Mencari "${query}"...`;
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`); const data = await res.json();
                if (data && data.length > 0) {
                    const { lat, lon, display_name } = data[0];
                    showRouteTo([lat, lon], display_name); map.setView([lat, lon], 14);
                } else { DOM.status.textContent = `Lokasi "${query}" tidak ditemukan.`; }
            } catch (error) { DOM.status.textContent = 'Gagal melakukan pencarian.'; }
        });

        function setupModal() {
            DOM.colorOptions.innerHTML = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6', '#34495e', '#ffffff'].map(c => `<div><input type="radio" name="color" value="${c}" id="c-${c}" class="sr-only"><label for="c-${c}" class="block w-8 h-8 rounded-full cursor-pointer border-2 border-gray-500" style="background-color:${c};"></label></div>`).join('');
            DOM.iconOptions.innerHTML = Object.keys(availableIcons).map(i => `<div><input type="radio" name="icon" value="${i}" id="i-${i}" class="sr-only"><label for="i-${i}" class="block p-2 rounded-lg cursor-pointer border-2 border-gray-500 bg-gray-600 transition-transform">${availableIcons[i]}</label></div>`.replace('<path', '<svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20"><path')).join('');
        }
        DOM.settingsBtn.addEventListener('click', () => {
            document.querySelector(`input[name="color"][value="${currentUserSettings.pinColor}"]`).checked = true;
            document.querySelector(`input[name="icon"][value="${currentUserSettings.pinIcon}"]`).checked = true;
            DOM.modal.classList.remove('hidden');
        });
        DOM.saveSettingsBtn.addEventListener('click', async () => {
            currentUserSettings.pinColor = document.querySelector('input[name="color"]:checked').value;
            currentUserSettings.pinIcon = document.querySelector('input[name="icon"]:checked').value;
            if (auth.currentUser) await updateLocationInFirestore(auth.currentUser);
            DOM.modal.classList.add('hidden');
        });
        DOM.cancelSettingsBtn.addEventListener('click', () => DOM.modal.classList.add('hidden'));
        
        initMap(); setupModal();
    </script>
</body>
</html>
