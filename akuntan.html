import React, { useState, useEffect, useMemo } from 'react';
import { 
  LayoutDashboard, PlusCircle, FileText, TrendingUp, AlertTriangle, 
  Trash2, Save, DollarSign, Utensils, Users, Calendar, Printer, 
  Clock, Banknote, UserPlus, CheckSquare, XCircle, RefreshCw,
  MapPin, Navigation, Calculator, Package, Download, BarChart3
} from 'lucide-react';

// --- 1. DATA STATIS ---
const INITIAL_EXPENSES = [
  { id: 173101, date: '2025-11-01', item: 'Beras Premium', category: 'Bahan Baku (Lauk Protein)', qty: 100, unit: 'kg', price: 13500, total: 1350000, tax: 0, vendor: 'Toko Jaya Abadi', type: 'Stok' },
  { id: 173102, date: '2025-11-01', item: 'Kompor Mawar High Pressure', category: 'Aset Tetap', qty: 2, unit: 'set', price: 1500000, total: 3000000, tax: 330000, vendor: 'CV Dapur Nusantara', type: 'Aset' }, 
];

const INITIAL_EMPLOYEES = [
  { id: 'emp_001', name: 'Budi Santoso', role: 'Kepala Dapur', type: 'Bulanan', basicRate: 4500000, overtimeRate: 25000, taxRate: 5 }, 
  { id: 'emp_002', name: 'Siti Aminah', role: 'Juru Masak', type: 'Harian', basicRate: 120000, overtimeRate: 15000, taxRate: 0 }, 
];

const INITIAL_ATTENDANCE = [
  { id: 'att_1', employeeId: 'emp_001', date: '2025-11-01', timeIn: '07:00', status: 'Hadir', overtime: 2 },
  { id: 'att_2', employeeId: 'emp_002', date: '2025-11-01', timeIn: '07:15', status: 'Hadir', overtime: 0 },
];

const INITIAL_STOCK = [
  { id: 'stk_1', name: 'Beras Premium', unit: 'kg', in: 100, out: 20, current: 80 },
  { id: 'stk_2', name: 'Minyak Goreng', unit: 'liter', in: 50, out: 5, current: 45 },
];

const INITIAL_BUDGET = 150000000; // Contoh Pagu Anggaran Bulan Ini

// --- Helper ---
const formatRupiah = (num) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);

export default function MBGFinalSystem() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [salaryPeriod, setSalaryPeriod] = useState('2025-11');
  const [lpjPeriod, setLpjPeriod] = useState('2025-11');
  const [selectedSlip, setSelectedSlip] = useState(null);

  // --- LOCAL STORAGE ---
  const useStickyState = (key, defaultValue) => {
    const [value, setValue] = useState(() => {
      const stickyValue = window.localStorage.getItem(key);
      return stickyValue !== null ? JSON.parse(stickyValue) : defaultValue;
    });
    useEffect(() => { window.localStorage.setItem(key, JSON.stringify(value)); }, [key, value]);
    return [value, setValue];
  };

  const [expenses, setExpenses] = useStickyState('mbg_final_expenses_v2', INITIAL_EXPENSES);
  const [employees, setEmployees] = useStickyState('mbg_final_employees_v2', INITIAL_EMPLOYEES);
  const [attendanceData, setAttendanceData] = useStickyState('mbg_final_attendance_v2', INITIAL_ATTENDANCE);
  const [stockData, setStockData] = useStickyState('mbg_final_stock_v2', INITIAL_STOCK);
  const [budgetLimit, setBudgetLimit] = useStickyState('mbg_final_budget_v2', INITIAL_BUDGET);

  // --- FORMS ---
  const [formData, setFormData] = useState({
    item: '', category: 'Bahan Baku (Lauk Protein)', qty: 1, unit: 'kg', price: 0, vendor: '', tax: 0, type: 'Habis Pakai', date: new Date().toISOString().split('T')[0]
  });
  
  const [stockUsageForm, setStockUsageForm] = useState({ id: '', qty: 0 });

  // --- GPS Logic ---
  const [gpsStatus, setGpsStatus] = useState('Siap');
  const [currentLocation, setCurrentLocation] = useState(null);
  const [selectedEmpForClockIn, setSelectedEmpForClockIn] = useState('');

  // --- CALCULATIONS ---
  
  // 1. Payroll + PPh 21
  const calculatedPayroll = useMemo(() => {
    if (!salaryPeriod) return [];
    return employees.map(emp => {
      const records = attendanceData.filter(r => r.employeeId === emp.id && r.date.startsWith(salaryPeriod));
      const days = records.filter(r => r.status === 'Hadir').length;
      const otHours = records.reduce((sum, r) => sum + (r.overtime || 0), 0);
      
      const basic = emp.type === 'Harian' ? days * emp.basicRate : emp.basicRate;
      const otPay = otHours * emp.overtimeRate;
      const gross = basic + otPay;
      const tax = gross * (emp.taxRate / 100); // PPh 21
      
      return { ...emp, gross, tax, net: gross - tax, days, otHours };
    });
  }, [employees, attendanceData, salaryPeriod]);

  // 2. LPJ Data Aggregation (Expenses + Payroll)
  const lpjData = useMemo(() => {
    const periodExpenses = expenses.filter(e => e.date.startsWith(lpjPeriod)).map(e => ({
      date: e.date,
      desc: `Belanja: ${e.item} (${e.qty} ${e.unit})`,
      debet: 0,
      kredit: e.total,
      tax: e.tax || 0,
      type: e.type === 'Aset' ? 'Belanja Modal (Aset)' : 'Belanja Barang'
    }));

    const payrollForLpj = employees.map(emp => {
      const records = attendanceData.filter(r => r.employeeId === emp.id && r.date.startsWith(lpjPeriod));
      const days = records.filter(r => r.status === 'Hadir').length;
      if (days === 0 && emp.type === 'Harian') return null;

      const otHours = records.reduce((sum, r) => sum + (r.overtime || 0), 0);
      const basic = emp.type === 'Harian' ? days * emp.basicRate : emp.basicRate;
      const gross = basic + (otHours * emp.overtimeRate);
      const tax = gross * (emp.taxRate / 100);

      return {
        date: `${lpjPeriod}-28`, 
        desc: `Gaji & Tunjangan: ${emp.name}`,
        debet: 0,
        kredit: gross, 
        tax: tax, 
        type: 'Belanja Pegawai'
      };
    }).filter(Boolean);

    return [...periodExpenses, ...payrollForLpj].sort((a, b) => new Date(a.date) - new Date(b.date));
  }, [expenses, employees, attendanceData, lpjPeriod]);

  const totalRealization = useMemo(() => lpjData.reduce((a,b) => a + b.kredit, 0), [lpjData]);

  // --- HANDLERS ---
  const handleAddExpense = (e) => {
    e.preventDefault();
    const total = Number(formData.qty) * Number(formData.price);
    
    // 1. Add Expense Record
    setExpenses([{ id: Date.now(), ...formData, qty: Number(formData.qty), price: Number(formData.price), tax: Number(formData.tax), total }, ...expenses]);
    
    // 2. Auto-Update Stock if type is Stock
    if (formData.type === 'Stok') {
      const existingStock = stockData.find(s => s.name.toLowerCase() === formData.item.toLowerCase());
      if (existingStock) {
         setStockData(stockData.map(s => s.id === existingStock.id ? { ...s, in: s.in + Number(formData.qty), current: s.current + Number(formData.qty) } : s));
      } else {
         setStockData([...stockData, { id: `stk_${Date.now()}`, name: formData.item, unit: formData.unit, in: Number(formData.qty), out: 0, current: Number(formData.qty) }]);
      }
    }

    setFormData({ ...formData, item: '', qty: 1, price: 0, tax: 0 });
    alert('Transaksi tersimpan & Stok terupdate (jika barang stok)!');
  };

  const handleUseStock = (e) => {
     e.preventDefault();
     const { id, qty } = stockUsageForm;
     setStockData(stockData.map(s => s.id === id ? { ...s, out: s.out + Number(qty), current: s.current - Number(qty) } : s));
     setStockUsageForm({ id: '', qty: 0 });
     alert('Pemakaian stok tercatat!');
  };

  const handleClockIn = () => {
    if (!selectedEmpForClockIn) return alert('Pilih karyawan!');
    const today = new Date().toISOString().split('T')[0];
    if (attendanceData.find(a => a.employeeId === selectedEmpForClockIn && a.date === today)) return alert('Sudah absen!');
    
    setAttendanceData([{
      id: Date.now(),
      employeeId: selectedEmpForClockIn,
      date: today,
      timeIn: new Date().toLocaleTimeString('id-ID', {hour:'2-digit', minute:'2-digit'}),
      location: currentLocation ? `${currentLocation.lat}, ${currentLocation.lng}` : 'No GPS',
      status: 'Hadir',
      overtime: 0
    }, ...attendanceData]);
    alert('Berhasil Absen!');
    setSelectedEmpForClockIn('');
  };

  const downloadCSV = () => {
    const headers = ["Tanggal", "Uraian", "Jenis", "Nominal", "Pajak"];
    const rows = lpjData.map(d => [d.date, d.desc, d.type, d.kredit, d.tax]);
    const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].map(e => e.join(",")).join("\n");
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `Laporan_MBG_${lpjPeriod}.csv`);
    document.body.appendChild(link);
    link.click();
  };

  return (
    <div className="min-h-screen bg-gray-50 text-slate-800 font-sans pb-20">
      {/* Header */}
      <header className="bg-emerald-900 text-white p-4 sticky top-0 z-30 shadow-md">
        <div className="max-w-6xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-3">
            <div className="bg-white/10 p-2 rounded"><FileText size={24}/></div>
            <div><h1 className="font-bold text-lg">Sistem MBG Enterprise</h1><p className="text-xs text-emerald-300">Akuntansi, Stok & Pajak Terintegrasi</p></div>
          </div>
          <button onClick={() => {localStorage.clear(); window.location.reload()}} className="bg-red-600 px-3 py-1 rounded text-xs hover:bg-red-700">Reset Data</button>
        </div>
      </header>

      {/* Navigasi Tab */}
      <div className="bg-white border-b sticky top-[72px] z-20 overflow-x-auto shadow-sm">
        <div className="max-w-6xl mx-auto flex">
          {[
            {id:'dashboard', label:'Dashboard & Budget', icon:BarChart3},
            {id:'lpj', label:'Laporan & Audit', icon:FileText}, 
            {id:'keuangan', label:'Input Belanja', icon:DollarSign},
            {id:'stok', label:'Gudang Stok', icon:Package},
            {id:'absensi', label:'Absensi GPS', icon:MapPin},
            {id:'gaji', label:'Payroll', icon:Banknote},
          ].map(t => (
            <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex items-center gap-2 px-6 py-4 border-b-2 transition-colors ${activeTab===t.id ? 'border-emerald-600 text-emerald-800 font-bold bg-emerald-50' : 'border-transparent text-gray-500 hover:text-emerald-600'}`}>
              <t.icon size={18}/> {t.label}
            </button>
          ))}
        </div>
      </div>

      <main className="max-w-6xl mx-auto p-4 mt-4">

        {/* DASHBOARD & BUDGET CONTROL */}
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <div className="bg-white p-6 rounded-xl border shadow-sm">
               <div className="flex justify-between items-center mb-4">
                  <h3 className="font-bold text-lg flex items-center gap-2"><BarChart3/> Kontrol Anggaran (Budgeting)</h3>
                  <div className="text-sm text-gray-500">Pagu: {formatRupiah(budgetLimit)}</div>
               </div>
               {/* Budget Bar */}
               <div className="w-full bg-gray-200 rounded-full h-6 mb-2">
                  <div className={`h-6 rounded-full ${totalRealization > budgetLimit ? 'bg-red-600' : 'bg-emerald-600'}`} style={{width: `${Math.min((totalRealization/budgetLimit)*100, 100)}%`}}></div>
               </div>
               <div className="flex justify-between text-sm font-bold">
                  <span className="text-emerald-700">Realisasi: {formatRupiah(totalRealization)} ({(totalRealization/budgetLimit*100).toFixed(1)}%)</span>
                  <span className="text-gray-600">Sisa: {formatRupiah(budgetLimit - totalRealization)}</span>
               </div>
            </div>

            <div className="grid md:grid-cols-3 gap-4">
              <div className="bg-white p-6 rounded-xl border-l-4 border-blue-500 shadow-sm">
                <p className="text-gray-500 text-sm">Belanja Barang & Jasa</p>
                <h3 className="text-2xl font-bold">{formatRupiah(lpjData.filter(x=>x.type==='Belanja Barang').reduce((a,b)=>a+b.kredit,0))}</h3>
              </div>
              <div className="bg-white p-6 rounded-xl border-l-4 border-purple-500 shadow-sm">
                <p className="text-gray-500 text-sm">Belanja Pegawai</p>
                <h3 className="text-2xl font-bold">{formatRupiah(lpjData.filter(x=>x.type==='Belanja Pegawai').reduce((a,b)=>a+b.kredit,0))}</h3>
              </div>
              <div className="bg-white p-6 rounded-xl border-l-4 border-orange-500 shadow-sm">
                <p className="text-gray-500 text-sm">Belanja Modal (Aset)</p>
                <h3 className="text-2xl font-bold">{formatRupiah(lpjData.filter(x=>x.type==='Belanja Modal (Aset)').reduce((a,b)=>a+b.kredit,0))}</h3>
                <p className="text-xs text-gray-400 mt-1">Perlu Inventarisasi Aset</p>
              </div>
            </div>
          </div>
        )}

        {/* TAB LAPORAN LPJ & EXPORT */}
        {activeTab === 'lpj' && (
          <div className="space-y-6">
            <div className="bg-white p-4 rounded-xl shadow-sm border flex justify-between items-center">
               <div>
                 <h2 className="font-bold text-lg text-gray-800">Laporan Pertanggungjawaban (LPJ)</h2>
                 <p className="text-sm text-gray-500">Data siap audit (Expenses + Payroll)</p>
               </div>
               <div className="flex gap-3">
                 <input type="month" value={lpjPeriod} onChange={e=>setLpjPeriod(e.target.value)} className="border rounded p-2 text-sm"/>
                 <button onClick={downloadCSV} className="bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2 text-sm hover:bg-green-700"><Download size={16}/> Export Excel</button>
                 <button onClick={()=>window.print()} className="bg-emerald-900 text-white px-4 py-2 rounded flex items-center gap-2 text-sm"><Printer size={16}/> Cetak PDF</button>
               </div>
            </div>

            <div className="bg-white rounded-xl shadow-sm border overflow-hidden print:shadow-none print:border-0">
              <div className="p-8 print:p-0" id="print-area">
                <div className="text-center mb-6 hidden print:block">
                   <h2 className="font-bold text-xl uppercase">Laporan Realisasi Anggaran & Pajak</h2>
                   <p>Program Makan Bergizi Gratis - Periode {lpjPeriod}</p>
                </div>

                <table className="w-full text-sm border-collapse border border-gray-300">
                  <thead className="bg-gray-100 text-gray-700">
                    <tr>
                      <th className="border p-2 text-center w-10">No</th>
                      <th className="border p-2 text-left">Tanggal</th>
                      <th className="border p-2 text-left">Uraian Transaksi</th>
                      <th className="border p-2 text-center">Akun Belanja</th>
                      <th className="border p-2 text-right">Realisasi (Rp)</th>
                      <th className="border p-2 text-right bg-red-50 text-red-700">Pajak (Rp)</th>
                    </tr>
                  </thead>
                  <tbody>
                    {lpjData.map((row, idx) => (
                      <tr key={idx} className="hover:bg-gray-50">
                        <td className="border p-2 text-center">{idx+1}</td>
                        <td className="border p-2">{row.date}</td>
                        <td className="border p-2">{row.desc}</td>
                        <td className="border p-2 text-center text-xs font-bold text-gray-600">{row.type}</td>
                        <td className="border p-2 text-right font-medium">{formatRupiah(row.kredit)}</td>
                        <td className="border p-2 text-right text-red-600 bg-red-50">{row.tax > 0 ? formatRupiah(row.tax) : '-'}</td>
                      </tr>
                    ))}
                  </tbody>
                  <tfoot className="font-bold bg-gray-100">
                    <tr>
                      <td colSpan="4" className="border p-2 text-right">TOTAL REALISASI:</td>
                      <td className="border p-2 text-right text-emerald-800">{formatRupiah(lpjData.reduce((a,b)=>a+b.kredit, 0))}</td>
                      <td className="border p-2 text-right text-red-700">{formatRupiah(lpjData.reduce((a,b)=>a+b.tax, 0))}</td>
                    </tr>
                  </tfoot>
                </table>
              </div>
            </div>
          </div>
        )}

        {/* INPUT KEUANGAN + STOK LINKING */}
        {activeTab === 'keuangan' && (
          <div className="grid md:grid-cols-3 gap-6">
            <div className="md:col-span-1 bg-white p-5 rounded-xl border shadow-sm">
              <h3 className="font-bold mb-4 flex items-center gap-2"><PlusCircle size={18}/> Input Belanja</h3>
              <form onSubmit={handleAddExpense} className="space-y-3 text-sm">
                <input type="date" required className="w-full border p-2 rounded" value={formData.date} onChange={e=>setFormData({...formData, date:e.target.value})}/>
                <select className="w-full border p-2 rounded bg-blue-50 font-bold" value={formData.type} onChange={e=>setFormData({...formData, type:e.target.value})}>
                  <option value="Habis Pakai">Belanja Barang (Habis Pakai)</option>
                  <option value="Stok">Belanja Persediaan (Masuk Stok)</option>
                  <option value="Aset">Belanja Modal (Aset Tetap)</option>
                  <option value="Jasa">Belanja Jasa</option>
                </select>
                <input type="text" placeholder="Nama Barang" required className="w-full border p-2 rounded" value={formData.item} onChange={e=>setFormData({...formData, item:e.target.value})}/>
                <select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>
                  <option>Bahan Baku (Protein)</option><option>Bahan Baku (Sayur)</option><option>Inventaris</option><option>Operasional</option>
                </select>
                <div className="grid grid-cols-2 gap-2">
                   <input type="number" placeholder="Qty" required className="w-full border p-2 rounded" value={formData.qty} onChange={e=>setFormData({...formData, qty:e.target.value})}/>
                   <input type="text" placeholder="Satuan (Kg/Ltr)" required className="w-full border p-2 rounded" value={formData.unit} onChange={e=>setFormData({...formData, unit:e.target.value})}/>
                </div>
                <input type="number" placeholder="Harga Satuan" required className="w-full border p-2 rounded" value={formData.price} onChange={e=>setFormData({...formData, price:e.target.value})}/>
                
                <div className="bg-red-50 p-2 rounded border border-red-100">
                   <label className="text-xs text-red-600 font-bold flex items-center gap-1"><Calculator size={12}/> Pajak PPN/PPh</label>
                   <input type="number" placeholder="Nominal Pajak (Rp)" className="w-full border p-1 rounded text-right mt-1" value={formData.tax} onChange={e=>setFormData({...formData, tax:e.target.value})}/>
                </div>
                <button className="w-full bg-emerald-700 text-white py-2 rounded hover:bg-emerald-800">Simpan Transaksi</button>
              </form>
            </div>
            <div className="md:col-span-2">
               <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                  <table className="w-full text-sm text-left">
                    <thead className="bg-gray-100"><tr><th className="p-3">Tanggal</th><th className="p-3">Item</th><th className="p-3">Akun</th><th className="p-3 text-right">Total</th><th className="p-3"></th></tr></thead>
                    <tbody>
                      {expenses.map(e => (
                        <tr key={e.id} className="border-b hover:bg-gray-50">
                          <td className="p-3">{e.date}</td>
                          <td className="p-3 font-medium">{e.item}<br/><span className="text-xs text-gray-400">{e.category}</span></td>
                          <td className="p-3 text-xs font-bold text-gray-500">{e.type}</td>
                          <td className="p-3 text-right">{formatRupiah(e.total)}</td>
                          <td className="p-3 text-center"><button onClick={()=>setExpenses(expenses.filter(x=>x.id!==e.id))} className="text-red-400"><Trash2 size={16}/></button></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
               </div>
            </div>
          </div>
        )}

        {/* STOK GUDANG (INVENTORY) */}
        {activeTab === 'stok' && (
           <div className="grid md:grid-cols-3 gap-6">
              <div className="md:col-span-1 bg-white p-5 rounded-xl border shadow-sm h-fit">
                 <h3 className="font-bold mb-4 flex items-center gap-2"><Package size={18}/> Catat Pemakaian</h3>
                 <p className="text-xs text-gray-500 mb-4">Gunakan ini setiap sore untuk mencatat bahan yang dimasak.</p>
                 <form onSubmit={handleUseStock} className="space-y-3">
                    <select className="w-full border p-2 rounded" required value={stockUsageForm.id} onChange={e=>setStockUsageForm({...stockUsageForm, id:e.target.value})}>
                       <option value="">-- Pilih Barang --</option>
                       {stockData.map(s => <option key={s.id} value={s.id}>{s.name} (Sisa: {s.current} {s.unit})</option>)}
                    </select>
                    <input type="number" placeholder="Jumlah Dipakai" required className="w-full border p-2 rounded" value={stockUsageForm.qty} onChange={e=>setStockUsageForm({...stockUsageForm, qty:e.target.value})}/>
                    <button className="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700">Catat Keluar Barang</button>
                 </form>
              </div>
              <div className="md:col-span-2 bg-white rounded-xl border shadow-sm overflow-hidden">
                 <div className="p-4 bg-gray-50 border-b font-bold text-gray-700">Kartu Stok Gudang</div>
                 <table className="w-full text-sm text-left">
                    <thead className="bg-gray-100">
                       <tr>
                          <th className="p-3">Nama Barang</th>
                          <th className="p-3 text-center">Masuk (Beli)</th>
                          <th className="p-3 text-center">Keluar (Masak)</th>
                          <th className="p-3 text-center bg-emerald-50">Sisa Stok</th>
                       </tr>
                    </thead>
                    <tbody>
                       {stockData.map(s => (
                          <tr key={s.id} className="border-b hover:bg-gray-50">
                             <td className="p-3 font-medium">{s.name} <span className="text-xs text-gray-400">({s.unit})</span></td>
                             <td className="p-3 text-center text-green-600">+{s.in}</td>
                             <td className="p-3 text-center text-red-500">-{s.out}</td>
                             <td className="p-3 text-center font-bold bg-emerald-50 text-emerald-800">{s.current}</td>
                          </tr>
                       ))}
                    </tbody>
                 </table>
              </div>
           </div>
        )}

        {/* GPS ABSENSI */}
        {activeTab === 'absensi' && (
           <div className="max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden text-center">
              <div className="bg-emerald-800 text-white p-6">
                 <Clock size={40} className="mx-auto mb-2"/>
                 <h2 className="text-2xl font-bold">Mesin Absensi GPS</h2>
                 <p className="text-emerald-200">{new Date().toLocaleDateString('id-ID', {weekday:'long', day:'numeric', month:'long'})}</p>
              </div>
              <div className="p-6 space-y-4">
                 <select className="w-full p-3 border rounded text-lg" value={selectedEmpForClockIn} onChange={e=>setSelectedEmpForClockIn(e.target.value)}>
                    <option value="">-- Pilih Nama Karyawan --</option>
                    {employees.map(e => <option key={e.id} value={e.id}>{e.name}</option>)}
                 </select>
                 
                 <div className="bg-gray-100 p-4 rounded text-sm">
                    <p className="mb-2 font-bold text-gray-600">Status Lokasi: {gpsStatus}</p>
                    {!currentLocation ? (
                      <button onClick={()=>{
                        if(!navigator.geolocation) return alert('Browser tidak support GPS');
                        setGpsStatus('Mencari...');
                        navigator.geolocation.getCurrentPosition(p => {
                           setGpsStatus('Terkunci'); setCurrentLocation({lat:p.coords.latitude, lng:p.coords.longitude});
                        }, () => setGpsStatus('Gagal Ambil Lokasi'));
                      }} className="bg-blue-600 text-white px-4 py-2 rounded-full flex items-center gap-2 mx-auto"><Navigation size={14}/> Aktifkan GPS</button>
                    ) : (
                      <p className="text-green-600 flex items-center justify-center gap-1"><MapPin size={14}/> {currentLocation.lat.toFixed(5)}, {currentLocation.lng.toFixed(5)}</p>
                    )}
                 </div>

                 <button onClick={handleClockIn} disabled={!currentLocation || !selectedEmpForClockIn} className={`w-full py-3 rounded font-bold text-white ${!currentLocation || !selectedEmpForClockIn ? 'bg-gray-300' : 'bg-emerald-600 hover:bg-emerald-700'}`}>ABSEN MASUK</button>
              </div>
           </div>
        )}

        {/* GAJI & PAJAK (PAYROLL) */}
        {activeTab === 'gaji' && (
           <div className="space-y-6">
              <div className="flex justify-between items-center bg-white p-4 rounded-xl border shadow-sm">
                 <h3 className="font-bold text-gray-700 flex items-center gap-2"><Banknote/> Payroll & Pajak PPh 21</h3>
                 <input type="month" value={salaryPeriod} onChange={e=>setSalaryPeriod(e.target.value)} className="border p-2 rounded"/>
              </div>
              <div className="grid md:grid-cols-2 gap-4">
                 {calculatedPayroll.map(emp => (
                    <div key={emp.id} className="bg-white p-5 rounded-xl border shadow-sm hover:shadow-md transition">
                       <div className="flex justify-between mb-3">
                          <div><h4 className="font-bold text-lg">{emp.name}</h4><span className="text-xs bg-gray-100 px-2 py-1 rounded">{emp.role}</span></div>
                          <div className="text-right"><h4 className="font-bold text-xl text-green-700">{formatRupiah(emp.net)}</h4><p className="text-xs text-gray-400">Gaji Bersih</p></div>
                       </div>
                       <div className="space-y-1 text-sm text-gray-600 bg-gray-50 p-3 rounded mb-4">
                          <div className="flex justify-between"><span>Gaji Bruto:</span> <span>{formatRupiah(emp.gross)}</span></div>
                          <div className="flex justify-between text-red-500"><span>Potongan PPh 21 ({emp.taxRate}%):</span> <span>- {formatRupiah(emp.tax)}</span></div>
                       </div>
                       <button onClick={()=>setSelectedSlip(emp)} className="w-full border border-emerald-600 text-emerald-600 py-2 rounded hover:bg-emerald-50 font-medium">Lihat Slip Gaji</button>
                    </div>
                 ))}
              </div>
           </div>
        )}

      </main>

      {/* MODAL SLIP */}
      {selectedSlip && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
           <div className="bg-white w-full max-w-md rounded-lg overflow-hidden shadow-2xl">
              <div className="bg-emerald-900 text-white p-4 flex justify-between"><h3>Slip Gaji</h3><button onClick={()=>setSelectedSlip(null)}><XCircle/></button></div>
              <div className="p-6 text-sm">
                 <div className="text-center border-b pb-4 mb-4"><h2 className="font-bold text-lg">DAPUR MBG</h2><p>Periode: {selectedSlip.period}</p></div>
                 <div className="space-y-2 mb-4">
                    <div className="flex justify-between"><span>Nama:</span> <b>{selectedSlip.name}</b></div>
                    <div className="flex justify-between"><span>Jabatan:</span> <span>{selectedSlip.role}</span></div>
                 </div>
                 <table className="w-full mb-4"><tbody>
                    <tr><td className="py-1">Gaji Pokok + Lembur</td><td className="text-right">{formatRupiah(selectedSlip.gross)}</td></tr>
                    <tr className="text-red-600"><td className="py-1">Pajak PPh 21</td><td className="text-right">({formatRupiah(selectedSlip.tax)})</td></tr>
                    <tr className="font-bold border-t border-dashed"><td className="py-2">DITERIMA (NET)</td><td className="text-right py-2">{formatRupiah(selectedSlip.net)}</td></tr>
                 </tbody></table>
                 <button onClick={()=>window.print()} className="w-full bg-emerald-700 text-white py-2 rounded font-bold mt-4">Cetak Slip</button>
              </div>
           </div>
        </div>
      )}
    </div>
  );
}